<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mailbee Gmail</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Google Sans', 'Roboto', Arial, sans-serif;
      background: #ffffff;
      height: 100%;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    * {
      box-sizing: border-box;
    }

    .container {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: #f6f8fc;
    }

    .auth-card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 48px 40px 36px;
      width: 100%;
      max-width: 450px;
    }

    .logo {
      text-align: center;
      margin-bottom: 24px;
    }

    .logo h1 {
      color: #1a73e8;
      font-size: 24px;
      margin: 0;
      font-weight: 400;
      letter-spacing: -0.5px;
    }

    .logo p {
      color: #5f6368;
      font-size: 16px;
      margin: 8px 0 0 0;
      font-weight: 400;
    }

    .form-group {
      margin-bottom: 24px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #202124;
      font-weight: 400;
      font-size: 14px;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 13px 15px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-size: 16px;
      transition: border-color 0.2s;
      background: white;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 0 1px #1a73e8;
    }

    .btn {
      width: 100%;
      padding: 12px 24px;
      background: #1a73e8;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
      margin-top: 16px;
      touch-action: manipulation;
    }

    .btn:hover {
      background: #1557b0;
    }

    .btn:disabled {
      background: #dadce0;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: white;
      color: #1a73e8;
      border: 1px solid #dadce0;
    }

    .btn-secondary:hover {
      background: #f8f9fa;
    }

    .link-btn {
      background: none;
      color: #1a73e8;
      text-decoration: none;
      cursor: pointer;
      border: none;
      padding: 8px;
      font-size: 14px;
      margin-top: 24px;
      font-weight: 500;
      touch-action: manipulation;
    }

    .link-btn:hover {
      text-decoration: underline;
    }

    /* Gmail Interface */
    .gmail-container {
      background: white;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .gmail-header {
      height: 64px;
      padding: 8px 16px;
      border-bottom: 1px solid #e8eaed;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: white;
      position: relative;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .menu-btn {
      display: none;
      background: none;
      border: none;
      padding: 8px;
      border-radius: 50%;
      cursor: pointer;
      color: #5f6368;
      font-size: 20px;
      touch-action: manipulation;
    }

    .menu-btn:hover {
      background: #f1f3f4;
    }

    .gmail-header h1 {
      color: #5f6368;
      font-size: 22px;
      font-weight: 400;
      margin: 0;
    }

    .search-bar {
      flex: 1;
      max-width: 720px;
      margin: 0 32px;
      position: relative;
    }

    .search-bar input {
      width: 100%;
      padding: 12px 48px 12px 16px;
      border: none;
      background: #f1f3f4;
      border-radius: 8px;
      font-size: 16px;
      outline: none;
    }

    .search-bar input:focus {
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .search-icon {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: #5f6368;
      font-size: 20px;
    }

    .user-section {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .profile-pic {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #1a73e8;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
      font-size: 14px;
      cursor: pointer;
      position: relative;
      touch-action: manipulation;
    }

    .profile-pic img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .profile-upload {
      display: none;
    }

    .gmail-body {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .sidebar {
      width: 256px;
      border-right: 1px solid #e8eaed;
      padding: 8px 0;
      overflow-y: auto;
      background: white;
      transition: transform 0.3s ease;
    }

    .compose-btn {
      margin: 8px 16px 16px 16px;
      padding: 12px 24px;
      background: #c2e7ff;
      color: #001d35;
      border: none;
      border-radius: 16px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: all 0.2s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      touch-action: manipulation;
    }

    .compose-btn:hover {
      background: #a8daff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }

    .compose-icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sidebar-section {
      margin-bottom: 8px;
    }

    .sidebar-item {
      padding: 8px 24px 8px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      font-size: 14px;
      color: #202124;
      transition: background 0.2s;
      border-radius: 0 16px 16px 0;
      margin-right: 8px;
      position: relative;
      touch-action: manipulation;
    }

    .sidebar-item:hover {
      background: #f1f3f4;
    }

    .sidebar-item.active {
      background: #fce8e6;
      color: #d93025;
      font-weight: 500;
    }

    .sidebar-item .icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sidebar-item .count {
      margin-left: auto;
      font-size: 12px;
      color: #5f6368;
      background: #f1f3f4;
      padding: 2px 6px;
      border-radius: 8px;
      min-width: 16px;
      text-align: center;
    }

    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .toolbar {
      height: 48px;
      padding: 0 16px;
      border-bottom: 1px solid #e8eaed;
      display: flex;
      align-items: center;
      gap: 8px;
      background: white;
    }

    .toolbar-btn {
      padding: 8px;
      border: none;
      background: none;
      border-radius: 4px;
      cursor: pointer;
      color: #5f6368;
      font-size: 14px;
      touch-action: manipulation;
    }

    .toolbar-btn:hover {
      background: #f1f3f4;
    }

    .mail-list {
      flex: 1;
      overflow-y: auto;
      background: white;
    }

    .mail-item {
      padding: 12px 16px;
      display: flex;
      align-items: center;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.2s;
      position: relative;
      min-height: 64px;
      touch-action: manipulation;
    }

    .mail-item:hover {
      box-shadow: inset 1px 0 0 #dadce0, inset -1px 0 0 #dadce0, 0 1px 2px rgba(0,0,0,0.1);
      z-index: 1;
    }

    .mail-item.unread {
      background: white;
      font-weight: 500;
    }

    .mail-item.selected {
      background: #fce8e6;
    }

    .mail-checkbox {
      width: 20px;
      margin-right: 16px;
      cursor: pointer;
      color: #dadce0;
      font-size: 18px;
      touch-action: manipulation;
    }

    .mail-star {
      width: 20px;
      margin-right: 16px;
      cursor: pointer;
      color: #dadce0;
      font-size: 18px;
      touch-action: manipulation;
    }

    .mail-star.starred {
      color: #fbbc04;
    }

    .mail-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .mail-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .mail-sender {
      font-size: 14px;
      color: #202124;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 4px;
      flex: 1;
      min-width: 0;
    }

    .verified-tick {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
      background-image: url('https://pulse.oriontec.xyz/tick-mark.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
    }

    .mail-time {
      font-size: 12px;
      color: #5f6368;
      white-space: nowrap;
      margin-left: 8px;
    }

    .mail-subject {
      font-size: 14px;
      color: #202124;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      margin-bottom: 2px;
    }

    .mail-preview {
      font-size: 13px;
      color: #5f6368;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Compose Modal */
    .compose-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.4);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .compose-modal.active {
      display: flex;
    }

    .compose-card {
      background: white;
      border-radius: 8px;
      width: 90%;
      max-width: 680px;
      max-height: 90%;
      display: flex;
      flex-direction: column;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      margin: 20px;
    }

    .compose-header {
      padding: 16px 24px;
      border-bottom: 1px solid #e8eaed;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f8f9fa;
    }

    .compose-header h3 {
      margin: 0;
      color: #202124;
      font-size: 16px;
      font-weight: 500;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #5f6368;
      padding: 4px;
      border-radius: 4px;
      touch-action: manipulation;
    }

    .close-btn:hover {
      background: #f1f3f4;
    }

    .compose-body {
      padding: 16px 24px;
      flex: 1;
      overflow-y: auto;
    }

    .compose-footer {
      padding: 16px 24px;
      border-top: 1px solid #e8eaed;
      display: flex;
      gap: 8px;
      background: #f8f9fa;
    }

    .compose-send-btn {
      padding: 8px 24px;
      background: #1a73e8;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      touch-action: manipulation;
    }

    .compose-send-btn:hover {
      background: #1557b0;
    }

    .compose-field {
      display: flex;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #e8eaed;
    }

    .compose-field label {
      width: 60px;
      color: #5f6368;
      font-size: 14px;
    }

    .compose-field input {
      flex: 1;
      border: none;
      outline: none;
      font-size: 14px;
      padding: 4px 0;
    }

    textarea {
      width: 100%;
      min-height: 200px;
      padding: 8px 0;
      border: none;
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
      outline: none;
    }

    .image-preview {
      margin-top: 16px;
    }

    .image-preview img {
      max-width: 100%;
      border-radius: 4px;
      border: 1px solid #e8eaed;
    }

    /* Mail Detail */
    .mail-detail {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
      display: none;
      background: white;
    }

    .mail-detail.active {
      display: block;
    }

    .mail-detail-header {
      border-bottom: 1px solid #e8eaed;
      padding-bottom: 16px;
      margin-bottom: 24px;
    }

    .mail-detail-subject {
      font-size: 20px;
      font-weight: 400;
      color: #202124;
      margin-bottom: 16px;
    }

    .mail-detail-from {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .mail-detail-body {
      color: #202124;
      line-height: 1.6;
      white-space: pre-wrap;
      font-size: 14px;
    }

    .mail-detail-image {
      margin-top: 24px;
    }

    .mail-detail-image img {
      max-width: 100%;
      border-radius: 8px;
      border: 1px solid #e8eaed;
    }

    .loading {
      text-align: center;
      padding: 48px 24px;
      color: #5f6368;
      font-size: 14px;
    }

    .error-message {
      background: #fce8e6;
      color: #d93025;
      padding: 12px 16px;
      border-radius: 4px;
      margin-bottom: 16px;
      font-size: 14px;
      border: 1px solid #f28b82;
    }

    .success-message {
      background: #e6f4ea;
      color: #137333;
      padding: 12px 16px;
      border-radius: 4px;
      margin-bottom: 16px;
      font-size: 14px;
      border: 1px solid #81c995;
    }

    .step-indicator {
      text-align: center;
      margin-bottom: 24px;
      color: #5f6368;
      font-size: 14px;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .menu-btn {
        display: block;
      }

      .search-bar {
        margin: 0 16px;
        max-width: none;
      }

      .user-section span {
        display: none;
      }

      .sidebar {
        position: fixed;
        top: 64px;
        left: 0;
        height: calc(100% - 64px);
        z-index: 200;
        transform: translateX(-100%);
        box-shadow: 2px 0 8px rgba(0,0,0,0.1);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .sidebar-overlay {
        display: none;
        position: fixed;
        top: 64px;
        left: 0;
        width: 100%;
        height: calc(100% - 64px);
        background: rgba(0,0,0,0.5);
        z-index: 150;
      }

      .sidebar-overlay.active {
        display: block;
      }

      .main-content {
        width: 100%;
      }

      .mail-item {
        padding: 16px 12px;
      }

      .mail-sender {
        max-width: 120px;
      }

      .compose-card {
        width: 95%;
        max-height: 95%;
        margin: 10px;
      }

      .compose-header,
      .compose-body,
      .compose-footer {
        padding: 12px 16px;
      }

      .auth-card {
        padding: 32px 24px;
        margin: 16px;
      }

      .gmail-header {
        padding: 8px 12px;
      }

      .gmail-header h1 {
        font-size: 18px;
      }
    }

    @media (max-width: 480px) {
      .search-bar {
        display: none;
      }

      .mail-checkbox,
      .mail-star {
        display: none;
      }

      .mail-item {
        padding: 12px 8px;
      }

      .compose-field {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
      }

      .compose-field label {
        width: auto;
        font-weight: 500;
      }

      .compose-field input {
        width: 100%;
      }
    }

    /* Touch improvements */
    @media (hover: none) and (pointer: coarse) {
      .sidebar-item,
      .mail-item,
      .toolbar-btn,
      .compose-btn {
        min-height: 44px;
      }

      .btn {
        min-height: 44px;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="container" id="app"></div>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC30TcmMVhP_8HdFYS1WufRiZwSDYNMTF0",
      authDomain: "pulse2-92372.firebaseapp.com",
      databaseURL: "https://pulse2-92372-default-rtdb.firebaseio.com",
      projectId: "pulse2-92372",
      storageBucket: "pulse2-92372.firebasestorage.app",
      messagingSenderId: "276235725177",
      appId: "1:276235725177:web:0f4e0789fae80a435927a8"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const defaultConfig = {
      app_title: "Mailbee",
      domain_name: "dozera.com",
      primary_color: "#1a73e8",
      secondary_color: "#34a853",
      text_color: "#202124",
      background_color: "#ffffff",
      accent_color: "#1557b0"
    };

    let config = { ...defaultConfig };
    let currentUser = null;
    let currentView = 'inbox';
    let selectedMail = null;
    let unreadCounts = {};
    let sidebarOpen = false;

    const app = document.getElementById('app');

    const sidebarItems = [
      { id: 'inbox', label: 'Inbox', icon: 'üì•', section: 'main' },
      { id: 'starred', label: 'Starred', icon: '‚≠ê', section: 'main' },
      { id: 'snoozed', label: 'Snoozed', icon: '‚è∞', section: 'main' },
      { id: 'important', label: 'Important', icon: 'üîñ', section: 'main' },
      { id: 'sent', label: 'Sent', icon: 'üì§', section: 'main' },
      { id: 'drafts', label: 'Drafts', icon: 'üìù', section: 'main' },
      { id: 'all', label: 'All mail', icon: 'üìß', section: 'more' },
      { id: 'spam', label: 'Spam', icon: 'üö´', section: 'more' },
      { id: 'trash', label: 'Trash', icon: 'üóëÔ∏è', section: 'more' }
    ];

    function generateEmailSuggestions(name) {
      const cleanName = name.toLowerCase().replace(/\s+/g, '');
      const random = Math.floor(Math.random() * 999);
      return [
        `${cleanName}@${config.domain_name}`,
        `${cleanName}${random}@${config.domain_name}`,
        `${cleanName}.official@${config.domain_name}`
      ];
    }

    async function checkEmailExists(email) {
      const snapshot = await database.ref('users').orderByChild('email').equalTo(email).once('value');
      return snapshot.exists();
    }

    async function sendWelcomeEmail(userEmail, userName) {
      const welcomeMailData = {
        from: `mailbee@${config.domain_name}`,
        fromName: 'Mailbee Team',
        to: userEmail,
        subject: `Welcome to ${config.app_title}! üéâ`,
        body: `Hello ${userName}!

Welcome to ${config.app_title}! We're excited to have you on our email platform.

What's special for you:
‚Ä¢ Unlimited email storage
‚Ä¢ Fast and secure messaging  
‚Ä¢ Beautiful Gmail-like interface
‚Ä¢ Real-time notifications
‚Ä¢ Image attachments support
‚Ä¢ Professional @${config.domain_name} email address

Quick tips to get started:
1. Use the Compose button to send new emails
2. Organize your emails with folders  
3. Star important emails
4. Upload your profile picture

If you need any help, we're always here for you. Enjoy your ${config.app_title} experience!

Best regards,
${config.app_title} Team
${config.domain_name}

---
This is an automated message. Please don't reply.`,
        image: '',
        timestamp: Date.now(),
        read: false,
        isWelcome: true
      };

      await database.ref('mails').push(welcomeMailData);
    }

    function showLogin() {
      app.innerHTML = `
        <div class="auth-card">
          <div class="logo">
            <h1>${config.app_title}</h1>
            <p>Sign in to your account</p>
          </div>
          <div id="loginError"></div>
          <form id="loginForm">
            <div class="form-group">
              <label for="loginEmail">Email</label>
              <input type="email" id="loginEmail" placeholder="your@${config.domain_name}" required>
            </div>
            <div class="form-group">
              <label for="loginPassword">Password</label>
              <input type="password" id="loginPassword" placeholder="Enter your password" required>
            </div>
            <button type="submit" class="btn" id="loginBtn">Sign in</button>
            <button type="button" class="link-btn" onclick="showSignupStep1()">Create account</button>
          </form>
        </div>
      `;

      document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        const btn = document.getElementById('loginBtn');
        const errorDiv = document.getElementById('loginError');

        btn.disabled = true;
        btn.textContent = 'Signing in...';
        errorDiv.innerHTML = '';

        try {
          const snapshot = await database.ref('users').orderByChild('email').equalTo(email).once('value');
          if (snapshot.exists()) {
            const userData = Object.values(snapshot.val())[0];
            if (userData.password === password) {
              currentUser = userData;
              showGmail();
            } else {
              errorDiv.innerHTML = '<div class="error-message">Incorrect password</div>';
            }
          } else {
            errorDiv.innerHTML = '<div class="error-message">Email not found</div>';
          }
        } catch (error) {
          errorDiv.innerHTML = '<div class="error-message">Error: ' + error.message + '</div>';
        }

        btn.disabled = false;
        btn.textContent = 'Sign in';
      });
    }

    let signupData = {};

    function showSignupStep1() {
      app.innerHTML = `
        <div class="auth-card">
          <div class="logo">
            <h1>${config.app_title}</h1>
            <p>Create your account</p>
          </div>
          <div class="step-indicator">Step 1 of 6</div>
          <form id="step1Form">
            <div class="form-group">
              <label for="fullName">Full Name</label>
              <input type="text" id="fullName" placeholder="Enter your full name" required>
            </div>
            <button type="submit" class="btn">Next</button>
            <button type="button" class="btn btn-secondary" onclick="showLogin()">Back to Sign in</button>
          </form>
        </div>
      `;

      document.getElementById('step1Form').addEventListener('submit', (e) => {
        e.preventDefault();
        signupData.name = document.getElementById('fullName').value;
        showSignupStep2();
      });
    }

    function showSignupStep2() {
      app.innerHTML = `
        <div class="auth-card">
          <div class="logo">
            <h1>${config.app_title}</h1>
            <p>Create your account</p>
          </div>
          <div class="step-indicator">Step 2 of 6</div>
          <form id="step2Form">
            <div class="form-group">
              <label for="birthdate">Date of Birth</label>
              <input type="date" id="birthdate" required>
            </div>
            <button type="submit" class="btn">Next</button>
            <button type="button" class="btn btn-secondary" onclick="showSignupStep1()">Back</button>
          </form>
        </div>
      `;

      document.getElementById('step2Form').addEventListener('submit', (e) => {
        e.preventDefault();
        signupData.birthdate = document.getElementById('birthdate').value;
        showSignupStep3();
      });
    }

    function showSignupStep3() {
      app.innerHTML = `
        <div class="auth-card">
          <div class="logo">
            <h1>${config.app_title}</h1>
            <p>Create your account</p>
          </div>
          <div class="step-indicator">Step 3 of 6</div>
          <form id="step3Form">
            <div class="form-group">
              <label>Gender</label>
              <select id="gender" required>
                <option value="">Choose your gender</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="other">Other</option>
              </select>
            </div>
            <button type="submit" class="btn">Next</button>
            <button type="button" class="btn btn-secondary" onclick="showSignupStep2()">Back</button>
          </form>
        </div>
      `;

      document.getElementById('step3Form').addEventListener('submit', (e) => {
        e.preventDefault();
        signupData.gender = document.getElementById('gender').value;
        showSignupStep4();
      });
    }

    function showSignupStep4() {
      app.innerHTML = `
        <div class="auth-card">
          <div class="logo">
            <h1>${config.app_title}</h1>
            <p>Create your account</p>
          </div>
          <div class="step-indicator">Step 4 of 6</div>
          <form id="step4Form">
            <div class="form-group">
              <label for="mobile">Mobile Number</label>
              <input type="tel" id="mobile" placeholder="10 digit number" pattern="[0-9]{10}" required>
            </div>
            <button type="submit" class="btn">Next</button>
            <button type="button" class="btn btn-secondary" onclick="showSignupStep3()">Back</button>
          </form>
        </div>
      `;

      document.getElementById('step4Form').addEventListener('submit', (e) => {
        e.preventDefault();
        signupData.mobile = document.getElementById('mobile').value;
        showSignupStep5();
      });
    }

    function showSignupStep5() {
      const suggestions = generateEmailSuggestions(signupData.name);
      
      app.innerHTML = `
        <div class="auth-card">
          <div class="logo">
            <h1>${config.app_title}</h1>
            <p>Create your account</p>
          </div>
          <div class="step-indicator">Step 5 of 6</div>
          <div id="emailError"></div>
          <form id="step5Form">
            <div class="form-group">
              <label>Choose your email</label>
              <div style="margin-top: 10px; padding: 10px; background: #f1f3f4; border-radius: 8px;">
                <p style="margin: 0 0 8px 0; font-size: 13px; color: #5f6368;">Recommended:</p>
                ${suggestions.map((email, i) => `
                  <div style="padding: 8px 12px; background: white; border: 1px solid #dadce0; border-radius: 4px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; font-size: 14px;" 
                       class="suggestion-item" data-email="${email}" onclick="selectEmail('${email}', ${i})">
                    ${email}
                  </div>
                `).join('')}
              </div>
              <div style="display: flex; align-items: center; margin-top: 10px;">
                <input type="text" id="customEmail" placeholder="Or create your own" style="flex: 1; margin-right: 5px;">
                <span style="color: #5f6368; font-weight: 400;">@${config.domain_name}</span>
              </div>
            </div>
            <button type="submit" class="btn" id="emailBtn">Next</button>
            <button type="button" class="btn btn-secondary" onclick="showSignupStep4()">Back</button>
          </form>
        </div>
      `;

      let selectedEmailValue = suggestions[0];

      window.selectEmail = (email, index) => {
        document.querySelectorAll('.suggestion-item').forEach((item, i) => {
          if (i === index) {
            item.style.borderColor = '#1a73e8';
            item.style.background = '#e8f0fe';
            item.style.color = '#1a73e8';
          } else {
            item.style.borderColor = '#dadce0';
            item.style.background = 'white';
            item.style.color = '#202124';
          }
        });
        selectedEmailValue = email;
        document.getElementById('customEmail').value = '';
      };

      // Select first suggestion by default
      document.querySelectorAll('.suggestion-item')[0].style.borderColor = '#1a73e8';
      document.querySelectorAll('.suggestion-item')[0].style.background = '#e8f0fe';
      document.querySelectorAll('.suggestion-item')[0].style.color = '#1a73e8';

      document.getElementById('step5Form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const customEmail = document.getElementById('customEmail').value.trim();
        const finalEmail = customEmail ? `${customEmail}@${config.domain_name}` : selectedEmailValue;
        const btn = document.getElementById('emailBtn');
        const errorDiv = document.getElementById('emailError');

        btn.disabled = true;
        btn.textContent = 'Checking...';
        errorDiv.innerHTML = '';

        const exists = await checkEmailExists(finalEmail);
        if (exists) {
          errorDiv.innerHTML = '<div class="error-message">This email already exists! Try another one.</div>';
          btn.disabled = false;
          btn.textContent = 'Next';
        } else {
          signupData.email = finalEmail;
          btn.disabled = false;
          btn.textContent = 'Next';
          showSignupStep6();
        }
      });
    }

    function showSignupStep6() {
      app.innerHTML = `
        <div class="auth-card">
          <div class="logo">
            <h1>${config.app_title}</h1>
            <p>Create your account</p>
          </div>
          <div class="step-indicator">Step 6 of 6</div>
          <div id="passwordError"></div>
          <form id="step6Form">
            <div class="form-group">
              <label for="password">Password</label>
              <input type="password" id="password" placeholder="Strong password" minlength="6" required>
            </div>
            <div class="form-group">
              <label for="confirmPassword">Confirm Password</label>
              <input type="password" id="confirmPassword" placeholder="Re-enter password" required>
            </div>
            <button type="submit" class="btn" id="createBtn">Create Account</button>
            <button type="button" class="btn btn-secondary" onclick="showSignupStep5()">Back</button>
          </form>
        </div>
      `;

      document.getElementById('step6Form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const btn = document.getElementById('createBtn');
        const errorDiv = document.getElementById('passwordError');

        errorDiv.innerHTML = '';

        if (password !== confirmPassword) {
          errorDiv.innerHTML = '<div class="error-message">Passwords do not match!</div>';
          return;
        }

        btn.disabled = true;
        btn.textContent = 'Creating account...';

        try {
          signupData.password = password;
          signupData.createdAt = Date.now();
          signupData.profilePic = '';

          const newUserRef = database.ref('users').push();
          signupData.userId = newUserRef.key;
          await newUserRef.set(signupData);

          // Send welcome email
          await sendWelcomeEmail(signupData.email, signupData.name);

          showInstructions();
        } catch (error) {
          errorDiv.innerHTML = '<div class="error-message">Error: ' + error.message + '</div>';
          btn.disabled = false;
          btn.textContent = 'Create Account';
        }
      });
    }

    function showInstructions() {
      app.innerHTML = `
        <div class="auth-card">
          <div class="logo">
            <h1>üéâ Congratulations!</h1>
            <p>Your ${config.app_title} account has been created</p>
          </div>
          <div style="padding: 20px; background: #f1f3f4; border-radius: 8px; margin: 20px 0;">
            <h3 style="margin-top: 0; color: #1a73e8;">How to use ${config.app_title}:</h3>
            <ul style="line-height: 1.8; color: #5f6368;">
              <li>üìß Use Compose button to send new emails</li>
              <li>üì• Check Inbox for received emails</li>
              <li>üì§ View Sent folder for sent emails</li>
              <li>üñºÔ∏è Attach images to your emails</li>
              <li>üë§ Upload your profile picture</li>
              <li>‚≠ê Star important emails</li>
              <li>üóÇÔ∏è Organize emails in folders</li>
            </ul>
            <p><strong>Welcome email has been sent to your inbox!</strong></p>
          </div>
          <button class="btn" onclick="loginNewUser()">Get Started</button>
        </div>
      `;
    }

    window.loginNewUser = async () => {
      const snapshot = await database.ref('users').orderByChild('email').equalTo(signupData.email).once('value');
      if (snapshot.exists()) {
        currentUser = Object.values(snapshot.val())[0];
        showGmail();
      }
    };

    function showGmail() {
      app.innerHTML = `
        <div class="gmail-container">
          <div class="gmail-header">
            <div class="header-left">
              <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
              <h1>${config.app_title}</h1>
            </div>
            <div class="search-bar">
              <input type="text" placeholder="Search mail">
              <div class="search-icon">üîç</div>
            </div>
            <div class="user-section">
              <span style="font-size: 14px; color: #5f6368;">${currentUser.email}</span>
              <div class="profile-pic" onclick="document.getElementById('profileUpload').click()">
                ${currentUser.profilePic ? `<img src="${currentUser.profilePic}" alt="Profile">` : currentUser.name.charAt(0).toUpperCase()}
              </div>
              <input type="file" id="profileUpload" class="profile-upload" accept="image/*">
              <button class="btn" style="width: auto; padding: 8px 16px; margin: 0; font-size: 12px;" onclick="logout()">Sign out</button>
            </div>
          </div>
          <div class="gmail-body">
            <div class="sidebar-overlay" onclick="closeSidebar()"></div>
            <div class="sidebar" id="sidebar">
              <button class="compose-btn" onclick="openCompose()">
                <div class="compose-icon">‚úèÔ∏è</div>
                <span>Compose</span>
              </button>
              <div class="sidebar-section">
                ${sidebarItems.filter(item => item.section === 'main').map(item => `
                  <div class="sidebar-item ${item.id === 'inbox' ? 'active' : ''}" onclick="switchView('${item.id}')">
                    <div class="icon">${item.icon}</div>
                    <span>${item.label}</span>
                    <span class="count" id="count-${item.id}"></span>
                  </div>
                `).join('')}
              </div>
              <div class="sidebar-section">
                ${sidebarItems.filter(item => item.section === 'more').map(item => `
                  <div class="sidebar-item" onclick="switchView('${item.id}')">
                    <div class="icon">${item.icon}</div>
                    <span>${item.label}</span>
                    <span class="count" id="count-${item.id}"></span>
                  </div>
                `).join('')}
              </div>
            </div>
            <div class="main-content">
              <div class="toolbar">
                <button class="toolbar-btn" onclick="loadMails()">üîÑ</button>
                <button class="toolbar-btn">üì•</button>
                <button class="toolbar-btn">üóëÔ∏è</button>
                <button class="toolbar-btn">üìß</button>
              </div>
              <div class="mail-list" id="mailList">
                <div class="loading">Loading emails...</div>
              </div>
              <div class="mail-detail" id="mailDetail"></div>
            </div>
          </div>
        </div>

        <div class="compose-modal" id="composeModal">
          <div class="compose-card">
            <div class="compose-header">
              <h3>New Message</h3>
              <button class="close-btn" onclick="closeCompose()">√ó</button>
            </div>
            <div class="compose-body">
              <div id="composeError"></div>
              <form id="composeForm">
                <div class="compose-field">
                  <label>To</label>
                  <input type="email" id="mailTo" placeholder="recipient@${config.domain_name}" required>
                </div>
                <div class="compose-field">
                  <label>Subject</label>
                  <input type="text" id="mailSubject" placeholder="Subject" required>
                </div>
                <div style="border-bottom: 1px solid #e8eaed; padding: 8px 0;">
                  <textarea id="mailBody" placeholder="Compose email..." required></textarea>
                </div>
                <div style="padding: 16px 0;">
                  <input type="file" id="mailImage" accept="image/*" style="font-size: 14px;">
                  <div id="imagePreview" class="image-preview"></div>
                </div>
              </form>
            </div>
            <div class="compose-footer">
              <button class="compose-send-btn" onclick="sendMail()" id="sendBtn">Send</button>
              <button class="toolbar-btn" onclick="closeCompose()">Cancel</button>
            </div>
          </div>
        </div>
      `;

      document.getElementById('profileUpload').addEventListener('change', handleProfileUpload);
      document.getElementById('mailImage').addEventListener('change', handleImagePreview);

      loadMails();
      updateUnreadCounts();
    }

    window.toggleSidebar = () => {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.querySelector('.sidebar-overlay');
      
      if (sidebarOpen) {
        sidebar.classList.remove('open');
        overlay.classList.remove('active');
        sidebarOpen = false;
      } else {
        sidebar.classList.add('open');
        overlay.classList.add('active');
        sidebarOpen = true;
      }
    };

    window.closeSidebar = () => {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.querySelector('.sidebar-overlay');
      
      sidebar.classList.remove('open');
      overlay.classList.remove('active');
      sidebarOpen = false;
    };

    async function handleProfileUpload(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = async (event) => {
          const base64 = event.target.result;
          try {
            await database.ref(`users/${currentUser.userId}`).update({ profilePic: base64 });
            currentUser.profilePic = base64;
            showGmail();
          } catch (error) {
            console.error('Profile pic upload error:', error);
          }
        };
        reader.readAsDataURL(file);
      }
    }

    function handleImagePreview(e) {
      const file = e.target.files[0];
      const preview = document.getElementById('imagePreview');
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          preview.innerHTML = `<img src="${event.target.result}" alt="Preview">`;
        };
        reader.readAsDataURL(file);
      } else {
        preview.innerHTML = '';
      }
    }

    window.openCompose = () => {
      document.getElementById('composeModal').classList.add('active');
      closeSidebar();
    };

    window.closeCompose = () => {
      document.getElementById('composeModal').classList.remove('active');
      document.getElementById('composeForm').reset();
      document.getElementById('imagePreview').innerHTML = '';
    };

    window.sendMail = async () => {
      const to = document.getElementById('mailTo').value;
      const subject = document.getElementById('mailSubject').value;
      const body = document.getElementById('mailBody').value;
      const imageFile = document.getElementById('mailImage').files[0];
      const btn = document.getElementById('sendBtn');
      const errorDiv = document.getElementById('composeError');

      btn.disabled = true;
      btn.textContent = 'Sending...';
      errorDiv.innerHTML = '';

      try {
        const receiverExists = await checkEmailExists(to);
        if (!receiverExists) {
          errorDiv.innerHTML = '<div class="error-message">Recipient email not found!</div>';
          btn.disabled = false;
          btn.textContent = 'Send';
          return;
        }

        let imageBase64 = '';
        if (imageFile) {
          imageBase64 = await new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.readAsDataURL(imageFile);
          });
        }

        const mailData = {
          from: currentUser.email,
          fromName: currentUser.name,
          to: to,
          subject: subject,
          body: body,
          image: imageBase64,
          timestamp: Date.now(),
          read: false,
          starred: false,
          important: false
        };

        await database.ref('mails').push(mailData);

        errorDiv.innerHTML = '<div class="success-message">Email sent successfully! ‚úÖ</div>';
        setTimeout(() => {
          closeCompose();
          loadMails();
          updateUnreadCounts();
        }, 1500);
      } catch (error) {
        errorDiv.innerHTML = '<div class="error-message">Error: ' + error.message + '</div>';
      }

      btn.disabled = false;
      btn.textContent = 'Send';
    };

    window.switchView = (view) => {
      currentView = view;
      document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
      event.target.closest('.sidebar-item').classList.add('active');
      document.getElementById('mailDetail').classList.remove('active');
      document.getElementById('mailList').style.display = 'block';
      loadMails();
      closeSidebar();
    };

    async function updateUnreadCounts() {
      try {
        const snapshot = await database.ref('mails').orderByChild('to').equalTo(currentUser.email).once('value');
        let unreadCount = 0;
        
        snapshot.forEach((child) => {
          const mail = child.val();
          if (!mail.read) {
            unreadCount++;
          }
        });

        const countElement = document.getElementById('count-inbox');
        if (countElement) {
          countElement.textContent = unreadCount > 0 ? unreadCount : '';
        }
      } catch (error) {
        console.error('Error updating counts:', error);
      }
    }

    async function loadMails() {
      const mailList = document.getElementById('mailList');
      mailList.innerHTML = '<div class="loading">Loading emails...</div>';

      try {
        let query;
        if (currentView === 'inbox') {
          query = database.ref('mails').orderByChild('to').equalTo(currentUser.email);
        } else if (currentView === 'sent') {
          query = database.ref('mails').orderByChild('from').equalTo(currentUser.email);
        } else {
          // For other views, show inbox for now
          query = database.ref('mails').orderByChild('to').equalTo(currentUser.email);
        }

        const snapshot = await query.once('value');
        const mails = [];

        snapshot.forEach((child) => {
          mails.push({ id: child.key, ...child.val() });
        });

        mails.sort((a, b) => b.timestamp - a.timestamp);

        if (mails.length === 0) {
          mailList.innerHTML = '<div class="loading">No emails found</div>';
          return;
        }

        mailList.innerHTML = mails.map(mail => {
          const isFromMailbee = mail.from && mail.from.includes(`mailbee@${config.domain_name}`);
          const verifiedTick = isFromMailbee ? `<div class="verified-tick"></div>` : '';
          
          return `
            <div class="mail-item ${!mail.read && currentView === 'inbox' ? 'unread' : ''}" onclick="showMailDetail('${mail.id}')">
              <div class="mail-checkbox" onclick="toggleCheckbox(event)">‚òê</div>
              <div class="mail-star ${mail.starred ? 'starred' : ''}" onclick="toggleStar('${mail.id}', event)">‚òÜ</div>
              <div class="mail-content">
                <div class="mail-header">
                  <div class="mail-sender">
                    ${currentView === 'inbox' ? mail.fromName || mail.from : mail.to}
                    ${verifiedTick}
                  </div>
                  <div class="mail-time">${formatTime(mail.timestamp)}</div>
                </div>
                <div class="mail-subject">${mail.subject}</div>
                <div class="mail-preview">${mail.body.substring(0, 80)}...</div>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        mailList.innerHTML = '<div class="loading">Error loading emails</div>';
      }
    }

    function formatTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;
      
      if (diff < 24 * 60 * 60 * 1000) {
        return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
      } else if (diff < 7 * 24 * 60 * 60 * 1000) {
        return date.toLocaleDateString('en-US', { weekday: 'short' });
      } else {
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      }
    }

    window.toggleCheckbox = (event) => {
      event.stopPropagation();
      const checkbox = event.target;
      checkbox.textContent = checkbox.textContent === '‚òê' ? '‚òë' : '‚òê';
      checkbox.style.color = checkbox.textContent === '‚òë' ? '#1a73e8' : '#dadce0';
    };

    window.toggleStar = async (mailId, event) => {
      event.stopPropagation();
      try {
        const snapshot = await database.ref(`mails/${mailId}`).once('value');
        const mail = snapshot.val();
        const newStarred = !mail.starred;
        
        await database.ref(`mails/${mailId}`).update({ starred: newStarred });
        
        const starElement = event.target;
        starElement.classList.toggle('starred', newStarred);
        starElement.textContent = newStarred ? '‚òÖ' : '‚òÜ';
      } catch (error) {
        console.error('Error toggling star:', error);
      }
    };

    window.showMailDetail = async (mailId) => {
      try {
        const snapshot = await database.ref(`mails/${mailId}`).once('value');
        const mail = snapshot.val();

        if (currentView === 'inbox' && !mail.read) {
          await database.ref(`mails/${mailId}`).update({ read: true });
        }

        const isFromMailbee = mail.from && mail.from.includes(`mailbee@${config.domain_name}`);
        const verifiedTick = isFromMailbee ? `<div class="verified-tick"></div>` : '';

        const mailDetail = document.getElementById('mailDetail');
        mailDetail.innerHTML = `
          <div class="mail-detail-header">
            <div class="mail-detail-subject">${mail.subject}</div>
            <div class="mail-detail-from">
              <div class="profile-pic" style="width: 40px; height: 40px; font-size: 16px;">
                ${mail.fromName ? mail.fromName.charAt(0).toUpperCase() : mail.from.charAt(0).toUpperCase()}
              </div>
              <div>
                <div style="display: flex; align-items: center; gap: 4px;">
                  <strong>${currentView === 'inbox' ? mail.fromName || mail.from : 'To: ' + mail.to}</strong>
                  ${verifiedTick}
                </div>
                <div style="color: #5f6368; font-size: 12px;">
                  ${new Date(mail.timestamp).toLocaleString()}
                </div>
              </div>
            </div>
          </div>
          <div class="mail-detail-body">${mail.body}</div>
          ${mail.image ? `<div class="mail-detail-image"><img src="${mail.image}" alt="Attachment"></div>` : ''}
          <button class="btn" onclick="backToList()" style="margin-top: 24px; width: auto; padding: 8px 16px;">‚Üê Back to ${currentView}</button>
        `;
        mailDetail.classList.add('active');
        document.getElementById('mailList').style.display = 'none';
        
        updateUnreadCounts();
      } catch (error) {
        console.error('Error loading mail detail:', error);
      }
    };

    window.backToList = () => {
      document.getElementById('mailDetail').classList.remove('active');
      document.getElementById('mailList').style.display = 'block';
      loadMails();
    };

    window.logout = () => {
      currentUser = null;
      showLogin();
    };

    async function onConfigChange(newConfig) {
      config = { ...defaultConfig, ...newConfig };
      
      const style = document.createElement('style');
      style.textContent = `
        .btn, .compose-btn, .compose-send-btn { background: ${config.primary_color}; }
        .btn:hover, .compose-send-btn:hover { background: ${config.accent_color}; }
        .profile-pic { background: ${config.primary_color}; }
        .sidebar-item.active { background: #fce8e6; color: #d93025; }
        .link-btn, .btn-secondary { color: ${config.primary_color}; }
        .form-group input:focus, .form-group select:focus { border-color: ${config.primary_color}; box-shadow: 0 0 0 1px ${config.primary_color}; }
        .logo h1, .gmail-header h1 { color: ${config.primary_color}; }
      `;
      document.head.appendChild(style);

      if (currentUser) {
        showGmail();
      } else {
        showLogin();
      }
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: (config) => ({
          recolorables: [
            {
              get: () => config.primary_color || defaultConfig.primary_color,
              set: (value) => {
                config.primary_color = value;
                window.elementSdk.setConfig({ primary_color: value });
              }
            },
            {
              get: () => config.secondary_color || defaultConfig.secondary_color,
              set: (value) => {
                config.secondary_color = value;
                window.elementSdk.setConfig({ secondary_color: value });
              }
            },
            {
              get: () => config.text_color || defaultConfig.text_color,
              set: (value) => {
                config.text_color = value;
                window.elementSdk.setConfig({ text_color: value });
              }
            },
            {
              get: () => config.background_color || defaultConfig.background_color,
              set: (value) => {
                config.background_color = value;
                window.elementSdk.setConfig({ background_color: value });
              }
            },
            {
              get: () => config.accent_color || defaultConfig.accent_color,
              set: (value) => {
                config.accent_color = value;
                window.elementSdk.setConfig({ accent_color: value });
              }
            }
          ],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map([
          ['app_title', config.app_title || defaultConfig.app_title],
          ['domain_name', config.domain_name || defaultConfig.domain_name]
        ])
      });
    }

    showLogin();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9989447e81b7c51e',t:'MTc2MjE0NTYwMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
