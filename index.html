<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Pulse - Social Media</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(45deg, #ec4899 0%, #8b5cf6 50%, #3b82f6 100%);
        }
        .pulse-gradient {
            background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 50%, #3b82f6 100%);
        }
        .instagram-gradient {
            background: linear-gradient(45deg, #ec4899 0%, #8b5cf6 50%, #3b82f6 100%);
        }
        .story-gradient {
            background: linear-gradient(45deg, #ec4899, #8b5cf6, #3b82f6);
        }
        .avatar-gradient {
            background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 50%, #3b82f6 100%);
            border-radius: 50%;
        }
        .notification-dot {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .buzz-card:hover {
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
        }
        .touch-target {
            min-height: 44px;
            min-width: 44px;
        }
        .hashtag {
            color: #3b82f6;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
        }
        .hashtag:hover {
            text-decoration: underline;
        }
        .mention {
            color: #ec4899;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
        }
        .mention:hover {
            text-decoration: underline;
        }
        .autocomplete-dropdown {
            position: absolute;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
        }
        .autocomplete-item {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
        }
        .autocomplete-item:hover {
            background-color: #f9fafb;
        }
        .autocomplete-item:last-child {
            border-bottom: none;
        }
        .verified-badge {
            display: inline-block;
            width: 16px;
            height: 16px;
            background-image: url('https://community.oriontec.xyz/check.png');
            background-size: contain;
            background-repeat: no-repeat;
            vertical-align: middle;
        }
        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }
        input, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        @media (max-width: 768px) {
            body {
                background: #000;
                overflow-x: hidden;
            }
            
            .mobile-padding {
                padding: 1rem;
            }
            .mobile-text {
                font-size: 0.875rem;
            }
            .mobile-avatar {
                width: 2.5rem;
                height: 2.5rem;
            }
            
            /* Mobile optimizations */
            .grid-cols-3 {
                grid-template-columns: repeat(3, minmax(0, 1fr));
                gap: 1px;
            }
            
            .aspect-square {
                aspect-ratio: 1 / 1;
            }
            
            /* Touch targets */
            .touch-target {
                min-height: 44px;
                min-width: 44px;
            }
            
            /* Full screen pages on mobile */
            .fixed.inset-0 {
                position: fixed;
                top: 0;
                right: 0;
                bottom: 0;
                left: 0;
            }
            
            /* Mobile app styling */
            #mainApp {
                background: #000;
                min-height: 100vh;
            }
            
            nav {
                background: rgba(0, 0, 0, 0.9);
                backdrop-filter: blur(10px);
                border-bottom: 1px solid #333;
            }
            
            .bg-white {
                background: #1a1a1a !important;
                color: white !important;
            }
            
            .text-gray-900, .text-gray-800, .text-gray-700 {
                color: #e5e5e5 !important;
            }
            
            .text-gray-600, .text-gray-500 {
                color: #a0a0a0 !important;
            }
            
            .border-gray-200, .border-gray-300 {
                border-color: #333 !important;
            }
            
            .buzz-card {
                background: #1a1a1a !important;
                border: 1px solid #333 !important;
                margin-bottom: 0 !important;
                border-radius: 0 !important;
            }
            
            .hover\:bg-gray-50:hover {
                background: #2a2a2a !important;
            }
            
            input, textarea {
                background: #2a2a2a !important;
                color: white !important;
                border-color: #444 !important;
            }
            
            input::placeholder, textarea::placeholder {
                color: #888 !important;
            }
        }
        
        /* Desktop optimizations */
        @media (min-width: 1024px) {
            .max-w-6xl {
                max-width: 72rem;
            }
            
            .lg\:col-span-1 {
                grid-column: span 1 / span 1;
            }
            
            .lg\:col-span-2 {
                grid-column: span 2 / span 2;
            }
        }
        
        /* Tablet optimizations */
        @media (min-width: 768px) and (max-width: 1023px) {
            .md\:grid-cols-3 {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
            
            .md\:space-x-8 > :not([hidden]) ~ :not([hidden]) {
                margin-left: 2rem;
            }
        }
        
        /* Line clamp utility */
        .line-clamp-4 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 4;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center gradient-bg">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md mx-4">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold instagram-gradient bg-clip-text text-transparent">Pulse</h1>
                <p class="text-gray-600 mt-2">Connect with the world</p>
            </div>
            <button id="googleSignIn" class="w-full bg-white border-2 border-gray-300 text-gray-700 py-3 px-4 rounded-xl hover:bg-gray-50 transition duration-300 flex items-center justify-center space-x-2 touch-target">
                <svg class="w-5 h-5" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                <span>Continue with Google</span>
            </button>
        </div>
    </div>

    <!-- Setup Screens -->
    <div id="nameSetup" class="hidden min-h-screen flex items-center justify-center gradient-bg">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md mx-4">
            <h2 class="text-2xl font-bold text-center mb-6">What's your name?</h2>
            <input type="text" id="fullName" placeholder="Enter your full name" class="w-full p-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 outline-none mb-4">
            <button id="nameNext" class="w-full instagram-gradient text-white py-3 rounded-xl font-semibold touch-target">Next</button>
        </div>
    </div>

    <div id="usernameSetup" class="hidden min-h-screen flex items-center justify-center gradient-bg">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md mx-4">
            <h2 class="text-2xl font-bold text-center mb-6">Choose a username</h2>
            <input type="text" id="username" placeholder="username123" class="w-full p-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 outline-none mb-2">
            <p class="text-sm text-gray-500 mb-4">Only lowercase letters and numbers allowed</p>
            <div id="usernameError" class="text-red-500 text-sm mb-4 hidden"></div>
            <button id="usernameNext" class="w-full instagram-gradient text-white py-3 rounded-xl font-semibold touch-target">Next</button>
        </div>
    </div>

    <div id="dobSetup" class="hidden min-h-screen flex items-center justify-center gradient-bg">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md mx-4">
            <h2 class="text-2xl font-bold text-center mb-6">When's your birthday?</h2>
            <input type="date" id="dateOfBirth" class="w-full p-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 outline-none mb-4">
            <button id="dobNext" class="w-full instagram-gradient text-white py-3 rounded-xl font-semibold touch-target">Next</button>
        </div>
    </div>

    <div id="profilePicSetup" class="hidden min-h-screen flex items-center justify-center gradient-bg">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md mx-4">
            <h2 class="text-2xl font-bold text-center mb-6">Add a profile picture</h2>
            <div class="flex justify-center mb-6">
                <div id="previewAvatar" class="w-24 h-24 rounded-full avatar-gradient flex items-center justify-center text-white text-2xl font-bold"></div>
            </div>
            <input type="file" id="profilePicInput" accept="image/*" class="hidden">
            <button id="selectPicBtn" class="w-full border-2 border-purple-500 text-purple-500 py-3 rounded-xl font-semibold mb-4 touch-target">Select Photo</button>
            <button id="skipPic" class="w-full bg-gray-300 text-gray-700 py-3 rounded-xl font-semibold mb-2 touch-target">Skip</button>
            <button id="finishSetup" class="w-full instagram-gradient text-white py-3 rounded-xl font-semibold touch-target">Finish</button>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="hidden min-h-screen flex items-center justify-center gradient-bg">
        <div class="text-center">
            <div class="w-20 h-20 mx-auto mb-6 rounded-full instagram-gradient flex items-center justify-center animate-pulse">
                <span class="text-white text-3xl font-bold">P</span>
            </div>
            <h1 class="text-3xl font-bold instagram-gradient bg-clip-text text-transparent mb-4">Pulse</h1>
            <div class="flex justify-center space-x-1 mb-4">
                <div class="w-2 h-2 bg-pink-500 rounded-full animate-bounce"></div>
                <div class="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            </div>
            <p class="text-white text-sm">Loading your feed...</p>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Top Navigation -->
        <nav class="bg-white shadow-sm border-b sticky top-0 z-50">
            <div class="max-w-6xl mx-auto px-4 mobile-padding">
                <div class="flex justify-between items-center h-16">
                    <h1 class="text-2xl font-bold instagram-gradient bg-clip-text text-transparent">Pulse</h1>
                    
                    <!-- Search Bar -->
                    <div class="hidden md:flex flex-1 max-w-md mx-8">
                        <div class="relative w-full">
                            <input type="text" id="searchInput" placeholder="Search users..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:border-purple-500">
                            <svg class="absolute left-3 top-2.5 w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                            </svg>
                            <div id="searchResults" class="absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-lg shadow-lg mt-1 hidden max-h-64 overflow-y-auto z-50"></div>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-2 md:space-x-4">
                        <button id="mobileSearchBtn" class="md:hidden p-2 rounded-full hover:bg-gray-100 touch-target">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                        <button id="homeBtn" class="p-2 rounded-full hover:bg-gray-100 touch-target" onclick="goHome()">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                            </svg>
                        </button>
                        <button id="notificationBtn" class="p-2 rounded-full hover:bg-gray-100 relative touch-target">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/>
                            </svg>
                            <div id="notificationDot" class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full notification-dot hidden"></div>
                        </button>
                        <button id="messageBtn" class="p-2 rounded-full hover:bg-gray-100 touch-target">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                                <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                            </svg>
                        </button>
                        <button id="settingsBtn" class="p-2 rounded-full hover:bg-gray-100 touch-target">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                        <div id="userAvatar" class="w-8 h-8 md:w-10 md:h-10 rounded-full cursor-pointer avatar-gradient flex items-center justify-center text-white text-sm font-bold touch-target" onclick="openProfile()"></div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Mobile Search Bar -->
        <div id="mobileSearchBar" class="hidden md:hidden bg-white border-b p-4">
            <div class="relative">
                <input type="text" id="mobileSearchInput" placeholder="Search users..." class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:border-purple-500">
                <svg class="absolute left-3 top-3.5 w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                </svg>
                <div id="mobileSearchResults" class="absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-lg shadow-lg mt-1 hidden max-h-64 overflow-y-auto z-50"></div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-6xl mx-auto px-4 py-6 mobile-padding">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Left Sidebar -->
                <div class="lg:col-span-1 hidden lg:block">
                    <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
                        <div class="flex items-center space-x-4 mb-4">
                            <div id="sidebarAvatar" class="w-16 h-16 rounded-full avatar-gradient flex items-center justify-center text-white text-xl font-bold cursor-pointer" onclick="openProfile()"></div>
                            <div>
                                <h3 id="sidebarName" class="font-bold text-lg"></h3>
                                <p id="sidebarUsername" class="text-gray-500"></p>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div>
                                <div id="sidebarBuzzCount" class="font-bold text-lg">0</div>
                                <div class="text-gray-500 text-sm">Buzzes</div>
                            </div>
                            <div>
                                <div id="sidebarFollowingCount" class="font-bold text-lg">0</div>
                                <div class="text-gray-500 text-sm">Following</div>
                            </div>
                            <div>
                                <div id="sidebarFollowerCount" class="font-bold text-lg">0</div>
                                <div class="text-gray-500 text-sm">Followers</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Feed -->
                <div class="lg:col-span-2">
                    <!-- Create Buzz -->
                    <div class="bg-white rounded-2xl shadow-sm p-4 md:p-6 mb-6">
                        <div class="flex space-x-3 md:space-x-4">
                            <div id="createBuzzAvatar" class="w-10 h-10 md:w-12 md:h-12 rounded-full avatar-gradient flex items-center justify-center text-white font-bold flex-shrink-0"></div>
                            <div class="flex-1 relative">
                                <textarea id="buzzText" placeholder="What's buzzing?" class="w-full p-3 border-2 border-gray-200 rounded-xl resize-none focus:border-purple-500 outline-none mobile-text" rows="3"></textarea>
                                <div id="buzzAutocomplete" class="autocomplete-dropdown hidden"></div>
                                <div class="flex items-center justify-between mt-4">
                                    <div class="flex space-x-2 md:space-x-4">
                                        <button id="addImageBtn" class="flex items-center space-x-2 text-purple-500 hover:bg-purple-50 px-3 py-2 rounded-lg touch-target">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                                            </svg>
                                            <span class="hidden md:inline">Photo</span>
                                        </button>
                                        <button id="addPollBtn" class="flex items-center space-x-2 text-blue-500 hover:bg-blue-50 px-3 py-2 rounded-lg touch-target">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                                            </svg>
                                            <span class="hidden md:inline">Poll</span>
                                        </button>
                                        <button id="addLocationBtn" class="flex items-center space-x-2 text-green-500 hover:bg-green-50 px-3 py-2 rounded-lg touch-target">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                                            </svg>
                                            <span class="hidden md:inline">Location</span>
                                        </button>
                                        <input type="file" id="buzzImageInput" accept="image/*" class="hidden">
                                    </div>
                                    <button id="postBuzzBtn" class="instagram-gradient text-white px-4 md:px-6 py-2 rounded-full font-semibold touch-target">Buzz</button>
                                </div>
                                <div id="imagePreview" class="mt-4 hidden">
                                    <img id="previewImg" class="w-full max-h-64 object-cover rounded-xl">
                                    <button id="removeImage" class="mt-2 text-red-500 text-sm touch-target">Remove image</button>
                                </div>
                                
                                <!-- Poll Preview -->
                                <div id="pollPreview" class="mt-4 hidden border border-gray-200 rounded-xl p-4">
                                    <div class="flex justify-between items-center mb-3">
                                        <h4 class="font-semibold">Create Poll</h4>
                                        <button id="removePoll" class="text-red-500 text-sm touch-target">Remove</button>
                                    </div>
                                    <div class="space-y-2">
                                        <input type="text" id="pollOption1" placeholder="Option 1" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" maxlength="25">
                                        <input type="text" id="pollOption2" placeholder="Option 2" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" maxlength="25">
                                        <input type="text" id="pollOption3" placeholder="Option 3 (optional)" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" maxlength="25">
                                        <input type="text" id="pollOption4" placeholder="Option 4 (optional)" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" maxlength="25">
                                    </div>
                                    <div class="mt-3">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Poll Duration</label>
                                        <select id="pollDuration" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                                            <option value="1">1 day</option>
                                            <option value="3" selected>3 days</option>
                                            <option value="7">7 days</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Location Preview -->
                                <div id="locationPreview" class="mt-4 hidden border border-gray-200 rounded-xl p-4">
                                    <div class="flex justify-between items-center mb-3">
                                        <h4 class="font-semibold">Location</h4>
                                        <button id="removeLocation" class="text-red-500 text-sm touch-target">Remove</button>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <div id="mapPreview" class="w-16 h-16 rounded-lg overflow-hidden"></div>
                                        <div>
                                            <div id="selectedLocation" class="text-sm font-medium"></div>
                                            <div class="text-xs text-gray-500">Current location</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Link Preview -->
                                <div id="linkPreview" class="mt-4 hidden border border-gray-200 rounded-xl overflow-hidden">
                                    <div class="flex justify-between items-center p-3 border-b">
                                        <h4 class="font-semibold text-sm">Link Preview</h4>
                                        <button id="removeLinkPreview" class="text-red-500 text-sm touch-target">Remove</button>
                                    </div>
                                    <img id="linkPreviewImage" class="w-full h-32 object-cover hidden">
                                    <div class="p-3">
                                        <h5 id="linkPreviewTitle" class="font-semibold text-sm line-clamp-2"></h5>
                                        <p id="linkPreviewDescription" class="text-xs text-gray-600 line-clamp-2 mt-1"></p>
                                        <a id="linkPreviewUrl" href="#" target="_blank" class="text-xs text-blue-500 hover:underline mt-1 block"></a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Feed -->
                    <div id="buzzFeed" class="space-y-6">
                        <!-- Buzzes will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Full Screen Pages -->
    <!-- Notification Page -->
    <div id="notificationPage" class="hidden fixed inset-0 bg-white z-50">
        <div class="h-full flex flex-col">
            <div class="bg-white border-b p-4 flex items-center">
                <button onclick="hidePage('notificationPage')" class="p-2 rounded-full hover:bg-gray-100 mr-4 touch-target">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"/>
                    </svg>
                </button>
                <h3 class="text-xl font-bold">Notifications</h3>
            </div>
            <div id="notificationList" class="flex-1 overflow-y-auto p-4">
                <p class="text-gray-500 text-center">No notifications yet</p>
            </div>
        </div>
    </div>

    <!-- Message Modal -->
    <div id="messageModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-96 overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Messages</h3>
                <button onclick="hideModal('messageModal')" class="text-gray-500 hover:text-gray-700 touch-target">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>
            <div id="messageList" class="p-6">
                <p class="text-gray-500 text-center">No messages yet</p>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-96 overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Settings</h3>
                <button onclick="hideModal('settingsModal')" class="text-gray-500 hover:text-gray-700 touch-target">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <button id="profileSettingsBtn" class="w-full text-left p-3 hover:bg-gray-50 rounded-lg touch-target">Profile Settings</button>
                <button id="verificationBtn" class="w-full text-left p-3 hover:bg-gray-50 rounded-lg touch-target">Request Verification</button>
                <button id="privacyBtn" class="w-full text-left p-3 hover:bg-gray-50 rounded-lg touch-target">Privacy</button>
                <button id="blockListBtn" class="w-full text-left p-3 hover:bg-gray-50 rounded-lg touch-target">Blocked Users</button>
                <button id="addAccountBtn" class="w-full text-left p-3 hover:bg-gray-50 rounded-lg touch-target">Add Account</button>
                <button class="w-full text-left p-3 hover:bg-gray-50 rounded-lg touch-target">Notifications</button>
                <button id="logoutBtn" class="w-full text-left p-3 hover:bg-gray-50 rounded-lg text-red-500 touch-target">Logout</button>
            </div>
        </div>
    </div>

    <!-- Comment Modal -->
    <div id="commentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-96 overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Comments</h3>
                <button onclick="hideModal('commentModal')" class="text-gray-500 hover:text-gray-700 touch-target">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>
            <div id="commentList" class="p-6 max-h-64 overflow-y-auto">
                <!-- Comments will be loaded here -->
            </div>
            <div class="p-6 border-t">
                <div class="flex space-x-3">
                    <div id="commentAvatar" class="w-8 h-8 rounded-full avatar-gradient flex items-center justify-center text-white text-sm font-bold flex-shrink-0"></div>
                    <div class="flex-1 relative">
                        <input type="text" id="commentInput" placeholder="Add a comment..." class="w-full p-2 border border-gray-300 rounded-full outline-none focus:border-purple-500">
                        <div id="commentAutocomplete" class="autocomplete-dropdown hidden"></div>
                    </div>
                    <button id="postCommentBtn" class="instagram-gradient text-white px-4 py-2 rounded-full text-sm font-semibold touch-target">Post</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Page -->
    <div id="profilePage" class="hidden fixed inset-0 bg-white z-50">
        <div class="h-full flex flex-col">
            <!-- Header -->
            <div class="bg-white border-b p-4 flex items-center justify-between">
                <div class="flex items-center">
                    <button onclick="hidePage('profilePage')" class="p-2 rounded-full hover:bg-gray-100 mr-4 touch-target">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                    <h3 id="profilePageUsername" class="text-xl font-bold">@username</h3>
                </div>
                <button onclick="openSettingsPage()" class="p-2 rounded-full hover:bg-gray-100 touch-target">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/>
                    </svg>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto">
                <!-- Profile Header - Instagram Style -->
                <div class="p-4">
                    <div class="flex items-start space-x-4 mb-4">
                        <div id="profileModalAvatar" class="w-20 h-20 md:w-24 md:h-24 rounded-full avatar-gradient flex items-center justify-center text-white text-xl md:text-2xl font-bold flex-shrink-0"></div>
                        <div class="flex-1">
                            <h2 id="profileModalName" class="text-xl md:text-2xl font-bold mb-1"></h2>
                            <div class="flex space-x-6 mb-3">
                                <div class="text-center">
                                    <div id="profileBuzzCount" class="font-bold text-lg">0</div>
                                    <div class="text-gray-500 text-xs">posts</div>
                                </div>
                                <div class="text-center cursor-pointer" onclick="showFollowersPage()">
                                    <div id="profileFollowerCount" class="font-bold text-lg">0</div>
                                    <div class="text-gray-500 text-xs">followers</div>
                                </div>
                                <div class="text-center cursor-pointer" onclick="showFollowingPage()">
                                    <div id="profileFollowingCount" class="font-bold text-lg">0</div>
                                    <div class="text-gray-500 text-xs">following</div>
                                </div>
                            </div>
                            <button onclick="openEditProfilePage()" class="w-full bg-gray-100 text-black px-4 py-2 rounded-lg font-semibold text-sm touch-target">Edit Profile</button>
                        </div>
                    </div>
                    
                    <div id="profileBio" class="text-gray-800 mb-4 text-sm"></div>
                </div>

                <!-- Profile Tabs -->
                <div class="border-b">
                    <nav class="flex">
                        <button id="buzzesTab" class="flex-1 py-3 text-center border-b-2 border-black text-black font-semibold text-sm touch-target">
                            <svg class="w-6 h-6 mx-auto" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M3 3h18v18H3V3zm16 16V5H5v14h14z"/>
                                <path d="M11 7h2v10h-2V7zM7 11h2v6H7v-6zM15 9h2v8h-2V9z"/>
                            </svg>
                        </button>
                        <button id="mediaTab" class="flex-1 py-3 text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-sm touch-target">
                            <svg class="w-6 h-6 mx-auto" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M4 4h16v16H4V4zm14 14V6H6v12h12z"/>
                                <path d="M8 8h8v8H8V8z"/>
                            </svg>
                        </button>
                        <button id="likesTab" class="flex-1 py-3 text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-sm touch-target">
                            <svg class="w-6 h-6 mx-auto" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                            </svg>
                        </button>
                    </nav>
                </div>

                <!-- Profile Content -->
                <div id="profileContent" class="p-1">
                    <!-- Content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- User Profile Page -->
    <div id="userProfilePage" class="hidden fixed inset-0 bg-white z-50">
        <div class="h-full flex flex-col">
            <!-- Header -->
            <div class="bg-white border-b p-4 flex items-center justify-between">
                <div class="flex items-center">
                    <button onclick="hidePage('userProfilePage')" class="p-2 rounded-full hover:bg-gray-100 mr-4 touch-target">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                    <h3 id="userProfilePageUsername" class="text-xl font-bold">@username</h3>
                </div>
                <button onclick="openUserProfileMenu()" class="p-2 rounded-full hover:bg-gray-100 touch-target">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/>
                    </svg>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto">
                <div id="userProfileContent" class="p-4">
                    <!-- User profile content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-screen overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center sticky top-0 bg-white">
                <h3 class="text-xl font-bold">Edit Profile</h3>
                <button id="closeEditProfileBtn" class="text-gray-500 hover:text-gray-700 touch-target">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex justify-center mb-6">
                    <div class="relative">
                        <div id="editProfileAvatar" class="w-24 h-24 rounded-full avatar-gradient flex items-center justify-center text-white text-2xl font-bold cursor-pointer touch-target"></div>
                        <div id="editProfilePicBtn" class="absolute bottom-0 right-0 bg-purple-500 text-white rounded-full p-2 cursor-pointer touch-target">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                            </svg>
                        </div>
                    </div>
                </div>
                <input type="file" id="editProfilePicInput" accept="image/*" class="hidden">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Name *</label>
                    <input type="text" id="editName" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500" placeholder="Your full name">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username *</label>
                    <input type="text" id="editUsername" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500" placeholder="username123">
                    <p class="text-sm text-gray-500 mt-1">Only lowercase letters and numbers</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Bio</label>
                    <textarea id="editBio" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500" placeholder="Tell us about yourself..."></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="editEmail" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500" placeholder="your@email.com">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                    <input type="tel" id="editPhone" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500" placeholder="+1234567890">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Website</label>
                    <input type="url" id="editWebsite" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500" placeholder="https://yourwebsite.com">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date of Birth</label>
                    <input type="date" id="editDob" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500">
                </div>
                
                <div class="flex space-x-3 pt-4">
                    <button id="cancelEditProfileBtn" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 touch-target">Cancel</button>
                    <button id="saveProfileBtn" class="flex-1 px-4 py-2 instagram-gradient text-white rounded-lg touch-target">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Privacy Settings Modal -->
    <div id="privacyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Privacy Settings</h3>
                <button onclick="hideModal('privacyModal')" class="text-gray-500 hover:text-gray-700 touch-target">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex items-center justify-between">
                    <span>Private Account</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="privateAccountToggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
                    </label>
                </div>
                <p class="text-sm text-gray-500">When your account is private, only people you approve can see your buzzes</p>
            </div>
        </div>
    </div>

    <!-- Block List Modal -->
    <div id="blockListModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-96 overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Blocked Users</h3>
                <button onclick="hideModal('blockListModal')" class="text-gray-500 hover:text-gray-700 touch-target">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>
            <div id="blockList" class="p-6">
                <p class="text-gray-500 text-center">No blocked users</p>
            </div>
        </div>
    </div>

    <!-- Verification Request Modal -->
    <div id="verificationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-screen overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Request Verification</h3>
                <button onclick="hideModal('verificationModal')" class="text-gray-500 hover:text-gray-700 touch-target">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>
            <div class="p-6 space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Full Name (as on National ID) *</label>
                    <input type="text" id="verificationName" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500" placeholder="Enter your full legal name">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Why do you think you deserve a verified badge? *</label>
                    <textarea id="verificationReason" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500" placeholder="Explain why you should be verified..."></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Other name you're known by (Optional)</label>
                    <input type="text" id="verificationOtherName" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500" placeholder="Stage name, pen name, etc.">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Country *</label>
                    <select id="verificationCountry" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500">
                        <option value="">Select Country</option>
                        <option value="US">United States</option>
                        <option value="IN">India</option>
                        <option value="UK">United Kingdom</option>
                        <option value="CA">Canada</option>
                        <option value="AU">Australia</option>
                        <option value="DE">Germany</option>
                        <option value="FR">France</option>
                        <option value="JP">Japan</option>
                        <option value="BR">Brazil</option>
                        <option value="MX">Mexico</option>
                        <option value="IT">Italy</option>
                        <option value="ES">Spain</option>
                        <option value="RU">Russia</option>
                        <option value="CN">China</option>
                        <option value="KR">South Korea</option>
                        <option value="SG">Singapore</option>
                        <option value="AE">UAE</option>
                        <option value="SA">Saudi Arabia</option>
                        <option value="ZA">South Africa</option>
                        <option value="NG">Nigeria</option>
                        <option value="EG">Egypt</option>
                        <option value="AR">Argentina</option>
                        <option value="CL">Chile</option>
                        <option value="CO">Colombia</option>
                        <option value="PE">Peru</option>
                        <option value="TH">Thailand</option>
                        <option value="VN">Vietnam</option>
                        <option value="ID">Indonesia</option>
                        <option value="MY">Malaysia</option>
                        <option value="PH">Philippines</option>
                        <option value="BD">Bangladesh</option>
                        <option value="PK">Pakistan</option>
                        <option value="LK">Sri Lanka</option>
                        <option value="NP">Nepal</option>
                        <option value="MM">Myanmar</option>
                        <option value="KH">Cambodia</option>
                        <option value="LA">Laos</option>
                        <option value="BN">Brunei</option>
                        <option value="MV">Maldives</option>
                        <option value="BT">Bhutan</option>
                        <option value="AF">Afghanistan</option>
                        <option value="IR">Iran</option>
                        <option value="IQ">Iraq</option>
                        <option value="SY">Syria</option>
                        <option value="LB">Lebanon</option>
                        <option value="JO">Jordan</option>
                        <option value="IL">Israel</option>
                        <option value="PS">Palestine</option>
                        <option value="TR">Turkey</option>
                        <option value="GR">Greece</option>
                        <option value="BG">Bulgaria</option>
                        <option value="RO">Romania</option>
                        <option value="HU">Hungary</option>
                        <option value="CZ">Czech Republic</option>
                        <option value="SK">Slovakia</option>
                        <option value="PL">Poland</option>
                        <option value="LT">Lithuania</option>
                        <option value="LV">Latvia</option>
                        <option value="EE">Estonia</option>
                        <option value="FI">Finland</option>
                        <option value="SE">Sweden</option>
                        <option value="NO">Norway</option>
                        <option value="DK">Denmark</option>
                        <option value="IS">Iceland</option>
                        <option value="IE">Ireland</option>
                        <option value="NL">Netherlands</option>
                        <option value="BE">Belgium</option>
                        <option value="LU">Luxembourg</option>
                        <option value="CH">Switzerland</option>
                        <option value="AT">Austria</option>
                        <option value="PT">Portugal</option>
                        <option value="MT">Malta</option>
                        <option value="CY">Cyprus</option>
                        <option value="HR">Croatia</option>
                        <option value="SI">Slovenia</option>
                        <option value="BA">Bosnia and Herzegovina</option>
                        <option value="RS">Serbia</option>
                        <option value="ME">Montenegro</option>
                        <option value="MK">North Macedonia</option>
                        <option value="AL">Albania</option>
                        <option value="XK">Kosovo</option>
                        <option value="MD">Moldova</option>
                        <option value="UA">Ukraine</option>
                        <option value="BY">Belarus</option>
                        <option value="GE">Georgia</option>
                        <option value="AM">Armenia</option>
                        <option value="AZ">Azerbaijan</option>
                        <option value="KZ">Kazakhstan</option>
                        <option value="UZ">Uzbekistan</option>
                        <option value="TM">Turkmenistan</option>
                        <option value="KG">Kyrgyzstan</option>
                        <option value="TJ">Tajikistan</option>
                        <option value="MN">Mongolia</option>
                        <option value="NZ">New Zealand</option>
                        <option value="FJ">Fiji</option>
                        <option value="PG">Papua New Guinea</option>
                        <option value="SB">Solomon Islands</option>
                        <option value="VU">Vanuatu</option>
                        <option value="NC">New Caledonia</option>
                        <option value="PF">French Polynesia</option>
                        <option value="WS">Samoa</option>
                        <option value="TO">Tonga</option>
                        <option value="KI">Kiribati</option>
                        <option value="TV">Tuvalu</option>
                        <option value="NR">Nauru</option>
                        <option value="PW">Palau</option>
                        <option value="FM">Micronesia</option>
                        <option value="MH">Marshall Islands</option>
                    </select>
                </div>
                
                <div id="documentTypeSection" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Document Type *</label>
                    <select id="verificationDocType" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500">
                        <option value="">Select Document Type</option>
                    </select>
                </div>
                
                <div id="documentUploadSection" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Upload Document *</label>
                    <input type="file" id="verificationDocument" accept="image/*" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500">
                    <p class="text-sm text-gray-500 mt-1">Upload a clear photo of your document</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Social Media Links (Optional)</label>
                    <p class="text-sm text-gray-500 mb-3">Add up to 5 links to verified accounts or news articles</p>
                    <div id="socialLinksContainer">
                        <input type="url" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500 mb-2" placeholder="https://instagram.com/username">
                        <input type="url" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500 mb-2" placeholder="https://facebook.com/username">
                        <input type="url" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500 mb-2" placeholder="https://youtube.com/channel">
                        <input type="url" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500 mb-2" placeholder="News article link">
                        <input type="url" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500 mb-2" placeholder="Additional link">
                    </div>
                </div>
                
                <div class="flex space-x-3 pt-4">
                    <button onclick="hideModal('verificationModal')" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 touch-target">Cancel</button>
                    <button onclick="submitVerificationRequest()" class="flex-1 px-4 py-2 instagram-gradient text-white rounded-lg touch-target">Submit Request</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Modal -->
    <div id="messageModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl h-96 flex">
            <!-- Conversations List -->
            <div class="w-1/3 border-r">
                <div class="p-4 border-b">
                    <h3 class="text-lg font-bold">Messages</h3>
                </div>
                <div id="conversationsList" class="overflow-y-auto h-full">
                    <!-- Conversations will be loaded here -->
                </div>
            </div>
            
            <!-- Chat Area -->
            <div class="flex-1 flex flex-col">
                <div id="chatHeader" class="p-4 border-b hidden">
                    <div class="flex items-center space-x-3">
                        <div id="chatUserAvatar" class="w-10 h-10 rounded-full avatar-gradient flex items-center justify-center text-white font-bold"></div>
                        <div>
                            <div id="chatUserName" class="font-semibold"></div>
                            <div id="chatUserUsername" class="text-sm text-gray-500"></div>
                        </div>
                    </div>
                </div>
                
                <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-3">
                    <div class="text-center text-gray-500">Select a conversation to start messaging</div>
                </div>
                
                <div id="messageInputContainer" class="p-4 border-t hidden">
                    <div class="flex space-x-3">
                        <input type="text" id="messageInput" placeholder="Type a message..." class="flex-1 p-3 border border-gray-300 rounded-full outline-none focus:border-purple-500">
                        <button id="sendMessageBtn" class="instagram-gradient text-white px-6 py-3 rounded-full font-semibold touch-target">Send</button>
                    </div>
                </div>
            </div>
            
            <button onclick="hideModal('messageModal')" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 touch-target">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="shareModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-96 overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Share Buzz</h3>
                <button onclick="hideModal('shareModal')" class="text-gray-500 hover:text-gray-700 touch-target">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>
            <div class="p-4">
                <input type="text" id="shareSearchInput" placeholder="Search users..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500 mb-4">
                <div id="shareUsersList" class="space-y-2 max-h-64 overflow-y-auto">
                    <!-- Users will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Hashtag Modal -->
    <div id="hashtagModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-screen overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 id="hashtagTitle" class="text-xl font-bold">#hashtag</h3>
                <button onclick="hideModal('hashtagModal')" class="text-gray-500 hover:text-gray-700 touch-target">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="text-center">
                        <div id="hashtagPostCount" class="text-2xl font-bold text-blue-600">0</div>
                        <div class="text-gray-500">Posts</div>
                    </div>
                    <div class="text-center">
                        <div id="hashtagUserCount" class="text-2xl font-bold text-blue-600">0</div>
                        <div class="text-gray-500">Users</div>
                    </div>
                    <div class="text-center">
                        <div id="hashtagEngagement" class="text-2xl font-bold text-blue-600">0</div>
                        <div class="text-gray-500">Engagement</div>
                    </div>
                </div>
                <div id="hashtagPosts" class="space-y-4">
                    <!-- Hashtag posts will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Followers/Following Modal -->
    <div id="followListModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-96 overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 id="followListTitle" class="text-xl font-bold">Followers</h3>
                <button onclick="hideModal('followListModal')" class="text-gray-500 hover:text-gray-700 touch-target">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>
            <div id="followListContent" class="p-6">
                <!-- Follow list will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Settings Page -->
    <div id="settingsPage" class="hidden fixed inset-0 bg-white z-50">
        <div class="h-full flex flex-col">
            <div class="bg-white border-b p-4 flex items-center">
                <button onclick="hidePage('settingsPage')" class="p-2 rounded-full hover:bg-gray-100 mr-4 touch-target">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"/>
                    </svg>
                </button>
                <h3 class="text-xl font-bold">Settings</h3>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-2">
                <button onclick="openEditProfilePage()" class="w-full text-left p-4 hover:bg-gray-50 rounded-lg touch-target flex items-center">
                    <svg class="w-6 h-6 mr-3 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"/>
                    </svg>
                    Profile Settings
                </button>
                <button onclick="showModal('verificationModal')" class="w-full text-left p-4 hover:bg-gray-50 rounded-lg touch-target flex items-center">
                    <svg class="w-6 h-6 mr-3 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    Request Verification
                </button>
                <button onclick="showModal('privacyModal')" class="w-full text-left p-4 hover:bg-gray-50 rounded-lg touch-target flex items-center">
                    <svg class="w-6 h-6 mr-3 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                    </svg>
                    Privacy
                </button>
                <button onclick="showModal('blockListModal')" class="w-full text-left p-4 hover:bg-gray-50 rounded-lg touch-target flex items-center">
                    <svg class="w-6 h-6 mr-3 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z" clip-rule="evenodd"/>
                    </svg>
                    Blocked Users
                </button>
                <button class="w-full text-left p-4 hover:bg-gray-50 rounded-lg touch-target flex items-center">
                    <svg class="w-6 h-6 mr-3 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/>
                    </svg>
                    Notifications
                </button>
                <button onclick="showModal('aboutPulseModal')" class="w-full text-left p-4 hover:bg-gray-50 rounded-lg touch-target flex items-center">
                    <svg class="w-6 h-6 mr-3 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
                    About Pulse
                </button>
                <button onclick="logout()" class="w-full text-left p-4 hover:bg-gray-50 rounded-lg text-red-500 touch-target flex items-center">
                    <svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd"/>
                    </svg>
                    Logout
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Profile Page -->
    <div id="editProfilePage" class="hidden fixed inset-0 bg-white z-50">
        <div class="h-full flex flex-col">
            <div class="bg-white border-b p-4 flex items-center justify-between">
                <button onclick="hidePage('editProfilePage')" class="text-gray-600 font-semibold touch-target">Cancel</button>
                <h3 class="text-xl font-bold">Edit Profile</h3>
                <button onclick="saveProfileChanges()" class="text-blue-600 font-semibold touch-target">Done</button>
            </div>
            <div class="flex-1 overflow-y-auto">
                <!-- Profile Picture Section -->
                <div class="p-6 border-b">
                    <div class="flex justify-center mb-4">
                        <div class="relative">
                            <div id="editPageProfileAvatar" class="w-24 h-24 rounded-full avatar-gradient flex items-center justify-center text-white text-2xl font-bold cursor-pointer" onclick="document.getElementById('editPageProfilePicInput').click()"></div>
                            <div class="absolute bottom-0 right-0 bg-blue-500 text-white rounded-full p-2 cursor-pointer" onclick="document.getElementById('editPageProfilePicInput').click()">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <p class="text-center text-blue-600 font-semibold cursor-pointer" onclick="document.getElementById('editPageProfilePicInput').click()">Change Profile Photo</p>
                    <input type="file" id="editPageProfilePicInput" accept="image/*" class="hidden">
                </div>
                
                <!-- Form Fields -->
                <div class="p-4 space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                        <input type="text" id="editPageName" class="w-full p-3 border-b border-gray-300 focus:outline-none focus:border-blue-500 bg-transparent" placeholder="Name">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                        <input type="text" id="editPageUsername" class="w-full p-3 border-b border-gray-300 focus:outline-none focus:border-blue-500 bg-transparent" placeholder="Username">
                        <p class="text-xs text-gray-500 mt-1">Only lowercase letters and numbers</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Bio</label>
                        <textarea id="editPageBio" rows="3" class="w-full p-3 border-b border-gray-300 focus:outline-none focus:border-blue-500 bg-transparent resize-none" placeholder="Bio"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="editPageEmail" class="w-full p-3 border-b border-gray-300 focus:outline-none focus:border-blue-500 bg-transparent" placeholder="Email">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                        <input type="tel" id="editPagePhone" class="w-full p-3 border-b border-gray-300 focus:outline-none focus:border-blue-500 bg-transparent" placeholder="Phone">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Website</label>
                        <input type="url" id="editPageWebsite" class="w-full p-3 border-b border-gray-300 focus:outline-none focus:border-blue-500 bg-transparent" placeholder="Website">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date of Birth</label>
                        <input type="date" id="editPageDob" class="w-full p-3 border-b border-gray-300 focus:outline-none focus:border-blue-500 bg-transparent">
                    </div>
                </div>
                
                <!-- Personal Information Section -->
                <div class="p-4 border-t">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">Personal Information</h4>
                    <p class="text-sm text-gray-500 mb-4">Provide your personal information, even if the account is used for a business, a pet or something else. This won't be part of your public profile.</p>
                    
                    <div class="space-y-4">
                        <div class="flex items-center justify-between py-3 border-b border-gray-200">
                            <div>
                                <div class="font-medium">Gender</div>
                                <div class="text-sm text-gray-500">This won't be part of your public profile</div>
                            </div>
                            <select id="editPageGender" class="text-gray-600 bg-transparent">
                                <option value="">Prefer not to say</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Messages Page -->
    <div id="messagesPage" class="hidden fixed inset-0 bg-white z-50">
        <div class="h-full flex flex-col">
            <div class="bg-white border-b p-4 flex items-center">
                <button onclick="hidePage('messagesPage')" class="p-2 rounded-full hover:bg-gray-100 mr-4 touch-target">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"/>
                    </svg>
                </button>
                <h3 class="text-xl font-bold">Messages</h3>
            </div>
            <div id="messagesConversationsList" class="flex-1 overflow-y-auto">
                <!-- Conversations will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Chat Page -->
    <div id="chatPage" class="hidden fixed inset-0 bg-white z-50">
        <div class="h-full flex flex-col">
            <div class="bg-white border-b p-4 flex items-center">
                <button onclick="hidePage('chatPage')" class="p-2 rounded-full hover:bg-gray-100 mr-4 touch-target">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"/>
                    </svg>
                </button>
                <div class="flex items-center space-x-3">
                    <div id="chatUserAvatar" class="w-10 h-10 rounded-full avatar-gradient flex items-center justify-center text-white font-bold"></div>
                    <div>
                        <div id="chatUserName" class="font-semibold"></div>
                        <div id="chatUserUsername" class="text-sm text-gray-500"></div>
                    </div>
                </div>
            </div>
            
            <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-3">
                <!-- Messages will be loaded here -->
            </div>
            
            <div class="border-t p-4">
                <div class="flex space-x-3">
                    <input type="text" id="messageInput" placeholder="Type a message..." class="flex-1 p-3 border border-gray-300 rounded-full outline-none focus:border-purple-500">
                    <button id="sendMessageBtn" class="instagram-gradient text-white px-6 py-3 rounded-full font-semibold touch-target">Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- About Pulse Modal -->
    <div id="aboutPulseModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">About Pulse</h3>
                <button onclick="hideModal('aboutPulseModal')" class="text-gray-500 hover:text-gray-700 touch-target">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>
            <div class="p-6 text-center">
                <div class="w-20 h-20 mx-auto mb-4 rounded-full instagram-gradient flex items-center justify-center">
                    <span class="text-white text-3xl font-bold">P</span>
                </div>
                <h2 class="text-2xl font-bold mb-2 instagram-gradient bg-clip-text text-transparent">Pulse</h2>
                <p class="text-gray-600 mb-4">Version 81.08.09</p>
                <p class="text-gray-700 mb-6">Connect with the world through Pulse - the social media platform that brings people together.</p>
                
                <div class="space-y-3 mb-6">
                    <button onclick="showModal('privacyPolicyModal'); hideModal('aboutPulseModal')" class="w-full text-left p-3 hover:bg-gray-50 rounded-lg text-blue-600 touch-target">
                        Privacy Policy
                    </button>
                    <button onclick="showModal('termsModal'); hideModal('aboutPulseModal')" class="w-full text-left p-3 hover:bg-gray-50 rounded-lg text-blue-600 touch-target">
                        Terms of Service
                    </button>
                </div>
                
                <div class="border-t pt-4">
                    <p class="text-xs text-gray-500"> 2024 Pulse. All rights reserved.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Privacy Policy Modal -->
    <div id="privacyPolicyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-screen overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center sticky top-0 bg-white">
                <h3 class="text-xl font-bold">Privacy Policy</h3>
                <button onclick="hideModal('privacyPolicyModal')" class="text-gray-500 hover:text-gray-700 touch-target">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>
            <div class="p-6 space-y-6 text-sm text-gray-700 leading-relaxed">
                <div>
                    <h4 class="text-lg font-semibold text-gray-900 mb-3">1. Information We Collect</h4>
                    <p class="mb-3">We collect information you provide directly to us, such as when you create an account, post content, or contact us. This includes:</p>
                    <ul class="list-disc pl-6 space-y-1">
                        <li>Account information (name, username, email address, phone number)</li>
                        <li>Profile information (bio, profile picture, date of birth)</li>
                        <li>Content you post (buzzes, comments, messages)</li>
                        <li>Communications with us and other users</li>
                    </ul>
                </div>
                
                <div>
                    <h4 class="text-lg font-semibold text-gray-900 mb-3">2. How We Use Your Information</h4>
                    <p class="mb-3">We use the information we collect to:</p>
                    <ul class="list-disc pl-6 space-y-1">
                        <li>Provide, maintain, and improve our services</li>
                        <li>Process transactions and send related information</li>
                        <li>Send technical notices, updates, security alerts</li>
                        <li>Respond to your comments, questions, and requests</li>
                        <li>Communicate with you about products, services, and events</li>
                        <li>Monitor and analyze trends, usage, and activities</li>
                        <li>Detect, investigate, and prevent fraudulent transactions</li>
                    </ul>
                </div>
                
                <div>
                    <h4 class="text-lg font-semibold text-gray-900 mb-3">3. Information Sharing</h4>
                    <p class="mb-3">We may share information about you as follows:</p>
                    <ul class="list-disc pl-6 space-y-1">
                        <li>With other users when you post content publicly</li>
                        <li>With vendors, consultants, and other service providers</li>
                        <li>In response to legal requests or to protect rights and safety</li>
                        <li>In connection with a merger, acquisition, or sale of assets</li>
                        <li>With your consent or at your direction</li>
                    </ul>
                </div>
                
                <div>
                    <h4 class="text-lg font-semibold text-gray-900 mb-3">4. Data Security</h4>
                    <p>We take reasonable measures to help protect information about you from loss, theft, misuse, unauthorized access, disclosure, alteration, and destruction. However, no internet or electronic storage system is 100% secure.</p>
                </div>
                
                <div>
                    <h4 class="text-lg font-semibold text-gray-900 mb-3">5. Data Retention</h4>
                    <p>We store the information we collect about you for as long as is necessary for the purpose(s) for which we originally collected it. We may retain certain information for legitimate business purposes or as required by law.</p>
                </div>
                
                <div>
                    <h4 class="text-lg font-semibold text-gray-900 mb-3">6. Your Rights</h4>
                    <p class="mb-3">You have the right to:</p>
                    <ul class="list-disc pl-6 space-y-1">
                        <li>Access and update your personal information</li>
                        <li>Delete your account and associated data</li>
                        <li>Object to processing of your personal information</li>
                        <li>Request data portability</li>
                        <li>Withdraw consent where applicable</li>
                    </ul>
                </div>
                
                <div>
                    <h4 class="text-lg font-semibold text-gray-900 mb-3">7. Cookies and Tracking</h4>
                    <p>We use cookies and similar tracking technologies to track activity on our service and hold certain information. You can instruct your browser to refuse all cookies or to indicate when a cookie is being sent.</p>
                </div>
                
                <div>
                    <h4 class="text-lg font-semibold text-gray-900 mb-3">8. Third-Party Services</h4>
                    <p>Our service may contain links to third-party websites or services that are not owned or controlled by us. We have no control over and assume no responsibility for the content, privacy policies, or practices of any third-party services.</p>
                </div>
                
                <div>
                    <h4 class="text-lg font-semibold text-gray-900 mb-3">9. Children's Privacy</h4>
                    <p>Our service does not address anyone under the age of 13. We do not knowingly collect personally identifiable information from children under 13. If you are a parent or guardian and believe your child has provided us with personal information, please contact us.</p>
                </div>
                
                <div>
                    <h4 class="text-lg font-semibold text-gray-900 mb-3">10. International Data Transfers</h4>
                    <p>Your information may be transferred to and maintained on computers located outside of your state, province, country, or other governmental jurisdiction where data protection laws may differ.</p>
                </div>
                
                <div>
                    <h4 class="text-lg font-semibold text-gray-900 mb-3">11. Changes to Privacy Policy</h4>
                    <p>We may update our Privacy Policy from time to time. We will notify you of any changes by posting the new Privacy Policy on this page and updating the "effective date" at the top of this Privacy Policy.</p>
                </div>
                
                <div>
                    <h4 class="text-lg font-semibold text-gray-900 mb-3">12. Contact Us</h4>
                    <p class="mb-3">If you have any questions about this Privacy Policy, please contact us:</p>
                    <ul class="list-disc pl-6 space-y-1">
                        <li>By email: privacy@pulse.com</li>
                        <li>By phone: +1-555-PULSE-01</li>
                        <li>On our website: pulse.com/contact</li>
                    </ul>
                </div>
                
                <div class="border-t pt-6">
                    <p class="text-xs text-gray-500">Last updated: December 2024</p>
                    <p class="text-xs text-gray-500 mt-2"> 2024 Pulse. All rights reserved.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Toast Notification -->
    <div id="customToast" class="hidden fixed top-4 right-4 z-50 max-w-sm">
        <div class="bg-white border border-gray-200 rounded-lg shadow-lg p-4 flex items-center space-x-3">
            <div id="toastIcon" class="flex-shrink-0">
                <!-- Icon will be inserted here -->
            </div>
            <div class="flex-1">
                <div id="toastTitle" class="font-semibold text-gray-900"></div>
                <div id="toastMessage" class="text-sm text-gray-600"></div>
            </div>
            <button onclick="hideToast()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                </svg>
            </button>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC30TcmMVhP_8HdFYS1WufRiZwSDYNMTF0",
            authDomain: "pulse2-92372.firebaseapp.com",
            databaseURL: "https://pulse2-92372-default-rtdb.firebaseio.com",
            projectId: "pulse2-92372",
            storageBucket: "pulse2-92372.firebasestorage.app",
            messagingSenderId: "276235725177",
            appId: "1:276235725177:web:0f4e0789fae80a435927a8"
        };

        // API Keys Configuration
        const API_KEYS = {
            safeBrowsing: "AIzaSyC25CucKloJCXqbq-I0NuXi5aN3l-Nkc1Y",
            youtube: "AIzaSyAvmam8BVo9PtXHY9-_F6x9SYidyvSZTxE",
            linkPreview: "3939f4f637fc345cc8e94113c98139b2"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();

        let currentUser = null;
        let currentBuzzId = null;
        let selectedImage = null;
        let currentUserData = null;
        let activeProfileTab = 'buzzes';
        let userBuzzes = [];
        let userRebuzzes = [];
        let userLikes = [];
        let blockedUsers = [];
        let allUsers = [];
        let currentChatUser = null;
        let currentShareBuzzId = null;
        let allHashtags = [];
        let currentAutocompleteInput = null;
        
        // Document types by country
        const documentTypes = {
            'US': ['Passport', 'Driver License', 'State ID'],
            'IN': ['PAN Card', 'Voter ID', 'Aadhaar Card', 'Passport', 'Driver License'],
            'UK': ['Passport', 'Driver License', 'National ID'],
            'CA': ['Passport', 'Driver License', 'Provincial ID'],
            'AU': ['Passport', 'Driver License', 'Proof of Age Card'],
            'DE': ['Passport', 'National ID', 'Driver License'],
            'FR': ['Passport', 'National ID', 'Driver License'],
            'JP': ['Passport', 'Driver License', 'Residence Card'],
            'BR': ['Passport', 'National ID', 'Driver License'],
            'MX': ['Passport', 'National ID', 'Driver License'],
            'IT': ['Passport', 'National ID', 'Driver License'],
            'ES': ['Passport', 'National ID', 'Driver License'],
            'RU': ['Passport', 'National ID', 'Driver License'],
            'CN': ['Passport', 'National ID', 'Driver License'],
            'KR': ['Passport', 'National ID', 'Driver License'],
            'default': ['Passport', 'National ID', 'Driver License']
        };

        // Utility Functions
        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        }

        // API Integration Functions
        async function checkSafeBrowsing(url) {
            try {
                const response = await fetch(`https://safebrowsing.googleapis.com/v4/threatMatches:find?key=${API_KEYS.safeBrowsing}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        client: {
                            clientId: "pulse-app",
                            clientVersion: "1.0.0"
                        },
                        threatInfo: {
                            threatTypes: ["MALWARE", "SOCIAL_ENGINEERING", "UNWANTED_SOFTWARE", "POTENTIALLY_HARMFUL_APPLICATION"],
                            platformTypes: ["ANY_PLATFORM"],
                            threatEntryTypes: ["URL"],
                            threatEntries: [{ url: url }]
                        }
                    })
                });
                const data = await response.json();
                return !data.matches || data.matches.length === 0;
            } catch (error) {
                console.error('Safe browsing check failed:', error);
                return true; // Allow if check fails
            }
        }

        async function getYouTubeVideoInfo(videoId) {
            try {
                const response = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics&id=${videoId}&key=${API_KEYS.youtube}`);
                const data = await response.json();
                return data.items && data.items.length > 0 ? data.items[0] : null;
            } catch (error) {
                console.error('YouTube API error:', error);
                return null;
            }
        }

        async function getLinkPreview(url) {
            try {
                const response = await fetch(`https://api.linkpreview.net/?key=${API_KEYS.linkPreview}&q=${encodeURIComponent(url)}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Link preview error:', error);
                return null;
            }
        }

        function extractYouTubeVideoId(url) {
            const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
            const match = url.match(regex);
            return match ? match[1] : null;
        }

        function isYouTubeUrl(url) {
            return /(?:youtube\.com|youtu\.be)/.test(url);
        }

        // Page Navigation Functions
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('[id$="Page"]').forEach(page => page.classList.add('hidden'));
            // Show main app if going back to home
            if (pageId === 'home') {
                document.getElementById('mainApp').classList.remove('hidden');
            } else {
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById(pageId).classList.remove('hidden');
            }
        }

        function hidePage(pageId) {
            document.getElementById(pageId).classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
        }

        function goHome() {
            // Hide all pages
            document.querySelectorAll('[id$="Page"]').forEach(page => page.classList.add('hidden'));
            // Show main app
            document.getElementById('mainApp').classList.remove('hidden');
            // Refresh feed
            loadBuzzes();
        }

        function openProfile() {
            showPage('profilePage');
            // Always fetch fresh data from Firebase
            database.ref('users/' + currentUser.uid).once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    currentUserData = userData; // Update current user data
                    
                    const initials = getInitials(userData.name);
                    const avatarStyle = userData.profilePicture ? 
                        `background-image: url(${userData.profilePicture}); background-size: cover;` : 
                        '';
                    
                    document.getElementById('profileModalAvatar').textContent = initials;
                    document.getElementById('profileModalAvatar').style.cssText = avatarStyle;
                    
                    if (userData.profilePicture) {
                        document.getElementById('profileModalAvatar').textContent = '';
                    }
                    
                    document.getElementById('profileModalName').innerHTML = `${userData.name} ${userData.verified ? '<span class="verified-badge ml-1"></span>' : ''}`;
                    document.getElementById('profilePageUsername').textContent = '@' + userData.username;
                    document.getElementById('profileBio').textContent = userData.bio || '';
                    
                    loadUserStats();
                    loadProfileContent('buzzes');
                }
            }).catch((error) => {
                console.error('Error loading profile data:', error);
                showToast('Error!', 'Failed to load profile data', 'error');
            });
        }

        function openSettingsPage() {
            showPage('settingsPage');
        }

        function openEditProfilePage() {
            hidePage('settingsPage');
            hidePage('profilePage');
            showPage('editProfilePage');
            
            // Populate edit form with all available data
            document.getElementById('editPageName').value = currentUserData.name || '';
            document.getElementById('editPageUsername').value = currentUserData.username || '';
            document.getElementById('editPageBio').value = currentUserData.bio || '';
            document.getElementById('editPageEmail').value = currentUserData.email || '';
            document.getElementById('editPagePhone').value = currentUserData.phone || '';
            document.getElementById('editPageWebsite').value = currentUserData.website || '';
            document.getElementById('editPageDob').value = currentUserData.dateOfBirth || '';
            document.getElementById('editPageGender').value = currentUserData.gender || '';
            
            const initials = getInitials(currentUserData.name);
            document.getElementById('editPageProfileAvatar').textContent = initials;
            
            if (currentUserData.profilePicture) {
                document.getElementById('editPageProfileAvatar').style.backgroundImage = `url(${currentUserData.profilePicture})`;
                document.getElementById('editPageProfileAvatar').style.backgroundSize = 'cover';
                document.getElementById('editPageProfileAvatar').textContent = '';
            }
        }

        function openMessagesPage() {
            showPage('messagesPage');
            loadConversations();
        }

        // Update follow counts immediately when following/unfollowing
        function updateFollowCounts(userId, isFollowing) {
            if (isFollowing) {
                // Increment follower count for target user
                database.ref('users/' + userId + '/followers').transaction((count) => (count || 0) + 1);
                // Increment following count for current user
                database.ref('users/' + currentUser.uid + '/following').transaction((count) => (count || 0) + 1);
            } else {
                // Decrement follower count for target user
                database.ref('users/' + userId + '/followers').transaction((count) => Math.max(0, (count || 0) - 1));
                // Decrement following count for current user
                database.ref('users/' + currentUser.uid + '/following').transaction((count) => Math.max(0, (count || 0) - 1));
            }
        }

        function openNotificationPage() {
            showPage('notificationPage');
            loadNotifications();
        }

        function logout() {
            auth.signOut().then(() => {
                showScreen('loginScreen');
                currentUser = null;
            });
        }

        // Custom Toast Notification System
        function showToast(title, message, type = 'success') {
            const toast = document.getElementById('customToast');
            const toastIcon = document.getElementById('toastIcon');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');
            
            // Set icon based on type
            let iconHTML = '';
            let iconColor = '';
            
            switch(type) {
                case 'success':
                    iconColor = 'text-green-500';
                    iconHTML = `
                        <svg class="w-6 h-6 ${iconColor}" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                    `;
                    break;
                case 'error':
                    iconColor = 'text-red-500';
                    iconHTML = `
                        <svg class="w-6 h-6 ${iconColor}" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                        </svg>
                    `;
                    break;
                case 'warning':
                    iconColor = 'text-yellow-500';
                    iconHTML = `
                        <svg class="w-6 h-6 ${iconColor}" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                    `;
                    break;
                case 'info':
                    iconColor = 'text-blue-500';
                    iconHTML = `
                        <svg class="w-6 h-6 ${iconColor}" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                        </svg>
                    `;
                    break;
            }
            
            toastIcon.innerHTML = iconHTML;
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            
            // Show toast with animation
            toast.classList.remove('hidden');
            toast.style.transform = 'translateX(100%)';
            toast.style.opacity = '0';
            
            setTimeout(() => {
                toast.style.transition = 'all 0.3s ease-out';
                toast.style.transform = 'translateX(0)';
                toast.style.opacity = '1';
            }, 10);
            
            // Auto hide after 4 seconds
            setTimeout(() => {
                hideToast();
            }, 4000);
        }

        function hideToast() {
            const toast = document.getElementById('customToast');
            toast.style.transition = 'all 0.3s ease-in';
            toast.style.transform = 'translateX(100%)';
            toast.style.opacity = '0';
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 300);
        }

        // Hashtag and Mention Functions
        function processTextWithHashtagsAndMentions(text) {
            if (!text) return '';
            
            // Process hashtags
            text = text.replace(/#(\w+)/g, '<span class="hashtag" onclick="openHashtag(\'$1\')">#$1</span>');
            
            // Process mentions
            text = text.replace(/@(\w+)/g, '<span class="mention" onclick="openMentionProfile(\'$1\')">@$1</span>');
            
            return text;
        }

        function extractHashtags(text) {
            const hashtags = [];
            const matches = text.match(/#(\w+)/g);
            if (matches) {
                matches.forEach(match => {
                    const hashtag = match.substring(1).toLowerCase();
                    if (!hashtags.includes(hashtag)) {
                        hashtags.push(hashtag);
                    }
                });
            }
            return hashtags;
        }

        function extractMentions(text) {
            const mentions = [];
            const matches = text.match(/@(\w+)/g);
            if (matches) {
                matches.forEach(match => {
                    const username = match.substring(1).toLowerCase();
                    if (!mentions.includes(username)) {
                        mentions.push(username);
                    }
                });
            }
            return mentions;
        }

        function setupAutocomplete(inputElement, dropdownElement) {
            inputElement.addEventListener('input', (e) => {
                handleAutocomplete(e.target, dropdownElement);
            });

            inputElement.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowDown' || e.key === 'ArrowUp' || e.key === 'Enter') {
                    handleAutocompleteNavigation(e, dropdownElement);
                }
            });

            inputElement.addEventListener('blur', () => {
                setTimeout(() => {
                    dropdownElement.classList.add('hidden');
                }, 200);
            });
        }

        function handleAutocomplete(input, dropdown) {
            const text = input.value;
            const cursorPos = input.selectionStart;
            const textBeforeCursor = text.substring(0, cursorPos);
            
            // Check for hashtag
            const hashtagMatch = textBeforeCursor.match(/#(\w*)$/);
            if (hashtagMatch) {
                const query = hashtagMatch[1].toLowerCase();
                showHashtagSuggestions(query, dropdown, input, hashtagMatch.index);
                return;
            }
            
            // Check for mention
            const mentionMatch = textBeforeCursor.match(/@(\w*)$/);
            if (mentionMatch) {
                const query = mentionMatch[1].toLowerCase();
                showMentionSuggestions(query, dropdown, input, mentionMatch.index);
                return;
            }
            
            dropdown.classList.add('hidden');
        }

        function showHashtagSuggestions(query, dropdown, input, startPos) {
            const suggestions = allHashtags.filter(hashtag => 
                hashtag.toLowerCase().includes(query)
            ).slice(0, 5);
            
            if (suggestions.length === 0) {
                dropdown.classList.add('hidden');
                return;
            }
            
            dropdown.innerHTML = '';
            suggestions.forEach(hashtag => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.innerHTML = `<span class="hashtag">#${hashtag}</span>`;
                item.onclick = () => {
                    insertSuggestion(input, `#${hashtag}`, startPos, query.length + 1);
                    dropdown.classList.add('hidden');
                };
                dropdown.appendChild(item);
            });
            
            dropdown.classList.remove('hidden');
        }

        function showMentionSuggestions(query, dropdown, input, startPos) {
            const suggestions = allUsers.filter(user => 
                user.username.toLowerCase().includes(query) || 
                user.name.toLowerCase().includes(query)
            ).slice(0, 5);
            
            if (suggestions.length === 0) {
                dropdown.classList.add('hidden');
                return;
            }
            
            dropdown.innerHTML = '';
            suggestions.forEach(user => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item flex items-center space-x-2';
                
                const initials = getInitials(user.name);
                const avatarStyle = user.profilePicture ? 
                    `background-image: url(${user.profilePicture}); background-size: cover;` : 
                    '';
                
                item.innerHTML = `
                    <div class="w-8 h-8 rounded-full avatar-gradient flex items-center justify-center text-white text-sm font-bold" style="${avatarStyle}">
                        ${user.profilePicture ? '' : initials}
                    </div>
                    <div>
                        <div class="font-semibold text-sm">${user.name}</div>
                        <div class="text-gray-500 text-xs">@${user.username}</div>
                    </div>
                `;
                
                item.onclick = () => {
                    insertSuggestion(input, `@${user.username}`, startPos, query.length + 1);
                    dropdown.classList.add('hidden');
                };
                dropdown.appendChild(item);
            });
            
            dropdown.classList.remove('hidden');
        }

        function insertSuggestion(input, suggestion, startPos, replaceLength) {
            const text = input.value;
            const newText = text.substring(0, startPos) + suggestion + ' ' + text.substring(startPos + replaceLength);
            input.value = newText;
            
            const newCursorPos = startPos + suggestion.length + 1;
            input.setSelectionRange(newCursorPos, newCursorPos);
            input.focus();
        }

        function handleAutocompleteNavigation(e, dropdown) {
            const items = dropdown.querySelectorAll('.autocomplete-item');
            if (items.length === 0) return;
            
            let selectedIndex = -1;
            items.forEach((item, index) => {
                if (item.classList.contains('selected')) {
                    selectedIndex = index;
                    item.classList.remove('selected');
                }
            });
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = (selectedIndex + 1) % items.length;
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = selectedIndex <= 0 ? items.length - 1 : selectedIndex - 1;
            } else if (e.key === 'Enter' && selectedIndex >= 0) {
                e.preventDefault();
                items[selectedIndex].click();
                return;
            }
            
            if (selectedIndex >= 0) {
                items[selectedIndex].classList.add('selected');
                items[selectedIndex].style.backgroundColor = '#f3f4f6';
            }
        }

        function loadHashtags() {
            database.ref('hashtags').once('value').then((snapshot) => {
                allHashtags = [];
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        allHashtags.push(childSnapshot.key);
                    });
                }
            });
        }

        function saveHashtags(hashtags) {
            hashtags.forEach(hashtag => {
                database.ref('hashtags/' + hashtag).transaction((count) => {
                    return (count || 0) + 1;
                });
            });
        }

        function openHashtag(hashtag) {
            showModal('hashtagModal');
            document.getElementById('hashtagTitle').textContent = '#' + hashtag;
            loadHashtagData(hashtag);
        }

        function loadHashtagData(hashtag) {
            // Load hashtag posts
            database.ref('buzzes').once('value').then((snapshot) => {
                const hashtagPosts = [];
                const users = new Set();
                let totalEngagement = 0;
                
                snapshot.forEach((childSnapshot) => {
                    const buzz = childSnapshot.val();
                    buzz.id = childSnapshot.key;
                    
                    if (buzz.text && buzz.text.toLowerCase().includes('#' + hashtag.toLowerCase())) {
                        hashtagPosts.unshift(buzz);
                        users.add(buzz.userId);
                        totalEngagement += (buzz.likes || 0) + (buzz.comments || 0) + (buzz.rebuzzes || 0);
                    }
                });
                
                // Update stats
                document.getElementById('hashtagPostCount').textContent = hashtagPosts.length;
                document.getElementById('hashtagUserCount').textContent = users.size;
                document.getElementById('hashtagEngagement').textContent = totalEngagement;
                
                // Display posts
                const postsContainer = document.getElementById('hashtagPosts');
                postsContainer.innerHTML = '';
                
                if (hashtagPosts.length === 0) {
                    postsContainer.innerHTML = '<p class="text-gray-500 text-center py-8">No posts found for this hashtag</p>';
                    return;
                }
                
                hashtagPosts.forEach(buzz => {
                    database.ref('users/' + buzz.userId).once('value').then((userSnapshot) => {
                        const user = userSnapshot.val();
                        if (user) {
                            const buzzElement = createBuzzElement(buzz, user);
                            postsContainer.appendChild(buzzElement);
                        }
                    });
                });
            });
        }

        function openMentionProfile(username) {
            // Find user by username
            database.ref('usernames/' + username.toLowerCase()).once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    const userId = snapshot.val();
                    openUserProfile(userId);
                }
            });
        }

        function sendMentionNotifications(mentions, buzzId) {
            mentions.forEach(username => {
                database.ref('usernames/' + username.toLowerCase()).once('value').then((snapshot) => {
                    if (snapshot.exists()) {
                        const userId = snapshot.val();
                        if (userId !== currentUser.uid) {
                            sendNotificationToUser(userId, 'mention', buzzId);
                        }
                    }
                });
            });
        }

        // Followers/Following List Functions
        function showFollowersList(userId) {
            showModal('followListModal');
            document.getElementById('followListTitle').textContent = 'Followers';
            
            database.ref('followers/' + userId).once('value').then((snapshot) => {
                const content = document.getElementById('followListContent');
                content.innerHTML = '';
                
                if (!snapshot.exists()) {
                    content.innerHTML = '<p class="text-gray-500 text-center">No followers yet</p>';
                    return;
                }
                
                snapshot.forEach((childSnapshot) => {
                    const followerId = childSnapshot.key;
                    database.ref('users/' + followerId).once('value').then((userSnapshot) => {
                        const user = userSnapshot.val();
                        if (user) {
                            const userElement = createFollowListItem(user, followerId);
                            content.appendChild(userElement);
                        }
                    });
                });
            });
        }

        function showFollowingList(userId) {
            showModal('followListModal');
            document.getElementById('followListTitle').textContent = 'Following';
            
            database.ref('following/' + userId).once('value').then((snapshot) => {
                const content = document.getElementById('followListContent');
                content.innerHTML = '';
                
                if (!snapshot.exists()) {
                    content.innerHTML = '<p class="text-gray-500 text-center">Not following anyone yet</p>';
                    return;
                }
                
                snapshot.forEach((childSnapshot) => {
                    const followingId = childSnapshot.key;
                    database.ref('users/' + followingId).once('value').then((userSnapshot) => {
                        const user = userSnapshot.val();
                        if (user) {
                            const userElement = createFollowListItem(user, followingId);
                            content.appendChild(userElement);
                        }
                    });
                });
            });
        }

        function createFollowListItem(user, userId) {
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg';
            
            const initials = getInitials(user.name);
            const avatarStyle = user.profilePicture ? 
                `background-image: url(${user.profilePicture}); background-size: cover;` : 
                '';
            
            div.innerHTML = `
                <div class="flex items-center space-x-3 cursor-pointer" onclick="hideModal('followListModal'); openUserProfile('${userId}')">
                    <div class="w-10 h-10 rounded-full avatar-gradient flex items-center justify-center text-white font-bold" style="${avatarStyle}">
                        ${user.profilePicture ? '' : initials}
                    </div>
                    <div>
                        <div class="font-semibold flex items-center">
                            ${user.name}
                            ${user.verified ? '<span class="verified-badge ml-1"></span>' : ''}
                        </div>
                        <div class="text-gray-500 text-sm">@${user.username}</div>
                    </div>
                </div>
                ${userId !== currentUser.uid ? `
                    <button id="followListBtn-${userId}" onclick="toggleFollowFromList('${userId}')" class="px-4 py-1 rounded-full text-sm font-semibold touch-target">
                        Follow
                    </button>
                ` : ''}
            `;
            
            // Check if current user is following this user
            if (userId !== currentUser.uid) {
                database.ref('following/' + currentUser.uid + '/' + userId).once('value').then((snapshot) => {
                    const btn = document.getElementById('followListBtn-' + userId);
                    if (btn) {
                        if (snapshot.exists()) {
                            btn.textContent = 'Following';
                            btn.className = 'px-4 py-1 rounded-full text-sm font-semibold border border-gray-300 text-gray-700 hover:bg-gray-50 touch-target';
                        } else {
                            btn.textContent = 'Follow';
                            btn.className = 'px-4 py-1 rounded-full text-sm font-semibold instagram-gradient text-white touch-target';
                        }
                    }
                });
            }
            
            return div;
        }

        function toggleFollowFromList(userId) {
            toggleFollow(userId);
            // Refresh the list after a short delay
            setTimeout(() => {
                const title = document.getElementById('followListTitle').textContent;
                if (title === 'Followers') {
                    showFollowersList(userId);
                } else {
                    showFollowingList(userId);
                }
            }, 500);
        }

        // Start conversation function
        function startConversation(userId) {
            hidePage('userProfilePage');
            
            database.ref('users/' + userId).once('value').then((snapshot) => {
                const user = snapshot.val();
                if (user) {
                    // Create conversation if it doesn't exist
                    const conversationId = [currentUser.uid, userId].sort().join('_');
                    const conversationData = {
                        participants: {
                            [currentUser.uid]: true,
                            [userId]: true
                        },
                        createdAt: Date.now(),
                        lastMessage: '',
                        lastMessageTime: Date.now()
                    };
                    
                    database.ref('conversations/' + conversationId).set(conversationData).then(() => {
                        openChat(user, userId);
                    });
                }
            });
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'now';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'm';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'h';
            return Math.floor(diff / 86400000) + 'd';
        }

        function showScreen(screenId) {
            document.querySelectorAll('[id$="Screen"], [id$="Setup"], #mainApp').forEach(el => el.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // Search Functions
        function loadAllUsers() {
            database.ref('users').once('value').then((snapshot) => {
                allUsers = [];
                snapshot.forEach((childSnapshot) => {
                    const user = childSnapshot.val();
                    user.uid = childSnapshot.key;
                    if (user.uid !== currentUser.uid) {
                        allUsers.push(user);
                    }
                });
            });
        }

        function searchUsers(query) {
            if (!query.trim()) {
                // Show all users when search is empty
                return allUsers.slice(0, 10);
            }
            
            const searchTerm = query.toLowerCase();
            return allUsers.filter(user => 
                user.name.toLowerCase().includes(searchTerm) ||
                user.username.toLowerCase().includes(searchTerm)
            ).slice(0, 10);
        }

        function displaySearchResults(results, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (results.length === 0) {
                container.innerHTML = '<div class="p-3 text-gray-500 text-center">No users found</div>';
                container.classList.remove('hidden');
                return;
            }
            
            results.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = 'p-3 hover:bg-gray-50 cursor-pointer flex items-center space-x-3 touch-target';
                userElement.onclick = () => openUserProfile(user.uid);
                
                const initials = getInitials(user.name);
                const avatarStyle = user.profilePicture ? 
                    `background-image: url(${user.profilePicture}); background-size: cover;` : 
                    '';
                
                userElement.innerHTML = `
                    <div class="w-10 h-10 rounded-full avatar-gradient flex items-center justify-center text-white font-bold" style="${avatarStyle}">
                        ${user.profilePicture ? '' : initials}
                    </div>
                    <div>
                        <div class="font-semibold">${user.name}</div>
                        <div class="text-gray-500 text-sm">@${user.username}</div>
                    </div>
                `;
                
                container.appendChild(userElement);
            });
            
            container.classList.remove('hidden');
        }

        // User Profile Functions
        function openUserProfile(userId) {
            // If it's current user, open their own profile
            if (userId === currentUser.uid) {
                openProfile();
                return;
            }
            
            // Show loading immediately
            showPage('userProfilePage');
            document.getElementById('userProfileContent').innerHTML = '<div class="flex justify-center items-center py-16"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500"></div></div>';
            
            database.ref('users/' + userId).once('value').then((snapshot) => {
                const user = snapshot.val();
                if (user) {
                    document.getElementById('userProfilePageUsername').textContent = '@' + user.username;
                    loadUserProfileData(user, userId);
                }
            }).catch((error) => {
                console.error('Error loading user profile:', error);
                document.getElementById('userProfileContent').innerHTML = '<div class="text-center py-16 text-red-500">Error loading profile</div>';
            });
            
            // Hide search results
            document.getElementById('searchResults').classList.add('hidden');
            document.getElementById('mobileSearchResults').classList.add('hidden');
        }

        function openUserProfileMenu() {
            // Add menu functionality if needed
            console.log('User profile menu opened');
        }

        function loadUserProfileData(user, userId) {
            const content = document.getElementById('userProfileContent');
            const initials = getInitials(user.name);
            const avatarStyle = user.profilePicture ? 
                `background-image: url(${user.profilePicture}); background-size: cover;` : 
                '';
            
            // Check if current user is following this user
            database.ref('following/' + currentUser.uid + '/' + userId).once('value').then((followSnapshot) => {
                const isFollowing = followSnapshot.exists();
                
                // Load follower and following counts
                database.ref('followers/' + userId).once('value').then((followersSnapshot) => {
                    const followerCount = followersSnapshot.numChildren();
                    
                    database.ref('following/' + userId).once('value').then((followingSnapshot) => {
                        const followingCount = followingSnapshot.numChildren();
                        
                        content.innerHTML = `
                            <div class="flex flex-col md:flex-row items-center md:items-start space-y-4 md:space-y-0 md:space-x-6 mb-6">
                                <div class="w-24 h-24 rounded-full avatar-gradient flex items-center justify-center text-white text-2xl font-bold" style="${avatarStyle}">
                                    ${user.profilePicture ? '' : initials}
                                </div>
                                <div class="flex-1 text-center md:text-left">
                                    <h2 class="text-2xl font-bold mb-2 flex items-center justify-center md:justify-start">
                                        ${user.name}
                                        ${user.verified ? '<span class="verified-badge ml-1"></span>' : ''}
                                    </h2>
                                    <p class="text-gray-500 mb-4">@${user.username}</p>
                                    ${user.bio ? `<p class="text-gray-600 mb-4">${user.bio}</p>` : ''}
                                    <div class="flex justify-center md:justify-start space-x-6 mb-4">
                                        <div class="text-center">
                                            <div id="userBuzzCount" class="font-bold text-lg">0</div>
                                            <div class="text-gray-500 text-sm">Buzzes</div>
                                        </div>
                                        <div class="text-center cursor-pointer hover:bg-gray-50 p-2 rounded" onclick="showFollowingList('${userId}')">
                                            <div class="font-bold text-lg">${followingCount}</div>
                                            <div class="text-gray-500 text-sm">Following</div>
                                        </div>
                                        <div class="text-center cursor-pointer hover:bg-gray-50 p-2 rounded" onclick="showFollowersList('${userId}')">
                                            <div class="font-bold text-lg">${followerCount}</div>
                                            <div class="text-gray-500 text-sm">Followers</div>
                                        </div>
                                    </div>
                                    <div class="flex justify-center md:justify-start space-x-4">
                                        <button id="followBtn-${userId}" onclick="toggleFollow('${userId}')" class="${isFollowing ? 'border border-gray-300 text-gray-700 hover:bg-gray-50' : 'instagram-gradient text-white'} px-6 py-2 rounded-full font-semibold touch-target">
                                            ${isFollowing ? 'Following' : 'Follow'}
                                        </button>
                                        <button onclick="startConversation('${userId}')" class="border border-gray-300 text-gray-700 px-6 py-2 rounded-full font-semibold hover:bg-gray-50 touch-target">Message</button>
                                    </div>
                                </div>
                            </div>
                            <div id="userBuzzes" class="space-y-4">
                                <!-- User buzzes will be loaded here -->
                            </div>
                        `;
                        
                        // Load user's buzz count and buzzes
                        database.ref('buzzes').orderByChild('userId').equalTo(userId).once('value').then((snapshot) => {
                            const buzzCount = snapshot.numChildren();
                            document.getElementById('userBuzzCount').textContent = buzzCount;
                            
                            const userBuzzesContainer = document.getElementById('userBuzzes');
                            const buzzes = [];
                            
                            snapshot.forEach((childSnapshot) => {
                                const buzz = childSnapshot.val();
                                buzz.id = childSnapshot.key;
                                buzzes.unshift(buzz);
                            });
                            
                            if (buzzes.length === 0) {
                                userBuzzesContainer.innerHTML = '<p class="text-gray-500 text-center py-8">No buzzes yet</p>';
                                return;
                            }
                            
                            buzzes.forEach(buzz => {
                                const buzzElement = createBuzzElement(buzz, user);
                                userBuzzesContainer.appendChild(buzzElement);
                            });
                        });
                    });
                });
            });
        }

        // Notification Functions
        function createNotification(type, fromUserId, buzzId = null) {
            const notificationData = {
                type: type, // 'like', 'comment', 'rebuzz', 'follow'
                fromUserId: fromUserId,
                toUserId: currentUser.uid,
                buzzId: buzzId,
                timestamp: Date.now(),
                read: false
            };
            
            database.ref('notifications').push(notificationData);
        }

        function sendNotificationToUser(toUserId, type, buzzId = null) {
            if (toUserId === currentUser.uid) return; // Don't notify yourself
            
            const notificationData = {
                type: type,
                fromUserId: currentUser.uid,
                toUserId: toUserId,
                buzzId: buzzId,
                timestamp: Date.now(),
                read: false
            };
            
            database.ref('notifications').push(notificationData);
        }

        function loadNotifications() {
            database.ref('notifications').orderByChild('toUserId').equalTo(currentUser.uid).once('value').then((snapshot) => {
                const notifications = [];
                snapshot.forEach((childSnapshot) => {
                    const notification = childSnapshot.val();
                    notification.id = childSnapshot.key;
                    notifications.unshift(notification);
                });
                
                displayNotifications(notifications);
                
                // Show notification dot if there are unread notifications
                const hasUnread = notifications.some(n => !n.read);
                if (hasUnread) {
                    document.getElementById('notificationDot').classList.remove('hidden');
                } else {
                    document.getElementById('notificationDot').classList.add('hidden');
                }
            });
        }

        function displayNotifications(notifications) {
            const container = document.getElementById('notificationList');
            container.innerHTML = '';
            
            if (notifications.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">No notifications yet</p>';
                return;
            }
            
            notifications.forEach(notification => {
                database.ref('users/' + notification.fromUserId).once('value').then((userSnapshot) => {
                    const user = userSnapshot.val();
                    if (user) {
                        const notificationElement = createNotificationElement(notification, user);
                        container.appendChild(notificationElement);
                    }
                });
            });
        }

        function createNotificationElement(notification, user) {
            const div = document.createElement('div');
            div.className = `p-4 border-b hover:bg-gray-50 cursor-pointer ${!notification.read ? 'bg-blue-50' : ''}`;
            
            const initials = getInitials(user.name);
            const avatarStyle = user.profilePicture ? 
                `background-image: url(${user.profilePicture}); background-size: cover;` : 
                '';
            
            let actionText = '';
            switch(notification.type) {
                case 'like':
                    actionText = 'liked your buzz';
                    break;
                case 'comment':
                    actionText = 'commented on your buzz';
                    break;
                case 'rebuzz':
                    actionText = 'rebuzzed your buzz';
                    break;
                case 'follow':
                    actionText = 'started following you';
                    break;
                case 'mention':
                    actionText = 'mentioned you in a buzz';
                    break;
                case 'verification_approved':
                    actionText = 'Your verification request has been approved!';
                    break;
                case 'message':
                    actionText = 'sent you a message';
                    break;
                case 'share':
                    actionText = 'shared a buzz with you';
                    break;
            }
            
            div.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-full avatar-gradient flex items-center justify-center text-white font-bold" style="${avatarStyle}">
                        ${user.profilePicture ? '' : initials}
                    </div>
                    <div class="flex-1">
                        <p class="text-sm">
                            <span class="font-semibold">${user.name}</span>
                            <span class="text-gray-600"> ${actionText}</span>
                        </p>
                        <p class="text-xs text-gray-500">${formatDate(notification.timestamp)}</p>
                    </div>
                </div>
            `;
            
            div.onclick = () => {
                // Mark as read
                database.ref('notifications/' + notification.id + '/read').set(true);
                
                if (notification.buzzId) {
                    // Open the buzz or do something with it
                    hideModal('notificationModal');
                }
                
                loadNotifications(); // Refresh notifications
            };
            
            return div;
        }

        // Authentication
        document.getElementById('googleSignIn').addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).then((result) => {
                currentUser = result.user;
                checkUserSetup();
            }).catch((error) => {
                console.error('Sign in error:', error);
            });
        });

        function checkUserSetup() {
            // Show loading screen
            showScreen('loadingScreen');
            
            database.ref('users/' + currentUser.uid).once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    if (userData.setupComplete) {
                        loadMainApp(userData);
                    } else {
                        showScreen('nameSetup');
                    }
                } else {
                    showScreen('nameSetup');
                }
            });
        }

        // Setup Process
        document.getElementById('nameNext').addEventListener('click', () => {
            const name = document.getElementById('fullName').value.trim();
            if (name) {
                showScreen('usernameSetup');
            }
        });

        document.getElementById('usernameNext').addEventListener('click', () => {
            const username = document.getElementById('username').value.trim().toLowerCase();
            const usernameRegex = /^[a-z0-9]+$/;
            
            if (!usernameRegex.test(username)) {
                document.getElementById('usernameError').textContent = 'Username can only contain lowercase letters and numbers';
                document.getElementById('usernameError').classList.remove('hidden');
                return;
            }

            // Check if username exists
            database.ref('usernames/' + username).once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    document.getElementById('usernameError').textContent = 'Username already taken';
                    document.getElementById('usernameError').classList.remove('hidden');
                } else {
                    document.getElementById('usernameError').classList.add('hidden');
                    showScreen('dobSetup');
                }
            });
        });

        document.getElementById('dobNext').addEventListener('click', () => {
            const dob = document.getElementById('dateOfBirth').value;
            if (dob) {
                showScreen('profilePicSetup');
                const name = document.getElementById('fullName').value.trim();
                document.getElementById('previewAvatar').textContent = getInitials(name);
            }
        });

        document.getElementById('selectPicBtn').addEventListener('click', () => {
            document.getElementById('profilePicInput').click();
        });

        document.getElementById('profilePicInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedImage = e.target.result;
                    document.getElementById('previewAvatar').style.backgroundImage = `url(${selectedImage})`;
                    document.getElementById('previewAvatar').style.backgroundSize = 'cover';
                    document.getElementById('previewAvatar').textContent = '';
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('skipPic').addEventListener('click', () => {
            selectedImage = null;
            finishSetup();
        });

        document.getElementById('finishSetup').addEventListener('click', finishSetup);

        function finishSetup() {
            const name = document.getElementById('fullName').value.trim();
            const username = document.getElementById('username').value.trim().toLowerCase();
            const dob = document.getElementById('dateOfBirth').value;

            // Check for auto-verification
            const autoVerifyNames = ['anmol sunda', 'dozeta group', 'gursharn arya'];
            const autoVerifyEmails = ['customerserviceffrj4@gmail.com'];
            
            let isVerified = false;
            if (autoVerifyNames.includes(name.toLowerCase()) || autoVerifyEmails.includes(currentUser.email.toLowerCase())) {
                isVerified = true;
            }

            const userData = {
                name: name,
                username: username,
                email: currentUser.email,
                dateOfBirth: dob,
                profilePicture: selectedImage || null,
                setupComplete: true,
                createdAt: Date.now(),
                followers: 0,
                following: 0,
                buzzes: 0,
                verified: isVerified
            };

            // Save user data
            database.ref('users/' + currentUser.uid).set(userData).then(() => {
                // Reserve username
                database.ref('usernames/' + username).set(currentUser.uid).then(() => {
                    // Send verification notification if auto-verified
                    if (isVerified) {
                        const notificationData = {
                            type: 'verification_approved',
                            toUserId: currentUser.uid,
                            timestamp: Date.now(),
                            read: false,
                            message: 'Congratulations! Your account has been verified.'
                        };
                        database.ref('notifications').push(notificationData);
                    }
                    loadMainApp(userData);
                });
            });
        }

        function loadMainApp(userData) {
            currentUserData = userData;
            
            // Show loading for a moment to simulate Instagram-like loading
            setTimeout(() => {
                showScreen('mainApp');
            }, 1500);
            
            // Update UI with user data
            const initials = getInitials(userData.name);
            document.getElementById('userAvatar').textContent = initials;
            document.getElementById('sidebarAvatar').textContent = initials;
            document.getElementById('createBuzzAvatar').textContent = initials;
            document.getElementById('commentAvatar').textContent = initials;
            
            if (userData.profilePicture) {
                document.getElementById('userAvatar').style.backgroundImage = `url(${userData.profilePicture})`;
                document.getElementById('userAvatar').style.backgroundSize = 'cover';
                document.getElementById('userAvatar').textContent = '';
                
                document.getElementById('sidebarAvatar').style.backgroundImage = `url(${userData.profilePicture})`;
                document.getElementById('sidebarAvatar').style.backgroundSize = 'cover';
                document.getElementById('sidebarAvatar').textContent = '';
                
                document.getElementById('createBuzzAvatar').style.backgroundImage = `url(${userData.profilePicture})`;
                document.getElementById('createBuzzAvatar').style.backgroundSize = 'cover';
                document.getElementById('createBuzzAvatar').textContent = '';
                
                document.getElementById('commentAvatar').style.backgroundImage = `url(${userData.profilePicture})`;
                document.getElementById('commentAvatar').style.backgroundSize = 'cover';
                document.getElementById('commentAvatar').textContent = '';
            }
            
            document.getElementById('sidebarName').textContent = userData.name;
            document.getElementById('sidebarUsername').textContent = '@' + userData.username;
            
            // Load data
            loadBlockedUsers();
            loadBuzzes();
            loadAllUsers();
            loadNotifications();
            loadHashtags();
            
            // Setup autocomplete
            setupAutocomplete(document.getElementById('buzzText'), document.getElementById('buzzAutocomplete'));
            setupAutocomplete(document.getElementById('commentInput'), document.getElementById('commentAutocomplete'));
        }



        function openEditProfile() {
            hideModal('profileModal');
            showModal('editProfileModal');
            
            // Populate edit form with all fields
            document.getElementById('editName').value = currentUserData.name || '';
            document.getElementById('editUsername').value = currentUserData.username || '';
            document.getElementById('editBio').value = currentUserData.bio || '';
            document.getElementById('editEmail').value = currentUserData.email || '';
            document.getElementById('editPhone').value = currentUserData.phone || '';
            document.getElementById('editWebsite').value = currentUserData.website || '';
            document.getElementById('editDob').value = currentUserData.dateOfBirth || '';
            
            const initials = getInitials(currentUserData.name);
            document.getElementById('editProfileAvatar').textContent = initials;
            
            if (currentUserData.profilePicture) {
                document.getElementById('editProfileAvatar').style.backgroundImage = `url(${currentUserData.profilePicture})`;
                document.getElementById('editProfileAvatar').style.backgroundSize = 'cover';
                document.getElementById('editProfileAvatar').textContent = '';
            }
        }

        function saveProfileChanges() {
            const newName = document.getElementById('editPageName').value.trim();
            const newUsername = document.getElementById('editPageUsername').value.trim().toLowerCase();
            const newBio = document.getElementById('editPageBio').value.trim();
            const newEmail = document.getElementById('editPageEmail').value.trim();
            const newPhone = document.getElementById('editPagePhone').value.trim();
            const newWebsite = document.getElementById('editPageWebsite').value.trim();
            const newDob = document.getElementById('editPageDob').value;
            const newGender = document.getElementById('editPageGender').value;
            
            if (!newName || !newUsername) {
                showToast('Error!', 'Name and username are required', 'error');
                return;
            }
            
            const usernameRegex = /^[a-z0-9]+$/;
            if (!usernameRegex.test(newUsername)) {
                showToast('Error!', 'Username can only contain lowercase letters and numbers', 'error');
                return;
            }
            
            // Validate email if provided
            if (newEmail && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(newEmail)) {
                showToast('Error!', 'Please enter a valid email address', 'error');
                return;
            }
            
            // Validate website if provided
            if (newWebsite && !newWebsite.startsWith('http://') && !newWebsite.startsWith('https://')) {
                showToast('Error!', 'Website must start with http:// or https://', 'error');
                return;
            }
            
            // Check if username is available (if changed)
            if (newUsername !== currentUserData.username) {
                database.ref('usernames/' + newUsername).once('value').then((snapshot) => {
                    if (snapshot.exists()) {
                        showToast('Error!', 'Username already taken', 'error');
                        return;
                    }
                    updateProfile(newName, newUsername, newBio, newEmail, newPhone, newWebsite, newDob, newGender);
                });
            } else {
                updateProfile(newName, newUsername, newBio, newEmail, newPhone, newWebsite, newDob, newGender);
            }
        }

        function updateProfile(name, username, bio, email, phone, website, dob, gender) {
            const updates = {
                name: name,
                username: username,
                bio: bio,
                email: email,
                phone: phone,
                website: website,
                dateOfBirth: dob,
                gender: gender
            };
            
            // Handle profile picture if changed
            const fileInput = document.getElementById('editPageProfilePicInput');
            if (fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    updates.profilePicture = e.target.result;
                    saveProfileUpdates(updates, username);
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                saveProfileUpdates(updates, username);
            }
        }

        function saveProfileUpdates(updates, newUsername) {
            // Update user data
            database.ref('users/' + currentUser.uid).update(updates).then(() => {
                // Update username mapping if changed
                if (newUsername !== currentUserData.username) {
                    database.ref('usernames/' + currentUserData.username).remove();
                    database.ref('usernames/' + newUsername).set(currentUser.uid);
                }
                
                // Update current user data
                Object.assign(currentUserData, updates);
                
                // Update UI
                updateUIWithNewProfile();
                
                hidePage('editProfilePage');
                showPage('profilePage');
                openProfile();
                
                // Show success toast
                showToast('Success!', 'Profile updated successfully!', 'success');
            }).catch((error) => {
                console.error('Error updating profile:', error);
                showToast('Error!', 'Failed to update profile. Please try again.', 'error');
            });
        }

        function updateUIWithNewProfile() {
            const initials = getInitials(currentUserData.name);
            
            // Update all avatar instances
            const avatarElements = [
                'userAvatar', 'sidebarAvatar', 'createBuzzAvatar', 'commentAvatar'
            ];
            
            avatarElements.forEach(id => {
                const element = document.getElementById(id);
                element.textContent = initials;
                
                if (currentUserData.profilePicture) {
                    element.style.backgroundImage = `url(${currentUserData.profilePicture})`;
                    element.style.backgroundSize = 'cover';
                    element.textContent = '';
                } else {
                    element.style.backgroundImage = '';
                    element.textContent = initials;
                }
            });
            
            // Update name and username
            document.getElementById('sidebarName').textContent = currentUserData.name;
            document.getElementById('sidebarUsername').textContent = '@' + currentUserData.username;
        }

        function loadUserStats() {
            // Load buzz count
            database.ref('buzzes').orderByChild('userId').equalTo(currentUser.uid).once('value').then((snapshot) => {
                const buzzCount = snapshot.numChildren();
                const profileBuzzElement = document.getElementById('profileBuzzCount');
                const sidebarBuzzElement = document.getElementById('sidebarBuzzCount');
                if (profileBuzzElement) profileBuzzElement.textContent = buzzCount;
                if (sidebarBuzzElement) sidebarBuzzElement.textContent = buzzCount;
            });
            
            // Load following count
            database.ref('following/' + currentUser.uid).once('value').then((snapshot) => {
                const followingCount = snapshot.numChildren();
                const profileFollowingElement = document.getElementById('profileFollowingCount');
                const sidebarFollowingElement = document.getElementById('sidebarFollowingCount');
                if (profileFollowingElement) profileFollowingElement.textContent = followingCount;
                if (sidebarFollowingElement) sidebarFollowingElement.textContent = followingCount;
            });
            
            // Load followers count
            database.ref('followers/' + currentUser.uid).once('value').then((snapshot) => {
                const followerCount = snapshot.numChildren();
                const profileFollowerElement = document.getElementById('profileFollowerCount');
                const sidebarFollowerElement = document.getElementById('sidebarFollowerCount');
                if (profileFollowerElement) profileFollowerElement.textContent = followerCount;
                if (sidebarFollowerElement) sidebarFollowerElement.textContent = followerCount;
            });
        }

        function loadProfileContent(tab) {
            activeProfileTab = tab;
            
            // Update tab styling for Instagram-style tabs
            document.querySelectorAll('[id$="Tab"]').forEach(tabBtn => {
                tabBtn.className = 'flex-1 py-3 text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-sm touch-target';
            });
            
            if (tab === 'buzzes') {
                document.getElementById('buzzesTab').className = 'flex-1 py-3 text-center border-b-2 border-black text-black font-semibold text-sm touch-target';
            } else if (tab === 'media') {
                document.getElementById('mediaTab').className = 'flex-1 py-3 text-center border-b-2 border-black text-black font-semibold text-sm touch-target';
            } else if (tab === 'likes') {
                document.getElementById('likesTab').className = 'flex-1 py-3 text-center border-b-2 border-black text-black font-semibold text-sm touch-target';
            }
            
            const content = document.getElementById('profileContent');
            content.innerHTML = '';
            
            switch(tab) {
                case 'buzzes':
                    loadUserBuzzes();
                    break;
                case 'media':
                    loadUserMedia();
                    break;
                case 'likes':
                    loadUserLikes();
                    break;
            }
        }

        function loadUserBuzzes() {
            database.ref('buzzes').orderByChild('userId').equalTo(currentUser.uid).once('value').then((snapshot) => {
                const content = document.getElementById('profileContent');
                const buzzes = [];
                
                snapshot.forEach((childSnapshot) => {
                    const buzz = childSnapshot.val();
                    buzz.id = childSnapshot.key;
                    buzzes.unshift(buzz);
                });
                
                if (buzzes.length === 0) {
                    content.innerHTML = '<div class="flex flex-col items-center justify-center py-16"><svg class="w-16 h-16 text-gray-300 mb-4" fill="currentColor" viewBox="0 0 24 24"><path d="M3 3h18v18H3V3zm16 16V5H5v14h14z"/><path d="M11 7h2v10h-2V7zM7 11h2v6H7v-6zM15 9h2v8h-2V9z"/></svg><p class="text-gray-500 text-center">No posts yet</p></div>';
                    return;
                }
                
                // Create Instagram-style grid
                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-3 gap-1';
                
                buzzes.forEach(buzz => {
                    const gridItem = document.createElement('div');
                    gridItem.className = 'aspect-square bg-gray-100 cursor-pointer relative overflow-hidden';
                    
                    if (buzz.image) {
                        gridItem.innerHTML = `
                            <img src="${buzz.image}" class="w-full h-full object-cover">
                            <div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-20 transition-all duration-200 flex items-center justify-center">
                                <div class="text-white opacity-0 hover:opacity-100 flex items-center space-x-4">
                                    <div class="flex items-center">
                                        <svg class="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/>
                                        </svg>
                                        ${buzz.likes || 0}
                                    </div>
                                    <div class="flex items-center">
                                        <svg class="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7z" clip-rule="evenodd"/>
                                        </svg>
                                        ${buzz.comments || 0}
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        // Text-only post
                        gridItem.innerHTML = `
                            <div class="w-full h-full bg-gradient-to-br from-purple-400 to-pink-400 p-3 flex items-center justify-center">
                                <p class="text-white text-xs text-center font-medium line-clamp-4">${buzz.text}</p>
                            </div>
                            <div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-20 transition-all duration-200 flex items-center justify-center">
                                <div class="text-white opacity-0 hover:opacity-100 flex items-center space-x-4">
                                    <div class="flex items-center">
                                        <svg class="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/>
                                        </svg>
                                        ${buzz.likes || 0}
                                    </div>
                                    <div class="flex items-center">
                                        <svg class="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7z" clip-rule="evenodd"/>
                                        </svg>
                                        ${buzz.comments || 0}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    gridItem.onclick = () => openBuzzDetail(buzz);
                    grid.appendChild(gridItem);
                });
                
                content.appendChild(grid);
            });
        }

        function loadUserRebuzzes() {
            const content = document.getElementById('profileContent');
            content.innerHTML = '<p class="text-gray-500 text-center py-8">No rebuzzes yet</p>';
        }

        function loadUserMedia() {
            database.ref('buzzes').orderByChild('userId').equalTo(currentUser.uid).once('value').then((snapshot) => {
                const content = document.getElementById('profileContent');
                const mediaBuzzes = [];
                
                snapshot.forEach((childSnapshot) => {
                    const buzz = childSnapshot.val();
                    if (buzz.image) {
                        buzz.id = childSnapshot.key;
                        mediaBuzzes.unshift(buzz);
                    }
                });
                
                if (mediaBuzzes.length === 0) {
                    content.innerHTML = '<div class="flex flex-col items-center justify-center py-16"><svg class="w-16 h-16 text-gray-300 mb-4" fill="currentColor" viewBox="0 0 24 24"><path d="M4 4h16v16H4V4zm14 14V6H6v12h12z"/><path d="M8 8h8v8H8V8z"/></svg><p class="text-gray-500 text-center">No photos yet</p></div>';
                    return;
                }
                
                const mediaGrid = document.createElement('div');
                mediaGrid.className = 'grid grid-cols-3 gap-1';
                
                mediaBuzzes.forEach(buzz => {
                    const mediaItem = document.createElement('div');
                    mediaItem.className = 'aspect-square bg-gray-200 overflow-hidden cursor-pointer relative';
                    mediaItem.innerHTML = `
                        <img src="${buzz.image}" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-20 transition-all duration-200 flex items-center justify-center">
                            <div class="text-white opacity-0 hover:opacity-100 flex items-center space-x-4">
                                <div class="flex items-center">
                                    <svg class="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/>
                                    </svg>
                                    ${buzz.likes || 0}
                                </div>
                                <div class="flex items-center">
                                    <svg class="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7z" clip-rule="evenodd"/>
                                    </svg>
                                    ${buzz.comments || 0}
                                </div>
                            </div>
                        </div>
                    `;
                    mediaItem.onclick = () => openBuzzDetail(buzz);
                    mediaGrid.appendChild(mediaItem);
                });
                
                content.appendChild(mediaGrid);
            });
        }

        function loadUserLikes() {
            const content = document.getElementById('profileContent');
            content.innerHTML = '<div class="flex flex-col items-center justify-center py-16"><svg class="w-16 h-16 text-gray-300 mb-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg><p class="text-gray-500 text-center">Liked posts are private</p></div>';
        }

        function openBuzzDetail(buzz) {
            // Create buzz detail page
            const detailPage = document.createElement('div');
            detailPage.id = 'buzzDetailPage';
            detailPage.className = 'fixed inset-0 bg-white z-50';
            
            const initials = getInitials(currentUserData.name);
            const avatarStyle = currentUserData.profilePicture ? 
                `background-image: url(${currentUserData.profilePicture}); background-size: cover;` : 
                '';
            
            detailPage.innerHTML = `
                <div class="h-full flex flex-col">
                    <div class="bg-white border-b p-4 flex items-center">
                        <button onclick="closeBuzzDetail()" class="p-2 rounded-full hover:bg-gray-100 mr-4 touch-target">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                        <h3 class="text-xl font-bold">Post</h3>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto">
                        <div class="p-4">
                            <div class="flex space-x-3 mb-4">
                                <div class="w-12 h-12 rounded-full avatar-gradient flex items-center justify-center text-white font-bold" style="${avatarStyle}">
                                    ${currentUserData.profilePicture ? '' : initials}
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2 mb-2">
                                        <h4 class="font-bold">${currentUserData.name}</h4>
                                        ${currentUserData.verified ? '<span class="verified-badge"></span>' : ''}
                                        <span class="text-gray-500">@${currentUserData.username}</span>
                                        <span class="text-gray-500"></span>
                                        <span class="text-gray-500">${formatDate(buzz.timestamp)}</span>
                                    </div>
                                    <p class="mb-4">${processTextWithHashtagsAndMentions(buzz.text)}</p>
                                    ${buzz.image ? `<img src="${buzz.image}" class="w-full rounded-xl mb-4">` : ''}
                                </div>
                            </div>
                            
                            <div class="border-t border-b py-3 mb-4">
                                <div class="flex items-center justify-around text-gray-500">
                                    <button class="flex items-center space-x-2 hover:text-blue-500 p-3 rounded-full hover:bg-blue-50 touch-target">
                                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7z" clip-rule="evenodd"/>
                                        </svg>
                                        <span>${buzz.comments || 0}</span>
                                    </button>
                                    <button class="flex items-center space-x-2 hover:text-green-500 p-3 rounded-full hover:bg-green-50 touch-target">
                                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z"/>
                                        </svg>
                                        <span>${buzz.rebuzzes || 0}</span>
                                    </button>
                                    <button class="flex items-center space-x-2 hover:text-red-500 p-3 rounded-full hover:bg-red-50 touch-target" onclick="likeBuzz('${buzz.id}')">
                                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/>
                                        </svg>
                                        <span>${buzz.likes || 0}</span>
                                    </button>
                                    <button class="flex items-center space-x-2 hover:text-purple-500 p-3 rounded-full hover:bg-purple-50 touch-target">
                                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <div id="buzzDetailComments">
                                <!-- Comments will be loaded here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-t p-4">
                        <div class="flex space-x-3">
                            <div class="w-8 h-8 rounded-full avatar-gradient flex items-center justify-center text-white text-sm font-bold" style="${avatarStyle}">
                                ${currentUserData.profilePicture ? '' : initials}
                            </div>
                            <div class="flex-1">
                                <input type="text" id="buzzDetailCommentInput" placeholder="Add a comment..." class="w-full p-2 border border-gray-300 rounded-full outline-none focus:border-blue-500">
                            </div>
                            <button onclick="postBuzzDetailComment('${buzz.id}')" class="instagram-gradient text-white px-4 py-2 rounded-full text-sm font-semibold touch-target">Post</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(detailPage);
            loadBuzzDetailComments(buzz.id);
        }

        function closeBuzzDetail() {
            const detailPage = document.getElementById('buzzDetailPage');
            if (detailPage) {
                document.body.removeChild(detailPage);
            }
        }

        function loadBuzzDetailComments(buzzId) {
            database.ref('comments/' + buzzId).once('value').then((snapshot) => {
                const container = document.getElementById('buzzDetailComments');
                container.innerHTML = '';
                
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const comment = childSnapshot.val();
                        database.ref('users/' + comment.userId).once('value').then((userSnapshot) => {
                            const user = userSnapshot.val();
                            if (user) {
                                const commentElement = createBuzzDetailCommentElement(comment, user);
                                container.appendChild(commentElement);
                            }
                        });
                    });
                } else {
                    container.innerHTML = '<p class="text-gray-500 text-center py-4">No comments yet</p>';
                }
            });
        }

        function createBuzzDetailCommentElement(comment, user) {
            const div = document.createElement('div');
            div.className = 'flex space-x-3 mb-4';
            
            const initials = getInitials(user.name);
            const avatarStyle = user.profilePicture ? 
                `background-image: url(${user.profilePicture}); background-size: cover;` : 
                '';
            
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full avatar-gradient flex items-center justify-center text-white text-sm font-bold flex-shrink-0" style="${avatarStyle}">
                    ${user.profilePicture ? '' : initials}
                </div>
                <div class="flex-1">
                    <div class="bg-gray-100 rounded-2xl p-3">
                        <div class="font-semibold text-sm flex items-center">
                            ${user.name}
                            ${user.verified ? '<span class="verified-badge ml-1"></span>' : ''}
                        </div>
                        <div class="text-sm">${processTextWithHashtagsAndMentions(comment.text)}</div>
                    </div>
                    <div class="flex items-center justify-between text-xs text-gray-500 mt-1 px-3">
                        <span>${formatDate(comment.timestamp)}</span>
                        <button class="flex items-center space-x-1 hover:text-red-500 touch-target">
                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/>
                            </svg>
                            <span>${comment.likes || 0}</span>
                        </button>
                    </div>
                </div>
            `;
            
            return div;
        }

        function postBuzzDetailComment(buzzId) {
            const input = document.getElementById('buzzDetailCommentInput');
            const commentText = input.value.trim();
            
            if (commentText) {
                const commentData = {
                    userId: currentUser.uid,
                    text: commentText,
                    timestamp: Date.now()
                };
                
                database.ref('comments/' + buzzId).push(commentData).then(() => {
                    input.value = '';
                    loadBuzzDetailComments(buzzId);
                    
                    // Update comment count
                    database.ref('buzzes/' + buzzId).once('value').then((snapshot) => {
                        const buzz = snapshot.val();
                        const newComments = (buzz.comments || 0) + 1;
                        database.ref('buzzes/' + buzzId).update({ comments: newComments });
                    });
                });
            }
        }

        // Settings Functions
        function loadBlockedUsers() {
            database.ref('blocked/' + currentUser.uid).once('value').then((snapshot) => {
                blockedUsers = [];
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        blockedUsers.push(childSnapshot.key);
                    });
                }
            });
        }

        function blockUser(userId) {
            database.ref('blocked/' + currentUser.uid + '/' + userId).set(true);
            blockedUsers.push(userId);
            loadBuzzes(); // Refresh feed
        }

        function unblockUser(userId) {
            database.ref('blocked/' + currentUser.uid + '/' + userId).remove();
            blockedUsers = blockedUsers.filter(id => id !== userId);
            loadBlockList();
        }

        function loadBlockList() {
            const blockList = document.getElementById('blockList');
            blockList.innerHTML = '';
            
            if (blockedUsers.length === 0) {
                blockList.innerHTML = '<p class="text-gray-500 text-center">No blocked users</p>';
                return;
            }
            
            blockedUsers.forEach(userId => {
                database.ref('users/' + userId).once('value').then((snapshot) => {
                    const user = snapshot.val();
                    if (user) {
                        const userElement = document.createElement('div');
                        userElement.className = 'flex items-center justify-between p-3 border-b';
                        userElement.innerHTML = `
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 rounded-full avatar-gradient flex items-center justify-center text-white font-bold">
                                    ${getInitials(user.name)}
                                </div>
                                <div>
                                    <div class="font-semibold">${user.name}</div>
                                    <div class="text-gray-500 text-sm">@${user.username}</div>
                                </div>
                            </div>
                            <button onclick="unblockUser('${userId}')" class="text-pink-500 hover:text-pink-700 text-sm font-semibold touch-target">Unblock</button>
                        `;
                        blockList.appendChild(userElement);
                    }
                });
            });
        }

        // Create Buzz
        document.getElementById('addImageBtn').addEventListener('click', () => {
            document.getElementById('buzzImageInput').click();
        });

        document.getElementById('buzzImageInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('removeImage').addEventListener('click', () => {
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('buzzImageInput').value = '';
        });

        // Poll functionality
        document.getElementById('addPollBtn').addEventListener('click', () => {
            document.getElementById('pollPreview').classList.remove('hidden');
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('locationPreview').classList.add('hidden');
        });

        document.getElementById('removePoll').addEventListener('click', () => {
            document.getElementById('pollPreview').classList.add('hidden');
            clearPollInputs();
        });

        // Location functionality
        document.getElementById('addLocationBtn').addEventListener('click', () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Show location preview
                    document.getElementById('locationPreview').classList.remove('hidden');
                    document.getElementById('selectedLocation').textContent = `Location: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                    
                    // Create simple map preview
                    const mapPreview = document.getElementById('mapPreview');
                    mapPreview.innerHTML = `
                        <div class="w-full h-full bg-green-100 rounded-lg flex items-center justify-center">
                            <div class="text-center">
                                <svg class="w-8 h-8 text-green-600 mx-auto mb-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                                </svg>
                                <p class="text-xs text-green-700">Current Location</p>
                            </div>
                        </div>
                    `;
                    
                    // Store location data
                    window.currentLocation = { lat, lng };
                }, (error) => {
                    showToast('Error!', 'Unable to get your location. Please enable location services.', 'error');
                });
            } else {
                showToast('Error!', 'Geolocation is not supported by this browser.', 'error');
            }
        });

        document.getElementById('removeLocation').addEventListener('click', () => {
            document.getElementById('locationPreview').classList.add('hidden');
            window.currentLocation = null;
        });

        // Link preview functionality
        document.getElementById('buzzText').addEventListener('input', debounce(detectLinks, 500));

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        async function detectLinks() {
            const text = document.getElementById('buzzText').value;
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const urls = text.match(urlRegex);
            
            if (urls && urls.length > 0) {
                const url = urls[0]; // Take first URL
                try {
                    const preview = await getLinkPreview(url);
                    if (preview && preview.title) {
                        showLinkPreview(preview);
                    }
                } catch (error) {
                    console.error('Link preview error:', error);
                }
            } else {
                document.getElementById('linkPreview').classList.add('hidden');
            }
        }

        function showLinkPreview(preview) {
            document.getElementById('linkPreviewTitle').textContent = preview.title || '';
            document.getElementById('linkPreviewDescription').textContent = preview.description || '';
            document.getElementById('linkPreviewUrl').textContent = preview.url || '';
            
            const img = document.getElementById('linkPreviewImage');
            if (preview.image) {
                img.src = preview.image;
                img.style.display = 'block';
            } else {
                img.style.display = 'none';
            }
            
            document.getElementById('linkPreview').classList.remove('hidden');
            window.currentLinkPreview = preview;
        }

        document.getElementById('removeLinkPreview').addEventListener('click', () => {
            document.getElementById('linkPreview').classList.add('hidden');
            window.currentLinkPreview = null;
        });

        function clearPollInputs() {
            document.getElementById('pollOption1').value = '';
            document.getElementById('pollOption2').value = '';
            document.getElementById('pollOption3').value = '';
            document.getElementById('pollOption4').value = '';
        }

        document.getElementById('postBuzzBtn').addEventListener('click', () => {
            const text = document.getElementById('buzzText').value.trim();
            const imageFile = document.getElementById('buzzImageInput').files[0];
            
            if (!text && !imageFile) return;

            const buzzData = {
                userId: currentUser.uid,
                authorName: currentUserData.name,
                authorUsername: currentUserData.username,
                authorImage: currentUserData.profilePicture || null,
                text: text,
                timestamp: Date.now(),
                likes: 0,
                rebuzzes: 0,
                comments: 0,
                image: null
            };

            if (imageFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    buzzData.image = e.target.result;
                    saveBuzz(buzzData);
                };
                reader.readAsDataURL(imageFile);
            } else {
                saveBuzz(buzzData);
            }
        });

        function saveBuzz(buzzData) {
            // Extract hashtags and mentions
            const hashtags = extractHashtags(buzzData.text);
            const mentions = extractMentions(buzzData.text);
            
            // Add poll data if exists
            if (!document.getElementById('pollPreview').classList.contains('hidden')) {
                const pollOptions = [];
                const option1 = document.getElementById('pollOption1').value.trim();
                const option2 = document.getElementById('pollOption2').value.trim();
                const option3 = document.getElementById('pollOption3').value.trim();
                const option4 = document.getElementById('pollOption4').value.trim();
                
                if (option1) pollOptions.push({ text: option1, votes: 0 });
                if (option2) pollOptions.push({ text: option2, votes: 0 });
                if (option3) pollOptions.push({ text: option3, votes: 0 });
                if (option4) pollOptions.push({ text: option4, votes: 0 });
                
                if (pollOptions.length >= 2) {
                    const duration = parseInt(document.getElementById('pollDuration').value);
                    buzzData.poll = {
                        options: pollOptions,
                        totalVotes: 0,
                        expiresAt: Date.now() + (duration * 24 * 60 * 60 * 1000),
                        voters: {}
                    };
                }
            }
            
            // Add location data if exists
            if (window.currentLocation) {
                buzzData.location = {
                    lat: window.currentLocation.lat,
                    lng: window.currentLocation.lng,
                    timestamp: Date.now()
                };
            }
            
            // Add link preview if exists
            if (window.currentLinkPreview) {
                buzzData.linkPreview = window.currentLinkPreview;
            }
            
            const buzzRef = database.ref('buzzes').push();
            buzzRef.set(buzzData).then(() => {
                // Save hashtags
                if (hashtags.length > 0) {
                    saveHashtags(hashtags);
                    loadHashtags(); // Refresh hashtag list
                }
                
                // Send mention notifications
                if (mentions.length > 0) {
                    sendMentionNotifications(mentions, buzzRef.key);
                }
                
                // Clear all inputs
                document.getElementById('buzzText').value = '';
                document.getElementById('imagePreview').classList.add('hidden');
                document.getElementById('pollPreview').classList.add('hidden');
                document.getElementById('locationPreview').classList.add('hidden');
                document.getElementById('linkPreview').classList.add('hidden');
                document.getElementById('buzzImageInput').value = '';
                document.getElementById('buzzAutocomplete').classList.add('hidden');
                clearPollInputs();
                window.currentLocation = null;
                window.currentLinkPreview = null;
                
                loadBuzzes();
                loadUserStats(); // Update buzz count
                
                // Show success toast
                showToast('Success!', 'Buzz posted successfully!', 'success');
            }).catch((error) => {
                console.error('Error posting buzz:', error);
                showToast('Error!', 'Failed to post buzz. Please try again.', 'error');
            });
        }

        function loadBuzzes() {
            const feed = document.getElementById('buzzFeed');
            
            // Show loading animation
            feed.innerHTML = `
                <div class="flex justify-center items-center py-16">
                    <div class="text-center">
                        <div class="w-12 h-12 mx-auto mb-4 rounded-full instagram-gradient flex items-center justify-center animate-pulse">
                            <span class="text-white text-xl font-bold">P</span>
                        </div>
                        <div class="flex justify-center space-x-1 mb-2">
                            <div class="w-2 h-2 bg-pink-500 rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                            <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        </div>
                        <p class="text-gray-500 text-sm">Loading buzzes...</p>
                    </div>
                </div>
            `;
            
            database.ref('buzzes').orderByChild('timestamp').once('value').then((snapshot) => {
                const buzzes = [];
                snapshot.forEach((childSnapshot) => {
                    const buzz = childSnapshot.val();
                    buzz.id = childSnapshot.key;
                    buzzes.unshift(buzz);
                });
                
                // Simulate loading delay for better UX
                setTimeout(() => {
                    displayBuzzes(buzzes);
                }, 800);
            });
        }

        function displayBuzzes(buzzes) {
            const feed = document.getElementById('buzzFeed');
            feed.innerHTML = '';
            
            buzzes.forEach(buzz => {
                // Skip buzzes from blocked users
                if (blockedUsers.includes(buzz.userId)) {
                    return;
                }
                
                // Always fetch fresh user data from database for verified status and other updates
                database.ref('users/' + buzz.userId).once('value').then((userSnapshot) => {
                    const user = userSnapshot.val();
                    if (user) {
                        // Update buzz with fresh user data
                        buzz.authorName = user.name;
                        buzz.authorUsername = user.username;
                        buzz.authorImage = user.profilePicture;
                        buzz.authorVerified = user.verified;
                        
                        const buzzElement = createBuzzElement(buzz, user);
                        feed.appendChild(buzzElement);
                    }
                });
            });
        }

        function createBuzzElement(buzz, user) {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-2xl shadow-sm p-4 md:p-6 buzz-card';
            
            const initials = getInitials(user.name);
            const avatarStyle = user.profilePicture ? 
                `background-image: url(${user.profilePicture}); background-size: cover;` : 
                '';
            
            // Create poll HTML if exists
            let pollHTML = '';
            if (buzz.poll) {
                const isExpired = Date.now() > buzz.poll.expiresAt;
                const hasVoted = buzz.poll.voters && buzz.poll.voters[currentUser.uid];
                
                pollHTML = `
                    <div class="border border-gray-200 rounded-xl p-4 mb-4">
                        <div class="space-y-2">
                            ${buzz.poll.options.map((option, index) => {
                                const percentage = buzz.poll.totalVotes > 0 ? Math.round((option.votes / buzz.poll.totalVotes) * 100) : 0;
                                return `
                                    <div class="relative">
                                        <button onclick="votePoll('${buzz.id}', ${index})" 
                                                class="w-full text-left p-3 border border-gray-300 rounded-lg hover:bg-gray-50 ${hasVoted || isExpired ? 'cursor-not-allowed opacity-75' : ''}" 
                                                ${hasVoted || isExpired ? 'disabled' : ''}>
                                            <div class="flex justify-between items-center">
                                                <span>${option.text}</span>
                                                ${hasVoted || isExpired ? `<span class="text-sm text-gray-500">${percentage}%</span>` : ''}
                                            </div>
                                            ${hasVoted || isExpired ? `
                                                <div class="absolute bottom-0 left-0 h-1 bg-blue-500 rounded-full" style="width: ${percentage}%"></div>
                                            ` : ''}
                                        </button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div class="text-xs text-gray-500 mt-2">
                            ${buzz.poll.totalVotes} votes  ${isExpired ? 'Ended' : 'Ends'} ${formatDate(buzz.poll.expiresAt)}
                        </div>
                    </div>
                `;
            }
            
            // Create location HTML if exists
            let locationHTML = '';
            if (buzz.location) {
                locationHTML = `
                    <div class="border border-gray-200 rounded-xl p-3 mb-4 flex items-center space-x-3">
                        <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                        </svg>
                        <div>
                            <div class="text-sm font-medium">Location</div>
                            <div class="text-xs text-gray-500">${buzz.location.lat.toFixed(4)}, ${buzz.location.lng.toFixed(4)}</div>
                        </div>
                        <button onclick="openMap(${buzz.location.lat}, ${buzz.location.lng})" class="text-blue-500 text-xs hover:underline">View Map</button>
                    </div>
                `;
            }
            
            // Create link preview HTML if exists
            let linkPreviewHTML = '';
            if (buzz.linkPreview) {
                linkPreviewHTML = `
                    <div class="border border-gray-200 rounded-xl overflow-hidden mb-4">
                        ${buzz.linkPreview.image ? `<img src="${buzz.linkPreview.image}" class="w-full h-48 object-cover">` : ''}
                        <div class="p-3">
                            <h4 class="font-semibold text-sm line-clamp-2">${buzz.linkPreview.title || ''}</h4>
                            <p class="text-xs text-gray-600 line-clamp-2 mt-1">${buzz.linkPreview.description || ''}</p>
                            <a href="${buzz.linkPreview.url}" target="_blank" class="text-xs text-blue-500 hover:underline mt-1 block">${buzz.linkPreview.url}</a>
                        </div>
                    </div>
                `;
            }
            
            div.innerHTML = `
                <div class="flex space-x-3 md:space-x-4">
                    <div class="w-10 h-10 md:w-12 md:h-12 rounded-full avatar-gradient flex items-center justify-center text-white font-bold flex-shrink-0 cursor-pointer touch-target" style="${avatarStyle}" onclick="openUserProfile('${buzz.userId}')">
                        ${user.profilePicture ? '' : initials}
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-2">
                            <h4 class="font-bold cursor-pointer hover:underline flex items-center" onclick="openUserProfile('${buzz.userId}')">
                                ${user.name}
                                ${user.verified ? '<span class="verified-badge ml-1"></span>' : ''}
                            </h4>
                            <span class="text-gray-500 cursor-pointer hover:underline" onclick="openUserProfile('${buzz.userId}')">@${user.username}</span>
                            <span class="text-gray-500"></span>
                            <span class="text-gray-500">${formatDate(buzz.timestamp)}</span>
                        </div>
                        <p class="mb-4 mobile-text">${processTextWithHashtagsAndMentions(buzz.text)}</p>
                        ${buzz.image ? `<img src="${buzz.image}" class="w-full max-h-96 object-cover rounded-xl mb-4">` : ''}
                        ${pollHTML}
                        ${locationHTML}
                        ${linkPreviewHTML}
                        <div class="flex items-center justify-between text-gray-500">
                            <button class="flex items-center space-x-2 hover:text-blue-500 p-2 rounded-full hover:bg-blue-50 touch-target" onclick="openComments('${buzz.id}')">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/>
                                </svg>
                                <span class="text-sm">${buzz.comments || 0}</span>
                            </button>
                            <button class="flex items-center space-x-2 hover:text-green-500 p-2 rounded-full hover:bg-green-50 touch-target" onclick="showRebuzzOptions('${buzz.id}')">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z"/>
                                </svg>
                                <span class="text-sm">${buzz.rebuzzes || 0}</span>
                            </button>
                            <button class="flex items-center space-x-2 hover:text-red-500 p-2 rounded-full hover:bg-red-50 touch-target" onclick="likeBuzz('${buzz.id}')">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/>
                                </svg>
                                <span class="text-sm">${buzz.likes || 0}</span>
                            </button>
                            <button class="flex items-center space-x-2 hover:text-purple-500 p-2 rounded-full hover:bg-purple-50 touch-target" onclick="shareBuzz('${buzz.id}')">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"/>
                                </svg>
                            </button>
                            <div class="relative">
                                <button onclick="toggleBuzzMenu('${buzz.id}')" class="flex items-center space-x-2 hover:text-gray-700 p-2 rounded-full hover:bg-gray-50 touch-target">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/>
                                    </svg>
                                </button>
                                <div id="buzzMenu-${buzz.id}" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border z-10">
                                    ${buzz.userId === currentUser.uid ? `
                                        <button onclick="deleteBuzz('${buzz.id}')" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-red-500 touch-target">Delete Buzz</button>
                                    ` : `
                                        <button onclick="blockUser('${buzz.userId}')" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-red-500 touch-target">Block User</button>
                                        <button onclick="reportBuzz('${buzz.id}')" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-red-500 touch-target">Report</button>
                                    `}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            return div;
        }

        // Buzz Actions
        function likeBuzz(buzzId) {
            const likeRef = database.ref('likes/' + buzzId + '/' + currentUser.uid);
            likeRef.once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    // Unlike
                    likeRef.remove();
                    database.ref('buzzes/' + buzzId + '/likes').transaction((likes) => {
                        return Math.max(0, (likes || 0) - 1);
                    });
                } else {
                    // Like
                    likeRef.set(true);
                    database.ref('buzzes/' + buzzId + '/likes').transaction((likes) => {
                        return (likes || 0) + 1;
                    });
                    
                    // Send notification to buzz author
                    database.ref('buzzes/' + buzzId + '/userId').once('value').then((userSnapshot) => {
                        const authorId = userSnapshot.val();
                        if (authorId !== currentUser.uid) {
                            sendNotificationToUser(authorId, 'like', buzzId);
                        }
                    });
                }
                loadBuzzes();
            });
        }

        function showRebuzzOptions(buzzId) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm">
                    <div class="p-6">
                        <h3 class="text-xl font-bold mb-4 text-center">Rebuzz Options</h3>
                        <div class="space-y-3">
                            <button onclick="rebuzz('${buzzId}'); document.body.removeChild(this.closest('.fixed'))" class="w-full p-3 text-left hover:bg-gray-50 rounded-lg touch-target">
                                <div class="font-semibold">Rebuzz</div>
                                <div class="text-sm text-gray-500">Share instantly</div>
                            </button>
                            <button onclick="quoteRebuzz('${buzzId}'); document.body.removeChild(this.closest('.fixed'))" class="w-full p-3 text-left hover:bg-gray-50 rounded-lg touch-target">
                                <div class="font-semibold">Quote Rebuzz</div>
                                <div class="text-sm text-gray-500">Add your thoughts</div>
                            </button>
                        </div>
                        <button onclick="document.body.removeChild(this.closest('.fixed'))" class="w-full mt-4 p-3 text-center text-gray-500 hover:bg-gray-50 rounded-lg touch-target">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function rebuzz(buzzId) {
            const rebuzzRef = database.ref('rebuzzes/' + buzzId + '/' + currentUser.uid);
            rebuzzRef.once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    // Un-rebuzz
                    rebuzzRef.remove();
                    database.ref('buzzes/' + buzzId + '/rebuzzes').transaction((rebuzzes) => {
                        return Math.max(0, (rebuzzes || 0) - 1);
                    });
                } else {
                    // Rebuzz
                    rebuzzRef.set(true);
                    database.ref('buzzes/' + buzzId + '/rebuzzes').transaction((rebuzzes) => {
                        return (rebuzzes || 0) + 1;
                    });
                    
                    // Send notification to buzz author
                    database.ref('buzzes/' + buzzId + '/userId').once('value').then((userSnapshot) => {
                        const authorId = userSnapshot.val();
                        if (authorId !== currentUser.uid) {
                            sendNotificationToUser(authorId, 'rebuzz', buzzId);
                        }
                    });
                }
                loadBuzzes();
            });
        }

        function quoteRebuzz(buzzId) {
            database.ref('buzzes/' + buzzId).once('value').then((snapshot) => {
                const originalBuzz = snapshot.val();
                if (originalBuzz) {
                    // Get original author data
                    database.ref('users/' + originalBuzz.userId).once('value').then((userSnapshot) => {
                        const originalUser = userSnapshot.val();
                        if (originalUser) {
                            // Pre-fill buzz text with quote
                            const quoteText = `"${originalBuzz.text}" - @${originalUser.username}\n\n`;
                            document.getElementById('buzzText').value = quoteText;
                            document.getElementById('buzzText').focus();
                            
                            // Set cursor at the end
                            const textArea = document.getElementById('buzzText');
                            textArea.setSelectionRange(textArea.value.length, textArea.value.length);
                            
                            // Scroll to top smoothly
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                            
                            showToast('Success!', 'Quote added! Add your thoughts and buzz it.', 'success');
                        }
                    });
                }
            });
        }

        function toggleFollow(userId) {
            // Update UI immediately for better UX
            const buttons = document.querySelectorAll(`[id^="followBtn-${userId}"], [id^="followListBtn-${userId}"]`);
            const isCurrentlyFollowing = buttons[0] && buttons[0].textContent.trim() === 'Following';
            
            // Update buttons immediately
            buttons.forEach(btn => {
                btn.disabled = true;
                btn.textContent = isCurrentlyFollowing ? 'Follow' : 'Following';
                btn.className = isCurrentlyFollowing ? 
                    (btn.className.includes('followListBtn') ? 
                        'px-4 py-1 rounded-full text-sm font-semibold instagram-gradient text-white touch-target' :
                        'instagram-gradient text-white px-6 py-2 rounded-full font-semibold touch-target') :
                    (btn.className.includes('followListBtn') ? 
                        'px-4 py-1 rounded-full text-sm font-semibold border border-gray-300 text-gray-700 hover:bg-gray-50 touch-target' :
                        'border border-gray-300 text-gray-700 px-6 py-2 rounded-full font-semibold hover:bg-gray-50 touch-target');
            });
            
            const followRef = database.ref('following/' + currentUser.uid + '/' + userId);
            const followerRef = database.ref('followers/' + userId + '/' + currentUser.uid);
            
            if (isCurrentlyFollowing) {
                // Unfollow
                followRef.remove();
                followerRef.remove();
                showToast('Success!', 'Unfollowed successfully', 'success');
                sendNotificationToUser(userId, 'unfollow');
            } else {
                // Follow
                followRef.set(true);
                followerRef.set(true);
                showToast('Success!', 'Following successfully', 'success');
                sendNotificationToUser(userId, 'follow');
            }
            
            // Re-enable buttons
            setTimeout(() => {
                buttons.forEach(btn => btn.disabled = false);
            }, 500);
            
            // Update follow counts
            loadUserStats();
        }

        function openComments(buzzId) {
            currentBuzzId = buzzId;
            showModal('commentModal');
            loadComments(buzzId);
        }

        function loadComments(buzzId) {
            database.ref('comments/' + buzzId).once('value').then((snapshot) => {
                const commentList = document.getElementById('commentList');
                commentList.innerHTML = '';
                
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const comment = childSnapshot.val();
                        database.ref('users/' + comment.userId).once('value').then((userSnapshot) => {
                            const user = userSnapshot.val();
                            if (user) {
                                const commentElement = createCommentElement(comment, user);
                                commentList.appendChild(commentElement);
                            }
                        });
                    });
                } else {
                    commentList.innerHTML = '<p class="text-gray-500 text-center">No comments yet</p>';
                }
            });
        }

        function createCommentElement(comment, user) {
            const div = document.createElement('div');
            div.className = 'flex space-x-3 mb-4';
            
            const initials = getInitials(user.name);
            const avatarStyle = user.profilePicture ? 
                `background-image: url(${user.profilePicture}); background-size: cover;` : 
                '';
            
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full avatar-gradient flex items-center justify-center text-white text-sm font-bold flex-shrink-0" style="${avatarStyle}">
                    ${user.profilePicture ? '' : initials}
                </div>
                <div class="flex-1">
                    <div class="bg-gray-100 rounded-2xl p-3">
                        <div class="font-semibold text-sm flex items-center">
                            ${user.name}
                            ${user.verified ? '<span class="verified-badge ml-1"></span>' : ''}
                        </div>
                        <div class="text-sm mobile-text">${processTextWithHashtagsAndMentions(comment.text)}</div>
                    </div>
                    <div class="flex items-center justify-between text-xs text-gray-500 mt-1">
                        <span>${formatDate(comment.timestamp)}</span>
                        <button onclick="likeComment('${comment.id || Date.now()}')" class="flex items-center space-x-1 hover:text-red-500 touch-target">
                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/>
                            </svg>
                            <span>${comment.likes || 0}</span>
                        </button>
                    </div>
                </div>
            `;
            
            return div;
        }

        document.getElementById('postCommentBtn').addEventListener('click', () => {
            const commentText = document.getElementById('commentInput').value.trim();
            if (commentText && currentBuzzId) {
                const commentData = {
                    userId: currentUser.uid,
                    text: commentText,
                    timestamp: Date.now()
                };
                
                // Extract hashtags and mentions
                const hashtags = extractHashtags(commentText);
                const mentions = extractMentions(commentText);
                
                database.ref('comments/' + currentBuzzId).push(commentData).then((commentRef) => {
                    // Save hashtags
                    if (hashtags.length > 0) {
                        saveHashtags(hashtags);
                        loadHashtags();
                    }
                    
                    // Send mention notifications
                    if (mentions.length > 0) {
                        sendMentionNotifications(mentions, currentBuzzId);
                    }
                    
                    document.getElementById('commentInput').value = '';
                    document.getElementById('commentAutocomplete').classList.add('hidden');
                    loadComments(currentBuzzId);
                    
                    // Update comment count and send notification
                    database.ref('buzzes/' + currentBuzzId).once('value').then((snapshot) => {
                        const buzz = snapshot.val();
                        const newComments = (buzz.comments || 0) + 1;
                        database.ref('buzzes/' + currentBuzzId).update({ comments: newComments });
                        
                        // Send notification to buzz author
                        if (buzz.userId !== currentUser.uid) {
                            sendNotificationToUser(buzz.userId, 'comment', currentBuzzId);
                        }
                        
                        loadBuzzes();
                    });
                });
            }
        });

        // Search Event Listeners
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const query = e.target.value;
            const results = searchUsers(query);
            displaySearchResults(results, 'searchResults');
        });

        document.getElementById('searchInput').addEventListener('focus', (e) => {
            const query = e.target.value;
            const results = searchUsers(query);
            displaySearchResults(results, 'searchResults');
        });

        document.getElementById('mobileSearchInput').addEventListener('input', (e) => {
            const query = e.target.value;
            const results = searchUsers(query);
            displaySearchResults(results, 'mobileSearchResults');
        });

        document.getElementById('mobileSearchInput').addEventListener('focus', (e) => {
            const query = e.target.value;
            const results = searchUsers(query);
            displaySearchResults(results, 'mobileSearchResults');
        });

        document.getElementById('mobileSearchBtn').addEventListener('click', () => {
            const searchBar = document.getElementById('mobileSearchBar');
            searchBar.classList.toggle('hidden');
            if (!searchBar.classList.contains('hidden')) {
                document.getElementById('mobileSearchInput').focus();
            }
        });

        // Page Controls
        document.getElementById('notificationBtn').addEventListener('click', () => {
            openNotificationPage();
        });

        document.getElementById('messageBtn').addEventListener('click', () => {
            openMessagesPage();
        });

        document.getElementById('settingsBtn').addEventListener('click', () => {
            openSettingsPage();
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            auth.signOut().then(() => {
                showScreen('loginScreen');
                currentUser = null;
            });
        });

        // Profile tab event listeners
        document.getElementById('buzzesTab').addEventListener('click', () => loadProfileContent('buzzes'));
        document.getElementById('mediaTab').addEventListener('click', () => loadProfileContent('media'));
        document.getElementById('likesTab').addEventListener('click', () => loadProfileContent('likes'));

        // Edit Profile Event Listeners
        document.getElementById('editProfilePicBtn').addEventListener('click', () => {
            document.getElementById('editProfilePicInput').click();
        });
        
        document.getElementById('editProfileAvatar').addEventListener('click', () => {
            document.getElementById('editProfilePicInput').click();
        });
        
        document.getElementById('closeEditProfileBtn').addEventListener('click', () => {
            hideModal('editProfileModal');
        });
        
        document.getElementById('cancelEditProfileBtn').addEventListener('click', () => {
            hideModal('editProfileModal');
        });
        
        document.getElementById('saveProfileBtn').addEventListener('click', () => {
            saveProfileChanges();
        });
        
        // Profile picture change handler for edit page
        document.getElementById('editPageProfilePicInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('editPageProfileAvatar').style.backgroundImage = `url(${e.target.result})`;
                    document.getElementById('editPageProfileAvatar').style.backgroundSize = 'cover';
                    document.getElementById('editPageProfileAvatar').textContent = '';
                };
                reader.readAsDataURL(file);
            }
        });

        // Settings event listeners
        function openVerificationPage() {
            showPage('verificationPage');
        }

        function openPrivacyPage() {
            showPage('privacyPage');
        }

        function openBlockListPage() {
            showPage('blockListPage');
            loadBlockList();
        }

        document.getElementById('closeProfileBtn').addEventListener('click', () => {
            hideModal('profileModal');
        });

        // Private account toggle
        document.getElementById('privateAccountToggle').addEventListener('change', (e) => {
            const isPrivate = e.target.checked;
            database.ref('users/' + currentUser.uid + '/isPrivate').set(isPrivate);
            currentUserData.isPrivate = isPrivate;
        });

        // Close search results and menus when clicking outside
        document.addEventListener('click', (e) => {
            // Close search results
            if (!e.target.closest('#searchInput') && !e.target.closest('#searchResults')) {
                document.getElementById('searchResults').classList.add('hidden');
            }
            if (!e.target.closest('#mobileSearchInput') && !e.target.closest('#mobileSearchResults')) {
                document.getElementById('mobileSearchResults').classList.add('hidden');
            }
            
            // Close buzz menus
            if (!e.target.closest('[id^="buzzMenu-"]') && !e.target.closest('button[onclick^="toggleBuzzMenu"]')) {
                document.querySelectorAll('[id^="buzzMenu-"]').forEach(m => m.classList.add('hidden'));
            }
        });

        // Auth State Observer - Persistent login
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                // Check if user is already logged in and has setup complete
                database.ref('users/' + user.uid).once('value').then((snapshot) => {
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        if (userData.setupComplete) {
                            // User is already set up, load main app directly
                            loadMainApp(userData);
                        } else {
                            // User needs to complete setup
                            showScreen('nameSetup');
                        }
                    } else {
                        // New user, start setup
                        showScreen('nameSetup');
                    }
                });
            } else {
                showScreen('loginScreen');
            }
        });

        // Buzz menu functions
        function toggleBuzzMenu(buzzId) {
            const menu = document.getElementById('buzzMenu-' + buzzId);
            const isHidden = menu.classList.contains('hidden');
            
            // Hide all other menus
            document.querySelectorAll('[id^="buzzMenu-"]').forEach(m => m.classList.add('hidden'));
            
            if (isHidden) {
                menu.classList.remove('hidden');
            }
        }

        function reportBuzz(buzzId) {
            // Create custom confirmation dialog
            const modal = document.createElement('div');
            modal.id = 'reportBuzzModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6">
                    <div class="text-center">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 mb-4">
                            <svg class="h-6 w-6 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Report Buzz</h3>
                        <p class="text-sm text-gray-500 mb-6">Report this buzz for inappropriate content? Our team will review it.</p>
                        <div class="flex space-x-3">
                            <button id="cancelReportBtn" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 touch-target">Cancel</button>
                            <button id="confirmReportBtn" class="flex-1 px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 touch-target">Report</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add event listeners
            document.getElementById('cancelReportBtn').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            document.getElementById('confirmReportBtn').addEventListener('click', () => {
                confirmReportBuzz(buzzId);
                document.body.removeChild(modal);
            });
        }

        function confirmReportBuzz(buzzId) {
            database.ref('reports/' + buzzId).push({
                reportedBy: currentUser.uid,
                timestamp: Date.now(),
                reason: 'inappropriate'
            }).then(() => {
                showToast('Success!', 'Buzz reported successfully. Thank you for keeping our community safe!', 'success');
            }).catch((error) => {
                console.error('Error reporting buzz:', error);
                showToast('Error!', 'Failed to report buzz. Please try again.', 'error');
            });
        }

        function deleteBuzz(buzzId) {
            // Create custom confirmation dialog
            const modal = document.createElement('div');
            modal.id = 'deleteBuzzModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6">
                    <div class="text-center">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                            <svg class="h-6 w-6 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" clip-rule="evenodd"/>
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Delete Buzz</h3>
                        <p class="text-sm text-gray-500 mb-6">Are you sure you want to delete this buzz? This action cannot be undone.</p>
                        <div class="flex space-x-3">
                            <button id="cancelDeleteBtn" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 touch-target">Cancel</button>
                            <button id="confirmDeleteBtn" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 touch-target">Delete</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add event listeners
            document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
                confirmDeleteBuzz(buzzId);
                document.body.removeChild(modal);
            });
        }

        function confirmDeleteBuzz(buzzId) {
            // Delete the buzz
            database.ref('buzzes/' + buzzId).remove();
            
            // Delete associated comments
            database.ref('comments/' + buzzId).remove();
            
            // Delete associated likes
            database.ref('likes/' + buzzId).remove();
            
            // Delete associated rebuzzes
            database.ref('rebuzzes/' + buzzId).remove();
            
            // Refresh the feed
            loadBuzzes();
            loadUserStats();
            
            // Show success toast
            showToast('Success!', 'Buzz deleted successfully!', 'success');
        }

        // Verification Functions
        document.getElementById('verificationCountry').addEventListener('change', (e) => {
            const country = e.target.value;
            const docTypeSelect = document.getElementById('verificationDocType');
            const docTypeSection = document.getElementById('documentTypeSection');
            const docUploadSection = document.getElementById('documentUploadSection');
            
            if (country) {
                const docs = documentTypes[country] || documentTypes['default'];
                docTypeSelect.innerHTML = '<option value="">Select Document Type</option>';
                docs.forEach(doc => {
                    docTypeSelect.innerHTML += `<option value="${doc}">${doc}</option>`;
                });
                docTypeSection.classList.remove('hidden');
            } else {
                docTypeSection.classList.add('hidden');
                docUploadSection.classList.add('hidden');
            }
        });

        document.getElementById('verificationDocType').addEventListener('change', (e) => {
            const docUploadSection = document.getElementById('documentUploadSection');
            if (e.target.value) {
                docUploadSection.classList.remove('hidden');
            } else {
                docUploadSection.classList.add('hidden');
            }
        });

        function submitVerificationRequest() {
            const name = document.getElementById('verificationName').value.trim();
            const reason = document.getElementById('verificationReason').value.trim();
            const otherName = document.getElementById('verificationOtherName').value.trim();
            const country = document.getElementById('verificationCountry').value;
            const docType = document.getElementById('verificationDocType').value;
            const docFile = document.getElementById('verificationDocument').files[0];
            
            if (!name || !reason || !country || !docType || !docFile) {
                showToast('Error!', 'Please fill all required fields', 'error');
                return;
            }
            
            // Get social links
            const socialLinks = [];
            document.querySelectorAll('#socialLinksContainer input').forEach(input => {
                if (input.value.trim()) {
                    socialLinks.push(input.value.trim());
                }
            });
            
            // Convert document to base64
            const reader = new FileReader();
            reader.onload = (e) => {
                const verificationData = {
                    userId: currentUser.uid,
                    name: name,
                    reason: reason,
                    otherName: otherName,
                    country: country,
                    documentType: docType,
                    documentImage: e.target.result,
                    socialLinks: socialLinks,
                    status: 'pending',
                    submittedAt: Date.now()
                };
                
                database.ref('verificationRequests').push(verificationData).then(() => {
                    hideModal('verificationModal');
                    showToast('Success!', 'Verification request submitted successfully! We will review it within 24-48 hours.', 'success');
                    
                    // Clear form
                    document.getElementById('verificationName').value = '';
                    document.getElementById('verificationReason').value = '';
                    document.getElementById('verificationOtherName').value = '';
                    document.getElementById('verificationCountry').value = '';
                    document.getElementById('verificationDocType').value = '';
                    document.getElementById('verificationDocument').value = '';
                    document.querySelectorAll('#socialLinksContainer input').forEach(input => input.value = '');
                    document.getElementById('documentTypeSection').classList.add('hidden');
                    document.getElementById('documentUploadSection').classList.add('hidden');
                }).catch((error) => {
                    console.error('Error submitting verification:', error);
                    showToast('Error!', 'Failed to submit verification request. Please try again.', 'error');
                });
            };
            reader.readAsDataURL(docFile);
        }

        // Messaging Functions
        function loadConversations() {
            const conversationsList = document.getElementById('messagesConversationsList');
            conversationsList.innerHTML = '<div class="flex justify-center items-center py-16"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500"></div></div>';
            
            database.ref('conversations').orderByChild('participants/' + currentUser.uid).equalTo(true).once('value').then((snapshot) => {
                conversationsList.innerHTML = '';
                
                if (!snapshot.exists()) {
                    conversationsList.innerHTML = `
                        <div class="flex flex-col items-center justify-center py-16 px-8 text-center">
                            <div class="w-20 h-20 rounded-full bg-gray-100 flex items-center justify-center mb-4">
                                <svg class="w-10 h-10 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                                    <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                                </svg>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">No messages yet</h3>
                            <p class="text-gray-500 text-sm mb-4">Start messaging by visiting someone's profile and tapping "Message"</p>
                            <button onclick="hidePage('messagesPage')" class="instagram-gradient text-white px-6 py-2 rounded-full font-semibold">Explore Users</button>
                        </div>
                    `;
                    return;
                }
                
                const conversations = [];
                snapshot.forEach((childSnapshot) => {
                    const conversation = childSnapshot.val();
                    conversation.id = childSnapshot.key;
                    conversations.push(conversation);
                });
                
                // Sort by last message time
                conversations.sort((a, b) => (b.lastMessageTime || 0) - (a.lastMessageTime || 0));
                
                conversations.forEach(conversation => {
                    // Get other participant
                    const otherUserId = Object.keys(conversation.participants).find(id => id !== currentUser.uid);
                    
                    database.ref('users/' + otherUserId).once('value').then((userSnapshot) => {
                        const user = userSnapshot.val();
                        if (user) {
                            const conversationElement = createConversationElement(conversation, user, otherUserId);
                            conversationsList.appendChild(conversationElement);
                        }
                    });
                });
            });
        }

        function createConversationElement(conversation, user, userId) {
            const div = document.createElement('div');
            div.className = 'p-4 border-b hover:bg-gray-50 cursor-pointer touch-target';
            div.onclick = () => openChat(user, userId);
            
            const initials = getInitials(user.name);
            const avatarStyle = user.profilePicture ? 
                `background-image: url(${user.profilePicture}); background-size: cover; border-radius: 50%;` : 
                '';
            
            div.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 rounded-full avatar-gradient flex items-center justify-center text-white font-bold" style="${avatarStyle}">
                        ${user.profilePicture ? '' : initials}
                    </div>
                    <div class="flex-1">
                        <div class="font-semibold flex items-center">
                            ${user.name}
                            ${user.verified ? '<span class="verified-badge ml-1"></span>' : ''}
                        </div>
                        <div class="text-sm text-gray-500">@${user.username}</div>
                        <div class="text-sm text-gray-600 truncate">${conversation.lastMessage || 'Start a conversation'}</div>
                        <div class="text-xs text-gray-400">${formatDate(conversation.lastMessageTime || conversation.createdAt || Date.now())}</div>
                    </div>
                </div>
            `;
            
            return div;
        }

        function openChat(user, userId) {
            currentChatUser = { ...user, uid: userId };
            showPage('chatPage');
            
            const initials = getInitials(user.name);
            document.getElementById('chatUserAvatar').textContent = initials;
            if (user.profilePicture) {
                document.getElementById('chatUserAvatar').style.backgroundImage = `url(${user.profilePicture})`;
                document.getElementById('chatUserAvatar').style.backgroundSize = 'cover';
                document.getElementById('chatUserAvatar').style.borderRadius = '50%';
                document.getElementById('chatUserAvatar').textContent = '';
            }
            
            document.getElementById('chatUserName').innerHTML = `${user.name} ${user.verified ? '<span class="verified-badge ml-1"></span>' : ''}`;
            document.getElementById('chatUserUsername').textContent = '@' + user.username;
            
            loadMessages(userId);
        }

        function loadMessages(otherUserId) {
            const conversationId = [currentUser.uid, otherUserId].sort().join('_');
            
            database.ref('messages/' + conversationId).orderByChild('timestamp').once('value').then((snapshot) => {
                const messagesContainer = document.getElementById('messagesContainer');
                messagesContainer.innerHTML = '';
                
                if (!snapshot.exists()) {
                    messagesContainer.innerHTML = '<div class="text-center text-gray-500">No messages yet. Start the conversation!</div>';
                    return;
                }
                
                snapshot.forEach((childSnapshot) => {
                    const message = childSnapshot.val();
                    const messageElement = createMessageElement(message);
                    messagesContainer.appendChild(messageElement);
                });
                
                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
        }

        function createMessageElement(message) {
            const div = document.createElement('div');
            const isSent = message.senderId === currentUser.uid;
            
            div.className = `flex ${isSent ? 'justify-end' : 'justify-start'} mb-2`;
            
            div.innerHTML = `
                <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-2xl ${isSent ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-900'}">
                    <div class="text-sm">${message.text}</div>
                    <div class="text-xs ${isSent ? 'text-blue-100' : 'text-gray-500'} mt-1">${formatDate(message.timestamp)}</div>
                </div>
            `;
            
            return div;
        }

        function sendMessage() {
            const messageText = document.getElementById('messageInput').value.trim();
            if (!messageText || !currentChatUser) return;
            
            const conversationId = [currentUser.uid, currentChatUser.uid].sort().join('_');
            
            const messageData = {
                senderId: currentUser.uid,
                receiverId: currentChatUser.uid,
                text: messageText,
                timestamp: Date.now()
            };
            
            // Save message
            database.ref('messages/' + conversationId).push(messageData).then(() => {
                // Update conversation
                const conversationData = {
                    participants: {
                        [currentUser.uid]: true,
                        [currentChatUser.uid]: true
                    },
                    lastMessage: messageText,
                    lastMessageTime: Date.now()
                };
                
                database.ref('conversations/' + conversationId).set(conversationData);
                
                // Clear input and reload messages
                document.getElementById('messageInput').value = '';
                loadMessages(currentChatUser.uid);
                
                // Send notification
                sendNotificationToUser(currentChatUser.uid, 'message');
            });
        }

        document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Share Functions
        function shareBuzz(buzzId) {
            currentShareBuzzId = buzzId;
            showModal('shareModal');
            loadShareUsers();
        }

        function loadShareUsers() {
            const shareUsersList = document.getElementById('shareUsersList');
            shareUsersList.innerHTML = '';
            
            // Load following users first
            database.ref('following/' + currentUser.uid).once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const userId = childSnapshot.key;
                        database.ref('users/' + userId).once('value').then((userSnapshot) => {
                            const user = userSnapshot.val();
                            if (user) {
                                const userElement = createShareUserElement(user, userId);
                                shareUsersList.appendChild(userElement);
                            }
                        });
                    });
                } else {
                    shareUsersList.innerHTML = '<div class="text-gray-500 text-center">Follow some users to share with them</div>';
                }
            });
        }

        function createShareUserElement(user, userId) {
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg cursor-pointer touch-target';
            
            const initials = getInitials(user.name);
            const avatarStyle = user.profilePicture ? 
                `background-image: url(${user.profilePicture}); background-size: cover;` : 
                '';
            
            div.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-full avatar-gradient flex items-center justify-center text-white font-bold" style="${avatarStyle}">
                        ${user.profilePicture ? '' : initials}
                    </div>
                    <div>
                        <div class="font-semibold flex items-center">
                            ${user.name}
                            ${user.verified ? '<span class="verified-badge ml-1"></span>' : ''}
                        </div>
                        <div class="text-gray-500 text-sm">@${user.username}</div>
                    </div>
                </div>
                <button onclick="shareWithUser('${userId}')" class="instagram-gradient text-white px-4 py-2 rounded-full text-sm font-semibold touch-target">Send</button>
            `;
            
            return div;
        }

        function shareWithUser(userId) {
            if (!currentShareBuzzId) return;
            
            // Get buzz data
            database.ref('buzzes/' + currentShareBuzzId).once('value').then((snapshot) => {
                const buzz = snapshot.val();
                if (buzz) {
                    const conversationId = [currentUser.uid, userId].sort().join('_');
                    
                    const messageData = {
                        senderId: currentUser.uid,
                        receiverId: userId,
                        text: `Shared a buzz: "${buzz.text}"`,
                        sharedBuzzId: currentShareBuzzId,
                        timestamp: Date.now()
                    };
                    
                    database.ref('messages/' + conversationId).push(messageData).then(() => {
                        // Update conversation
                        const conversationData = {
                            participants: {
                                [currentUser.uid]: true,
                                [userId]: true
                            },
                            lastMessage: 'Shared a buzz',
                            lastMessageTime: Date.now()
                        };
                        
                        database.ref('conversations/' + conversationId).set(conversationData);
                        
                        hideModal('shareModal');
                        showToast('Success!', 'Buzz shared successfully!', 'success');
                        
                        // Send notification
                        sendNotificationToUser(userId, 'share', currentShareBuzzId);
                    });
                }
            });
        }

        document.getElementById('shareSearchInput').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const shareUsersList = document.getElementById('shareUsersList');
            
            if (!query.trim()) {
                loadShareUsers();
                return;
            }
            
            shareUsersList.innerHTML = '';
            
            // Search in all users
            allUsers.forEach(user => {
                if (user.name.toLowerCase().includes(query) || user.username.toLowerCase().includes(query)) {
                    const userElement = createShareUserElement(user, user.uid);
                    shareUsersList.appendChild(userElement);
                }
            });
        });

        // Comment like function
        function likeComment(commentId) {
            // Implementation for comment likes
            console.log('Like comment:', commentId);
        }

        // Message button event listener
        document.getElementById('messageBtn').addEventListener('click', () => {
            showPage('messagesPage');
            loadConversations();
        });

        // Poll voting function
        function votePoll(buzzId, optionIndex) {
            database.ref('buzzes/' + buzzId + '/poll').once('value').then((snapshot) => {
                const poll = snapshot.val();
                if (!poll || Date.now() > poll.expiresAt || poll.voters[currentUser.uid]) {
                    return; // Poll expired or already voted
                }
                
                // Update vote count
                database.ref('buzzes/' + buzzId + '/poll/options/' + optionIndex + '/votes').transaction((votes) => {
                    return (votes || 0) + 1;
                });
                
                // Update total votes
                database.ref('buzzes/' + buzzId + '/poll/totalVotes').transaction((total) => {
                    return (total || 0) + 1;
                });
                
                // Mark user as voted
                database.ref('buzzes/' + buzzId + '/poll/voters/' + currentUser.uid).set(optionIndex);
                
                // Refresh feed
                loadBuzzes();
                
                showToast('Success!', 'Vote recorded successfully!', 'success');
            });
        }

        // Map function
        function openMap(lat, lng) {
            const mapUrl = `https://www.google.com/maps?q=${lat},${lng}`;
            window.open(mapUrl, '_blank');
        }

        // Quote rebuzz function
        function quoteRebuzz(buzzId) {
            database.ref('buzzes/' + buzzId).once('value').then((snapshot) => {
                const originalBuzz = snapshot.val();
                if (originalBuzz) {
                    // Get original author data
                    database.ref('users/' + originalBuzz.userId).once('value').then((userSnapshot) => {
                        const originalUser = userSnapshot.val();
                        if (originalUser) {
                            // Pre-fill buzz text with quote
                            const quoteText = `"${originalBuzz.text}" - @${originalUser.username}`;
                            document.getElementById('buzzText').value = quoteText;
                            document.getElementById('buzzText').focus();
                            
                            // Scroll to top
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                        }
                    });
                }
            });
        }

        // Initialize
        showScreen('loginScreen');
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97abf96854d0a6dc',t:'MTc1NzE0MDgxOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
