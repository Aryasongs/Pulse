<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#667eea">
    <title>Pulse - Social Media Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <style>
        /* Mobile-first responsive design */
        * {
            box-sizing: border-box;
        }
        
        html {
            font-size: 16px;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .pulse-shadow {
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .buzz-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        .avatar-letter {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .pink-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .blue-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .notification-dot {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Windows Mobile specific optimizations */
        @media screen and (max-width: 480px) {
            html {
                font-size: 14px;
            }
            
            .max-w-md {
                max-width: 100% !important;
                margin: 0 !important;
            }
            
            .p-4 {
                padding: 12px !important;
            }
            
            .p-6 {
                padding: 16px !important;
            }
            
            .gap-3 {
                gap: 8px !important;
            }
            
            .text-lg {
                font-size: 1rem !important;
            }
            
            .text-xl {
                font-size: 1.125rem !important;
            }
            
            .text-2xl {
                font-size: 1.25rem !important;
            }
        }
        
        /* Touch-friendly interactions */
        .touch-target {
            min-width: 48px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Improved scrolling for mobile */
        .mobile-scroll {
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }
        
        /* Full-screen modal optimization */
        .mobile-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 1000;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Safe area handling for mobile browsers */
        .safe-top {
            padding-top: env(safe-area-inset-top);
        }
        
        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* Optimized input fields for mobile */
        input, textarea, select {
            font-size: 16px !important; /* Prevents zoom on iOS */
            border-radius: 8px;
            padding: 12px 16px;
        }
        
        /* Better button spacing for touch */
        button {
            min-height: 44px;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
        }
        
        /* Responsive images */
        img {
            max-width: 100%;
            height: auto;
        }
        
        /* Mobile navigation optimization */
        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            padding: 8px 0;
            padding-bottom: calc(8px + env(safe-area-inset-bottom));
        }
        
        /* Content spacing for fixed navigation */
        .content-with-nav {
            padding-bottom: calc(80px + env(safe-area-inset-bottom));
        }
        
        /* Improved modal animations */
        .modal-enter {
            animation: modalSlideUp 0.3s ease-out;
        }
        
        @keyframes modalSlideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* Windows Mobile specific fixes */
        @media screen and (-ms-high-contrast: active), (-ms-high-contrast: none) {
            .gradient-bg {
                background: #667eea;
            }
        }
        
        /* Landscape orientation adjustments */
        @media screen and (orientation: landscape) and (max-height: 500px) {
            .mobile-modal {
                padding-top: 10px;
            }
            
            .modal-content {
                max-height: calc(100vh - 20px);
                overflow-y: auto;
            }
        }
        .verified-tick {
            width: 16px;
            height: 16px;
            background-image: url('https://community.oriontec.xyz/check.png');
            background-size: contain;
            background-repeat: no-repeat;
            display: inline-block;
            margin-left: 4px;
        }
        .message-bubble {
            max-width: 70%;
            word-wrap: break-word;
        }
        .message-sent {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
        }
        .message-received {
            background: #f3f4f6;
            color: #374151;
        }
        
        .hashtag {
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
        }
        
        .hashtag:hover {
            text-decoration: underline;
        }
        
        .mention {
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
        }
        
        .mention:hover {
            text-decoration: underline;
        }
        
        .hashtag {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.9em;
        }
        
        .mention {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.9em;
        }
        
        .suggestions-dropdown {
            position: absolute;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            width: 100%;
        }
        
        .suggestion-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            transition: all 0.2s ease;
        }
        
        .suggestion-item:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .hashtag-suggestion {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .hashtag-icon {
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
        
        .mention-suggestion {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .mention-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        /* Custom notification styles */
        .custom-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            transform: translateX(400px);
            transition: all 0.3s ease;
            border-left: 4px solid #667eea;
            max-width: 300px;
        }
        
        .custom-notification.show {
            transform: translateX(0);
        }
        
        .custom-notification.success {
            border-left-color: #10b981;
        }
        
        .custom-notification.error {
            border-left-color: #ef4444;
        }
        
        .custom-notification.warning {
            border-left-color: #f59e0b;
        }
        
        /* Link preview styles */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .youtube-preview {
            transition: all 0.2s ease;
        }
        
        .youtube-preview:hover {
            background-color: #f9fafb;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Disable text selection and copy */
        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        input, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen mobile-scroll safe-top safe-bottom">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-md pulse-shadow">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold gradient-bg bg-clip-text text-transparent mb-2">Pulse</h1>
                <p class="text-gray-600">Connect with the world through Buzz</p>
            </div>
            <button id="googleSignIn" class="w-full bg-white border-2 border-gray-200 rounded-xl py-3 px-4 flex items-center justify-center gap-3 hover:bg-gray-50 transition-colors">
                <svg class="w-5 h-5" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Continue with Google
            </button>
        </div>
    </div>

    <!-- Setup Screens -->
    <div id="nameSetup" class="hidden min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-md pulse-shadow">
            <h2 class="text-2xl font-bold text-center mb-6">What's your name?</h2>
            <input type="text" id="fullName" placeholder="Enter your full name" class="w-full p-4 border-2 border-gray-200 rounded-xl mb-4 focus:border-purple-500 outline-none">
            <button id="nameNext" class="w-full gradient-bg text-white py-3 rounded-xl font-semibold">Next</button>
        </div>
    </div>

    <div id="usernameSetup" class="hidden min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-md pulse-shadow">
            <h2 class="text-2xl font-bold text-center mb-6">Choose a username</h2>
            <input type="text" id="username" placeholder="username123" class="w-full p-4 border-2 border-gray-200 rounded-xl mb-2 focus:border-purple-500 outline-none">
            <p class="text-sm text-gray-500 mb-4">Only lowercase letters and numbers allowed</p>
            <div id="usernameError" class="text-red-500 text-sm mb-4 hidden"></div>
            <button id="usernameNext" class="w-full gradient-bg text-white py-3 rounded-xl font-semibold">Next</button>
        </div>
    </div>

    <div id="dobSetup" class="hidden min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-md pulse-shadow">
            <h2 class="text-2xl font-bold text-center mb-6">When's your birthday?</h2>
            <input type="date" id="dateOfBirth" class="w-full p-4 border-2 border-gray-200 rounded-xl mb-4 focus:border-purple-500 outline-none">
            <button id="dobNext" class="w-full gradient-bg text-white py-3 rounded-xl font-semibold mb-3">Next</button>
            <button id="dobSkip" class="w-full border-2 border-gray-300 text-gray-600 py-3 rounded-xl font-semibold">Skip</button>
        </div>
    </div>

    <div id="profilePicSetup" class="hidden min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-md pulse-shadow">
            <h2 class="text-2xl font-bold text-center mb-6">Add a profile picture</h2>
            <div class="flex justify-center mb-6">
                <div id="previewAvatar" class="w-24 h-24 rounded-full avatar-letter flex items-center justify-center text-white text-2xl font-bold"></div>
            </div>
            <input type="file" id="profilePicInput" accept="image/*" class="hidden">
            <button id="uploadPic" class="w-full gradient-bg text-white py-3 rounded-xl font-semibold mb-3">Choose Photo</button>
            <button id="picSkip" class="w-full border-2 border-gray-300 text-gray-600 py-3 rounded-xl font-semibold">Skip</button>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Top Navigation -->
        <nav class="bg-white border-b border-gray-200 sticky top-0 z-50 safe-top">
            <div class="w-full px-4 py-3 flex items-center justify-between">
                <h1 class="text-xl md:text-2xl font-bold gradient-bg bg-clip-text text-transparent">Pulse</h1>
                <div class="flex gap-1">
                    <button id="notificationBtn" class="relative touch-target hover:bg-gray-100 rounded-full transition-colors">
                        <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4"/>
                        </svg>
                        <div id="notificationDot" class="hidden absolute -top-1 -right-1 w-4 h-4 md:w-5 md:h-5 bg-red-500 rounded-full notification-dot flex items-center justify-center">
                            <span id="notificationCount" class="text-white text-xs font-bold">0</span>
                        </div>
                    </button>
                    <button id="messageBtn" class="touch-target hover:bg-gray-100 rounded-full transition-colors">
                        <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                        </svg>
                    </button>
                    <button id="settingsBtn" class="touch-target hover:bg-gray-100 rounded-full transition-colors">
                        <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Create Buzz -->
        <div class="w-full px-3 md:max-w-md md:mx-auto content-with-nav">
            <div class="bg-white rounded-2xl p-3 md:p-4 mb-4 pulse-shadow">
                <div class="flex gap-2 md:gap-3">
                    <div id="userAvatar" class="w-10 h-10 md:w-12 md:h-12 rounded-full avatar-letter flex items-center justify-center text-white font-bold flex-shrink-0"></div>
                    <div class="flex-1 relative">
                        <textarea id="buzzText" placeholder="What's buzzing?" class="w-full resize-none border-none outline-none text-base md:text-lg" rows="3"></textarea>
                        <div id="suggestionDropdown" class="suggestions-dropdown hidden"></div>
                        <div class="flex items-center justify-between mt-3">
                            <div class="flex gap-2">
                                <button id="addImage" class="touch-target hover:bg-gray-100 rounded-full">
                                    <svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                    </svg>
                                </button>
                                <input type="file" id="buzzImageInput" accept="image/*" class="hidden">
                            </div>
                            <button id="postBuzz" class="gradient-bg text-white px-4 md:px-6 py-2 rounded-full font-semibold disabled:opacity-50 min-h-[44px]" disabled>Buzz</button>
                        </div>
                        <div id="imagePreview" class="hidden mt-3">
                            <img id="previewImg" class="w-full rounded-lg max-h-48 object-cover">
                            <button id="removeImage" class="mt-2 text-red-500 text-sm touch-target">Remove image</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Feed -->
            <div id="feed" class="space-y-3 md:space-y-4 pb-4">
                <!-- Buzz posts will be dynamically added here -->
            </div>
        </div>

        <!-- Search Screen -->
        <div id="searchScreen" class="hidden w-full px-3 md:max-w-md md:mx-auto content-with-nav">
            <div class="mb-4">
                <div class="relative">
                    <input type="text" id="searchInput" placeholder="Search users..." class="w-full p-3 md:p-4 pl-10 md:pl-12 border-2 border-gray-200 rounded-xl focus:border-purple-500 outline-none">
                    <svg class="w-4 h-4 md:w-5 md:h-5 absolute left-3 md:left-4 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                </div>
            </div>
            <div id="searchResults" class="space-y-3 pb-4">
                <!-- Search results will appear here -->
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="mobile-nav">
            <div class="w-full px-4 py-2 flex justify-around">
                <button id="homeBtn" class="touch-target gradient-bg bg-clip-text text-transparent rounded-full hover:bg-gray-100 transition-colors">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                    </svg>
                </button>
                <button id="searchBtn" class="touch-target text-gray-400 rounded-full hover:bg-gray-100 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                </button>
                <button id="profileBtn" class="touch-target text-gray-400 rounded-full hover:bg-gray-100 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                </button>
            </div>
        </nav>
    </div>

    <!-- Full-Screen Modals -->
    <!-- Notifications Screen -->
    <div id="notificationScreen" class="hidden mobile-modal modal-enter">
        <div class="safe-top">
            <div class="flex justify-between items-center p-4 border-b border-gray-200 bg-white sticky top-0">
                <button id="backFromNotifications" class="touch-target rounded-full hover:bg-gray-100 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </button>
                <h3 class="text-lg font-semibold">Notifications</h3>
                <div class="w-12"></div>
            </div>
            <div id="notificationsList" class="p-4 space-y-3 pb-20">
                <!-- Notifications will be loaded here -->
            </div>
        </div>
    </div>

    <!-- User Profile Screen -->
    <div id="userProfileScreen" class="hidden mobile-modal modal-enter">
        <div class="safe-top">
            <!-- Header -->
            <div class="flex justify-between items-center p-4 border-b border-gray-200 bg-white sticky top-0">
                <button id="backFromUserProfile" class="touch-target rounded-full hover:bg-gray-100 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </button>
                <h3 id="userProfileUsernameHeader" class="text-lg font-semibold"></h3>
                <button class="touch-target rounded-full hover:bg-gray-100 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>
                    </svg>
                </button>
            </div>
            
            <!-- Profile Info -->
            <div class="p-4">
                <div class="flex items-start gap-4 mb-4">
                    <div id="userProfileAvatar" class="w-20 h-20 rounded-full flex-shrink-0"></div>
                    <div class="flex-1">
                        <div class="flex items-center gap-1 mb-1">
                            <h4 id="userProfileName" class="text-xl font-bold"></h4>
                        </div>
                        <p id="userProfileUsername" class="text-gray-500 mb-3"></p>
                        <div class="flex gap-4">
                            <div class="text-center">
                                <div id="userFollowersCount" class="font-bold text-lg">0</div>
                                <div class="text-sm text-gray-500">Followers</div>
                            </div>
                            <div class="text-center">
                                <div id="userFollowingCount" class="font-bold text-lg">0</div>
                                <div class="text-sm text-gray-500">Following</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex gap-2 mb-6">
                    <button id="followBtn" class="flex-1 gradient-bg text-white py-3 rounded-lg font-semibold">
                        Follow
                    </button>
                    <button id="messageUserBtn" class="py-3 px-6 border border-gray-300 rounded-lg font-semibold">
                        Message
                    </button>
                </div>
                
                <!-- Tabs -->
                <div class="flex border-b border-gray-200 mb-4">
                    <button class="flex-1 py-3 text-center border-b-2 border-black font-semibold">
                        <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
                        </svg>
                    </button>
                    <button class="flex-1 py-3 text-center border-b-2 border-transparent text-gray-400">
                        <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4V2a1 1 0 011-1h8a1 1 0 011 1v2h4a1 1 0 110 2h-1v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6H3a1 1 0 110-2h4zM6 6v12h12V6H6zm3-2V3h6v1H9z"/>
                        </svg>
                    </button>
                    <button class="flex-1 py-3 text-center border-b-2 border-transparent text-gray-400">
                        <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                        </svg>
                    </button>
                    <button class="flex-1 py-3 text-center border-b-2 border-transparent text-gray-400">
                        <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                    </button>
                </div>
                
                <!-- Posts Grid -->
                <div id="userPostsGrid" class="grid grid-cols-3 gap-1">
                    <!-- Posts will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Comments Modal -->
    <div id="commentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end">
        <div class="bg-white w-full max-w-md mx-auto rounded-t-3xl p-4 max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Comments</h3>
                <button id="closeComments" class="p-2 min-w-[44px] min-h-[44px] flex items-center justify-center rounded-full hover:bg-gray-100 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div id="commentsList" class="space-y-3 mb-4">
                <!-- Comments will be loaded here -->
            </div>
            <div class="flex gap-2 relative">
                <div class="flex-1 relative">
                    <input type="text" id="commentInput" placeholder="Add a comment..." class="w-full p-3 border border-gray-300 rounded-full min-h-[44px]">
                    <div id="commentSuggestionDropdown" class="suggestions-dropdown hidden"></div>
                </div>
                <button id="postComment" class="gradient-bg text-white px-4 py-2 rounded-full min-h-[44px]">Post</button>
            </div>
        </div>
    </div>

    <!-- Settings Screen -->
    <div id="settingsScreen" class="hidden mobile-modal modal-enter">
        <div class="safe-top">
            <!-- Header -->
            <div class="flex justify-between items-center p-4 border-b border-gray-200 bg-white sticky top-0">
                <button id="backFromSettings" class="touch-target rounded-full hover:bg-gray-100 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </button>
                <h3 class="text-lg font-semibold">Settings</h3>
                <div class="w-12"></div>
            </div>
            
            <!-- Settings Options -->
            <div class="p-4 space-y-2">
                <button id="blockUnblockBtn" class="w-full text-left p-4 hover:bg-gray-100 rounded-lg flex items-center gap-4 touch-target">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L18.364 5.636M5.636 18.364l12.728-12.728"/>
                    </svg>
                    <span class="text-base">Block/Unblock Users</span>
                </button>
                <button id="addAccountBtn" class="w-full text-left p-4 hover:bg-gray-100 rounded-lg flex items-center gap-4 touch-target">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                    </svg>
                    <span class="text-base">Add Account</span>
                </button>
                <button id="privateAccountBtn" class="w-full text-left p-4 hover:bg-gray-100 rounded-lg flex items-center gap-4 touch-target">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                    </svg>
                    <span class="text-base">Private Account</span>
                </button>
                <button id="verificationBtn" class="w-full text-left p-4 hover:bg-gray-100 rounded-lg flex items-center gap-4 touch-target">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span class="text-base">Request Verification</span>
                </button>
                <button id="privacyBtn" class="w-full text-left p-4 hover:bg-gray-100 rounded-lg flex items-center gap-4 touch-target">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                    </svg>
                    <span class="text-base">Privacy Settings</span>
                </button>
                <button id="logoutBtn" class="w-full text-left p-4 hover:bg-red-100 rounded-lg flex items-center gap-4 text-red-600 touch-target">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                    </svg>
                    <span class="text-base">Logout</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Verification Modal -->
    <div id="verificationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold">Request Verification</h3>
                <button id="closeVerification" class="p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <form id="verificationForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Full Name (as on National ID)</label>
                    <input type="text" id="verifyFullName" class="w-full p-3 border border-gray-300 rounded-lg" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Why do you think you deserve verification?</label>
                    <textarea id="verifyReason" class="w-full p-3 border border-gray-300 rounded-lg" rows="3" required></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Other name you're famous by (Optional)</label>
                    <input type="text" id="verifyFamousName" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Country</label>
                    <select id="verifyCountry" class="w-full p-3 border border-gray-300 rounded-lg" required>
                        <option value="">Select Country</option>
                        <option value="US">United States</option>
                        <option value="IN">India</option>
                        <option value="UK">United Kingdom</option>
                        <option value="CA">Canada</option>
                        <option value="AU">Australia</option>
                        <option value="DE">Germany</option>
                        <option value="FR">France</option>
                        <option value="JP">Japan</option>
                        <option value="BR">Brazil</option>
                        <option value="MX">Mexico</option>
                    </select>
                </div>
                
                <div id="documentTypeDiv" class="hidden">
                    <label class="block text-sm font-medium mb-2">Document Type</label>
                    <select id="verifyDocumentType" class="w-full p-3 border border-gray-300 rounded-lg">
                        <option value="">Select Document</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Upload Document</label>
                    <input type="file" id="verifyDocument" accept="image/*" class="w-full p-3 border border-gray-300 rounded-lg" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Social Media Links (Optional - up to 5)</label>
                    <input type="url" id="socialLink1" placeholder="Instagram/Facebook/YouTube verified link" class="w-full p-3 border border-gray-300 rounded-lg mb-2">
                    <input type="url" id="socialLink2" placeholder="News article link" class="w-full p-3 border border-gray-300 rounded-lg mb-2">
                    <input type="url" id="socialLink3" placeholder="Additional link" class="w-full p-3 border border-gray-300 rounded-lg mb-2">
                    <input type="url" id="socialLink4" placeholder="Additional link" class="w-full p-3 border border-gray-300 rounded-lg mb-2">
                    <input type="url" id="socialLink5" placeholder="Additional link" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                
                <button type="submit" class="w-full gradient-bg text-white py-3 rounded-lg font-semibold">Submit Verification Request</button>
            </form>
        </div>
    </div>

    <!-- Messages Modal -->
    <div id="messagesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold">Messages</h3>
                <button id="closeMessages" class="p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div id="messagesList" class="space-y-3">
                <!-- Messages will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div id="chatModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-3">
                    <div id="chatUserAvatar" class="w-10 h-10 rounded-full"></div>
                    <h3 id="chatUserName" class="text-lg font-semibold"></h3>
                </div>
                <button id="closeChat" class="p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div id="chatMessages" class="space-y-3 mb-4 max-h-64 overflow-y-auto">
                <!-- Chat messages will be loaded here -->
            </div>
            <div class="flex gap-2">
                <input type="text" id="messageInput" placeholder="Type a message..." class="flex-1 p-3 border border-gray-300 rounded-full">
                <button id="sendMessage" class="gradient-bg text-white px-4 py-2 rounded-full">Send</button>
            </div>
        </div>
    </div>

    <!-- Hashtag Modal -->
    <div id="hashtagModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 id="hashtagTitle" class="text-xl font-semibold">#hashtag</h3>
                <button id="closeHashtag" class="p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="text-center mb-6">
                <div class="flex justify-center gap-6">
                    <div class="text-center">
                        <div id="hashtagPostCount" class="font-bold text-2xl">0</div>
                        <div class="text-sm text-gray-500">Posts</div>
                    </div>
                    <div class="text-center">
                        <div id="hashtagUserCount" class="font-bold text-2xl">0</div>
                        <div class="text-sm text-gray-500">Users</div>
                    </div>
                </div>
            </div>
            <div id="hashtagFeed" class="space-y-4">
                <!-- Hashtag posts will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Followers List Modal -->
    <div id="followersModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 id="followersTitle" class="text-xl font-semibold">Followers</h3>
                <button id="closeFollowers" class="p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div id="followersList" class="space-y-3">
                <!-- Followers will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Profile Screen -->
    <div id="profileScreen" class="hidden mobile-modal modal-enter">
        <div class="safe-top">
            <!-- Header -->
            <div class="flex justify-between items-center p-4 border-b border-gray-200 bg-white sticky top-0">
                <button id="backFromProfile" class="touch-target rounded-full hover:bg-gray-100 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </button>
                <h3 id="profileUsernameHeader" class="text-lg font-semibold"></h3>
                <button class="touch-target rounded-full hover:bg-gray-100 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>
                    </svg>
                </button>
            </div>
            
            <!-- Profile Info -->
            <div class="p-4">
                <div class="flex items-start gap-4 mb-4">
                    <div id="profileAvatar" class="w-20 h-20 rounded-full flex-shrink-0 cursor-pointer" onclick="editProfilePicture()"></div>
                    <div class="flex-1">
                        <div class="flex items-center gap-1 mb-1">
                            <h4 id="profileName" class="text-xl font-bold cursor-pointer" onclick="editName()"></h4>
                            <div id="profileVerifiedTick" class="verified-tick hidden"></div>
                        </div>
                        <p id="profileUsername" class="text-gray-500 mb-3"></p>
                        <div class="flex gap-4">
                            <div class="text-center cursor-pointer hover:bg-gray-100 p-2 rounded-lg" onclick="showFollowersList(currentUser.uid, 'followers')">
                                <div id="followersCount" class="font-bold text-lg">0</div>
                                <div class="text-sm text-gray-500">Followers</div>
                            </div>
                            <div class="text-center cursor-pointer hover:bg-gray-100 p-2 rounded-lg" onclick="showFollowersList(currentUser.uid, 'following')">
                                <div id="followingCount" class="font-bold text-lg">0</div>
                                <div class="text-sm text-gray-500">Following</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Bio Section -->
                <div class="mb-4">
                    <p id="profileBio" class="text-gray-800 cursor-pointer hidden" onclick="editBio()"></p>
                    <button id="addBioBtn" class="text-blue-500 text-sm cursor-pointer" onclick="editBio()">Add Bio</button>
                </div>
                
                <!-- Edit Profile Button -->
                <button class="w-full py-3 border border-gray-300 rounded-lg font-semibold mb-6">
                    Edit Profile
                </button>
                
                <!-- Tabs -->
                <div class="flex border-b border-gray-200 mb-4">
                    <button id="postsTab" class="flex-1 py-3 text-center border-b-2 border-black font-semibold">
                        <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
                        </svg>
                    </button>
                    <button id="reelsTab" class="flex-1 py-3 text-center border-b-2 border-transparent text-gray-400">
                        <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4V2a1 1 0 011-1h8a1 1 0 011 1v2h4a1 1 0 110 2h-1v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6H3a1 1 0 110-2h4zM6 6v12h12V6H6zm3-2V3h6v1H9z"/>
                        </svg>
                    </button>
                    <button id="savedTab" class="flex-1 py-3 text-center border-b-2 border-transparent text-gray-400">
                        <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                        </svg>
                    </button>
                    <button id="taggedTab" class="flex-1 py-3 text-center border-b-2 border-transparent text-gray-400">
                        <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                    </button>
                </div>
                
                <!-- Posts Grid -->
                <div id="postsGrid" class="grid grid-cols-3 gap-1">
                    <!-- Posts will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC30TcmMVhP_8HdFYS1WufRiZwSDYNMTF0",
            authDomain: "pulse2-92372.firebaseapp.com",
            databaseURL: "https://pulse2-92372-default-rtdb.firebaseio.com",
            projectId: "pulse2-92372",
            storageBucket: "pulse2-92372.firebasestorage.app",
            messagingSenderId: "276235725177",
            appId: "1:276235725177:web:0f4e0789fae80a435927a8"
        };

        // API Keys
        const SAFE_BROWSING_API_KEY = "AIzaSyC25CucKloJCXqbq-I0NuXi5aN3l-Nkc1Y";
        const YOUTUBE_API_KEY = "AIzaSyAvmam8BVo9PtXHY9-_F6x9SYidyvSZTxE";
        const LINK_PREVIEW_API_KEY = "3939f4f637fc345cc8e94113c98139b2";

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Global variables
        let currentUser = null;
        let currentBuzzId = null;
        let selectedImage = null;

        // API Integration Functions
        async function checkUrlSafety(url) {
            try {
                const response = await fetch(`https://safebrowsing.googleapis.com/v4/threatMatches:find?key=${SAFE_BROWSING_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        client: {
                            clientId: "pulse-social",
                            clientVersion: "1.0.0"
                        },
                        threatInfo: {
                            threatTypes: ["MALWARE", "SOCIAL_ENGINEERING", "UNWANTED_SOFTWARE", "POTENTIALLY_HARMFUL_APPLICATION"],
                            platformTypes: ["ANY_PLATFORM"],
                            threatEntryTypes: ["URL"],
                            threatEntries: [{"url": url}]
                        }
                    })
                });
                
                const data = await response.json();
                return !data.matches || data.matches.length === 0;
            } catch (error) {
                console.error('Safe browsing check failed:', error);
                return true; // Allow if check fails
            }
        }

        async function loadYouTubePreview(videoId) {
            try {
                const response = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics&id=${videoId}&key=${YOUTUBE_API_KEY}`);
                const data = await response.json();
                
                if (data.items && data.items.length > 0) {
                    const video = data.items[0];
                    const previewElement = document.getElementById(`youtube-${videoId}`);
                    
                    if (previewElement) {
                        previewElement.innerHTML = `
                            <div class="flex gap-3">
                                <img src="${video.snippet.thumbnails.medium.url}" class="w-24 h-18 rounded object-cover">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-sm line-clamp-2">${video.snippet.title}</h4>
                                    <p class="text-xs text-gray-500 mt-1">${video.snippet.channelTitle}</p>
                                    <p class="text-xs text-gray-500">${formatNumber(video.statistics.viewCount)} views</p>
                                </div>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('YouTube preview failed:', error);
            }
        }

        async function getLinkPreview(url) {
            try {
                const response = await fetch(`https://api.linkpreview.net/?key=${LINK_PREVIEW_API_KEY}&q=${encodeURIComponent(url)}`);
                const data = await response.json();
                
                if (data.title) {
                    return {
                        title: data.title,
                        description: data.description,
                        image: data.image,
                        url: data.url
                    };
                }
            } catch (error) {
                console.error('Link preview failed:', error);
            }
            return null;
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        function createLinkPreviewHtml(linkPreview) {
            return `
                <div class="border border-gray-200 rounded-lg overflow-hidden mb-3 hover:bg-gray-50 cursor-pointer" onclick="window.open('${linkPreview.url}', '_blank')">
                    ${linkPreview.image ? `<img src="${linkPreview.image}" class="w-full h-48 object-cover">` : ''}
                    <div class="p-3">
                        <h4 class="font-semibold text-sm line-clamp-2 mb-1">${linkPreview.title}</h4>
                        ${linkPreview.description ? `<p class="text-xs text-gray-600 line-clamp-2 mb-2">${linkPreview.description}</p>` : ''}
                        <p class="text-xs text-gray-500">${new URL(linkPreview.url).hostname}</p>
                    </div>
                </div>
            `;
        }

        // Custom notification system
        function showCustomNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `custom-notification ${type}`;
            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="flex-shrink-0">
                        ${type === 'success' ? 
                            '<svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>' :
                        type === 'error' ?
                            '<svg class="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>' :
                            '<svg class="w-5 h-5 text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>'
                        }
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="flex-shrink-0 text-gray-400 hover:text-gray-600">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Show notification
            setTimeout(() => notification.classList.add('show'), 100);
            
            // Auto remove after 4 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        // Utility functions
        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        }

        function generateAvatar(name, imageUrl = null) {
            if (imageUrl) {
                return `<img src="${imageUrl}" class="w-full h-full rounded-full object-cover">`;
            }
            return `<div class="w-full h-full rounded-full avatar-letter flex items-center justify-center text-white font-bold">${getInitials(name)}</div>`;
        }

        function timeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'now';
            if (minutes < 60) return `${minutes}m`;
            if (hours < 24) return `${hours}h`;
            return `${days}d`;
        }

        function processHashtagsAndMentions(text) {
            if (!text) return '';
            
            // Process URLs first
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            text = text.replace(urlRegex, '<a href="$1" target="_blank" class="text-blue-500 underline hover:text-blue-700">$1</a>');
            
            // Process YouTube URLs specially
            const youtubeRegex = /(https?:\/\/)?(www\.)?(youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)/g;
            text = text.replace(youtubeRegex, (match, protocol, www, domain, videoId) => {
                return `<div class="youtube-preview mt-2 p-3 border rounded-lg bg-gray-50" onclick="loadYouTubePreview('${videoId}')">
                    <div class="flex items-center gap-2">
                        <svg class="w-6 h-6 text-red-500" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                        </svg>
                        <span class="text-sm font-medium">YouTube Video</span>
                    </div>
                    <div id="youtube-${videoId}" class="mt-2 text-sm text-gray-600">Click to load preview</div>
                </div>`;
            });
            
            // Process hashtags with colorful styling
            text = text.replace(/#(\w+)/g, '<span class="hashtag" onclick="showHashtag(\'$1\')">#$1</span>');
            
            // Process mentions with colorful styling
            text = text.replace(/@(\w+)/g, '<span class="mention" onclick="showMentionProfile(\'$1\')">@$1</span>');
            
            return text;
        }

        function extractHashtags(text) {
            if (!text) return [];
            const hashtags = text.match(/#(\w+)/g);
            return hashtags ? hashtags.map(tag => tag.substring(1).toLowerCase()) : [];
        }

        function extractMentions(text) {
            if (!text) return [];
            const mentions = text.match(/@(\w+)/g);
            return mentions ? mentions.map(mention => mention.substring(1).toLowerCase()) : [];
        }

        function validateUsername(username) {
            const regex = /^[a-z0-9]+$/;
            return regex.test(username) && username.length >= 3;
        }

        // Image handling
        function convertToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Authentication
        document.getElementById('googleSignIn').addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).then((result) => {
                currentUser = result.user;
                checkUserSetup();
            }).catch((error) => {
                console.error('Sign in error:', error);
            });
        });

        function checkUserSetup() {
            database.ref(`users/${currentUser.uid}`).once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    if (userData.setupComplete) {
                        showMainApp();
                    } else {
                        startSetup();
                    }
                } else {
                    startSetup();
                }
            });
        }

        function startSetup() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('nameSetup').classList.remove('hidden');
        }

        // Setup flow
        document.getElementById('nameNext').addEventListener('click', () => {
            const name = document.getElementById('fullName').value.trim();
            if (name) {
                document.getElementById('nameSetup').classList.add('hidden');
                document.getElementById('usernameSetup').classList.remove('hidden');
            }
        });

        document.getElementById('usernameNext').addEventListener('click', async () => {
            const username = document.getElementById('username').value.trim().toLowerCase();
            const errorDiv = document.getElementById('usernameError');
            
            if (!validateUsername(username)) {
                errorDiv.textContent = 'Username must be at least 3 characters and contain only lowercase letters and numbers';
                errorDiv.classList.remove('hidden');
                return;
            }

            // Check if username exists
            const snapshot = await database.ref('usernames').child(username).once('value');
            if (snapshot.exists()) {
                errorDiv.textContent = 'Username already taken';
                errorDiv.classList.remove('hidden');
                return;
            }

            errorDiv.classList.add('hidden');
            document.getElementById('usernameSetup').classList.add('hidden');
            document.getElementById('dobSetup').classList.remove('hidden');
        });

        document.getElementById('dobNext').addEventListener('click', () => {
            document.getElementById('dobSetup').classList.add('hidden');
            setupProfilePic();
        });

        document.getElementById('dobSkip').addEventListener('click', () => {
            document.getElementById('dobSetup').classList.add('hidden');
            setupProfilePic();
        });

        function setupProfilePic() {
            const name = document.getElementById('fullName').value.trim();
            document.getElementById('previewAvatar').textContent = getInitials(name);
            document.getElementById('profilePicSetup').classList.remove('hidden');
        }

        document.getElementById('uploadPic').addEventListener('click', () => {
            document.getElementById('profilePicInput').click();
        });

        document.getElementById('profilePicInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                const base64 = await convertToBase64(file);
                selectedImage = base64;
                document.getElementById('previewAvatar').innerHTML = `<img src="${base64}" class="w-full h-full rounded-full object-cover">`;
            }
        });

        document.getElementById('picSkip').addEventListener('click', () => {
            completeSetup();
        });

        document.getElementById('previewAvatar').addEventListener('click', () => {
            completeSetup();
        });

        async function completeSetup() {
            const name = document.getElementById('fullName').value.trim();
            const username = document.getElementById('username').value.trim().toLowerCase();
            const dob = document.getElementById('dateOfBirth').value;

            const userData = {
                name: name,
                username: username,
                email: currentUser.email,
                dateOfBirth: dob || null,
                profilePicture: selectedImage || null,
                setupComplete: true,
                createdAt: Date.now(),
                followers: 0,
                following: 0
            };

            // Save user data
            await database.ref(`users/${currentUser.uid}`).set(userData);
            await database.ref(`usernames/${username}`).set(currentUser.uid);

            showMainApp();
        }

        function showMainApp() {
            document.getElementById('profilePicSetup').classList.add('hidden');
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            loadUserData();
            loadFeed();
            loadNotifications(); // Load notifications on app start
            loadSuggestionData(); // Load hashtags and users for suggestions
            migrateExistingData(); // Preserve and migrate existing data
        }

        // Data Migration and Preservation
        async function migrateExistingData() {
            try {
                console.log('Checking for existing data migration...');
                
                // Check if migration has already been done
                const migrationSnapshot = await database.ref('migrationComplete').once('value');
                if (migrationSnapshot.exists()) {
                    console.log('Data migration already completed');
                    return;
                }
                
                // Preserve existing users data
                const usersSnapshot = await database.ref('users').once('value');
                if (usersSnapshot.exists()) {
                    console.log('Preserving existing users data...');
                    const users = usersSnapshot.val();
                    
                    // Ensure all users have required fields
                    for (const [userId, userData] of Object.entries(users)) {
                        const updatedUserData = {
                            ...userData,
                            followers: userData.followers || 0,
                            following: userData.following || 0,
                            isVerified: userData.isVerified || false,
                            isPrivate: userData.isPrivate || false,
                            unreadNotifications: userData.unreadNotifications || 0
                        };
                        
                        await database.ref(`users/${userId}`).update(updatedUserData);
                    }
                }
                
                // Preserve existing buzzes
                const buzzesSnapshot = await database.ref('buzzes').once('value');
                if (buzzesSnapshot.exists()) {
                    console.log('Preserving existing buzzes data...');
                    const buzzes = buzzesSnapshot.val();
                    
                    for (const [buzzId, buzzData] of Object.entries(buzzes)) {
                        const updatedBuzzData = {
                            ...buzzData,
                            likes: buzzData.likes || 0,
                            comments: buzzData.comments || 0,
                            rebuzzes: buzzData.rebuzzes || 0,
                            saves: buzzData.saves || 0,
                            hashtags: buzzData.hashtags || [],
                            mentions: buzzData.mentions || []
                        };
                        
                        await database.ref(`buzzes/${buzzId}`).update(updatedBuzzData);
                    }
                }
                
                // Preserve existing follows
                const followsSnapshot = await database.ref('follows').once('value');
                if (followsSnapshot.exists()) {
                    console.log('Preserving existing follows data...');
                    // Data is already in correct format, no migration needed
                }
                
                // Preserve existing followers
                const followersSnapshot = await database.ref('followers').once('value');
                if (followersSnapshot.exists()) {
                    console.log('Preserving existing followers data...');
                    // Data is already in correct format, no migration needed
                }
                
                // Preserve existing likes
                const likesSnapshot = await database.ref('likes').once('value');
                if (likesSnapshot.exists()) {
                    console.log('Preserving existing likes data...');
                    // Data is already in correct format, no migration needed
                }
                
                // Preserve existing comments
                const commentsSnapshot = await database.ref('comments').once('value');
                if (commentsSnapshot.exists()) {
                    console.log('Preserving existing comments data...');
                    // Data is already in correct format, no migration needed
                }
                
                // Preserve existing notifications
                const notificationsSnapshot = await database.ref('notifications').once('value');
                if (notificationsSnapshot.exists()) {
                    console.log('Preserving existing notifications data...');
                    // Data is already in correct format, no migration needed
                }
                
                // Preserve existing messages
                const messagesSnapshot = await database.ref('messages').once('value');
                if (messagesSnapshot.exists()) {
                    console.log('Preserving existing messages data...');
                    // Data is already in correct format, no migration needed
                }
                
                // Preserve existing conversations
                const conversationsSnapshot = await database.ref('conversations').once('value');
                if (conversationsSnapshot.exists()) {
                    console.log('Preserving existing conversations data...');
                    // Data is already in correct format, no migration needed
                }
                
                // Mark migration as complete
                await database.ref('migrationComplete').set({
                    timestamp: Date.now(),
                    version: '2.0'
                });
                
                console.log('Data migration completed successfully!');
                showCustomNotification('Welcome back! All your data has been preserved.', 'success');
                
            } catch (error) {
                console.error('Data migration error:', error);
                showCustomNotification('Data migration completed with some warnings. Your data is safe.', 'warning');
            }
        }

        async function showUserProfileById(userId) {
            const userSnapshot = await database.ref(`users/${userId}`).once('value');
            if (userSnapshot.exists()) {
                const userData = userSnapshot.val();
                showUserProfile(userId, userData);
            }
        }

        async function loadUserData() {
            const snapshot = await database.ref(`users/${currentUser.uid}`).once('value');
            const userData = snapshot.val();
            
            const avatarElement = document.getElementById('userAvatar');
            if (userData.profilePicture) {
                avatarElement.innerHTML = `<img src="${userData.profilePicture}" class="w-full h-full rounded-full object-cover">`;
            } else {
                avatarElement.textContent = getInitials(userData.name);
            }
            
            // Check for auto-verification
            await checkAutoVerification(userData);
        }

        async function checkAutoVerification(userData) {
            // Auto-verify specific users
            const autoVerifyUsers = ['Anmol Sunda', 'Dozeta Group', 'Gursharn Arya'];
            const autoVerifyEmail = 'customerserviceffrj4@gmail.com';
            
            if (autoVerifyUsers.includes(userData.name) || userData.email === autoVerifyEmail) {
                if (!userData.isVerified) {
                    await database.ref(`users/${currentUser.uid}`).update({isVerified: true});
                    await createNotification(currentUser.uid, 'verification_approved', null, 'Pulse Team');
                }
            }
        }

        // Verification system
        document.getElementById('verificationBtn').addEventListener('click', () => {
            document.getElementById('verificationModal').classList.remove('hidden');
        });

        document.getElementById('closeVerification').addEventListener('click', () => {
            document.getElementById('verificationModal').classList.add('hidden');
        });

        document.getElementById('verifyCountry').addEventListener('change', (e) => {
            const country = e.target.value;
            const documentTypeDiv = document.getElementById('documentTypeDiv');
            const documentTypeSelect = document.getElementById('verifyDocumentType');
            
            if (country) {
                documentTypeDiv.classList.remove('hidden');
                documentTypeSelect.innerHTML = '<option value="">Select Document</option>';
                
                switch(country) {
                    case 'US':
                        documentTypeSelect.innerHTML += '<option value="passport">Passport</option><option value="driving_license">Driving License</option>';
                        break;
                    case 'IN':
                        documentTypeSelect.innerHTML += '<option value="pan_card">PAN Card</option><option value="voter_card">Voter Card</option><option value="national_id">National ID</option>';
                        break;
                    case 'UK':
                        documentTypeSelect.innerHTML += '<option value="passport">Passport</option><option value="driving_license">Driving License</option><option value="national_id">National ID</option>';
                        break;
                    case 'CA':
                        documentTypeSelect.innerHTML += '<option value="passport">Passport</option><option value="driving_license">Driving License</option><option value="health_card">Health Card</option>';
                        break;
                    default:
                        documentTypeSelect.innerHTML += '<option value="passport">Passport</option><option value="national_id">National ID</option>';
                }
            } else {
                documentTypeDiv.classList.add('hidden');
            }
        });

        document.getElementById('verificationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                userId: currentUser.uid,
                fullName: document.getElementById('verifyFullName').value,
                reason: document.getElementById('verifyReason').value,
                famousName: document.getElementById('verifyFamousName').value,
                country: document.getElementById('verifyCountry').value,
                documentType: document.getElementById('verifyDocumentType').value,
                socialLinks: [
                    document.getElementById('socialLink1').value,
                    document.getElementById('socialLink2').value,
                    document.getElementById('socialLink3').value,
                    document.getElementById('socialLink4').value,
                    document.getElementById('socialLink5').value
                ].filter(link => link.trim()),
                timestamp: Date.now(),
                status: 'pending'
            };
            
            // Handle document upload
            const documentFile = document.getElementById('verifyDocument').files[0];
            if (documentFile) {
                formData.document = await convertToBase64(documentFile);
            }
            
            await database.ref('verificationRequests').push(formData);
            
            showCustomNotification('Verification request submitted successfully! We will review it and get back to you.', 'success');
            document.getElementById('verificationModal').classList.add('hidden');
            document.getElementById('verificationForm').reset();
        });

        // Messaging system
        function loadMessages() {
            database.ref('conversations').orderByChild(`participants/${currentUser.uid}`).equalTo(true).on('value', (snapshot) => {
                const conversations = [];
                snapshot.forEach((child) => {
                    conversations.push({id: child.key, ...child.val()});
                });
                renderMessagesList(conversations);
            });
        }

        function renderMessagesList(conversations) {
            const messagesList = document.getElementById('messagesList');
            messagesList.innerHTML = '';
            
            if (conversations.length === 0) {
                messagesList.innerHTML = '<div class="text-center py-8 text-gray-500">No messages yet</div>';
                return;
            }
            
            conversations.forEach(conversation => {
                const otherUserId = Object.keys(conversation.participants).find(id => id !== currentUser.uid);
                
                database.ref(`users/${otherUserId}`).once('value', (userSnapshot) => {
                    const otherUser = userSnapshot.val();
                    
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-3 p-3 bg-white rounded-lg pulse-shadow cursor-pointer hover:bg-gray-50 transition-colors';
                    
                    div.innerHTML = `
                        <div class="w-12 h-12 rounded-full flex-shrink-0">
                            ${generateAvatar(otherUser.name, otherUser.profilePicture)}
                        </div>
                        <div class="flex-1">
                            <h4 class="font-semibold">${otherUser.name}</h4>
                            <p class="text-gray-500 text-sm">${conversation.lastMessage || 'Start a conversation'}</p>
                        </div>
                        <div class="text-xs text-gray-400">
                            ${conversation.lastMessageTime ? timeAgo(conversation.lastMessageTime) : ''}
                        </div>
                    `;
                    
                    div.addEventListener('click', () => {
                        openChat(otherUserId, otherUser);
                    });
                    
                    messagesList.appendChild(div);
                });
            });
        }

        function openChat(userId, userData) {
            document.getElementById('messagesModal').classList.add('hidden');
            document.getElementById('chatModal').classList.remove('hidden');
            
            document.getElementById('chatUserAvatar').innerHTML = generateAvatar(userData.name, userData.profilePicture);
            document.getElementById('chatUserName').textContent = userData.name;
            
            loadChatMessages(userId);
        }

        function loadChatMessages(otherUserId) {
            const conversationId = [currentUser.uid, otherUserId].sort().join('_');
            
            database.ref(`messages/${conversationId}`).orderByChild('timestamp').on('value', (snapshot) => {
                const messages = [];
                snapshot.forEach((child) => {
                    messages.push({id: child.key, ...child.val()});
                });
                renderChatMessages(messages);
            });
        }

        function renderChatMessages(messages) {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            messages.forEach(message => {
                const div = document.createElement('div');
                div.className = `flex ${message.senderId === currentUser.uid ? 'justify-end' : 'justify-start'} mb-3`;
                
                div.innerHTML = `
                    <div class="message-bubble p-3 rounded-lg ${message.senderId === currentUser.uid ? 'message-sent' : 'message-received'}">
                        <p class="text-sm">${message.text}</p>
                        <p class="text-xs opacity-70 mt-1">${timeAgo(message.timestamp)}</p>
                    </div>
                `;
                
                chatMessages.appendChild(div);
            });
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        document.getElementById('sendMessage').addEventListener('click', sendMessage);
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        async function sendMessage() {
            const messageText = document.getElementById('messageInput').value.trim();
            if (!messageText) return;
            
            const otherUserId = document.getElementById('chatUserName').textContent;
            const conversationId = [currentUser.uid, otherUserId].sort().join('_');
            
            const messageData = {
                senderId: currentUser.uid,
                text: messageText,
                timestamp: Date.now()
            };
            
            await database.ref(`messages/${conversationId}`).push(messageData);
            
            // Update conversation
            const conversationData = {
                participants: {
                    [currentUser.uid]: true,
                    [otherUserId]: true
                },
                lastMessage: messageText,
                lastMessageTime: Date.now()
            };
            
            await database.ref(`conversations/${conversationId}`).set(conversationData);
            
            document.getElementById('messageInput').value = '';
        }

        document.getElementById('closeMessages').addEventListener('click', () => {
            document.getElementById('messagesModal').classList.add('hidden');
        });

        document.getElementById('closeChat').addEventListener('click', () => {
            document.getElementById('chatModal').classList.add('hidden');
        });

        // Suggestion system
        let allHashtags = new Set();
        let allUsers = [];
        let currentSuggestionType = null;
        let currentSuggestionStart = 0;
        
        // Load hashtags and users for suggestions
        async function loadSuggestionData() {
            // Load existing hashtags
            const hashtagsSnapshot = await database.ref('hashtags').once('value');
            hashtagsSnapshot.forEach((child) => {
                allHashtags.add(child.key);
            });
            
            // Load all users
            const usersSnapshot = await database.ref('users').once('value');
            allUsers = [];
            usersSnapshot.forEach((child) => {
                const user = child.val();
                if (user.setupComplete && child.key !== currentUser.uid) {
                    allUsers.push({
                        id: child.key,
                        username: user.username,
                        name: user.name,
                        profilePicture: user.profilePicture
                    });
                }
            });
        }
        
        function showSuggestions(inputElement, dropdownElement, query, type) {
            const suggestions = [];
            
            if (type === 'hashtag') {
                // Filter hashtags
                const filteredHashtags = Array.from(allHashtags).filter(hashtag => 
                    hashtag.toLowerCase().includes(query.toLowerCase())
                ).slice(0, 5);
                
                filteredHashtags.forEach(hashtag => {
                    suggestions.push({
                        type: 'hashtag',
                        value: hashtag,
                        display: `#${hashtag}`
                    });
                });
            } else if (type === 'mention') {
                // Filter users
                const filteredUsers = allUsers.filter(user => 
                    user.username.toLowerCase().includes(query.toLowerCase()) ||
                    user.name.toLowerCase().includes(query.toLowerCase())
                ).slice(0, 5);
                
                filteredUsers.forEach(user => {
                    suggestions.push({
                        type: 'mention',
                        value: user.username,
                        display: `@${user.username}`,
                        name: user.name,
                        avatar: user.profilePicture
                    });
                });
            }
            
            renderSuggestions(dropdownElement, suggestions, inputElement);
        }
        
        function renderSuggestions(dropdownElement, suggestions, inputElement) {
            dropdownElement.innerHTML = '';
            
            if (suggestions.length === 0) {
                dropdownElement.classList.add('hidden');
                return;
            }
            
            suggestions.forEach(suggestion => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                
                if (suggestion.type === 'hashtag') {
                    div.innerHTML = `
                        <div class="hashtag-suggestion">
                            <div class="hashtag-icon">#</div>
                            <span>${suggestion.value}</span>
                        </div>
                    `;
                } else if (suggestion.type === 'mention') {
                    div.innerHTML = `
                        <div class="mention-suggestion">
                            <div class="mention-avatar">
                                ${generateAvatar(suggestion.name, suggestion.avatar)}
                            </div>
                            <div>
                                <div class="font-semibold text-sm">${suggestion.name}</div>
                                <div class="text-gray-500 text-xs">@${suggestion.value}</div>
                            </div>
                        </div>
                    `;
                }
                
                div.addEventListener('click', () => {
                    insertSuggestion(inputElement, suggestion);
                    dropdownElement.classList.add('hidden');
                });
                
                dropdownElement.appendChild(div);
            });
            
            dropdownElement.classList.remove('hidden');
        }
        
        function insertSuggestion(inputElement, suggestion) {
            const text = inputElement.value;
            const cursorPos = inputElement.selectionStart;
            
            // Find the start of the current word
            let start = cursorPos - 1;
            while (start >= 0 && text[start] !== ' ' && text[start] !== '\n') {
                start--;
            }
            start++;
            
            // Find the trigger character
            let triggerPos = start;
            while (triggerPos < cursorPos && text[triggerPos] !== '#' && text[triggerPos] !== '@') {
                triggerPos++;
            }
            
            if (triggerPos < cursorPos) {
                const beforeTrigger = text.substring(0, triggerPos);
                const afterCursor = text.substring(cursorPos);
                const newText = beforeTrigger + suggestion.display + ' ' + afterCursor;
                
                inputElement.value = newText;
                const newCursorPos = triggerPos + suggestion.display.length + 1;
                inputElement.setSelectionRange(newCursorPos, newCursorPos);
                inputElement.focus();
            }
        }
        
        function handleInputSuggestions(inputElement, dropdownElement) {
            const text = inputElement.value;
            const cursorPos = inputElement.selectionStart;
            
            // Find current word
            let start = cursorPos - 1;
            while (start >= 0 && text[start] !== ' ' && text[start] !== '\n') {
                start--;
            }
            start++;
            
            const currentWord = text.substring(start, cursorPos);
            
            if (currentWord.startsWith('#') && currentWord.length > 1) {
                const query = currentWord.substring(1);
                showSuggestions(inputElement, dropdownElement, query, 'hashtag');
            } else if (currentWord.startsWith('@') && currentWord.length > 1) {
                const query = currentWord.substring(1);
                showSuggestions(inputElement, dropdownElement, query, 'mention');
            } else {
                dropdownElement.classList.add('hidden');
            }
        }

        // Buzz creation
        document.getElementById('buzzText').addEventListener('input', (e) => {
            const postBtn = document.getElementById('postBuzz');
            postBtn.disabled = e.target.value.trim().length === 0 && !selectedImage;
            
            // Handle suggestions
            handleInputSuggestions(e.target, document.getElementById('suggestionDropdown'));
        });
        
        document.getElementById('buzzText').addEventListener('keydown', (e) => {
            const dropdown = document.getElementById('suggestionDropdown');
            if (e.key === 'Escape') {
                dropdown.classList.add('hidden');
            }
        });
        
        // Comment input suggestions
        document.getElementById('commentInput').addEventListener('input', (e) => {
            handleInputSuggestions(e.target, document.getElementById('commentSuggestionDropdown'));
        });
        
        document.getElementById('commentInput').addEventListener('keydown', (e) => {
            const dropdown = document.getElementById('commentSuggestionDropdown');
            if (e.key === 'Escape') {
                dropdown.classList.add('hidden');
            }
        });

        document.getElementById('addImage').addEventListener('click', () => {
            document.getElementById('buzzImageInput').click();
        });

        document.getElementById('buzzImageInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                const base64 = await convertToBase64(file);
                selectedImage = base64;
                document.getElementById('previewImg').src = base64;
                document.getElementById('imagePreview').classList.remove('hidden');
                document.getElementById('postBuzz').disabled = false;
            }
        });

        document.getElementById('removeImage').addEventListener('click', () => {
            selectedImage = null;
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('buzzImageInput').value = '';
            const postBtn = document.getElementById('postBuzz');
            postBtn.disabled = document.getElementById('buzzText').value.trim().length === 0;
        });

        document.getElementById('postBuzz').addEventListener('click', async () => {
            const text = document.getElementById('buzzText').value.trim();
            if (!text && !selectedImage) return;

            // Check for URLs and validate safety
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const urls = text.match(urlRegex);
            
            if (urls) {
                showCustomNotification('Checking links for safety...', 'warning');
                for (const url of urls) {
                    const isSafe = await checkUrlSafety(url);
                    if (!isSafe) {
                        showCustomNotification('Unsafe link detected! Please remove malicious URLs.', 'error');
                        return;
                    }
                }
            }

            const userData = await database.ref(`users/${currentUser.uid}`).once('value');
            const user = userData.val();

            // Extract hashtags and mentions
            const hashtags = extractHashtags(text);
            const mentions = extractMentions(text);

            // Get link preview for first URL (if any)
            let linkPreview = null;
            if (urls && urls.length > 0) {
                // Skip YouTube URLs as they have special handling
                const nonYouTubeUrls = urls.filter(url => !url.match(/(youtube\.com\/watch\?v=|youtu\.be\/)/));
                if (nonYouTubeUrls.length > 0) {
                    linkPreview = await getLinkPreview(nonYouTubeUrls[0]);
                }
            }

            const buzzData = {
                userId: currentUser.uid,
                userName: user.name,
                username: user.username,
                userAvatar: user.profilePicture || null,
                isVerified: user.isVerified || false,
                text: text || '',
                image: selectedImage || null,
                linkPreview: linkPreview,
                hashtags: hashtags,
                mentions: mentions,
                timestamp: Date.now(),
                likes: 0,
                comments: 0,
                rebuzzes: 0,
                saves: 0
            };

            const buzzRef = await database.ref('buzzes').push(buzzData);
            const buzzId = buzzRef.key;

            // Store hashtags for search
            for (const hashtag of hashtags) {
                await database.ref(`hashtags/${hashtag}/${buzzId}`).set({
                    userId: currentUser.uid,
                    timestamp: Date.now()
                });
            }

            // Create notifications for mentions
            for (const mentionUsername of mentions) {
                const userSnapshot = await database.ref('usernames').child(mentionUsername).once('value');
                if (userSnapshot.exists()) {
                    const mentionedUserId = userSnapshot.val();
                    if (mentionedUserId !== currentUser.uid) {
                        await createNotification(mentionedUserId, 'mention', buzzId, user.name);
                    }
                }
            }
            
            // Reset form
            document.getElementById('buzzText').value = '';
            selectedImage = null;
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('postBuzz').disabled = true;
            
            showCustomNotification('Buzz posted successfully!', 'success');
            loadFeed();
        });

        // Feed loading
        function loadFeed() {
            database.ref('buzzes').orderByChild('timestamp').limitToLast(20).on('value', (snapshot) => {
                const buzzes = [];
                snapshot.forEach((child) => {
                    buzzes.unshift({id: child.key, ...child.val()});
                });
                renderFeed(buzzes);
            });
        }

        function renderFeed(buzzes) {
            const feed = document.getElementById('feed');
            feed.innerHTML = '';

            buzzes.forEach(buzz => {
                const buzzElement = createBuzzElement(buzz);
                feed.appendChild(buzzElement);
            });
        }

        function createBuzzElement(buzz) {
            const div = document.createElement('div');
            div.className = 'buzz-card rounded-2xl p-4 pulse-shadow';
            
            let quotedBuzzHtml = '';
            if (buzz.isQuote && buzz.quotedBuzz) {
                quotedBuzzHtml = `
                    <div class="mt-3 p-3 border border-gray-200 rounded-lg bg-gray-50">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-6 h-6 rounded-full flex-shrink-0">
                                ${generateAvatar(buzz.quotedBuzz.userName, buzz.quotedBuzz.userAvatar)}
                            </div>
                            <span class="font-semibold text-sm">${buzz.quotedBuzz.userName}</span>
                            <span class="text-gray-500 text-xs">@${buzz.quotedBuzz.username}</span>
                        </div>
                        ${buzz.quotedBuzz.text ? `<p class="text-sm mb-2">${processHashtagsAndMentions(buzz.quotedBuzz.text)}</p>` : ''}
                        ${buzz.quotedBuzz.image ? `<img src="${buzz.quotedBuzz.image}" class="w-full rounded-lg max-h-48 object-cover">` : ''}
                    </div>
                `;
            }
            
            div.innerHTML = `
                <div class="flex gap-3">
                    <div class="w-12 h-12 rounded-full flex-shrink-0">
                        ${generateAvatar(buzz.userName, buzz.userAvatar)}
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="flex items-center">
                                <span class="font-semibold cursor-pointer hover:underline" onclick="showUserProfileById('${buzz.userId}')">${buzz.userName}</span>
                                ${buzz.isVerified ? '<div class="verified-tick ml-1"></div>' : ''}
                            </div>
                            <span class="text-gray-500 text-sm cursor-pointer hover:underline" onclick="showUserProfileById('${buzz.userId}')">@${buzz.username}</span>
                            <span class="text-gray-500 text-sm">·</span>
                            <span class="text-gray-500 text-sm">${timeAgo(buzz.timestamp)}</span>
                            ${buzz.isQuote ? '<span class="text-blue-500 text-xs bg-blue-100 px-2 py-1 rounded-full">Quote</span>' : ''}
                            <button class="ml-auto p-1 hover:bg-gray-100 rounded-full min-w-[44px] min-h-[44px] flex items-center justify-center" onclick="showBuzzMenu('${buzz.id}')">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                                </svg>
                            </button>
                        </div>
                        ${buzz.text ? `<p class="mb-3">${processHashtagsAndMentions(buzz.text)}</p>` : ''}
                        ${buzz.image ? `<img src="${buzz.image}" class="w-full rounded-lg mb-3 max-h-96 object-cover">` : ''}
                        ${buzz.linkPreview ? createLinkPreviewHtml(buzz.linkPreview) : ''}
                        ${quotedBuzzHtml}
                        <div class="flex items-center justify-between text-gray-500">
                            <button class="flex items-center gap-2 hover:text-red-500 transition-colors p-2 rounded-full hover:bg-red-50 min-w-[44px] min-h-[44px]" onclick="toggleLike('${buzz.id}')">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                                </svg>
                                <span>${buzz.likes || 0}</span>
                            </button>
                            <button class="flex items-center gap-2 hover:text-blue-500 transition-colors p-2 rounded-full hover:bg-blue-50 min-w-[44px] min-h-[44px]" onclick="showComments('${buzz.id}')">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                </svg>
                                <span>${buzz.comments || 0}</span>
                            </button>
                            <button class="flex items-center gap-2 hover:text-green-500 transition-colors p-2 rounded-full hover:bg-green-50 min-w-[44px] min-h-[44px]" onclick="rebuzz('${buzz.id}')">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                </svg>
                                <span>${buzz.rebuzzes || 0}</span>
                            </button>
                            <button class="flex items-center gap-2 hover:text-purple-500 transition-colors p-2 rounded-full hover:bg-purple-50 min-w-[44px] min-h-[44px]" onclick="toggleSave('${buzz.id}')">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                                </svg>
                            </button>
                            <button class="flex items-center gap-2 hover:text-gray-700 transition-colors p-2 rounded-full hover:bg-gray-50 min-w-[44px] min-h-[44px]" onclick="shareBuzz('${buzz.id}')">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            return div;
        }

        // Buzz interactions
        async function toggleLike(buzzId) {
            try {
                const likeRef = database.ref(`likes/${buzzId}/${currentUser.uid}`);
                const buzzRef = database.ref(`buzzes/${buzzId}`);
                
                const likeSnapshot = await likeRef.once('value');
                const buzzSnapshot = await buzzRef.once('value');
                const buzz = buzzSnapshot.val();
                
                if (likeSnapshot.exists()) {
                    // Unlike
                    await likeRef.remove();
                    await buzzRef.update({likes: Math.max(0, (buzz.likes || 1) - 1)});
                } else {
                    // Like
                    await likeRef.set(true);
                    await buzzRef.update({likes: (buzz.likes || 0) + 1});
                    
                    // Create notification
                    if (buzz.userId !== currentUser.uid) {
                        const currentUserData = await database.ref(`users/${currentUser.uid}`).once('value');
                        await createNotification(buzz.userId, 'like', buzzId, currentUserData.val().name);
                    }
                }
            } catch (error) {
                console.error('Error toggling like:', error);
            }
        }

        function showComments(buzzId) {
            currentBuzzId = buzzId;
            document.getElementById('commentModal').classList.remove('hidden');
            loadComments(buzzId);
        }

        function loadComments(buzzId) {
            database.ref(`comments/${buzzId}`).on('value', (snapshot) => {
                const comments = [];
                snapshot.forEach((child) => {
                    comments.push({id: child.key, ...child.val()});
                });
                renderComments(comments);
            });
        }

        function renderComments(comments) {
            const commentsList = document.getElementById('commentsList');
            commentsList.innerHTML = '';
            
            comments.forEach(comment => {
                const div = document.createElement('div');
                div.className = 'flex gap-3 p-3 bg-gray-50 rounded-lg';
                div.innerHTML = `
                    <div class="w-8 h-8 rounded-full flex-shrink-0">
                        ${generateAvatar(comment.userName, comment.userAvatar)}
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-semibold text-sm">${comment.userName}</span>
                            <span class="text-gray-500 text-xs">${timeAgo(comment.timestamp)}</span>
                        </div>
                        <p class="text-sm">${processHashtagsAndMentions(comment.text)}</p>
                    </div>
                `;
                commentsList.appendChild(div);
            });
        }

        document.getElementById('closeComments').addEventListener('click', () => {
            document.getElementById('commentModal').classList.add('hidden');
        });

        document.getElementById('postComment').addEventListener('click', async () => {
            const text = document.getElementById('commentInput').value.trim();
            if (!text || !currentBuzzId) return;

            const userData = await database.ref(`users/${currentUser.uid}`).once('value');
            const user = userData.val();

            // Extract mentions from comment
            const mentions = extractMentions(text);

            const commentData = {
                userId: currentUser.uid,
                userName: user.name,
                userAvatar: user.profilePicture,
                text: text,
                mentions: mentions,
                timestamp: Date.now()
            };

            await database.ref(`comments/${currentBuzzId}`).push(commentData);
            
            // Update comment count
            const buzzSnapshot = await database.ref(`buzzes/${currentBuzzId}`).once('value');
            const buzz = buzzSnapshot.val();
            await database.ref(`buzzes/${currentBuzzId}`).update({
                comments: (buzz.comments || 0) + 1
            });

            // Create notification for buzz owner
            if (buzz.userId !== currentUser.uid) {
                await createNotification(buzz.userId, 'comment', currentBuzzId, user.name);
            }

            // Create notifications for mentions in comment
            for (const mentionUsername of mentions) {
                const userSnapshot = await database.ref('usernames').child(mentionUsername).once('value');
                if (userSnapshot.exists()) {
                    const mentionedUserId = userSnapshot.val();
                    if (mentionedUserId !== currentUser.uid) {
                        await createNotification(mentionedUserId, 'mention', currentBuzzId, user.name);
                    }
                }
            }

            document.getElementById('commentInput').value = '';
            
            // Refresh feed to show updated comment count
            loadFeed();
        });

        async function rebuzz(buzzId) {
            // Show rebuzz options
            const choice = confirm('Choose rebuzz type:\nOK = Simple Rebuzz\nCancel = Quote Rebuzz');
            
            if (choice === null) return; // User cancelled
            
            try {
                const buzzSnapshot = await database.ref(`buzzes/${buzzId}`).once('value');
                const originalBuzz = buzzSnapshot.val();
                
                if (choice) {
                    // Simple rebuzz
                    const rebuzzRef = database.ref(`rebuzzes/${currentUser.uid}/${buzzId}`);
                    const rebuzzSnapshot = await rebuzzRef.once('value');
                    
                    if (rebuzzSnapshot.exists()) {
                        // Un-rebuzz
                        await rebuzzRef.remove();
                        await database.ref(`buzzes/${buzzId}`).update({rebuzzes: Math.max(0, (originalBuzz.rebuzzes || 1) - 1)});
                    } else {
                        // Rebuzz
                        await rebuzzRef.set(true);
                        await database.ref(`buzzes/${buzzId}`).update({rebuzzes: (originalBuzz.rebuzzes || 0) + 1});
                        
                        // Create notification
                        if (originalBuzz.userId !== currentUser.uid) {
                            const currentUserData = await database.ref(`users/${currentUser.uid}`).once('value');
                            await createNotification(originalBuzz.userId, 'rebuzz', buzzId, currentUserData.val().name);
                        }
                    }
                } else {
                    // Quote rebuzz
                    const quoteText = prompt('Add your comment:');
                    if (quoteText !== null) {
                        const userData = await database.ref(`users/${currentUser.uid}`).once('value');
                        const user = userData.val();
                        
                        const quoteBuzzData = {
                            userId: currentUser.uid,
                            userName: user.name,
                            username: user.username,
                            userAvatar: user.profilePicture || null,
                            text: quoteText,
                            quotedBuzz: originalBuzz,
                            quotedBuzzId: buzzId,
                            timestamp: Date.now(),
                            likes: 0,
                            comments: 0,
                            rebuzzes: 0,
                            saves: 0,
                            isQuote: true
                        };
                        
                        await database.ref('buzzes').push(quoteBuzzData);
                        
                        // Create notification
                        if (originalBuzz.userId !== currentUser.uid) {
                            const currentUserData = await database.ref(`users/${currentUser.uid}`).once('value');
                            await createNotification(originalBuzz.userId, 'quote', buzzId, currentUserData.val().name);
                        }
                    }
                }
                
                loadFeed();
            } catch (error) {
                console.error('Error rebuzzing:', error);
            }
        }

        async function toggleSave(buzzId) {
            const saveRef = database.ref(`saves/${currentUser.uid}/${buzzId}`);
            const saveSnapshot = await saveRef.once('value');
            
            if (saveSnapshot.exists()) {
                await saveRef.remove();
                showCustomNotification('Buzz removed from saved!', 'success');
            } else {
                await saveRef.set(true);
                showCustomNotification('Buzz saved successfully!', 'success');
                
                // Create notification
                const buzzSnapshot = await database.ref(`buzzes/${buzzId}`).once('value');
                const buzz = buzzSnapshot.val();
                const currentUserData = await database.ref(`users/${currentUser.uid}`).once('value');
                await createNotification(buzz.userId, 'save', buzzId, currentUserData.val().name);
            }
        }

        function shareBuzz(buzzId) {
            if (navigator.share) {
                navigator.share({
                    title: 'Check out this Buzz on Pulse',
                    url: `${window.location.origin}?buzz=${buzzId}`
                }).catch(() => {
                    // Fallback if share fails
                    navigator.clipboard.writeText(`${window.location.origin}?buzz=${buzzId}`);
                    showCustomNotification('Link copied to clipboard!', 'success');
                });
            } else {
                // Fallback - copy to clipboard
                navigator.clipboard.writeText(`${window.location.origin}?buzz=${buzzId}`);
                showCustomNotification('Link copied to clipboard!', 'success');
            }
        }

        async function showBuzzMenu(buzzId) {
            const buzzSnapshot = await database.ref(`buzzes/${buzzId}`).once('value');
            const buzz = buzzSnapshot.val();
            
            let options = '';
            if (buzz.userId === currentUser.uid) {
                options = 'Choose an option:\n1. Delete Buzz\n2. Copy Link';
            } else {
                options = 'Choose an option:\n1. Report\n2. Block User\n3. Copy Link';
            }
            
            const choice = prompt(options);
            
            if (buzz.userId === currentUser.uid) {
                switch(choice) {
                    case '1':
                        if (confirm('Are you sure you want to delete this buzz?')) {
                            await deleteBuzz(buzzId);
                        }
                        break;
                    case '2':
                        navigator.clipboard.writeText(`${window.location.origin}?buzz=${buzzId}`);
                        showCustomNotification('Link copied to clipboard!', 'success');
                        break;
                }
            } else {
                switch(choice) {
                    case '1':
                        showCustomNotification('Buzz reported. Thank you for keeping Pulse safe!', 'success');
                        break;
                    case '2':
                        showCustomNotification('User blocked successfully.', 'success');
                        break;
                    case '3':
                        navigator.clipboard.writeText(`${window.location.origin}?buzz=${buzzId}`);
                        showCustomNotification('Link copied to clipboard!', 'success');
                        break;
                }
            }
        }

        async function deleteBuzz(buzzId) {
            try {
                // Delete the buzz
                await database.ref(`buzzes/${buzzId}`).remove();
                
                // Delete associated data
                await database.ref(`likes/${buzzId}`).remove();
                await database.ref(`comments/${buzzId}`).remove();
                
                // Remove from rebuzzes
                const rebuzzesSnapshot = await database.ref('rebuzzes').once('value');
                rebuzzesSnapshot.forEach((userRebuzzes) => {
                    if (userRebuzzes.child(buzzId).exists()) {
                        database.ref(`rebuzzes/${userRebuzzes.key}/${buzzId}`).remove();
                    }
                });
                
                // Remove from saves
                const savesSnapshot = await database.ref('saves').once('value');
                savesSnapshot.forEach((userSaves) => {
                    if (userSaves.child(buzzId).exists()) {
                        database.ref(`saves/${userSaves.key}/${buzzId}`).remove();
                    }
                });
                
                showCustomNotification('Buzz deleted successfully!', 'success');
                loadFeed();
            } catch (error) {
                console.error('Error deleting buzz:', error);
                showCustomNotification('Error deleting buzz. Please try again.', 'error');
            }
        }

        // Disable copy, right-click, and keyboard shortcuts
        document.addEventListener('contextmenu', (e) => e.preventDefault());
        document.addEventListener('keydown', (e) => {
            // Disable F12, Ctrl+Shift+I, Ctrl+U, Ctrl+S, Ctrl+A, Ctrl+C, Ctrl+V
            if (e.key === 'F12' || 
                (e.ctrlKey && (e.shiftKey && e.key === 'I')) ||
                (e.ctrlKey && e.key === 'u') ||
                (e.ctrlKey && e.key === 's') ||
                (e.ctrlKey && e.key === 'a') ||
                (e.ctrlKey && e.key === 'c') ||
                (e.ctrlKey && e.key === 'v')) {
                e.preventDefault();
            }
        });

        // Close suggestions when clicking outside
        document.addEventListener('click', (e) => {
            const suggestionDropdown = document.getElementById('suggestionDropdown');
            const commentSuggestionDropdown = document.getElementById('commentSuggestionDropdown');
            const buzzText = document.getElementById('buzzText');
            const commentInput = document.getElementById('commentInput');
            
            if (!buzzText.contains(e.target) && !suggestionDropdown.contains(e.target)) {
                suggestionDropdown.classList.add('hidden');
            }
            
            if (!commentInput.contains(e.target) && !commentSuggestionDropdown.contains(e.target)) {
                commentSuggestionDropdown.classList.add('hidden');
            }
        });

        // Check authentication state
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                checkUserSetup();
            } else {
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }
        });

        // Hashtag and mention functions
        async function showHashtag(hashtag) {
            document.getElementById('hashtagTitle').textContent = `#${hashtag}`;
            document.getElementById('hashtagModal').classList.remove('hidden');
            
            // Load hashtag data
            const hashtagSnapshot = await database.ref(`hashtags/${hashtag.toLowerCase()}`).once('value');
            const hashtagData = hashtagSnapshot.val() || {};
            
            const buzzIds = Object.keys(hashtagData);
            const uniqueUsers = new Set();
            const buzzes = [];
            
            for (const buzzId of buzzIds) {
                const buzzSnapshot = await database.ref(`buzzes/${buzzId}`).once('value');
                if (buzzSnapshot.exists()) {
                    const buzz = buzzSnapshot.val();
                    buzzes.push({id: buzzId, ...buzz});
                    uniqueUsers.add(buzz.userId);
                }
            }
            
            // Sort by timestamp
            buzzes.sort((a, b) => b.timestamp - a.timestamp);
            
            document.getElementById('hashtagPostCount').textContent = buzzes.length;
            document.getElementById('hashtagUserCount').textContent = uniqueUsers.size;
            
            // Render hashtag feed
            const hashtagFeed = document.getElementById('hashtagFeed');
            hashtagFeed.innerHTML = '';
            
            if (buzzes.length === 0) {
                hashtagFeed.innerHTML = '<div class="text-center py-8 text-gray-500">No posts found for this hashtag</div>';
            } else {
                buzzes.forEach(buzz => {
                    const buzzElement = createBuzzElement(buzz);
                    hashtagFeed.appendChild(buzzElement);
                });
            }
        }

        async function showMentionProfile(username) {
            const userSnapshot = await database.ref('usernames').child(username.toLowerCase()).once('value');
            if (userSnapshot.exists()) {
                const userId = userSnapshot.val();
                const userDataSnapshot = await database.ref(`users/${userId}`).once('value');
                if (userDataSnapshot.exists()) {
                    const userData = userDataSnapshot.val();
                    showUserProfile(userId, userData);
                }
            } else {
                showCustomNotification('User not found', 'error');
            }
        }

        document.getElementById('closeHashtag').addEventListener('click', () => {
            document.getElementById('hashtagModal').classList.add('hidden');
        });

        // Notification system
        async function createNotification(targetUserId, type, buzzId, actorName) {
            if (targetUserId === currentUser.uid) return; // Don't notify yourself
            
            const notificationData = {
                targetUserId: targetUserId,
                actorId: currentUser.uid,
                actorName: actorName,
                type: type, // 'like', 'comment', 'rebuzz', 'save'
                buzzId: buzzId,
                timestamp: Date.now(),
                read: false
            };
            
            await database.ref('notifications').push(notificationData);
            
            // Update notification count
            const notifSnapshot = await database.ref('notifications').orderByChild('targetUserId').equalTo(targetUserId).once('value');
            let unreadCount = 0;
            notifSnapshot.forEach((child) => {
                if (!child.val().read) unreadCount++;
            });
            
            // Update notification badge for target user (if they're online)
            await database.ref(`users/${targetUserId}/unreadNotifications`).set(unreadCount);
        }

        function loadNotifications() {
            database.ref('notifications').orderByChild('targetUserId').equalTo(currentUser.uid).on('value', (snapshot) => {
                const notifications = [];
                snapshot.forEach((child) => {
                    notifications.unshift({id: child.key, ...child.val()});
                });
                renderNotifications(notifications);
                
                // Update notification count
                const unreadCount = notifications.filter(n => !n.read).length;
                const notificationDot = document.getElementById('notificationDot');
                const notificationCount = document.getElementById('notificationCount');
                
                if (unreadCount > 0) {
                    notificationDot.classList.remove('hidden');
                    notificationCount.textContent = unreadCount > 99 ? '99+' : unreadCount;
                } else {
                    notificationDot.classList.add('hidden');
                }
            });
        }

        function renderNotifications(notifications) {
            const notificationsList = document.getElementById('notificationsList');
            notificationsList.innerHTML = '';
            
            if (notifications.length === 0) {
                notificationsList.innerHTML = '<div class="text-center py-8 text-gray-500">No notifications yet</div>';
                return;
            }
            
            notifications.forEach(notification => {
                const div = document.createElement('div');
                div.className = `p-3 rounded-lg cursor-pointer hover:bg-gray-50 ${!notification.read ? 'bg-blue-50' : 'bg-white'}`;
                
                let message = '';
                switch(notification.type) {
                    case 'like':
                        message = `${notification.actorName} liked your buzz`;
                        break;
                    case 'comment':
                        message = `${notification.actorName} commented on your buzz`;
                        break;
                    case 'rebuzz':
                        message = `${notification.actorName} rebuzzed your post`;
                        break;
                    case 'save':
                        message = `${notification.actorName} saved your buzz`;
                        break;
                    case 'verification_approved':
                        message = `🎉 Congratulations! Your account has been verified!`;
                        break;
                    case 'follow':
                        message = `${notification.actorName} started following you`;
                        break;
                    case 'quote':
                        message = `${notification.actorName} quoted your buzz`;
                        break;
                    case 'mention':
                        message = `${notification.actorName} mentioned you in a buzz`;
                        break;
                }
                
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-2 rounded-full ${!notification.read ? 'bg-blue-500' : 'bg-transparent'}"></div>
                        <div class="flex-1">
                            <p class="text-sm">${message}</p>
                            <p class="text-xs text-gray-500">${timeAgo(notification.timestamp)}</p>
                        </div>
                    </div>
                `;
                
                div.addEventListener('click', async () => {
                    // Mark as read
                    if (!notification.read) {
                        await database.ref(`notifications/${notification.id}`).update({read: true});
                    }
                    // Close modal and show the buzz
                    document.getElementById('notificationModal').classList.add('hidden');
                    // You could implement navigation to specific buzz here
                });
                
                notificationsList.appendChild(div);
            });
        }

        // Search functionality
        function searchUsers(query) {
            database.ref('users').once('value', (snapshot) => {
                const users = [];
                snapshot.forEach((child) => {
                    const user = child.val();
                    if (user.setupComplete && child.key !== currentUser.uid) {
                        if (!query.trim() || 
                            user.name.toLowerCase().includes(query.toLowerCase()) || 
                            user.username.toLowerCase().includes(query.toLowerCase())) {
                            users.push({id: child.key, ...user});
                        }
                    }
                });
                renderSearchResults(users);
            });
        }

        function renderSearchResults(users) {
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = '';
            
            if (users.length === 0) {
                searchResults.innerHTML = '<div class="text-center py-8 text-gray-500">No users found</div>';
                return;
            }
            
            users.forEach(user => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-3 p-3 bg-white rounded-lg pulse-shadow cursor-pointer hover:bg-gray-50 transition-colors';
                
                div.innerHTML = `
                    <div class="w-12 h-12 rounded-full flex-shrink-0">
                        ${generateAvatar(user.name, user.profilePicture)}
                    </div>
                    <div class="flex-1">
                        <h4 class="font-semibold">${user.name}</h4>
                        <p class="text-gray-500 text-sm">@${user.username}</p>
                    </div>
                `;
                
                div.addEventListener('click', () => {
                    showUserProfile(user.id, user);
                });
                
                searchResults.appendChild(div);
            });
        }

        function showUserProfile(userId, userData) {
            hideAllScreens();
            document.getElementById('userProfileAvatar').innerHTML = generateAvatar(userData.name, userData.profilePicture);
            
            // Update header username
            document.getElementById('userProfileUsernameHeader').textContent = userData.username;
            
            // Add verified tick to name if verified
            const nameElement = document.getElementById('userProfileName');
            nameElement.innerHTML = userData.name + (userData.isVerified ? '<div class="verified-tick ml-1 inline-block"></div>' : '');
            
            document.getElementById('userProfileUsername').textContent = `@${userData.username}`;
            document.getElementById('userFollowersCount').textContent = (userData.followers && typeof userData.followers === 'number') ? userData.followers : 0;
            document.getElementById('userFollowingCount').textContent = (userData.following && typeof userData.following === 'number') ? userData.following : 0;
            
            const followBtn = document.getElementById('followBtn');
            const messageBtn = document.getElementById('messageUserBtn');
            const actionButtonsDiv = followBtn.parentElement;
            
            // Check if viewing own profile
            if (userId === currentUser.uid) {
                // Show edit button for own profile
                actionButtonsDiv.innerHTML = `
                    <button id="editProfileBtn" class="flex-1 gradient-bg text-white py-3 rounded-lg font-semibold">
                        Edit Profile
                    </button>
                `;
                document.getElementById('editProfileBtn').onclick = () => {
                    showProfile();
                };
            } else {
                // Show follow and message buttons for other users
                actionButtonsDiv.innerHTML = `
                    <button id="followBtn" class="flex-1 gradient-bg text-white py-3 rounded-lg font-semibold">
                        Follow
                    </button>
                    <button id="messageUserBtn" class="py-3 px-6 border border-gray-300 rounded-lg font-semibold">
                        Message
                    </button>
                `;
                
                // Check if already following
                database.ref(`follows/${currentUser.uid}/${userId}`).once('value', (snapshot) => {
                    const newFollowBtn = document.getElementById('followBtn');
                    if (snapshot.exists()) {
                        newFollowBtn.textContent = 'Unfollow';
                        newFollowBtn.className = 'flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold';
                    } else {
                        newFollowBtn.textContent = 'Follow';
                        newFollowBtn.className = 'flex-1 gradient-bg text-white py-3 rounded-lg font-semibold';
                    }
                    
                    newFollowBtn.onclick = () => toggleFollow(userId, userData);
                });
                
                // Message button handler
                document.getElementById('messageUserBtn').onclick = () => {
                    showCustomNotification('Messages feature coming soon!', 'warning');
                };
            }
            
            // Add click handlers for followers/following counts
            document.getElementById('userFollowersCount').parentElement.onclick = () => showFollowersList(userId, 'followers');
            document.getElementById('userFollowingCount').parentElement.onclick = () => showFollowersList(userId, 'following');
            
            // Load user posts grid
            loadUserPostsGridForProfile(userId);
            
            document.getElementById('userProfileScreen').classList.remove('hidden');
        }

        // Load posts grid for user profile
        async function loadUserPostsGridForProfile(userId) {
            const postsGrid = document.getElementById('userPostsGrid');
            postsGrid.innerHTML = '<div class="col-span-3 text-center py-8 text-gray-500">Loading posts...</div>';
            
            try {
                const buzzesSnapshot = await database.ref('buzzes').orderByChild('userId').equalTo(userId).once('value');
                const posts = [];
                
                buzzesSnapshot.forEach((child) => {
                    const buzz = child.val();
                    if (buzz.image) { // Only show posts with images in grid
                        posts.unshift({id: child.key, ...buzz});
                    }
                });
                
                if (posts.length === 0) {
                    postsGrid.innerHTML = `
                        <div class="col-span-3 text-center py-12">
                            <div class="w-16 h-16 mx-auto mb-4 border-2 border-gray-300 rounded-full flex items-center justify-center">
                                <svg class="w-8 h-8 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                            </div>
                            <h3 class="text-xl font-semibold mb-2">No Posts Yet</h3>
                            <p class="text-gray-500">No photos shared yet.</p>
                        </div>
                    `;
                    return;
                }
                
                postsGrid.innerHTML = '';
                posts.forEach(post => {
                    const div = document.createElement('div');
                    div.className = 'aspect-square bg-gray-100 rounded cursor-pointer hover:opacity-75 transition-opacity';
                    div.innerHTML = `<img src="${post.image}" class="w-full h-full object-cover rounded">`;
                    div.addEventListener('click', () => {
                        showPostDetail(post);
                    });
                    postsGrid.appendChild(div);
                });
                
            } catch (error) {
                console.error('Error loading posts grid:', error);
                postsGrid.innerHTML = '<div class="col-span-3 text-center py-8 text-red-500">Error loading posts</div>';
            }
        }

        async function toggleFollow(userId, userData) {
            try {
                const followRef = database.ref(`follows/${currentUser.uid}/${userId}`);
                const followSnapshot = await followRef.once('value');
                
                const userRef = database.ref(`users/${userId}`);
                const currentUserRef = database.ref(`users/${currentUser.uid}`);
                
                if (followSnapshot.exists()) {
                    // Unfollow
                    await followRef.remove();
                    await database.ref(`followers/${userId}/${currentUser.uid}`).remove();
                    
                    // Update counts
                    const userSnapshot = await userRef.once('value');
                    const currentUserSnapshot = await currentUserRef.once('value');
                    const user = userSnapshot.val();
                    const currentUser_data = currentUserSnapshot.val();
                    
                    const newFollowerCount = Math.max(0, (user.followers || 1) - 1);
                    const newFollowingCount = Math.max(0, (currentUser_data.following || 1) - 1);
                    
                    await userRef.update({followers: newFollowerCount});
                    await currentUserRef.update({following: newFollowingCount});
                    
                    // Update UI
                    document.getElementById('followBtn').textContent = 'Follow';
                    document.getElementById('followBtn').className = 'mt-4 gradient-bg text-white px-6 py-2 rounded-full font-semibold min-h-[44px]';
                    document.getElementById('userFollowersCount').textContent = newFollowerCount;
                } else {
                    // Follow
                    await followRef.set(true);
                    await database.ref(`followers/${userId}/${currentUser.uid}`).set(true);
                    
                    // Update counts
                    const userSnapshot = await userRef.once('value');
                    const currentUserSnapshot = await currentUserRef.once('value');
                    const user = userSnapshot.val();
                    const currentUser_data = currentUserSnapshot.val();
                    
                    const newFollowerCount = (user.followers || 0) + 1;
                    const newFollowingCount = (currentUser_data.following || 0) + 1;
                    
                    await userRef.update({followers: newFollowerCount});
                    await currentUserRef.update({following: newFollowingCount});
                    
                    // Update UI
                    document.getElementById('followBtn').textContent = 'Unfollow';
                    document.getElementById('followBtn').className = 'mt-4 bg-gray-200 text-gray-700 px-6 py-2 rounded-full font-semibold min-h-[44px]';
                    document.getElementById('userFollowersCount').textContent = newFollowerCount;
                    
                    // Create notification
                    if (userId !== currentUser.uid) {
                        const currentUserData = await database.ref(`users/${currentUser.uid}`).once('value');
                        await createNotification(userId, 'follow', null, currentUserData.val().name);
                    }
                }
            } catch (error) {
                console.error('Error toggling follow:', error);
            }
        }

        // Screen management functions
        function hideAllScreens() {
            document.getElementById('feed').parentElement.classList.add('hidden');
            document.getElementById('searchScreen').classList.add('hidden');
            document.getElementById('notificationScreen').classList.add('hidden');
            document.getElementById('userProfileScreen').classList.add('hidden');
            document.getElementById('profileScreen').classList.add('hidden');
            document.getElementById('settingsScreen').classList.add('hidden');
        }

        function showHomeScreen() {
            hideAllScreens();
            document.getElementById('feed').parentElement.classList.remove('hidden');
            loadFeed();
        }

        // Navigation handlers
        document.getElementById('notificationBtn').addEventListener('click', () => {
            hideAllScreens();
            document.getElementById('notificationScreen').classList.remove('hidden');
            loadNotifications();
        });

        document.getElementById('backFromNotifications').addEventListener('click', () => {
            showHomeScreen();
        });

        document.getElementById('backFromUserProfile').addEventListener('click', () => {
            showHomeScreen();
        });

        document.getElementById('backFromProfile').addEventListener('click', () => {
            showHomeScreen();
        });

        document.getElementById('backFromSettings').addEventListener('click', () => {
            showHomeScreen();
        });

        document.getElementById('messageBtn').addEventListener('click', () => {
            // For now, show notification that messages are coming soon
            showCustomNotification('Messages feature coming soon!', 'warning');
        });

        document.getElementById('settingsBtn').addEventListener('click', () => {
            hideAllScreens();
            document.getElementById('settingsScreen').classList.remove('hidden');
        });

        document.getElementById('profileBtn').addEventListener('click', () => {
            showProfile();
        });

        document.getElementById('homeBtn').addEventListener('click', () => {
            showHomeScreen();
        });

        document.getElementById('searchBtn').addEventListener('click', () => {
            hideAllScreens();
            document.getElementById('searchScreen').classList.remove('hidden');
            document.getElementById('searchInput').focus();
            // Load all users initially
            searchUsers('');
        });

        document.getElementById('searchInput').addEventListener('input', (e) => {
            searchUsers(e.target.value);
        });

        // Settings screen handlers
        document.getElementById('closeSettings').addEventListener('click', () => {
            document.getElementById('settingsScreen').classList.add('hidden');
            document.getElementById('feed').parentElement.classList.remove('hidden');
        });

        document.getElementById('closeProfile').addEventListener('click', () => {
            document.getElementById('profileScreen').classList.add('hidden');
            document.getElementById('feed').parentElement.classList.remove('hidden');
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            auth.signOut();
            document.getElementById('settingsScreen').classList.add('hidden');
        });

        document.getElementById('blockUnblockBtn').addEventListener('click', () => {
            showCustomNotification('Block/Unblock feature coming soon!', 'warning');
        });

        document.getElementById('addAccountBtn').addEventListener('click', () => {
            showCustomNotification('Add Account feature coming soon!', 'warning');
        });

        document.getElementById('privateAccountBtn').addEventListener('click', async () => {
            const userRef = database.ref(`users/${currentUser.uid}`);
            const snapshot = await userRef.once('value');
            const userData = snapshot.val();
            
            await userRef.update({
                isPrivate: !userData.isPrivate
            });
            
            showCustomNotification(userData.isPrivate ? 'Account is now public' : 'Account is now private', 'success');
        });

        document.getElementById('privacyBtn').addEventListener('click', () => {
            showCustomNotification('Privacy Settings feature coming soon!', 'warning');
        });

        // Profile modal handlers
        document.getElementById('closeProfile').addEventListener('click', () => {
            document.getElementById('profileModal').classList.add('hidden');
        });

        document.getElementById('closeFollowers').addEventListener('click', () => {
            document.getElementById('followersModal').classList.add('hidden');
        });

        // Followers list functionality
        async function showFollowersList(userId, type) {
            document.getElementById('followersTitle').textContent = type === 'followers' ? 'Followers' : 'Following';
            document.getElementById('followersModal').classList.remove('hidden');
            
            const followersList = document.getElementById('followersList');
            followersList.innerHTML = '<div class="text-center py-4 text-gray-500">Loading...</div>';
            
            try {
                let userIds = [];
                
                if (type === 'followers') {
                    const followersSnapshot = await database.ref(`followers/${userId}`).once('value');
                    if (followersSnapshot.exists()) {
                        userIds = Object.keys(followersSnapshot.val());
                    }
                } else {
                    const followingSnapshot = await database.ref(`follows/${userId}`).once('value');
                    if (followingSnapshot.exists()) {
                        userIds = Object.keys(followingSnapshot.val());
                    }
                }
                
                if (userIds.length === 0) {
                    followersList.innerHTML = `<div class="text-center py-8 text-gray-500">No ${type} yet</div>`;
                    return;
                }
                
                followersList.innerHTML = '';
                
                for (const uid of userIds) {
                    const userSnapshot = await database.ref(`users/${uid}`).once('value');
                    if (userSnapshot.exists()) {
                        const userData = userSnapshot.val();
                        
                        const div = document.createElement('div');
                        div.className = 'flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors';
                        
                        div.innerHTML = `
                            <div class="w-12 h-12 rounded-full flex-shrink-0">
                                ${generateAvatar(userData.name, userData.profilePicture)}
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center gap-1">
                                    <h4 class="font-semibold">${userData.name}</h4>
                                    ${userData.isVerified ? '<div class="verified-tick"></div>' : ''}
                                </div>
                                <p class="text-gray-500 text-sm">@${userData.username}</p>
                            </div>
                        `;
                        
                        div.addEventListener('click', () => {
                            document.getElementById('followersModal').classList.add('hidden');
                            showUserProfile(uid, userData);
                        });
                        
                        followersList.appendChild(div);
                    }
                }
            } catch (error) {
                console.error('Error loading followers:', error);
                followersList.innerHTML = '<div class="text-center py-8 text-red-500">Error loading data</div>';
            }
        }

        async function showProfile() {
            hideAllScreens();
            const userData = await database.ref(`users/${currentUser.uid}`).once('value');
            const user = userData.val();
            
            // Update header username
            document.getElementById('profileUsernameHeader').textContent = user.username;
            
            // Update profile info
            const profileAvatar = document.getElementById('profileAvatar');
            if (user.profilePicture) {
                profileAvatar.innerHTML = `<img src="${user.profilePicture}" class="w-full h-full rounded-full object-cover">`;
            } else {
                profileAvatar.className = 'w-20 h-20 rounded-full cursor-pointer avatar-letter flex items-center justify-center text-white font-bold text-2xl';
                profileAvatar.textContent = getInitials(user.name);
            }
            
            document.getElementById('profileName').textContent = user.name;
            document.getElementById('profileUsername').textContent = `@${user.username}`;
            document.getElementById('followersCount').textContent = (user.followers && typeof user.followers === 'number') ? user.followers : 0;
            document.getElementById('followingCount').textContent = (user.following && typeof user.following === 'number') ? user.following : 0;
            
            // Show verified tick if user is verified
            const verifiedTick = document.getElementById('profileVerifiedTick');
            if (user.isVerified) {
                verifiedTick.classList.remove('hidden');
            } else {
                verifiedTick.classList.add('hidden');
            }
            
            // Show bio if exists
            const bioElement = document.getElementById('profileBio');
            const addBioBtn = document.getElementById('addBioBtn');
            if (user.bio && user.bio.trim()) {
                bioElement.textContent = user.bio;
                bioElement.classList.remove('hidden');
                addBioBtn.classList.add('hidden');
            } else {
                bioElement.classList.add('hidden');
                addBioBtn.classList.remove('hidden');
            }
            
            // Load user posts grid
            loadUserPostsGrid();
            
            document.getElementById('profileScreen').classList.remove('hidden');
        }

        async function loadUserStats() {
            // Count user's buzzes
            const buzzesSnapshot = await database.ref('buzzes').orderByChild('userId').equalTo(currentUser.uid).once('value');
            let buzzCount = 0;
            let mediaCount = 0;
            buzzesSnapshot.forEach(() => {
                buzzCount++;
                // Count media posts
            });
            
            // Count rebuzzes
            const rebuzzesSnapshot = await database.ref('rebuzzes').child(currentUser.uid).once('value');
            let rebuzzCount = 0;
            rebuzzesSnapshot.forEach(() => rebuzzCount++);
            
            // Count likes
            const likesSnapshot = await database.ref('likes').once('value');
            let likedCount = 0;
            likesSnapshot.forEach((buzzLikes) => {
                if (buzzLikes.child(currentUser.uid).exists()) {
                    likedCount++;
                }
            });
            
            document.getElementById('myBuzzesCount').textContent = buzzCount;
            document.getElementById('rebuzzesCount').textContent = rebuzzCount;
            document.getElementById('mediaCount').textContent = mediaCount;
            document.getElementById('likedCount').textContent = likedCount;
        }

        // Load user posts in Instagram-style grid
        async function loadUserPostsGrid() {
            const postsGrid = document.getElementById('postsGrid');
            postsGrid.innerHTML = '<div class="col-span-3 text-center py-8 text-gray-500">Loading posts...</div>';
            
            try {
                const buzzesSnapshot = await database.ref('buzzes').orderByChild('userId').equalTo(currentUser.uid).once('value');
                const posts = [];
                
                buzzesSnapshot.forEach((child) => {
                    const buzz = child.val();
                    if (buzz.image) { // Only show posts with images in grid
                        posts.unshift({id: child.key, ...buzz});
                    }
                });
                
                if (posts.length === 0) {
                    postsGrid.innerHTML = `
                        <div class="col-span-3 text-center py-12">
                            <div class="w-16 h-16 mx-auto mb-4 border-2 border-gray-300 rounded-full flex items-center justify-center">
                                <svg class="w-8 h-8 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                            </div>
                            <h3 class="text-xl font-semibold mb-2">No Posts Yet</h3>
                            <p class="text-gray-500">When you share photos, they'll appear on your profile.</p>
                        </div>
                    `;
                    return;
                }
                
                postsGrid.innerHTML = '';
                posts.forEach(post => {
                    const div = document.createElement('div');
                    div.className = 'aspect-square bg-gray-100 rounded cursor-pointer hover:opacity-75 transition-opacity';
                    div.innerHTML = `<img src="${post.image}" class="w-full h-full object-cover rounded">`;
                    div.addEventListener('click', () => {
                        // Show post details - could implement a post detail view
                        showPostDetail(post);
                    });
                    postsGrid.appendChild(div);
                });
                
            } catch (error) {
                console.error('Error loading posts grid:', error);
                postsGrid.innerHTML = '<div class="col-span-3 text-center py-8 text-red-500">Error loading posts</div>';
            }
        }

        function showPostDetail(post) {
            // For now, just show the post in feed format
            hideAllScreens();
            const feed = document.getElementById('feed');
            feed.innerHTML = '';
            const postElement = createBuzzElement(post);
            feed.appendChild(postElement);
            document.getElementById('feed').parentElement.classList.remove('hidden');
        }

        // Profile tab handlers
        document.getElementById('postsTab').addEventListener('click', () => {
            // Switch to posts view
            document.getElementById('postsTab').className = 'flex-1 py-3 text-center border-b-2 border-black font-semibold';
            document.getElementById('reelsTab').className = 'flex-1 py-3 text-center border-b-2 border-transparent text-gray-400';
            document.getElementById('savedTab').className = 'flex-1 py-3 text-center border-b-2 border-transparent text-gray-400';
            document.getElementById('taggedTab').className = 'flex-1 py-3 text-center border-b-2 border-transparent text-gray-400';
            loadUserPostsGrid();
        });

        document.getElementById('reelsTab').addEventListener('click', () => {
            // Switch to reels view (placeholder)
            document.getElementById('postsTab').className = 'flex-1 py-3 text-center border-b-2 border-transparent text-gray-400';
            document.getElementById('reelsTab').className = 'flex-1 py-3 text-center border-b-2 border-black font-semibold';
            document.getElementById('savedTab').className = 'flex-1 py-3 text-center border-b-2 border-transparent text-gray-400';
            document.getElementById('taggedTab').className = 'flex-1 py-3 text-center border-b-2 border-transparent text-gray-400';
            document.getElementById('postsGrid').innerHTML = '<div class="col-span-3 text-center py-12 text-gray-500">Reels coming soon!</div>';
        });

        document.getElementById('savedTab').addEventListener('click', () => {
            // Switch to saved view
            document.getElementById('postsTab').className = 'flex-1 py-3 text-center border-b-2 border-transparent text-gray-400';
            document.getElementById('reelsTab').className = 'flex-1 py-3 text-center border-b-2 border-transparent text-gray-400';
            document.getElementById('savedTab').className = 'flex-1 py-3 text-center border-b-2 border-black font-semibold';
            document.getElementById('taggedTab').className = 'flex-1 py-3 text-center border-b-2 border-transparent text-gray-400';
            loadSavedPosts();
        });

        document.getElementById('taggedTab').addEventListener('click', () => {
            // Switch to tagged view
            document.getElementById('postsTab').className = 'flex-1 py-3 text-center border-b-2 border-transparent text-gray-400';
            document.getElementById('reelsTab').className = 'flex-1 py-3 text-center border-b-2 border-transparent text-gray-400';
            document.getElementById('savedTab').className = 'flex-1 py-3 text-center border-b-2 border-transparent text-gray-400';
            document.getElementById('taggedTab').className = 'flex-1 py-3 text-center border-b-2 border-black font-semibold';
            document.getElementById('postsGrid').innerHTML = '<div class="col-span-3 text-center py-12 text-gray-500">Tagged posts coming soon!</div>';
        });

        async function loadSavedPosts() {
            const postsGrid = document.getElementById('postsGrid');
            postsGrid.innerHTML = '<div class="col-span-3 text-center py-8 text-gray-500">Loading saved posts...</div>';
            
            try {
                const savesSnapshot = await database.ref(`saves/${currentUser.uid}`).once('value');
                const savedPosts = [];
                
                if (savesSnapshot.exists()) {
                    for (const buzzId of Object.keys(savesSnapshot.val())) {
                        const buzzSnapshot = await database.ref(`buzzes/${buzzId}`).once('value');
                        if (buzzSnapshot.exists()) {
                            const buzz = buzzSnapshot.val();
                            if (buzz.image) {
                                savedPosts.push({id: buzzId, ...buzz});
                            }
                        }
                    }
                }
                
                if (savedPosts.length === 0) {
                    postsGrid.innerHTML = `
                        <div class="col-span-3 text-center py-12">
                            <div class="w-16 h-16 mx-auto mb-4 border-2 border-gray-300 rounded-full flex items-center justify-center">
                                <svg class="w-8 h-8 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                                </svg>
                            </div>
                            <h3 class="text-xl font-semibold mb-2">No Saved Posts</h3>
                            <p class="text-gray-500">Save posts to see them here.</p>
                        </div>
                    `;
                    return;
                }
                
                postsGrid.innerHTML = '';
                savedPosts.forEach(post => {
                    const div = document.createElement('div');
                    div.className = 'aspect-square bg-gray-100 rounded cursor-pointer hover:opacity-75 transition-opacity';
                    div.innerHTML = `<img src="${post.image}" class="w-full h-full object-cover rounded">`;
                    div.addEventListener('click', () => showPostDetail(post));
                    postsGrid.appendChild(div);
                });
                
            } catch (error) {
                console.error('Error loading saved posts:', error);
                postsGrid.innerHTML = '<div class="col-span-3 text-center py-8 text-red-500">Error loading saved posts</div>';
            }
        }

        async function showUserBuzzes(type) {
            const feed = document.getElementById('feed');
            feed.innerHTML = '<div class="text-center py-8 text-gray-500">Loading...</div>';
            
            let buzzes = [];
            
            switch(type) {
                case 'myBuzzes':
                    const myBuzzesSnapshot = await database.ref('buzzes').orderByChild('userId').equalTo(currentUser.uid).once('value');
                    myBuzzesSnapshot.forEach((child) => {
                        buzzes.unshift({id: child.key, ...child.val()});
                    });
                    break;
                    
                case 'rebuzzes':
                    const rebuzzesSnapshot = await database.ref('rebuzzes').child(currentUser.uid).once('value');
                    for (let buzzId of Object.keys(rebuzzesSnapshot.val() || {})) {
                        const buzzSnapshot = await database.ref(`buzzes/${buzzId}`).once('value');
                        if (buzzSnapshot.exists()) {
                            buzzes.push({id: buzzId, ...buzzSnapshot.val(), isRebuzz: true});
                        }
                    }
                    break;
                    
                case 'media':
                    const mediaBuzzesSnapshot = await database.ref('buzzes').orderByChild('userId').equalTo(currentUser.uid).once('value');
                    mediaBuzzesSnapshot.forEach((child) => {
                        const buzz = child.val();
                        if (buzz.image) {
                            buzzes.unshift({id: child.key, ...buzz});
                        }
                    });
                    break;
                    
                case 'liked':
                    const likesSnapshot = await database.ref('likes').once('value');
                    for (let [buzzId, likes] of Object.entries(likesSnapshot.val() || {})) {
                        if (likes[currentUser.uid]) {
                            const buzzSnapshot = await database.ref(`buzzes/${buzzId}`).once('value');
                            if (buzzSnapshot.exists()) {
                                buzzes.push({id: buzzId, ...buzzSnapshot.val()});
                            }
                        }
                    }
                    break;
            }
            
            document.getElementById('profileModal').classList.add('hidden');
            
            if (buzzes.length === 0) {
                feed.innerHTML = '<div class="text-center py-8 text-gray-500">No buzzes found</div>';
            } else {
                renderFeed(buzzes);
            }
        }

        // Profile editing functions
        async function editName() {
            const userData = await database.ref(`users/${currentUser.uid}`).once('value');
            const user = userData.val();
            
            const newName = prompt('Enter new name:', user.name);
            if (newName && newName.trim() && newName.trim() !== user.name) {
                await database.ref(`users/${currentUser.uid}`).update({name: newName.trim()});
                document.getElementById('profileName').textContent = newName.trim();
                loadUserData(); // Refresh avatar in main app
                showCustomNotification('Name updated successfully!', 'success');
            }
        }

        async function editBio() {
            const userData = await database.ref(`users/${currentUser.uid}`).once('value');
            const user = userData.val();
            
            const newBio = prompt('Enter your bio:', user.bio || '');
            if (newBio !== null) {
                await database.ref(`users/${currentUser.uid}`).update({bio: newBio.trim()});
                
                const bioElement = document.getElementById('profileBio');
                const addBioBtn = document.getElementById('addBioBtn');
                
                if (newBio.trim()) {
                    bioElement.textContent = newBio.trim();
                    bioElement.classList.remove('hidden');
                    addBioBtn.classList.add('hidden');
                } else {
                    bioElement.classList.add('hidden');
                    addBioBtn.classList.remove('hidden');
                }
                
                showCustomNotification('Bio updated successfully!', 'success');
            }
        }

        async function editProfilePicture() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const base64 = await convertToBase64(file);
                    await database.ref(`users/${currentUser.uid}`).update({profilePicture: base64});
                    
                    // Update profile modal
                    document.getElementById('profileAvatar').innerHTML = `<img src="${base64}" class="w-full h-full rounded-full object-cover">`;
                    
                    // Update main app avatar
                    loadUserData();
                    
                    showCustomNotification('Profile picture updated successfully!', 'success');
                }
            };
            
            input.click();
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97936c02918b47ec',t:'MTc1Njg4MzM2OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
