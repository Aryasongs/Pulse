<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="light-content">
  <meta name="apple-mobile-web-app-title" content="DCloud">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#007AFF">
  <title>DCloud - Premium Cloud Storage</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
        body {
            box-sizing: border-box;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ebee 100%);
            color: #1d1d1f;
            min-height: 100%;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .premium-button {
            background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 24px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(0, 122, 255, 0.3);
            min-height: 48px;
            touch-action: manipulation;
        }

        .premium-button:hover, .premium-button:active {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0, 122, 255, 0.4);
        }

        .floating-add {
            position: fixed;
            bottom: calc(32px + env(safe-area-inset-bottom));
            right: calc(32px + env(safe-area-inset-right));
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 8px 32px rgba(0, 122, 255, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        .floating-add:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 40px rgba(0, 122, 255, 0.5);
        }

        .sidebar {
            width: 280px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(0, 0, 0, 0.1);
            padding: 24px;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 100;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .sidebar-item:hover {
            background: rgba(0, 122, 255, 0.1);
        }

        .sidebar-item.active {
            background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
            color: white;
        }

        .main-content {
            margin-left: 280px;
            padding: 32px;
            min-height: 100vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .storage-bar {
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .storage-progress {
            height: 100%;
            background: linear-gradient(90deg, #34C759 0%, #30D158 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: 20px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.show .modal {
            transform: scale(1);
        }

        .input-field {
            width: 100%;
            padding: 16px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.9);
            min-height: 48px;
            box-sizing: border-box;
        }

        .input-field:focus {
            outline: none;
            border-color: #007AFF;
            background: white;
        }

        .note-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .note-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .image-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .image-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        .drop-zone {
            border: 2px dashed #007AFF;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            background: rgba(0, 122, 255, 0.05);
            transition: all 0.3s ease;
        }

        .drop-zone.dragover {
            background: rgba(0, 122, 255, 0.1);
            border-color: #5856D6;
        }

        .toast {
            position: fixed;
            top: 32px;
            right: 32px;
            background: white;
            color: #1d1d1f;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            z-index: 3000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .ps-code-display {
            background: linear-gradient(135deg, #FF9500 0%, #FF6B35 100%);
            color: white;
            padding: 20px;
            border-radius: 16px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 18px;
            font-weight: 600;
            letter-spacing: 2px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .ps-code-display::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-in {
            animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            overflow: hidden;
        }

        .calendar-day {
            background: white;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-day:hover {
            background: rgba(0, 122, 255, 0.1);
        }

        .calendar-day.has-event {
            background: rgba(0, 122, 255, 0.2);
            font-weight: 600;
        }

        .location-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .location-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        .share-button {
            background: linear-gradient(135deg, #34C759 0%, #30D158 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .share-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(52, 199, 89, 0.3);
        }

        .shared-note-view {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .backup-section {
            background: linear-gradient(135deg, #8E8E93 0%, #636366 100%);
            color: white;
            padding: 24px;
            border-radius: 16px;
            margin-top: 20px;
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #ffffff;
        }

        body.dark-mode .glass-card {
            background: rgba(45, 45, 45, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.dark-mode .sidebar {
            background: rgba(30, 30, 30, 0.9);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.dark-mode .input-field {
            background: rgba(45, 45, 45, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }

        body.dark-mode .input-field:focus {
            border-color: #007AFF;
            background: rgba(45, 45, 45, 1);
        }

        body.dark-mode .note-card,
        body.dark-mode .image-card,
        body.dark-mode .location-card {
            background: rgba(45, 45, 45, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.dark-mode .modal {
            background: rgba(30, 30, 30, 0.95);
            color: #ffffff;
        }

        body.dark-mode .drop-zone {
            background: rgba(0, 122, 255, 0.1);
            border-color: #007AFF;
        }

        body.dark-mode .calendar-day {
            background: rgba(45, 45, 45, 0.8);
            color: #ffffff;
        }

        body.dark-mode .calendar-day:hover {
            background: rgba(0, 122, 255, 0.2);
        }

        body.dark-mode .storage-bar {
            background: rgba(255, 255, 255, 0.2);
        }

        .priority-high {
            border-left: 4px solid #FF3B30;
        }

        .priority-medium {
            border-left: 4px solid #FF9500;
        }

        .priority-low {
            border-left: 4px solid #34C759;
        }

        .category-work {
            background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
        }

        .category-personal {
            background: linear-gradient(135deg, #34C759 0%, #30D158 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
        }

        .category-ideas {
            background: linear-gradient(135deg, #FF9500 0%, #FF6B35 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
        }

        .category-important {
            background: linear-gradient(135deg, #FF3B30 0%, #D70015 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
        }

        .pinned-note {
            border: 2px solid #FFD60A;
            box-shadow: 0 0 20px rgba(255, 214, 10, 0.3);
        }

        .mobile-header {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            z-index: 200;
            padding: 0 20px;
            align-items: center;
            justify-content: space-between;
            box-sizing: border-box;
        }

        .hamburger-menu {
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 4px;
        }

        .hamburger-line {
            width: 100%;
            height: 3px;
            background: #007AFF;
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .hamburger-menu.active .hamburger-line:nth-child(1) {
            transform: rotate(45deg) translate(6px, 6px);
        }

        .hamburger-menu.active .hamburger-line:nth-child(2) {
            opacity: 0;
        }

        .hamburger-menu.active .hamburger-line:nth-child(3) {
            transform: rotate(-45deg) translate(6px, -6px);
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 150;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.show {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .mobile-header {
                display: flex;
            }

            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                width: 100%;
                max-width: 320px;
                z-index: 300;
                padding-top: 80px;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }

            .sidebar-overlay {
                display: block;
            }
            
            .main-content {
                margin-left: 0;
                padding: 20px;
                padding-top: 80px;
                padding-bottom: 100px;
            }
            
            .floating-add {
                bottom: 20px;
                right: 20px;
                width: 60px;
                height: 60px;
                font-size: 28px;
            }
            
            .glass-card {
                margin: 0;
                border-radius: 12px;
            }
            
            .modal {
                margin: 20px;
                max-width: calc(100% - 40px);
                max-height: calc(100vh - 40px);
                padding: 24px;
            }

            .image-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }

            #notesList, #pinnedNotesList {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .premium-button {
                padding: 18px 24px;
                font-size: 16px;
                min-height: 52px;
            }

            .input-field {
                padding: 18px;
                font-size: 16px;
                min-height: 52px;
            }

            body.dark-mode .mobile-header {
                background: rgba(30, 30, 30, 0.95);
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }

            body.dark-mode .sidebar-overlay {
                background: rgba(0, 0, 0, 0.7);
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body><!-- Login Screen -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
   <div class="glass-card p-8 w-full max-w-md text-center fade-in">
    <div class="mb-8">
     <div class="text-6xl mb-4">
      ☁️
     </div>
     <h1 id="appTitle" class="text-3xl font-bold mb-2">DCloud</h1>
     <p id="tagline" class="text-gray-600">Your personal cloud storage</p>
    </div><button id="googleLoginBtn" class="premium-button w-full flex items-center justify-center gap-3">
     <svg width="20" height="20" viewbox="0 0 24 24"><path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" /> <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
     </svg> Sign in with Google </button>
   </div>
  </div><!-- Profile Setup Screen -->
  <div id="profileSetupScreen" class="hidden min-h-screen flex items-center justify-center p-4 overflow-y-auto">
   <div class="glass-card p-8 w-full max-w-2xl fade-in">
    <div class="text-center mb-8">
     <div class="text-5xl mb-4">
      👤
     </div>
     <h2 class="text-2xl font-bold mb-2">Complete Your Profile</h2>
     <p class="text-gray-600">Let's set up your DCloud account</p>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
     <div><label class="block text-sm font-semibold mb-2">Full Name</label> <input type="text" id="profileName" class="input-field" placeholder="Enter your name">
     </div>
     <div><label class="block text-sm font-semibold mb-2">Mobile Number</label> <input type="tel" id="profileMobile" class="input-field" placeholder="Your mobile number">
     </div>
     <div><label class="block text-sm font-semibold mb-2">Email Address</label> <input type="email" id="profileEmail" class="input-field" readonly>
     </div>
     <div><label class="block text-sm font-semibold mb-2">Date of Birth</label> <input type="date" id="profileDob" class="input-field">
     </div>
    </div>
    <div class="mt-8">
     <h3 class="text-lg font-semibold mb-4">🔐 Set Your MPIN (4-6 digits)</h3>
     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div><label class="block text-sm font-semibold mb-2">Create MPIN</label> <input type="password" id="createMPIN" class="input-field" placeholder="Enter 4-6 digit MPIN" maxlength="6">
      </div>
      <div><label class="block text-sm font-semibold mb-2">Confirm MPIN</label> <input type="password" id="confirmMPIN" class="input-field" placeholder="Confirm MPIN" maxlength="6">
      </div>
     </div>
     <p class="text-sm text-gray-600 mt-2">⚠️ MPIN is required for all sensitive actions like delete, edit, and share.</p>
    </div>
    <div class="mt-8">
     <h3 class="text-lg font-semibold mb-4">🔐 Your Personal Security Code</h3>
     <div class="ps-code-display mb-4"><span id="psCode"></span>
     </div>
     <div class="flex gap-3"><button id="copyPsCode" class="premium-button flex-1">📋 Copy Code</button> <button id="screenshotPsCode" class="premium-button flex-1">📸 Screenshot</button>
     </div>
     <p class="text-sm text-gray-600 mt-3 text-center">⚠️ Save this code securely. You'll need it for account recovery.</p>
    </div><button id="completeSetup" class="premium-button w-full mt-8">Complete Setup</button>
   </div>
  </div><!-- MPIN Login Screen -->
  <div id="mpinLoginScreen" class="hidden min-h-screen flex items-center justify-center p-4">
   <div class="glass-card p-8 w-full max-w-md text-center fade-in">
    <div class="mb-8">
     <div class="text-6xl mb-4">
      🔐
     </div>
     <h1 class="text-3xl font-bold mb-2">Enter MPIN</h1>
     <p class="text-gray-600">Enter your 4-6 digit MPIN to continue</p>
    </div>
    <div class="mb-6"><input type="password" id="loginMPIN" class="input-field text-center text-2xl tracking-widest" placeholder="••••••" maxlength="6">
    </div>
    <div class="grid grid-cols-3 gap-3 mb-6"><button class="mpin-key premium-button" data-key="1">1</button> <button class="mpin-key premium-button" data-key="2">2</button> <button class="mpin-key premium-button" data-key="3">3</button> <button class="mpin-key premium-button" data-key="4">4</button> <button class="mpin-key premium-button" data-key="5">5</button> <button class="mpin-key premium-button" data-key="6">6</button> <button class="mpin-key premium-button" data-key="7">7</button> <button class="mpin-key premium-button" data-key="8">8</button> <button class="mpin-key premium-button" data-key="9">9</button> <button class="premium-button" style="background: #8E8E93;" onclick="clearMPIN()">Clear</button> <button class="mpin-key premium-button" data-key="0">0</button> <button class="premium-button" style="background: #FF3B30;" onclick="deleteMPINDigit()">⌫</button>
    </div><button id="verifyMPIN" class="premium-button w-full">Verify MPIN</button>
    <div class="mt-6"><button id="forgotMPIN" class="text-blue-500 hover:text-blue-700 text-sm">Forgot MPIN? Use PS Code</button>
    </div>
   </div>
  </div><!-- Main Dashboard -->
  <div id="dashboard" class="hidden"><!-- Mobile Header -->
   <div class="mobile-header">
    <div class="hamburger-menu" id="hamburgerMenu">
     <div class="hamburger-line"></div>
     <div class="hamburger-line"></div>
     <div class="hamburger-line"></div>
    </div>
    <div class="flex items-center gap-2">
     <div class="text-xl">
      ☁️
     </div>
     <h1 class="text-lg font-bold">DCloud</h1>
    </div><button id="mobileDarkToggle" class="text-2xl">🌙</button>
   </div><!-- Sidebar Overlay -->
   <div class="sidebar-overlay" id="sidebarOverlay"></div><!-- Sidebar -->
   <div class="sidebar">
    <div class="mb-8">
     <div class="flex items-center gap-3 mb-2">
      <div class="text-2xl">
       ☁️
      </div>
      <h1 class="text-xl font-bold">DCloud</h1>
     </div>
     <p id="welcomeText" class="text-sm text-gray-600">Welcome back</p>
    </div>
    <nav class="space-y-2">
     <div class="sidebar-item active" data-tab="notes">
      <svg width="20" height="20" fill="currentColor" viewbox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
      </svg><span>Notes</span>
     </div>
     <div class="sidebar-item" data-tab="images">
      <svg width="20" height="20" fill="currentColor" viewbox="0 0 24 24"><path d="M8.5,13.5L11,16.5L14.5,12L19,18H5M21,19V5C21,3.89 20.1,3 19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19Z" />
      </svg><span>Images</span>
     </div>
     <div class="sidebar-item" data-tab="calendar">
      <svg width="20" height="20" fill="currentColor" viewbox="0 0 24 24"><path d="M19,3H18V1H16V3H8V1H6V3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M19,19H5V8H19V19Z" />
      </svg><span>Calendar</span>
     </div>
     <div class="sidebar-item" data-tab="maps">
      <svg width="20" height="20" fill="currentColor" viewbox="0 0 24 24"><path d="M12,11.5A2.5,2.5 0 0,1 9.5,9A2.5,2.5 0 0,1 12,6.5A2.5,2.5 0 0,1 14.5,9A2.5,2.5 0 0,1 12,11.5M12,2A7,7 0 0,0 5,9C5,14.25 12,22 12,22C12,22 19,14.25 19,9A7,7 0 0,0 12,2Z" />
      </svg><span>Locations</span>
     </div>
     <div class="sidebar-item" data-tab="settings">
      <svg width="20" height="20" fill="currentColor" viewbox="0 0 24 24"><path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z" />
      </svg><span>Settings</span>
     </div>
     <div class="sidebar-item" data-tab="about">
      <svg width="20" height="20" fill="currentColor" viewbox="0 0 24 24"><path d="M11,9H13V7H11M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M11,17H13V11H11V17Z" />
      </svg><span>About &amp; Help</span>
     </div>
    </nav>
    <div class="mt-8 pt-6 border-t border-gray-200">
     <div class="flex items-center gap-3 mb-4"><img id="userAvatar" class="w-10 h-10 rounded-full" alt="User">
      <div>
       <p id="userName" class="font-semibold text-sm"></p>
       <p class="text-xs text-gray-600">Premium Account</p>
      </div>
     </div><button id="logoutBtn" class="w-full text-left text-sm text-gray-600 hover:text-red-500 transition-colors"> 🚪 Sign Out </button>
    </div>
   </div><!-- Main Content -->
   <div class="main-content"><!-- Notes Tab -->
    <div id="notesTab" class="tab-content">
     <div class="flex justify-between items-center mb-8">
      <div>
       <h2 class="text-3xl font-bold mb-2">Notes</h2>
       <p class="text-gray-600">Your thoughts, organized beautifully</p>
      </div><button id="darkModeToggle" class="premium-button">🌙 Dark Mode</button>
     </div><!-- Search and Filter Bar -->
     <div class="glass-card p-4 mb-6">
      <div class="flex flex-col md:flex-row gap-4">
       <div class="flex-1"><input type="text" id="notesSearch" class="input-field" placeholder="🔍 Search notes...">
       </div>
       <div class="flex gap-2"><select id="notesCategory" class="input-field"> <option value="">All Categories</option> <option value="work">Work</option> <option value="personal">Personal</option> <option value="ideas">Ideas</option> <option value="important">Important</option> </select> <button id="addCategoryBtn" class="premium-button">+ Category</button>
       </div>
      </div>
     </div><!-- Pinned Notes -->
     <div id="pinnedNotesSection" class="mb-8 hidden">
      <h3 class="text-xl font-semibold mb-4 flex items-center gap-2">📌 Pinned Notes</h3>
      <div id="pinnedNotesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6"><!-- Pinned notes will be loaded here -->
      </div>
     </div>
     <div id="notesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"><!-- Notes will be loaded here -->
     </div>
    </div><!-- Images Tab -->
    <div id="imagesTab" class="tab-content hidden">
     <div class="flex justify-between items-center mb-8">
      <div>
       <h2 class="text-3xl font-bold mb-2">Images</h2>
       <p class="text-gray-600">Your memories in the cloud</p>
      </div>
     </div><!-- Search Bar for Images -->
     <div class="glass-card p-4 mb-6"><input type="text" id="imagesSearch" class="input-field" placeholder="🔍 Search images by name...">
     </div>
     <div id="dropZone" class="drop-zone mb-8">
      <div class="text-4xl mb-4">
       📸
      </div>
      <h3 class="text-xl font-semibold mb-2">Drop images here</h3>
      <p class="text-gray-600 mb-4">Or click to browse files</p><input type="file" id="fileInput" accept="image/*,application/pdf,.doc,.docx" multiple class="hidden"> <button id="browseBtn" class="premium-button">Browse Files</button>
      <p class="text-xs text-gray-500 mt-2">Supports: Images, PDF, DOC, DOCX</p>
     </div>
     <div id="imagesList" class="image-grid"><!-- Images will be loaded here -->
     </div>
    </div><!-- Calendar Tab -->
    <div id="calendarTab" class="tab-content hidden">
     <div class="flex justify-between items-center mb-8">
      <div>
       <h2 class="text-3xl font-bold mb-2">Calendar</h2>
       <p class="text-gray-600">Stay organized with your schedule</p>
      </div>
     </div><!-- Search Bar for Events -->
     <div class="glass-card p-4 mb-6">
      <div class="flex gap-4"><input type="text" id="eventsSearch" class="input-field flex-1" placeholder="🔍 Search events..."> <select id="eventsPriority" class="input-field"> <option value="">All Priority</option> <option value="high">High Priority</option> <option value="medium">Medium Priority</option> <option value="low">Low Priority</option> </select>
      </div>
     </div>
     <div class="glass-card p-6 mb-6">
      <div id="calendarView" class="calendar-grid"><!-- Calendar will be generated here -->
      </div>
     </div>
     <div id="eventsList" class="space-y-4"><!-- Events will be loaded here -->
     </div>
    </div><!-- Maps Tab -->
    <div id="mapsTab" class="tab-content hidden">
     <div class="flex justify-between items-center mb-8">
      <div>
       <h2 class="text-3xl font-bold mb-2">Locations</h2>
       <p class="text-gray-600">Places you've been and want to remember</p>
      </div>
     </div>
     <div id="locationsList" class="grid grid-cols-1 md:grid-cols-2 gap-6"><!-- Locations will be loaded here -->
     </div>
    </div><!-- Settings Tab -->
    <div id="settingsTab" class="tab-content hidden">
     <div class="mb-8">
      <h2 class="text-3xl font-bold mb-2">Settings</h2>
      <p class="text-gray-600">Manage your account and preferences</p>
     </div>
     <div class="space-y-6"><!-- Personal Information -->
      <div class="glass-card p-6">
       <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold">Personal Information</h3><button id="editProfileBtn" class="premium-button">✏️ Edit Profile</button>
       </div>
       <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium mb-1">Name</label>
         <p id="settingsName" class="text-gray-800"></p>
        </div>
        <div><label class="block text-sm font-medium mb-1">Email</label>
         <p id="settingsEmail" class="text-gray-800"></p>
        </div>
        <div><label class="block text-sm font-medium mb-1">Mobile</label>
         <p id="settingsMobile" class="text-gray-800"></p>
        </div>
        <div><label class="block text-sm font-medium mb-1">Date of Birth</label>
         <p id="settingsDob" class="text-gray-800"></p>
        </div>
       </div>
      </div><!-- Security Settings -->
      <div class="glass-card p-6">
       <h3 class="text-xl font-semibold mb-4">Security Settings</h3>
       <div class="space-y-4"><button id="changeMPINBtn" class="premium-button w-full">🔐 Change MPIN</button> <button id="regeneratePSCodeBtn" class="premium-button w-full" style="background: #FF9500;">🔄 Regenerate PS Code</button>
        <div class="bg-yellow-50 p-4 rounded-lg">
         <p class="text-sm text-yellow-800">⚠️ Changing security settings requires current MPIN verification</p>
        </div>
       </div>
      </div><!-- Account Storage -->
      <div class="glass-card p-6">
       <h3 class="text-xl font-semibold mb-4">Account Storage</h3>
       <div class="mb-4">
        <div class="flex justify-between items-center mb-2"><span class="text-sm font-medium">Used Storage</span> <span id="storageText" class="text-sm text-gray-600">0 GB / 20 GB</span>
        </div>
        <div class="storage-bar">
         <div id="storageProgress" class="storage-progress" style="width: 0%"></div>
        </div>
       </div>
       <p class="text-sm text-gray-600">You have 20 GB of free storage available.</p>
      </div><!-- PS Code -->
      <div class="glass-card p-6">
       <h3 class="text-xl font-semibold mb-4">Personal Security Code</h3>
       <div class="ps-code-display mb-4"><span id="settingsPsCode"></span>
       </div>
       <div class="flex gap-3"><button id="copySettingsPsCode" class="premium-button">📋 Copy Code</button> <button id="screenshotSettingsPsCode" class="premium-button">📸 Screenshot</button>
       </div>
       <p class="text-sm text-gray-600 mt-3">Keep this code safe. It's required for account recovery.</p>
      </div><!-- Notifications -->
      <div class="glass-card p-6">
       <h3 class="text-xl font-semibold mb-4">Notifications</h3>
       <div class="space-y-3"><label class="flex items-center gap-3"> <input type="checkbox" id="enableNotifications" class="rounded"> <span>Enable browser notifications for reminders</span> </label> <button id="testNotificationBtn" class="premium-button">🔔 Test Notification</button>
       </div>
      </div><!-- Backup & Export -->
      <div class="backup-section">
       <h3 class="text-xl font-semibold mb-4">Backup &amp; Export</h3>
       <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><button id="exportNotesBtn" class="premium-button">📝 Export Notes</button> <button id="exportImagesBtn" class="premium-button">🖼️ Export Images</button> <button id="exportCalendarBtn" class="premium-button">📅 Export Calendar</button> <button id="exportAllBtn" class="premium-button">💾 Export All Data</button>
       </div>
       <p class="text-sm opacity-80 mt-3">Download your data in multiple formats for backup or migration.</p>
      </div><!-- Danger Zone -->
      <div class="glass-card p-6 border-2 border-red-200">
       <h3 class="text-xl font-semibold mb-4 text-red-600">⚠️ Danger Zone</h3>
       <div class="space-y-3"><button id="clearAllDataBtn" class="premium-button w-full" style="background: #FF9500;">🗑️ Clear All Data</button> <button id="deleteAccountBtn" class="premium-button w-full" style="background: #FF3B30;">❌ Delete Account</button>
       </div>
       <p class="text-sm text-red-600 mt-3">These actions cannot be undone. Please be careful.</p>
      </div>
     </div>
    </div><!-- About & Help Tab -->
    <div id="aboutTab" class="tab-content hidden">
     <div class="mb-8">
      <h2 class="text-3xl font-bold mb-2">About &amp; Help</h2>
      <p class="text-gray-600">Learn more about DCloud and get help</p>
     </div>
     <div class="space-y-6"><!-- App Info -->
      <div class="glass-card p-6 text-center">
       <div class="text-6xl mb-4">
        ☁️
       </div>
       <h3 class="text-2xl font-bold mb-2">DCloud</h3>
       <p class="text-gray-600 mb-4">Your Personal Cloud Storage Solution</p>
       <div class="text-sm text-gray-500">
        <p>Version 2.0.0</p>
        <p>Built with ❤️ for productivity</p>
       </div>
      </div><!-- Features -->
      <div class="glass-card p-6">
       <h3 class="text-xl font-semibold mb-4">✨ Features</h3>
       <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="space-y-2">
         <div class="flex items-center gap-2"><span class="text-green-500">✓</span> <span>Secure Notes with Categories</span>
         </div>
         <div class="flex items-center gap-2"><span class="text-green-500">✓</span> <span>Image &amp; File Storage</span>
         </div>
         <div class="flex items-center gap-2"><span class="text-green-500">✓</span> <span>Calendar &amp; Reminders</span>
         </div>
         <div class="flex items-center gap-2"><span class="text-green-500">✓</span> <span>Location Tracking</span>
         </div>
        </div>
        <div class="space-y-2">
         <div class="flex items-center gap-2"><span class="text-green-500">✓</span> <span>Private &amp; Shared Notes</span>
         </div>
         <div class="flex items-center gap-2"><span class="text-green-500">✓</span> <span>PDF Export</span>
         </div>
         <div class="flex items-center gap-2"><span class="text-green-500">✓</span> <span>Dark Mode</span>
         </div>
         <div class="flex items-center gap-2"><span class="text-green-500">✓</span> <span>Mobile Responsive</span>
         </div>
        </div>
       </div>
      </div><!-- FAQ -->
      <div class="glass-card p-6">
       <h3 class="text-xl font-semibold mb-4">❓ Frequently Asked Questions</h3>
       <div class="space-y-4">
        <div class="border-b pb-3">
         <h4 class="font-semibold mb-2">How secure is my data?</h4>
         <p class="text-sm text-gray-600">Your data is protected with MPIN authentication and encrypted storage. Private notes have additional password protection.</p>
        </div>
        <div class="border-b pb-3">
         <h4 class="font-semibold mb-2">What is the PS Code?</h4>
         <p class="text-sm text-gray-600">Personal Security Code is your backup access method. Keep it safe as it can be used to recover your account if you forget your MPIN.</p>
        </div>
        <div class="border-b pb-3">
         <h4 class="font-semibold mb-2">How much storage do I get?</h4>
         <p class="text-sm text-gray-600">Each account gets 20 GB of free storage for notes, images, and files. You'll get warnings when approaching the limit.</p>
        </div>
        <div class="border-b pb-3">
         <h4 class="font-semibold mb-2">Can I share my notes?</h4>
         <p class="text-sm text-gray-600">Yes! You can share notes and images with others via secure links. Private notes require the password you set.</p>
        </div>
        <div>
         <h4 class="font-semibold mb-2">How do I backup my data?</h4>
         <p class="text-sm text-gray-600">Use the export functions in Settings to download your data in JSON, PDF, or text formats for backup.</p>
        </div>
       </div>
      </div><!-- Contact & Support -->
      <div class="glass-card p-6">
       <h3 class="text-xl font-semibold mb-4">📞 Support &amp; Contact</h3>
       <div class="space-y-3">
        <div class="flex items-center gap-3"><span class="text-2xl">📧</span>
         <div>
          <p class="font-semibold">Email Support</p>
          <p class="text-sm text-gray-600">support@dcloud.app</p>
         </div>
        </div>
        <div class="flex items-center gap-3"><span class="text-2xl">💬</span>
         <div>
          <p class="font-semibold">Live Chat</p>
          <p class="text-sm text-gray-600">Available 24/7 for premium users</p>
         </div>
        </div>
        <div class="flex items-center gap-3"><span class="text-2xl">📚</span>
         <div>
          <p class="font-semibold">Documentation</p>
          <p class="text-sm text-gray-600">Complete user guide and tutorials</p>
         </div>
        </div>
       </div>
      </div><!-- Privacy & Terms -->
      <div class="glass-card p-6">
       <h3 class="text-xl font-semibold mb-4">📋 Legal</h3>
       <div class="flex gap-4 text-sm"><button class="text-blue-500 hover:text-blue-700">Privacy Policy</button> <button class="text-blue-500 hover:text-blue-700">Terms of Service</button> <button class="text-blue-500 hover:text-blue-700">Cookie Policy</button>
       </div>
       <p class="text-xs text-gray-500 mt-4">© 2024 DCloud. All rights reserved.</p>
      </div>
     </div>
    </div>
   </div><!-- Floating Add Button --> <button class="floating-add" id="floatingAdd">+</button>
  </div><!-- Shared Note View -->
  <div id="sharedNoteView" class="hidden">
   <div class="shared-note-view">
    <div class="glass-card p-8">
     <div class="text-center mb-6">
      <div class="text-4xl mb-4">
       📝
      </div>
      <h1 class="text-2xl font-bold mb-2">Shared Note</h1>
      <p class="text-gray-600">Read-only view</p>
     </div>
     <div id="sharedNoteContent"><!-- Shared note content will be loaded here -->
     </div>
     <div class="text-center mt-8"><button id="backToApp" class="premium-button">← Back to DCloud</button>
     </div>
    </div>
   </div>
  </div><!-- Modals -->
  <div id="noteModal" class="modal-overlay">
   <div class="modal">
    <h3 class="text-2xl font-bold mb-6">Create Note</h3>
    <div class="space-y-4"><input type="text" id="noteTitle" placeholder="Note title..." class="input-field">
     <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><select id="noteCategory" class="input-field"> <option value="">Select Category</option> <option value="work">Work</option> <option value="personal">Personal</option> <option value="ideas">Ideas</option> <option value="important">Important</option> </select> <select id="notePriority" class="input-field"> <option value="low">Low Priority</option> <option value="medium" selected>Medium Priority</option> <option value="high">High Priority</option> </select>
     </div><textarea id="noteContent" placeholder="Start writing..." rows="8" class="input-field resize-none"></textarea>
     <div class="flex items-center gap-4"><label class="flex items-center gap-2"> <input type="checkbox" id="notePin" class="rounded"> <span class="text-sm">📌 Pin to top</span> </label> <label class="flex items-center gap-2"> <input type="checkbox" id="notePrivate" class="rounded"> <span class="text-sm">🔒 Private note</span> </label>
     </div>
     <div id="privateNotePassword" class="hidden"><input type="password" id="notePassword" placeholder="Set password for private sharing..." class="input-field">
     </div>
     <div class="flex gap-3"><button id="saveNote" class="premium-button flex-1">Save Note</button> <button id="cancelNote" class="premium-button flex-1" style="background: #8E8E93;">Cancel</button>
     </div>
    </div>
   </div>
  </div>
  <div id="eventModal" class="modal-overlay">
   <div class="modal">
    <h3 class="text-2xl font-bold mb-6">Create Event</h3>
    <div class="space-y-4"><input type="text" id="eventTitle" placeholder="Event title..." class="input-field">
     <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="date" id="eventDate" class="input-field"> <input type="time" id="eventTime" class="input-field">
     </div><select id="eventPriority" class="input-field"> <option value="low">Low Priority</option> <option value="medium" selected>Medium Priority</option> <option value="high">High Priority</option> </select> <textarea id="eventDescription" placeholder="Event description..." rows="4" class="input-field resize-none"></textarea>
     <div class="space-y-3"><label class="flex items-center gap-2"> <input type="checkbox" id="eventReminder" class="rounded"> <span class="text-sm">🔔 Set Reminder</span> </label>
      <div id="reminderOptions" class="hidden pl-6"><select id="reminderTime" class="input-field"> <option value="5">5 minutes before</option> <option value="15" selected>15 minutes before</option> <option value="30">30 minutes before</option> <option value="60">1 hour before</option> <option value="1440">1 day before</option> </select>
      </div>
     </div>
     <div class="flex gap-3"><button id="saveEvent" class="premium-button flex-1">Save Event</button> <button id="cancelEvent" class="premium-button flex-1" style="background: #8E8E93;">Cancel</button>
     </div>
    </div>
   </div>
  </div>
  <div id="locationModal" class="modal-overlay">
   <div class="modal">
    <h3 class="text-2xl font-bold mb-6">Add Location</h3>
    <div class="space-y-4"><input type="text" id="locationName" placeholder="Location name..." class="input-field"> <input type="text" id="locationAddress" placeholder="Address or coordinates..." class="input-field"> <button id="getCurrentLocation" class="premium-button w-full">📍 Use Current Location</button> <textarea id="locationNotes" placeholder="Notes about this location..." rows="3" class="input-field resize-none"></textarea>
     <div class="flex gap-3"><button id="saveLocation" class="premium-button flex-1">Save Location</button> <button id="cancelLocation" class="premium-button flex-1" style="background: #8E8E93;">Cancel</button>
     </div>
    </div>
   </div>
  </div><!-- Security Verification Modal -->
  <div id="securityModal" class="modal-overlay">
   <div class="modal">
    <h3 class="text-2xl font-bold mb-6">🔐 Security Verification</h3>
    <p class="text-gray-600 mb-6">This action requires verification. Enter your MPIN or PS Code:</p>
    <div class="space-y-4">
     <div class="tabs flex gap-2 mb-4"><button id="mpinTab" class="premium-button flex-1 active">MPIN</button> <button id="psCodeTab" class="premium-button flex-1" style="background: #8E8E93;">PS Code</button>
     </div>
     <div id="mpinVerification"><input type="password" id="verifyMPIN" class="input-field text-center text-2xl tracking-widest" placeholder="••••••" maxlength="6">
     </div>
     <div id="psCodeVerification" class="hidden"><input type="text" id="verifyPSCode" class="input-field text-center" placeholder="Enter PS Code" maxlength="16">
     </div>
     <div class="flex gap-3"><button id="confirmSecurity" class="premium-button flex-1">Verify &amp; Continue</button> <button id="cancelSecurity" class="premium-button flex-1" style="background: #8E8E93;">Cancel</button>
     </div>
    </div>
   </div>
  </div><!-- Private Note Access Modal -->
  <div id="privateNoteModal" class="modal-overlay">
   <div class="modal">
    <h3 class="text-2xl font-bold mb-6">🔒 Private Note Access</h3>
    <p class="text-gray-600 mb-6">This note is password protected. Enter the password to view:</p>
    <div class="space-y-4"><input type="password" id="privateNotePasswordInput" class="input-field" placeholder="Enter note password">
     <div class="flex gap-3"><button id="accessPrivateNote" class="premium-button flex-1">Access Note</button> <button id="cancelPrivateNote" class="premium-button flex-1" style="background: #8E8E93;">Cancel</button>
     </div>
    </div>
   </div>
  </div>
  <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC30TcmMVhP_8HdFYS1WufRiZwSDYNMTF0",
            authDomain: "pulse2-92372.firebaseapp.com",
            databaseURL: "https://pulse2-92372-default-rtdb.firebaseio.com",
            projectId: "pulse2-92372",
            storageBucket: "pulse2-92372.firebasestorage.app",
            messagingSenderId: "276235725177",
            appId: "1:276235725177:web:0f4e0789fae80a435927a8"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Global variables
        let currentUser = null;
        let userProfile = null;
        let currentTab = 'notes';
        let isDarkMode = false;
        let userMPIN = null;
        let isLoggedInWithMPIN = false;

        // Default config for Element SDK
        const defaultConfig = {
            app_title: "DCloud",
            tagline: "Your personal cloud storage",
            welcome_text: "Welcome back"
        };

        // Element SDK Implementation
        const element = {
            defaultConfig,
            render: async (config) => {
                document.getElementById('appTitle').textContent = config.app_title || defaultConfig.app_title;
                document.getElementById('tagline').textContent = config.tagline || defaultConfig.tagline;
                document.getElementById('welcomeText').textContent = config.welcome_text || defaultConfig.welcome_text;
            },
            mapToCapabilities: (config) => ({
                recolorables: [],
                borderables: [],
                fontEditable: undefined,
                fontSizeable: undefined
            }),
            mapToEditPanelValues: (config) => new Map([
                ["app_title", config.app_title || defaultConfig.app_title],
                ["tagline", config.tagline || defaultConfig.tagline],
                ["welcome_text", config.welcome_text || defaultConfig.welcome_text]
            ])
        };

        // Initialize Element SDK
        if (window.elementSdk) {
            window.elementSdk.init(element);
        }

        // Utility Functions
        function generatePSCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 16; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function generateNoteId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            
            if (type === 'error') {
                toast.style.background = '#FF3B30';
                toast.style.color = 'white';
            }
            
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied to clipboard!');
            }).catch(() => {
                showToast('Failed to copy', 'error');
            });
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Cache Management
        function saveToCache(key, data) {
            try {
                localStorage.setItem(`dcloud_${key}`, JSON.stringify(data));
            } catch (e) {
                console.warn('Cache save failed:', e);
            }
        }

        function loadFromCache(key) {
            try {
                const data = localStorage.getItem(`dcloud_${key}`);
                return data ? JSON.parse(data) : null;
            } catch (e) {
                console.warn('Cache load failed:', e);
                return null;
            }
        }

        // Authentication
        document.getElementById('googleLoginBtn').addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.addScope('email');
            provider.addScope('profile');
            
            auth.signInWithPopup(provider).then((result) => {
                currentUser = result.user;
                showToast('Login successful!');
                checkUserProfile();
            }).catch((error) => {
                console.error('Login error:', error);
                showToast('Login failed: ' + error.message, 'error');
            });
        });

        function checkUserProfile() {
            database.ref(`users/${currentUser.uid}/profile`).once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    userProfile = snapshot.val();
                    userMPIN = userProfile.mpin;
                    if (userProfile.mpin && !isLoggedInWithMPIN) {
                        showMPINLogin();
                    } else {
                        showDashboard();
                    }
                } else {
                    showProfileSetup();
                }
            }).catch((error) => {
                console.error('Profile check error:', error);
                showProfileSetup();
            });
        }

        function showMPINLogin() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mpinLoginScreen').classList.remove('hidden');
        }

        // MPIN Keypad functionality
        document.querySelectorAll('.mpin-key').forEach(key => {
            key.addEventListener('click', () => {
                const digit = key.dataset.key;
                const mpinInput = document.getElementById('loginMPIN');
                if (mpinInput.value.length < 6) {
                    mpinInput.value += digit;
                }
            });
        });

        function clearMPIN() {
            document.getElementById('loginMPIN').value = '';
        }

        function deleteMPINDigit() {
            const mpinInput = document.getElementById('loginMPIN');
            mpinInput.value = mpinInput.value.slice(0, -1);
        }

        document.getElementById('verifyMPIN').addEventListener('click', () => {
            const enteredMPIN = document.getElementById('loginMPIN').value;
            if (enteredMPIN === userMPIN) {
                isLoggedInWithMPIN = true;
                document.getElementById('mpinLoginScreen').classList.add('hidden');
                showDashboard();
                showToast('Welcome back!');
            } else {
                showToast('Invalid MPIN', 'error');
                document.getElementById('loginMPIN').value = '';
            }
        });

        document.getElementById('forgotMPIN').addEventListener('click', () => {
            const psCode = prompt('Enter your PS Code:');
            if (psCode === userProfile.psCode) {
                isLoggedInWithMPIN = true;
                document.getElementById('mpinLoginScreen').classList.add('hidden');
                showDashboard();
                showToast('Access granted with PS Code');
            } else {
                showToast('Invalid PS Code', 'error');
            }
        });

        function showProfileSetup() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('profileSetupScreen').classList.remove('hidden');
            
            document.getElementById('profileEmail').value = currentUser.email;
            document.getElementById('psCode').textContent = generatePSCode();
        }

        document.getElementById('completeSetup').addEventListener('click', () => {
            const name = document.getElementById('profileName').value;
            const mobile = document.getElementById('profileMobile').value;
            const dob = document.getElementById('profileDob').value;
            const psCode = document.getElementById('psCode').textContent;
            const createMPIN = document.getElementById('createMPIN').value;
            const confirmMPIN = document.getElementById('confirmMPIN').value;

            if (!name || !mobile || !dob) {
                showToast('Please fill all fields', 'error');
                return;
            }

            if (!createMPIN || createMPIN.length < 4 || createMPIN.length > 6) {
                showToast('MPIN must be 4-6 digits', 'error');
                return;
            }

            if (createMPIN !== confirmMPIN) {
                showToast('MPIN does not match', 'error');
                return;
            }

            userProfile = {
                name,
                mobile,
                email: currentUser.email,
                dob,
                psCode,
                mpin: createMPIN,
                createdAt: Date.now(),
                storageUsed: 0
            };

            // Save to Firebase database
            database.ref(`users/${currentUser.uid}/profile`).set(userProfile).then(() => {
                userMPIN = createMPIN;
                showDashboard();
                showToast('Profile created successfully!');
            }).catch((error) => {
                console.error('Profile save error:', error);
                showToast('Failed to save profile: ' + error.message, 'error');
            });
        });

        // Copy PS Code
        document.getElementById('copyPsCode').addEventListener('click', () => {
            copyToClipboard(document.getElementById('psCode').textContent);
        });

        document.getElementById('copySettingsPsCode').addEventListener('click', () => {
            copyToClipboard(document.getElementById('settingsPsCode').textContent);
        });

        // Screenshot PS Code
        document.getElementById('screenshotPsCode').addEventListener('click', () => {
            showToast('Screenshot feature would capture the PS Code area');
        });

        document.getElementById('screenshotSettingsPsCode').addEventListener('click', () => {
            showToast('Screenshot feature would capture the PS Code area');
        });

        // Dashboard - removed duplicate, using the one at the end

        function updateStorageInfo() {
            const usedGB = (userProfile.storageUsed / (1024 * 1024 * 1024)).toFixed(2);
            const remainingGB = 20 - usedGB;
            const percentage = (userProfile.storageUsed / (20 * 1024 * 1024 * 1024)) * 100;
            
            document.getElementById('storageText').textContent = `${usedGB} GB / 20 GB`;
            document.getElementById('storageProgress').style.width = `${Math.min(percentage, 100)}%`;
            
            // Storage warning system
            if (remainingGB <= 5 && remainingGB > 1) {
                // Yellow warning for 1-5 GB remaining
                document.getElementById('storageProgress').style.background = 'linear-gradient(90deg, #FF9500 0%, #FFCC02 100%)';
                showStorageWarning(`⚠️ Storage Warning: Only ${remainingGB.toFixed(2)} GB remaining!`, 'warning');
            } else if (remainingGB <= 1) {
                // Red critical warning for less than 1 GB
                document.getElementById('storageProgress').style.background = 'linear-gradient(90deg, #FF3B30 0%, #D70015 100%)';
                showStorageWarning(`🚨 Critical: Only ${remainingGB.toFixed(2)} GB left! Please delete some files.`, 'critical');
            } else {
                // Green for normal usage
                document.getElementById('storageProgress').style.background = 'linear-gradient(90deg, #34C759 0%, #30D158 100%)';
            }
        }

        function showStorageWarning(message, type) {
            // Remove existing warning if any
            const existingWarning = document.getElementById('storageWarning');
            if (existingWarning) {
                existingWarning.remove();
            }

            const warning = document.createElement('div');
            warning.id = 'storageWarning';
            warning.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-semibold text-sm';
            
            if (type === 'critical') {
                warning.style.background = 'linear-gradient(135deg, #FF3B30 0%, #D70015 100%)';
            } else {
                warning.style.background = 'linear-gradient(135deg, #FF9500 0%, #FFCC02 100%)';
            }
            
            warning.innerHTML = `
                <div class="flex items-center gap-2">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">✕</button>
                </div>
            `;
            
            document.body.appendChild(warning);
            
            // Auto-hide after 10 seconds for warning, keep critical visible
            if (type === 'warning') {
                setTimeout(() => {
                    if (warning.parentElement) {
                        warning.remove();
                    }
                }, 10000);
            }
        }

        // Tab Navigation
        document.querySelectorAll('.sidebar-item').forEach(item => {
            item.addEventListener('click', () => {
                const tab = item.dataset.tab;
                switchTab(tab);
            });
        });

        function switchTab(tab) {
            // Update sidebar
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            
            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`${tab}Tab`).classList.remove('hidden');
            
            currentTab = tab;
        }

        // Floating Add Button
        document.getElementById('floatingAdd').addEventListener('click', () => {
            if (currentTab === 'notes') {
                showModal('noteModal');
            } else if (currentTab === 'images') {
                document.getElementById('fileInput').click();
            } else if (currentTab === 'calendar') {
                showModal('eventModal');
            } else if (currentTab === 'maps') {
                showModal('locationModal');
            }
        });

        // Notes Management
        document.getElementById('notePrivate').addEventListener('change', (e) => {
            const passwordField = document.getElementById('privateNotePassword');
            if (e.target.checked) {
                passwordField.classList.remove('hidden');
            } else {
                passwordField.classList.add('hidden');
            }
        });

        document.getElementById('saveNote').addEventListener('click', () => {
            const title = document.getElementById('noteTitle').value;
            const content = document.getElementById('noteContent').value;
            const category = document.getElementById('noteCategory').value;
            const priority = document.getElementById('notePriority').value;
            const isPinned = document.getElementById('notePin').checked;
            const isPrivate = document.getElementById('notePrivate').checked;
            const password = document.getElementById('notePassword').value;
            
            if (!title || !content) {
                showToast('Please fill all fields', 'error');
                return;
            }

            if (isPrivate && !password) {
                showToast('Please set a password for private note', 'error');
                return;
            }
            
            const noteId = generateNoteId();
            const noteData = {
                id: noteId,
                title,
                content,
                category: category || 'uncategorized',
                priority: priority || 'medium',
                pinned: isPinned,
                private: isPrivate,
                password: isPrivate ? password : null,
                createdAt: Date.now(),
                shared: false
            };
            
            // Save to Firebase database
            database.ref(`users/${currentUser.uid}/notes/${noteId}`).set(noteData).then(() => {
                hideModal('noteModal');
                clearNoteModal();
                loadNotes();
                showToast('Note saved successfully!');
            }).catch((error) => {
                console.error('Note save error:', error);
                showToast('Failed to save note: ' + error.message, 'error');
            });
        });

        function clearNoteModal() {
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteContent').value = '';
            document.getElementById('noteCategory').value = '';
            document.getElementById('notePriority').value = 'medium';
            document.getElementById('notePin').checked = false;
            document.getElementById('notePrivate').checked = false;
            document.getElementById('notePassword').value = '';
            document.getElementById('privateNotePassword').classList.add('hidden');
        }

        document.getElementById('cancelNote').addEventListener('click', () => {
            hideModal('noteModal');
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteContent').value = '';
        });

        function loadNotes() {
            database.ref(`users/${currentUser.uid}/notes`).on('value', (snapshot) => {
                const notes = snapshot.val() || {};
                displayNotes(notes);
                saveToCache('notes', notes);
            });
        }

        function displayNotes(notes) {
            const notesList = document.getElementById('notesList');
            const pinnedNotesList = document.getElementById('pinnedNotesList');
            const pinnedSection = document.getElementById('pinnedNotesSection');
            
            notesList.innerHTML = '';
            pinnedNotesList.innerHTML = '';
            
            const searchTerm = document.getElementById('notesSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('notesCategory').value;
            
            let hasPinnedNotes = false;
            
            Object.entries(notes).forEach(([key, note]) => {
                // Apply filters
                const matchesSearch = !searchTerm || 
                    note.title.toLowerCase().includes(searchTerm) || 
                    note.content.toLowerCase().includes(searchTerm);
                
                const matchesCategory = !categoryFilter || note.category === categoryFilter;
                
                if (matchesSearch && matchesCategory) {
                    const noteCard = createNoteCard(key, note);
                    
                    if (note.pinned) {
                        pinnedNotesList.appendChild(noteCard);
                        hasPinnedNotes = true;
                    } else {
                        notesList.appendChild(noteCard);
                    }
                }
            });
            
            // Show/hide pinned section
            if (hasPinnedNotes) {
                pinnedSection.classList.remove('hidden');
            } else {
                pinnedSection.classList.add('hidden');
            }
        }

        // Search functionality
        document.getElementById('notesSearch').addEventListener('input', () => {
            loadNotes();
        });

        document.getElementById('notesCategory').addEventListener('change', () => {
            loadNotes();
        });

        // Mobile menu functionality
        document.getElementById('hamburgerMenu').addEventListener('click', () => {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const hamburger = document.getElementById('hamburgerMenu');
            
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
            hamburger.classList.toggle('active');
        });

        // Close sidebar when clicking overlay
        document.getElementById('sidebarOverlay').addEventListener('click', () => {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const hamburger = document.getElementById('hamburgerMenu');
            
            sidebar.classList.remove('open');
            overlay.classList.remove('show');
            hamburger.classList.remove('active');
        });

        // Close sidebar when selecting a tab on mobile
        document.querySelectorAll('.sidebar-item').forEach(item => {
            item.addEventListener('click', () => {
                // Close mobile menu after selection
                if (window.innerWidth <= 768) {
                    const sidebar = document.querySelector('.sidebar');
                    const overlay = document.getElementById('sidebarOverlay');
                    const hamburger = document.getElementById('hamburgerMenu');
                    
                    sidebar.classList.remove('open');
                    overlay.classList.remove('show');
                    hamburger.classList.remove('active');
                }
            });
        });

        // Dark mode toggle (desktop)
        document.getElementById('darkModeToggle').addEventListener('click', () => {
            toggleDarkMode();
        });

        // Dark mode toggle (mobile)
        document.getElementById('mobileDarkToggle').addEventListener('click', () => {
            toggleDarkMode();
        });

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            
            const desktopToggle = document.getElementById('darkModeToggle');
            const mobileToggle = document.getElementById('mobileDarkToggle');
            
            if (isDarkMode) {
                desktopToggle.textContent = '☀️ Light Mode';
                mobileToggle.textContent = '☀️';
            } else {
                desktopToggle.textContent = '🌙 Dark Mode';
                mobileToggle.textContent = '🌙';
            }
            
            // Save preference
            localStorage.setItem('dcloud_dark_mode', isDarkMode);
        }

        // Load dark mode preference
        function loadDarkModePreference() {
            const savedMode = localStorage.getItem('dcloud_dark_mode');
            if (savedMode === 'true') {
                isDarkMode = true;
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeToggle').textContent = '☀️ Light Mode';
                document.getElementById('mobileDarkToggle').textContent = '☀️';
            }
        }

        function createNoteCard(key, note) {
            const noteCard = document.createElement('div');
            let cardClasses = 'note-card fade-in';
            
            if (note.pinned) {
                cardClasses += ' pinned-note';
            }
            
            if (note.priority) {
                cardClasses += ` priority-${note.priority}`;
            }
            
            noteCard.className = cardClasses;
            
            const categoryBadge = note.category && note.category !== 'uncategorized' 
                ? `<span class="category-${note.category}">${note.category.toUpperCase()}</span>` 
                : '';
            
            const pinnedIcon = note.pinned ? '📌 ' : '';
            const privateIcon = note.private ? '🔒 ' : '';
            
            noteCard.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <h3 class="font-semibold text-lg">${pinnedIcon}${privateIcon}${note.title}</h3>
                            ${categoryBadge}
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="pinNote('${key}', ${!note.pinned})" class="text-yellow-500 hover:text-yellow-700" title="${note.pinned ? 'Unpin' : 'Pin'}">${note.pinned ? '📌' : '📍'}</button>
                        <button onclick="shareNote('${key}')" class="share-button">Share</button>
                        <button onclick="editNote('${key}')" class="text-blue-500 hover:text-blue-700">✏️</button>
                        <button onclick="deleteNote('${key}')" class="text-red-500 hover:text-red-700">🗑️</button>
                    </div>
                </div>
                <p class="text-gray-600 mb-3 line-clamp-3" onclick="viewNote('${key}')" style="cursor: pointer;">${note.private ? '🔒 Private note - Click to view' : note.content}</p>
                <div class="flex justify-between items-center">
                    <p class="text-xs text-gray-400">${new Date(note.createdAt).toLocaleDateString()}</p>
                    <span class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-600">${note.priority || 'medium'} priority</span>
                </div>
            `;
            return noteCard;
        }

        function pinNote(noteKey, shouldPin) {
            database.ref(`users/${currentUser.uid}/notes/${noteKey}/pinned`).set(shouldPin).then(() => {
                showToast(shouldPin ? 'Note pinned!' : 'Note unpinned!');
            }).catch((error) => {
                console.error('Pin note error:', error);
                showToast('Failed to update note', 'error');
            });
        }

        function editNote(noteKey) {
            database.ref(`users/${currentUser.uid}/notes/${noteKey}`).once('value').then((snapshot) => {
                const note = snapshot.val();
                
                if (note) {
                    // Populate modal with existing data
                    document.getElementById('noteTitle').value = note.title;
                    document.getElementById('noteContent').value = note.content;
                    document.getElementById('noteCategory').value = note.category || '';
                    document.getElementById('notePriority').value = note.priority || 'medium';
                    document.getElementById('notePin').checked = note.pinned || false;
                    document.getElementById('notePrivate').checked = note.private || false;
                    
                    if (note.private) {
                        document.getElementById('privateNotePassword').classList.remove('hidden');
                        document.getElementById('notePassword').value = note.password || '';
                    }
                    
                    // Change save button to update
                    const saveBtn = document.getElementById('saveNote');
                    saveBtn.textContent = 'Update Note';
                    saveBtn.onclick = () => updateNote(noteKey);
                    
                    showModal('noteModal');
                }
            });
        }

        function updateNote(noteKey) {
            const title = document.getElementById('noteTitle').value;
            const content = document.getElementById('noteContent').value;
            const category = document.getElementById('noteCategory').value;
            const priority = document.getElementById('notePriority').value;
            const isPinned = document.getElementById('notePin').checked;
            const isPrivate = document.getElementById('notePrivate').checked;
            const password = document.getElementById('notePassword').value;
            
            if (!title || !content) {
                showToast('Please fill all fields', 'error');
                return;
            }

            if (isPrivate && !password) {
                showToast('Please set a password for private note', 'error');
                return;
            }
            
            const noteData = {
                title,
                content,
                category: category || 'uncategorized',
                priority: priority || 'medium',
                pinned: isPinned,
                private: isPrivate,
                password: isPrivate ? password : null,
                updatedAt: Date.now()
            };
            
            database.ref(`users/${currentUser.uid}/notes/${noteKey}`).update(noteData).then(() => {
                hideModal('noteModal');
                clearNoteModal();
                resetSaveButton();
                loadNotes();
                showToast('Note updated successfully!');
            });
        }

        function resetSaveButton() {
            const saveBtn = document.getElementById('saveNote');
            saveBtn.textContent = 'Save Note';
            saveBtn.onclick = () => document.getElementById('saveNote').click();
        }

        function viewNote(noteKey) {
            database.ref(`users/${currentUser.uid}/notes/${noteKey}`).once('value').then((snapshot) => {
                const note = snapshot.val();
                if (note && note.private) {
                    showModal('privateNoteModal');
                    document.getElementById('accessPrivateNote').onclick = () => {
                        const enteredPassword = document.getElementById('privateNotePasswordInput').value;
                        if (enteredPassword === note.password) {
                            hideModal('privateNoteModal');
                            showNoteContent(note);
                            document.getElementById('privateNotePasswordInput').value = '';
                        } else {
                            showToast('Incorrect password', 'error');
                        }
                    };
                } else if (note) {
                    showNoteContent(note);
                }
            });
        }

        function showNoteContent(note) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay show';
            modal.innerHTML = `
                <div class="modal">
                    <h3 class="text-2xl font-bold mb-4">${note.title}</h3>
                    <div class="mb-4">
                        <span class="category-${note.category || 'uncategorized'}">${(note.category || 'uncategorized').toUpperCase()}</span>
                        <span class="ml-2 text-sm text-gray-600">${note.priority || 'medium'} priority</span>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg mb-4 max-h-96 overflow-y-auto">
                        <p class="whitespace-pre-wrap">${note.content}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="premium-button w-full">Close</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        let pendingSecurityAction = null;

        function requireSecurity(callback) {
            pendingSecurityAction = callback;
            showModal('securityModal');
        }

        // Security modal tabs
        document.getElementById('mpinTab').addEventListener('click', () => {
            document.getElementById('mpinTab').classList.add('active');
            document.getElementById('psCodeTab').classList.remove('active');
            document.getElementById('mpinTab').style.background = '';
            document.getElementById('psCodeTab').style.background = '#8E8E93';
            document.getElementById('mpinVerification').classList.remove('hidden');
            document.getElementById('psCodeVerification').classList.add('hidden');
        });

        document.getElementById('psCodeTab').addEventListener('click', () => {
            document.getElementById('psCodeTab').classList.add('active');
            document.getElementById('mpinTab').classList.remove('active');
            document.getElementById('psCodeTab').style.background = '';
            document.getElementById('mpinTab').style.background = '#8E8E93';
            document.getElementById('psCodeVerification').classList.remove('hidden');
            document.getElementById('mpinVerification').classList.add('hidden');
        });

        document.getElementById('confirmSecurity').addEventListener('click', () => {
            const mpinActive = !document.getElementById('mpinVerification').classList.contains('hidden');
            
            if (mpinActive) {
                const enteredMPIN = document.getElementById('verifyMPIN').value;
                if (enteredMPIN === userMPIN) {
                    hideModal('securityModal');
                    if (pendingSecurityAction) {
                        pendingSecurityAction();
                        pendingSecurityAction = null;
                    }
                    document.getElementById('verifyMPIN').value = '';
                } else {
                    showToast('Invalid MPIN', 'error');
                }
            } else {
                const enteredPSCode = document.getElementById('verifyPSCode').value;
                if (enteredPSCode === userProfile.psCode) {
                    hideModal('securityModal');
                    if (pendingSecurityAction) {
                        pendingSecurityAction();
                        pendingSecurityAction = null;
                    }
                    document.getElementById('verifyPSCode').value = '';
                } else {
                    showToast('Invalid PS Code', 'error');
                }
            }
        });

        document.getElementById('cancelSecurity').addEventListener('click', () => {
            hideModal('securityModal');
            pendingSecurityAction = null;
            document.getElementById('verifyMPIN').value = '';
            document.getElementById('verifyPSCode').value = '';
        });

        document.getElementById('cancelPrivateNote').addEventListener('click', () => {
            hideModal('privateNoteModal');
            document.getElementById('privateNotePasswordInput').value = '';
        });

        function shareNote(noteKey) {
            database.ref(`users/${currentUser.uid}/notes/${noteKey}`).once('value').then((snapshot) => {
                const note = snapshot.val();
                
                if (note) {
                    // Create shared note
                    const sharedNoteData = {
                        title: note.title,
                        content: note.content,
                        category: note.category,
                        priority: note.priority,
                        createdAt: note.createdAt,
                        sharedBy: userProfile.name,
                        contentType: 'note'
                    };
                    
                    database.ref(`shared_notes/${noteKey}`).set(sharedNoteData).then(() => {
                        const shareUrl = `${window.location.origin}${window.location.pathname}#${noteKey}`;
                        copyToClipboard(shareUrl);
                        showToast('Share link copied to clipboard!');
                        
                        // Mark note as shared
                        database.ref(`users/${currentUser.uid}/notes/${noteKey}/shared`).set(true);
                    });
                }
            });
        }

        function deleteNote(noteKey) {
            const confirmModal = document.createElement('div');
            confirmModal.className = 'modal-overlay show';
            confirmModal.innerHTML = `
                <div class="modal">
                    <h3 class="text-2xl font-bold mb-4">🗑️ Delete Note</h3>
                    <p class="text-gray-600 mb-6">Are you sure you want to delete this note? This action cannot be undone.</p>
                    <div class="flex gap-3">
                        <button onclick="confirmDelete('${noteKey}', this)" class="premium-button flex-1" style="background: #FF3B30;">Delete</button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="premium-button flex-1" style="background: #8E8E93;">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmModal);
        }

        function confirmDelete(noteKey, button) {
            database.ref(`users/${currentUser.uid}/notes/${noteKey}`).remove().then(() => {
                showToast('Note deleted successfully!');
                button.parentElement.parentElement.parentElement.remove();
            }).catch((error) => {
                console.error('Delete note error:', error);
                showToast('Failed to delete note: ' + error.message, 'error');
            });
        }

        // Images Management
        document.getElementById('browseBtn').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        // Drag and Drop
        const dropZone = document.getElementById('dropZone');
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            handleFileUpload(files);
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handleFileUpload(files);
        });

        function compressImage(file, maxWidth = 1920, quality = 0.8) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = () => {
                    // Calculate new dimensions
                    let { width, height } = img;
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Draw and compress
                    ctx.drawImage(img, 0, 0, width, height);
                    canvas.toBlob(resolve, 'image/jpeg', quality);
                };
                
                img.src = URL.createObjectURL(file);
            });
        }

        function handleFileUpload(files) {
            files.forEach(async file => {
                if (file.size > 20 * 1024 * 1024) {
                    showToast('File size should be less than 20MB', 'error');
                    return;
                }

                let processedFile = file;
                let fileData;

                // Compress images
                if (file.type.startsWith('image/')) {
                    try {
                        processedFile = await compressImage(file);
                        showToast(`Image compressed: ${file.name}`, 'success');
                    } catch (error) {
                        console.warn('Compression failed, using original:', error);
                    }
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const finalSize = processedFile.size || file.size;
                    
                    // Check storage limit
                    if (userProfile.storageUsed + finalSize > 20 * 1024 * 1024 * 1024) {
                        showToast('Storage limit exceeded! Please delete some files.', 'error');
                        return;
                    }

                    fileData = {
                        name: file.name,
                        originalSize: file.size,
                        size: finalSize,
                        type: file.type,
                        data: e.target.result,
                        uploadedAt: Date.now(),
                        compressed: processedFile !== file
                    };
                    
                    database.ref(`users/${currentUser.uid}/images`).push(fileData).then(() => {
                        userProfile.storageUsed += finalSize;
                        database.ref(`users/${currentUser.uid}/profile/storageUsed`).set(userProfile.storageUsed);
                        updateStorageInfo();
                        loadImages();
                        
                        const fileType = file.type.startsWith('image/') ? 'Image' : 'File';
                        showToast(`${fileType} uploaded successfully!`);
                    });
                };
                reader.readAsDataURL(processedFile);
            });
        }

        function loadImages() {
            database.ref(`users/${currentUser.uid}/images`).on('value', (snapshot) => {
                const images = snapshot.val() || {};
                const imagesList = document.getElementById('imagesList');
                imagesList.innerHTML = '';
                
                Object.entries(images).forEach(([key, image]) => {
                    const imageCard = createImageCard(key, image);
                    imagesList.appendChild(imageCard);
                });
                
                saveToCache('images', images);
            });
        }

        function createImageCard(key, image) {
            const imageCard = document.createElement('div');
            imageCard.className = 'image-card fade-in';
            imageCard.innerHTML = `
                <img src="${image.data}" alt="${image.name}" class="w-full h-48 object-cover">
                <div class="p-4">
                    <h3 class="font-semibold truncate">${image.name}</h3>
                    <p class="text-sm text-gray-600">${(image.size / 1024).toFixed(1)} KB</p>
                    <p class="text-xs text-gray-400">${new Date(image.uploadedAt).toLocaleDateString()}</p>
                    <div class="flex gap-2 mt-2">
                        <button onclick="shareImage('${key}')" class="share-button">Share</button>
                        <button onclick="deleteImage('${key}', ${image.size})" class="text-red-500 hover:text-red-700 text-sm">Delete</button>
                    </div>
                </div>
            `;
            return imageCard;
        }

        function shareImage(imageKey) {
            database.ref(`users/${currentUser.uid}/images/${imageKey}`).once('value').then((snapshot) => {
                const image = snapshot.val();
                if (image) {
                    // Create shared image
                    const sharedImageData = {
                        name: image.name,
                        data: image.data,
                        size: image.size,
                        fileType: image.type,
                        uploadedAt: image.uploadedAt,
                        sharedBy: userProfile.name,
                        contentType: 'image'
                    };
                    
                    database.ref(`shared_images/${imageKey}`).set(sharedImageData).then(() => {
                        const shareUrl = `https://pulse.oriontec.xyz/dcloud.html#${imageKey}`;
                        copyToClipboard(shareUrl);
                        showToast('Image share link copied to clipboard!');
                        
                        // Update image to mark as shared
                        database.ref(`users/${currentUser.uid}/images/${imageKey}/shared`).set(true);
                    });
                }
            });
        }

        function deleteImage(imageKey, size) {
            if (confirm('Are you sure you want to delete this image?')) {
                database.ref(`users/${currentUser.uid}/images/${imageKey}`).remove().then(() => {
                    userProfile.storageUsed -= size;
                    database.ref(`users/${currentUser.uid}/profile/storageUsed`).set(userProfile.storageUsed);
                    updateStorageInfo();
                    showToast('Image deleted successfully!');
                });
            }
        }

        // Calendar Management
        document.getElementById('saveEvent').addEventListener('click', () => {
            const title = document.getElementById('eventTitle').value;
            const date = document.getElementById('eventDate').value;
            const time = document.getElementById('eventTime').value;
            const description = document.getElementById('eventDescription').value;
            const priority = document.getElementById('eventPriority').value;
            const hasReminder = document.getElementById('eventReminder').checked;
            const reminderTime = document.getElementById('reminderTime').value;
            
            if (!title || !date) {
                showToast('Please fill required fields', 'error');
                return;
            }
            
            const eventData = {
                title,
                date,
                time,
                description,
                priority: priority || 'medium',
                reminder: hasReminder,
                reminderMinutes: hasReminder ? parseInt(reminderTime) : null,
                createdAt: Date.now()
            };
            
            database.ref(`users/${currentUser.uid}/events`).push(eventData).then(() => {
                hideModal('eventModal');
                clearEventModal();
                loadEvents();
                showToast('Event saved successfully!');
                
                // Schedule notification if reminder is set
                if (hasReminder && time) {
                    scheduleNotification(eventData);
                }
            });
        });

        function clearEventModal() {
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventDate').value = '';
            document.getElementById('eventTime').value = '';
            document.getElementById('eventDescription').value = '';
            document.getElementById('eventPriority').value = 'medium';
            document.getElementById('eventReminder').checked = false;
            document.getElementById('reminderOptions').classList.add('hidden');
        }

        // Notification System
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showToast('Notifications enabled for reminders!');
                    }
                });
            }
        }

        function scheduleNotification(event) {
            if (!('Notification' in window) || Notification.permission !== 'granted') {
                return;
            }

            const eventDateTime = new Date(`${event.date}T${event.time || '00:00'}`);
            const reminderTime = new Date(eventDateTime.getTime() - (event.reminderMinutes * 60 * 1000));
            const now = new Date();

            if (reminderTime > now) {
                const timeUntilReminder = reminderTime.getTime() - now.getTime();
                
                setTimeout(() => {
                    new Notification(`📅 Event Reminder: ${event.title}`, {
                        body: `Starting ${event.reminderMinutes === 0 ? 'now' : `in ${event.reminderMinutes} minutes`}`,
                        icon: '☁️',
                        tag: `event-${event.createdAt}`,
                        requireInteraction: true
                    });
                    
                    // Also show in-app notification
                    showInAppNotification(event);
                }, timeUntilReminder);
            }
        }

        function showInAppNotification(event) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 right-4 bg-blue-500 text-white p-4 rounded-lg shadow-lg z-50 max-w-sm';
            notification.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="text-2xl">📅</div>
                    <div class="flex-1">
                        <h4 class="font-semibold">Event Reminder</h4>
                        <p class="text-sm">${event.title}</p>
                        <p class="text-xs opacity-80">${event.date} ${event.time || ''}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:text-gray-200">✕</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 10000);
        }

        // Check for upcoming events on load
        function checkUpcomingEvents() {
            if (!currentUser) return;
            
            database.ref(`users/${currentUser.uid}/events`).once('value').then((snapshot) => {
                const events = snapshot.val() || {};
                const now = new Date();
                
                Object.values(events).forEach(event => {
                    if (event.reminder && event.time) {
                        scheduleNotification(event);
                    }
                });
            });
        }

        document.getElementById('cancelEvent').addEventListener('click', () => {
            hideModal('eventModal');
        });

        function loadEvents() {
            database.ref(`users/${currentUser.uid}/events`).on('value', (snapshot) => {
                const events = snapshot.val() || {};
                const eventsList = document.getElementById('eventsList');
                eventsList.innerHTML = '';
                
                Object.entries(events).forEach(([key, event]) => {
                    const eventCard = createEventCard(key, event);
                    eventsList.appendChild(eventCard);
                });
                
                generateCalendar(events);
                saveToCache('events', events);
            });
        }

        function createEventCard(key, event) {
            const eventCard = document.createElement('div');
            eventCard.className = 'glass-card p-4 fade-in';
            eventCard.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="font-semibold text-lg">${event.title}</h3>
                        <p class="text-blue-600 text-sm">📅 ${event.date} ${event.time ? '⏰ ' + event.time : ''}</p>
                        ${event.description ? `<p class="text-gray-600 text-sm mt-2">${event.description}</p>` : ''}
                    </div>
                    <button onclick="deleteEvent('${key}')" class="text-red-500 hover:text-red-700">🗑️</button>
                </div>
            `;
            return eventCard;
        }

        function generateCalendar(events) {
            const calendarView = document.getElementById('calendarView');
            calendarView.innerHTML = '';
            
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            // Generate calendar days (simplified version)
            for (let day = 1; day <= 31; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                
                // Check if day has events
                const dayStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const hasEvent = Object.values(events).some(event => event.date === dayStr);
                
                if (hasEvent) {
                    dayElement.classList.add('has-event');
                }
                
                calendarView.appendChild(dayElement);
            }
        }

        function deleteEvent(eventKey) {
            if (confirm('Are you sure you want to delete this event?')) {
                database.ref(`users/${currentUser.uid}/events/${eventKey}`).remove().then(() => {
                    showToast('Event deleted successfully!');
                });
            }
        }

        // Location Management
        document.getElementById('getCurrentLocation').addEventListener('click', () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    document.getElementById('locationAddress').value = `${lat}, ${lng}`;
                    showToast('Current location added!');
                }, (error) => {
                    showToast('Unable to get location', 'error');
                });
            } else {
                showToast('Geolocation not supported', 'error');
            }
        });

        document.getElementById('saveLocation').addEventListener('click', () => {
            const name = document.getElementById('locationName').value;
            const address = document.getElementById('locationAddress').value;
            const notes = document.getElementById('locationNotes').value;
            
            if (!name || !address) {
                showToast('Please fill required fields', 'error');
                return;
            }
            
            const locationData = {
                name,
                address,
                notes,
                createdAt: Date.now()
            };
            
            database.ref(`users/${currentUser.uid}/locations`).push(locationData).then(() => {
                hideModal('locationModal');
                document.getElementById('locationName').value = '';
                document.getElementById('locationAddress').value = '';
                document.getElementById('locationNotes').value = '';
                loadLocations();
                showToast('Location saved successfully!');
            });
        });

        document.getElementById('cancelLocation').addEventListener('click', () => {
            hideModal('locationModal');
        });

        function loadLocations() {
            database.ref(`users/${currentUser.uid}/locations`).on('value', (snapshot) => {
                const locations = snapshot.val() || {};
                const locationsList = document.getElementById('locationsList');
                locationsList.innerHTML = '';
                
                Object.entries(locations).forEach(([key, location]) => {
                    const locationCard = createLocationCard(key, location);
                    locationsList.appendChild(locationCard);
                });
                
                saveToCache('locations', locations);
            });
        }

        function createLocationCard(key, location) {
            const locationCard = document.createElement('div');
            locationCard.className = 'location-card fade-in';
            locationCard.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <h3 class="font-semibold text-lg">${location.name}</h3>
                    <button onclick="deleteLocation('${key}')" class="text-red-500 hover:text-red-700">🗑️</button>
                </div>
                <p class="text-blue-600 text-sm mb-2">📍 ${location.address}</p>
                ${location.notes ? `<p class="text-gray-600 text-sm mb-3">${location.notes}</p>` : ''}
                <p class="text-xs text-gray-400 mb-3">${new Date(location.createdAt).toLocaleDateString()}</p>
                <button onclick="openInMaps('${location.address}')" class="premium-button text-sm">Open in Maps</button>
            `;
            return locationCard;
        }

        function deleteLocation(locationKey) {
            if (confirm('Are you sure you want to delete this location?')) {
                database.ref(`users/${currentUser.uid}/locations/${locationKey}`).remove().then(() => {
                    showToast('Location deleted successfully!');
                });
            }
        }

        function openInMaps(address) {
            const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
            window.open(url, '_blank', 'noopener,noreferrer');
        }

        // Settings
        function loadSettings() {
            document.getElementById('settingsName').textContent = userProfile.name;
            document.getElementById('settingsEmail').textContent = userProfile.email;
            document.getElementById('settingsMobile').textContent = userProfile.mobile;
            document.getElementById('settingsDob').textContent = userProfile.dob;
            document.getElementById('settingsPsCode').textContent = userProfile.psCode;
        }

        // Export Functions
        document.getElementById('exportNotesBtn').addEventListener('click', () => {
            const exportModal = document.createElement('div');
            exportModal.className = 'modal-overlay show';
            exportModal.innerHTML = `
                <div class="modal">
                    <h3 class="text-2xl font-bold mb-6">📝 Export Notes</h3>
                    <p class="text-gray-600 mb-6">Choose export format:</p>
                    <div class="space-y-3">
                        <button onclick="exportNotesAsJSON()" class="premium-button w-full">📄 Export as JSON</button>
                        <button onclick="exportNotesAsPDF()" class="premium-button w-full">📋 Export as PDF</button>
                        <button onclick="exportNotesAsText()" class="premium-button w-full">📝 Export as Text</button>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="premium-button w-full mt-4" style="background: #8E8E93;">Cancel</button>
                </div>
            `;
            document.body.appendChild(exportModal);
        });

        function exportNotesAsJSON() {
            database.ref(`users/${currentUser.uid}/notes`).once('value').then((snapshot) => {
                const notes = snapshot.val() || {};
                downloadJSON(notes, 'dcloud-notes.json');
                showToast('Notes exported as JSON!');
                document.querySelector('.modal-overlay').remove();
            });
        }

        function exportNotesAsText() {
            database.ref(`users/${currentUser.uid}/notes`).once('value').then((snapshot) => {
                const notes = snapshot.val() || {};
                let textContent = `DCloud Notes Export\nGenerated: ${new Date().toLocaleString()}\n\n`;
                
                Object.values(notes).forEach((note, index) => {
                    textContent += `${index + 1}. ${note.title}\n`;
                    textContent += `Category: ${note.category || 'Uncategorized'}\n`;
                    textContent += `Priority: ${note.priority || 'Medium'}\n`;
                    textContent += `Created: ${new Date(note.createdAt).toLocaleString()}\n`;
                    textContent += `Content:\n${note.content}\n`;
                    textContent += `${'='.repeat(50)}\n\n`;
                });
                
                downloadText(textContent, 'dcloud-notes.txt');
                showToast('Notes exported as text!');
                document.querySelector('.modal-overlay').remove();
            });
        }

        function exportNotesAsPDF() {
            database.ref(`users/${currentUser.uid}/notes`).once('value').then((snapshot) => {
                const notes = snapshot.val() || {};
                generatePDF(notes);
                showToast('Notes exported as PDF!');
                document.querySelector('.modal-overlay').remove();
            });
        }

        function generatePDF(notes) {
            // Create a new window for PDF generation
            const printWindow = window.open('', '_blank');
            
            let htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>DCloud Notes Export</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
                        .header { text-align: center; margin-bottom: 40px; border-bottom: 2px solid #007AFF; padding-bottom: 20px; }
                        .note { margin-bottom: 30px; page-break-inside: avoid; }
                        .note-title { font-size: 18px; font-weight: bold; color: #007AFF; margin-bottom: 10px; }
                        .note-meta { font-size: 12px; color: #666; margin-bottom: 15px; }
                        .note-content { background: #f9f9f9; padding: 15px; border-radius: 8px; white-space: pre-wrap; }
                        .category { background: #007AFF; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px; }
                        .priority-high { border-left: 4px solid #FF3B30; }
                        .priority-medium { border-left: 4px solid #FF9500; }
                        .priority-low { border-left: 4px solid #34C759; }
                        @media print {
                            body { margin: 20px; }
                            .note { page-break-inside: avoid; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>☁️ DCloud Notes Export</h1>
                        <p>Generated on ${new Date().toLocaleString()}</p>
                        <p>Total Notes: ${Object.keys(notes).length}</p>
                    </div>
            `;
            
            Object.values(notes).forEach((note, index) => {
                const priorityClass = note.priority ? `priority-${note.priority}` : 'priority-medium';
                htmlContent += `
                    <div class="note ${priorityClass}">
                        <div class="note-title">${index + 1}. ${note.title}</div>
                        <div class="note-meta">
                            <span class="category">${(note.category || 'Uncategorized').toUpperCase()}</span>
                            | Priority: ${(note.priority || 'Medium').toUpperCase()}
                            | Created: ${new Date(note.createdAt).toLocaleString()}
                            ${note.pinned ? ' | 📌 PINNED' : ''}
                            ${note.private ? ' | 🔒 PRIVATE' : ''}
                        </div>
                        <div class="note-content">${note.content}</div>
                    </div>
                `;
            });
            
            htmlContent += `
                </body>
                </html>
            `;
            
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            
            // Wait for content to load then print
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        function downloadText(content, filename) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        document.getElementById('exportImagesBtn').addEventListener('click', () => {
            database.ref(`users/${currentUser.uid}/images`).once('value').then((snapshot) => {
                const images = snapshot.val() || {};
                downloadJSON(images, 'dcloud-images.json');
                showToast('Images exported successfully!');
            });
        });

        document.getElementById('exportCalendarBtn').addEventListener('click', () => {
            database.ref(`users/${currentUser.uid}/events`).once('value').then((snapshot) => {
                const events = snapshot.val() || {};
                downloadJSON(events, 'dcloud-calendar.json');
                showToast('Calendar exported successfully!');
            });
        });

        document.getElementById('exportAllBtn').addEventListener('click', () => {
            Promise.all([
                database.ref(`users/${currentUser.uid}/notes`).once('value'),
                database.ref(`users/${currentUser.uid}/images`).once('value'),
                database.ref(`users/${currentUser.uid}/events`).once('value'),
                database.ref(`users/${currentUser.uid}/locations`).once('value')
            ]).then(([notesSnapshot, imagesSnapshot, eventsSnapshot, locationsSnapshot]) => {
                const allData = {
                    profile: userProfile,
                    notes: notesSnapshot.val() || {},
                    images: imagesSnapshot.val() || {},
                    events: eventsSnapshot.val() || {},
                    locations: locationsSnapshot.val() || {},
                    exportedAt: new Date().toISOString()
                };
                downloadJSON(allData, 'dcloud-backup.json');
                showToast('All data exported successfully!');
            });
        });

        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Load all data
        function loadAllData() {
            loadNotes();
            loadImages();
            loadEvents();
            loadLocations();
            loadSettings();
        }

        // Shared Content Handling
        function checkForSharedContent() {
            const hash = window.location.hash.substring(1);
            if (hash) {
                // Check for shared note first
                database.ref(`shared_notes/${hash}`).once('value').then((snapshot) => {
                    if (snapshot.exists()) {
                        const note = snapshot.val();
                        showSharedNote(note);
                    } else {
                        // Check for shared image
                        database.ref(`shared_images/${hash}`).once('value').then((imageSnapshot) => {
                            if (imageSnapshot.exists()) {
                                const image = imageSnapshot.val();
                                showSharedImage(image);
                            }
                        });
                    }
                });
            }
        }

        function showSharedNote(note) {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('sharedNoteView').classList.remove('hidden');
            
            document.getElementById('sharedNoteContent').innerHTML = `
                <div class="text-center mb-6">
                    <div class="text-4xl mb-4">📝</div>
                    <h2 class="text-2xl font-bold mb-2">${note.title}</h2>
                    <p class="text-sm text-gray-600">Shared by ${note.sharedBy} on ${new Date(note.createdAt).toLocaleDateString()}</p>
                </div>
                <div class="bg-gray-50 p-6 rounded-lg">
                    <p class="whitespace-pre-wrap">${note.content}</p>
                </div>
            `;
        }

        function showSharedImage(image) {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('sharedNoteView').classList.remove('hidden');
            
            document.getElementById('sharedNoteContent').innerHTML = `
                <div class="text-center mb-6">
                    <div class="text-4xl mb-4">🖼️</div>
                    <h2 class="text-2xl font-bold mb-2">Shared Image</h2>
                    <p class="text-sm text-gray-600">Shared by ${image.sharedBy} on ${new Date(image.uploadedAt).toLocaleDateString()}</p>
                </div>
                <div class="bg-white p-6 rounded-lg text-center">
                    <img src="${image.data}" alt="${image.name}" class="max-w-full h-auto rounded-lg shadow-lg mx-auto mb-4">
                    <h3 class="text-lg font-semibold mb-2">${image.name}</h3>
                    <p class="text-sm text-gray-600">${(image.size / 1024).toFixed(1)} KB</p>
                </div>
            `;
        }

        document.getElementById('backToApp').addEventListener('click', () => {
            window.location.hash = '';
            document.getElementById('sharedNoteView').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            auth.signOut().then(() => {
                currentUser = null;
                userProfile = null;
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                showToast('Signed out successfully!');
            });
        });

        // Auth state observer
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                checkUserProfile();
            } else {
                checkForSharedContent();
            }
        });

        // Settings Functions
        document.getElementById('editProfileBtn').addEventListener('click', () => {
            const editModal = document.createElement('div');
            editModal.className = 'modal-overlay show';
            editModal.innerHTML = `
                <div class="modal">
                    <h3 class="text-2xl font-bold mb-6">✏️ Edit Profile</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Full Name</label>
                            <input type="text" id="editName" class="input-field" value="${userProfile.name}">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">Mobile Number</label>
                            <input type="tel" id="editMobile" class="input-field" value="${userProfile.mobile}">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">Date of Birth</label>
                            <input type="date" id="editDob" class="input-field" value="${userProfile.dob}">
                        </div>
                        <div class="flex gap-3">
                            <button onclick="saveProfileChanges()" class="premium-button flex-1">Save Changes</button>
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" class="premium-button flex-1" style="background: #8E8E93;">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(editModal);
        });

        function saveProfileChanges() {
            const newName = document.getElementById('editName').value;
            const newMobile = document.getElementById('editMobile').value;
            const newDob = document.getElementById('editDob').value;

            if (!newName || !newMobile || !newDob) {
                showToast('Please fill all fields', 'error');
                return;
            }

            const updates = {
                name: newName,
                mobile: newMobile,
                dob: newDob,
                updatedAt: Date.now()
            };

            // Update Firebase database
            database.ref(`users/${currentUser.uid}/profile`).update(updates).then(() => {
                userProfile = { ...userProfile, ...updates };
                loadSettings();
                document.querySelector('.modal-overlay').remove();
                showToast('Profile updated successfully!');
            }).catch((error) => {
                console.error('Profile update error:', error);
                showToast('Failed to update profile: ' + error.message, 'error');
            });
        }

        document.getElementById('changeMPINBtn').addEventListener('click', () => {
            const mpinModal = document.createElement('div');
            mpinModal.className = 'modal-overlay show';
            mpinModal.innerHTML = `
                <div class="modal">
                    <h3 class="text-2xl font-bold mb-6">🔐 Change MPIN</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">New MPIN (4-6 digits)</label>
                            <input type="password" id="newMPIN" class="input-field" placeholder="Enter new MPIN" maxlength="6">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">Confirm New MPIN</label>
                            <input type="password" id="confirmNewMPIN" class="input-field" placeholder="Confirm new MPIN" maxlength="6">
                        </div>
                        <div class="flex gap-3">
                            <button onclick="saveNewMPIN()" class="premium-button flex-1">Change MPIN</button>
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" class="premium-button flex-1" style="background: #8E8E93;">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(mpinModal);
        });

        function saveNewMPIN() {
            const newMPIN = document.getElementById('newMPIN').value;
            const confirmMPIN = document.getElementById('confirmNewMPIN').value;

            if (!newMPIN || newMPIN.length < 4 || newMPIN.length > 6) {
                showToast('MPIN must be 4-6 digits', 'error');
                return;
            }

            if (newMPIN !== confirmMPIN) {
                showToast('MPIN does not match', 'error');
                return;
            }

            // Update Firebase database
            database.ref(`users/${currentUser.uid}/profile/mpin`).set(newMPIN).then(() => {
                userMPIN = newMPIN;
                userProfile.mpin = newMPIN;
                document.querySelector('.modal-overlay').remove();
                showToast('MPIN changed successfully!');
            }).catch((error) => {
                console.error('MPIN update error:', error);
                showToast('Failed to change MPIN: ' + error.message, 'error');
            });
        }

        document.getElementById('regeneratePSCodeBtn').addEventListener('click', () => {
            const confirmModal = document.createElement('div');
            confirmModal.className = 'modal-overlay show';
            confirmModal.innerHTML = `
                <div class="modal">
                    <h3 class="text-2xl font-bold mb-6">🔄 Regenerate PS Code</h3>
                    <p class="text-gray-600 mb-6">⚠️ This will generate a new PS Code. Your old code will no longer work. Make sure to save the new code securely.</p>
                    <div class="flex gap-3">
                        <button onclick="generateNewPSCode()" class="premium-button flex-1" style="background: #FF9500;">Generate New Code</button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="premium-button flex-1" style="background: #8E8E93;">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmModal);
        });

        function generateNewPSCode() {
            const newPSCode = generatePSCode();
            
            // Update Firebase database
            database.ref(`users/${currentUser.uid}/profile/psCode`).set(newPSCode).then(() => {
                userProfile.psCode = newPSCode;
                document.getElementById('settingsPsCode').textContent = newPSCode;
                document.querySelector('.modal-overlay').remove();
            }).catch((error) => {
                console.error('PS Code update error:', error);
                showToast('Failed to regenerate PS Code: ' + error.message, 'error');
                return;
            });
            
            // Show new code modal
            const newCodeModal = document.createElement('div');
            newCodeModal.className = 'modal-overlay show';
            newCodeModal.innerHTML = `
                <div class="modal">
                    <h3 class="text-2xl font-bold mb-6">🔐 New PS Code Generated</h3>
                    <div class="ps-code-display mb-4">
                        <span>${newPSCode}</span>
                    </div>
                    <div class="flex gap-3 mb-4">
                        <button onclick="copyToClipboard('${newPSCode}')" class="premium-button flex-1">📋 Copy Code</button>
                        <button onclick="window.print()" class="premium-button flex-1">📸 Screenshot</button>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">⚠️ Save this code securely. You'll need it for account recovery.</p>
                    <button onclick="this.parentElement.parentElement.remove()" class="premium-button w-full">I've Saved It Safely</button>
                </div>
            `;
            document.body.appendChild(newCodeModal);
            showToast('New PS Code generated successfully!');
        }

        document.getElementById('enableNotifications').addEventListener('change', (e) => {
            if (e.target.checked) {
                requestNotificationPermission();
            }
        });

        document.getElementById('testNotificationBtn').addEventListener('click', () => {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('🔔 DCloud Test Notification', {
                    body: 'Notifications are working perfectly!',
                    icon: '☁️'
                });
                showToast('Test notification sent!');
            } else {
                showToast('Please enable notifications first', 'error');
            }
        });

        document.getElementById('clearAllDataBtn').addEventListener('click', () => {
            const confirmModal = document.createElement('div');
            confirmModal.className = 'modal-overlay show';
            confirmModal.innerHTML = `
                <div class="modal">
                    <h3 class="text-2xl font-bold mb-6 text-red-600">🗑️ Clear All Data</h3>
                    <p class="text-gray-600 mb-6">⚠️ This will permanently delete ALL your notes, images, events, and locations. This action cannot be undone.</p>
                    <div class="mb-4">
                        <label class="block text-sm font-semibold mb-2">Type "DELETE ALL" to confirm:</label>
                        <input type="text" id="confirmClearText" class="input-field" placeholder="DELETE ALL">
                    </div>
                    <div class="flex gap-3">
                        <button onclick="confirmClearAllData()" class="premium-button flex-1" style="background: #FF3B30;">Clear All Data</button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="premium-button flex-1" style="background: #8E8E93;">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmModal);
        });

        function confirmClearAllData() {
            const confirmText = document.getElementById('confirmClearText').value;
            if (confirmText !== 'DELETE ALL') {
                showToast('Please type "DELETE ALL" to confirm', 'error');
                return;
            }

            // Clear all Firebase data
            Promise.all([
                database.ref(`users/${currentUser.uid}/notes`).remove(),
                database.ref(`users/${currentUser.uid}/images`).remove(),
                database.ref(`users/${currentUser.uid}/events`).remove(),
                database.ref(`users/${currentUser.uid}/locations`).remove(),
                database.ref(`users/${currentUser.uid}/profile/storageUsed`).set(0)
            ]).then(() => {
                userProfile.storageUsed = 0;
                updateStorageInfo();
                loadAllData();
                document.querySelector('.modal-overlay').remove();
                showToast('All data cleared successfully!');
            }).catch((error) => {
                console.error('Clear data error:', error);
                showToast('Failed to clear data: ' + error.message, 'error');
            });
        }

        document.getElementById('deleteAccountBtn').addEventListener('click', () => {
            const confirmModal = document.createElement('div');
            confirmModal.className = 'modal-overlay show';
            confirmModal.innerHTML = `
                <div class="modal">
                    <h3 class="text-2xl font-bold mb-6 text-red-600">❌ Delete Account</h3>
                    <p class="text-gray-600 mb-6">⚠️ This will permanently delete your account and ALL data. This action cannot be undone.</p>
                    <div class="mb-4">
                        <label class="block text-sm font-semibold mb-2">Type "DELETE ACCOUNT" to confirm:</label>
                        <input type="text" id="confirmDeleteText" class="input-field" placeholder="DELETE ACCOUNT">
                    </div>
                    <div class="flex gap-3">
                        <button onclick="confirmDeleteAccount()" class="premium-button flex-1" style="background: #FF3B30;">Delete Account</button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="premium-button flex-1" style="background: #8E8E93;">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmModal);
        });

        function confirmDeleteAccount() {
            const confirmText = document.getElementById('confirmDeleteText').value;
            if (confirmText !== 'DELETE ACCOUNT') {
                showToast('Please type "DELETE ACCOUNT" to confirm', 'error');
                return;
            }

            // Delete all user data
            database.ref(`users/${currentUser.uid}`).remove().then(() => {
                // Delete Firebase Auth account
                currentUser.delete().then(() => {
                    showToast('Account deleted successfully');
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                }).catch(() => {
                    showToast('Account data deleted, please sign out manually', 'error');
                });
            });
        }

        // Event reminder toggle
        document.getElementById('eventReminder').addEventListener('change', (e) => {
            const reminderOptions = document.getElementById('reminderOptions');
            if (e.target.checked) {
                reminderOptions.classList.remove('hidden');
                requestNotificationPermission();
            } else {
                reminderOptions.classList.add('hidden');
            }
        });

        // Initialize welcome note for new users
        function initializeWelcomeNote() {
            if (!currentUser) return;
            
            database.ref(`users/${currentUser.uid}/notes`).once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    // Create welcome note for new users
                    const welcomeNote = {
                        id: 'welcome_' + Date.now(),
                        title: 'Welcome to DCloud! 🎉',
                        content: 'This is your first note in DCloud. You can create, edit, and organize your notes with categories and priorities.\n\nTry creating a new note using the + button!',
                        category: 'personal',
                        priority: 'high',
                        pinned: true,
                        private: false,
                        createdAt: Date.now(),
                        shared: false
                    };
                    
                    database.ref(`users/${currentUser.uid}/notes/welcome_${Date.now()}`).set(welcomeNote);
                }
            });
        }

        // Initialize
        loadDarkModePreference();
        checkForSharedContent();
        
        // Initialize dashboard functions
        function showDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('profileSetupScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            
            document.getElementById('userName').textContent = userProfile.name;
            document.getElementById('userAvatar').src = currentUser.photoURL;
            
            updateStorageInfo();
            loadAllData();
            checkUpcomingEvents();
            initializeWelcomeNote();
            
            // Check notification permission
            if ('Notification' in window && Notification.permission === 'granted') {
                document.getElementById('enableNotifications').checked = true;
            }
        }
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98ff4e2e30628fcd',t:'MTc2MDY5ODk2NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
