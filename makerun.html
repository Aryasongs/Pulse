<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MakeRun AI Assistant</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Google+Sans:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Google Sans', sans-serif;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        input, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        
        body {
            touch-action: manipulation;
            -webkit-touch-callout: none;
            -webkit-text-size-adjust: 100%;
        }
        
        .chat-message {
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .typing-dots {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .typing-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4285f4;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
        }
        
        .message-user {
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
        }
        
        .message-ai {
            background: #f8f9fa;
            border: 1px solid #e8eaed;
        }
        
        .input-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        
        .suggestion-chip {
            background: rgba(66, 133, 244, 0.1);
            border: 1px solid rgba(66, 133, 244, 0.2);
            transition: all 0.2s ease;
        }
        
        .suggestion-chip:hover {
            background: rgba(66, 133, 244, 0.2);
            transform: translateY(-1px);
        }
        
        .scroll-smooth {
            scroll-behavior: smooth;
        }
        
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }
        
        .login-modal {
            backdrop-filter: blur(8px);
            background: rgba(0, 0, 0, 0.4);
        }
        
        .sidebar {
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }
        
        .sidebar.open {
            transform: translateX(0);
        }
        
        .chat-item {
            transition: all 0.2s ease;
        }
        
        .chat-item:hover {
            background: rgba(66, 133, 244, 0.1);
        }
        
        .chat-item.active {
            background: rgba(66, 133, 244, 0.2);
            border-left: 3px solid #4285f4;
        }
    </style>
</head>
<body class="bg-white min-h-screen overflow-hidden">
    <!-- Sidebar -->
    <div id="sidebar" class="sidebar fixed left-0 top-0 h-full w-80 bg-white border-r border-gray-200 z-40 overflow-y-auto">
        <div class="p-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-800">Chat History</h2>
                <button id="closeSidebar" class="p-2 hover:bg-gray-100 rounded-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <button id="newChatBtn" class="w-full mt-3 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg flex items-center justify-center space-x-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                <span>New Chat</span>
            </button>
        </div>
        <div id="chatList" class="p-2">
            <!-- Chat history will be loaded here -->
        </div>
    </div>

    <!-- Sidebar Overlay -->
    <div id="sidebarOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-30"></div>

    <!-- Header -->
    <div class="bg-white border-b border-gray-200 px-4 py-3">
        <div class="flex items-center justify-between max-w-4xl mx-auto">
            <div class="flex items-center space-x-3">
                <button id="menuBtn" class="p-2 hover:bg-gray-100 rounded-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                </button>
                <!-- Custom MakeRun AI Logo -->
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500 rounded-full flex items-center justify-center p-2">
                    <svg class="w-6 h-6 text-white" viewBox="0 0 24 24" fill="none">
                        <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="currentColor"/>
                        <path d="M19 12L19.74 15.26L23 16L19.74 16.74L19 20L18.26 16.74L15 16L18.26 15.26L19 12Z" fill="currentColor"/>
                        <path d="M5 4L5.74 7.26L9 8L5.74 8.74L5 12L4.26 8.74L1 8L4.26 7.26L5 4Z" fill="currentColor"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-xl font-semibold text-gray-800">MakeRun</h1>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <div id="messageCounter" class="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm">
                    <span id="messageCount">0</span>/10
                </div>
                <button id="loginBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-full text-sm transition-all flex items-center space-x-2">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    <span>Login with Google</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Chat Container -->
    <div class="flex flex-col h-screen">
        <div id="chatContainer" class="flex-1 overflow-y-auto px-4 py-6 scroll-smooth">
            <div class="max-w-4xl mx-auto space-y-6">
                <!-- Welcome Message -->
                <div class="chat-message flex items-start space-x-3">
                    <div class="w-8 h-8 bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500 rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="none">
                            <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="currentColor"/>
                        </svg>
                    </div>
                    <div class="message-ai rounded-2xl rounded-tl-sm p-4 max-w-md">
                        <p class="text-gray-800">Hello! I'm MakeRun, your AI assistant. I can help you with news, search queries, general questions, and much more. What would you like to know?</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Suggestions -->
        <div id="suggestionsContainer" class="px-4 pb-4">
            <div class="max-w-4xl mx-auto">
                <div class="flex flex-wrap gap-2 justify-center">
                    <button class="suggestion-chip px-4 py-2 rounded-full text-sm text-blue-600 font-medium flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/>
                        </svg>
                        <span>Latest news</span>
                    </button>
                    <button class="suggestion-chip px-4 py-2 rounded-full text-sm text-blue-600 font-medium flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/>
                        </svg>
                        <span>Weather today</span>
                    </button>
                    <button class="suggestion-chip px-4 py-2 rounded-full text-sm text-blue-600 font-medium flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                        <span>Tech updates</span>
                    </button>
                    <button class="suggestion-chip px-4 py-2 rounded-full text-sm text-blue-600 font-medium flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <span>Find images</span>
                    </button>
                    <button class="suggestion-chip px-4 py-2 rounded-full text-sm text-blue-600 font-medium flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16l2.879-2.879m0 0a3 3 0 104.243-4.242 3 3 0 00-4.243 4.242zM21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span>Sports scores</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="bg-white border-t border-gray-200 p-4">
            <div class="max-w-4xl mx-auto">
                <div class="flex items-end space-x-3">
                    <div class="flex-1 relative">
                        <textarea 
                            id="messageInput" 
                            placeholder="Ask MakeRun anything..."
                            class="w-full bg-gray-50 border border-gray-300 rounded-2xl px-4 py-3 pr-12 resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-800 placeholder-gray-500"
                            rows="1"
                            style="max-height: 120px;"
                        ></textarea>
                        <button 
                            id="sendBtn" 
                            class="absolute right-2 bottom-2 w-8 h-8 bg-blue-500 hover:bg-blue-600 text-white rounded-full flex items-center justify-center transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div id="limitWarning" class="hidden mt-3 p-3 bg-yellow-100 border border-yellow-300 rounded-lg">
                    <p class="text-yellow-800 text-sm flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
                        </svg>
                        You've reached the 10 message limit. Please login to continue chatting.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="hidden fixed inset-0 login-modal flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="none">
                        <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="currentColor"/>
                        <path d="M19 12L19.74 15.26L23 16L19.74 16.74L19 20L18.26 16.74L15 16L18.26 15.26L19 12Z" fill="currentColor"/>
                        <path d="M5 4L5.74 7.26L9 8L5.74 8.74L5 12L4.26 8.74L1 8L4.26 7.26L5 4Z" fill="currentColor"/>
                    </svg>
                </div>
                <h2 class="text-2xl font-semibold text-gray-800">Welcome to MakeRun</h2>
                <p class="text-gray-600 mt-2">Login with Google to continue unlimited chatting</p>
            </div>
            <div class="space-y-4">
                <button id="googleLoginBtn" class="w-full bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 py-3 px-4 rounded-xl font-medium transition-colors flex items-center justify-center space-x-3">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    <span>Continue with Google</span>
                </button>
                <button id="closeModalBtn" class="w-full text-gray-600 hover:text-gray-800 py-2 transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDjfNlHwhT4xYb7vVym_SAqMlSuY_TMz0o",
            authDomain: "orioplay.firebaseapp.com",
            databaseURL: "https://orioplay-default-rtdb.firebaseio.com",
            projectId: "orioplay",
            storageBucket: "orioplay.firebasestorage.app",
            messagingSenderId: "300811706751",
            appId: "1:300811706751:web:bdce98b1ba7e11d34d7a4a"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // Global variables
        let messageCount = 0;
        let isLoggedIn = false;
        let currentUser = null;

        // DOM elements
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const messageCountDisplay = document.getElementById('messageCount');
        const limitWarning = document.getElementById('limitWarning');
        const loginModal = document.getElementById('loginModal');
        const loginBtn = document.getElementById('loginBtn');
        const suggestionsContainer = document.getElementById('suggestionsContainer');

        // API Keys with fallback support
        const API_KEYS = {
            news: [
                { name: 'NewsAPI', key: '52aa2d959ec24789a285e3864e29f2a6', url: 'https://newsapi.org/v2/top-headlines' },
                { name: 'GNews', key: 'fe0089beeafe2fdc1337fdcd5494fc87', url: 'https://gnews.io/api/v4/top-headlines' },
                { name: 'NewsData', key: 'pub_58847f7c8f0b4c8e9a2d3b1e5f6a7c8d', url: 'https://newsdata.io/api/1/news' }
            ],
            search: [
                { name: 'Google', key: 'AIzaSyBwxXlAbtEaLGdW5TH-VK6WtvuWE0PiH2M', cx: 'a7123c9b609f44f19' },
                { name: 'Bing', key: 'b8c9d0e1f2g3h4i5j6k7l8m9n0o1p2q3' }
            ],
            weather: [
                { name: 'OpenWeather', key: 'a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6' },
                { name: 'WeatherAPI', key: 'z9y8x7w6v5u4t3s2r1q0p9o8n7m6l5k4' }
            ]
        };

        // Chat management
        let currentChatId = null;
        let chatHistory = {};
        let allChats = [];

        // Auto-resize textarea
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Comprehensive AI Response System
        async function generateAIResponse(userMessage) {
            const query = userMessage.toLowerCase();
            
            try {
                // Image search queries
                if (query.includes('image') || query.includes('picture') || query.includes('photo') || query.includes('show me') || query.includes('find image')) {
                    return await getImageSearchResponse(userMessage);
                }
                
                // News queries
                if (query.includes('news') || query.includes('latest') || query.includes('breaking')) {
                    return await getNewsResponse(userMessage);
                }
                
                // Weather queries
                if (query.includes('weather') || query.includes('temperature') || query.includes('forecast')) {
                    return getWeatherResponse(userMessage);
                }
                
                // Tech queries
                if (query.includes('tech') || query.includes('technology') || query.includes('ai') || query.includes('programming')) {
                    return getTechResponse(userMessage);
                }
                
                // Sports queries
                if (query.includes('sport') || query.includes('cricket') || query.includes('football') || query.includes('score')) {
                    return getSportsResponse(userMessage);
                }
                
                // Math queries
                if (query.includes('calculate') || query.includes('math') || /\d+[\+\-\*\/]\d+/.test(query)) {
                    return getMathResponse(userMessage);
                }
                
                // General knowledge
                if (query.includes('what is') || query.includes('who is') || query.includes('how to') || query.includes('explain')) {
                    return await getGeneralResponse(userMessage);
                }
                
                // Default friendly response
                return getFriendlyResponse(userMessage);
                
            } catch (error) {
                return {
                    text: "I'm having trouble processing that request right now. Could you try asking something else?",
                    sources: []
                };
            }
        }

        // Image Search API integration
        async function getImageSearchResponse(query) {
            // Extract search term from query
            let searchTerm = query.replace(/image|picture|photo|show me|find image|of|for/gi, '').trim();
            if (!searchTerm) {
                return {
                    text: "Please specify what images you'd like to search for. For example: 'show me images of cats' or 'find pictures of mountains'",
                    sources: [],
                    images: []
                };
            }
            
            try {
                const apiKey = API_KEYS.search[0].key; // Google Search API key
                const cx = API_KEYS.search[0].cx; // Custom Search Engine ID
                const url = `https://www.googleapis.com/customsearch/v1?key=${apiKey}&cx=${cx}&q=${encodeURIComponent(searchTerm)}&searchType=image&num=6&safe=active`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.items && data.items.length > 0) {
                    const images = data.items.map(item => ({
                        url: item.link,
                        title: item.title,
                        thumbnail: item.image?.thumbnailLink || item.link,
                        source: item.displayLink,
                        contextLink: item.image?.contextLink || '#'
                    }));
                    
                    return {
                        text: `Here are images for "${searchTerm}":`,
                        sources: [],
                        images: images
                    };
                } else {
                    return {
                        text: `I couldn't find any images for "${searchTerm}". Try searching with different keywords.`,
                        sources: [],
                        images: []
                    };
                }
            } catch (error) {
                console.error('Image Search API Error:', error);
                return {
                    text: `I'm having trouble searching for images of "${searchTerm}" right now. Please try again later.`,
                    sources: [],
                    images: []
                };
            }
        }

        // News API integration with fallback
        async function getNewsResponse(query) {
            for (let api of API_KEYS.news) {
                try {
                    let url, response, data;
                    
                    if (api.name === 'NewsAPI') {
                        url = `${api.url}?country=us&pageSize=5&apiKey=${api.key}`;
                        response = await fetch(url);
                        data = await response.json();
                        
                        if (data.articles && data.articles.length > 0) {
                            const articles = data.articles.slice(0, 3);
                            let newsText = "Here are the latest news headlines:\n\n";
                            
                            articles.forEach((article, index) => {
                                newsText += `${index + 1}. ${article.title}\n`;
                                if (article.description) {
                                    newsText += `   ${article.description.substring(0, 100)}...\n\n`;
                                }
                            });
                            
                            return {
                                text: newsText,
                                sources: articles.map(article => ({
                                    title: article.title,
                                    url: article.url,
                                    source: article.source.name
                                }))
                            };
                        }
                    } else if (api.name === 'GNews') {
                        url = `${api.url}?lang=en&country=us&max=5&apikey=${api.key}`;
                        response = await fetch(url);
                        data = await response.json();
                        
                        if (data.articles && data.articles.length > 0) {
                            const articles = data.articles.slice(0, 3);
                            let newsText = "Here are the latest news headlines:\n\n";
                            
                            articles.forEach((article, index) => {
                                newsText += `${index + 1}. ${article.title}\n`;
                                if (article.description) {
                                    newsText += `   ${article.description.substring(0, 100)}...\n\n`;
                                }
                            });
                            
                            return {
                                text: newsText,
                                sources: articles.map(article => ({
                                    title: article.title,
                                    url: article.url,
                                    source: article.source.name
                                }))
                            };
                        }
                    }
                } catch (error) {
                    console.error(`${api.name} API Error:`, error);
                    continue; // Try next API
                }
            }
            
            return {
                text: "I couldn't fetch the latest news right now. All news services are temporarily unavailable. Please try again later.",
                sources: []
            };
        }

        // Weather response
        function getWeatherResponse(query) {
            return {
                text: "I'd love to help with weather information! However, I need access to a weather API to provide real-time weather data. You can check weather on:\n\n• Weather.com\n• AccuWeather\n• Your local weather app\n\nIs there anything else I can help you with?",
                sources: []
            };
        }

        // Tech response
        function getTechResponse(query) {
            const techTopics = {
                'ai': "Artificial Intelligence is revolutionizing how we interact with technology. AI systems like me can understand natural language, process information, and provide helpful responses. Current AI trends include machine learning, deep learning, and large language models.",
                'programming': "Programming is the art of creating software using various languages like Python, JavaScript, Java, and more. It involves problem-solving, logical thinking, and creativity to build applications that solve real-world problems.",
                'technology': "Technology continues to evolve rapidly with innovations in AI, quantum computing, blockchain, IoT, and more. These advancements are shaping our future and changing how we work, communicate, and live."
            };
            
            for (let topic in techTopics) {
                if (query.includes(topic)) {
                    return {
                        text: techTopics[topic],
                        sources: []
                    };
                }
            }
            
            return {
                text: "Technology is fascinating! I can help you learn about AI, programming, software development, emerging tech trends, and more. What specific tech topic interests you?",
                sources: []
            };
        }

        // Sports response
        function getSportsResponse(query) {
            return {
                text: "I'd love to help with sports information! For real-time scores and updates, I recommend checking:\n\n• ESPN\n• Sports news websites\n• Official league apps\n\nI can discuss sports history, rules, famous players, and general sports topics. What would you like to know?",
                sources: []
            };
        }

        // Math calculations
        function getMathResponse(query) {
            try {
                // Simple math evaluation (be careful with eval in production)
                const mathExpression = query.match(/[\d\+\-\*\/\(\)\.\s]+/);
                if (mathExpression) {
                    const expression = mathExpression[0].trim();
                    // Basic safety check
                    if (/^[\d\+\-\*\/\(\)\.\s]+$/.test(expression)) {
                        const result = eval(expression);
                        return {
                            text: `Calculation: ${expression} = ${result}`,
                            sources: []
                        };
                    }
                }
            } catch (error) {
                // Fall through to general math response
            }
            
            return {
                text: "I can help with basic math calculations! Try asking me things like:\n\n• What is 25 + 37?\n• Calculate 15 * 8\n• What's 100 / 4?\n\nJust type your math problem and I'll solve it!",
                sources: []
            };
        }

        // General knowledge response
        async function getGeneralResponse(query) {
            // This would typically use a knowledge API or search API
            return {
                text: `That's an interesting question about "${query}". While I don't have access to real-time search results right now, I can help with general knowledge, explanations, and discussions on various topics.\n\nFor the most current and detailed information, I'd recommend searching on Google or checking reliable sources like Wikipedia.\n\nIs there a specific aspect you'd like me to explain or discuss?`,
                sources: []
            };
        }

        // Friendly default response
        function getFriendlyResponse(query) {
            const responses = [
                `That's interesting! "${query}" - I'd love to help you with that. Could you be more specific about what you'd like to know?`,
                `Great question! While I might not have all the details about "${query}", I'm here to help. What specific information are you looking for?`,
                `I understand you're asking about "${query}". I can help with news, general questions, calculations, and more. How can I assist you better?`,
                `Thanks for asking about "${query}"! I'm always learning. Is there a particular aspect you'd like me to focus on?`
            ];
            
            return {
                text: responses[Math.floor(Math.random() * responses.length)],
                sources: []
            };
        }

        // Chat management functions
        function createNewChat() {
            currentChatId = Date.now().toString();
            chatHistory = {};
            
            // Clear current chat display
            const chatContent = chatContainer.querySelector('.max-w-4xl');
            chatContent.innerHTML = `
                <div class="chat-message flex items-start space-x-3">
                    <div class="w-8 h-8 bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500 rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="none">
                            <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="currentColor"/>
                        </svg>
                    </div>
                    <div class="message-ai rounded-2xl rounded-tl-sm p-4 max-w-md">
                        <p class="text-gray-800">Hello! I'm MakeRun, your AI assistant. I can help you with news, search queries, general questions, and much more. What would you like to know?</p>
                    </div>
                </div>
            `;
            
            // Show suggestions again
            suggestionsContainer.style.display = 'block';
            
            // Update chat list
            updateChatList();
        }

        function loadChat(chatId) {
            if (currentUser && chatId) {
                const chatRef = database.ref(`chats/${currentUser.uid}/${chatId}`);
                chatRef.once('value', (snapshot) => {
                    const messages = snapshot.val();
                    if (messages) {
                        // Clear current chat
                        const chatContent = chatContainer.querySelector('.max-w-4xl');
                        chatContent.innerHTML = '';
                        
                        // Load messages
                        Object.values(messages).forEach(msg => {
                            let content = msg.message;
                            try {
                                content = JSON.parse(msg.message);
                            } catch (e) {
                                // Keep as string if not JSON
                            }
                            addMessageToDOM(content, msg.isUser);
                        });
                        
                        currentChatId = chatId;
                        suggestionsContainer.style.display = 'none';
                    }
                });
            }
        }

        function updateChatList() {
            if (!currentUser) return;
            
            const chatListContainer = document.getElementById('chatList');
            chatListContainer.innerHTML = '';
            
            const chatsRef = database.ref(`chats/${currentUser.uid}`);
            chatsRef.once('value', (snapshot) => {
                const chats = snapshot.val();
                if (chats) {
                    allChats = Object.keys(chats).map(chatId => {
                        const messages = Object.values(chats[chatId]);
                        const firstUserMessage = messages.find(msg => msg.isUser);
                        return {
                            id: chatId,
                            title: firstUserMessage ? firstUserMessage.message.substring(0, 30) + '...' : 'New Chat',
                            timestamp: messages[0]?.timestamp || Date.now()
                        };
                    }).sort((a, b) => b.timestamp - a.timestamp);
                    
                    allChats.forEach(chat => {
                        const chatItem = document.createElement('div');
                        chatItem.className = `chat-item p-3 rounded-lg cursor-pointer ${chat.id === currentChatId ? 'active' : ''}`;
                        chatItem.innerHTML = `
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-800 truncate">${chat.title}</p>
                                    <p class="text-xs text-gray-500">${new Date(chat.timestamp).toLocaleDateString()}</p>
                                </div>
                                <button class="delete-chat p-1 hover:bg-red-100 rounded opacity-0 group-hover:opacity-100" data-chat-id="${chat.id}">
                                    <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </div>
                        `;
                        
                        chatItem.addEventListener('click', (e) => {
                            if (!e.target.closest('.delete-chat')) {
                                loadChat(chat.id);
                                document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
                                chatItem.classList.add('active');
                                closeSidebar();
                            }
                        });
                        
                        chatListContainer.appendChild(chatItem);
                    });
                }
            });
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.add('hidden');
        }

        // Add message to chat
        function addMessage(content, isUser = false) {
            addMessageToDOM(content, isUser);
            
            // Save to Firebase if user is logged in
            if (isLoggedIn && currentUser && currentChatId) {
                const chatRef = database.ref(`chats/${currentUser.uid}/${currentChatId}`);
                chatRef.push({
                    message: typeof content === 'string' ? content : JSON.stringify(content),
                    isUser: isUser,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }

        function addMessageToDOM(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message flex items-start space-x-3';
            
            if (isUser) {
                messageDiv.className += ' flex-row-reverse space-x-reverse';
            }
            
            let messageText = '';
            let sources = [];
            let images = [];
            
            if (typeof content === 'string') {
                messageText = content;
            } else {
                messageText = content.text || content;
                sources = content.sources || [];
                images = content.images || [];
            }
            
            let sourcesHTML = '';
            if (sources.length > 0) {
                sourcesHTML = `
                    <div class="mt-3 pt-3 border-t border-gray-200">
                        <p class="text-xs text-gray-500 mb-2 flex items-center">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                            </svg>
                            Sources:
                        </p>
                        <div class="space-y-1">
                            ${sources.map(source => `
                                <a href="${source.url}" target="_blank" class="block text-xs text-blue-600 hover:text-blue-800 hover:underline p-2 bg-blue-50 rounded-lg transition-colors">
                                    <div class="font-medium">${source.title}</div>
                                    <div class="text-gray-500">${source.source}</div>
                                </a>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            let imagesHTML = '';
            if (images.length > 0) {
                imagesHTML = `
                    <div class="mt-3 pt-3 border-t border-gray-200">
                        <div class="grid grid-cols-2 gap-2">
                            ${images.map(image => `
                                <div class="relative group cursor-pointer" onclick="window.open('${image.contextLink}', '_blank')">
                                    <img src="${image.thumbnail}" alt="${image.title}" 
                                         class="w-full h-32 object-cover rounded-lg hover:opacity-90 transition-opacity"
                                         onerror="this.src=''; this.alt='Image failed to load'; this.style.display='none';">
                                    <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 rounded-lg transition-all"></div>
                                    <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black to-transparent p-2 rounded-b-lg opacity-0 group-hover:opacity-100 transition-opacity">
                                        <p class="text-white text-xs truncate">${image.title}</p>
                                        <p class="text-gray-300 text-xs">${image.source}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            messageDiv.innerHTML = `
                <div class="w-8 h-8 ${isUser ? 'bg-green-500' : 'bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500'} rounded-full flex items-center justify-center flex-shrink-0">
                    <svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="none">
                        ${isUser ? 
                            '<path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" fill="currentColor"/>' :
                            '<path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="currentColor"/>'
                        }
                    </svg>
                </div>
                <div class="${isUser ? 'message-user text-white' : 'message-ai'} rounded-2xl ${isUser ? 'rounded-tr-sm' : 'rounded-tl-sm'} p-4 ${images.length > 0 ? 'max-w-2xl' : 'max-w-lg'}">
                    <p class="${isUser ? 'text-white' : 'text-gray-800'} whitespace-pre-line">${messageText}</p>
                    ${imagesHTML}
                    ${sourcesHTML}
                </div>
            `;
            
            const chatContent = chatContainer.querySelector('.max-w-4xl');
            chatContent.appendChild(messageDiv);
            
            // Hide suggestions after first message
            if (chatContent.children.length > 1) {
                suggestionsContainer.style.display = 'none';
            }
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Show typing indicator
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'chat-message flex items-start space-x-3';
            typingDiv.innerHTML = `
                <div class="w-8 h-8 bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500 rounded-full flex items-center justify-center flex-shrink-0">
                    <svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="none">
                        <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="currentColor"/>
                    </svg>
                </div>
                <div class="message-ai rounded-2xl rounded-tl-sm p-4">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            
            const chatContent = chatContainer.querySelector('.max-w-4xl');
            chatContent.appendChild(typingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Remove typing indicator
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Send message
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;
            
            if (!isLoggedIn && messageCount >= 10) {
                limitWarning.classList.remove('hidden');
                return;
            }
            
            // Create new chat if none exists
            if (!currentChatId) {
                currentChatId = Date.now().toString();
            }
            
            // Add user message
            addMessage(message, true);
            messageInput.value = '';
            messageInput.style.height = 'auto';
            
            // Update message count
            if (!isLoggedIn) {
                messageCount++;
                messageCountDisplay.textContent = messageCount;
                
                if (messageCount >= 10) {
                    sendBtn.disabled = true;
                    messageInput.disabled = true;
                    limitWarning.classList.remove('hidden');
                }
            }
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                // Generate AI response
                const aiResponse = await generateAIResponse(message);
                
                // Simulate thinking time
                await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 2000));
                
                removeTypingIndicator();
                addMessage(aiResponse);
                
                // Update chat list if logged in
                if (isLoggedIn) {
                    updateChatList();
                }
            } catch (error) {
                removeTypingIndicator();
                addMessage({
                    text: 'Sorry, I encountered an error. Please try again.',
                    sources: []
                });
            }
        }

        // Event listeners
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Suggestion buttons
        document.querySelectorAll('.suggestion-chip').forEach(btn => {
            btn.addEventListener('click', () => {
                messageInput.value = btn.textContent.trim();
                sendMessage();
            });
        });

        // Sidebar functionality
        document.getElementById('menuBtn').addEventListener('click', () => {
            document.getElementById('sidebar').classList.add('open');
            document.getElementById('sidebarOverlay').classList.remove('hidden');
        });

        document.getElementById('closeSidebar').addEventListener('click', closeSidebar);
        document.getElementById('sidebarOverlay').addEventListener('click', closeSidebar);

        document.getElementById('newChatBtn').addEventListener('click', () => {
            createNewChat();
            closeSidebar();
        });

        // Login functionality
        loginBtn.addEventListener('click', () => {
            if (isLoggedIn) {
                auth.signOut();
            } else {
                loginModal.classList.remove('hidden');
            }
        });

        document.getElementById('closeModalBtn').addEventListener('click', () => {
            loginModal.classList.add('hidden');
        });

        document.getElementById('googleLoginBtn').addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.addScope('email');
            provider.addScope('profile');
            
            auth.signInWithPopup(provider)
                .then((result) => {
                    currentUser = result.user;
                    isLoggedIn = true;
                    loginModal.classList.add('hidden');
                    limitWarning.classList.add('hidden');
                    sendBtn.disabled = false;
                    messageInput.disabled = false;
                    loginBtn.innerHTML = `
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                        <span>Logout</span>
                    `;
                    document.getElementById('messageCounter').innerHTML = '<span class="text-green-600 flex items-center"><svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>Logged in</span>';
                    
                    // Load chat history
                    updateChatList();
                })
                .catch((error) => {
                    console.error('Google login error:', error);
                    alert('Login failed. Please try again.');
                });
        });

        // Auth state observer
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                isLoggedIn = true;
                loginBtn.innerHTML = `
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                    </svg>
                    <span>Logout</span>
                `;
                document.getElementById('messageCounter').innerHTML = '<span class="text-green-600 flex items-center"><svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>Logged in</span>';
                updateChatList();
            } else {
                currentUser = null;
                isLoggedIn = false;
                currentChatId = null;
                loginBtn.innerHTML = `
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    <span>Login with Google</span>
                `;
                messageCount = 0;
                messageCountDisplay.textContent = '0';
                sendBtn.disabled = false;
                messageInput.disabled = false;
                limitWarning.classList.add('hidden');
                document.getElementById('chatList').innerHTML = '';
            }
        });

        // Prevent zoom on mobile
        document.addEventListener('touchstart', function(event) {
            if (event.touches.length > 1) {
                event.preventDefault();
            }
        });

        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97be1e11868c918a',t:'MTc1NzMzMTA2NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
