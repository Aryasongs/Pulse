<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dozera Law Enforcement Portal</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script><!-- Firebase SDK -->
  <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getDatabase, ref, push, set, get, onValue, update } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyC30TcmMVhP_8HdFYS1WufRiZwSDYNMTF0",
            authDomain: "pulse2-92372.firebaseapp.com",
            databaseURL: "https://pulse2-92372-default-rtdb.firebaseio.com",
            projectId: "pulse2-92372",
            storageBucket: "pulse2-92372.firebasestorage.app",
            messagingSenderId: "276235725177",
            appId: "1:276235725177:web:0f4e0789fae80a435927a8"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);

        // Make Firebase available globally
        window.firebaseDB = database;
        window.firebaseAuth = auth;
        window.firebaseRefs = { ref, push, set, get, onValue, update };
        window.signInAnonymously = signInAnonymously;

        // Initialize Firebase Auth
        signInAnonymously(auth).then(() => {
            console.log('Firebase initialized successfully');
            window.firebaseReady = true;
        }).catch((error) => {
            console.error('Firebase initialization error:', error);
        });
    </script>
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Times New Roman', serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #2c3e50;
            min-height: 100%;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #c9302c 0%, #8b1538 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border-bottom: 4px solid #ffd700;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .dozera-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid #fff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .title-section h1 {
            margin: 0;
            font-size: 32px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .title-section p {
            margin: 5px 0 0 0;
            font-size: 16px;
            color: #e8e8e8;
        }

        .contact-info {
            text-align: right;
            font-size: 14px;
            color: #ffd700;
        }

        .navigation {
            background: rgba(52, 73, 94, 0.95);
            padding: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: none;
            border: none;
            color: white;
            padding: 15px 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .nav-btn:hover, .nav-btn.active {
            background: rgba(201, 48, 44, 0.8);
            border-bottom-color: #ffd700;
            transform: translateY(-2px);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            padding: 30px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .section-title {
            font-size: 28px;
            font-weight: bold;
            color: #c9302c;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #ffd700;
            text-align: center;
        }

        .company-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .company-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid #c9302c;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .company-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.2), transparent);
            transition: left 0.5s;
        }

        .company-card:hover::before {
            left: 100%;
        }

        .company-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(201, 48, 44, 0.3);
            border-color: #ffd700;
        }

        .company-card.selected {
            background: linear-gradient(135deg, #c9302c, #8b1538);
            color: white;
            border-color: #ffd700;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .required {
            color: #c9302c;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #c9302c;
            box-shadow: 0 0 10px rgba(201, 48, 44, 0.3);
            transform: scale(1.02);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .btn {
            background: linear-gradient(135deg, #c9302c, #8b1538);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(201, 48, 44, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(201, 48, 44, 0.4);
        }

        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #34495e, #2c3e50);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .token-display {
            background: linear-gradient(135deg, #c9302c, #8b1538);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            font-size: 24px;
            font-weight: bold;
            border: 3px solid #ffd700;
            box-shadow: 0 8px 25px rgba(201, 48, 44, 0.4);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 8px 25px rgba(201, 48, 44, 0.4); }
            50% { box-shadow: 0 8px 35px rgba(201, 48, 44, 0.6); }
            100% { box-shadow: 0 8px 25px rgba(201, 48, 44, 0.4); }
        }

        .status-badge {
            display: inline-block;
            padding: 8px 15px;
            border-radius: 25px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-pending { background: #f39c12; color: white; }
        .status-active { background: #3498db; color: white; }
        .status-under-review { background: #9b59b6; color: white; }
        .status-resolved { background: #27ae60; color: white; }
        .status-closed { background: #95a5a6; color: white; }

        .case-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid #dee2e6;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .case-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(201, 48, 44, 0.1), transparent);
            transition: left 0.5s;
        }

        .case-card:hover::before {
            left: 100%;
        }

        .case-card:hover {
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            transform: translateY(-3px);
            border-color: #c9302c;
        }

        .case-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .case-token {
            font-size: 20px;
            font-weight: bold;
            color: #c9302c;
        }

        .case-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .case-actions .btn {
            padding: 10px 20px;
            font-size: 14px;
        }

        .login-form {
            max-width: 450px;
            margin: 50px auto;
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .login-title {
            text-align: center;
            margin-bottom: 30px;
            color: #c9302c;
            font-size: 28px;
        }

        .chat-container {
            background: rgba(248, 249, 250, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            backdrop-filter: blur(10px);
        }

        .chat-messages {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            background: white;
            margin-bottom: 15px;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 10px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-admin {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            margin-left: 20px;
            border-left: 4px solid #2196f3;
        }

        .chat-user {
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
            margin-right: 20px;
            border-left: 4px solid #9c27b0;
        }

        .chat-lawyer {
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            margin-left: 20px;
            border-left: 4px solid #4caf50;
        }

        .chat-input-group {
            display: flex;
            gap: 15px;
        }

        .chat-input {
            flex: 1;
        }

        .alert {
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .alert-success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .alert-error {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .audit-trail {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-left: 5px solid #c9302c;
            padding: 20px;
            margin-top: 20px;
            border-radius: 10px;
        }

        .audit-entry {
            margin-bottom: 12px;
            font-size: 14px;
            padding: 8px;
            background: white;
            border-radius: 5px;
            border-left: 3px solid #ffd700;
        }

        .audit-timestamp {
            color: #c9302c;
            font-weight: bold;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            color: #c9302c;
            font-style: italic;
            padding: 30px;
            font-size: 18px;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }

        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #bdc3c7;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .step.active {
            background: #c9302c;
            transform: scale(1.2);
        }

        .step.completed {
            background: #27ae60;
        }

        .lawyer-request {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 2px solid #f39c12;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }

            .nav-container {
                flex-direction: column;
            }

            .form-grid, .company-grid {
                grid-template-columns: 1fr;
            }

            .case-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .case-actions {
                justify-content: flex-start;
            }

            .title-section h1 {
                font-size: 24px;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <header class="header">
   <div class="header-content">
    <div class="logo-section">
     <div class="dozera-logo">
      <svg width="60" height="60" viewbox="0 0 100 100" fill="none"><circle cx="50" cy="50" r="45" fill="#c9302c" /> <text x="50" y="35" text-anchor="middle" fill="#ffd700" font-size="12" font-weight="bold">
        DOZERA
       </text> <text x="50" y="50" text-anchor="middle" fill="#ffd700" font-size="8">
        LAW
       </text> <text x="50" y="65" text-anchor="middle" fill="#ffd700" font-size="8">
        DEPT
       </text> <circle cx="50" cy="50" r="35" stroke="#ffd700" stroke-width="2" fill="none" />
      </svg>
     </div>
     <div class="title-section">
      <h1 id="portalTitle">Dozera Law Enforcement Portal</h1>
      <p id="departmentName">Dozera Group Legal Department</p>
     </div>
    </div>
    <div class="contact-info" id="contactDetails">
     Legal Helpline: 1800-DOZERA-LAW<br>
      Emergency: +91-7973804008
    </div>
   </div>
  </header>
  <nav class="navigation">
   <div class="nav-container"><button class="nav-btn active" onclick="showSection('home')">Home</button> <button class="nav-btn" onclick="showSection('file-complaint')">File Complaint</button> <button class="nav-btn" onclick="showSection('track-case')">Track Case</button> <button class="nav-btn" onclick="showSection('lawyer-connect')">Connect Lawyer</button> <button class="nav-btn" onclick="showSection('admin-login')">Admin Access</button>
   </div>
  </nav>
  <main class="container"><!-- Home Section -->
   <section id="home-section" class="section">
    <h2 class="section-title">Welcome to Dozera Law Enforcement Portal</h2>
    <p style="font-size: 18px; margin-bottom: 30px; text-align: center;">File complaints against Dozera Group companies and their employees. Connect with legal experts and track your case progress through our comprehensive legal platform.</p>
    <div class="company-grid">
     <div class="company-card">
      <h3 style="color: #c9302c; margin-top: 0;">Dozera Ltd</h3>
      <p>Main holding company</p>
     </div>
     <div class="company-card">
      <h3 style="color: #c9302c; margin-top: 0;">Dozera Shop</h3>
      <p>E-commerce platform</p>
     </div>
     <div class="company-card">
      <h3 style="color: #c9302c; margin-top: 0;">Saint Soul</h3>
      <p>Fashion &amp; lifestyle</p>
     </div>
     <div class="company-card">
      <h3 style="color: #c9302c; margin-top: 0;">Zynk</h3>
      <p>Technology solutions</p>
     </div>
     <div class="company-card">
      <h3 style="color: #c9302c; margin-top: 0;">Dozera Construction</h3>
      <p>Infrastructure development</p>
     </div>
     <div class="company-card">
      <h3 style="color: #c9302c; margin-top: 0;">Dozera Cloud &amp; Storage</h3>
      <p>Data services</p>
     </div>
     <div class="company-card">
      <h3 style="color: #c9302c; margin-top: 0;">Dozera F1</h3>
      <p>Racing &amp; sports</p>
     </div>
     <div class="company-card">
      <h3 style="color: #c9302c; margin-top: 0;">Jet2 Airline</h3>
      <p>Aviation services</p>
     </div>
     <div class="company-card">
      <h3 style="color: #c9302c; margin-top: 0;">Oriontec Inc</h3>
      <p>Technology consulting</p>
     </div>
    </div>
   </section><!-- File Complaint Section -->
   <section id="file-complaint-section" class="section hidden">
    <h2 class="section-title">File Legal Complaint</h2>
    <div class="step-indicator">
     <div class="step active" id="step1">
      1
     </div>
     <div class="step" id="step2">
      2
     </div>
     <div class="step" id="step3">
      3
     </div>
     <div class="step" id="step4">
      4
     </div>
    </div><!-- Step 1: Company Selection -->
    <div id="complaint-step-1">
     <h3 style="color: #c9302c; text-align: center; margin-bottom: 30px;">Step 1: Select Target Company</h3>
     <div class="company-grid" id="companySelection">
      <div class="company-card" onclick="selectCompany('Dozera Ltd')">
       <h4>Dozera Ltd</h4>
       <p>Main holding company</p>
      </div>
      <div class="company-card" onclick="selectCompany('Dozera Shop')">
       <h4>Dozera Shop</h4>
       <p>E-commerce platform</p>
      </div>
      <div class="company-card" onclick="selectCompany('Saint Soul')">
       <h4>Saint Soul</h4>
       <p>Fashion &amp; lifestyle</p>
      </div>
      <div class="company-card" onclick="selectCompany('Zynk')">
       <h4>Zynk</h4>
       <p>Technology solutions</p>
      </div>
      <div class="company-card" onclick="selectCompany('Dozera Construction')">
       <h4>Dozera Construction</h4>
       <p>Infrastructure development</p>
      </div>
      <div class="company-card" onclick="selectCompany('Dozera Cloud &amp; Storage Services')">
       <h4>Dozera Cloud &amp; Storage</h4>
       <p>Data services</p>
      </div>
      <div class="company-card" onclick="selectCompany('Dozera Law Department')">
       <h4>Dozera Law Department</h4>
       <p>Legal services</p>
      </div>
      <div class="company-card" onclick="selectCompany('Dozera F1')">
       <h4>Dozera F1</h4>
       <p>Racing &amp; sports</p>
      </div>
      <div class="company-card" onclick="selectCompany('Jet2 Airline')">
       <h4>Jet2 Airline</h4>
       <p>Aviation services</p>
      </div>
      <div class="company-card" onclick="selectCompany('Oriontec Inc')">
       <h4>Oriontec Inc</h4>
       <p>Technology consulting</p>
      </div>
     </div>
     <div style="text-align: center; margin-top: 30px;"><button class="btn" onclick="nextStep(2)" id="step1NextBtn" disabled>Continue to Employee Details</button>
     </div>
    </div><!-- Step 2: Employee Details -->
    <div id="complaint-step-2" class="hidden">
     <h3 style="color: #c9302c; text-align: center; margin-bottom: 30px;">Step 2: Employee Information</h3>
     <div class="form-grid">
      <div class="form-group"><label class="form-label" for="employeeId">Employee ID <span class="required">*</span></label> <input type="text" class="form-input" id="employeeId" required placeholder="Enter employee ID">
      </div>
      <div class="form-group"><label class="form-label" for="employeeName">Employee Name <span class="required">*</span></label> <input type="text" class="form-input" id="employeeName" required placeholder="Enter full name">
      </div>
      <div class="form-group"><label class="form-label" for="employeeDesignation">Designation</label> <input type="text" class="form-input" id="employeeDesignation" placeholder="Employee position/role">
      </div>
      <div class="form-group"><label class="form-label" for="employeeDepartment">Department</label> <input type="text" class="form-input" id="employeeDepartment" placeholder="Department name">
      </div>
     </div>
     <div style="text-align: center; margin-top: 30px;"><button class="btn btn-secondary" onclick="previousStep(1)">Back</button> <button class="btn" onclick="nextStep(3)" style="margin-left: 15px;">Continue to Complaint Details</button>
     </div>
    </div><!-- Step 3: Complaint Details -->
    <div id="complaint-step-3" class="hidden">
     <h3 style="color: #c9302c; text-align: center; margin-bottom: 30px;">Step 3: Complaint Information</h3>
     <form id="complaintForm">
      <div class="form-grid">
       <div class="form-group"><label class="form-label" for="complaintType">Complaint Type <span class="required">*</span></label> <select class="form-select" id="complaintType" required> <option value="">Select complaint type</option> <option value="harassment">Workplace Harassment</option> <option value="discrimination">Discrimination</option> <option value="fraud">Financial Fraud</option> <option value="misconduct">Professional Misconduct</option> <option value="breach">Contract Breach</option> <option value="safety">Safety Violation</option> <option value="corruption">Corruption</option> <option value="data-breach">Data Privacy Breach</option> <option value="other">Other</option> </select>
       </div>
       <div class="form-group"><label class="form-label" for="priority">Priority Level <span class="required">*</span></label> <select class="form-select" id="priority" required> <option value="">Select priority</option> <option value="critical">Critical</option> <option value="high">High</option> <option value="medium">Medium</option> <option value="low">Low</option> </select>
       </div>
       <div class="form-group"><label class="form-label" for="incidentDate">Date of Incident <span class="required">*</span></label> <input type="date" class="form-input" id="incidentDate" required>
       </div>
       <div class="form-group"><label class="form-label" for="incidentTime">Time of Incident</label> <input type="time" class="form-input" id="incidentTime">
       </div>
      </div>
      <div class="form-group"><label class="form-label" for="incidentLocation">Location of Incident <span class="required">*</span></label> <textarea class="form-textarea" id="incidentLocation" required placeholder="Provide detailed location information"></textarea>
      </div>
      <div class="form-group"><label class="form-label" for="complaintDescription">Detailed Description <span class="required">*</span></label> <textarea class="form-textarea" id="complaintDescription" style="min-height: 150px;" required placeholder="Provide a comprehensive account of the incident, including sequence of events, persons involved, and impact"></textarea>
      </div>
      <div class="form-group"><label class="form-label" for="evidenceDetails">Evidence Details</label> <textarea class="form-textarea" id="evidenceDetails" placeholder="Describe any documents, emails, recordings, or other evidence you have"></textarea>
      </div>
      <div class="form-group"><label class="form-label" for="witnessDetails">Witness Information</label> <textarea class="form-textarea" id="witnessDetails" placeholder="Names and contact details of any witnesses"></textarea>
      </div>
      <div class="form-group"><label class="form-label" for="reliefSought">Relief/Action Requested <span class="required">*</span></label> <textarea class="form-textarea" id="reliefSought" required placeholder="Specify what action or remedy you are seeking"></textarea>
      </div>
     </form>
     <div style="text-align: center; margin-top: 30px;"><button class="btn btn-secondary" onclick="previousStep(2)">Back</button> <button class="btn" onclick="nextStep(4)" style="margin-left: 15px;">Continue to Personal Details</button>
     </div>
    </div><!-- Step 4: Personal Information -->
    <div id="complaint-step-4" class="hidden">
     <h3 style="color: #c9302c; text-align: center; margin-bottom: 30px;">Step 4: Your Information</h3>
     <div class="form-grid">
      <div class="form-group"><label class="form-label" for="complainantName">Your Full Name <span class="required">*</span></label> <input type="text" class="form-input" id="complainantName" required>
      </div>
      <div class="form-group"><label class="form-label" for="complainantEmail">Email Address <span class="required">*</span></label> <input type="email" class="form-input" id="complainantEmail" required>
      </div>
      <div class="form-group"><label class="form-label" for="complainantPhone">Phone Number <span class="required">*</span></label> <input type="tel" class="form-input" id="complainantPhone" required>
      </div>
      <div class="form-group"><label class="form-label" for="complainantRelation">Relationship to Company</label> <select class="form-select" id="complainantRelation"> <option value="">Select relationship</option> <option value="employee">Current Employee</option> <option value="ex-employee">Former Employee</option> <option value="customer">Customer</option> <option value="vendor">Vendor/Supplier</option> <option value="partner">Business Partner</option> <option value="other">Other</option> </select>
      </div>
     </div>
     <div class="form-group"><label class="form-label" for="complainantAddress">Complete Address <span class="required">*</span></label> <textarea class="form-textarea" id="complainantAddress" required></textarea>
     </div>
     <div style="text-align: center; margin-top: 30px;"><button class="btn btn-secondary" onclick="previousStep(3)">Back</button> <button class="btn" onclick="submitComplaint()" style="margin-left: 15px;" id="submitComplaintBtn">Submit Complaint</button>
     </div>
    </div>
    <div id="complaintResult" class="hidden"></div>
   </section><!-- Track Case Section -->
   <section id="track-case-section" class="section hidden">
    <h2 class="section-title">Track Your Case</h2>
    <div class="form-group"><label class="form-label" for="trackingToken">Enter Case Token</label> <input type="text" class="form-input" id="trackingToken" placeholder="Enter your case tracking number"> <button class="btn" onclick="trackCase()" style="margin-top: 15px;">Search Case</button>
    </div>
    <div id="caseDetails" class="hidden"></div>
   </section><!-- Lawyer Connect Section -->
   <section id="lawyer-connect-section" class="section hidden">
    <h2 class="section-title">Connect with Lawyer</h2>
    <div class="form-group"><label class="form-label" for="lawyerCaseToken">Enter Your Case Token</label> <input type="text" class="form-input" id="lawyerCaseToken" placeholder="Enter case token to connect with assigned lawyer"> <button class="btn" onclick="connectWithLawyer()" style="margin-top: 15px;">Connect</button>
    </div>
    <div id="lawyerConnection" class="hidden"></div>
   </section><!-- Admin Login Section -->
   <section id="admin-login-section" class="section hidden">
    <div class="login-form">
     <h2 class="login-title">Administrative Access</h2>
     <div class="form-group"><label class="form-label" for="adminPassword">Access Code</label> <input type="password" class="form-input" id="adminPassword" placeholder="Enter administrative access code">
     </div><button class="btn" onclick="adminLogin()" style="width: 100%;">Access Admin Panel</button>
    </div>
   </section><!-- Edit Case Section -->
   <section id="edit-case-section" class="section hidden">
    <h2 class="section-title">Edit Case Details</h2>
    <div id="editCaseForm" class="hidden">
     <form id="caseEditForm">
      <div class="alert alert-info">
       <p><strong>Case Token:</strong> <span id="editCaseToken"></span></p>
       <p>You can modify the details below. Changes will be saved immediately.</p>
      </div>
      <h3 style="color: #2c3e50; margin: 30px 0 20px;">Employee Information</h3>
      <div class="form-grid">
       <div class="form-group"><label class="form-label" for="editEmployeeId">Employee ID</label> <input type="text" class="form-input" id="editEmployeeId">
       </div>
       <div class="form-group"><label class="form-label" for="editEmployeeName">Employee Name</label> <input type="text" class="form-input" id="editEmployeeName">
       </div>
       <div class="form-group"><label class="form-label" for="editEmployeeDesignation">Designation</label> <input type="text" class="form-input" id="editEmployeeDesignation">
       </div>
       <div class="form-group"><label class="form-label" for="editEmployeeDepartment">Department</label> <input type="text" class="form-input" id="editEmployeeDepartment">
       </div>
      </div>
      <h3 style="color: #2c3e50; margin: 30px 0 20px;">Complaint Details</h3>
      <div class="form-grid">
       <div class="form-group"><label class="form-label" for="editComplaintType">Complaint Type</label> <select class="form-select" id="editComplaintType"> <option value="harassment">Workplace Harassment</option> <option value="discrimination">Discrimination</option> <option value="fraud">Financial Fraud</option> <option value="breach_of_contract">Breach of Contract</option> <option value="negligence">Professional Negligence</option> <option value="misconduct">Employee Misconduct</option> <option value="safety_violation">Safety Violations</option> <option value="data_breach">Data Privacy Breach</option> <option value="corruption">Corruption/Bribery</option> <option value="defamation">Defamation</option> <option value="other">Other Legal Issue</option> </select>
       </div>
       <div class="form-group"><label class="form-label" for="editPriority">Priority Level</label> <select class="form-select" id="editPriority"> <option value="urgent">Urgent - Immediate Action Required</option> <option value="high">High - Serious Legal Matter</option> <option value="medium">Medium - Standard Processing</option> <option value="low">Low - Non-Critical Issue</option> </select>
       </div>
       <div class="form-group"><label class="form-label" for="editIncidentDate">Incident Date</label> <input type="date" class="form-input" id="editIncidentDate">
       </div>
       <div class="form-group"><label class="form-label" for="editIncidentTime">Incident Time</label> <input type="time" class="form-input" id="editIncidentTime">
       </div>
      </div>
      <div class="form-group"><label class="form-label" for="editIncidentLocation">Location of Incident</label> <textarea class="form-textarea" id="editIncidentLocation"></textarea>
      </div>
      <div class="form-group"><label class="form-label" for="editComplaintDescription">Complaint Description</label> <textarea class="form-textarea" id="editComplaintDescription" style="min-height: 150px;"></textarea>
      </div>
      <div class="form-group"><label class="form-label" for="editEvidenceDetails">Evidence Details</label> <textarea class="form-textarea" id="editEvidenceDetails"></textarea>
      </div>
      <div class="form-group"><label class="form-label" for="editWitnessDetails">Witness Information</label> <textarea class="form-textarea" id="editWitnessDetails"></textarea>
      </div>
      <div class="form-group"><label class="form-label" for="editReliefSought">Relief/Action Sought</label> <textarea class="form-textarea" id="editReliefSought"></textarea>
      </div>
      <h3 style="color: #2c3e50; margin: 30px 0 20px;">Your Information</h3>
      <div class="form-grid">
       <div class="form-group"><label class="form-label" for="editComplainantName">Your Name</label> <input type="text" class="form-input" id="editComplainantName">
       </div>
       <div class="form-group"><label class="form-label" for="editComplainantEmail">Email Address</label> <input type="email" class="form-input" id="editComplainantEmail">
       </div>
       <div class="form-group"><label class="form-label" for="editComplainantPhone">Phone Number</label> <input type="tel" class="form-input" id="editComplainantPhone">
       </div>
       <div class="form-group"><label class="form-label" for="editComplainantRelation">Relationship to Company</label> <select class="form-select" id="editComplainantRelation"> <option value="">Select relationship</option> <option value="employee">Current Employee</option> <option value="former_employee">Former Employee</option> <option value="customer">Customer/Client</option> <option value="vendor">Vendor/Supplier</option> <option value="partner">Business Partner</option> <option value="public">General Public</option> <option value="other">Other</option> </select>
       </div>
      </div>
      <div class="form-group"><label class="form-label" for="editComplainantAddress">Complete Address</label> <textarea class="form-textarea" id="editComplainantAddress"></textarea>
      </div>
      <div style="text-align: center; margin-top: 30px;"><button type="button" class="btn btn-secondary" onclick="cancelCaseEdit()">Cancel</button> <button type="submit" class="btn" style="margin-left: 15px;">Save Changes</button>
      </div>
     </form>
    </div>
    <div id="editCaseResult" class="hidden"></div>
   </section><!-- Admin Panel Section -->
   <section id="admin-panel-section" class="section hidden">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
     <h2 class="section-title" style="margin: 0;">Administrative Panel</h2><button class="btn btn-secondary" onclick="adminLogout()">Logout</button>
    </div>
    <div class="form-group"><input type="text" class="form-input" id="adminSearch" placeholder="Search by case token, complainant name, or company"> <button class="btn" onclick="searchCases()" style="margin-top: 10px;">Search Cases</button>
    </div>
    <div id="adminCases" class="loading">
     Loading cases...
    </div>
    <div id="lawyerChat" class="chat-container hidden">
     <h3 style="color: #c9302c;">Lawyer Chat - Case: <span id="chatCaseToken"></span></h3>
     <div class="chat-messages" id="chatMessages"></div>
     <div class="chat-input-group"><input type="text" class="chat-input" id="chatInput" placeholder="Type message to complainant..."> <button class="btn" onclick="sendChatMessage()">Send</button>
     </div>
     <div style="margin-top: 15px;"><button class="btn btn-warning" onclick="requestDetailedInfo()">Request Detailed Information</button>
     </div>
    </div>
   </section>
  </main>
  <script>
        // Default configuration
        const defaultConfig = {
            portal_title: "Dozera Law Enforcement Portal",
            department_name: "Dozera Group Legal Department",
            contact_details: "Legal Helpline: 1800-DOZERA-LAW\nEmergency: +91-7973804008"
        };

        let selectedCompany = '';
        let currentChatToken = null;
        let isAdminLoggedIn = false;
        let currentStep = 1;

        // Data SDK Handler
        const dataHandler = {
            onDataChanged(data) {
                console.log('Data updated:', data);
                if (isAdminLoggedIn && !document.getElementById('admin-panel-section').classList.contains('hidden')) {
                    loadAdminCases();
                }
            }
        };

        // Element SDK Configuration
        const elementConfig = {
            defaultConfig: defaultConfig,
            onConfigChange: async (config) => {
                const portalTitle = config.portal_title || defaultConfig.portal_title;
                const departmentName = config.department_name || defaultConfig.department_name;
                const contactDetails = config.contact_details || defaultConfig.contact_details;

                document.getElementById('portalTitle').textContent = portalTitle;
                document.getElementById('departmentName').textContent = departmentName;
                document.getElementById('contactDetails').innerHTML = contactDetails.replace(/\n/g, '<br>');
            },
            mapToCapabilities: (config) => ({
                recolorables: [],
                borderables: [],
                fontEditable: undefined,
                fontSizeable: undefined
            }),
            mapToEditPanelValues: (config) => new Map([
                ["portal_title", config.portal_title || defaultConfig.portal_title],
                ["department_name", config.department_name || defaultConfig.department_name],
                ["contact_details", config.contact_details || defaultConfig.contact_details]
            ])
        };

        // Initialize SDKs and Firebase
        async function initializeApp() {
            try {
                if (window.elementSdk) {
                    await window.elementSdk.init(elementConfig);
                }
                
                if (window.dataSdk) {
                    const result = await window.dataSdk.init(dataHandler);
                    if (!result.isOk) {
                        console.error('Failed to initialize Data SDK');
                    }
                }

                // Wait for Firebase to be ready
                const checkFirebase = setInterval(() => {
                    if (window.firebaseReady) {
                        clearInterval(checkFirebase);
                        console.log('Firebase is ready');
                    }
                }, 100);
            } catch (error) {
                console.error('Initialization error:', error);
            }
        }

        // Navigation
        function showSection(sectionName) {
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => section.classList.add('hidden'));
            
            const navButtons = document.querySelectorAll('.nav-btn');
            navButtons.forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(sectionName + '-section').classList.remove('hidden');
            event.target.classList.add('active');

            // Reset complaint form when navigating away
            if (sectionName !== 'file-complaint') {
                resetComplaintForm();
            }
        }

        // Company Selection
        function selectCompany(companyName) {
            selectedCompany = companyName;
            
            // Remove selection from all cards
            const cards = document.querySelectorAll('#companySelection .company-card');
            cards.forEach(card => card.classList.remove('selected'));
            
            // Add selection to clicked card
            event.target.classList.add('selected');
            
            // Enable next button
            document.getElementById('step1NextBtn').disabled = false;
        }

        // Step Navigation
        function nextStep(step) {
            // Validate current step
            if (step === 2 && !selectedCompany) {
                showAlert('Please select a company first', 'error');
                return;
            }
            
            if (step === 3) {
                const employeeId = document.getElementById('employeeId').value;
                const employeeName = document.getElementById('employeeName').value;
                if (!employeeId || !employeeName) {
                    showAlert('Please fill in required employee details', 'error');
                    return;
                }
            }

            // Hide current step
            document.getElementById(`complaint-step-${currentStep}`).classList.add('hidden');
            
            // Show next step
            document.getElementById(`complaint-step-${step}`).classList.remove('hidden');
            
            // Update step indicators
            document.getElementById(`step${currentStep}`).classList.remove('active');
            document.getElementById(`step${currentStep}`).classList.add('completed');
            document.getElementById(`step${step}`).classList.add('active');
            
            currentStep = step;
        }

        function previousStep(step) {
            // Hide current step
            document.getElementById(`complaint-step-${currentStep}`).classList.add('hidden');
            
            // Show previous step
            document.getElementById(`complaint-step-${step}`).classList.remove('hidden');
            
            // Update step indicators
            document.getElementById(`step${currentStep}`).classList.remove('active');
            document.getElementById(`step${step}`).classList.remove('completed');
            document.getElementById(`step${step}`).classList.add('active');
            
            currentStep = step;
        }

        // Generate unique token
        function generateToken() {
            const prefix = 'DZR';
            const timestamp = Date.now().toString(36).toUpperCase();
            const random = Math.random().toString(36).substr(2, 6).toUpperCase();
            return `${prefix}${timestamp}${random}`;
        }

        // Submit Complaint
        async function submitComplaint() {
            const submitBtn = document.getElementById('submitComplaintBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';
            
            try {
                const token = generateToken();
                const currentTime = new Date().toISOString();
                
                const complaintData = {
                    token: token,
                    target_company: selectedCompany,
                    employee_id: document.getElementById('employeeId').value,
                    employee_name: document.getElementById('employeeName').value,
                    employee_designation: document.getElementById('employeeDesignation').value,
                    employee_department: document.getElementById('employeeDepartment').value,
                    complaint_type: document.getElementById('complaintType').value,
                    priority: document.getElementById('priority').value,
                    incident_date: document.getElementById('incidentDate').value,
                    incident_time: document.getElementById('incidentTime').value,
                    incident_location: document.getElementById('incidentLocation').value,
                    complaint_description: document.getElementById('complaintDescription').value,
                    evidence_details: document.getElementById('evidenceDetails').value,
                    witness_details: document.getElementById('witnessDetails').value,
                    relief_sought: document.getElementById('reliefSought').value,
                    complainant_name: document.getElementById('complainantName').value,
                    complainant_email: document.getElementById('complainantEmail').value,
                    complainant_phone: document.getElementById('complainantPhone').value,
                    complainant_relation: document.getElementById('complainantRelation').value,
                    complainant_address: document.getElementById('complainantAddress').value,
                    status: 'pending',
                    assigned_lawyer: '',
                    created_at: currentTime,
                    updated_at: currentTime,
                    audit_trail: `Complaint filed against ${selectedCompany} on ${new Date(currentTime).toLocaleString()}`
                };

                // Save to Data SDK
                if (window.dataSdk) {
                    const result = await window.dataSdk.create(complaintData);
                    if (result.isOk) {
                        // Save to Firebase
                        await saveToFirebase(complaintData);
                        
                        // Generate PDF
                        generateComplaintPDF(complaintData);
                        
                        // Show success message
                        document.getElementById('complaintResult').innerHTML = `
                            <div class="alert alert-success">
                                <h3>Complaint Filed Successfully</h3>
                                <div class="token-display">
                                    Case Token: ${token}
                                </div>
                                <p><strong>Important:</strong> Please save this token number for future reference. 
                                Your legal complaint document has been generated and will download automatically.</p>
                                <p><strong>Target Company:</strong> ${selectedCompany}</p>
                                <p><strong>Employee:</strong> ${complaintData.employee_name} (ID: ${complaintData.employee_id})</p>
                                <p><strong>Next Steps:</strong> Your complaint has been registered and will be reviewed by our legal team. 
                                A lawyer will be assigned to your case within 24-48 hours.</p>
                                <button class="btn" onclick="trackCase('${token}')" style="margin-top: 15px;">Track This Case</button>
                            </div>
                        `;
                        document.getElementById('complaintResult').classList.remove('hidden');
                        
                        // Hide all steps and show result
                        for (let i = 1; i <= 4; i++) {
                            document.getElementById(`complaint-step-${i}`).classList.add('hidden');
                        }
                        
                    } else {
                        throw new Error('Failed to save complaint data');
                    }
                } else {
                    throw new Error('Data SDK not available');
                }
                
            } catch (error) {
                console.error('Error filing complaint:', error);
                document.getElementById('complaintResult').innerHTML = `
                    <div class="alert alert-error">
                        <h3>Error Filing Complaint</h3>
                        <p>There was an error processing your complaint. Please try again or contact technical support.</p>
                    </div>
                `;
                document.getElementById('complaintResult').classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Complaint';
            }
        }

        // Save to Firebase
        async function saveToFirebase(data) {
            if (window.firebaseDB && window.firebaseRefs) {
                try {
                    const { ref, push, set } = window.firebaseRefs;
                    const casesRef = ref(window.firebaseDB, 'cases');
                    const newCaseRef = push(casesRef);
                    await set(newCaseRef, data);
                    
                    // Also save to chats for lawyer communication
                    const chatsRef = ref(window.firebaseDB, `chats/${data.token}`);
                    await set(chatsRef, {
                        case_token: data.token,
                        messages: [],
                        created_at: data.created_at
                    });
                    
                    console.log('Data saved to Firebase successfully');
                } catch (error) {
                    console.error('Firebase save error:', error);
                }
            }
        }

        // Generate Complaint PDF
        function generateComplaintPDF(complaintData) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Header with Dozera branding
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('DOZERA GROUP', 105, 15, { align: 'center' });
            doc.text('LEGAL ENFORCEMENT DEPARTMENT', 105, 25, { align: 'center' });
            
            // Add logo placeholder
            doc.setLineWidth(2);
            doc.circle(105, 40, 10);
            doc.setFontSize(10);
            doc.text('DOZERA', 105, 42, { align: 'center' });
            doc.text('LAW', 105, 47, { align: 'center' });
            
            // Title and Token
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('LEGAL COMPLAINT REPORT', 105, 60, { align: 'center' });
            
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text(`Case No: ${complaintData.token}`, 105, 70, { align: 'center' });
            
            // Separator line
            doc.setLineWidth(1);
            doc.line(20, 75, 190, 75);
            
            let yPos = 85;
            const lineHeight = 7;
            
            // Case Information
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('CASE INFORMATION', 20, yPos);
            yPos += lineHeight + 2;
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            doc.text(`Date of Filing: ${new Date(complaintData.created_at).toLocaleDateString()}`, 25, yPos);
            yPos += lineHeight;
            doc.text(`Time of Filing: ${new Date(complaintData.created_at).toLocaleTimeString()}`, 25, yPos);
            yPos += lineHeight;
            doc.text(`Complaint Type: ${complaintData.complaint_type.toUpperCase()}`, 25, yPos);
            yPos += lineHeight;
            doc.text(`Priority Level: ${complaintData.priority.toUpperCase()}`, 25, yPos);
            yPos += lineHeight + 5;
            
            // Target Company and Employee
            doc.setFont(undefined, 'bold');
            doc.text('TARGET COMPANY & EMPLOYEE', 20, yPos);
            yPos += lineHeight + 2;
            
            doc.setFont(undefined, 'normal');
            doc.text(`Company: ${complaintData.target_company}`, 25, yPos);
            yPos += lineHeight;
            doc.text(`Employee Name: ${complaintData.employee_name}`, 25, yPos);
            yPos += lineHeight;
            doc.text(`Employee ID: ${complaintData.employee_id}`, 25, yPos);
            yPos += lineHeight;
            
            if (complaintData.employee_designation) {
                doc.text(`Designation: ${complaintData.employee_designation}`, 25, yPos);
                yPos += lineHeight;
            }
            
            if (complaintData.employee_department) {
                doc.text(`Department: ${complaintData.employee_department}`, 25, yPos);
                yPos += lineHeight;
            }
            yPos += 5;
            
            // Complainant Details
            doc.setFont(undefined, 'bold');
            doc.text('COMPLAINANT DETAILS', 20, yPos);
            yPos += lineHeight + 2;
            
            doc.setFont(undefined, 'normal');
            doc.text(`Name: ${complaintData.complainant_name}`, 25, yPos);
            yPos += lineHeight;
            doc.text(`Email: ${complaintData.complainant_email}`, 25, yPos);
            yPos += lineHeight;
            doc.text(`Phone: ${complaintData.complainant_phone}`, 25, yPos);
            yPos += lineHeight;
            
            if (complaintData.complainant_relation) {
                doc.text(`Relationship: ${complaintData.complainant_relation}`, 25, yPos);
                yPos += lineHeight;
            }
            
            const addressLines = doc.splitTextToSize(`Address: ${complaintData.complainant_address}`, 165);
            doc.text(addressLines, 25, yPos);
            yPos += addressLines.length * lineHeight + 5;
            
            // Incident Details
            if (yPos > 250) {
                doc.addPage();
                yPos = 20;
            }
            
            doc.setFont(undefined, 'bold');
            doc.text('INCIDENT DETAILS', 20, yPos);
            yPos += lineHeight + 2;
            
            doc.setFont(undefined, 'normal');
            doc.text(`Date of Incident: ${complaintData.incident_date}`, 25, yPos);
            yPos += lineHeight;
            
            if (complaintData.incident_time) {
                doc.text(`Time of Incident: ${complaintData.incident_time}`, 25, yPos);
                yPos += lineHeight;
            }
            
            const locationLines = doc.splitTextToSize(`Location: ${complaintData.incident_location}`, 165);
            doc.text(locationLines, 25, yPos);
            yPos += locationLines.length * lineHeight + 5;
            
            // Detailed Description
            doc.setFont(undefined, 'bold');
            doc.text('DETAILED COMPLAINT DESCRIPTION', 20, yPos);
            yPos += lineHeight + 2;
            
            doc.setFont(undefined, 'normal');
            const descriptionLines = doc.splitTextToSize(complaintData.complaint_description, 165);
            doc.text(descriptionLines, 25, yPos);
            yPos += descriptionLines.length * lineHeight + 5;
            
            // Evidence Details
            if (complaintData.evidence_details) {
                if (yPos > 240) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFont(undefined, 'bold');
                doc.text('EVIDENCE DETAILS', 20, yPos);
                yPos += lineHeight + 2;
                
                doc.setFont(undefined, 'normal');
                const evidenceLines = doc.splitTextToSize(complaintData.evidence_details, 165);
                doc.text(evidenceLines, 25, yPos);
                yPos += evidenceLines.length * lineHeight + 5;
            }
            
            // Witness Details
            if (complaintData.witness_details) {
                if (yPos > 240) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFont(undefined, 'bold');
                doc.text('WITNESS INFORMATION', 20, yPos);
                yPos += lineHeight + 2;
                
                doc.setFont(undefined, 'normal');
                const witnessLines = doc.splitTextToSize(complaintData.witness_details, 165);
                doc.text(witnessLines, 25, yPos);
                yPos += witnessLines.length * lineHeight + 5;
            }
            
            // Relief Sought
            if (yPos > 240) {
                doc.addPage();
                yPos = 20;
            }
            
            doc.setFont(undefined, 'bold');
            doc.text('RELIEF/ACTION SOUGHT', 20, yPos);
            yPos += lineHeight + 2;
            
            doc.setFont(undefined, 'normal');
            const reliefLines = doc.splitTextToSize(complaintData.relief_sought, 165);
            doc.text(reliefLines, 25, yPos);
            yPos += reliefLines.length * lineHeight + 10;
            
            // Declaration and Signature
            if (yPos > 250) {
                doc.addPage();
                yPos = 20;
            }
            
            doc.setFont(undefined, 'bold');
            doc.text('COMPLAINANT DECLARATION', 20, yPos);
            yPos += lineHeight + 2;
            
            doc.setFont(undefined, 'normal');
            doc.text('I hereby declare that the information provided above is true and correct to the best of my knowledge.', 25, yPos);
            doc.text('I understand that providing false information may result in legal consequences.', 25, yPos + lineHeight);
            yPos += lineHeight * 3;
            
            doc.text('Complainant Signature: _________________________', 25, yPos);
            yPos += lineHeight;
            doc.text(`Name: ${complaintData.complainant_name}`, 25, yPos);
            yPos += lineHeight;
            doc.text(`Date: ${new Date().toLocaleDateString()}`, 25, yPos);
            
            // Official Footer
            doc.setFontSize(10);
            doc.setFont(undefined, 'italic');
            doc.text('This is an official document generated by Dozera Law Enforcement Portal', 105, 285, { align: 'center' });
            doc.text(`Document ID: ${complaintData.token} | Generated on: ${new Date().toLocaleString()}`, 105, 290, { align: 'center' });
            
            // Download PDF
            doc.save(`Dozera_Legal_Complaint_${complaintData.token}.pdf`);
        }

        // Track Case Function
        async function trackCase(token = null) {
            const trackingToken = token || document.getElementById('trackingToken').value.trim();
            if (!trackingToken) {
                showAlert('Please enter a valid case token.', 'error');
                return;
            }
            
            try {
                // Search in Firebase
                if (window.firebaseDB && window.firebaseRefs) {
                    const { ref, get } = window.firebaseRefs;
                    const casesRef = ref(window.firebaseDB, 'cases');
                    const snapshot = await get(casesRef);
                    
                    if (snapshot.exists()) {
                        const cases = snapshot.val();
                        let foundCase = null;
                        
                        Object.keys(cases).forEach(key => {
                            if (cases[key].token === trackingToken) {
                                foundCase = cases[key];
                            }
                        });
                        
                        if (foundCase) {
                            displayCaseDetails(foundCase);
                        } else {
                            showAlert('Case not found. Please check your token number.', 'error');
                        }
                    } else {
                        showAlert('No cases found in the system.', 'error');
                    }
                }
            } catch (error) {
                console.error('Error tracking case:', error);
                showAlert('Error retrieving case details. Please try again.', 'error');
            }
        }

        // Display Case Details
        function displayCaseDetails(caseData) {
            const statusClass = `status-${caseData.status}`;
            document.getElementById('caseDetails').innerHTML = `
                <div class="case-card">
                    <div class="case-header">
                        <div class="case-token">Case Token: ${caseData.token}</div>
                        <span class="status-badge ${statusClass}">${caseData.status.toUpperCase()}</span>
                    </div>
                    <p><strong>Target Company:</strong> ${caseData.target_company}</p>
                    <p><strong>Employee:</strong> ${caseData.employee_name} (ID: ${caseData.employee_id})</p>
                    <p><strong>Complaint Type:</strong> ${caseData.complaint_type}</p>
                    <p><strong>Priority:</strong> ${caseData.priority}</p>
                    <p><strong>Filed Date:</strong> ${new Date(caseData.created_at).toLocaleDateString()}</p>
                    <p><strong>Last Updated:</strong> ${new Date(caseData.updated_at).toLocaleDateString()}</p>
                    ${caseData.assigned_lawyer ? `<p><strong>Assigned Lawyer:</strong> ${caseData.assigned_lawyer}</p>` : ''}
                    
                    <div class="case-actions">
                        <button class="btn" onclick="connectWithLawyer('${caseData.token}')">Chat with Lawyer</button>
                        <button class="btn btn-secondary" onclick="generateComplaintPDF(${JSON.stringify(caseData).replace(/"/g, '&quot;')})">Download PDF</button>
                        <button class="btn btn-warning" onclick="editCase('${caseData.token}')">Edit Case</button>
                    </div>
                    
                    <div class="audit-trail">
                        <h4 style="margin-top: 0;">Case Timeline</h4>
                        <div class="audit-entry">
                            <span class="audit-timestamp">${new Date(caseData.created_at).toLocaleString()}</span> - ${caseData.audit_trail}
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('caseDetails').classList.remove('hidden');
        }

        // Connect with Lawyer
        async function connectWithLawyer(token = null) {
            const caseToken = token || document.getElementById('lawyerCaseToken').value.trim();
            if (!caseToken) {
                showAlert('Please enter a valid case token.', 'error');
                return;
            }
            
            try {
                // Check if case exists and has assigned lawyer
                if (window.firebaseDB && window.firebaseRefs) {
                    const { ref, get } = window.firebaseRefs;
                    const casesRef = ref(window.firebaseDB, 'cases');
                    const snapshot = await get(casesRef);
                    
                    if (snapshot.exists()) {
                        const cases = snapshot.val();
                        let foundCase = null;
                        
                        Object.keys(cases).forEach(key => {
                            if (cases[key].token === caseToken) {
                                foundCase = cases[key];
                            }
                        });
                        
                        if (foundCase) {
                            if (foundCase.assigned_lawyer) {
                                displayLawyerChat(caseToken, foundCase.assigned_lawyer);
                            } else {
                                showAlert('No lawyer has been assigned to your case yet. Please wait for assignment.', 'error');
                            }
                        } else {
                            showAlert('Case not found. Please check your token number.', 'error');
                        }
                    }
                }
            } catch (error) {
                console.error('Error connecting with lawyer:', error);
                showAlert('Error connecting with lawyer. Please try again.', 'error');
            }
        }

        // Display Lawyer Chat
        function displayLawyerChat(caseToken, lawyerName) {
            document.getElementById('lawyerConnection').innerHTML = `
                <div class="chat-container">
                    <h3 style="color: #c9302c;">Chat with ${lawyerName} - Case: ${caseToken}</h3>
                    <div class="chat-messages" id="userChatMessages"></div>
                    <div class="chat-input-group">
                        <input type="text" class="chat-input" id="userChatInput" placeholder="Type your message...">
                        <button class="btn" onclick="sendUserMessage('${caseToken}')">Send</button>
                    </div>
                </div>
            `;
            document.getElementById('lawyerConnection').classList.remove('hidden');
            loadUserChatMessages(caseToken);
        }

        // Load User Chat Messages
        async function loadUserChatMessages(caseToken) {
            if (window.firebaseDB && window.firebaseRefs) {
                const { ref, onValue } = window.firebaseRefs;
                const chatRef = ref(window.firebaseDB, `chats/${caseToken}/messages`);
                
                onValue(chatRef, (snapshot) => {
                    const messages = snapshot.val() || [];
                    const chatContainer = document.getElementById('userChatMessages');
                    
                    chatContainer.innerHTML = '';
                    messages.forEach(message => {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `chat-message ${message.sender === 'lawyer' ? 'chat-lawyer' : 'chat-user'}`;
                        messageDiv.innerHTML = `
                            <strong>${message.sender === 'lawyer' ? 'Lawyer' : 'You'}:</strong> ${message.text}
                            <br><small>${new Date(message.timestamp).toLocaleString()}</small>
                        `;
                        chatContainer.appendChild(messageDiv);
                    });
                    
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                });
            }
        }

        // Send User Message
        async function sendUserMessage(caseToken) {
            const input = document.getElementById('userChatInput');
            const message = input.value.trim();
            
            if (message && window.firebaseDB && window.firebaseRefs) {
                try {
                    const { ref, get, set } = window.firebaseRefs;
                    const chatRef = ref(window.firebaseDB, `chats/${caseToken}/messages`);
                    const snapshot = await get(chatRef);
                    const messages = snapshot.val() || [];
                    
                    messages.push({
                        sender: 'user',
                        text: message,
                        timestamp: new Date().toISOString()
                    });
                    
                    await set(chatRef, messages);
                    input.value = '';
                } catch (error) {
                    console.error('Error sending message:', error);
                    showAlert('Error sending message. Please try again.', 'error');
                }
            }
        }

        // Admin Login
        function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            if (password === '7973804008') {
                isAdminLoggedIn = true;
                document.getElementById('admin-login-section').classList.add('hidden');
                document.getElementById('admin-panel-section').classList.remove('hidden');
                loadAdminCases();
            } else {
                showAlert('Invalid access code. Please try again.', 'error');
            }
        }

        // Admin Logout
        function adminLogout() {
            isAdminLoggedIn = false;
            document.getElementById('admin-panel-section').classList.add('hidden');
            document.getElementById('admin-login-section').classList.remove('hidden');
            document.getElementById('adminPassword').value = '';
        }

        // Load Admin Cases
        async function loadAdminCases() {
            const adminCases = document.getElementById('adminCases');
            adminCases.innerHTML = '<div class="loading">Loading cases...</div>';
            
            try {
                if (window.firebaseDB && window.firebaseRefs) {
                    const { ref, get } = window.firebaseRefs;
                    const casesRef = ref(window.firebaseDB, 'cases');
                    const snapshot = await get(casesRef);
                    
                    if (snapshot.exists()) {
                        const cases = snapshot.val();
                        let casesHTML = '';
                        
                        Object.keys(cases).forEach(key => {
                            const caseData = cases[key];
                            const statusClass = `status-${caseData.status}`;
                            
                            casesHTML += `
                                <div class="case-card">
                                    <div class="case-header">
                                        <div class="case-token">${caseData.token}</div>
                                        <span class="status-badge ${statusClass}">${caseData.status.toUpperCase()}</span>
                                    </div>
                                    <p><strong>Company:</strong> ${caseData.target_company}</p>
                                    <p><strong>Employee:</strong> ${caseData.employee_name} (${caseData.employee_id})</p>
                                    <p><strong>Type:</strong> ${caseData.complaint_type}</p>
                                    <p><strong>Complainant:</strong> ${caseData.complainant_name}</p>
                                    <p><strong>Filed:</strong> ${new Date(caseData.created_at).toLocaleDateString()}</p>
                                    <div class="case-actions">
                                        <button class="btn btn-secondary" onclick="updateCaseStatus('${caseData.token}', 'under-review')">Mark Under Review</button>
                                        <button class="btn btn-success" onclick="assignLawyer('${caseData.token}')">Assign Lawyer</button>
                                        <button class="btn" onclick="startAdminChat('${caseData.token}')">Start Chat</button>
                                        <button class="btn btn-secondary" onclick="generateComplaintPDF(${JSON.stringify(caseData).replace(/"/g, '&quot;')})">Download PDF</button>
                                    </div>
                                </div>
                            `;
                        });
                        
                        adminCases.innerHTML = casesHTML || '<p>No cases found.</p>';
                    } else {
                        adminCases.innerHTML = '<p>No cases found.</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading admin cases:', error);
                adminCases.innerHTML = '<p>Error loading cases. Please try again.</p>';
            }
        }

        // Update Case Status
        async function updateCaseStatus(token, status) {
            try {
                if (window.firebaseDB && window.firebaseRefs) {
                    const { ref, get, set } = window.firebaseRefs;
                    const casesRef = ref(window.firebaseDB, 'cases');
                    const snapshot = await get(casesRef);
                    
                    if (snapshot.exists()) {
                        const cases = snapshot.val();
                        Object.keys(cases).forEach(async (key) => {
                            if (cases[key].token === token) {
                                cases[key].status = status;
                                cases[key].updated_at = new Date().toISOString();
                                cases[key].audit_trail += `\n${new Date().toLocaleString()} - Status updated to ${status}`;
                                
                                const caseRef = ref(window.firebaseDB, `cases/${key}`);
                                await set(caseRef, cases[key]);
                            }
                        });
                    }
                }
                
                showAlert(`Case ${token} status updated to ${status}`, 'success');
                loadAdminCases();
            } catch (error) {
                console.error('Error updating case status:', error);
                showAlert('Error updating case status', 'error');
            }
        }

        // Assign Lawyer
        async function assignLawyer(token) {
            const lawyerName = prompt('Enter lawyer name:');
            if (lawyerName) {
                try {
                    if (window.firebaseDB && window.firebaseRefs) {
                        const { ref, get, set } = window.firebaseRefs;
                        const casesRef = ref(window.firebaseDB, 'cases');
                        const snapshot = await get(casesRef);
                        
                        if (snapshot.exists()) {
                            const cases = snapshot.val();
                            Object.keys(cases).forEach(async (key) => {
                                if (cases[key].token === token) {
                                    cases[key].assigned_lawyer = lawyerName;
                                    cases[key].status = 'active';
                                    cases[key].updated_at = new Date().toISOString();
                                    cases[key].audit_trail += `\n${new Date().toLocaleString()} - Lawyer ${lawyerName} assigned`;
                                    
                                    const caseRef = ref(window.firebaseDB, `cases/${key}`);
                                    await set(caseRef, cases[key]);
                                }
                            });
                        }
                    }
                    
                    showAlert(`Lawyer ${lawyerName} assigned to case ${token}`, 'success');
                    loadAdminCases();
                } catch (error) {
                    console.error('Error assigning lawyer:', error);
                    showAlert('Error assigning lawyer', 'error');
                }
            }
        }

        // Start Admin Chat
        function startAdminChat(token) {
            currentChatToken = token;
            document.getElementById('chatCaseToken').textContent = token;
            document.getElementById('lawyerChat').classList.remove('hidden');
            loadAdminChatMessages(token);
        }

        // Load Admin Chat Messages
        async function loadAdminChatMessages(caseToken) {
            if (window.firebaseDB && window.firebaseRefs) {
                const { ref, onValue } = window.firebaseRefs;
                const chatRef = ref(window.firebaseDB, `chats/${caseToken}/messages`);
                
                onValue(chatRef, (snapshot) => {
                    const messages = snapshot.val() || [];
                    const chatContainer = document.getElementById('chatMessages');
                    
                    chatContainer.innerHTML = '';
                    messages.forEach(message => {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `chat-message ${message.sender === 'lawyer' ? 'chat-admin' : 'chat-user'}`;
                        messageDiv.innerHTML = `
                            <strong>${message.sender === 'lawyer' ? 'Lawyer' : 'User'}:</strong> ${message.text}
                            <br><small>${new Date(message.timestamp).toLocaleString()}</small>
                        `;
                        chatContainer.appendChild(messageDiv);
                    });
                    
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                });
            }
        }

        // Send Chat Message (Admin)
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message && currentChatToken && window.firebaseDB && window.firebaseRefs) {
                try {
                    const { ref, get, set } = window.firebaseRefs;
                    const chatRef = ref(window.firebaseDB, `chats/${currentChatToken}/messages`);
                    const snapshot = await get(chatRef);
                    const messages = snapshot.val() || [];
                    
                    messages.push({
                        sender: 'lawyer',
                        text: message,
                        timestamp: new Date().toISOString()
                    });
                    
                    await set(chatRef, messages);
                    input.value = '';
                } catch (error) {
                    console.error('Error sending message:', error);
                    showAlert('Error sending message. Please try again.', 'error');
                }
            }
        }

        // Request Detailed Information
        async function requestDetailedInfo() {
            if (currentChatToken && window.firebaseDB && window.firebaseRefs) {
                try {
                    const { ref, get, set } = window.firebaseRefs;
                    const chatRef = ref(window.firebaseDB, `chats/${currentChatToken}/messages`);
                    const snapshot = await get(chatRef);
                    const messages = snapshot.val() || [];
                    
                    const detailRequest = `Please provide more detailed information about your complaint. Include:
1. Exact timeline of events
2. Any additional witnesses
3. More specific details about the incident
4. Any communication records (emails, messages, etc.)
5. Impact on you personally or professionally

This information will help us better understand your case and provide appropriate legal assistance.`;
                    
                    messages.push({
                        sender: 'lawyer',
                        text: detailRequest,
                        timestamp: new Date().toISOString(),
                        type: 'detail_request'
                    });
                    
                    await set(chatRef, messages);
                    showAlert('Detailed information request sent to complainant', 'success');
                } catch (error) {
                    console.error('Error sending detail request:', error);
                    showAlert('Error sending request. Please try again.', 'error');
                }
            }
        }

        // Search Cases
        async function searchCases() {
            const searchTerm = document.getElementById('adminSearch').value.trim().toLowerCase();
            if (!searchTerm) {
                loadAdminCases();
                return;
            }
            
            try {
                if (window.firebaseDB && window.firebaseRefs) {
                    const { ref, get } = window.firebaseRefs;
                    const casesRef = ref(window.firebaseDB, 'cases');
                    const snapshot = await get(casesRef);
                    
                    if (snapshot.exists()) {
                        const cases = snapshot.val();
                        let filteredCasesHTML = '';
                        
                        Object.keys(cases).forEach(key => {
                            const caseData = cases[key];
                            const searchableText = `${caseData.token} ${caseData.complainant_name} ${caseData.target_company} ${caseData.employee_name}`.toLowerCase();
                            
                            if (searchableText.includes(searchTerm)) {
                                const statusClass = `status-${caseData.status}`;
                                filteredCasesHTML += `
                                    <div class="case-card">
                                        <div class="case-header">
                                            <div class="case-token">${caseData.token}</div>
                                            <span class="status-badge ${statusClass}">${caseData.status.toUpperCase()}</span>
                                        </div>
                                        <p><strong>Company:</strong> ${caseData.target_company}</p>
                                        <p><strong>Employee:</strong> ${caseData.employee_name} (${caseData.employee_id})</p>
                                        <p><strong>Type:</strong> ${caseData.complaint_type}</p>
                                        <p><strong>Complainant:</strong> ${caseData.complainant_name}</p>
                                        <p><strong>Filed:</strong> ${new Date(caseData.created_at).toLocaleDateString()}</p>
                                        <div class="case-actions">
                                            <button class="btn btn-secondary" onclick="updateCaseStatus('${caseData.token}', 'under-review')">Mark Under Review</button>
                                            <button class="btn btn-success" onclick="assignLawyer('${caseData.token}')">Assign Lawyer</button>
                                            <button class="btn" onclick="startAdminChat('${caseData.token}')">Start Chat</button>
                                            <button class="btn btn-secondary" onclick="generateComplaintPDF(${JSON.stringify(caseData).replace(/"/g, '&quot;')})">Download PDF</button>
                                        </div>
                                    </div>
                                `;
                            }
                        });
                        
                        document.getElementById('adminCases').innerHTML = filteredCasesHTML || '<p>No matching cases found.</p>';
                    }
                }
            } catch (error) {
                console.error('Error searching cases:', error);
                showAlert('Error searching cases. Please try again.', 'error');
            }
        }

        // Reset Complaint Form
        function resetComplaintForm() {
            selectedCompany = '';
            currentStep = 1;
            
            // Reset step indicators
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`step${i}`).classList.remove('active', 'completed');
                document.getElementById(`complaint-step-${i}`).classList.add('hidden');
            }
            
            document.getElementById('step1').classList.add('active');
            document.getElementById('complaint-step-1').classList.remove('hidden');
            document.getElementById('step1NextBtn').disabled = true;
            
            // Clear form fields
            const inputs = document.querySelectorAll('#file-complaint-section input, #file-complaint-section select, #file-complaint-section textarea');
            inputs.forEach(input => input.value = '');
            
            // Remove company selections
            const companyCards = document.querySelectorAll('#companySelection .company-card');
            companyCards.forEach(card => card.classList.remove('selected'));
            
            // Hide result
            document.getElementById('complaintResult').classList.add('hidden');
        }

        // Edit Case (placeholder function)
        function editCase(token) {
            showAlert('Case editing feature will be available soon. Please contact admin for modifications.', 'error');
        }

        // Show Alert
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Chat input enter key support
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (e.target.id === 'chatInput') {
                    sendChatMessage();
                } else if (e.target.id === 'userChatInput') {
                    const caseToken = e.target.getAttribute('data-case-token');
                    if (caseToken) {
                        sendUserMessage(caseToken);
                    }
                }
            }
        });

        // Edit Case Functions
        let currentEditToken = null;

        async function editCase(token) {
            try {
                currentEditToken = token;
                
                // Get case data from Firebase
                const caseRef = window.firebaseRef(window.firebaseDB, `legal_cases/${token}`);
                const snapshot = await window.firebaseGet(caseRef);
                
                if (snapshot.exists()) {
                    const caseData = snapshot.val();
                    populateEditForm(caseData);
                    
                    // Show edit section
                    document.querySelectorAll('.section').forEach(section => section.classList.add('hidden'));
                    document.getElementById('edit-case-section').classList.remove('hidden');
                    document.getElementById('editCaseForm').classList.remove('hidden');
                } else {
                    showAlert('Case not found for editing', 'error');
                }
            } catch (error) {
                console.error('Error loading case for edit:', error);
                showAlert('Error loading case details for editing', 'error');
            }
        }

        function populateEditForm(caseData) {
            document.getElementById('editCaseToken').textContent = caseData.token;
            document.getElementById('editEmployeeId').value = caseData.employee_id || '';
            document.getElementById('editEmployeeName').value = caseData.employee_name || '';
            document.getElementById('editEmployeeDesignation').value = caseData.employee_designation || '';
            document.getElementById('editEmployeeDepartment').value = caseData.employee_department || '';
            document.getElementById('editComplaintType').value = caseData.complaint_type || '';
            document.getElementById('editPriority').value = caseData.priority || '';
            document.getElementById('editIncidentDate').value = caseData.incident_date || '';
            document.getElementById('editIncidentTime').value = caseData.incident_time || '';
            document.getElementById('editIncidentLocation').value = caseData.incident_location || '';
            document.getElementById('editComplaintDescription').value = caseData.complaint_description || '';
            document.getElementById('editEvidenceDetails').value = caseData.evidence_details || '';
            document.getElementById('editWitnessDetails').value = caseData.witness_details || '';
            document.getElementById('editReliefSought').value = caseData.relief_sought || '';
            document.getElementById('editComplainantName').value = caseData.complainant_name || '';
            document.getElementById('editComplainantEmail').value = caseData.complainant_email || '';
            document.getElementById('editComplainantPhone').value = caseData.complainant_phone || '';
            document.getElementById('editComplainantRelation').value = caseData.complainant_relation || '';
            document.getElementById('editComplainantAddress').value = caseData.complainant_address || '';
        }

        function cancelCaseEdit() {
            document.getElementById('edit-case-section').classList.add('hidden');
            document.getElementById('track-case-section').classList.remove('hidden');
            currentEditToken = null;
        }

        async function viewUpdatedCase(token) {
            // Set the tracking token and trigger case tracking
            document.getElementById('trackingToken').value = token;
            
            // Switch to track case section
            document.querySelectorAll('.section').forEach(section => section.classList.add('hidden'));
            document.getElementById('track-case-section').classList.remove('hidden');
            
            // Update navigation
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.nav-btn[onclick="showSection(\'track-case\')"]').classList.add('active');
            
            // Track the case
            await trackCase();
            
            currentEditToken = null;
        }

        // Handle case edit form submission
        document.getElementById('caseEditForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentEditToken) {
                showAlert('No case selected for editing', 'error');
                return;
            }
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';
            
            try {
                const updatedData = {
                    employee_id: document.getElementById('editEmployeeId').value.trim(),
                    employee_name: document.getElementById('editEmployeeName').value.trim(),
                    employee_designation: document.getElementById('editEmployeeDesignation').value.trim(),
                    employee_department: document.getElementById('editEmployeeDepartment').value.trim(),
                    complaint_type: document.getElementById('editComplaintType').value,
                    priority: document.getElementById('editPriority').value,
                    incident_date: document.getElementById('editIncidentDate').value,
                    incident_time: document.getElementById('editIncidentTime').value,
                    incident_location: document.getElementById('editIncidentLocation').value.trim(),
                    complaint_description: document.getElementById('editComplaintDescription').value.trim(),
                    evidence_details: document.getElementById('editEvidenceDetails').value.trim(),
                    witness_details: document.getElementById('editWitnessDetails').value.trim(),
                    relief_sought: document.getElementById('editReliefSought').value.trim(),
                    complainant_name: document.getElementById('editComplainantName').value.trim(),
                    complainant_email: document.getElementById('editComplainantEmail').value.trim(),
                    complainant_phone: document.getElementById('editComplainantPhone').value.trim(),
                    complainant_relation: document.getElementById('editComplainantRelation').value,
                    complainant_address: document.getElementById('editComplainantAddress').value.trim(),
                    updated_at: new Date().toISOString()
                };
                
                // Update Firebase
                const caseRef = window.firebaseRef(window.firebaseDB, `legal_cases/${currentEditToken}`);
                await window.firebaseUpdate(caseRef, updatedData);
                
                // Try to update Data SDK as well
                if (window.dataSdk) {
                    try {
                        // Get current case data first
                        const snapshot = await window.firebaseGet(caseRef);
                        if (snapshot.exists()) {
                            const fullCaseData = snapshot.val();
                            const result = await window.dataSdk.update(fullCaseData);
                            if (!result.isOk) {
                                console.warn('Data SDK update failed:', result.error);
                            }
                        }
                    } catch (sdkError) {
                        console.warn('Data SDK update error:', sdkError);
                    }
                }
                
                // Show success message
                document.getElementById('editCaseResult').innerHTML = `
                    <div class="alert alert-success">
                        <h3>Case Updated Successfully</h3>
                        <p>Your case details have been updated and saved.</p>
                        <p><strong>Case Token:</strong> ${currentEditToken}</p>
                        <div style="margin-top: 15px;">
                            <button class="btn" onclick="viewUpdatedCase('${currentEditToken}')">View Updated Case</button>
                            <button class="btn btn-secondary" onclick="cancelCaseEdit()" style="margin-left: 10px;">Close</button>
                        </div>
                    </div>
                `;
                document.getElementById('editCaseResult').classList.remove('hidden');
                document.getElementById('editCaseForm').classList.add('hidden');
                
            } catch (error) {
                console.error('Error updating case:', error);
                document.getElementById('editCaseResult').innerHTML = `
                    <div class="alert alert-error">
                        <h3>Error Updating Case</h3>
                        <p>There was an error updating your case. Please try again.</p>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `;
                document.getElementById('editCaseResult').classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Changes';
            }
        });

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dozera Law Enforcement Portal</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script><!-- Firebase SDK -->
  <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getDatabase, ref, push, set, get, onValue, update } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyC30TcmMVhP_8HdFYS1WufRiZwSDYNMTF0",
            authDomain: "pulse2-92372.firebaseapp.com",
            databaseURL: "https://pulse2-92372-default-rtdb.firebaseio.com",
            projectId: "pulse2-92372",
            storageBucket: "pulse2-92372.firebasestorage.app",
            messagingSenderId: "276235725177",
            appId: "1:276235725177:web:0f4e0789fae80a435927a8"
        };
        
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        window.firebaseDB = database;
        window.firebaseRef = ref;
        window.firebasePush = push;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebaseOnValue = onValue;
        window.firebaseUpdate = update;
    </script>
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Times New Roman', serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #2c3e50;
            min-height: 100%;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #c9302c 0%, #e74c3c 50%, #8b0000 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            border-bottom: 4px solid #ffd700;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .dozera-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid #fff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .title-section h1 {
            margin: 0;
            font-size: 28px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .title-section p {
            margin: 5px 0 0 0;
            font-size: 16px;
            color: #e8e8e8;
        }

        .contact-info {
            text-align: right;
            font-size: 14px;
            color: #ffd700;
        }

        .navigation {
            background: rgba(52, 73, 94, 0.95);
            padding: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: none;
            border: none;
            color: white;
            padding: 15px 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .nav-btn:hover, .nav-btn.active {
            background: linear-gradient(135deg, #c9302c, #e74c3c);
            border-bottom-color: #ffd700;
            transform: translateY(-2px);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .section-title {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #c9302c;
            background: linear-gradient(135deg, #c9302c, #e74c3c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .company-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .company-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .company-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(201, 48, 44, 0.1), transparent);
            transition: left 0.5s;
        }

        .company-card:hover::before {
            left: 100%;
        }

        .company-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(201, 48, 44, 0.2);
            border-color: #c9302c;
        }

        .company-card.selected {
            background: linear-gradient(135deg, #c9302c, #e74c3c);
            color: white;
            border-color: #ffd700;
            transform: translateY(-5px);
        }

        .company-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .company-desc {
            font-size: 14px;
            color: #6c757d;
        }

        .company-card.selected .company-desc {
            color: #f8f9fa;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .required {
            color: #c9302c;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.9);
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #c9302c;
            box-shadow: 0 0 10px rgba(201, 48, 44, 0.3);
            background: white;
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .btn {
            background: linear-gradient(135deg, #c9302c, #e74c3c);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(201, 48, 44, 0.3);
        }

        .btn:hover {
            background: linear-gradient(135deg, #a02622, #c0392b);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(201, 48, 44, 0.4);
        }

        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #34495e, #2c3e50);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #2c3e50, #1a252f);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #229954, #27ae60);
        }

        .token-display {
            background: linear-gradient(135deg, #c9302c, #e74c3c);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            font-size: 22px;
            font-weight: bold;
            border: 3px solid #ffd700;
            box-shadow: 0 8px 25px rgba(201, 48, 44, 0.4);
            position: relative;
            overflow: hidden;
        }

        .token-display::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,215,0,0.1), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .status-pending { 
            background: linear-gradient(135deg, #f39c12, #e67e22); 
            color: white; 
        }
        .status-active { 
            background: linear-gradient(135deg, #3498db, #2980b9); 
            color: white; 
        }
        .status-under-review { 
            background: linear-gradient(135deg, #9b59b6, #8e44ad); 
            color: white; 
        }
        .status-resolved { 
            background: linear-gradient(135deg, #27ae60, #2ecc71); 
            color: white; 
        }
        .status-closed { 
            background: linear-gradient(135deg, #95a5a6, #7f8c8d); 
            color: white; 
        }

        .case-card {
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            border: 2px solid #dee2e6;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .case-card:hover {
            box-shadow: 0 8px 30px rgba(201, 48, 44, 0.15);
            transform: translateY(-3px);
            border-color: #c9302c;
        }

        .case-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .case-token {
            font-size: 20px;
            font-weight: bold;
            color: #c9302c;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .case-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .case-actions .btn {
            padding: 8px 16px;
            font-size: 14px;
        }

        .login-form {
            max-width: 450px;
            margin: 50px auto;
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .login-title {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
            font-size: 26px;
            font-weight: bold;
        }

        .chat-container {
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            border-radius: 15px;
            padding: 25px;
            margin-top: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .chat-messages {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            background: white;
            margin-bottom: 20px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.05);
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .chat-admin {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            margin-left: 20px;
            border-left: 4px solid #2196f3;
        }

        .chat-user {
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
            margin-right: 20px;
            border-left: 4px solid #9c27b0;
        }

        .chat-lawyer {
            background: linear-gradient(135deg, #fff3e0, #ffcc02);
            margin-left: 10px;
            margin-right: 10px;
            border-left: 4px solid #ff9800;
        }

        .chat-input-group {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            min-height: 50px;
            resize: vertical;
        }

        .alert {
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .alert-success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            border: 2px solid #b8daff;
        }

        .alert-error {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .alert-info {
            background: linear-gradient(135deg, #d1ecf1, #bee5eb);
            color: #0c5460;
            border: 2px solid #b8daff;
        }

        .audit-trail {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-left: 5px solid #3498db;
            border-radius: 8px;
            padding: 20px;
            margin-top: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .audit-entry {
            margin-bottom: 12px;
            font-size: 14px;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .audit-entry:last-child {
            border-bottom: none;
        }

        .audit-timestamp {
            color: #c9302c;
            font-weight: bold;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 30px;
            font-size: 18px;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .step {
            display: flex;
            align-items: center;
            margin: 0 10px;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #bdc3c7;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }

        .step.active .step-number {
            background: linear-gradient(135deg, #c9302c, #e74c3c);
        }

        .step.completed .step-number {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        .lawyer-request {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 2px solid #ffc107;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.2);
        }

        .detailed-description {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            min-height: 200px;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }

            .nav-container {
                flex-direction: column;
            }

            .form-grid, .company-grid {
                grid-template-columns: 1fr;
            }

            .case-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .case-actions {
                justify-content: flex-start;
            }

            .step-indicator {
                flex-direction: column;
                align-items: center;
            }

            .step {
                margin: 5px 0;
            }
        }
    </style>
  <header class="header">
   <div class="header-content">
    <div class="logo-section">
     <div class="dozera-logo">
      <svg width="60" height="60" viewbox="0 0 100 100" fill="none"><circle cx="50" cy="50" r="45" fill="#c9302c" /> <text x="50" y="35" text-anchor="middle" fill="#ffd700" font-size="16" font-weight="bold">
        D
       </text> <text x="50" y="55" text-anchor="middle" fill="#ffd700" font-size="12" font-weight="bold">
        LAW
       </text> <circle cx="50" cy="70" r="8" fill="#ffd700" />
      </svg>
     </div>
     <div class="title-section">
      <h1 id="portalTitle">Dozera Law Enforcement Portal</h1>
      <p id="departmentName">Dozera Group Legal Department</p>
     </div>
    </div>
    <div class="contact-info" id="contactDetails">
     Legal Helpline: 1800-DOZERA-LAW
    </div>
   </div>
  </header>
  <nav class="navigation">
   <div class="nav-container"><button class="nav-btn active" onclick="showSection('home')">Home</button> <button class="nav-btn" onclick="showSection('file-complaint')">File Complaint</button> <button class="nav-btn" onclick="showSection('track-case')">Track Case</button> <button class="nav-btn" onclick="showSection('lawyer-chat')">Lawyer Chat</button> <button class="nav-btn" onclick="showSection('admin-login')">Admin Access</button>
   </div>
  </nav>
  <main class="container"><!-- Home Section -->
   <section id="home-section" class="section">
    <h2 class="section-title">Welcome to Dozera Law Enforcement Portal</h2>
    <div class="alert alert-info">
     <h3 style="margin-top: 0;">Legal Notice</h3>
     <p>This portal enables filing legal complaints against Dozera Group companies and their employees. All proceedings are conducted under legal supervision with proper documentation and lawyer assistance.</p>
    </div>
    <div class="company-grid">
     <div style="background: linear-gradient(135deg, #e8f4fd, #d1ecf1); padding: 25px; border-radius: 15px; border-left: 5px solid #3498db;">
      <h3 style="color: #2c3e50; margin-top: 0;">File Legal Complaint</h3>
      <p>Submit formal complaints against Dozera Group companies and employees. Each case receives professional legal documentation and lawyer assignment.</p>
     </div>
     <div style="background: linear-gradient(135deg, #fff3cd, #ffeaa7); padding: 25px; border-radius: 15px; border-left: 5px solid #ffc107;">
      <h3 style="color: #2c3e50; margin-top: 0;">Track Case Progress</h3>
      <p>Monitor your case status, receive updates, and communicate with assigned lawyers through our secure messaging system.</p>
     </div>
     <div style="background: linear-gradient(135deg, #d1ecf1, #bee5eb); padding: 25px; border-radius: 15px; border-left: 5px solid #17a2b8;">
      <h3 style="color: #2c3e50; margin-top: 0;">Professional Documentation</h3>
      <p>Automatically generated legal documents with official formatting, case references, and professional legal language.</p>
     </div>
    </div>
    <div style="background: linear-gradient(135deg, #f8f9fa, #ffffff); padding: 25px; border-radius: 15px; margin-top: 30px; border: 2px solid #dee2e6;">
     <h3 style="color: #c9302c; margin-top: 0;">Dozera Group Companies</h3>
     <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
      <div style="padding: 10px; background: #e9ecef; border-radius: 8px; text-align: center;">
       Dozera Ltd
      </div>
      <div style="padding: 10px; background: #e9ecef; border-radius: 8px; text-align: center;">
       Dozera Shop
      </div>
      <div style="padding: 10px; background: #e9ecef; border-radius: 8px; text-align: center;">
       Saint Soul
      </div>
      <div style="padding: 10px; background: #e9ecef; border-radius: 8px; text-align: center;">
       Zynk
      </div>
      <div style="padding: 10px; background: #e9ecef; border-radius: 8px; text-align: center;">
       Dozera Construction
      </div>
      <div style="padding: 10px; background: #e9ecef; border-radius: 8px; text-align: center;">
       Dozera Cloud &amp; Storage
      </div>
      <div style="padding: 10px; background: #e9ecef; border-radius: 8px; text-align: center;">
       Dozera Law Department
      </div>
      <div style="padding: 10px; background: #e9ecef; border-radius: 8px; text-align: center;">
       Dozera F1
      </div>
      <div style="padding: 10px; background: #e9ecef; border-radius: 8px; text-align: center;">
       Jet2 Airline
      </div>
      <div style="padding: 10px; background: #e9ecef; border-radius: 8px; text-align: center;">
       Oriontec Inc
      </div>
     </div>
    </div>
   </section><!-- File Complaint Section -->
   <section id="file-complaint-section" class="section hidden">
    <h2 class="section-title">File Legal Complaint Against Dozera Group</h2>
    <div class="step-indicator">
     <div class="step active" id="step1">
      <div class="step-number">
       1
      </div><span>Company Selection</span>
     </div>
     <div class="step" id="step2">
      <div class="step-number">
       2
      </div><span>Employee Details</span>
     </div>
     <div class="step" id="step3">
      <div class="step-number">
       3
      </div><span>Complaint Details</span>
     </div>
     <div class="step" id="step4">
      <div class="step-number">
       4
      </div><span>Submit &amp; Review</span>
     </div>
    </div>
    <form id="complaintForm"><!-- Step 1: Company Selection -->
     <div id="companyStep" class="form-step">
      <h3 style="color: #2c3e50; margin-bottom: 25px;">Select Target Company</h3>
      <div class="company-grid">
       <div class="company-card" onclick="selectCompany('Dozera Ltd', 'Main holding company and corporate headquarters')">
        <div class="company-name">
         Dozera Ltd
        </div>
        <div class="company-desc">
         Main holding company and corporate headquarters
        </div>
       </div>
       <div class="company-card" onclick="selectCompany('Dozera Shop', 'E-commerce and retail operations')">
        <div class="company-name">
         Dozera Shop
        </div>
        <div class="company-desc">
         E-commerce and retail operations
        </div>
       </div>
       <div class="company-card" onclick="selectCompany('Saint Soul', 'Fashion and lifestyle brand')">
        <div class="company-name">
         Saint Soul
        </div>
        <div class="company-desc">
         Fashion and lifestyle brand
        </div>
       </div>
       <div class="company-card" onclick="selectCompany('Zynk', 'Technology and software solutions')">
        <div class="company-name">
         Zynk
        </div>
        <div class="company-desc">
         Technology and software solutions
        </div>
       </div>
       <div class="company-card" onclick="selectCompany('Dozera Construction', 'Construction and real estate development')">
        <div class="company-name">
         Dozera Construction
        </div>
        <div class="company-desc">
         Construction and real estate development
        </div>
       </div>
       <div class="company-card" onclick="selectCompany('Dozera Cloud &amp; Storage Services', 'Cloud computing and data storage')">
        <div class="company-name">
         Dozera Cloud &amp; Storage Services
        </div>
        <div class="company-desc">
         Cloud computing and data storage
        </div>
       </div>
       <div class="company-card" onclick="selectCompany('Dozera Law Department', 'Legal services and compliance')">
        <div class="company-name">
         Dozera Law Department
        </div>
        <div class="company-desc">
         Legal services and compliance
        </div>
       </div>
       <div class="company-card" onclick="selectCompany('Dozera F1', 'Racing and motorsports division')">
        <div class="company-name">
         Dozera F1
        </div>
        <div class="company-desc">
         Racing and motorsports division
        </div>
       </div>
       <div class="company-card" onclick="selectCompany('Jet2 Airline', 'Aviation and travel services')">
        <div class="company-name">
         Jet2 Airline
        </div>
        <div class="company-desc">
         Aviation and travel services
        </div>
       </div>
       <div class="company-card" onclick="selectCompany('Oriontec Inc', 'Advanced technology and research')">
        <div class="company-name">
         Oriontec Inc
        </div>
        <div class="company-desc">
         Advanced technology and research
        </div>
       </div>
      </div>
      <div style="text-align: center; margin-top: 30px;"><button type="button" class="btn" onclick="nextStep(2)" id="companyNextBtn" disabled>Continue to Employee Details</button>
      </div>
     </div><!-- Step 2: Employee Details -->
     <div id="employeeStep" class="form-step hidden">
      <h3 style="color: #2c3e50; margin-bottom: 25px;">Employee Information</h3>
      <div class="form-grid">
       <div class="form-group"><label class="form-label" for="employeeId">Employee ID <span class="required">*</span></label> <input type="text" class="form-input" id="employeeId" required placeholder="Enter employee ID">
       </div>
       <div class="form-group"><label class="form-label" for="employeeName">Employee Full Name <span class="required">*</span></label> <input type="text" class="form-input" id="employeeName" required placeholder="Enter full name">
       </div>
       <div class="form-group"><label class="form-label" for="employeeDesignation">Designation/Position</label> <input type="text" class="form-input" id="employeeDesignation" placeholder="Enter job title">
       </div>
       <div class="form-group"><label class="form-label" for="employeeDepartment">Department</label> <input type="text" class="form-input" id="employeeDepartment" placeholder="Enter department">
       </div>
      </div>
      <div style="text-align: center; margin-top: 30px;"><button type="button" class="btn btn-secondary" onclick="previousStep(1)">Back</button> <button type="button" class="btn" onclick="nextStep(3)" style="margin-left: 15px;">Continue to Complaint Details</button>
      </div>
     </div><!-- Step 3: Complaint Details -->
     <div id="complaintStep" class="form-step hidden">
      <h3 style="color: #2c3e50; margin-bottom: 25px;">Complaint Information</h3>
      <div class="form-grid">
       <div class="form-group"><label class="form-label" for="complaintType">Type of Complaint <span class="required">*</span></label> <select class="form-select" id="complaintType" required> <option value="">Select complaint type</option> <option value="harassment">Workplace Harassment</option> <option value="discrimination">Discrimination</option> <option value="fraud">Financial Fraud</option> <option value="breach_of_contract">Breach of Contract</option> <option value="negligence">Professional Negligence</option> <option value="misconduct">Employee Misconduct</option> <option value="safety_violation">Safety Violations</option> <option value="data_breach">Data Privacy Breach</option> <option value="corruption">Corruption/Bribery</option> <option value="defamation">Defamation</option> <option value="other">Other Legal Issue</option> </select>
       </div>
       <div class="form-group"><label class="form-label" for="priority">Priority Level <span class="required">*</span></label> <select class="form-select" id="priority" required> <option value="">Select priority</option> <option value="urgent">Urgent - Immediate Action Required</option> <option value="high">High - Serious Legal Matter</option> <option value="medium">Medium - Standard Processing</option> <option value="low">Low - Non-Critical Issue</option> </select>
       </div>
       <div class="form-group"><label class="form-label" for="incidentDate">Date of Incident <span class="required">*</span></label> <input type="date" class="form-input" id="incidentDate" required>
       </div>
       <div class="form-group"><label class="form-label" for="incidentTime">Time of Incident</label> <input type="time" class="form-input" id="incidentTime">
       </div>
      </div>
      <div class="form-group"><label class="form-label" for="incidentLocation">Location of Incident <span class="required">*</span></label> <textarea class="form-textarea" id="incidentLocation" required placeholder="Provide detailed location information"></textarea>
      </div>
      <div class="form-group"><label class="form-label" for="complaintDescription">Brief Description of Complaint <span class="required">*</span></label> <textarea class="form-textarea" id="complaintDescription" required style="min-height: 150px;" placeholder="Provide a comprehensive description of the incident, including what happened, when, where, and who was involved"></textarea>
      </div>
      <div class="form-group"><label class="form-label" for="evidenceDetails">Evidence and Supporting Documents</label> <textarea class="form-textarea" id="evidenceDetails" placeholder="Describe any evidence you have: documents, emails, photographs, recordings, etc."></textarea>
      </div>
      <div class="form-group"><label class="form-label" for="witnessDetails">Witness Information</label> <textarea class="form-textarea" id="witnessDetails" placeholder="Provide names, contact details, and brief statements of any witnesses"></textarea>
      </div>
      <div class="form-group"><label class="form-label" for="reliefSought">Relief/Action Sought <span class="required">*</span></label> <textarea class="form-textarea" id="reliefSought" required placeholder="Specify what legal action or remedy you are seeking through this complaint"></textarea>
      </div>
      <h3 style="color: #2c3e50; margin: 30px 0 20px;">Your Information</h3>
      <div class="form-grid">
       <div class="form-group"><label class="form-label" for="complainantName">Your Full Name <span class="required">*</span></label> <input type="text" class="form-input" id="complainantName" required>
       </div>
       <div class="form-group"><label class="form-label" for="complainantEmail">Email Address <span class="required">*</span></label> <input type="email" class="form-input" id="complainantEmail" required>
       </div>
       <div class="form-group"><label class="form-label" for="complainantPhone">Phone Number <span class="required">*</span></label> <input type="tel" class="form-input" id="complainantPhone" required>
       </div>
       <div class="form-group"><label class="form-label" for="complainantRelation">Relationship to Company</label> <select class="form-select" id="complainantRelation"> <option value="">Select relationship</option> <option value="employee">Current Employee</option> <option value="former_employee">Former Employee</option> <option value="customer">Customer/Client</option> <option value="vendor">Vendor/Supplier</option> <option value="partner">Business Partner</option> <option value="public">General Public</option> <option value="other">Other</option> </select>
       </div>
      </div>
      <div class="form-group"><label class="form-label" for="complainantAddress">Complete Address <span class="required">*</span></label> <textarea class="form-textarea" id="complainantAddress" required></textarea>
      </div>
      <div style="text-align: center; margin-top: 30px;"><button type="button" class="btn btn-secondary" onclick="previousStep(2)">Back</button> <button type="button" class="btn" onclick="nextStep(4)" style="margin-left: 15px;">Review &amp; Submit</button>
      </div>
     </div><!-- Step 4: Review & Submit -->
     <div id="reviewStep" class="form-step hidden">
      <h3 style="color: #2c3e50; margin-bottom: 25px;">Review Your Complaint</h3>
      <div id="reviewContent"></div>
      <div style="text-align: center; margin-top: 30px;"><button type="button" class="btn btn-secondary" onclick="previousStep(3)">Back to Edit</button> <button type="submit" class="btn" id="submitBtn" style="margin-left: 15px;">Submit Legal Complaint</button>
      </div>
     </div>
    </form>
    <div id="complaintResult" class="hidden"></div>
   </section><!-- Track Case Section -->
   <section id="track-case-section" class="section hidden">
    <h2 class="section-title">Track Your Case</h2>
    <div class="form-group"><label class="form-label" for="trackingToken">Enter Case Token</label> <input type="text" class="form-input" id="trackingToken" placeholder="Enter your case tracking number"> <button class="btn" onclick="trackCase()" style="margin-top: 15px;">Search Case</button>
    </div>
    <div id="caseDetails" class="hidden"></div>
   </section><!-- Lawyer Chat Section -->
   <section id="lawyer-chat-section" class="section hidden">
    <h2 class="section-title">Lawyer Communication</h2>
    <div class="form-group"><label class="form-label" for="chatToken">Enter Case Token for Chat</label> <input type="text" class="form-input" id="chatToken" placeholder="Enter your case token"> <button class="btn" onclick="initializeLawyerChat()" style="margin-top: 15px;">Start Chat</button>
    </div>
    <div id="lawyerChatContainer" class="hidden">
     <div class="chat-container">
      <h3 style="color: #2c3e50;">Chat with Assigned Lawyer - Case: <span id="currentChatToken"></span></h3>
      <div id="lawyerRequest" class="lawyer-request hidden">
       <h4 style="color: #c9302c; margin-top: 0;">Lawyer Request for Additional Information</h4>
       <p id="lawyerRequestText"></p>
       <div class="form-group"><label class="form-label" for="detailedResponse">Please provide detailed information:</label> <textarea class="form-textarea detailed-description" id="detailedResponse" placeholder="Please provide comprehensive details as requested by your lawyer..."></textarea>
       </div><button class="btn" onclick="submitDetailedResponse()">Submit Response</button>
      </div>
      <div class="chat-messages" id="lawyerChatMessages"></div>
      <div class="chat-input-group"><textarea class="chat-input" id="lawyerChatInput" placeholder="Type your message to the lawyer..."></textarea> <button class="btn" onclick="sendLawyerMessage()">Send</button>
      </div>
     </div>
    </div>
   </section><!-- Admin Login Section -->
   <section id="admin-login-section" class="section hidden">
    <div class="login-form">
     <h2 class="login-title">Administrative Access</h2>
     <div class="form-group"><label class="form-label" for="adminPassword">Access Code</label> <input type="password" class="form-input" id="adminPassword" placeholder="Enter administrative access code">
     </div><button class="btn" onclick="adminLogin()" style="width: 100%;">Access Admin Panel</button>
    </div>
   </section><!-- Edit Case Section -->
   <section id="edit-case-section" class="section hidden">
    <h2 class="section-title">Edit Case Details</h2>
    <div id="editCaseForm" class="hidden">
     <form id="caseEditForm">
      <div class="alert alert-info">
       <p><strong>Case Token:</strong> <span id="editCaseToken"></span></p>
       <p>You can modify the details below. Changes will be saved immediately.</p>
      </div>
      <h3 style="color: #2c3e50; margin: 30px 0 20px;">Employee Information</h3>
      <div class="form-grid">
       <div class="form-group"><label class="form-label" for="editEmployeeId">Employee ID</label> <input type="text" class="form-input" id="editEmployeeId">
       </div>
       <div class="form-group"><label class="form-label" for="editEmployeeName">Employee Name</label> <input type="text" class="form-input" id="editEmployeeName">
       </div>
       <div class="form-group"><label class="form-label" for="editEmployeeDesignation">Designation</label> <input type="text" class="form-input" id="editEmployeeDesignation">
       </div>
       <div class="form-group"><label class="form-label" for="editEmployeeDepartment">Department</label> <input type="text" class="form-input" id="editEmployeeDepartment">
       </div>
      </div>
      <h3 style="color: #2c3e50; margin: 30px 0 20px;">Complaint Details</h3>
      <div class="form-grid">
       <div class="form-group"><label class="form-label" for="editComplaintType">Complaint Type</label> <select class="form-select" id="editComplaintType"> <option value="harassment">Workplace Harassment</option> <option value="discrimination">Discrimination</option> <option value="fraud">Financial Fraud</option> <option value="breach_of_contract">Breach of Contract</option> <option value="negligence">Professional Negligence</option> <option value="misconduct">Employee Misconduct</option> <option value="safety_violation">Safety Violations</option> <option value="data_breach">Data Privacy Breach</option> <option value="corruption">Corruption/Bribery</option> <option value="defamation">Defamation</option> <option value="other">Other Legal Issue</option> </select>
       </div>
       <div class="form-group"><label class="form-label" for="editPriority">Priority Level</label> <select class="form-select" id="editPriority"> <option value="urgent">Urgent - Immediate Action Required</option> <option value="high">High - Serious Legal Matter</option> <option value="medium">Medium - Standard Processing</option> <option value="low">Low - Non-Critical Issue</option> </select>
       </div>
       <div class="form-group"><label class="form-label" for="editIncidentDate">Incident Date</label> <input type="date" class="form-input" id="editIncidentDate">
       </div>
       <div class="form-group"><label class="form-label" for="editIncidentTime">Incident Time</label> <input type="time" class="form-input" id="editIncidentTime">
       </div>
      </div>
      <div class="form-group"><label class="form-label" for="editIncidentLocation">Location of Incident</label> <textarea class="form-textarea" id="editIncidentLocation"></textarea>
      </div>
      <div class="form-group"><label class="form-label" for="editComplaintDescription">Complaint Description</label> <textarea class="form-textarea" id="editComplaintDescription" style="min-height: 150px;"></textarea>
      </div>
      <div class="form-group"><label class="form-label" for="editEvidenceDetails">Evidence Details</label> <textarea class="form-textarea" id="editEvidenceDetails"></textarea>
      </div>
      <div class="form-group"><label class="form-label" for="editWitnessDetails">Witness Information</label> <textarea class="form-textarea" id="editWitnessDetails"></textarea>
      </div>
      <div class="form-group"><label class="form-label" for="editReliefSought">Relief/Action Sought</label> <textarea class="form-textarea" id="editReliefSought"></textarea>
      </div>
      <h3 style="color: #2c3e50; margin: 30px 0 20px;">Your Information</h3>
      <div class="form-grid">
       <div class="form-group"><label class="form-label" for="editComplainantName">Your Name</label> <input type="text" class="form-input" id="editComplainantName">
       </div>
       <div class="form-group"><label class="form-label" for="editComplainantEmail">Email Address</label> <input type="email" class="form-input" id="editComplainantEmail">
       </div>
       <div class="form-group"><label class="form-label" for="editComplainantPhone">Phone Number</label> <input type="tel" class="form-input" id="editComplainantPhone">
       </div>
       <div class="form-group"><label class="form-label" for="editComplainantRelation">Relationship to Company</label> <select class="form-select" id="editComplainantRelation"> <option value="">Select relationship</option> <option value="employee">Current Employee</option> <option value="former_employee">Former Employee</option> <option value="customer">Customer/Client</option> <option value="vendor">Vendor/Supplier</option> <option value="partner">Business Partner</option> <option value="public">General Public</option> <option value="other">Other</option> </select>
       </div>
      </div>
      <div class="form-group"><label class="form-label" for="editComplainantAddress">Complete Address</label> <textarea class="form-textarea" id="editComplainantAddress"></textarea>
      </div>
      <div style="text-align: center; margin-top: 30px;"><button type="button" class="btn btn-secondary" onclick="cancelCaseEdit()">Cancel</button> <button type="submit" class="btn" style="margin-left: 15px;">Save Changes</button>
      </div>
     </form>
    </div>
    <div id="editCaseResult" class="hidden"></div>
   </section><!-- Admin Panel Section -->
   <section id="admin-panel-section" class="section hidden">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap;">
     <h2 class="section-title" style="margin: 0;">Administrative Panel</h2><button class="btn btn-secondary" onclick="adminLogout()">Logout</button>
    </div>
    <div class="form-group"><input type="text" class="form-input" id="adminSearch" placeholder="Search by case token, company, or complainant name"> <button class="btn" onclick="searchCases()" style="margin-top: 10px;">Search Cases</button>
    </div>
    <div id="adminCases" class="loading">
     Loading cases...
    </div>
    <div id="adminChat" class="chat-container hidden">
     <h3 style="color: #2c3e50;">Admin Chat - Case: <span id="adminChatToken"></span></h3>
     <div style="margin-bottom: 20px;"><button class="btn btn-secondary" onclick="requestDetailedInfo()">Request Detailed Information</button> <button class="btn btn-success" onclick="assignLawyer()" style="margin-left: 10px;">Assign Lawyer</button>
     </div>
     <div class="chat-messages" id="adminChatMessages"></div>
     <div class="chat-input-group"><textarea class="chat-input" id="adminChatInput" placeholder="Type message to user..."></textarea> <button class="btn" onclick="sendAdminMessage()">Send</button>
     </div>
    </div>
   </section>
  </main>
  <script>
        // Default configuration
        const defaultConfig = {
            portal_title: "Dozera Law Enforcement Portal",
            department_name: "Dozera Group Legal Department",
            contact_details: "Legal Helpline: 1800-DOZERA-LAW"
        };

        let selectedCompany = '';
        let currentStep = 1;
        let currentChatToken = null;
        let isAdminLoggedIn = false;
        let currentAdminChatToken = null;

        // Data SDK Handler
        const dataHandler = {
            onDataChanged(data) {
                console.log('Data updated:', data);
                if (isAdminLoggedIn && !document.getElementById('admin-panel-section').classList.contains('hidden')) {
                    loadAdminCases();
                }
            }
        };

        // Element SDK Configuration
        const elementConfig = {
            defaultConfig: defaultConfig,
            onConfigChange: async (config) => {
                const portalTitle = config.portal_title || defaultConfig.portal_title;
                const departmentName = config.department_name || defaultConfig.department_name;
                const contactDetails = config.contact_details || defaultConfig.contact_details;

                document.getElementById('portalTitle').textContent = portalTitle;
                document.getElementById('departmentName').textContent = departmentName;
                document.getElementById('contactDetails').textContent = contactDetails;
            },
            mapToCapabilities: (config) => ({
                recolorables: [],
                borderables: [],
                fontEditable: undefined,
                fontSizeable: undefined
            }),
            mapToEditPanelValues: (config) => new Map([
                ["portal_title", config.portal_title || defaultConfig.portal_title],
                ["department_name", config.department_name || defaultConfig.department_name],
                ["contact_details", config.contact_details || defaultConfig.contact_details]
            ])
        };

        // Initialize SDKs
        async function initializeApp() {
            try {
                if (window.elementSdk) {
                    await window.elementSdk.init(elementConfig);
                }
                
                if (window.dataSdk) {
                    const result = await window.dataSdk.init(dataHandler);
                    if (!result.isOk) {
                        console.error('Failed to initialize Data SDK');
                    }
                }
            } catch (error) {
                console.error('Initialization error:', error);
            }
        }

        // Navigation
        function showSection(sectionName) {
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => section.classList.add('hidden'));
            
            const navButtons = document.querySelectorAll('.nav-btn');
            navButtons.forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(sectionName + '-section').classList.remove('hidden');
            event.target.classList.add('active');
        }

        // Company Selection
        function selectCompany(companyName, description) {
            selectedCompany = companyName;
            
            // Remove selection from all cards
            const cards = document.querySelectorAll('.company-card');
            cards.forEach(card => card.classList.remove('selected'));
            
            // Add selection to clicked card
            event.currentTarget.classList.add('selected');
            
            // Enable next button
            document.getElementById('companyNextBtn').disabled = false;
        }

        // Step Navigation
        function nextStep(stepNumber) {
            // Hide current step
            document.querySelectorAll('.form-step').forEach(step => step.classList.add('hidden'));
            
            // Show next step
            const stepMap = {
                2: 'employeeStep',
                3: 'complaintStep',
                4: 'reviewStep'
            };
            
            document.getElementById(stepMap[stepNumber]).classList.remove('hidden');
            
            // Update step indicator
            updateStepIndicator(stepNumber);
            
            // If review step, populate review content
            if (stepNumber === 4) {
                populateReviewContent();
            }
            
            currentStep = stepNumber;
        }

        function previousStep(stepNumber) {
            // Hide current step
            document.querySelectorAll('.form-step').forEach(step => step.classList.add('hidden'));
            
            // Show previous step
            const stepMap = {
                1: 'companyStep',
                2: 'employeeStep',
                3: 'complaintStep'
            };
            
            document.getElementById(stepMap[stepNumber]).classList.remove('hidden');
            
            // Update step indicator
            updateStepIndicator(stepNumber);
            
            currentStep = stepNumber;
        }

        function updateStepIndicator(activeStep) {
            for (let i = 1; i <= 4; i++) {
                const step = document.getElementById(`step${i}`);
                step.classList.remove('active', 'completed');
                
                if (i < activeStep) {
                    step.classList.add('completed');
                } else if (i === activeStep) {
                    step.classList.add('active');
                }
            }
        }

        function populateReviewContent() {
            const reviewContent = document.getElementById('reviewContent');
            reviewContent.innerHTML = `
                <div class="case-card">
                    <h4 style="color: #c9302c; margin-top: 0;">Complaint Summary</h4>
                    <p><strong>Target Company:</strong> ${selectedCompany}</p>
                    <p><strong>Employee ID:</strong> ${document.getElementById('employeeId').value}</p>
                    <p><strong>Employee Name:</strong> ${document.getElementById('employeeName').value}</p>
                    <p><strong>Complaint Type:</strong> ${document.getElementById('complaintType').value}</p>
                    <p><strong>Priority:</strong> ${document.getElementById('priority').value}</p>
                    <p><strong>Incident Date:</strong> ${document.getElementById('incidentDate').value}</p>
                    <p><strong>Your Name:</strong> ${document.getElementById('complainantName').value}</p>
                    <p><strong>Your Email:</strong> ${document.getElementById('complainantEmail').value}</p>
                    <p><strong>Description:</strong> ${document.getElementById('complaintDescription').value.substring(0, 200)}...</p>
                </div>
                <div class="alert alert-info">
                    <p><strong>Please review all information carefully.</strong> Once submitted, your complaint will be processed and you will receive a case token for tracking.</p>
                </div>
            `;
        }

        // Generate unique token
        function generateToken() {
            const prefix = 'DLW';
            const timestamp = Date.now().toString(36).toUpperCase();
            const random = Math.random().toString(36).substr(2, 6).toUpperCase();
            return `${prefix}${timestamp}${random}`;
        }

        // Complaint Form Submission
        document.getElementById('complaintForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';
            
            try {
                // Validate required fields
                if (!selectedCompany) {
                    throw new Error('Please select a target company');
                }
                
                const requiredFields = [
                    'employeeId', 'employeeName', 'complaintType', 'priority', 
                    'incidentDate', 'incidentLocation', 'complaintDescription', 
                    'reliefSought', 'complainantName', 'complainantEmail', 
                    'complainantPhone', 'complainantAddress'
                ];
                
                for (const fieldId of requiredFields) {
                    const field = document.getElementById(fieldId);
                    if (!field || !field.value.trim()) {
                        throw new Error(`Please fill in the ${fieldId.replace(/([A-Z])/g, ' $1').toLowerCase()} field`);
                    }
                }
                
                const token = generateToken();
                const currentTime = new Date().toISOString();
                
                const complaintData = {
                    token: token,
                    target_company: selectedCompany,
                    employee_id: document.getElementById('employeeId').value.trim(),
                    employee_name: document.getElementById('employeeName').value.trim(),
                    employee_designation: document.getElementById('employeeDesignation').value.trim(),
                    employee_department: document.getElementById('employeeDepartment').value.trim(),
                    complaint_type: document.getElementById('complaintType').value,
                    priority: document.getElementById('priority').value,
                    incident_date: document.getElementById('incidentDate').value,
                    incident_time: document.getElementById('incidentTime').value,
                    incident_location: document.getElementById('incidentLocation').value.trim(),
                    complaint_description: document.getElementById('complaintDescription').value.trim(),
                    evidence_details: document.getElementById('evidenceDetails').value.trim(),
                    witness_details: document.getElementById('witnessDetails').value.trim(),
                    relief_sought: document.getElementById('reliefSought').value.trim(),
                    complainant_name: document.getElementById('complainantName').value.trim(),
                    complainant_email: document.getElementById('complainantEmail').value.trim(),
                    complainant_phone: document.getElementById('complainantPhone').value.trim(),
                    complainant_relation: document.getElementById('complainantRelation').value,
                    complainant_address: document.getElementById('complainantAddress').value.trim(),
                    status: 'pending',
                    assigned_lawyer: '',
                    created_at: currentTime,
                    updated_at: currentTime,
                    audit_trail: `Complaint filed against ${selectedCompany} on ${new Date(currentTime).toLocaleString()}`,
                    chat_messages: '[]',
                    lawyer_notes: '',
                    case_updates: '[]'
                };

                let saveSuccess = false;
                
                // Try to save to Firebase first
                try {
                    await saveToFirebase(complaintData);
                    saveSuccess = true;
                    console.log('Saved to Firebase successfully');
                } catch (firebaseError) {
                    console.warn('Firebase save failed:', firebaseError);
                }
                
                // Try to save to Data SDK
                if (window.dataSdk) {
                    try {
                        const result = await window.dataSdk.create(complaintData);
                        if (result.isOk) {
                            saveSuccess = true;
                            console.log('Saved to Data SDK successfully');
                        } else {
                            console.warn('Data SDK save failed:', result.error);
                        }
                    } catch (sdkError) {
                        console.warn('Data SDK error:', sdkError);
                    }
                }
                
                if (!saveSuccess) {
                    throw new Error('Failed to save complaint data to any storage system');
                }
                
                // Generate PDF
                try {
                    generateComplaintPDF(complaintData);
                } catch (pdfError) {
                    console.warn('PDF generation failed:', pdfError);
                }
                
                // Show success message
                document.getElementById('complaintResult').innerHTML = `
                    <div class="alert alert-success">
                        <h3>Legal Complaint Filed Successfully</h3>
                        <div class="token-display">
                            Case Token: ${token}
                        </div>
                        <p><strong>Important:</strong> Please save this token number for future reference. 
                        Your legal complaint document has been generated and will download automatically.</p>
                        <p><strong>Case Details:</strong></p>
                        <ul>
                            <li><strong>Target Company:</strong> ${selectedCompany}</li>
                            <li><strong>Employee:</strong> ${complaintData.employee_name} (ID: ${complaintData.employee_id})</li>
                            <li><strong>Complaint Type:</strong> ${complaintData.complaint_type}</li>
                            <li><strong>Priority:</strong> ${complaintData.priority}</li>
                        </ul>
                        <p><strong>Next Steps:</strong></p>
                        <ul>
                            <li>Your case has been registered in our legal system</li>
                            <li>A lawyer will be assigned within 24-48 hours</li>
                            <li>You will receive email updates on case progress</li>
                            <li>Use the token to track your case or chat with your lawyer</li>
                        </ul>
                        <div style="margin-top: 20px;">
                            <button class="btn" onclick="trackCase('${token}')">Track This Case</button>
                            <button class="btn btn-secondary" onclick="openLawyerChat('${token}')" style="margin-left: 10px;">Start Chat</button>
                        </div>
                    </div>
                `;
                document.getElementById('complaintResult').classList.remove('hidden');
                
                // Hide form steps and show result
                document.querySelectorAll('.form-step').forEach(step => step.classList.add('hidden'));
                
                // Reset form for next use
                setTimeout(() => {
                    document.getElementById('complaintForm').reset();
                    selectedCompany = '';
                    currentStep = 1;
                    updateStepIndicator(1);
                    document.getElementById('companyStep').classList.remove('hidden');
                    document.querySelectorAll('.company-card').forEach(card => card.classList.remove('selected'));
                    document.getElementById('companyNextBtn').disabled = true;
                }, 2000);
                
            } catch (error) {
                console.error('Error filing complaint:', error);
                document.getElementById('complaintResult').innerHTML = `
                    <div class="alert alert-error">
                        <h3>Error Filing Complaint</h3>
                        <p><strong>Error Details:</strong> ${error.message}</p>
                        <p>Please check all required fields and try again. If the problem persists, contact technical support.</p>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-secondary" onclick="document.getElementById('complaintResult').classList.add('hidden')">Try Again</button>
                        </div>
                    </div>
                `;
                document.getElementById('complaintResult').classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Legal Complaint';
            }
        });

        // Save to Firebase
        async function saveToFirebase(data) {
            try {
                if (window.firebaseDB && window.firebaseRef && window.firebaseSet) {
                    const casesRef = window.firebaseRef(window.firebaseDB, 'legal_cases/' + data.token);
                    await window.firebaseSet(casesRef, data);
                    console.log('Data saved to Firebase successfully');
                    return true;
                } else {
                    console.warn('Firebase not available');
                    return false;
                }
            } catch (error) {
                console.error('Error saving to Firebase:', error);
                throw error;
            }
        }

        // Generate Complaint PDF
        function generateComplaintPDF(complaintData) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Header
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('DOZERA GROUP LEGAL DEPARTMENT', 105, 15, { align: 'center' });
            doc.text('LEGAL COMPLAINT REPORT', 105, 25, { align: 'center' });
            
            // Logo placeholder
            doc.setLineWidth(1);
            doc.circle(105, 40, 8);
            doc.setFontSize(8);
            doc.text('DOZERA', 105, 42, { align: 'center' });
            
            // Title and Token
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('FORMAL LEGAL COMPLAINT', 105, 55, { align: 'center' });
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text(`Case No: ${complaintData.token}`, 105, 65, { align: 'center' });
            
            // Separator line
            doc.setLineWidth(0.5);
            doc.line(20, 70, 190, 70);
            
            let yPos = 80;
            const lineHeight = 7;
            
            // Case Information
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('CASE INFORMATION', 20, yPos);
            yPos += lineHeight + 2;
            
            doc.setFont(undefined, 'normal');
            doc.text(`Date of Filing: ${new Date(complaintData.created_at).toLocaleDateString()}`, 25, yPos);
            yPos += lineHeight;
            doc.text(`Time of Filing: ${new Date(complaintData.created_at).toLocaleTimeString()}`, 25, yPos);
            yPos += lineHeight;
            doc.text(`Target Company: ${complaintData.target_company}`, 25, yPos);
            yPos += lineHeight;
            doc.text(`Complaint Type: ${complaintData.complaint_type.toUpperCase()}`, 25, yPos);
            yPos += lineHeight;
            doc.text(`Priority Level: ${complaintData.priority.toUpperCase()}`, 25, yPos);
            yPos += lineHeight + 5;
            
            // Employee Details
            doc.setFont(undefined, 'bold');
            doc.text('ACCUSED EMPLOYEE DETAILS', 20, yPos);
            yPos += lineHeight + 2;
            
            doc.setFont(undefined, 'normal');
            doc.text(`Employee ID: ${complaintData.employee_id}`, 25, yPos);
            yPos += lineHeight;
            doc.text(`Name: ${complaintData.employee_name}`, 25, yPos);
            yPos += lineHeight;
            if (complaintData.employee_designation) {
                doc.text(`Designation: ${complaintData.employee_designation}`, 25, yPos);
                yPos += lineHeight;
            }
            if (complaintData.employee_department) {
                doc.text(`Department: ${complaintData.employee_department}`, 25, yPos);
                yPos += lineHeight;
            }
            yPos += 5;
            
            // Complainant Details
            doc.setFont(undefined, 'bold');
            doc.text('COMPLAINANT DETAILS', 20, yPos);
            yPos += lineHeight + 2;
            
            doc.setFont(undefined, 'normal');
            doc.text(`Name: ${complaintData.complainant_name}`, 25, yPos);
            yPos += lineHeight;
            doc.text(`Email: ${complaintData.complainant_email}`, 25, yPos);
            yPos += lineHeight;
            doc.text(`Phone: ${complaintData.complainant_phone}`, 25, yPos);
            yPos += lineHeight;
            if (complaintData.complainant_relation) {
                doc.text(`Relationship: ${complaintData.complainant_relation}`, 25, yPos);
                yPos += lineHeight;
            }
            
            const addressLines = doc.splitTextToSize(`Address: ${complaintData.complainant_address}`, 165);
            doc.text(addressLines, 25, yPos);
            yPos += addressLines.length * lineHeight + 5;
            
            // Incident Details
            doc.setFont(undefined, 'bold');
            doc.text('INCIDENT DETAILS', 20, yPos);
            yPos += lineHeight + 2;
            
            doc.setFont(undefined, 'normal');
            doc.text(`Date of Incident: ${complaintData.incident_date}`, 25, yPos);
            yPos += lineHeight;
            
            if (complaintData.incident_time) {
                doc.text(`Time of Incident: ${complaintData.incident_time}`, 25, yPos);
                yPos += lineHeight;
            }
            
            const locationLines = doc.splitTextToSize(`Location: ${complaintData.incident_location}`, 165);
            doc.text(locationLines, 25, yPos);
            yPos += locationLines.length * lineHeight + 5;
            
            // Check if we need a new page
            if (yPos > 250) {
                doc.addPage();
                yPos = 20;
            }
            
            // Complaint Description
            doc.setFont(undefined, 'bold');
            doc.text('DETAILED COMPLAINT DESCRIPTION', 20, yPos);
            yPos += lineHeight + 2;
            
            doc.setFont(undefined, 'normal');
            const descriptionLines = doc.splitTextToSize(complaintData.complaint_description, 165);
            doc.text(descriptionLines, 25, yPos);
            yPos += descriptionLines.length * lineHeight + 5;
            
            // Evidence Details
            if (complaintData.evidence_details) {
                if (yPos > 240) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFont(undefined, 'bold');
                doc.text('EVIDENCE AND SUPPORTING DOCUMENTS', 20, yPos);
                yPos += lineHeight + 2;
                
                doc.setFont(undefined, 'normal');
                const evidenceLines = doc.splitTextToSize(complaintData.evidence_details, 165);
                doc.text(evidenceLines, 25, yPos);
                yPos += evidenceLines.length * lineHeight + 5;
            }
            
            // Witness Details
            if (complaintData.witness_details) {
                if (yPos > 240) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFont(undefined, 'bold');
                doc.text('WITNESS INFORMATION', 20, yPos);
                yPos += lineHeight + 2;
                
                doc.setFont(undefined, 'normal');
                const witnessLines = doc.splitTextToSize(complaintData.witness_details, 165);
                doc.text(witnessLines, 25, yPos);
                yPos += witnessLines.length * lineHeight + 5;
            }
            
            // Relief Sought
            if (yPos > 240) {
                doc.addPage();
                yPos = 20;
            }
            
            doc.setFont(undefined, 'bold');
            doc.text('RELIEF/ACTION SOUGHT', 20, yPos);
            yPos += lineHeight + 2;
            
            doc.setFont(undefined, 'normal');
            const reliefLines = doc.splitTextToSize(complaintData.relief_sought, 165);
            doc.text(reliefLines, 25, yPos);
            yPos += reliefLines.length * lineHeight + 10;
            
            // Legal Declaration
            if (yPos > 250) {
                doc.addPage();
                yPos = 20;
            }
            
            doc.setFont(undefined, 'bold');
            doc.text('LEGAL DECLARATION', 20, yPos);
            yPos += lineHeight + 2;
            
            doc.setFont(undefined, 'normal');
            const declaration = 'I hereby declare under penalty of perjury that the information provided in this complaint is true and correct to the best of my knowledge and belief. I understand that providing false information may result in legal consequences.';
            const declarationLines = doc.splitTextToSize(declaration, 165);
            doc.text(declarationLines, 25, yPos);
            yPos += declarationLines.length * lineHeight + 10;
            
            // Signature Section
            doc.text('Complainant Signature: _________________________', 25, yPos);
            yPos += lineHeight;
            doc.text(`Name: ${complaintData.complainant_name}`, 25, yPos);
            yPos += lineHeight;
            doc.text(`Date: ${new Date().toLocaleDateString()}`, 25, yPos);
            
            // Official Footer
            doc.setFontSize(10);
            doc.setFont(undefined, 'italic');
            doc.text('This is an official legal document generated by Dozera Group Legal Department', 105, 285, { align: 'center' });
            doc.text(`Document ID: ${complaintData.token} | Generated on: ${new Date().toLocaleString()}`, 105, 290, { align: 'center' });
            
            // Download PDF
            doc.save(`Legal_Complaint_${complaintData.token}.pdf`);
        }

        // Track Case Function
        async function trackCase() {
            const token = document.getElementById('trackingToken').value.trim();
            if (!token) {
                showAlert('Please enter a valid case token.', 'error');
                return;
            }
            
            try {
                // Try to get from Firebase first
                if (window.firebaseDB && window.firebaseRef && window.firebaseGet) {
                    const caseRef = window.firebaseRef(window.firebaseDB, 'legal_cases/' + token);
                    const snapshot = await window.firebaseGet(caseRef);
                    
                    if (snapshot.exists()) {
                        const caseData = snapshot.val();
                        displayCaseDetails(caseData);
                    } else {
                        showAlert('Case not found. Please check your token number.', 'error');
                    }
                } else {
                    showAlert('Unable to connect to case database.', 'error');
                }
            } catch (error) {
                console.error('Error tracking case:', error);
                showAlert('Error retrieving case details. Please try again.', 'error');
            }
        }

        function displayCaseDetails(caseData) {
            const statusClass = `status-${caseData.status.replace('_', '-')}`;
            const updates = JSON.parse(caseData.case_updates || '[]');
            
            document.getElementById('caseDetails').innerHTML = `
                <div class="case-card">
                    <div class="case-header">
                        <div class="case-token">Case Token: ${caseData.token}</div>
                        <span class="status-badge ${statusClass}">${caseData.status.toUpperCase()}</span>
                    </div>
                    <div class="form-grid">
                        <div>
                            <p><strong>Target Company:</strong> ${caseData.target_company}</p>
                            <p><strong>Employee:</strong> ${caseData.employee_name} (ID: ${caseData.employee_id})</p>
                            <p><strong>Complaint Type:</strong> ${caseData.complaint_type}</p>
                        </div>
                        <div>
                            <p><strong>Filed Date:</strong> ${new Date(caseData.created_at).toLocaleDateString()}</p>
                            <p><strong>Priority:</strong> ${caseData.priority}</p>
                            <p><strong>Assigned Lawyer:</strong> ${caseData.assigned_lawyer || 'Not assigned yet'}</p>
                        </div>
                    </div>
                    
                    <div class="audit-trail">
                        <h4 style="margin-top: 0;">Case Timeline</h4>
                        <div class="audit-entry">
                            <span class="audit-timestamp">${new Date(caseData.created_at).toLocaleString()}</span> - Complaint filed against ${caseData.target_company}
                        </div>
                        ${updates.map(update => `
                            <div class="audit-entry">
                                <span class="audit-timestamp">${new Date(update.timestamp).toLocaleString()}</span> - ${update.message}
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="case-actions">
                        <button class="btn btn-secondary" onclick="generateCasePDF('${caseData.token}')">Download PDF</button>
                        <button class="btn" onclick="openLawyerChat('${caseData.token}')">Chat with Lawyer</button>
                        <button class="btn btn-success" onclick="editCase('${caseData.token}')">Edit Case</button>
                    </div>
                </div>
            `;
            document.getElementById('caseDetails').classList.remove('hidden');
        }

        // Initialize Lawyer Chat
        function initializeLawyerChat() {
            const token = document.getElementById('chatToken').value.trim();
            if (!token) {
                showAlert('Please enter a valid case token.', 'error');
                return;
            }
            
            openLawyerChat(token);
        }

        async function openLawyerChat(token) {
            currentChatToken = token;
            document.getElementById('currentChatToken').textContent = token;
            document.getElementById('lawyerChatContainer').classList.remove('hidden');
            
            // Load chat messages from Firebase
            await loadChatMessages(token);
            
            // Set up real-time listener for new messages
            if (window.firebaseDB && window.firebaseRef && window.firebaseOnValue) {
                const chatRef = window.firebaseRef(window.firebaseDB, `legal_cases/${token}/chat_messages`);
                window.firebaseOnValue(chatRef, (snapshot) => {
                    if (snapshot.exists()) {
                        const messages = JSON.parse(snapshot.val() || '[]');
                        displayChatMessages(messages);
                    }
                });
            }
        }

        async function loadChatMessages(token) {
            try {
                if (window.firebaseDB && window.firebaseRef && window.firebaseGet) {
                    const caseRef = window.firebaseRef(window.firebaseDB, `legal_cases/${token}`);
                    const snapshot = await window.firebaseGet(caseRef);
                    
                    if (snapshot.exists()) {
                        const caseData = snapshot.val();
                        const messages = JSON.parse(caseData.chat_messages || '[]');
                        displayChatMessages(messages);
                        
                        // Check for lawyer requests
                        if (caseData.lawyer_notes && caseData.lawyer_notes.includes('REQUEST_DETAILS:')) {
                            const requestText = caseData.lawyer_notes.replace('REQUEST_DETAILS:', '');
                            showLawyerRequest(requestText);
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading chat messages:', error);
            }
        }

        function displayChatMessages(messages) {
            const chatContainer = document.getElementById('lawyerChatMessages');
            chatContainer.innerHTML = '';
            
            messages.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message chat-${message.sender}`;
                messageDiv.innerHTML = `
                    <strong>${message.sender === 'user' ? 'You' : message.sender === 'lawyer' ? 'Lawyer' : 'Admin'}:</strong> ${message.text}
                    <br><small>${new Date(message.timestamp).toLocaleString()}</small>
                `;
                chatContainer.appendChild(messageDiv);
            });
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showLawyerRequest(requestText) {
            document.getElementById('lawyerRequestText').textContent = requestText;
            document.getElementById('lawyerRequest').classList.remove('hidden');
        }

        async function sendLawyerMessage() {
            const input = document.getElementById('lawyerChatInput');
            const message = input.value.trim();
            
            if (message && currentChatToken) {
                try {
                    // Get current messages
                    const caseRef = window.firebaseRef(window.firebaseDB, `legal_cases/${currentChatToken}`);
                    const snapshot = await window.firebaseGet(caseRef);
                    
                    if (snapshot.exists()) {
                        const caseData = snapshot.val();
                        const messages = JSON.parse(caseData.chat_messages || '[]');
                        
                        // Add new message
                        messages.push({
                            sender: 'user',
                            text: message,
                            timestamp: new Date().toISOString()
                        });
                        
                        // Update Firebase
                        await window.firebaseUpdate(caseRef, {
                            chat_messages: JSON.stringify(messages),
                            updated_at: new Date().toISOString()
                        });
                        
                        input.value = '';
                    }
                } catch (error) {
                    console.error('Error sending message:', error);
                    showAlert('Error sending message. Please try again.', 'error');
                }
            }
        }

        async function submitDetailedResponse() {
            const response = document.getElementById('detailedResponse').value.trim();
            
            if (response && currentChatToken) {
                try {
                    // Get current messages
                    const caseRef = window.firebaseRef(window.firebaseDB, `legal_cases/${currentChatToken}`);
                    const snapshot = await window.firebaseGet(caseRef);
                    
                    if (snapshot.exists()) {
                        const caseData = snapshot.val();
                        const messages = JSON.parse(caseData.chat_messages || '[]');
                        
                        // Add detailed response
                        messages.push({
                            sender: 'user',
                            text: `DETAILED RESPONSE: ${response}`,
                            timestamp: new Date().toISOString()
                        });
                        
                        // Update Firebase and clear lawyer request
                        await window.firebaseUpdate(caseRef, {
                            chat_messages: JSON.stringify(messages),
                            lawyer_notes: '',
                            updated_at: new Date().toISOString()
                        });
                        
                        document.getElementById('detailedResponse').value = '';
                        document.getElementById('lawyerRequest').classList.add('hidden');
                        showAlert('Detailed response submitted successfully.', 'success');
                    }
                } catch (error) {
                    console.error('Error submitting response:', error);
                    showAlert('Error submitting response. Please try again.', 'error');
                }
            }
        }

        // Admin Functions
        function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            if (password === '7973804008') {
                isAdminLoggedIn = true;
                document.getElementById('admin-login-section').classList.add('hidden');
                document.getElementById('admin-panel-section').classList.remove('hidden');
                loadAdminCases();
            } else {
                showAlert('Invalid access code. Please try again.', 'error');
            }
        }

        function adminLogout() {
            isAdminLoggedIn = false;
            document.getElementById('admin-panel-section').classList.add('hidden');
            document.getElementById('admin-login-section').classList.remove('hidden');
            document.getElementById('adminPassword').value = '';
        }

        async function loadAdminCases() {
            const adminCases = document.getElementById('adminCases');
            adminCases.innerHTML = '<div class="loading">Loading cases...</div>';
            
            try {
                if (window.firebaseDB && window.firebaseRef && window.firebaseGet) {
                    const casesRef = window.firebaseRef(window.firebaseDB, 'legal_cases');
                    const snapshot = await window.firebaseGet(casesRef);
                    
                    if (snapshot.exists()) {
                        const cases = snapshot.val();
                        displayAdminCases(Object.values(cases));
                    } else {
                        adminCases.innerHTML = '<p>No cases found.</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading admin cases:', error);
                adminCases.innerHTML = '<p>Error loading cases.</p>';
            }
        }

        function displayAdminCases(cases) {
            const adminCases = document.getElementById('adminCases');
            adminCases.innerHTML = '';
            
            cases.forEach(caseData => {
                const statusClass = `status-${caseData.status.replace('_', '-')}`;
                const caseDiv = document.createElement('div');
                caseDiv.className = 'case-card';
                caseDiv.innerHTML = `
                    <div class="case-header">
                        <div class="case-token">${caseData.token}</div>
                        <span class="status-badge ${statusClass}">${caseData.status.toUpperCase()}</span>
                    </div>
                    <div class="form-grid">
                        <div>
                            <p><strong>Company:</strong> ${caseData.target_company}</p>
                            <p><strong>Employee:</strong> ${caseData.employee_name}</p>
                            <p><strong>Type:</strong> ${caseData.complaint_type}</p>
                        </div>
                        <div>
                            <p><strong>Complainant:</strong> ${caseData.complainant_name}</p>
                            <p><strong>Filed:</strong> ${new Date(caseData.created_at).toLocaleDateString()}</p>
                            <p><strong>Priority:</strong> ${caseData.priority}</p>
                        </div>
                    </div>
                    <div class="case-actions">
                        <button class="btn btn-secondary" onclick="updateCaseStatus('${caseData.token}', 'active')">Mark Active</button>
                        <button class="btn btn-success" onclick="assignLawyerToCase('${caseData.token}')">Assign Lawyer</button>
                        <button class="btn" onclick="startAdminChat('${caseData.token}')">Chat</button>
                        <button class="btn btn-secondary" onclick="generateCasePDF('${caseData.token}')">Download PDF</button>
                    </div>
                `;
                adminCases.appendChild(caseDiv);
            });
        }

        async function updateCaseStatus(token, status) {
            try {
                const caseRef = window.firebaseRef(window.firebaseDB, `legal_cases/${token}`);
                const updates = {
                    status: status,
                    updated_at: new Date().toISOString()
                };
                
                await window.firebaseUpdate(caseRef, updates);
                showAlert(`Case ${token} status updated to ${status}`, 'success');
                loadAdminCases();
            } catch (error) {
                console.error('Error updating case status:', error);
                showAlert('Error updating case status', 'error');
            }
        }

        function assignLawyerToCase(token) {
            const lawyerName = prompt('Enter lawyer name:');
            if (lawyerName) {
                assignLawyer(token, lawyerName);
            }
        }

        async function assignLawyer(token, lawyerName) {
            try {
                const caseRef = window.firebaseRef(window.firebaseDB, `legal_cases/${token}`);
                const updates = {
                    assigned_lawyer: lawyerName,
                    status: 'active',
                    updated_at: new Date().toISOString()
                };
                
                await window.firebaseUpdate(caseRef, updates);
                showAlert(`Lawyer ${lawyerName} assigned to case ${token}`, 'success');
                loadAdminCases();
            } catch (error) {
                console.error('Error assigning lawyer:', error);
                showAlert('Error assigning lawyer', 'error');
            }
        }

        function startAdminChat(token) {
            currentAdminChatToken = token;
            document.getElementById('adminChatToken').textContent = token;
            document.getElementById('adminChat').classList.remove('hidden');
            loadAdminChatMessages(token);
        }

        async function loadAdminChatMessages(token) {
            try {
                const caseRef = window.firebaseRef(window.firebaseDB, `legal_cases/${token}`);
                const snapshot = await window.firebaseGet(caseRef);
                
                if (snapshot.exists()) {
                    const caseData = snapshot.val();
                    const messages = JSON.parse(caseData.chat_messages || '[]');
                    displayAdminChatMessages(messages);
                }
            } catch (error) {
                console.error('Error loading admin chat messages:', error);
            }
        }

        function displayAdminChatMessages(messages) {
            const chatContainer = document.getElementById('adminChatMessages');
            chatContainer.innerHTML = '';
            
            messages.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message chat-${message.sender}`;
                messageDiv.innerHTML = `
                    <strong>${message.sender === 'user' ? 'User' : message.sender === 'lawyer' ? 'Lawyer' : 'Admin'}:</strong> ${message.text}
                    <br><small>${new Date(message.timestamp).toLocaleString()}</small>
                `;
                chatContainer.appendChild(messageDiv);
            });
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function sendAdminMessage() {
            const input = document.getElementById('adminChatInput');
            const message = input.value.trim();
            
            if (message && currentAdminChatToken) {
                try {
                    const caseRef = window.firebaseRef(window.firebaseDB, `legal_cases/${currentAdminChatToken}`);
                    const snapshot = await window.firebaseGet(caseRef);
                    
                    if (snapshot.exists()) {
                        const caseData = snapshot.val();
                        const messages = JSON.parse(caseData.chat_messages || '[]');
                        
                        messages.push({
                            sender: 'admin',
                            text: message,
                            timestamp: new Date().toISOString()
                        });
                        
                        await window.firebaseUpdate(caseRef, {
                            chat_messages: JSON.stringify(messages),
                            updated_at: new Date().toISOString()
                        });
                        
                        input.value = '';
                        loadAdminChatMessages(currentAdminChatToken);
                    }
                } catch (error) {
                    console.error('Error sending admin message:', error);
                    showAlert('Error sending message. Please try again.', 'error');
                }
            }
        }

        async function requestDetailedInfo() {
            const request = prompt('Enter your request for additional information:');
            if (request && currentAdminChatToken) {
                try {
                    const caseRef = window.firebaseRef(window.firebaseDB, `legal_cases/${currentAdminChatToken}`);
                    await window.firebaseUpdate(caseRef, {
                        lawyer_notes: `REQUEST_DETAILS:${request}`,
                        updated_at: new Date().toISOString()
                    });
                    
                    showAlert('Request for detailed information sent to user.', 'success');
                } catch (error) {
                    console.error('Error requesting detailed info:', error);
                    showAlert('Error sending request.', 'error');
                }
            }
        }

        async function generateCasePDF(token) {
            try {
                // Get case data from Firebase
                const caseRef = window.firebaseRef(window.firebaseDB, `legal_cases/${token}`);
                const snapshot = await window.firebaseGet(caseRef);
                
                if (snapshot.exists()) {
                    const caseData = snapshot.val();
                    generateComplaintPDF(caseData);
                    showAlert(`PDF downloaded for case ${token}`, 'success');
                } else {
                    showAlert('Case not found for PDF generation', 'error');
                }
            } catch (error) {
                console.error('Error generating PDF:', error);
                showAlert('Error generating PDF. Please try again.', 'error');
            }
        }

        function searchCases() {
            const searchTerm = document.getElementById('adminSearch').value.trim();
            if (searchTerm) {
                showAlert(`Searching for: ${searchTerm}`, 'success');
                // Implement search logic here
            }
        }

        // Show Alert
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Chat input enter key support
        document.getElementById('lawyerChatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendLawyerMessage();
            }
        });

        document.getElementById('adminChatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendAdminMessage();
            }
        });

        // Edit Case Functions
        let currentEditToken = null;

        async function editCase(token) {
            try {
                currentEditToken = token;
                
                // Get case data from Firebase
                const caseRef = window.firebaseRef(window.firebaseDB, `legal_cases/${token}`);
                const snapshot = await window.firebaseGet(caseRef);
                
                if (snapshot.exists()) {
                    const caseData = snapshot.val();
                    populateEditForm(caseData);
                    
                    // Show edit section
                    document.querySelectorAll('.section').forEach(section => section.classList.add('hidden'));
                    document.getElementById('edit-case-section').classList.remove('hidden');
                    document.getElementById('editCaseForm').classList.remove('hidden');
                } else {
                    showAlert('Case not found for editing', 'error');
                }
            } catch (error) {
                console.error('Error loading case for edit:', error);
                showAlert('Error loading case details for editing', 'error');
            }
        }

        function populateEditForm(caseData) {
            document.getElementById('editCaseToken').textContent = caseData.token;
            document.getElementById('editEmployeeId').value = caseData.employee_id || '';
            document.getElementById('editEmployeeName').value = caseData.employee_name || '';
            document.getElementById('editEmployeeDesignation').value = caseData.employee_designation || '';
            document.getElementById('editEmployeeDepartment').value = caseData.employee_department || '';
            document.getElementById('editComplaintType').value = caseData.complaint_type || '';
            document.getElementById('editPriority').value = caseData.priority || '';
            document.getElementById('editIncidentDate').value = caseData.incident_date || '';
            document.getElementById('editIncidentTime').value = caseData.incident_time || '';
            document.getElementById('editIncidentLocation').value = caseData.incident_location || '';
            document.getElementById('editComplaintDescription').value = caseData.complaint_description || '';
            document.getElementById('editEvidenceDetails').value = caseData.evidence_details || '';
            document.getElementById('editWitnessDetails').value = caseData.witness_details || '';
            document.getElementById('editReliefSought').value = caseData.relief_sought || '';
            document.getElementById('editComplainantName').value = caseData.complainant_name || '';
            document.getElementById('editComplainantEmail').value = caseData.complainant_email || '';
            document.getElementById('editComplainantPhone').value = caseData.complainant_phone || '';
            document.getElementById('editComplainantRelation').value = caseData.complainant_relation || '';
            document.getElementById('editComplainantAddress').value = caseData.complainant_address || '';
        }

        function cancelCaseEdit() {
            document.getElementById('edit-case-section').classList.add('hidden');
            document.getElementById('track-case-section').classList.remove('hidden');
            currentEditToken = null;
        }

        async function viewUpdatedCase(token) {
            // Set the tracking token and trigger case tracking
            document.getElementById('trackingToken').value = token;
            
            // Switch to track case section
            document.querySelectorAll('.section').forEach(section => section.classList.add('hidden'));
            document.getElementById('track-case-section').classList.remove('hidden');
            
            // Update navigation
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.nav-btn[onclick="showSection(\'track-case\')"]').classList.add('active');
            
            // Track the case
            await trackCase();
            
            currentEditToken = null;
        }

        // Handle case edit form submission
        document.getElementById('caseEditForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentEditToken) {
                showAlert('No case selected for editing', 'error');
                return;
            }
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';
            
            try {
                const updatedData = {
                    employee_id: document.getElementById('editEmployeeId').value.trim(),
                    employee_name: document.getElementById('editEmployeeName').value.trim(),
                    employee_designation: document.getElementById('editEmployeeDesignation').value.trim(),
                    employee_department: document.getElementById('editEmployeeDepartment').value.trim(),
                    complaint_type: document.getElementById('editComplaintType').value,
                    priority: document.getElementById('editPriority').value,
                    incident_date: document.getElementById('editIncidentDate').value,
                    incident_time: document.getElementById('editIncidentTime').value,
                    incident_location: document.getElementById('editIncidentLocation').value.trim(),
                    complaint_description: document.getElementById('editComplaintDescription').value.trim(),
                    evidence_details: document.getElementById('editEvidenceDetails').value.trim(),
                    witness_details: document.getElementById('editWitnessDetails').value.trim(),
                    relief_sought: document.getElementById('editReliefSought').value.trim(),
                    complainant_name: document.getElementById('editComplainantName').value.trim(),
                    complainant_email: document.getElementById('editComplainantEmail').value.trim(),
                    complainant_phone: document.getElementById('editComplainantPhone').value.trim(),
                    complainant_relation: document.getElementById('editComplainantRelation').value,
                    complainant_address: document.getElementById('editComplainantAddress').value.trim(),
                    updated_at: new Date().toISOString()
                };
                
                // Update Firebase
                const caseRef = window.firebaseRef(window.firebaseDB, `legal_cases/${currentEditToken}`);
                await window.firebaseUpdate(caseRef, updatedData);
                
                // Try to update Data SDK as well
                if (window.dataSdk) {
                    try {
                        // Get current case data first
                        const snapshot = await window.firebaseGet(caseRef);
                        if (snapshot.exists()) {
                            const fullCaseData = snapshot.val();
                            const result = await window.dataSdk.update(fullCaseData);
                            if (!result.isOk) {
                                console.warn('Data SDK update failed:', result.error);
                            }
                        }
                    } catch (sdkError) {
                        console.warn('Data SDK update error:', sdkError);
                    }
                }
                
                // Show success message
                document.getElementById('editCaseResult').innerHTML = `
                    <div class="alert alert-success">
                        <h3>Case Updated Successfully</h3>
                        <p>Your case details have been updated and saved.</p>
                        <p><strong>Case Token:</strong> ${currentEditToken}</p>
                        <div style="margin-top: 15px;">
                            <button class="btn" onclick="viewUpdatedCase('${currentEditToken}')">View Updated Case</button>
                            <button class="btn btn-secondary" onclick="cancelCaseEdit()" style="margin-left: 10px;">Close</button>
                        </div>
                    </div>
                `;
                document.getElementById('editCaseResult').classList.remove('hidden');
                document.getElementById('editCaseForm').classList.add('hidden');
                
            } catch (error) {
                console.error('Error updating case:', error);
                document.getElementById('editCaseResult').innerHTML = `
                    <div class="alert alert-error">
                        <h3>Error Updating Case</h3>
                        <p>There was an error updating your case. Please try again.</p>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `;
                document.getElementById('editCaseResult').classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Changes';
            }
        });

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99606f90679384b9',t:'MTc2MTcxNzQ1MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
