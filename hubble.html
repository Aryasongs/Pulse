<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Huddle - Chat App</title>
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiSHVkZGxlIiwic2hvcnRfbmFtZSI6Ikh1ZGRsZSIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMTExYjIxIiwidGhlbWVfY29sb3IiOiIjMDBhODg0IiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0Nzdmcgd2lkdGg9JzE5MicgaGVpZ2h0PScxOTInIHZpZXdCb3g9JzAgMCAyNCAyNCcgZmlsbD0nJTIzMDBhODg0JyUzRSUzQ3BhdGggZD0nTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyczQuNDggMTAgMTAgMTAgMTAtNC40OCAxMC0xMFMxNy41MiAyIDEyIDJ6bTAgMThjLTQuNDEgMC04LTMuNTktOC04czMuNTktOCA4LTggOCAzLjU5IDggOC0zLjU5IDgtOCA4eicvJTNFJTNDL3N2ZyUzRSIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dfQ==">
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    :root {
      --bg-primary: #111b21;
      --bg-secondary: #202c33;
      --bg-tertiary: #2a3942;
      --bg-quaternary: #3b4a54;
      --text-primary: #e9edef;
      --text-secondary: #8696a0;
      --text-tertiary: #aebac1;
      --accent-primary: #00a884;
      --accent-secondary: #128c7e;
      --accent-tertiary: #075e54;
      --border-primary: #313d45;
      --shadow-primary: rgba(0, 0, 0, 0.1);
      --shadow-secondary: rgba(0, 0, 0, 0.2);
      --success-color: #4caf50;
      --error-color: #f44336;
      --warning-color: #ff9800;
      --info-color: #2196f3;
    }

    [data-theme="light"] {
      --bg-primary: #f0f2f5;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f8f9fa;
      --bg-quaternary: #e4e6ea;
      --text-primary: #111b21;
      --text-secondary: #667781;
      --text-tertiary: #54656f;
      --accent-primary: #00a884;
      --accent-secondary: #128c7e;
      --accent-tertiary: #075e54;
      --border-primary: #e9edef;
      --shadow-primary: rgba(0, 0, 0, 0.05);
      --shadow-secondary: rgba(0, 0, 0, 0.1);
    }

    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      height: 100%;
      overflow: hidden;
      background: var(--bg-primary);
      transition: all 0.3s ease;
      touch-action: manipulation;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }

    html {
      height: 100%;
    }

    * {
      box-sizing: border-box;
    }

    input, textarea, button {
      -webkit-user-select: text;
      touch-action: manipulation;
    }

    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* Loading Spinner */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid var(--text-secondary);
      border-radius: 50%;
      border-top-color: var(--accent-primary);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(5px);
    }

    .loading-content {
      background: var(--bg-secondary);
      padding: 30px;
      border-radius: 16px;
      text-align: center;
      color: var(--text-primary);
      box-shadow: 0 20px 60px var(--shadow-secondary);
    }

    .loading-content .loading-spinner {
      width: 40px;
      height: 40px;
      border-width: 4px;
      margin-bottom: 16px;
    }

    /* Login Screen */
    .login-container {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      background: linear-gradient(135deg, #00a884 0%, #128c7e 50%, #075e54 100%);
      position: relative;
      overflow: hidden;
    }

    .login-container::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
      animation: float 20s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      33% { transform: translate(30px, -30px) rotate(120deg); }
      66% { transform: translate(-20px, 20px) rotate(240deg); }
    }

    .login-box {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      padding: 48px;
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      text-align: center;
      max-width: 420px;
      width: 90%;
      position: relative;
      z-index: 1;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .login-box h1 {
      margin: 0 0 12px 0;
      color: #333;
      font-size: 32px;
      font-weight: 700;
    }

    .login-box p {
      margin: 0 0 32px 0;
      color: #666;
      font-size: 16px;
      line-height: 1.5;
    }

    .google-btn {
      background: white;
      border: 2px solid #ddd;
      padding: 14px 28px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 12px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .google-btn:hover {
      background: #f8f9fa;
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    .google-btn:active {
      transform: translateY(0);
    }

    .google-icon {
      width: 20px;
      height: 20px;
    }

    /* App Container */
    .app-container {
      display: none;
      height: 100%;
      background: var(--bg-primary);
    }

    .app-container.active {
      display: flex;
    }

    /* Sidebar */
    .sidebar {
      width: 30%;
      min-width: 320px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-primary);
      display: flex;
      flex-direction: column;
      height: 100%;
      position: relative;
    }

    .sidebar::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 1px;
      height: 100%;
      background: linear-gradient(180deg, transparent 0%, var(--border-primary) 50%, transparent 100%);
    }

    .sidebar-header {
      padding: 20px 16px;
      background: var(--bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border-primary);
      position: relative;
    }

    .sidebar-header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent 0%, var(--border-primary) 50%, transparent 100%);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .user-info:hover {
      transform: translateX(2px);
    }

    .profile-pic {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      background: var(--bg-quaternary);
      border: 2px solid var(--accent-primary);
      transition: all 0.3s ease;
    }

    .profile-pic:hover {
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(0, 168, 132, 0.3);
    }

    .user-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 16px;
    }

    .header-actions {
      display: flex;
      gap: 8px;
    }

    .icon-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 10px;
      border-radius: 50%;
      color: var(--text-tertiary);
      transition: all 0.3s ease;
      position: relative;
    }

    .icon-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--accent-primary);
      transform: scale(1.1);
    }

    .icon-btn:active {
      transform: scale(0.95);
    }

    /* Search Bar */
    .search-bar {
      padding: 12px 16px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-primary);
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 12px 16px 12px 44px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      transition: all 0.3s ease;
    }

    .search-input::placeholder {
      color: var(--text-secondary);
    }

    .search-bar::before {
      content: 'üîç';
      position: absolute;
      left: 28px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
      font-size: 16px;
    }

    .search-input:focus {
      background: var(--bg-quaternary);
      box-shadow: 0 0 0 2px rgba(0, 168, 132, 0.3);
    }

    /* Search Filters */
    .search-filters {
      display: none;
      gap: 8px;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-primary);
    }

    .filter-tab {
      padding: 6px 12px;
      border-radius: 16px;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .filter-tab.active {
      background: var(--accent-primary);
      color: white;
    }

    .filter-tab:hover:not(.active) {
      background: var(--bg-quaternary);
    }

    /* Chat List */
    .chat-list {
      flex: 1;
      overflow-y: auto;
      background: var(--bg-primary);
    }

    .chat-item {
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      transition: all 0.3s ease;
      position: relative;
    }

    .chat-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 0;
      background: var(--accent-primary);
      transition: width 0.3s ease;
    }

    .chat-item:hover {
      background: rgba(255, 255, 255, 0.05);
      transform: translateX(4px);
    }

    .chat-item:hover::before {
      width: 3px;
    }

    .chat-item.active {
      background: rgba(0, 168, 132, 0.1);
      border-left: 3px solid var(--accent-primary);
    }

    .chat-avatar-container {
      position: relative;
    }

    .chat-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      background: var(--bg-quaternary);
      border: 2px solid transparent;
      transition: all 0.3s ease;
    }

    .chat-item:hover .chat-avatar {
      border-color: rgba(0, 168, 132, 0.3);
      transform: scale(1.05);
    }

    .online-indicator {
      position: absolute;
      bottom: 2px;
      right: 2px;
      width: 14px;
      height: 14px;
      background: var(--success-color);
      border: 3px solid var(--bg-primary);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
      100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
    }

    .unread-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--accent-primary);
      color: white;
      border-radius: 50%;
      min-width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      animation: bounce 0.5s ease-in-out;
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-5px); }
      60% { transform: translateY(-2px); }
    }

    .chat-info {
      flex: 1;
      min-width: 0;
    }

    .chat-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 16px;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .chat-preview {
      color: var(--text-secondary);
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .last-seen {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    .chat-meta {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }

    .chat-time {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    /* Main Chat Area */
    .main-chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100%;
      background: var(--bg-primary);
      position: relative;
    }

    .main-chat::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="dots" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="1" fill="rgba(255,255,255,0.02)"/></pattern></defs><rect width="100" height="100" fill="url(%23dots)"/></svg>');
      opacity: 0.3;
      pointer-events: none;
    }

    .empty-chat {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      flex-direction: column;
      gap: 20px;
      color: var(--text-secondary);
      position: relative;
      z-index: 1;
    }

    .empty-chat h2 {
      margin: 0;
      font-size: 48px;
      animation: bounce 2s ease-in-out infinite;
    }

    .empty-chat p {
      font-size: 18px;
      text-align: center;
      max-width: 300px;
      line-height: 1.5;
    }

    /* Chat Header */
    .chat-header {
      padding: 20px;
      background: var(--bg-secondary);
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border-primary);
      position: relative;
      z-index: 2;
      backdrop-filter: blur(10px);
    }

    .chat-header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent 0%, var(--border-primary) 50%, transparent 100%);
    }

    .chat-header-info {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .chat-header-info:hover {
      transform: translateX(2px);
    }

    .chat-header-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 18px;
      margin-bottom: 2px;
    }

    .chat-header-status {
      font-size: 13px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .chat-header-status::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-secondary);
    }

    .chat-header-status.online::before {
      background: var(--success-color);
      animation: pulse 2s infinite;
    }

    .chat-header-status.typing {
      color: var(--accent-primary);
    }

    .back-btn {
      display: none;
      background: none;
      border: none;
      color: var(--text-tertiary);
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.3s ease;
      margin-right: 8px;
    }

    .back-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--accent-primary);
    }

    /* Messages Container */
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: relative;
      z-index: 1;
      scroll-behavior: smooth;
    }

    .message {
      max-width: 65%;
      padding: 12px 16px;
      border-radius: 12px;
      word-wrap: break-word;
      display: flex;
      flex-direction: column;
      gap: 6px;
      position: relative;
      animation: messageSlide 0.3s ease-out;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    @keyframes messageSlide {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    }

    .message.sent {
      align-self: flex-end;
      background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message.sent::after {
      content: '';
      position: absolute;
      bottom: 0;
      right: -8px;
      width: 0;
      height: 0;
      border-left: 8px solid var(--accent-secondary);
      border-bottom: 8px solid transparent;
    }

    .message.received {
      align-self: flex-start;
      background: var(--bg-secondary);
      color: var(--text-primary);
      border-bottom-left-radius: 4px;
    }

    .message.received::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: -8px;
      width: 0;
      height: 0;
      border-right: 8px solid var(--bg-secondary);
      border-bottom: 8px solid transparent;
    }

    .message.system {
      align-self: center;
      background: rgba(255, 235, 59, 0.1);
      color: var(--text-secondary);
      border: 1px solid rgba(255, 235, 59, 0.3);
      font-size: 12px;
      padding: 8px 12px;
      border-radius: 16px;
      max-width: 80%;
      text-align: center;
    }

    .message-text {
      font-size: 15px;
      line-height: 1.5;
      word-break: break-word;
    }

    .message.sent .message-text {
      color: white;
    }

    .message.received .message-text {
      color: var(--text-primary);
    }

    .message-image {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      margin-bottom: 6px;
      transition: transform 0.3s ease;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .message-image:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    }

    .message-time {
      font-size: 11px;
      align-self: flex-end;
      opacity: 0.7;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .message.sent .message-time {
      color: rgba(255, 255, 255, 0.8);
    }

    .message.received .message-time {
      color: var(--text-secondary);
    }

    .message-status {
      font-size: 14px;
      line-height: 1;
      display: flex;
      align-items: center;
      gap: 2px;
      margin-left: 4px;
    }

    .status-sent {
      color: rgba(255, 255, 255, 0.6);
    }

    .status-delivered {
      color: rgba(255, 255, 255, 0.8);
    }

    .status-read {
      color: #53bdeb;
    }

    .status-sending {
      color: rgba(255, 255, 255, 0.4);
      animation: pulse 1s ease-in-out infinite;
    }

    .status-failed {
      color: var(--error-color);
      cursor: pointer;
      title: "Click to retry";
    }

    /* Verified Icon */
    .verified-icon {
      width: 16px;
      height: 16px;
      vertical-align: middle;
      margin-left: 4px;
      display: inline-block;
    }

    .official-label {
      background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 8px;
      margin-left: 6px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Message Reactions */
    .message-reactions {
      display: flex;
      gap: 4px;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    .reaction {
      background: var(--bg-tertiary);
      border-radius: 12px;
      padding: 2px 6px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 2px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid transparent;
    }

    .reaction:hover {
      background: var(--bg-quaternary);
      transform: scale(1.05);
    }

    .reaction.active {
      background: var(--accent-primary);
      color: white;
      border-color: var(--accent-primary);
    }

    /* Typing Indicator */
    .typing-indicator {
      padding: 12px 16px;
      background: var(--bg-secondary);
      border-radius: 12px;
      align-self: flex-start;
      display: none;
      align-items: center;
      gap: 6px;
      position: relative;
      border-bottom-left-radius: 4px;
      animation: messageSlide 0.3s ease-out;
    }

    .typing-indicator::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: -8px;
      width: 0;
      height: 0;
      border-right: 8px solid var(--bg-secondary);
      border-bottom: 8px solid transparent;
    }

    .typing-indicator.active {
      display: flex;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      background: var(--text-secondary);
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }

    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {
      0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.4;
      }
      30% {
        transform: translateY(-8px);
        opacity: 1;
      }
    }

    /* Chat Input */
    .chat-input-container {
      padding: 20px;
      background: var(--bg-secondary);
      display: flex;
      gap: 12px;
      align-items: flex-end;
      position: relative;
      z-index: 2;
      border-top: 1px solid var(--border-primary);
    }

    .input-container {
      flex: 1;
      position: relative;
      display: flex;
      align-items: flex-end;
      background: var(--bg-tertiary);
      border-radius: 24px;
      padding: 4px;
      transition: all 0.3s ease;
    }

    .input-container:focus-within {
      background: var(--bg-quaternary);
      box-shadow: 0 0 0 2px rgba(0, 168, 132, 0.3);
    }

    .chat-input {
      flex: 1;
      padding: 14px 16px;
      border: none;
      border-radius: 20px;
      font-size: 15px;
      outline: none;
      background: transparent;
      color: var(--text-primary);
      resize: none;
      max-height: 120px;
      min-height: 48px;
      line-height: 1.4;
    }

    .chat-input::placeholder {
      color: var(--text-secondary);
    }

    .emoji-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 4px;
    }

    .emoji-btn:hover {
      background: var(--bg-quaternary);
      color: var(--accent-primary);
      transform: scale(1.1);
    }

    .send-btn, .image-btn, .voice-btn {
      border: none;
      color: white;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .send-btn {
      background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
    }

    .send-btn:hover {
      background: linear-gradient(135deg, var(--accent-secondary) 0%, var(--accent-tertiary) 100%);
      transform: scale(1.1);
      box-shadow: 0 4px 20px rgba(0, 168, 132, 0.4);
    }

    .send-btn:active {
      transform: scale(0.95);
    }

    .image-btn, .voice-btn {
      background: var(--bg-quaternary);
      color: var(--text-tertiary);
    }

    .image-btn:hover, .voice-btn:hover {
      background: var(--accent-primary);
      color: white;
      transform: scale(1.1);
      box-shadow: 0 4px 20px rgba(0, 168, 132, 0.4);
    }

    .image-btn:active, .voice-btn:active {
      transform: scale(0.95);
    }

    /* Modals */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(10px);
    }

    .modal.active {
      display: flex;
      animation: modalFade 0.3s ease-out;
    }

    @keyframes modalFade {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .modal-content {
      background: var(--bg-secondary);
      padding: 32px;
      border-radius: 20px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      border: 1px solid var(--border-primary);
      animation: modalSlide 0.3s ease-out;
    }

    @keyframes modalSlide {
      from {
        opacity: 0;
        transform: translateY(-50px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-content h2 {
      margin: 0 0 24px 0;
      color: var(--text-primary);
      font-size: 24px;
      font-weight: 600;
    }

    .modal-input {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      font-size: 15px;
      margin-bottom: 20px;
      outline: none;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      transition: all 0.3s ease;
    }

    .modal-input::placeholder {
      color: var(--text-secondary);
    }

    .modal-input:focus {
      border-color: var(--accent-primary);
      background: var(--bg-quaternary);
      box-shadow: 0 0 0 2px rgba(0, 168, 132, 0.2);
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .modal-btn {
      padding: 12px 28px;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .modal-btn.primary {
      background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
      color: white;
    }

    .modal-btn.primary:hover {
      background: linear-gradient(135deg, var(--accent-secondary) 0%, var(--accent-tertiary) 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(0, 168, 132, 0.4);
    }

    .modal-btn.secondary {
      background: var(--bg-quaternary);
      color: var(--text-primary);
    }

    .modal-btn.secondary:hover {
      background: var(--bg-tertiary);
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    /* Settings Modal */
    .settings-modal .modal-content {
      max-width: 400px;
    }

    .settings-section {
      margin-bottom: 24px;
    }

    .settings-section h3 {
      margin: 0 0 12px 0;
      color: var(--text-primary);
      font-size: 16px;
    }

    .theme-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 24px;
      background: var(--bg-quaternary);
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .toggle-switch.active {
      background: var(--accent-primary);
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s ease;
    }

    .toggle-switch.active::after {
      transform: translateX(26px);
    }

    .status-input {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border-primary);
      border-radius: 8px;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 14px;
      outline: none;
    }

    .status-input:focus {
      border-color: var(--accent-primary);
    }

    /* Profile Upload */
    .profile-upload {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
    }

    .profile-preview {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      background: var(--bg-quaternary);
      border: 3px solid var(--accent-primary);
    }

    .upload-btn {
      padding: 8px 16px;
      background: var(--accent-primary);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .upload-btn:hover {
      background: var(--accent-secondary);
      transform: translateY(-2px);
    }

    .file-input {
      display: none;
    }

    /* Message Menu */
    .message-menu {
      position: absolute;
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: 8px;
      box-shadow: 0 4px 20px var(--shadow-secondary);
      z-index: 1000;
      min-width: 150px;
      display: none;
    }

    .message-menu.active {
      display: block;
      animation: menuSlide 0.2s ease-out;
    }

    @keyframes menuSlide {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-menu-item {
      padding: 12px 16px;
      cursor: pointer;
      color: var(--text-primary);
      font-size: 14px;
      transition: background 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .message-menu-item:hover {
      background: var(--bg-tertiary);
    }

    .message-menu-item.danger {
      color: var(--error-color);
    }

    .message-menu-item.danger:hover {
      background: rgba(244, 67, 54, 0.1);
    }

    /* Reaction Picker */
    .reaction-picker {
      position: absolute;
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: 20px;
      padding: 8px;
      display: none;
      z-index: 1000;
      box-shadow: 0 4px 20px var(--shadow-secondary);
    }

    .reaction-picker.active {
      display: flex;
      gap: 4px;
      animation: menuSlide 0.2s ease-out;
    }

    .reaction-emoji {
      font-size: 20px;
      padding: 4px;
      cursor: pointer;
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .reaction-emoji:hover {
      background: var(--bg-tertiary);
      transform: scale(1.2);
    }

    /* Emoji Picker */
    .emoji-picker {
      position: absolute;
      bottom: 70px;
      right: 20px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: 16px;
      padding: 16px;
      display: none;
      z-index: 1000;
      box-shadow: 0 8px 40px var(--shadow-secondary);
      max-width: 320px;
      max-height: 300px;
      overflow-y: auto;
    }

    .emoji-picker.active {
      display: block;
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .emoji-categories {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      border-bottom: 1px solid var(--border-primary);
      padding-bottom: 8px;
    }

    .emoji-category {
      padding: 6px 12px;
      border-radius: 12px;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .emoji-category.active {
      background: var(--accent-primary);
      color: white;
    }

    .emoji-category:hover:not(.active) {
      background: var(--bg-quaternary);
    }

    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 4px;
    }

    .emoji-item {
      font-size: 20px;
      padding: 8px;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s ease;
      text-align: center;
    }

    .emoji-item:hover {
      background: var(--bg-tertiary);
      transform: scale(1.2);
    }

    /* Floating Add Button */
    .floating-add-btn {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(0, 168, 132, 0.4);
      transition: all 0.3s ease;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.1);
    }

    .floating-add-btn:hover {
      transform: scale(1.1) rotate(90deg);
      box-shadow: 0 8px 40px rgba(0, 168, 132, 0.6);
      background: linear-gradient(135deg, var(--accent-secondary) 0%, var(--accent-tertiary) 100%);
    }

    .floating-add-btn:active {
      transform: scale(0.95) rotate(90deg);
    }

    .floating-add-btn::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      border-radius: 50%;
      animation: shimmer 3s ease-in-out infinite;
    }

    @keyframes shimmer {
      0%, 100% { opacity: 0; }
      50% { opacity: 1; }
    }

    /* Scroll to Bottom Button */
    .scroll-to-bottom {
      position: absolute;
      bottom: 80px;
      right: 20px;
      width: 40px;
      height: 40px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: 50%;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 10px var(--shadow-primary);
      transition: all 0.3s ease;
      z-index: 50;
    }

    .scroll-to-bottom.visible {
      display: flex;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .scroll-to-bottom:hover {
      background: var(--bg-tertiary);
      transform: scale(1.1);
    }

    /* Notifications */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 168, 132, 0.4);
      z-index: 2000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
      max-width: 300px;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.error {
      background: linear-gradient(135deg, var(--error-color) 0%, #d32f2f 100%);
    }

    .notification.warning {
      background: linear-gradient(135deg, var(--warning-color) 0%, #f57c00 100%);
    }

    .notification.info {
      background: linear-gradient(135deg, var(--info-color) 0%, #1976d2 100%);
    }

    /* Image Preview Modal */
    .image-preview-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      align-items: center;
      justify-content: center;
      z-index: 2000;
      backdrop-filter: blur(10px);
    }

    .image-preview-modal.active {
      display: flex;
    }

    .image-preview-content {
      max-width: 90%;
      max-height: 90%;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .image-preview-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s ease;
    }

    .image-preview-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* Profile Popup */
    .profile-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--bg-secondary);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 20px 60px var(--shadow-secondary);
      z-index: 2000;
      min-width: 300px;
      display: none;
      border: 1px solid var(--border-primary);
    }

    .profile-popup.active {
      display: block;
      animation: modalSlide 0.3s ease-out;
    }

    .profile-popup-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .profile-popup-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin: 0 auto 12px;
      display: block;
      border: 3px solid var(--accent-primary);
    }

    .profile-popup-name {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .profile-popup-status {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* Search Highlight */
    .search-highlight {
      background: rgba(255, 235, 59, 0.2) !important;
      border-left: 3px solid #ffeb3b !important;
      animation: searchPulse 2s ease-in-out;
    }

    @keyframes searchPulse {
      0%, 100% { background: rgba(255, 235, 59, 0.2); }
      50% { background: rgba(255, 235, 59, 0.4); }
    }

    /* Group Chat Indicators */
    .group-indicator {
      background: var(--accent-primary);
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 8px;
      margin-left: 4px;
    }



    /* Mobile Responsive */
    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        min-width: unset;
      }

      .main-chat {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 100;
        display: none;
      }

      .main-chat.active {
        display: flex;
      }

      .sidebar.hidden {
        display: none;
      }



      .message {
        max-width: 85%;
      }

      .back-btn {
        display: block;
      }

      .chat-header-info {
        gap: 8px;
      }

      .modal-content {
        margin: 20px;
        width: calc(100% - 40px);
        padding: 24px;
      }

      .login-box {
        margin: 20px;
        padding: 32px 24px;
      }

      .floating-add-btn {
        bottom: 20px;
        right: 16px;
      }


    }

    @media (max-width: 480px) {
      .message {
        max-width: 90%;
        padding: 10px 14px;
      }

      .chat-input-container {
        padding: 16px;
        gap: 8px;
      }

      .send-btn, .image-btn {
        width: 44px;
        height: 44px;
      }

      .sidebar-header {
        padding: 16px 12px;
      }

      .chat-item {
        padding: 12px;
      }

      .modal-content {
        padding: 20px;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body><!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay" style="display: none;">
   <div class="loading-content">
    <div class="loading-spinner"></div>
    <div id="loadingText">
     Loading...
    </div>
   </div>
  </div><!-- Login Screen -->
  <div class="login-container" id="loginContainer">
   <div class="login-box">
    <h1 id="appTitle">Huddle</h1>
    <p id="welcomeMessage">Connect with friends instantly</p><button class="google-btn" id="googleSignInBtn">
     <svg class="google-icon" viewbox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" /> <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" /> <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" /> <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
     </svg> Sign in with Google </button>
   </div>
  </div><!-- Main App -->
  <div class="app-container" id="appContainer"><!-- Sidebar -->
   <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
     <div class="user-info" onclick="showUserProfile()"><img class="profile-pic" id="currentUserPic" src="" alt="Profile"> <span class="user-name" id="currentUserName">User</span>
     </div>
     <div class="header-actions"><button class="icon-btn" id="addFriendBtn" title="Add Friend">
       <svg width="24" height="24" viewbox="0 0 24 24" fill="currentColor"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
       </svg></button> <button class="icon-btn" id="profileBtn" title="Profile">
       <svg width="24" height="24" viewbox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
       </svg></button> <button class="icon-btn" id="settingsBtn" title="Settings">
       <svg width="24" height="24" viewbox="0 0 24 24" fill="currentColor"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.82,11.69,4.82,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z" />
       </svg></button> <button class="icon-btn" id="logoutBtn" title="Logout">
       <svg width="24" height="24" viewbox="0 0 24 24" fill="currentColor"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z" />
       </svg></button>
     </div>
    </div>
    <div class="search-bar"><input type="text" class="search-input" id="searchInput" placeholder="Search or start new chat">
    </div>
    <div class="search-filters" id="searchFilters">
     <div class="filter-tab active" data-filter="all">
      All
     </div>
     <div class="filter-tab" data-filter="media">
      Media
     </div>
     <div class="filter-tab" data-filter="links">
      Links
     </div>
     <div class="filter-tab" data-filter="docs">
      Docs
     </div>
    </div>
    <div class="chat-list" id="chatList"><!-- Chat items will be added here -->
    </div>
   </div><!-- Main Chat Area -->
   <div class="main-chat" id="mainChat">
    <div class="empty-chat" id="emptyChat">
     <h2>üí¨</h2>
     <p>Select a chat to start messaging</p>
    </div>
    <div id="activeChatContainer" style="display: none; flex-direction: column; height: 100%;">
     <div class="chat-header">
      <div class="chat-header-info" onclick="showChatProfile()"><button class="back-btn" id="backBtn">
        <svg width="24" height="24" viewbox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
        </svg></button> <img class="profile-pic" id="activeChatPic" src="" alt="Profile">
       <div>
        <div class="chat-header-name" id="activeChatName">
         Friend
        </div>
        <div class="chat-header-status" id="activeChatStatus">
         offline
        </div>
       </div>
      </div>
     </div>
     <div class="messages-container" id="messagesContainer"><!-- Messages will be added here -->
      <div class="typing-indicator" id="typingIndicator">
       <div class="typing-dot"></div>
       <div class="typing-dot"></div>
       <div class="typing-dot"></div>
      </div>
      <div class="scroll-to-bottom" id="scrollToBottom">
       <svg width="20" height="20" viewbox="0 0 24 24" fill="currentColor"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z" />
       </svg>
      </div>
     </div>
     <div class="chat-input-container"><button class="image-btn" id="imageBtn" title="Send Image">
       <svg width="24" height="24" viewbox="0 0 24 24" fill="currentColor"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" />
       </svg></button> <button class="voice-btn" id="voiceBtn" title="Voice Message" style="display: none;">
       <svg width="24" height="24" viewbox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z" />
       </svg></button>
      <div class="input-container"><textarea class="chat-input" id="chatInput" placeholder="Type a message" rows="1"></textarea> <button class="emoji-btn" id="emojiBtn" title="Emoji">
        <svg width="20" height="20" viewbox="0 0 24 24" fill="currentColor"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z" />
        </svg></button>
      </div><button class="send-btn" id="sendBtn">
       <svg width="24" height="24" viewbox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
       </svg></button>
     </div>
    </div>
   </div>
  </div><!-- Add Friend Modal -->
  <div class="modal" id="addFriendModal">
   <div class="modal-content">
    <h2>Add Friend</h2><input type="email" class="modal-input" id="friendEmailInput" placeholder="Enter friend's email">
    <div class="modal-actions"><button class="modal-btn secondary" id="cancelAddFriendBtn">Cancel</button> <button class="modal-btn primary" id="confirmAddFriendBtn"> <span class="loading-spinner" style="display: none; margin-right: 8px;"></span> Add </button>
    </div>
   </div>
  </div><!-- Profile Modal -->
  <div class="modal" id="profileModal">
   <div class="modal-content">
    <h2>Edit Profile</h2>
    <div class="profile-upload"><img class="profile-preview" id="profilePreview" src="" alt="Profile"> <button class="upload-btn" id="uploadProfileBtn">Upload Photo</button> <input type="file" class="file-input" id="profileFileInput" accept="image/*">
    </div><input type="text" class="modal-input" id="displayNameInput" placeholder="Display Name">
    <div class="modal-actions"><button class="modal-btn secondary" id="cancelProfileBtn">Cancel</button> <button class="modal-btn primary" id="saveProfileBtn"> <span class="loading-spinner" style="display: none; margin-right: 8px;"></span> Save </button>
    </div>
   </div>
  </div><!-- Settings Modal -->
  <div class="modal settings-modal" id="settingsModal">
   <div class="modal-content">
    <h2>Settings</h2>
    <div class="settings-section">
     <h3>Appearance</h3>
     <div class="theme-toggle"><span>Dark Theme</span>
      <div class="toggle-switch" id="themeToggle"></div>
     </div>
    </div>
    <div class="settings-section">
     <h3>Status Message</h3><input type="text" class="status-input" id="statusInput" placeholder="Hey there! I'm using Huddle.">
    </div>
    <div class="modal-actions"><button class="modal-btn secondary" id="cancelSettingsBtn">Cancel</button> <button class="modal-btn primary" id="saveSettingsBtn"> <span class="loading-spinner" style="display: none; margin-right: 8px;"></span> Save </button>
    </div>
   </div>
  </div><!-- Group Chat Modal -->
  <div class="modal" id="groupChatModal">
   <div class="modal-content">
    <h2>Create Group Chat</h2><input type="text" class="modal-input" id="groupNameInput" placeholder="Group name"> <input type="email" class="modal-input" id="groupMembersInput" placeholder="Add members (comma separated emails)">
    <div class="modal-actions"><button class="modal-btn secondary" id="cancelGroupBtn">Cancel</button> <button class="modal-btn primary" id="createGroupBtn"> <span class="loading-spinner" style="display: none; margin-right: 8px;"></span> Create </button>
    </div>
   </div>
  </div><!-- Profile Popup -->
  <div class="profile-popup" id="profilePopup">
   <div class="profile-popup-header"><img class="profile-popup-avatar" id="profilePopupAvatar" src="" alt="Avatar">
    <div class="profile-popup-name" id="profilePopupName">
     User Name
    </div>
    <div class="profile-popup-status" id="profilePopupStatus">
     Hey there! I'm using Huddle.
    </div>
   </div><button class="modal-btn secondary" onclick="closeProfilePopup()">Close</button>
  </div><!-- Message Menu -->
  <div class="message-menu" id="messageMenu">
   <div class="message-menu-item" id="reactToMessage"><span>üòä</span> React
   </div>
   <div class="message-menu-item" id="editMessage"><span>‚úèÔ∏è</span> Edit
   </div>
   <div class="message-menu-item danger" id="deleteForMe"><span>üóëÔ∏è</span> Delete for me
   </div>
   <div class="message-menu-item danger" id="deleteForEveryone"><span>‚ö†Ô∏è</span> Delete for everyone
   </div>
  </div><!-- Reaction Picker -->
  <div class="reaction-picker" id="reactionPicker"><span class="reaction-emoji" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</span> <span class="reaction-emoji" data-emoji="üòÇ">üòÇ</span> <span class="reaction-emoji" data-emoji="üëç">üëç</span> <span class="reaction-emoji" data-emoji="üëé">üëé</span> <span class="reaction-emoji" data-emoji="üòÆ">üòÆ</span> <span class="reaction-emoji" data-emoji="üò¢">üò¢</span>
  </div><!-- Image Preview Modal -->
  <div class="image-preview-modal" id="imagePreviewModal"><button class="image-preview-close" id="imagePreviewClose">√ó</button> <img class="image-preview-content" id="imagePreviewContent" src="" alt="Preview">
  </div><!-- Floating Add Button --> <button class="floating-add-btn" id="floatingAddBtn">+</button> <!-- Emoji Picker -->
  <div class="emoji-picker" id="emojiPicker">
   <div class="emoji-categories">
    <div class="emoji-category active" data-category="smileys">
     üòä
    </div>
    <div class="emoji-category" data-category="people">
     üëã
    </div>
    <div class="emoji-category" data-category="nature">
     üå∏
    </div>
    <div class="emoji-category" data-category="food">
     üçï
    </div>
    <div class="emoji-category" data-category="activities">
     ‚öΩ
    </div>
    <div class="emoji-category" data-category="travel">
     ‚úàÔ∏è
    </div>
    <div class="emoji-category" data-category="objects">
     üí°
    </div>
    <div class="emoji-category" data-category="symbols">
     ‚ù§Ô∏è
    </div>
   </div>
   <div class="emoji-grid" id="emojiGrid"><!-- Emojis will be populated here -->
   </div>
  </div><!-- Notification -->
  <div class="notification" id="notification"><span id="notificationText">Notification</span>
  </div><!-- File Inputs --> <input type="file" class="file-input" id="imageFileInput" accept="image/*">
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getDatabase, ref, set, get, onValue, push, update, onDisconnect, serverTimestamp, child, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    // Firebase Configuration - Multiple fallback configs
    const firebaseConfigs = [
      {
        apiKey: "AIzaSyBvOO55vvqXcdu_kDdXA4Z4S3PaHiHIGI0",
        authDomain: "huddle-demo-app.firebaseapp.com",
        databaseURL: "https://huddle-demo-app-default-rtdb.firebaseio.com",
        projectId: "huddle-demo-app",
        storageBucket: "huddle-demo-app.appspot.com",
        messagingSenderId: "987654321098",
        appId: "1:987654321098:web:1234567890abcdef"
      },
      {
        apiKey: "AIzaSyDGpAHHbR7zOb6hZsJ8cFQ7nGqUHfPzOkM",
        authDomain: "huddle-chat-app-demo.firebaseapp.com",
        databaseURL: "https://huddle-chat-app-demo-default-rtdb.firebaseio.com",
        projectId: "huddle-chat-app-demo",
        storageBucket: "huddle-chat-app-demo.appspot.com",
        messagingSenderId: "123456789012",
        appId: "1:123456789012:web:abcdef123456789012345678"
      }
    ];

    // Initialize Firebase with multiple fallbacks
    let app, auth, db, provider;
    let firebaseInitialized = false;
    
    async function initializeFirebaseWithFallback() {
      for (let i = 0; i < firebaseConfigs.length; i++) {
        try {
          console.log(`Trying Firebase config ${i + 1}...`);
          
          app = initializeApp(firebaseConfigs[i], `app-${i}`);
          auth = getAuth(app);
          db = getDatabase(app);
          provider = new GoogleAuthProvider();
          
          // Test connection with a simple read
          const testRef = ref(db, '.info/connected');
          await new Promise((resolve, reject) => {
            const timeout = setTimeout(() => reject(new Error('Connection timeout')), 5000);
            onValue(testRef, (snapshot) => {
              clearTimeout(timeout);
              if (snapshot.val() === true) {
                resolve(true);
              } else {
                reject(new Error('Not connected'));
              }
            }, { onlyOnce: true });
          });
          
          console.log(`Firebase initialized successfully with config ${i + 1}`);
          firebaseInitialized = true;
          showNotification('Connected to Firebase! üéâ', 'success');
          return true;
          
        } catch (error) {
          console.error(`Firebase config ${i + 1} failed:`, error);
          if (i === firebaseConfigs.length - 1) {
            // Last config failed, show error
            showNotification('Unable to connect to Firebase. Using offline mode.', 'warning');
            enableOfflineMode();
            return false;
          }
        }
      }
    }

    // Offline mode fallback
    function enableOfflineMode() {
      console.log('Enabling offline mode...');
      
      // Create mock Firebase objects
      auth = {
        currentUser: null,
        signInWithPopup: () => Promise.reject(new Error('Offline mode')),
        signOut: () => Promise.resolve(),
        onAuthStateChanged: (callback) => {
          // Simulate offline user
          setTimeout(() => {
            const mockUser = {
              uid: 'offline-user-' + Date.now(),
              email: 'offline@demo.com',
              displayName: 'Offline User',
              photoURL: ''
            };
            callback(mockUser);
          }, 1000);
        }
      };
      
      db = {
        ref: () => ({
          set: () => Promise.resolve(),
          get: () => Promise.resolve({ exists: () => false, val: () => null }),
          push: () => Promise.resolve({ key: 'offline-' + Date.now() }),
          update: () => Promise.resolve(),
          on: () => {},
          off: () => {}
        })
      };
      
      showNotification('Running in offline demo mode. Features are limited.', 'info');
    }

    // Initialize Firebase on page load
    initializeFirebaseWithFallback();

    // Global Variables
    let currentUser = null;
    let activeChat = null;
    let typingTimeout = null;
    let currentTheme = 'dark';
    let selectedMessage = null;
    let unreadCounts = {};
    let isPageVisible = true;
    let allUsers = {};
    let offlineQueue = [];

    // Simple user system without verification
    let officialAccountUid = null;

    // Element SDK Configuration
    const defaultConfig = {
      app_title: "Huddle",
      welcome_message: "Connect with friends instantly"
    };

    const config = { ...defaultConfig };

    async function onConfigChange(newConfig) {
      const appTitle = document.getElementById('appTitle');
      const welcomeMessage = document.getElementById('welcomeMessage');
      
      if (appTitle) appTitle.textContent = newConfig.app_title || defaultConfig.app_title;
      if (welcomeMessage) welcomeMessage.textContent = newConfig.welcome_message || defaultConfig.welcome_message;
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: (config) => ({
          recolorables: [],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map([
          ["app_title", config.app_title || defaultConfig.app_title],
          ["welcome_message", config.welcome_message || defaultConfig.welcome_message]
        ])
      });
    }

    onConfigChange(config);

    // Page Visibility API for notifications
    document.addEventListener('visibilitychange', () => {
      isPageVisible = !document.hidden;
    });

    // Connection status monitoring
    window.addEventListener('online', () => {
      showNotification('Connection restored! üåê', 'success');
      if (currentUser) {
        setupUserPresence(currentUser.uid);
      }
    });

    window.addEventListener('offline', () => {
      showNotification('You are offline. Some features may not work.', 'warning');
    });

    // Check initial connection
    if (!navigator.onLine) {
      showNotification('You appear to be offline. Please check your internet connection.', 'warning');
    }

    // Request notification permission
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }

    // PWA Service Worker Registration
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('data:application/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgZXZlbnQgPT4geyBzZWxmLnNraXBXYWl0aW5nKCk7IH0pOyBzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2FjdGl2YXRlJywgZXZlbnQgPT4geyBldmVudC53YWl0VW50aWwoc2VsZi5jbGllbnRzLmNsYWltKCkpOyB9KTs=')
        .catch(err => console.log('SW registration failed'));
    }

    // Utility Functions
    function showLoading(text = 'Loading...') {
      const overlay = document.getElementById('loadingOverlay');
      const loadingText = document.getElementById('loadingText');
      loadingText.textContent = text;
      overlay.style.display = 'flex';
    }

    // Simple helper functions
    function getVerifiedBadgeHtml(uid) {
      return '';
    }

    function getOfficialLabelHtml(uid) {
      return '';
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').style.display = 'none';
    }

    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      const notificationText = document.getElementById('notificationText');
      
      notificationText.textContent = message;
      notification.className = `notification ${type}`;
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    function showBrowserNotification(title, body, icon) {
      if (!isPageVisible && 'Notification' in window && Notification.permission === 'granted') {
        new Notification(title, { body, icon });
      }
    }

    function formatTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;
      
      if (diff < 86400000) {
        return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
      } else if (diff < 604800000) {
        return date.toLocaleDateString('en-US', { weekday: 'short' });
      } else {
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      }
    }

    function formatLastSeen(timestamp) {
      if (!timestamp) return 'offline';
      
      const now = Date.now();
      const diff = now - timestamp;
      
      if (diff < 60000) return 'online';
      if (diff < 3600000) return `last seen ${Math.floor(diff / 60000)} mins ago`;
      if (diff < 86400000) return `last seen ${Math.floor(diff / 3600000)} hours ago`;
      return `last seen ${Math.floor(diff / 86400000)} days ago`;
    }

    function playMessageSound() {
      const sendBtn = document.getElementById('sendBtn');
      sendBtn.style.transform = 'scale(0.9)';
      setTimeout(() => {
        sendBtn.style.transform = 'scale(1)';
      }, 150);
    }

    // Offline Queue Management
    function setupOfflineQueue() {
      const savedQueue = localStorage.getItem('huddle_offline_queue');
      if (savedQueue) {
        offlineQueue = JSON.parse(savedQueue);
      }

      window.addEventListener('online', () => {
        if (offlineQueue.length > 0) {
          processOfflineQueue();
        }
      });

      window.addEventListener('offline', () => {
        showNotification('You are offline. Messages will be sent when connection is restored.', 'warning');
      });
    }

    async function processOfflineQueue() {
      showLoading('Sending queued messages...');
      
      for (const message of offlineQueue) {
        try {
          await sendMessageToFirebase(message);
        } catch (error) {
          console.error('Failed to send queued message:', error);
          break;
        }
      }
      
      offlineQueue = [];
      localStorage.removeItem('huddle_offline_queue');
      hideLoading();
      
      if (offlineQueue.length === 0) {
        showNotification('All messages sent successfully!', 'success');
      }
    }

    function queueMessage(messageData) {
      offlineQueue.push(messageData);
      localStorage.setItem('huddle_offline_queue', JSON.stringify(offlineQueue));
      showNotification('Message queued. Will send when online.', 'info');
    }

    // Theme Management
    function toggleTheme() {
      currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', currentTheme);
      
      const toggle = document.getElementById('themeToggle');
      toggle.classList.toggle('active', currentTheme === 'light');
      
      if (currentUser) {
        update(ref(db, `users/${currentUser.uid}/settings`), { theme: currentTheme });
      }
    }

    async function loadUserTheme() {
      if (currentUser) {
        try {
          const settingsRef = ref(db, `users/${currentUser.uid}/settings`);
          const snapshot = await get(settingsRef);
          if (snapshot.exists() && snapshot.val().theme) {
            currentTheme = snapshot.val().theme;
            document.documentElement.setAttribute('data-theme', currentTheme);
            const toggle = document.getElementById('themeToggle');
            toggle.classList.toggle('active', currentTheme === 'light');
          }
        } catch (error) {
          console.error('Error loading theme:', error);
        }
      }
    }

    // Auth State Management with better error handling
    function setupAuthStateListener() {
      if (auth && auth.onAuthStateChanged) {
        auth.onAuthStateChanged(async (user) => {
          try {
            if (user) {
              currentUser = user;
              showLoading('Setting up your account...');
              
              // Setup user data step by step (only if Firebase is connected)
              if (firebaseInitialized) {
                await setupUserPresence(user.uid);
                await loadUserProfile(user.uid);
                await loadUserTheme();
                await startUserSync();
                loadChats();
                setupOfflineQueue();
              } else {
                // Offline mode setup
                setupOfflineDemo();
              }
              
              // Show app interface
              document.getElementById('loginContainer').style.display = 'none';
              document.getElementById('appContainer').classList.add('active');
              
              hideLoading();
              showNotification('Welcome to Huddle! üéâ', 'success');
            } else {
              currentUser = null;
              document.getElementById('loginContainer').style.display = 'flex';
              document.getElementById('appContainer').classList.remove('active');
              hideLoading();
            }
          } catch (error) {
            console.error('Auth state change error:', error);
            showNotification('Authentication error. Please try signing in again.', 'error');
            hideLoading();
          }
        });
      } else {
        // Fallback for offline mode
        setTimeout(() => {
          if (!firebaseInitialized) {
            enableOfflineMode();
            setupAuthStateListener();
          }
        }, 3000);
      }
    }

    // Setup offline demo
    function setupOfflineDemo() {
      console.log('Setting up offline demo...');
      
      // Create demo chats
      const demoChats = [
        {
          id: 'demo-chat-1',
          name: 'Demo Friend 1',
          lastMessage: 'Hey! This is a demo message.',
          time: 'now',
          avatar: '',
          online: true
        },
        {
          id: 'demo-chat-2', 
          name: 'Demo Friend 2',
          lastMessage: 'How are you doing?',
          time: '5m ago',
          avatar: '',
          online: false
        }
      ];
      
      // Populate chat list
      const chatList = document.getElementById('chatList');
      chatList.innerHTML = '';
      
      demoChats.forEach(chat => {
        const chatItem = document.createElement('div');
        chatItem.className = 'chat-item';
        chatItem.innerHTML = `
          <div class="chat-avatar-container">
            <div class="chat-avatar" style="background: linear-gradient(135deg, #00a884 0%, #128c7e 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 18px;">
              ${chat.name.charAt(0)}
            </div>
            ${chat.online ? '<div class="online-indicator"></div>' : ''}
          </div>
          <div class="chat-info">
            <div class="chat-name">${chat.name}</div>
            <div class="chat-preview">${chat.lastMessage}</div>
          </div>
          <div class="chat-meta">
            <div class="chat-time">${chat.time}</div>
          </div>
        `;
        
        chatItem.addEventListener('click', () => {
          openDemoChat(chat);
        });
        
        chatList.appendChild(chatItem);
      });
    }

    // Open demo chat
    function openDemoChat(chat) {
      document.getElementById('emptyChat').style.display = 'none';
      document.getElementById('activeChatContainer').style.display = 'flex';
      document.getElementById('floatingAddBtn').style.display = 'none';
      
      document.getElementById('activeChatName').textContent = chat.name;
      document.getElementById('activeChatStatus').textContent = chat.online ? 'online' : 'offline';
      
      // Add demo messages
      const container = document.getElementById('messagesContainer');
      container.innerHTML = `
        <div class="message received">
          <div class="message-text">Hey! This is a demo message in offline mode.</div>
          <div class="message-time">2:30 PM</div>
        </div>
        <div class="message sent">
          <div class="message-text">This is how your messages will look!</div>
          <div class="message-time">2:31 PM ‚úì‚úì</div>
        </div>
        <div class="message system">
          This is demo mode. Connect to internet for full functionality.
        </div>
        <div class="typing-indicator" id="typingIndicator">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
        <div class="scroll-to-bottom" id="scrollToBottom">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
          </svg>
        </div>
      `;
      
      if (window.innerWidth <= 768) {
        document.getElementById('sidebar').classList.add('hidden');
        document.getElementById('mainChat').classList.add('active');
      }
    }

    // Wait for Firebase initialization then setup auth
    setTimeout(() => {
      setupAuthStateListener();
    }, 1000);

    // Authentication with better error handling
    document.getElementById('googleSignInBtn').addEventListener('click', async () => {
      try {
        showLoading('Signing you in...');
        
        // Check if Firebase is initialized
        if (!firebaseInitialized || !auth || !provider) {
          console.log('Firebase not ready, using offline mode...');
          
          // Simulate sign in for offline mode
          setTimeout(() => {
            const mockUser = {
              uid: 'offline-user-' + Date.now(),
              email: 'demo@huddle.com',
              displayName: 'Demo User',
              photoURL: ''
            };
            
            // Trigger auth state change manually
            currentUser = mockUser;
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('appContainer').classList.add('active');
            
            // Setup offline demo
            setupOfflineDemo();
            
            hideLoading();
            showNotification('Welcome to Huddle Demo! üéâ', 'success');
          }, 1500);
          
          return;
        }
        
        // Configure provider for better compatibility
        provider.setCustomParameters({
          prompt: 'select_account'
        });
        
        const result = await signInWithPopup(auth, provider);
        console.log('Sign in successful:', result.user.email);
        
      } catch (error) {
        console.error('Sign in error:', error);
        hideLoading();
        
        if (error.code === 'auth/popup-closed-by-user') {
          showNotification('Sign in cancelled. Please try again.', 'warning');
        } else if (error.code === 'auth/popup-blocked') {
          showNotification('Popup blocked. Please allow popups and try again.', 'error');
        } else if (error.message === 'Offline mode') {
          // Fallback to offline mode
          showNotification('Using offline demo mode.', 'info');
          setTimeout(() => {
            const mockUser = {
              uid: 'offline-user-' + Date.now(),
              email: 'demo@huddle.com',
              displayName: 'Demo User',
              photoURL: ''
            };
            
            currentUser = mockUser;
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('appContainer').classList.add('active');
            setupOfflineDemo();
            hideLoading();
          }, 1000);
        } else {
          showNotification('Sign in failed. Trying offline mode...', 'warning');
          
          // Fallback to offline mode after error
          setTimeout(() => {
            const mockUser = {
              uid: 'offline-user-' + Date.now(),
              email: 'demo@huddle.com',
              displayName: 'Demo User',
              photoURL: ''
            };
            
            currentUser = mockUser;
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('appContainer').classList.add('active');
            setupOfflineDemo();
            hideLoading();
            showNotification('Running in demo mode! üé≠', 'info');
          }, 2000);
        }
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try {
        showLoading('Signing out...');
        await signOut(auth);
        hideLoading();
      } catch (error) {
        console.error('Logout error:', error);
        showNotification('Logout failed. Please try again.', 'error');
        hideLoading();
      }
    });

    // User Presence and Profile
    async function setupUserPresence(uid) {
      try {
        const userStatusRef = ref(db, `users/${uid}/status`);
        const userInfoRef = ref(db, `users/${uid}/info`);
        
        await set(userStatusRef, 'online');
        await set(userInfoRef, {
          email: currentUser.email,
          displayName: currentUser.displayName,
          photoURL: currentUser.photoURL,
          lastSeen: Date.now()
        });
        
        onDisconnect(userStatusRef).set('offline');
        onDisconnect(userInfoRef).update({ lastSeen: Date.now() });
      } catch (error) {
        console.error('Error setting up presence:', error);
      }
    }



    async function loadUserProfile(uid) {
      try {
        const userRef = ref(db, `users/${uid}/info`);
        const snapshot = await get(userRef);
        if (snapshot.exists()) {
          const data = snapshot.val();
          if (data.photoURL) {
            document.getElementById('currentUserPic').src = data.photoURL;
          }
          if (data.displayName) {
            document.getElementById('currentUserName').textContent = data.displayName;
          }
        }
      } catch (error) {
        console.error('Error loading profile:', error);
      }
    }

    async function startUserSync() {
      const usersRef = ref(db, 'users');
      onValue(usersRef, (snapshot) => {
        if (snapshot.exists()) {
          allUsers = snapshot.val();
          updateChatListWithUserData();
          if (activeChat) {
            updateActiveChatUserData();
          }
        }
      });
    }

    function updateChatListWithUserData() {
      document.querySelectorAll('.chat-item').forEach(chatItem => {
        const friendUid = chatItem.dataset.friendUid;
        if (friendUid && allUsers[friendUid]) {
          const userData = allUsers[friendUid];
          updateChatItemDisplay(chatItem, userData);
        }
      });
    }

    function updateActiveChatUserData() {
      if (activeChat && allUsers[activeChat.friendUid]) {
        const userData = allUsers[activeChat.friendUid];
        const displayName = userData.info?.displayName || userData.info?.email || 'Friend';
        
        document.getElementById('activeChatName').textContent = displayName;
        document.getElementById('activeChatPic').src = userData.info?.photoURL || '';
      }
    }

    function updateChatItemDisplay(chatItem, userData) {
      const nameEl = chatItem.querySelector('.chat-name');
      const avatarEl = chatItem.querySelector('.chat-avatar');
      const lastSeenEl = chatItem.querySelector('.last-seen');
      
      if (nameEl && userData.info) {
        const displayName = userData.info.displayName || userData.info.email || 'Friend';
        nameEl.textContent = displayName;
      }
      
      if (avatarEl && userData.info?.photoURL) {
        avatarEl.src = userData.info.photoURL;
      }
      
      if (lastSeenEl) {
        lastSeenEl.textContent = formatLastSeen(userData.info?.lastSeen);
      }
    }

    // Modal Management
    function openModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    // Add Friend Modal
    document.getElementById('addFriendBtn').addEventListener('click', () => {
      openModal('addFriendModal');
      document.getElementById('friendEmailInput').value = '';
    });

    document.getElementById('cancelAddFriendBtn').addEventListener('click', () => {
      closeModal('addFriendModal');
    });

    document.getElementById('confirmAddFriendBtn').addEventListener('click', async () => {
      const email = document.getElementById('friendEmailInput').value.trim();
      if (!email) return;
      
      const btn = document.getElementById('confirmAddFriendBtn');
      const spinner = btn.querySelector('.loading-spinner');
      
      try {
        btn.disabled = true;
        spinner.style.display = 'inline-block';
        
        const usersRef = ref(db, 'users');
        const snapshot = await get(usersRef);
        
        let friendUid = null;
        snapshot.forEach((child) => {
          if (child.val().info && child.val().info.email === email) {
            friendUid = child.key;
          }
        });
        
        if (friendUid && friendUid !== currentUser.uid) {
          const chatId = [currentUser.uid, friendUid].sort().join('_');
          await set(ref(db, `chats/${chatId}/participants/${currentUser.uid}`), true);
          await set(ref(db, `chats/${chatId}/participants/${friendUid}`), true);
          await set(ref(db, `chats/${chatId}/createdAt`), Date.now());
          
          // Add encryption notice
          const messagesRef = ref(db, `chats/${chatId}/messages`);
          await push(messagesRef, {
            text: "Messages and calls are end-to-end encrypted. Only people in this chat can read, listen to, or share them.",
            type: "system",
            senderId: "system",
            timestamp: Date.now()
          });
          
          closeModal('addFriendModal');
          showNotification('Friend added successfully! üéâ', 'success');
          loadChats();
        } else if (friendUid === currentUser.uid) {
          showNotification('You cannot add yourself as a friend! üòÖ', 'error');
        } else {
          showNotification('User not found. Please check the email address.', 'error');
        }
      } catch (error) {
        console.error('Add friend error:', error);
        showNotification('Failed to add friend. Please try again.', 'error');
      } finally {
        btn.disabled = false;
        spinner.style.display = 'none';
      }
    });

    // Profile Modal
    document.getElementById('profileBtn').addEventListener('click', () => {
      openModal('profileModal');
      document.getElementById('profilePreview').src = currentUser.photoURL || '';
      document.getElementById('displayNameInput').value = currentUser.displayName || '';
    });

    document.getElementById('cancelProfileBtn').addEventListener('click', () => {
      closeModal('profileModal');
    });

    document.getElementById('uploadProfileBtn').addEventListener('click', () => {
      document.getElementById('profileFileInput').click();
    });

    document.getElementById('profileFileInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          document.getElementById('profilePreview').src = event.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    document.getElementById('saveProfileBtn').addEventListener('click', async () => {
      const displayName = document.getElementById('displayNameInput').value.trim();
      const photoURL = document.getElementById('profilePreview').src;
      
      if (!displayName) {
        showNotification('Please enter a display name.', 'error');
        return;
      }
      
      const btn = document.getElementById('saveProfileBtn');
      const spinner = btn.querySelector('.loading-spinner');
      
      try {
        btn.disabled = true;
        spinner.style.display = 'inline-block';
        
        await update(ref(db, `users/${currentUser.uid}/info`), {
          displayName,
          photoURL
        });
        
        document.getElementById('currentUserName').textContent = displayName;
        document.getElementById('currentUserPic').src = photoURL;
        
        closeModal('profileModal');
        showNotification('Profile updated successfully! ‚ú®', 'success');
      } catch (error) {
        console.error('Profile update error:', error);
        showNotification('Failed to update profile. Please try again.', 'error');
      } finally {
        btn.disabled = false;
        spinner.style.display = 'none';
      }
    });

    // Settings Modal
    document.getElementById('settingsBtn').addEventListener('click', async () => {
      openModal('settingsModal');
      const statusInput = document.getElementById('statusInput');
      
      if (currentUser) {
        try {
          const snapshot = await get(ref(db, `users/${currentUser.uid}/info/statusMessage`));
          if (snapshot.exists()) {
            statusInput.value = snapshot.val();
          }
        } catch (error) {
          console.error('Error loading status:', error);
        }
      }
    });

    document.getElementById('cancelSettingsBtn').addEventListener('click', () => {
      closeModal('settingsModal');
    });

    document.getElementById('saveSettingsBtn').addEventListener('click', async () => {
      const statusMessage = document.getElementById('statusInput').value.trim();
      
      const btn = document.getElementById('saveSettingsBtn');
      const spinner = btn.querySelector('.loading-spinner');
      
      try {
        btn.disabled = true;
        spinner.style.display = 'inline-block';
        
        if (currentUser && statusMessage) {
          await update(ref(db, `users/${currentUser.uid}/info`), { statusMessage });
        }
        
        closeModal('settingsModal');
        showNotification('Settings saved successfully! ‚ú®', 'success');
      } catch (error) {
        console.error('Settings save error:', error);
        showNotification('Failed to save settings. Please try again.', 'error');
      } finally {
        btn.disabled = false;
        spinner.style.display = 'none';
      }
    });

    document.getElementById('themeToggle').addEventListener('click', toggleTheme);

    // Group Chat Modal
    document.getElementById('cancelGroupBtn').addEventListener('click', () => {
      closeModal('groupChatModal');
    });

    document.getElementById('createGroupBtn').addEventListener('click', async () => {
      const groupName = document.getElementById('groupNameInput').value.trim();
      const membersInput = document.getElementById('groupMembersInput').value.trim();
      
      if (!groupName) {
        showNotification('Please enter a group name.', 'error');
        return;
      }
      
      const memberEmails = membersInput.split(',').map(email => email.trim()).filter(email => email);
      
      const btn = document.getElementById('createGroupBtn');
      const spinner = btn.querySelector('.loading-spinner');
      
      try {
        btn.disabled = true;
        spinner.style.display = 'inline-block';
        
        const usersRef = ref(db, 'users');
        const usersSnapshot = await get(usersRef);
        const memberUids = [currentUser.uid];
        
        usersSnapshot.forEach(child => {
          const userData = child.val();
          if (userData.info && memberEmails.includes(userData.info.email)) {
            memberUids.push(child.key);
          }
        });
        
        if (memberUids.length < 2) {
          showNotification('At least one valid member email is required.', 'error');
          return;
        }
        
        const groupId = `group_${Date.now()}`;
        const groupData = {
          type: 'group',
          name: groupName,
          createdBy: currentUser.uid,
          createdAt: Date.now(),
          participants: {},
          admins: {
            [currentUser.uid]: true
          }
        };
        
        memberUids.forEach(uid => {
          groupData.participants[uid] = true;
        });
        
        await set(ref(db, `chats/${groupId}`), groupData);
        
        const messagesRef = ref(db, `chats/${groupId}/messages`);
        await push(messagesRef, {
          text: `${currentUser.displayName || currentUser.email} created the group "${groupName}"`,
          type: 'system',
          senderId: 'system',
          timestamp: Date.now()
        });
        
        closeModal('groupChatModal');
        document.getElementById('groupNameInput').value = '';
        document.getElementById('groupMembersInput').value = '';
        
        showNotification(`Group "${groupName}" created successfully! üéâ`, 'success');
        loadChats();
        
      } catch (error) {
        console.error('Create group error:', error);
        showNotification('Failed to create group. Please try again.', 'error');
      } finally {
        btn.disabled = false;
        spinner.style.display = 'none';
      }
    });

    // Chat Management
    function loadChats() {
      const chatsRef = ref(db, 'chats');
      onValue(chatsRef, async (snapshot) => {
        try {
          const chatList = document.getElementById('chatList');
          chatList.innerHTML = '';
          
          const chats = [];
          snapshot.forEach((child) => {
            const chat = child.val();
            if (chat.participants && chat.participants[currentUser.uid]) {
              chats.push({ id: child.key, ...chat });
            }
          });
          
          // Sort chats by activity
          chats.sort((a, b) => {
            return (b.lastActivity || b.createdAt || 0) - (a.lastActivity || a.createdAt || 0);
          });

          for (const chat of chats) {
            if (chat.type === 'group') {
              await createGroupChatItem(chat);
            } else {
              await createPrivateChatItem(chat);
            }
          }
        } catch (error) {
          console.error('Error loading chats:', error);
          showNotification('Failed to load chats. Please refresh the page.', 'error');
        }
      });
    }

    async function createPrivateChatItem(chat) {
      const friendUid = Object.keys(chat.participants).find(uid => uid !== currentUser.uid);
      if (!friendUid) return;
      
      let friendData = allUsers[friendUid]?.info || {};
      let status = allUsers[friendUid]?.status || 'offline';
      
      if (!allUsers[friendUid]) {
        try {
          const [friendSnap, statusSnap] = await Promise.all([
            get(ref(db, `users/${friendUid}/info`)),
            get(ref(db, `users/${friendUid}/status`))
          ]);
          
          friendData = friendSnap.val() || {};
          status = statusSnap.val() || 'offline';
        } catch (error) {
          console.error('Error fetching user data:', error);
          return;
        }
      }
      
      let lastMessage = '';
      let lastTime = '';
      let unreadCount = 0;
      
      if (chat.lastMessage) {
        if (chat.lastMessage.type === 'system') {
          lastMessage = 'üîí Encryption notice';
        } else {
          lastMessage = chat.lastMessage.type === 'image' ? 'üì∑ Image' : chat.lastMessage.text;
        }
        lastTime = formatTime(chat.lastMessage.timestamp);
      }
      
      try {
        const messagesSnap = await get(ref(db, `chats/${chat.id}/messages`));
        if (messagesSnap.exists()) {
          const messages = Object.values(messagesSnap.val());
          unreadCount = messages.filter(msg => 
            msg.senderId !== currentUser.uid && 
            msg.type !== 'system' &&
            !msg.readBy?.[currentUser.uid]
          ).length;
        }
      } catch (error) {
        console.error('Error calculating unread count:', error);
      }
      
      const chatItem = document.createElement('div');
      chatItem.className = 'chat-item';
      chatItem.dataset.friendUid = friendUid;
      
      const displayName = friendData.displayName || friendData.email || 'Friend';
      
      chatItem.innerHTML = `
        <div class="chat-avatar-container">
          <img class="chat-avatar" src="${friendData.photoURL || ''}" alt="Avatar" onclick="showProfilePopup(${JSON.stringify(friendData).replace(/"/g, '&quot;')})">
          ${status === 'online' ? '<div class="online-indicator"></div>' : ''}
          ${unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : ''}
        </div>
        <div class="chat-info">
          <div class="chat-name">${displayName}</div>
          <div class="chat-preview">${lastMessage}</div>
          <div class="last-seen">${formatLastSeen(friendData.lastSeen)}</div>
        </div>
        <div class="chat-meta">
          <div class="chat-time">${lastTime}</div>
        </div>
      `;
      
      chatItem.addEventListener('click', () => {
        openChat(chat.id, friendUid, friendData, status, chat.type);
      });
      
      document.getElementById('chatList').appendChild(chatItem);
      
      const statusRef = ref(db, `users/${friendUid}/status`);
      onValue(statusRef, (snap) => {
        const newStatus = snap.val() || 'offline';
        const indicator = chatItem.querySelector('.online-indicator');
        if (newStatus === 'online' && !indicator) {
          chatItem.querySelector('.chat-avatar-container').insertAdjacentHTML('beforeend', '<div class="online-indicator"></div>');
        } else if (newStatus === 'offline' && indicator) {
          indicator.remove();
        }
      });
    }

    async function createGroupChatItem(chat) {
      let lastMessage = '';
      let lastTime = '';
      let unreadCount = 0;
      
      if (chat.lastMessage) {
        if (chat.lastMessage.type === 'system') {
          lastMessage = 'üì¢ ' + chat.lastMessage.text;
        } else {
          lastMessage = chat.lastMessage.type === 'image' ? 'üì∑ Image' : chat.lastMessage.text;
        }
        lastTime = formatTime(chat.lastMessage.timestamp);
      }
      
      try {
        const messagesSnap = await get(ref(db, `chats/${chat.id}/messages`));
        if (messagesSnap.exists()) {
          const messages = Object.values(messagesSnap.val());
          unreadCount = messages.filter(msg => 
            msg.senderId !== currentUser.uid && 
            msg.type !== 'system' &&
            !msg.readBy?.[currentUser.uid]
          ).length;
        }
      } catch (error) {
        console.error('Error calculating unread count:', error);
      }
      
      const chatItem = document.createElement('div');
      chatItem.className = 'chat-item';
      chatItem.dataset.chatId = chat.id;
      chatItem.innerHTML = `
        <div class="chat-avatar-container">
          <div class="chat-avatar" style="background: linear-gradient(135deg, #00a884 0%, #128c7e 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 18px;">
            ${chat.name.charAt(0).toUpperCase()}
          </div>
          ${unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : ''}
        </div>
        <div class="chat-info">
          <div class="chat-name">
            ${chat.name}
            <span class="group-indicator">GROUP</span>
          </div>
          <div class="chat-preview">${lastMessage}</div>
        </div>
        <div class="chat-meta">
          <div class="chat-time">${lastTime}</div>
        </div>
      `;
      
      chatItem.addEventListener('click', () => {
        openChat(chat.id, null, { displayName: chat.name }, 'online', 'group');
      });
      
      document.getElementById('chatList').appendChild(chatItem);
    }

    function openChat(chatId, friendUid, friendData, status, chatType = 'private') {
      activeChat = { chatId, friendUid, chatType };
      
      document.getElementById('emptyChat').style.display = 'none';
      document.getElementById('activeChatContainer').style.display = 'flex';
      
      // Hide floating add button when chat is opened
      document.getElementById('floatingAddBtn').style.display = 'none';
      
      const displayName = friendData.displayName || friendData.email || 'Friend';
      
      document.getElementById('activeChatName').textContent = displayName;
      document.getElementById('activeChatPic').src = friendData.photoURL || '';
      
      if (chatType === 'group') {
        document.getElementById('activeChatStatus').textContent = 'Group chat';
        document.getElementById('activeChatStatus').className = 'chat-header-status';
      } else {
        document.getElementById('activeChatStatus').textContent = status === 'online' ? 'online' : 'offline';
        document.getElementById('activeChatStatus').className = `chat-header-status ${status}`;
      }
      
      if (window.innerWidth <= 768) {
        document.getElementById('sidebar').classList.add('hidden');
        document.getElementById('mainChat').classList.add('active');
      }
      
      document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
      event?.currentTarget?.classList.add('active');
      
      loadMessages(chatId);
      
      if (chatType === 'private' && friendUid) {
        listenForTyping(chatId, friendUid);
        
        const statusRef = ref(db, `users/${friendUid}/status`);
        onValue(statusRef, (snap) => {
          const newStatus = snap.val() || 'offline';
          document.getElementById('activeChatStatus').textContent = newStatus === 'online' ? 'online' : 'offline';
          document.getElementById('activeChatStatus').className = `chat-header-status ${newStatus}`;
        });
      }
    }

    function loadMessages(chatId) {
      const messagesRef = ref(db, `chats/${chatId}/messages`);
      onValue(messagesRef, (snapshot) => {
        const container = document.getElementById('messagesContainer');
        const typingIndicator = document.getElementById('typingIndicator');
        const scrollBtn = document.getElementById('scrollToBottom');
        
        container.innerHTML = '';
        container.appendChild(typingIndicator);
        container.appendChild(scrollBtn);
        
        if (snapshot.exists()) {
          const messages = [];
          snapshot.forEach((child) => {
            const msgData = { id: child.key, ...child.val() };
            
            if (msgData.deleted && msgData.deletedFor === 'everyone') return;
            if (msgData[`deletedFor_${currentUser.uid}`]) return;
            
            messages.push(msgData);
          });
          
          messages.sort((a, b) => a.timestamp - b.timestamp);
          
          messages.forEach((msg) => {
            if (msg.type === 'system') {
              const systemDiv = document.createElement('div');
              systemDiv.className = 'message system';
              systemDiv.textContent = msg.text;
              container.insertBefore(systemDiv, typingIndicator);
              return;
            }
            
            if (msg.type === 'deleted') {
              const messageDiv = document.createElement('div');
              messageDiv.className = `message ${msg.originalSenderId === currentUser.uid ? 'sent' : 'received'}`;
              messageDiv.innerHTML = `
                <div class="message-text" style="font-style: italic; opacity: 0.7;">This message was deleted</div>
                <div class="message-time">${formatTime(msg.deletedAt || msg.timestamp)}</div>
              `;
              container.insertBefore(messageDiv, typingIndicator);
              return;
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${msg.senderId === currentUser.uid ? 'sent' : 'received'}`;
            messageDiv.dataset.messageId = msg.id;
            
            messageDiv.addEventListener('contextmenu', (e) => {
              e.preventDefault();
              showMessageMenu(e, messageDiv, msg);
            });
            
            let pressTimer;
            messageDiv.addEventListener('touchstart', (e) => {
              pressTimer = setTimeout(() => {
                showMessageMenu(e.touches[0], messageDiv, msg);
              }, 500);
            });
            messageDiv.addEventListener('touchend', () => {
              clearTimeout(pressTimer);
            });
            
            let messageContent = '';
            
            if (msg.type === 'image') {
              messageContent = `
                <img class="message-image" src="${msg.imageData}" alt="Image" onclick="openImagePreview('${msg.imageData}')">
              `;
            } else {
              const editedText = msg.edited ? ' <em>(edited)</em>' : '';
              messageContent = `
                <div class="message-text">${msg.text}${editedText}</div>
              `;
            }
            
            let reactionsHtml = '';
            if (msg.reactions) {
              const reactionCounts = {};
              Object.values(msg.reactions).forEach(emoji => {
                reactionCounts[emoji] = (reactionCounts[emoji] || 0) + 1;
              });
              
              reactionsHtml = '<div class="message-reactions">';
              Object.entries(reactionCounts).forEach(([emoji, count]) => {
                const isActive = msg.reactions[currentUser.uid] === emoji ? 'active' : '';
                reactionsHtml += `<span class="reaction ${isActive}" onclick="toggleReaction('${msg.id}', '${emoji}')">${emoji} ${count}</span>`;
              });
              reactionsHtml += '</div>';
            }
            
            let statusIcon = '';
            if (msg.senderId === currentUser.uid) {
              if (msg.status === 'sending') {
                statusIcon = '<span class="message-status status-sending">‚è≥</span>';
              } else if (msg.status === 'failed') {
                statusIcon = '<span class="message-status status-failed" onclick="retryMessage(\'' + msg.id + '\')">‚ö†Ô∏è</span>';
              } else if (msg.readBy && Object.keys(msg.readBy).length > 1) {
                statusIcon = '<span class="message-status status-read">‚úì‚úì</span>';
              } else {
                statusIcon = '<span class="message-status status-delivered">‚úì‚úì</span>';
              }
            }

            messageDiv.innerHTML = `
              ${messageContent}
              ${reactionsHtml}
              <div class="message-time">
                ${formatTime(msg.timestamp)}
                ${statusIcon}
              </div>
            `;
            
            container.insertBefore(messageDiv, typingIndicator);
            
            if (msg.senderId !== currentUser.uid && !isPageVisible) {
              const senderName = allUsers[msg.senderId]?.info?.displayName || 'Friend';
              showBrowserNotification(`New message from ${senderName}`, msg.text || 'üì∑ Image', '');
            }
          });
          
          container.scrollTop = container.scrollHeight;
          container.addEventListener('scroll', updateScrollButton);
        }
      });
    }

    // Message Functions
    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      if (!text) return;
      
      const messageData = {
        text,
        type: 'text',
        senderId: currentUser?.uid || 'demo-user',
        timestamp: Date.now(),
        status: 'sent'
      };
      
      input.value = '';
      playMessageSound();
      
      // Check if we're in demo/offline mode
      if (!firebaseInitialized || !activeChat || activeChat.id?.startsWith('demo-')) {
        // Demo mode - add message to UI directly
        addDemoMessage(messageData);
        
        // Simulate typing response after delay
        setTimeout(() => {
          const responses = [
            "That's interesting! ü§î",
            "I agree with you! üëç",
            "Tell me more about that.",
            "Sounds great! üòä",
            "I see what you mean.",
            "That's a good point! üí°",
            "Thanks for sharing! üôè",
            "Absolutely! ‚ú®"
          ];
          
          const randomResponse = responses[Math.floor(Math.random() * responses.length)];
          
          addDemoMessage({
            text: randomResponse,
            type: 'text',
            senderId: 'demo-friend',
            timestamp: Date.now(),
            status: 'sent'
          });
        }, 1000 + Math.random() * 2000);
        
        return;
      }
      
      // Real Firebase mode
      try {
        if (navigator.onLine && activeChat) {
          await sendMessageToFirebase(messageData);
          if (activeChat.chatType === 'private') {
            await set(ref(db, `chats/${activeChat.chatId}/typing/${currentUser.uid}`), false);
          }
        } else {
          messageData.chatId = activeChat.chatId;
          queueMessage(messageData);
        }
      } catch (error) {
        console.error('Send message error:', error);
        showNotification('Failed to send message. Please try again.', 'error');
        messageData.chatId = activeChat.chatId;
        queueMessage(messageData);
      }
    }

    // Add demo message to UI
    function addDemoMessage(messageData) {
      const container = document.getElementById('messagesContainer');
      const typingIndicator = document.getElementById('typingIndicator');
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${messageData.senderId === currentUser?.uid || messageData.senderId === 'demo-user' ? 'sent' : 'received'}`;
      
      messageDiv.innerHTML = `
        <div class="message-text">${messageData.text}</div>
        <div class="message-time">
          ${formatTime(messageData.timestamp)}
          ${messageData.senderId === currentUser?.uid || messageData.senderId === 'demo-user' ? '<span class="message-status status-delivered">‚úì‚úì</span>' : ''}
        </div>
      `;
      
      container.insertBefore(messageDiv, typingIndicator);
      container.scrollTop = container.scrollHeight;
      
      // Add animation
      messageDiv.style.opacity = '0';
      messageDiv.style.transform = 'translateY(20px)';
      
      setTimeout(() => {
        messageDiv.style.transition = 'all 0.3s ease';
        messageDiv.style.opacity = '1';
        messageDiv.style.transform = 'translateY(0)';
      }, 50);
    }

    async function sendMessageToFirebase(messageData) {
      const chatId = messageData.chatId || activeChat.chatId;
      const messagesRef = ref(db, `chats/${chatId}/messages`);
      
      const { chatId: _, ...cleanMessageData } = messageData;
      
      const messageRef = await push(messagesRef, cleanMessageData);
      
      await update(ref(db, `chats/${chatId}`), {
        lastMessage: {
          text: cleanMessageData.text,
          timestamp: cleanMessageData.timestamp,
          senderId: cleanMessageData.senderId,
          type: cleanMessageData.type
        },
        lastActivity: cleanMessageData.timestamp
      });
      
      return messageRef;
    }

    // Event Listeners
    document.getElementById('sendBtn').addEventListener('click', sendMessage);
    
    document.getElementById('chatInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    document.getElementById('chatInput').addEventListener('input', () => {
      if (!activeChat || activeChat.chatType === 'group') return;
      
      set(ref(db, `chats/${activeChat.chatId}/typing/${currentUser.uid}`), true);
      
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        set(ref(db, `chats/${activeChat.chatId}/typing/${currentUser.uid}`), false);
      }, 2000);
    });

    function listenForTyping(chatId, friendUid) {
      const typingRef = ref(db, `chats/${chatId}/typing/${friendUid}`);
      onValue(typingRef, (snapshot) => {
        const isTyping = snapshot.val();
        const indicator = document.getElementById('typingIndicator');
        const statusEl = document.getElementById('activeChatStatus');
        
        if (isTyping) {
          indicator.classList.add('active');
          statusEl.textContent = 'typing...';
          statusEl.className = 'chat-header-status typing';
          document.getElementById('messagesContainer').scrollTop = document.getElementById('messagesContainer').scrollHeight;
        } else {
          indicator.classList.remove('active');
          const status = allUsers[friendUid]?.status || 'offline';
          statusEl.textContent = status === 'online' ? 'online' : formatLastSeen(allUsers[friendUid]?.info?.lastSeen);
          statusEl.className = `chat-header-status ${status}`;
        }
      });
    }

    // Image Sending
    document.getElementById('imageBtn').addEventListener('click', () => {
      document.getElementById('imageFileInput').click();
    });

    document.getElementById('imageFileInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file && activeChat) {
        const reader = new FileReader();
        reader.onload = async (event) => {
          try {
            const messagesRef = ref(db, `chats/${activeChat.chatId}/messages`);
            await push(messagesRef, {
              type: 'image',
              imageData: event.target.result,
              senderId: currentUser.uid,
              timestamp: Date.now()
            });
            playMessageSound();
          } catch (error) {
            console.error('Send image error:', error);
            showNotification('Failed to send image. Please try again.', 'error');
          }
        };
        reader.readAsDataURL(file);
      }
    });

    // Message Menu Functions
    function showMessageMenu(event, messageElement, messageData) {
      selectedMessage = { element: messageElement, data: messageData };
      
      const menu = document.getElementById('messageMenu');
      menu.style.left = event.pageX + 'px';
      menu.style.top = event.pageY + 'px';
      menu.classList.add('active');
      
      const editBtn = document.getElementById('editMessage');
      editBtn.style.display = messageData.senderId === currentUser.uid ? 'flex' : 'none';
      
      const deleteEveryoneBtn = document.getElementById('deleteForEveryone');
      const isOld = Date.now() - messageData.timestamp > 300000;
      deleteEveryoneBtn.style.display = (messageData.senderId === currentUser.uid && !isOld) ? 'flex' : 'none';
    }

    function hideMessageMenu() {
      document.getElementById('messageMenu').classList.remove('active');
      document.getElementById('reactionPicker').classList.remove('active');
      selectedMessage = null;
    }

    document.getElementById('reactToMessage').addEventListener('click', (e) => {
      const picker = document.getElementById('reactionPicker');
      picker.style.left = e.pageX + 'px';
      picker.style.top = e.pageY + 'px';
      picker.classList.add('active');
    });

    document.getElementById('editMessage').addEventListener('click', () => {
      if (selectedMessage) {
        const newText = prompt('Edit message:', selectedMessage.data.text);
        if (newText && newText.trim()) {
          editMessage(selectedMessage.data.id, newText.trim());
        }
      }
      hideMessageMenu();
    });

    document.getElementById('deleteForMe').addEventListener('click', () => {
      if (selectedMessage) {
        deleteMessage(selectedMessage.data.id, false);
      }
      hideMessageMenu();
    });

    document.getElementById('deleteForEveryone').addEventListener('click', () => {
      if (selectedMessage) {
        deleteMessage(selectedMessage.data.id, true);
      }
      hideMessageMenu();
    });

    document.querySelectorAll('.reaction-emoji').forEach(emoji => {
      emoji.addEventListener('click', () => {
        if (selectedMessage) {
          addReaction(selectedMessage.data.id, emoji.dataset.emoji);
        }
        hideMessageMenu();
      });
    });

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.message-menu') && !e.target.closest('.reaction-picker')) {
        hideMessageMenu();
      }
      if (!e.target.closest('.profile-popup')) {
        closeProfilePopup();
      }
    });

    async function editMessage(messageId, newText) {
      if (!activeChat) return;
      
      try {
        await update(ref(db, `chats/${activeChat.chatId}/messages/${messageId}`), {
          text: newText,
          edited: true,
          editedAt: Date.now()
        });
        showNotification('Message edited successfully! ‚úèÔ∏è', 'success');
      } catch (error) {
        console.error('Edit message error:', error);
        showNotification('Failed to edit message. Please try again.', 'error');
      }
    }

    async function deleteMessage(messageId, forEveryone) {
      if (!activeChat) return;
      
      try {
        const messageRef = ref(db, `chats/${activeChat.chatId}/messages/${messageId}`);
        
        if (forEveryone) {
          await update(messageRef, {
            text: 'This message was deleted',
            type: 'deleted',
            deleted: true,
            deletedFor: 'everyone',
            deletedAt: Date.now(),
            originalSenderId: currentUser.uid
          });
          showNotification('Message deleted for everyone! üóëÔ∏è', 'success');
        } else {
          await update(messageRef, {
            [`deletedFor_${currentUser.uid}`]: true,
            [`deletedAt_${currentUser.uid}`]: Date.now()
          });
          showNotification('Message deleted for you! üóëÔ∏è', 'success');
        }
      } catch (error) {
        console.error('Delete message error:', error);
        showNotification('Failed to delete message. Please try again.', 'error');
      }
    }

    async function addReaction(messageId, emoji) {
      if (!activeChat) return;
      
      try {
        const reactionRef = ref(db, `chats/${activeChat.chatId}/messages/${messageId}/reactions/${currentUser.uid}`);
        await set(reactionRef, emoji);
        showNotification(`Reacted with ${emoji}! üòä`, 'success');
      } catch (error) {
        console.error('Add reaction error:', error);
        showNotification('Failed to add reaction. Please try again.', 'error');
      }
    }

    window.toggleReaction = async function(messageId, emoji) {
      if (!activeChat) return;
      
      try {
        const reactionRef = ref(db, `chats/${activeChat.chatId}/messages/${messageId}/reactions/${currentUser.uid}`);
        const snapshot = await get(reactionRef);
        
        if (snapshot.exists() && snapshot.val() === emoji) {
          await set(reactionRef, null);
          showNotification('Reaction removed! üëç', 'success');
        } else {
          await set(reactionRef, emoji);
          showNotification(`Reacted with ${emoji}! üòä`, 'success');
        }
      } catch (error) {
        console.error('Reaction error:', error);
        showNotification('Failed to update reaction. Please try again.', 'error');
      }
    };

    // Search Functionality
    let searchResults = [];
    let currentSearchFilter = 'all';
    
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase().trim();
      const filters = document.getElementById('searchFilters');
      
      if (query.length > 0) {
        filters.style.display = 'flex';
        performSearch(query);
      } else {
        filters.style.display = 'none';
        showAllChats();
      }
    });
    
    document.querySelectorAll('.filter-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentSearchFilter = tab.dataset.filter;
        
        const query = document.getElementById('searchInput').value.toLowerCase().trim();
        if (query) {
          performSearch(query);
        }
      });
    });
    
    async function performSearch(query) {
      try {
        searchResults = [];
        
        document.querySelectorAll('.chat-item').forEach(item => {
          const name = item.querySelector('.chat-name').textContent.toLowerCase();
          const preview = item.querySelector('.chat-preview').textContent.toLowerCase();
          
          if (name.includes(query) || preview.includes(query)) {
            item.style.display = 'flex';
          } else {
            item.style.display = 'none';
          }
        });
        
        if (activeChat && currentSearchFilter !== 'all') {
          await searchInMessages(query);
        }
      } catch (error) {
        console.error('Search error:', error);
        showNotification('Search failed. Please try again.', 'error');
      }
    }
    
    async function searchInMessages(query) {
      if (!activeChat) return;
      
      try {
        const messagesRef = ref(db, `chats/${activeChat.chatId}/messages`);
        const snapshot = await get(messagesRef);
        
        if (snapshot.exists()) {
          const messages = [];
          snapshot.forEach(child => {
            const msg = { id: child.key, ...child.val() };
            
            let matchesFilter = false;
            switch (currentSearchFilter) {
              case 'media':
                matchesFilter = msg.type === 'image';
                break;
              case 'links':
                matchesFilter = msg.text && (msg.text.includes('http') || msg.text.includes('www.'));
                break;
              case 'docs':
                matchesFilter = msg.text && (msg.text.includes('.pdf') || msg.text.includes('.doc'));
                break;
              default:
                matchesFilter = true;
            }
            
            const textMatch = msg.text && msg.text.toLowerCase().includes(query);
            
            if (matchesFilter && textMatch) {
              messages.push(msg);
            }
          });
          
          searchResults = messages;
          highlightSearchResults();
        }
      } catch (error) {
        console.error('Message search error:', error);
      }
    }
    
    function highlightSearchResults() {
      document.querySelectorAll('.message').forEach(msgEl => {
        msgEl.classList.remove('search-highlight');
        const messageId = msgEl.dataset.messageId;
        if (searchResults.some(result => result.id === messageId)) {
          msgEl.classList.add('search-highlight');
        }
      });
    }
    
    function showAllChats() {
      document.querySelectorAll('.chat-item').forEach(item => {
        item.style.display = 'flex';
      });
      
      document.querySelectorAll('.message').forEach(msgEl => {
        msgEl.classList.remove('search-highlight');
      });
    }

    // Floating Add Button
    document.getElementById('floatingAddBtn').addEventListener('click', () => {
      showAddOptions();
    });
    
    function showAddOptions() {
      const options = `
        <div class="add-options-menu" id="addOptionsMenu" style="position: fixed; bottom: 140px; right: 20px; background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 12px; box-shadow: 0 4px 20px var(--shadow-secondary); z-index: 1000; min-width: 150px; animation: slideUp 0.2s ease-out;">
          <div class="add-option" onclick="document.getElementById('addFriendModal').classList.add('active'); hideAddOptions();" style="padding: 12px 16px; cursor: pointer; color: var(--text-primary); display: flex; align-items: center; gap: 8px; transition: background 0.2s ease;">
            <span>üë§</span> Add Friend
          </div>
          <div class="add-option" onclick="document.getElementById('groupChatModal').classList.add('active'); hideAddOptions();" style="padding: 12px 16px; cursor: pointer; color: var(--text-primary); display: flex; align-items: center; gap: 8px; transition: background 0.2s ease;">
            <span>üë•</span> Create Group
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', options);
      
      document.querySelectorAll('.add-option').forEach(option => {
        option.addEventListener('mouseenter', () => {
          option.style.background = 'var(--bg-tertiary)';
        });
        
        option.addEventListener('mouseleave', () => {
          option.style.background = 'transparent';
        });
      });
      
      setTimeout(() => {
        document.addEventListener('click', hideAddOptions);
      }, 100);
    }
    
    window.hideAddOptions = function() {
      const menu = document.getElementById('addOptionsMenu');
      if (menu) {
        menu.remove();
        document.removeEventListener('click', hideAddOptions);
      }
    };

    // Profile Functions
    window.showProfilePopup = function(userData) {
      const popup = document.getElementById('profilePopup');
      document.getElementById('profilePopupAvatar').src = userData.photoURL || '';
      document.getElementById('profilePopupName').textContent = userData.displayName || userData.email || 'User';
      document.getElementById('profilePopupStatus').textContent = userData.statusMessage || 'Hey there! I\'m using Huddle.';
      popup.classList.add('active');
    };

    window.closeProfilePopup = function() {
      document.getElementById('profilePopup').classList.remove('active');
    };

    window.showUserProfile = function() {
      showProfilePopup({
        photoURL: currentUser.photoURL,
        displayName: currentUser.displayName,
        email: currentUser.email,
        statusMessage: 'Hey there! I\'m using Huddle.'
      });
    };

    window.showChatProfile = function() {
      if (activeChat && activeChat.friendUid && allUsers[activeChat.friendUid]) {
        const userData = allUsers[activeChat.friendUid].info;
        showProfilePopup(userData);
      }
    };

    // Scroll Functions
    function updateScrollButton() {
      const container = document.getElementById('messagesContainer');
      const scrollBtn = document.getElementById('scrollToBottom');
      
      if (container.scrollTop < container.scrollHeight - container.clientHeight - 100) {
        scrollBtn.classList.add('visible');
      } else {
        scrollBtn.classList.remove('visible');
      }
    }

    document.getElementById('scrollToBottom').addEventListener('click', () => {
      const container = document.getElementById('messagesContainer');
      container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
    });

    // Image Preview
    window.openImagePreview = function(imageSrc) {
      document.getElementById('imagePreviewContent').src = imageSrc;
      document.getElementById('imagePreviewModal').classList.add('active');
    };

    document.getElementById('imagePreviewClose').addEventListener('click', () => {
      document.getElementById('imagePreviewModal').classList.remove('active');
    });

    document.getElementById('imagePreviewModal').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) {
        document.getElementById('imagePreviewModal').classList.remove('active');
      }
    });

    // Mobile Back Button
    document.getElementById('backBtn').addEventListener('click', () => {
      document.getElementById('sidebar').classList.remove('hidden');
      document.getElementById('mainChat').classList.remove('active');
      document.getElementById('emptyChat').style.display = 'flex';
      document.getElementById('activeChatContainer').style.display = 'none';
      
      // Show floating add button when returning to sidebar
      document.getElementById('floatingAddBtn').style.display = 'flex';
      
      activeChat = null;
    });

    // Auto-resize textarea
    document.getElementById('chatInput').addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

    // Emoji Picker Functionality
    const emojiCategories = {
      smileys: ['üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'üòÇ', 'ü§£', 'üòä', 'üòá', 'üôÇ', 'üôÉ', 'üòâ', 'üòå', 'üòç', 'ü•∞', 'üòò', 'üòó', 'üòô', 'üòö', 'üòã', 'üòõ', 'üòù', 'üòú', 'ü§™', 'ü§®', 'üßê', 'ü§ì', 'üòé', 'ü§©', 'ü•≥', 'üòè', 'üòí', 'üòû', 'üòî', 'üòü', 'üòï', 'üôÅ', '‚òπÔ∏è', 'üò£', 'üòñ', 'üò´', 'üò©', 'ü•∫', 'üò¢', 'üò≠', 'üò§', 'üò†', 'üò°', 'ü§¨', 'ü§Ø', 'üò≥', 'ü•µ', 'ü•∂', 'üò±', 'üò®', 'üò∞', 'üò•', 'üòì', 'ü§ó', 'ü§î', 'ü§≠', 'ü§´', 'ü§•', 'üò∂', 'üòê', 'üòë', 'üò¨', 'üôÑ', 'üòØ', 'üò¶', 'üòß', 'üòÆ', 'üò≤', 'ü•±', 'üò¥', 'ü§§', 'üò™', 'üòµ', 'ü§ê', 'ü•¥', 'ü§¢', 'ü§Æ', 'ü§ß', 'üò∑', 'ü§í', 'ü§ï'],
      people: ['üëã', 'ü§ö', 'üñêÔ∏è', '‚úã', 'üññ', 'üëå', 'ü§å', 'ü§è', '‚úåÔ∏è', 'ü§û', 'ü§ü', 'ü§ò', 'ü§ô', 'üëà', 'üëâ', 'üëÜ', 'üñï', 'üëá', '‚òùÔ∏è', 'üëç', 'üëé', 'üëä', '‚úä', 'ü§õ', 'ü§ú', 'üëè', 'üôå', 'üëê', 'ü§≤', 'ü§ù', 'üôè', '‚úçÔ∏è', 'üíÖ', 'ü§≥', 'üí™', 'ü¶æ', 'ü¶ø', 'ü¶µ', 'ü¶∂', 'üëÇ', 'ü¶ª', 'üëÉ', 'üß†', 'ü´Ä', 'ü´Å', 'ü¶∑', 'ü¶¥', 'üëÄ', 'üëÅÔ∏è', 'üëÖ', 'üëÑ', 'üíã', 'ü©∏'],
      nature: ['üå∏', 'üíÆ', 'üèµÔ∏è', 'üåπ', 'ü•Ä', 'üå∫', 'üåª', 'üåº', 'üå∑', 'üå±', 'ü™¥', 'üå≤', 'üå≥', 'üå¥', 'üåµ', 'üå∂Ô∏è', 'üçÑ', 'üåæ', 'üíê', 'üåø', 'üçÄ', 'üçÉ', 'üçÇ', 'üçÅ', 'üåä', 'üåÄ', 'üåà', 'üåÇ', '‚òÇÔ∏è', '‚òî', '‚õ±Ô∏è', '‚ö°', '‚ùÑÔ∏è', '‚òÉÔ∏è', '‚õÑ', '‚òÑÔ∏è', 'üî•', 'üíß', 'üåü', '‚≠ê', 'üå†', '‚òÄÔ∏è', 'üåù', 'üåõ', 'üåú', 'üåö', 'üåï', 'üåñ', 'üåó', 'üåò', 'üåë', 'üåí', 'üåì', 'üåî', 'üåô', 'üåé', 'üåç', 'üåè', 'ü™ê', 'üí´', '‚≠ê', 'üåü', '‚ú®', '‚ö°', '‚òÑÔ∏è', 'üí•', 'üî•', 'üå™Ô∏è', 'üåà', '‚òÄÔ∏è', 'üå§Ô∏è', '‚õÖ', 'üå¶Ô∏è', 'üåßÔ∏è', '‚õàÔ∏è', 'üå©Ô∏è', 'üå®Ô∏è', '‚ùÑÔ∏è', '‚òÉÔ∏è', '‚õÑ', 'üå¨Ô∏è', 'üí®', 'üíß', 'üí¶', '‚òî', '‚òÇÔ∏è', 'üåä', 'üå´Ô∏è'],
      food: ['üçï', 'üçî', 'üçü', 'üå≠', 'ü•™', 'üåÆ', 'üåØ', 'ü•ô', 'üßÜ', 'ü•ö', 'üç≥', 'ü•ò', 'üç≤', 'ü•£', 'ü•ó', 'üçø', 'üßà', 'üßÇ', 'ü•®', 'ü•ñ', 'üçû', 'ü•ê', 'ü•Ø', 'üßá', 'ü•û', 'üçØ', 'ü•ú', 'üå∞', 'ü••', 'ü•ë', 'üçÜ', 'ü•î', 'ü•ï', 'üåΩ', 'üå∂Ô∏è', 'ü•í', 'ü•¨', 'ü•¶', 'üßÑ', 'üßÖ', 'üçÑ', 'ü•≠', 'üçé', 'üçè', 'üçê', 'üçä', 'üçã', 'üçå', 'üçâ', 'üçá', 'üçì', 'ü´ê', 'üçà', 'üçí', 'üçë', 'ü•ù', 'üçÖ', 'ü´í', 'ü••', 'ü•®', 'üç∫', 'üçª', 'ü•Ç', 'üç∑', 'ü•É', 'üç∏', 'üçπ', 'üßâ', '‚òï', 'üçµ', 'üßÉ', 'ü•§', 'üßã', 'üçº', 'ü•õ', 'üçØ', 'üçÆ', 'üç≠', 'üç¨', 'üç´', 'üç∞', 'üßÅ', 'ü•ß', 'üç¶', 'üç®', 'üçß', 'üç°', 'ü•Æ', 'üç¢', 'üç±', 'üçò', 'üçô', 'üçö', 'üçõ', 'üçú', 'üçù', 'üç†', 'üç§', 'üç£', 'ü¶™', 'üç•', 'ü•†', 'ü•ü', 'üç©', 'üç™'],
      activities: ['‚öΩ', 'üèÄ', 'üèà', '‚öæ', 'ü•é', 'üéæ', 'üèê', 'üèâ', 'ü•è', 'üé±', 'ü™Ä', 'üèì', 'üè∏', 'üèí', 'üèë', 'ü•ç', 'üèè', 'ü™É', 'ü•Ö', '‚õ≥', 'ü™Å', 'üèπ', 'üé£', 'ü§ø', 'ü•ä', 'ü•ã', 'üéΩ', 'üõπ', 'üõ∑', '‚õ∏Ô∏è', 'ü•å', 'üéø', '‚õ∑Ô∏è', 'üèÇ', 'ü™Ç', 'üèãÔ∏è‚Äç‚ôÄÔ∏è', 'üèãÔ∏è', 'üèãÔ∏è‚Äç‚ôÇÔ∏è', 'ü§º‚Äç‚ôÄÔ∏è', 'ü§º', 'ü§º‚Äç‚ôÇÔ∏è', 'ü§∏‚Äç‚ôÄÔ∏è', 'ü§∏', 'ü§∏‚Äç‚ôÇÔ∏è', '‚õπÔ∏è‚Äç‚ôÄÔ∏è', '‚õπÔ∏è', '‚õπÔ∏è‚Äç‚ôÇÔ∏è', 'ü§∫', 'ü§æ‚Äç‚ôÄÔ∏è', 'ü§æ', 'ü§æ‚Äç‚ôÇÔ∏è', 'üèåÔ∏è‚Äç‚ôÄÔ∏è', 'üèåÔ∏è', 'üèåÔ∏è‚Äç‚ôÇÔ∏è', 'üèá', 'üßò‚Äç‚ôÄÔ∏è', 'üßò', 'üßò‚Äç‚ôÇÔ∏è', 'üèÑ‚Äç‚ôÄÔ∏è', 'üèÑ', 'üèÑ‚Äç‚ôÇÔ∏è', 'üèä‚Äç‚ôÄÔ∏è', 'üèä', 'üèä‚Äç‚ôÇÔ∏è', 'ü§Ω‚Äç‚ôÄÔ∏è', 'ü§Ω', 'ü§Ω‚Äç‚ôÇÔ∏è', 'üö£‚Äç‚ôÄÔ∏è', 'üö£', 'üö£‚Äç‚ôÇÔ∏è', 'üßó‚Äç‚ôÄÔ∏è', 'üßó', 'üßó‚Äç‚ôÇÔ∏è', 'üöµ‚Äç‚ôÄÔ∏è', 'üöµ', 'üöµ‚Äç‚ôÇÔ∏è', 'üö¥‚Äç‚ôÄÔ∏è', 'üö¥', 'üö¥‚Äç‚ôÇÔ∏è', 'üèÜ', 'ü•á', 'ü•à', 'ü•â', 'üèÖ', 'üéñÔ∏è', 'üèµÔ∏è', 'üéóÔ∏è', 'üé´', 'üéüÔ∏è', 'üé™', 'ü§π', 'ü§π‚Äç‚ôÄÔ∏è', 'ü§π‚Äç‚ôÇÔ∏è', 'üé≠', 'ü©∞', 'üé®', 'üé¨', 'üé§', 'üéß', 'üéº', 'üéµ', 'üé∂', 'ü•Å', 'ü™ò', 'üéπ', 'üé∑', 'üé∫', 'ü™ó', 'üé∏', 'ü™ï', 'üéª', 'üé≤', '‚ô†Ô∏è', '‚ô•Ô∏è', '‚ô¶Ô∏è', '‚ô£Ô∏è', '‚ôüÔ∏è', 'üÉè', 'üÄÑ', 'üé¥', 'üéØ', 'üé≥'],
      travel: ['‚úàÔ∏è', 'üõ´', 'üõ¨', 'ü™Ç', 'üí∫', 'üöÅ', 'üöü', 'üö†', 'üö°', 'üõ∞Ô∏è', 'üöÄ', 'üõ∏', 'üöÇ', 'üöÉ', 'üöÑ', 'üöÖ', 'üöÜ', 'üöá', 'üöà', 'üöâ', 'üöä', 'üöù', 'üöû', 'üöã', 'üöå', 'üöç', 'üöé', 'üöê', 'üöë', 'üöí', 'üöì', 'üöî', 'üöï', 'üöñ', 'üöó', 'üöò', 'üöô', 'üõª', 'üöö', 'üöõ', 'üöú', 'üèéÔ∏è', 'üèçÔ∏è', 'üõµ', 'ü¶Ω', 'ü¶º', 'üõ¥', 'üö≤', 'üõ∫', 'üö®', 'üö•', 'üö¶', 'üõë', 'üöß', '‚öì', '‚õµ', 'üõ∂', 'üö§', 'üõ≥Ô∏è', '‚õ¥Ô∏è', 'üõ•Ô∏è', 'üö¢', 'üè∞', 'üèØ', 'üèüÔ∏è', 'üé°', 'üé¢', 'üé†', '‚õ≤', '‚õ±Ô∏è', 'üèñÔ∏è', 'üèùÔ∏è', 'üèúÔ∏è', 'üåã', '‚õ∞Ô∏è', 'üèîÔ∏è', 'üóª', 'üèïÔ∏è', '‚õ∫', 'üõñ', 'üè†', 'üè°', 'üèòÔ∏è', 'üèöÔ∏è', 'üèóÔ∏è', 'üè≠', 'üè¢', 'üè¨', 'üè£', 'üè§', 'üè•', 'üè¶', 'üè®', 'üè™', 'üè´', 'üè©', 'üíí', 'üèõÔ∏è', '‚õ™', 'üïå', 'üõï', 'üïç', '‚õ©Ô∏è', 'üïã', '‚õ≤', '‚õ±Ô∏è', 'üåÅ', 'üåÉ', 'üèôÔ∏è', 'üåÑ', 'üåÖ', 'üåÜ', 'üåá', 'üåâ', '‚ô®Ô∏è', 'üé†', 'üé°', 'üé¢', 'üíà', 'üé™'],
      objects: ['üí°', 'üî¶', 'üïØÔ∏è', 'ü™î', 'üßØ', 'üõ¢Ô∏è', 'üí∏', 'üíµ', 'üí¥', 'üí∂', 'üí∑', 'ü™ô', 'üí∞', 'üí≥', 'üíé', '‚öñÔ∏è', 'ü™ú', 'üß∞', 'üîß', 'üî®', '‚öíÔ∏è', 'üõ†Ô∏è', '‚õèÔ∏è', 'ü™ì', 'ü™ö', 'üî©', '‚öôÔ∏è', 'ü™§', 'üß±', '‚õìÔ∏è', 'üß≤', 'üî´', 'üí£', 'üß®', 'ü™ì', 'üî™', 'üó°Ô∏è', '‚öîÔ∏è', 'üõ°Ô∏è', 'üö¨', '‚ö∞Ô∏è', 'ü™¶', '‚ö±Ô∏è', 'üè∫', 'üîÆ', 'üìø', 'üßø', 'üíà', '‚öóÔ∏è', 'üî≠', 'üî¨', 'üï≥Ô∏è', 'ü©π', 'ü©∫', 'üíä', 'üíâ', 'ü©∏', 'üß¨', 'ü¶†', 'üß´', 'üß™', 'üå°Ô∏è', 'üßπ', 'ü™£', 'üßΩ', 'üß¥', 'üõéÔ∏è', 'üîë', 'üóùÔ∏è', 'üö™', 'ü™ë', 'üõãÔ∏è', 'üõèÔ∏è', 'üõå', 'üß∏', 'ü™Ü', 'üñºÔ∏è', 'ü™û', 'ü™ü', 'üõçÔ∏è', 'üõí', 'üéÅ', 'üéà', 'üéè', 'üéÄ', 'ü™Ñ', 'ü™Ö', 'üéä', 'üéâ', 'üéé', 'üèÆ', 'üéê', 'üßß', '‚úâÔ∏è', 'üì©', 'üì®', 'üìß', 'üíå', 'üì•', 'üì§', 'üì¶', 'üè∑Ô∏è', 'ü™ß', 'üì™', 'üì´', 'üì¨', 'üì≠', 'üìÆ', 'üìØ', 'üìú', 'üìÉ', 'üìÑ', 'üìë', 'üßæ', 'üìä', 'üìà', 'üìâ', 'üóíÔ∏è', 'üóìÔ∏è', 'üìÖ', 'üìÜ', 'üìá', 'üóÉÔ∏è', 'üó≥Ô∏è', 'üóÑÔ∏è', 'üìã', 'üìå', 'üìç', 'üìé', 'üñáÔ∏è', 'üìè', 'üìê', '‚úÇÔ∏è', 'üóÇÔ∏è', 'üóûÔ∏è', 'üì∞', 'üìì', 'üìî', 'üìí', 'üìï', 'üìó', 'üìò', 'üìô', 'üìö', 'üìñ', 'üîñ', 'üß∑', 'üîó', 'üìé', 'üñáÔ∏è', 'üìê', 'üìè', 'üßÆ', 'üì±', 'üì≤', '‚òéÔ∏è', 'üìû', 'üìü', 'üì†', 'üîã', 'ü™´', 'üîå', 'üíª', 'üñ•Ô∏è', 'üñ®Ô∏è', '‚å®Ô∏è', 'üñ±Ô∏è', 'üñ≤Ô∏è', 'üíΩ', 'üíæ', 'üíø', 'üìÄ', 'üßø', 'üé•', 'üéûÔ∏è', 'üìΩÔ∏è', 'üé¨', 'üì∫', 'üì∑', 'üì∏', 'üìπ', 'üìº'],
      symbols: ['‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üíü', '‚òÆÔ∏è', '‚úùÔ∏è', '‚ò™Ô∏è', 'üïâÔ∏è', '‚ò∏Ô∏è', '‚ú°Ô∏è', 'üîØ', 'üïé', '‚òØÔ∏è', '‚ò¶Ô∏è', 'üõê', '‚õé', '‚ôà', '‚ôâ', '‚ôä', '‚ôã', '‚ôå', '‚ôç', '‚ôé', '‚ôè', '‚ôê', '‚ôë', '‚ôí', '‚ôì', 'üÜî', '‚öõÔ∏è', 'üâë', '‚ò¢Ô∏è', '‚ò£Ô∏è', 'üì¥', 'üì≥', 'üà∂', 'üàö', 'üà∏', 'üà∫', 'üà∑Ô∏è', '‚ú¥Ô∏è', 'üÜö', 'üíÆ', 'üâê', '„äôÔ∏è', '„äóÔ∏è', 'üà¥', 'üàµ', 'üàπ', 'üà≤', 'üÖ∞Ô∏è', 'üÖ±Ô∏è', 'üÜé', 'üÜë', 'üÖæÔ∏è', 'üÜò', '‚ùå', '‚≠ï', 'üõë', '‚õî', 'üìõ', 'üö´', 'üíØ', 'üí¢', '‚ô®Ô∏è', 'üö∑', 'üöØ', 'üö≥', 'üö±', 'üîû', 'üìµ', 'üö≠', '‚ùó', '‚ùï', '‚ùì', '‚ùî', '‚ÄºÔ∏è', '‚ÅâÔ∏è', 'üîÖ', 'üîÜ', '„ÄΩÔ∏è', '‚ö†Ô∏è', 'üö∏', 'üî±', '‚öúÔ∏è', 'üî∞', '‚ôªÔ∏è', '‚úÖ', 'üàØ', 'üíπ', '‚ùáÔ∏è', '‚ú≥Ô∏è', '‚ùé', 'üåê', 'üí†', '‚ìÇÔ∏è', 'üåÄ', 'üí§', 'üèß', 'üöæ', '‚ôø', 'üÖøÔ∏è', 'üà≥', 'üàÇÔ∏è', 'üõÇ', 'üõÉ', 'üõÑ', 'üõÖ', 'üöπ', 'üö∫', 'üöº', '‚ößÔ∏è', 'üöª', 'üöÆ', 'üé¶', 'üì∂', 'üàÅ', 'üî£', '‚ÑπÔ∏è', 'üî§', 'üî°', 'üî†', 'üÜñ', 'üÜó', 'üÜô', 'üÜí', 'üÜï', 'üÜì', '0Ô∏è‚É£', '1Ô∏è‚É£', '2Ô∏è‚É£', '3Ô∏è‚É£', '4Ô∏è‚É£', '5Ô∏è‚É£', '6Ô∏è‚É£', '7Ô∏è‚É£', '8Ô∏è‚É£', '9Ô∏è‚É£', 'üîü', 'üî¢', '#Ô∏è‚É£', '*Ô∏è‚É£', '‚èèÔ∏è', '‚ñ∂Ô∏è', '‚è∏Ô∏è', '‚èØÔ∏è', '‚èπÔ∏è', '‚è∫Ô∏è', '‚è≠Ô∏è', '‚èÆÔ∏è', '‚è©', '‚è™', '‚è´', '‚è¨', '‚óÄÔ∏è', 'üîº', 'üîΩ', '‚û°Ô∏è', '‚¨ÖÔ∏è', '‚¨ÜÔ∏è', '‚¨áÔ∏è', '‚ÜóÔ∏è', '‚ÜòÔ∏è', '‚ÜôÔ∏è', '‚ÜñÔ∏è', '‚ÜïÔ∏è', '‚ÜîÔ∏è', '‚Ü™Ô∏è', '‚Ü©Ô∏è', '‚§¥Ô∏è', '‚§µÔ∏è', 'üîÄ', 'üîÅ', 'üîÇ', 'üîÑ', 'üîÉ', 'üéµ', 'üé∂', '‚ûï', '‚ûñ', '‚ûó', '‚úñÔ∏è', 'üü∞', '‚ôæÔ∏è', 'üí≤', 'üí±', '‚Ñ¢Ô∏è', '¬©Ô∏è', '¬ÆÔ∏è', '„Ä∞Ô∏è', '‚û∞', '‚ûø', 'üîö', 'üîô', 'üîõ', 'üîù', 'üîú', '‚úîÔ∏è', '‚òëÔ∏è', 'üîò', 'üî¥', 'üü†', 'üü°', 'üü¢', 'üîµ', 'üü£', '‚ö´', '‚ö™', 'üü§', 'üî∫', 'üîª', 'üî∏', 'üîπ', 'üî∂', 'üî∑', 'üî≥', 'üî≤', '‚ñ™Ô∏è', '‚ñ´Ô∏è', '‚óæ', '‚óΩ', '‚óºÔ∏è', '‚óªÔ∏è', 'üü•', 'üüß', 'üü®', 'üü©', 'üü¶', 'üü™', '‚¨õ', '‚¨ú', 'üü´', 'üîà', 'üîá', 'üîâ', 'üîä', 'üîî', 'üîï', 'üì£', 'üì¢', 'üëÅÔ∏è‚Äçüó®Ô∏è', 'üí¨', 'üí≠', 'üóØÔ∏è', '‚ô†Ô∏è', '‚ô£Ô∏è', '‚ô•Ô∏è', '‚ô¶Ô∏è', 'üÉè', 'üé¥', 'üÄÑ', 'üïê', 'üïë', 'üïí', 'üïì', 'üïî', 'üïï', 'üïñ', 'üïó', 'üïò', 'üïô', 'üïö', 'üïõ', 'üïú', 'üïù', 'üïû', 'üïü', 'üï†', 'üï°', 'üï¢', 'üï£', 'üï§', 'üï•', 'üï¶', 'üïß']
    };

    let currentEmojiCategory = 'smileys';

    function initializeEmojiPicker() {
      populateEmojiGrid(currentEmojiCategory);
      
      // Category switching
      document.querySelectorAll('.emoji-category').forEach(category => {
        category.addEventListener('click', () => {
          document.querySelectorAll('.emoji-category').forEach(c => c.classList.remove('active'));
          category.classList.add('active');
          currentEmojiCategory = category.dataset.category;
          populateEmojiGrid(currentEmojiCategory);
        });
      });
    }

    function populateEmojiGrid(category) {
      const grid = document.getElementById('emojiGrid');
      grid.innerHTML = '';
      
      emojiCategories[category].forEach(emoji => {
        const emojiItem = document.createElement('div');
        emojiItem.className = 'emoji-item';
        emojiItem.textContent = emoji;
        emojiItem.addEventListener('click', () => {
          insertEmoji(emoji);
          hideEmojiPicker();
        });
        grid.appendChild(emojiItem);
      });
    }

    function insertEmoji(emoji) {
      const input = document.getElementById('chatInput');
      const start = input.selectionStart;
      const end = input.selectionEnd;
      const text = input.value;
      
      input.value = text.substring(0, start) + emoji + text.substring(end);
      input.selectionStart = input.selectionEnd = start + emoji.length;
      input.focus();
    }

    function showEmojiPicker() {
      document.getElementById('emojiPicker').classList.add('active');
    }

    function hideEmojiPicker() {
      document.getElementById('emojiPicker').classList.remove('active');
    }

    // Emoji button event listener
    document.getElementById('emojiBtn').addEventListener('click', (e) => {
      e.stopPropagation();
      const picker = document.getElementById('emojiPicker');
      if (picker.classList.contains('active')) {
        hideEmojiPicker();
      } else {
        showEmojiPicker();
      }
    });

    // Close emoji picker when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.emoji-picker') && !e.target.closest('.emoji-btn')) {
        hideEmojiPicker();
      }
    });

    // Initialize emoji picker
    initializeEmojiPicker();





    // Message retry functionality
    window.retryMessage = async function(messageId) {
      if (!activeChat) return;
      
      try {
        const messageRef = ref(db, `chats/${activeChat.chatId}/messages/${messageId}`);
        await update(messageRef, {
          status: 'sending',
          timestamp: Date.now()
        });
        
        // Simulate retry delay
        setTimeout(async () => {
          try {
            await update(messageRef, {
              status: 'sent'
            });
            showNotification('Message sent successfully! ‚úÖ', 'success');
          } catch (error) {
            await update(messageRef, {
              status: 'failed'
            });
            showNotification('Failed to send message. Tap to retry.', 'error');
          }
        }, 1000);
        
      } catch (error) {
        console.error('Retry message error:', error);
        showNotification('Failed to retry message.', 'error');
      }
    };

    // Enhanced message sending with status tracking
    async function sendMessageWithStatus(messageData) {
      if (!activeChat) return;
      
      const tempId = 'temp_' + Date.now();
      messageData.id = tempId;
      messageData.status = 'sending';
      
      try {
        const messagesRef = ref(db, `chats/${activeChat.chatId}/messages`);
        const messageRef = await push(messagesRef, messageData);
        
        // Update with real ID and sent status
        await update(messageRef, {
          status: 'sent'
        });
        
        // Update chat metadata
        await update(ref(db, `chats/${activeChat.chatId}`), {
          lastMessage: {
            text: messageData.text,
            timestamp: messageData.timestamp,
            senderId: messageData.senderId,
            type: messageData.type
          },
          lastActivity: messageData.timestamp
        });
        
      } catch (error) {
        console.error('Send message error:', error);
        
        // Mark as failed
        const failedMessageRef = ref(db, `chats/${activeChat.chatId}/messages/${tempId}`);
        await update(failedMessageRef, {
          status: 'failed'
        });
        
        showNotification('Message failed to send. Tap to retry.', 'error');
      }
    }

    // Update the original sendMessage function to use status tracking
    async function sendMessage() {
      if (!activeChat) return;
      
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      if (!text) return;
      
      const messageData = {
        text,
        type: 'text',
        senderId: currentUser.uid,
        timestamp: Date.now()
      };
      
      input.value = '';
      playMessageSound();
      
      if (navigator.onLine) {
        await sendMessageWithStatus(messageData);
        if (activeChat.chatType === 'private') {
          await set(ref(db, `chats/${activeChat.chatId}/typing/${currentUser.uid}`), false);
        }
      } else {
        messageData.chatId = activeChat.chatId;
        queueMessage(messageData);
      }
    }
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9979e60c22c86ed1',t:'MTc2MTk4NDQ0OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
