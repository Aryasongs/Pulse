<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <title>PixPlay - Discover & Share</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <style>
        /* Disable text selection and zoom */
        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Allow text selection only in input fields */
        input, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        
        /* Disable zoom on double tap */
        body {
            touch-action: pan-x pan-y;
            -ms-touch-action: pan-x pan-y;
        }
        
        /* Disable image dragging */
        img {
            -webkit-user-drag: none;
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
            user-drag: none;
            pointer-events: none;
        }
        
        /* Re-enable pointer events for clickable images */
        .pix-card img {
            pointer-events: auto;
        }
        
        /* Disable context menu */
        body {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Pinterest-style grid */
        .pinterest-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 8px;
            padding: 8px;
            max-width: 100vw;
            overflow: hidden;
        }
        
        @media (min-width: 480px) {
            .pinterest-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 12px;
                padding: 12px;
            }
        }
        
        @media (min-width: 768px) {
            .pinterest-grid {
                grid-template-columns: repeat(auto-fill, minmax(236px, 1fr));
                gap: 16px;
                padding: 16px;
            }
        }
        
        @media (min-width: 1024px) {
            .pinterest-grid {
                grid-template-columns: repeat(auto-fill, minmax(252px, 1fr));
                gap: 20px;
                padding: 20px;
            }
        }
        
        .pix-card {
            break-inside: avoid;
            border-radius: 16px;
            overflow: hidden;
            transition: transform 0.2s ease;
            max-width: 100%;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .pix-card:hover {
            transform: translateY(-2px);
        }
        
        .pix-card img {
            width: 100%;
            height: auto;
            display: block;
            max-width: 100%;
        }
        
        .pix-card p {
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .hover-overlay {
            opacity: 0;
            transition: opacity 0.3s ease;
            background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.6) 100%);
        }
        .pix-card:hover .hover-overlay {
            opacity: 1;
        }
        
        .monetized-badge {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #ef4444;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Loading Grid Animation */
        .loading-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 8px;
            padding: 8px;
            max-width: 100vw;
            overflow: hidden;
        }
        
        @media (min-width: 480px) {
            .loading-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 12px;
                padding: 12px;
            }
        }
        
        @media (min-width: 768px) {
            .loading-grid {
                grid-template-columns: repeat(auto-fill, minmax(236px, 1fr));
                gap: 16px;
                padding: 16px;
            }
        }
        
        @media (min-width: 1024px) {
            .loading-grid {
                grid-template-columns: repeat(auto-fill, minmax(252px, 1fr));
                gap: 20px;
                padding: 20px;
            }
        }

        .loading-card {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 16px;
            overflow: hidden;
        }

        .loading-image {
            width: 100%;
            height: 200px;
            background: linear-gradient(90deg, #e0e0e0 25%, #d0d0d0 50%, #e0e0e0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        .loading-text {
            height: 12px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 6px;
            margin: 8px 0;
        }

        .loading-text.short {
            width: 60%;
        }

        .loading-text.medium {
            width: 80%;
        }

        .loading-text.long {
            width: 100%;
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 1000;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loading-header {
            background: linear-gradient(90deg, #f8f9fa 25%, #e9ecef 50%, #f8f9fa 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            height: 60px;
            border-bottom: 1px solid #e5e7eb;
        }

        .loading-nav {
            background: linear-gradient(90deg, #f8f9fa 25%, #e9ecef 50%, #f8f9fa 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            height: 40px;
            margin: 10px 20px;
            border-radius: 8px;
        }



        .error-dialog {
            backdrop-filter: blur(4px);
        }
        
        /* Mobile bottom navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            z-index: 50;
            padding: 8px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            color: #6b7280;
            transition: color 0.2s;
        }
        
        .nav-item.active {
            color: #ef4444;
        }
        
        .nav-item svg {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
        }
        
        .nav-item span {
            font-size: 10px;
            font-weight: 500;
        }
        
        /* Mobile header */
        .mobile-header {
            position: sticky;
            top: 0;
            z-index: 40;
            background: white;
            border-bottom: 1px solid #e5e7eb;
        }
        
        /* Content padding for mobile nav */
        .main-content {
            padding-bottom: 80px;
        }
        
        /* Hide desktop nav on mobile */
        @media (max-width: 768px) {
            .desktop-nav { display: none; }
            .mobile-search { display: block; }
            .desktop-search { display: none; }
        }
        
        @media (min-width: 769px) {
            .bottom-nav { display: none; }
            .mobile-search { display: none; }
            .desktop-search { display: block; }
            .main-content { padding-bottom: 0; }
        }
    </style>
</head>
<body class="bg-white min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-red-50 to-pink-50">
        <div class="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full mx-4">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-red-600 mb-2">PixPlay</h1>
                <p class="text-gray-600">Discover & Share Amazing Images</p>
            </div>
            <button onclick="signInWithGoogle()" class="w-full bg-white border-2 border-gray-300 rounded-lg py-3 px-4 flex items-center justify-center space-x-3 hover:bg-gray-50 transition-colors">
                <svg class="w-5 h-5" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                <span class="font-medium text-gray-700">Continue with Google</span>
            </button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <!-- Loading Header -->
        <div class="loading-header"></div>
        
        <!-- Loading Navigation -->
        <div class="loading-nav"></div>
        
        <!-- Loading Grid -->
        <div class="loading-grid" id="loadingGrid">
            <!-- Loading cards will be generated by JavaScript -->
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp">
        <!-- Mobile Header -->
        <header class="mobile-header">
            <div class="px-4 py-3">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-red-600 cursor-pointer" onclick="showHome()">PixPlay</h1>
                    <div class="flex items-center space-x-3">
                        <button onclick="openSearchModal()" class="p-2 text-gray-600 hover:text-red-600 transition-colors md:hidden">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </button>
                        <div id="userActions" class="hidden">
                            <div class="relative">
                                <button onclick="toggleProfileMenu()" class="w-8 h-8 rounded-full overflow-hidden border-2 border-gray-300 hover:border-red-500 transition-colors">
                                    <img id="headerProfilePic" src="" alt="Profile" class="w-full h-full object-cover">
                                </button>
                                <div id="profileMenu" class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border hidden">
                                    <button onclick="showSettings()" class="w-full text-left px-4 py-2 hover:bg-gray-50">Settings</button>
                                    <button onclick="checkAdvertiserAccess()" class="w-full text-left px-4 py-2 hover:bg-gray-50">Advertiser Dashboard</button>
                                    <button onclick="signOut()" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-red-600 rounded-b-lg">Sign Out</button>
                                </div>
                            </div>
                        </div>
                        <div id="guestActions">
                            <button onclick="signInWithGoogle()" class="bg-red-600 text-white px-4 py-2 rounded-full text-sm font-medium hover:bg-red-700 transition-colors">
                                Sign In
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Desktop Search -->
                <div class="desktop-search mt-3">
                    <div class="relative max-w-2xl mx-auto">
                        <input type="text" placeholder="Search Pix (e.g., nature, food, art, travel)..." class="w-full bg-gray-100 rounded-full py-3 px-6 pl-12 focus:outline-none focus:ring-2 focus:ring-red-500 focus:bg-white transition-all" id="searchInput">
                        <svg class="w-5 h-5 text-gray-500 absolute left-4 top-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                </div>
                
                <!-- Desktop Navigation -->
                <nav class="desktop-nav flex justify-center space-x-8 mt-4">
                    <button onclick="showHome()" class="text-gray-700 hover:text-red-600 font-medium transition-colors pb-2 border-b-2 border-transparent" id="homeBtn">Home</button>
                    <button onclick="showSaved()" class="text-gray-700 hover:text-red-600 font-medium transition-colors pb-2 border-b-2 border-transparent hidden" id="savedBtn">Saved</button>
                    <button onclick="showMyPins()" class="text-gray-700 hover:text-red-600 font-medium transition-colors pb-2 border-b-2 border-transparent hidden" id="myPinsBtn">My Pix</button>
                </nav>
            </div>
        </header>



        <!-- Main Content -->
        <main class="main-content">
            <!-- Home View -->
            <div id="homeView">
                <div class="pinterest-grid" id="imageGallery">
                    <!-- Images will be loaded here -->
                </div>
                <div id="emptyState" class="text-center py-20 hidden">
                    <div class="text-6xl mb-4">📸</div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">No Pix yet</h3>
                    <p class="text-gray-500 mb-6">Start by uploading your first image!</p>
                    <button onclick="requireLogin(openUploadModal)" class="bg-red-600 text-white px-6 py-3 rounded-full hover:bg-red-700 transition-colors">
                        Upload Image
                    </button>
                </div>
            </div>

            <!-- Saved View -->
            <div id="savedView" class="hidden">
                <div class="px-4 py-4 md:px-0">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">Saved Pix</h2>
                </div>
                <div class="pinterest-grid" id="savedGallery">
                    <!-- Saved images will be loaded here -->
                </div>
                <div id="emptySaved" class="text-center py-20 hidden">
                    <div class="text-6xl mb-4">💾</div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">No saved Pix yet</h3>
                    <p class="text-gray-500">Save Pix you love to see them here!</p>
                </div>
            </div>

            <!-- My Pins View -->
            <div id="myPinsView" class="hidden">
                <div class="px-4 py-4 md:px-0">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">My Pix</h2>
                </div>
                <div class="pinterest-grid" id="myPinsGallery">
                    <!-- User's images will be loaded here -->
                </div>
                <div id="emptyMyPins" class="text-center py-20 hidden">
                    <div class="text-6xl mb-4">🎨</div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">No Pix created yet</h3>
                    <p class="text-gray-500 mb-6">Share your creativity with the world!</p>
                    <button onclick="openUploadModal()" class="bg-red-600 text-white px-6 py-3 rounded-full hover:bg-red-700 transition-colors">
                        Create Pix
                    </button>
                </div>
            </div>

            <!-- Advertiser Dashboard -->
            <div id="advertiserView" class="hidden">
                <div class="max-w-6xl mx-auto px-4 py-6">
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="text-3xl font-bold text-gray-900">Advertiser Dashboard</h2>
                        <button onclick="openCreateAdModal()" class="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-6 py-3 rounded-lg hover:from-purple-700 hover:to-blue-700 transition-all font-medium shadow-lg">
                            Create New Ad Campaign
                        </button>
                    </div>
                    
                    <!-- Stats Overview -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-xl border border-blue-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-blue-600 text-sm font-medium">Total Campaigns</p>
                                    <p class="text-2xl font-bold text-blue-900" id="totalCampaigns">0</p>
                                </div>
                                <div class="bg-blue-500 p-3 rounded-full">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-xl border border-green-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-green-600 text-sm font-medium">Total Impressions</p>
                                    <p class="text-2xl font-bold text-green-900" id="totalImpressions">0</p>
                                </div>
                                <div class="bg-green-500 p-3 rounded-full">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-xl border border-purple-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-purple-600 text-sm font-medium">Total Clicks</p>
                                    <p class="text-2xl font-bold text-purple-900" id="totalClicks">0</p>
                                </div>
                                <div class="bg-purple-500 p-3 rounded-full">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-6 rounded-xl border border-orange-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-orange-600 text-sm font-medium">Total Spent</p>
                                    <p class="text-2xl font-bold text-orange-900">$<span id="totalSpent">0.00</span></p>
                                </div>
                                <div class="bg-orange-500 p-3 rounded-full">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Active Campaigns -->
                    <div class="bg-white rounded-xl shadow-sm border p-6">
                        <h3 class="text-xl font-semibold text-gray-900 mb-6">Your Ad Campaigns</h3>
                        <div id="campaignsList">
                            <div class="text-center py-12">
                                <div class="text-6xl mb-4">📊</div>
                                <h4 class="text-lg font-semibold text-gray-700 mb-2">No campaigns yet</h4>
                                <p class="text-gray-500 mb-6">Create your first ad campaign to start reaching customers!</p>
                                <button onclick="openCreateAdModal()" class="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-6 py-3 rounded-lg hover:from-purple-700 hover:to-blue-700 transition-all font-medium">
                                    Create Campaign
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="settingsView" class="hidden">
                <div class="max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">Settings</h2>
                    <div class="bg-white rounded-lg shadow-sm border p-6">
                        <div class="flex items-center space-x-6 mb-6">
                            <div class="relative">
                                <img id="settingsProfilePic" src="" alt="Profile" class="w-20 h-20 rounded-full object-cover border-4 border-gray-200">
                                <button onclick="changeProfilePicture()" class="absolute bottom-0 right-0 bg-red-600 text-white p-1 rounded-full hover:bg-red-700 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="flex-1">
                                <input type="text" id="usernameInput" placeholder="Username (e.g., @johndoe)" class="w-full p-3 border border-gray-300 rounded-lg mb-3">
                                <input type="text" id="displayNameInput" placeholder="Display Name" class="w-full p-3 border border-gray-300 rounded-lg mb-3">
                                <input type="email" id="emailInput" placeholder="Email" class="w-full p-3 border border-gray-300 rounded-lg" readonly>
                            </div>
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Bio</label>
                            <textarea id="bioInput" placeholder="Tell us about yourself..." rows="3" class="w-full p-3 border border-gray-300 rounded-lg"></textarea>
                        </div>
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Monetization Stats</h3>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <p class="text-sm text-gray-600">Total Views</p>
                                    <p class="text-2xl font-bold text-gray-900" id="userTotalViews">0</p>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <p class="text-sm text-gray-600">Monetized Pix</p>
                                    <p class="text-2xl font-bold text-gray-900" id="userMonetizedPins">0</p>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <p class="text-sm text-green-600">Total Earnings</p>
                                    <p class="text-2xl font-bold text-green-600">$<span id="userTotalEarnings">0.00</span></p>
                                </div>
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <p class="text-sm text-blue-600">Wallet Balance</p>
                                    <p class="text-2xl font-bold text-blue-600">$<span id="userWalletBalance">0.00</span></p>
                                </div>
                            </div>
                            <p class="text-sm text-gray-500 mt-2">Earnings are sent to: customerserviceffrj4@gmail.com</p>
                        </div>
                        <button onclick="saveProfile()" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors">
                            Save Changes
                        </button>
                    </div>
                    
                    <!-- About PixPlay Section -->
                    <div class="bg-white rounded-lg shadow-sm border p-6 mt-6">
                        <h3 class="text-xl font-semibold text-gray-900 mb-6">About PixPlay</h3>
                        
                        <div class="space-y-6">
                            <!-- App Info -->
                            <div>
                                <h4 class="font-semibold text-gray-800 mb-3">About the Platform</h4>
                                <p class="text-gray-600 leading-relaxed">
                                    PixPlay is a creative platform where users can discover, share, and monetize amazing visual content. 
                                    Our mission is to empower creators and connect communities through the power of visual storytelling.
                                </p>
                            </div>
                            
                            <!-- Founders Section -->
                            <div>
                                <h4 class="font-semibold text-gray-800 mb-4">Meet Our Founders</h4>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="bg-gray-50 p-4 rounded-lg text-center">
                                        <div class="w-16 h-16 bg-gradient-to-br from-red-500 to-pink-500 rounded-full mx-auto mb-3 flex items-center justify-center text-white font-bold text-lg">
                                            GA
                                        </div>
                                        <h5 class="font-semibold text-gray-900">Mr. Gursharn Arya</h5>
                                        <p class="text-sm text-gray-600 mb-2">Founder</p>
                                        <a href="mailto:gursharnarya@oriontec.xyz" class="text-xs text-blue-600 hover:text-blue-800 break-all">
                                            gursharnarya@oriontec.xyz
                                        </a>
                                    </div>
                                    
                                    <div class="bg-gray-50 p-4 rounded-lg text-center">
                                        <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full mx-auto mb-3 flex items-center justify-center text-white font-bold text-lg">
                                            AS
                                        </div>
                                        <h5 class="font-semibold text-gray-900">Mr. Anmol Sunda</h5>
                                        <p class="text-sm text-gray-600 mb-2">Co-Founder</p>
                                        <a href="mailto:gursharnarya@oriontec.xyz" class="text-xs text-blue-600 hover:text-blue-800 break-all">
                                            gursharnarya@oriontec.xyz
                                        </a>
                                    </div>
                                    
                                    <div class="bg-gray-50 p-4 rounded-lg text-center">
                                        <div class="w-16 h-16 bg-gradient-to-br from-green-500 to-teal-500 rounded-full mx-auto mb-3 flex items-center justify-center text-white font-bold text-lg">
                                            JG
                                        </div>
                                        <h5 class="font-semibold text-gray-900">Mr. Jashan Preet Ram Gangar</h5>
                                        <p class="text-sm text-gray-600 mb-2">Co-Founder</p>
                                        <a href="mailto:gursharnarya@oriontec.xyz" class="text-xs text-blue-600 hover:text-blue-800 break-all">
                                            gursharnarya@oriontec.xyz
                                        </a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Contact & Support -->
                            <div>
                                <h4 class="font-semibold text-gray-800 mb-3">Contact & Support</h4>
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <p class="text-sm text-blue-800 mb-2">
                                        <strong>General Inquiries:</strong> 
                                        <a href="mailto:gursharnarya@oriontec.xyz" class="hover:underline">gursharnarya@oriontec.xyz</a>
                                    </p>
                                    <p class="text-sm text-blue-800 mb-2">
                                        <strong>Technical Support:</strong> Available 24/7 through our platform
                                    </p>
                                    <p class="text-sm text-blue-800">
                                        <strong>Business Partnerships:</strong> Contact any of our founders directly
                                    </p>
                                </div>
                            </div>
                            
                            <!-- App Version -->
                            <div class="border-t pt-4">
                                <div class="flex justify-between items-center text-sm text-gray-500">
                                    <span>PixPlay Version 1.0.0</span>
                                    <span>© 2024 PixPlay by Oriontec</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Mobile Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="flex justify-around">
                <button onclick="showHome()" class="nav-item active" id="mobileHomeBtn">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                    </svg>
                    <span>Home</span>
                </button>
                
                <button onclick="openSearchModal()" class="nav-item">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <span>Search</span>
                </button>
                
                <button onclick="requireLogin(openUploadModal)" class="nav-item">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    <span>Create</span>
                </button>
                
                <button onclick="requireLogin(showSaved)" class="nav-item" id="mobileSavedBtn">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                    </svg>
                    <span>Saved</span>
                </button>
                
                <button onclick="handleProfileClick()" class="nav-item" id="mobileProfileBtn">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <span>Profile</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- Mobile Search Modal -->
    <div id="searchModal" class="fixed inset-0 bg-white hidden z-50 md:hidden">
        <div class="flex flex-col h-full">
            <div class="flex items-center p-4 border-b">
                <button onclick="closeSearchModal()" class="mr-3 p-2 text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                <div class="flex-1 relative">
                    <input type="text" placeholder="Search Pix..." class="w-full bg-gray-100 rounded-full py-3 px-6 pl-12 focus:outline-none focus:ring-2 focus:ring-red-500 focus:bg-white transition-all" id="mobileSearchInput">
                    <svg class="w-5 h-5 text-gray-500 absolute left-4 top-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto">
                <div class="pinterest-grid" id="searchResults">
                    <!-- Search results will appear here -->
                </div>
                <div id="noSearchResults" class="text-center py-20 hidden">
                    <div class="text-4xl mb-4">🔍</div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">No results found</h3>
                    <p class="text-gray-500">Try searching for something else</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Create Pix</h3>
                    <button onclick="closeUploadModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="p-6 space-y-6">
                <!-- Image Upload -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Image (Optional)</label>
                    <input type="file" id="imageInput" accept="image/*" class="w-full p-2 border border-gray-300 rounded-lg">
                    <p class="text-xs text-gray-500 mt-1">You can also create a Pix using just a product link below</p>
                </div>

                <!-- Title -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                    <input type="text" id="titleInput" placeholder="Tell everyone what your Pix is about" maxlength="100" class="w-full p-3 border border-gray-300 rounded-lg">
                    <div class="flex justify-between items-center mt-1">
                        <p class="text-xs text-gray-500">Help others discover your Pix with a good title!</p>
                        <span id="titleCount" class="text-xs text-gray-400">0/100</span>
                    </div>
                </div>

                <!-- Description -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <textarea id="descriptionInput" placeholder="Add a description, mention, or hashtags to your Pix." rows="3" class="w-full p-3 border border-gray-300 rounded-lg resize-none"></textarea>
                    <p class="text-xs text-gray-500 mt-1">Add details, mentions, or hashtags</p>
                </div>

                <!-- Link -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Link</label>
                    <input type="url" id="linkInput" placeholder="Add a destination link" class="w-full p-3 border border-gray-300 rounded-lg" onblur="handleLinkPreview()">
                    <p class="text-xs text-gray-500 mt-1">Add a link to your website or product</p>
                    
                    <!-- Link Preview -->
                    <div id="linkPreview" class="hidden mt-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="flex items-center space-x-3 mb-2">
                            <div id="linkPreviewImage" class="w-16 h-16 bg-gray-200 rounded flex items-center justify-center text-2xl relative">
                                🔗
                                <div id="videoPlayIcon" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 rounded hidden">
                                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M8 5v14l11-7z"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 id="linkPreviewTitle" class="font-medium text-gray-900 text-sm truncate">Link Preview</h4>
                                <p id="linkPreviewDescription" class="text-xs text-gray-600 truncate">Loading preview...</p>
                                <p id="linkPreviewHostname" class="text-xs text-gray-500 truncate"></p>
                                <div id="linkPreviewPrice" class="hidden">
                                    <span class="text-sm font-bold text-green-600"></span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <div id="linkPreviewBadge" class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full font-medium hidden">
                                🛍️ Shopping
                            </div>
                            <button type="button" onclick="clearLinkPreview()" class="text-xs text-red-600 hover:text-red-800">
                                Remove Preview
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Board Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Pick a board</label>
                    <select id="boardSelect" class="w-full p-3 border border-gray-300 rounded-lg">
                        <option value="general">General</option>
                        <option value="art">Art & Design</option>
                        <option value="food">Food & Drink</option>
                        <option value="travel">Travel</option>
                        <option value="fashion">Fashion</option>
                        <option value="nature">Nature</option>
                        <option value="photography">Photography</option>
                        <option value="lifestyle">Lifestyle</option>
                        <option value="shopping">Shopping & Products</option>
                        <option value="technology">Technology</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Choose the most relevant category</p>
                </div>

                <!-- Profile & Topics -->
                <div class="space-y-3">
                    <div class="flex items-center space-x-3">
                        <img id="uploadProfilePic" src="" alt="Profile" class="w-10 h-10 rounded-full object-cover border-2 border-gray-200">
                        <div>
                            <p class="font-medium text-gray-900" id="uploadProfileName">Your Profile</p>
                            <p class="text-sm text-gray-500">Tag related topics</p>
                        </div>
                    </div>
                </div>

                <!-- Schedule -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Schedule</label>
                    <div class="flex space-x-3">
                        <button type="button" onclick="setPublishNow()" id="publishNowBtn" class="flex-1 bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">
                            Publish now
                        </button>
                        <input type="datetime-local" id="scheduleDate" class="flex-1 p-2 border border-gray-300 rounded-lg text-sm">
                    </div>
                </div>

                <!-- Advanced Settings Toggle -->
                <div>
                    <button type="button" onclick="toggleAdvancedSettings()" id="advancedToggle" class="text-red-600 hover:text-red-700 font-medium text-sm">
                        Show Advanced Settings
                    </button>
                </div>

                <!-- Advanced Settings -->
                <div id="advancedSettings" class="hidden space-y-4 border-t pt-4">
                    <h4 class="font-semibold text-gray-900">Advanced Settings</h4>
                    
                    <!-- Engagement Settings -->
                    <div>
                        <h5 class="font-medium text-gray-700 mb-3">Engagement settings</h5>
                        <label class="flex items-center space-x-3">
                            <input type="checkbox" id="allowComments" checked class="rounded border-gray-300 text-red-600 focus:ring-red-500">
                            <span class="text-sm text-gray-700">Allow comments</span>
                        </label>
                    </div>

                    <!-- Branded Content -->
                    <div>
                        <h5 class="font-medium text-gray-700 mb-3">Branded content</h5>
                        <label class="flex items-center space-x-3">
                            <input type="checkbox" id="brandedContent" class="rounded border-gray-300 text-red-600 focus:ring-red-500" onchange="toggleShoppingRecommendations()">
                            <span class="text-sm text-gray-700">Add paid partnership label</span>
                        </label>
                    </div>

                    <!-- Shopping Recommendations -->
                    <div>
                        <h5 class="font-medium text-gray-700 mb-3">Shopping recommendations</h5>
                        <label class="flex items-start space-x-3">
                            <input type="checkbox" id="shoppingRecommendations" checked class="rounded border-gray-300 text-red-600 focus:ring-red-500 mt-1">
                            <div>
                                <span class="text-sm text-gray-700">Show similar products</span>
                                <p class="text-xs text-gray-500 mt-1">People can shop products similar to what's shown in this Pix using visual search. Shopping recommendations aren't available for Pix with tagged products or paid partnership label.</p>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Create Button -->
                <button onclick="uploadImage()" id="uploadBtn" class="w-full bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center font-medium">
                    <span id="uploadBtnText">Create Pix</span>
                    <div id="uploadSpinner" class="loading-spinner ml-2 hidden"></div>
                </button>
            </div>
        </div>
    </div>

    <!-- Image Detail Modal -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-5xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center space-x-4">
                        <button onclick="downloadImage()" class="bg-gray-100 hover:bg-gray-200 p-2 rounded-lg transition-colors" title="Download Image">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </button>
                        <button onclick="currentUser ? toggleSaveImage() : requireLogin(toggleSaveImage)" id="saveBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                            Save
                        </button>
                    </div>
                    <button onclick="closeImageModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <img id="modalImage" src="" alt="" class="w-full rounded-lg">
                        <div id="adSpace" class="mt-4 p-4 bg-gray-100 rounded-lg text-center text-gray-600 hidden">
                            <p class="text-sm">📢 Advertisement</p>
                            <div class="mt-2 p-4 bg-blue-100 rounded">
                                <p class="font-semibold">Monetized Content</p>
                                <p class="text-sm">This pin is earning revenue</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col h-full">
                        <div class="mb-4">
                            <h2 id="modalTitle" class="text-xl font-bold text-gray-900 mb-2">Untitled</h2>
                            <p id="modalDescription" class="text-gray-700 mb-4"></p>
                            <div class="flex items-center space-x-4 text-sm text-gray-600 mb-4">
                                <span class="flex items-center space-x-1">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                                    </svg>
                                    <span id="modalViewCount">0 views</span>
                                </span>
                                <span id="modalEarnings" class="text-green-600 font-semibold hidden"></span>
                            </div>
                            <div class="flex items-center space-x-3 mb-6">
                                <img id="modalAuthorPic" src="" alt="" class="w-10 h-10 rounded-full">
                                <span id="modalAuthor" class="font-medium"></span>
                            </div>
                        </div>
                        
                        <!-- Comments Section -->
                        <div class="flex-1 border-t pt-4">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Comments</h3>
                            
                            <!-- Add Comment -->
                            <div class="mb-4" id="commentForm">
                                <div class="flex space-x-3">
                                    <img id="commentUserPic" src="" alt="Your profile" class="w-8 h-8 rounded-full">
                                    <div class="flex-1">
                                        <textarea id="commentInput" placeholder="Add a comment..." rows="2" class="w-full p-3 border border-gray-300 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500" onkeydown="handleCommentKeydown(event)"></textarea>
                                        <div class="flex justify-end mt-2">
                                            <button onclick="addComment()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors text-sm font-medium">
                                                Post Comment
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Comments List -->
                            <div id="commentsList" class="space-y-4 max-h-64 overflow-y-auto">
                                <!-- Comments will be loaded here -->
                            </div>
                            
                            <div id="noComments" class="text-center py-8 text-gray-500 hidden">
                                <div class="text-4xl mb-2">💬</div>
                                <p>No comments yet. Be the first to comment!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Dialog -->
    <div id="errorDialog" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[60] flex items-center justify-center p-4 error-dialog">
        <div class="bg-white rounded-lg max-w-md w-full p-6 shadow-2xl">
            <div class="flex items-center mb-4">
                <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-3">
                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-gray-900">Oops! Something went wrong</h3>
            </div>
            <p id="errorMessage" class="text-gray-600 mb-6">An unexpected error occurred. Please try again.</p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeErrorDialog()" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                    Cancel
                </button>
                <button onclick="retryLastAction()" id="retryBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                    Try Again
                </button>
            </div>
        </div>
    </div>

    <!-- Success Toast -->
    <div id="successToast" class="fixed top-20 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 hidden fade-in">
        <div class="flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span id="successMessage">Success!</span>
        </div>
    </div>

    <!-- Warning Dialog -->
    <div id="warningDialog" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[60] flex items-center justify-center p-4 error-dialog">
        <div class="bg-white rounded-lg max-w-md w-full p-6 shadow-2xl">
            <div class="flex items-center mb-4">
                <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center mr-3">
                    <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-gray-900" id="warningTitle">Content Warning</h3>
            </div>
            <p id="warningMessage" class="text-gray-600 mb-6">This content is not appropriate for our platform.</p>
            <div class="flex justify-end">
                <button onclick="closeWarningDialog()" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition-colors">
                    I Understand
                </button>
            </div>
        </div>
    </div>

    <!-- Create Ad Campaign Modal -->
    <div id="createAdModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold">Create Ad Campaign</h3>
                    <button onclick="closeCreateAdModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="p-6 space-y-6">
                <!-- Campaign Type -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">Campaign Type</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <label class="relative">
                            <input type="radio" name="campaignType" value="image" checked class="sr-only">
                            <div class="border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-500 transition-colors campaign-type-option">
                                <div class="text-center">
                                    <div class="text-3xl mb-2">🖼️</div>
                                    <h4 class="font-semibold text-gray-900">Image Ad</h4>
                                    <p class="text-sm text-gray-600">Promote with engaging visuals</p>
                                </div>
                            </div>
                        </label>
                        
                        <label class="relative">
                            <input type="radio" name="campaignType" value="video" class="sr-only">
                            <div class="border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-500 transition-colors campaign-type-option">
                                <div class="text-center">
                                    <div class="text-3xl mb-2">🎥</div>
                                    <h4 class="font-semibold text-gray-900">Video Ad</h4>
                                    <p class="text-sm text-gray-600">Capture attention with motion</p>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Brand Information -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Brand Name *</label>
                        <input type="text" id="adBrandName" placeholder="Your brand name" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Brand Logo URL</label>
                        <input type="url" id="adBrandLogo" placeholder="https://example.com/logo.png" class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                </div>

                <!-- Ad Content -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tagline *</label>
                    <input type="text" id="adTagline" placeholder="Catchy tagline for your ad" maxlength="60" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    <p class="text-xs text-gray-500 mt-1">Keep it short and memorable (max 60 characters)</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description *</label>
                    <textarea id="adDescription" placeholder="Describe your product or service..." rows="3" maxlength="150" class="w-full p-3 border border-gray-300 rounded-lg resize-none" required></textarea>
                    <p class="text-xs text-gray-500 mt-1">Brief description (max 150 characters)</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Preview Image URL *</label>
                    <input type="url" id="adPreviewImage" placeholder="https://example.com/preview.jpg" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    <p class="text-xs text-gray-500 mt-1">High-quality image that represents your brand</p>
                </div>

                <!-- Call to Action -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Call to Action Text</label>
                        <select id="adCtaText" class="w-full p-3 border border-gray-300 rounded-lg">
                            <option value="Learn More">Learn More</option>
                            <option value="Shop Now">Shop Now</option>
                            <option value="Get Started">Get Started</option>
                            <option value="Download App">Download App</option>
                            <option value="Sign Up">Sign Up</option>
                            <option value="Visit Website">Visit Website</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Destination URL *</label>
                        <input type="url" id="adCtaLink" placeholder="https://yourwebsite.com" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    </div>
                </div>

                <!-- Targeting -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">Target Audience</label>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" value="art" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="text-sm">Art & Design</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" value="food" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="text-sm">Food & Drink</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" value="travel" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="text-sm">Travel</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" value="fashion" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="text-sm">Fashion</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" value="nature" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="text-sm">Nature</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" value="photography" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="text-sm">Photography</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" value="lifestyle" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="text-sm">Lifestyle</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" value="general" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="text-sm">General</span>
                        </label>
                    </div>
                </div>

                <!-- Budget -->
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-blue-900 mb-3">Campaign Budget</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-blue-700 mb-2">Daily Budget</label>
                            <div class="relative">
                                <span class="absolute left-3 top-3 text-gray-500">$</span>
                                <input type="number" id="adDailyBudget" min="10" max="1000" placeholder="50" class="w-full pl-8 pr-3 py-3 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <p class="text-xs text-blue-600 mt-1">Minimum $10/day</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-blue-700 mb-2">Campaign Duration</label>
                            <select id="adDuration" class="w-full p-3 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="7">7 days</option>
                                <option value="14">14 days</option>
                                <option value="30">30 days</option>
                                <option value="60">60 days</option>
                                <option value="90">90 days</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-3 p-3 bg-white rounded border border-blue-200">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-blue-700">Estimated Total Cost:</span>
                            <span class="font-bold text-blue-900" id="estimatedCost">$350</span>
                        </div>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-xs text-blue-600">Estimated Reach:</span>
                            <span class="text-xs font-semibold text-blue-800" id="estimatedReach">5,000-15,000 users</span>
                        </div>
                    </div>
                </div>

                <!-- Create Campaign Button -->
                <button onclick="createAdCampaign()" id="createAdBtn" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white py-4 rounded-lg hover:from-purple-700 hover:to-blue-700 transition-all font-medium text-lg shadow-lg">
                    <span id="createAdBtnText">Launch Campaign</span>
                    <div id="createAdSpinner" class="loading-spinner ml-2 hidden"></div>
                </button>
            </div>
        </div>
    </div>

    <!-- Repix Modal -->
    <div id="repixModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white p-6 border-b border-purple-200">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-r from-purple-600 to-pink-600 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">Create Repix</h3>
                    </div>
                    <button onclick="closeRepixModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="p-6 space-y-6">
                <!-- Original Content Preview -->
                <div class="bg-gray-50 rounded-lg p-4 border-l-4 border-purple-500">
                    <div class="flex items-start space-x-4">
                        <img id="repixOriginalImage" src="" alt="Original" class="w-20 h-20 object-cover rounded-lg flex-shrink-0">
                        <div class="flex-1 min-w-0">
                            <h4 id="repixOriginalTitle" class="font-semibold text-gray-900 mb-1 truncate">Original Title</h4>
                            <p id="repixOriginalDescription" class="text-sm text-gray-600 line-clamp-2">Original description...</p>
                            <p class="text-xs text-purple-600 mt-2 font-medium">📌 Repixing this content</p>
                        </div>
                    </div>
                </div>

                <!-- User Info -->
                <div class="flex items-center space-x-3 p-4 bg-purple-50 rounded-lg">
                    <img id="repixUserPic" src="" alt="Your profile" class="w-12 h-12 rounded-full object-cover border-2 border-purple-300">
                    <div>
                        <p id="repixUserName" class="font-semibold text-gray-900">Your Profile</p>
                        <p class="text-sm text-purple-600">Adding your perspective</p>
                    </div>
                </div>

                <!-- Quote Input -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Your Quote</label>
                    <textarea id="repixQuote" placeholder="Add your thoughts, opinion, or quote about this content..." rows="4" maxlength="280" class="w-full p-4 border-2 border-purple-200 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500" oninput="updateRepixCharCount()"></textarea>
                    <div class="flex justify-between items-center mt-2">
                        <p class="text-xs text-gray-500">Share your perspective on this content</p>
                        <span id="repixCharCount" class="text-xs text-gray-500">0/280</span>
                    </div>
                </div>

                <!-- Board Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                    <select id="repixBoardSelect" class="w-full p-3 border-2 border-purple-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                        <option value="general">General</option>
                        <option value="art">Art & Design</option>
                        <option value="food">Food & Drink</option>
                        <option value="travel">Travel</option>
                        <option value="fashion">Fashion</option>
                        <option value="nature">Nature</option>
                        <option value="photography">Photography</option>
                        <option value="lifestyle">Lifestyle</option>
                        <option value="shopping">Shopping & Products</option>
                        <option value="technology">Technology</option>
                    </select>
                </div>

                <!-- Create Button -->
                <button onclick="createRepix()" id="repixBtn" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 rounded-lg hover:from-purple-700 hover:to-pink-700 transition-all font-medium text-lg shadow-lg repix-btn">
                    <span id="repixBtnText">Create Repix</span>
                    <div id="repixSpinner" class="loading-spinner ml-2 hidden"></div>
                </button>
                
                <div class="text-center">
                    <p class="text-xs text-gray-500">Repix allows you to share content with your own commentary, similar to quote tweets</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Support Dialog -->
    <div id="supportDialog" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[60] flex items-center justify-center p-4 error-dialog">
        <div class="bg-white rounded-lg max-w-md w-full p-6 shadow-2xl">
            <div class="flex items-center mb-4">
                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-gray-900">You Matter ❤️</h3>
            </div>
            <div class="text-gray-600 mb-6">
                <p class="mb-3">If you're going through a tough time, please know that you're not alone. There are people who care and want to help.</p>
                <div class="bg-blue-50 p-4 rounded-lg">
                    <p class="font-semibold text-blue-800 mb-2">Crisis Support:</p>
                    <p class="text-sm text-blue-700">🇺🇸 National Suicide Prevention Lifeline: 988</p>
                    <p class="text-sm text-blue-700">🇬🇧 Samaritans: 116 123</p>
                    <p class="text-sm text-blue-700">🌍 International: befrienders.org</p>
                </div>
                <p class="mt-3 text-sm">Your life has value and meaning. Please reach out for support.</p>
            </div>
            <div class="flex justify-end">
                <button onclick="closeSupportDialog()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                    Thank You
                </button>
            </div>
        </div>
    </div>



    <input type="file" id="profilePicInput" accept="image/*" class="hidden">

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDjfNlHwhT4xYb7vVym_SAqMlSuY_TMz0o",
            authDomain: "orioplay.firebaseapp.com",
            databaseURL: "https://orioplay-default-rtdb.firebaseio.com",
            projectId: "orioplay",
            storageBucket: "orioplay.firebasestorage.app",
            messagingSenderId: "300811706751",
            appId: "1:300811706751:web:bdce98b1ba7e11d34d7a4a"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // App state
        let currentUser = null;
        let allImages = [];
        let savedImages = [];
        let userImages = [];
        let currentImageId = null;
        let currentRepixImageId = null;
        let currentView = 'home';
        let lastFailedAction = null;
        let userInterests = {};
        let personalizedFeed = [];
        let userActivity = {
            searches: [],
            saves: [],
            views: [],
            interactions: []
        };

        // Error handling
        function handleError(error, userMessage = "Something went wrong. Please try again.", retryAction = null) {
            console.error('Error:', error);
            
            // Hide any loading states
            hideAllLoadingStates();
            
            // Show custom error dialog
            document.getElementById('errorMessage').textContent = userMessage;
            document.getElementById('errorDialog').classList.remove('hidden');
            
            // Store retry action
            lastFailedAction = retryAction;
            
            // Show/hide retry button based on whether retry action exists
            const retryBtn = document.getElementById('retryBtn');
            if (retryAction) {
                retryBtn.classList.remove('hidden');
            } else {
                retryBtn.classList.add('hidden');
            }
        }

        function closeErrorDialog() {
            document.getElementById('errorDialog').classList.add('hidden');
            lastFailedAction = null;
        }

        function retryLastAction() {
            closeErrorDialog();
            if (lastFailedAction) {
                lastFailedAction();
            }
        }

        function showSuccess(message) {
            document.getElementById('successMessage').textContent = message;
            const toast = document.getElementById('successToast');
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        function hideAllLoadingStates() {
            document.getElementById('uploadSpinner').classList.add('hidden');
            document.getElementById('uploadBtnText').textContent = 'Create Pin';
            document.getElementById('uploadBtn').disabled = false;
        }

        // Ad interaction functions
        function hideAd(adId, event) {
            event.stopPropagation();
            // Show close options modal
            showAdCloseOptions(adId);
        }

        function showAdCloseOptions(adId) {
            const modal = document.createElement('div');
            modal.id = 'adCloseModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-[70] flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-sm w-full p-6 shadow-2xl">
                    <div class="text-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Close Ad</h3>
                        <p class="text-sm text-gray-600">Choose an option:</p>
                    </div>
                    
                    <div class="space-y-3">
                        <button onclick="closeAdModal()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-800 py-3 px-4 rounded-lg transition-colors font-medium">
                            ← Back
                        </button>
                        <button onclick="showAdReasons('${adId}')" class="w-full bg-red-600 hover:bg-red-700 text-white py-3 px-4 rounded-lg transition-colors font-medium">
                            Why am I seeing this ad?
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showAdReasons(adId) {
            const modal = document.getElementById('adCloseModal');
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-sm w-full p-6 shadow-2xl">
                    <div class="text-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Why this ad?</h3>
                        <p class="text-sm text-gray-600">Select a reason to close this ad:</p>
                    </div>
                    
                    <div class="space-y-3">
                        <button onclick="closeAdWithReason('${adId}', 'not-interested')" class="w-full text-left bg-gray-50 hover:bg-gray-100 text-gray-800 py-3 px-4 rounded-lg transition-colors">
                            <div class="font-medium">Not interested</div>
                            <div class="text-xs text-gray-600">This ad doesn't interest me</div>
                        </button>
                        
                        <button onclick="closeAdWithReason('${adId}', 'irrelevant')" class="w-full text-left bg-gray-50 hover:bg-gray-100 text-gray-800 py-3 px-4 rounded-lg transition-colors">
                            <div class="font-medium">Irrelevant</div>
                            <div class="text-xs text-gray-600">This ad is not relevant to me</div>
                        </button>
                        
                        <button onclick="closeAdWithReason('${adId}', 'repetitive')" class="w-full text-left bg-gray-50 hover:bg-gray-100 text-gray-800 py-3 px-4 rounded-lg transition-colors">
                            <div class="font-medium">Repetitive</div>
                            <div class="text-xs text-gray-600">I've seen this ad too many times</div>
                        </button>
                        
                        <button onclick="closeAdWithReason('${adId}', 'inappropriate')" class="w-full text-left bg-gray-50 hover:bg-gray-100 text-gray-800 py-3 px-4 rounded-lg transition-colors">
                            <div class="font-medium">Inappropriate</div>
                            <div class="text-xs text-gray-600">This ad is inappropriate</div>
                        </button>
                        
                        <button onclick="closeAdModal()" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg transition-colors text-sm">
                            ← Back
                        </button>
                    </div>
                </div>
            `;
        }

        function closeAdWithReason(adId, reason) {
            // Hide the ad element
            const adElements = document.querySelectorAll(`[data-ad-id="${adId}"]`);
            adElements.forEach(element => {
                element.style.display = 'none';
            });
            
            // Close modal
            closeAdModal();
            
            // Show success message based on reason
            const messages = {
                'not-interested': 'Ad hidden. We\'ll show you fewer ads like this.',
                'irrelevant': 'Ad hidden. We\'ll improve your ad experience.',
                'repetitive': 'Ad hidden. We\'ll reduce similar ads.',
                'inappropriate': 'Ad reported and hidden. Thank you for your feedback.'
            };
            
            showSuccess(messages[reason] || 'Ad hidden');
            
            // Track ad feedback (optional)
            if (currentUser) {
                database.ref(`adFeedback/${currentUser.uid}/${adId}`).set({
                    reason: reason,
                    timestamp: Date.now()
                }).catch(error => {
                    console.error('Failed to save ad feedback:', error);
                });
            }
        }

        function closeAdModal() {
            const modal = document.getElementById('adCloseModal');
            if (modal) {
                modal.remove();
            }
        }

        function openAdLink(link) {
            if (link) {
                window.open(link, '_blank');
            }
        }

        // Sample images data
        const sampleImages = [
            { title: "Beautiful Sunset", description: "Amazing sunset over the mountains #nature #sunset #mountains", board: "nature", url: "https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400" },
            { title: "City Lights", description: "Urban nightscape with glowing lights #city #night #urban", board: "photography", url: "https://images.unsplash.com/photo-1519501025264-65ba15a82390?w=400" },
            { title: "Ocean Waves", description: "Peaceful ocean waves on sandy beach #ocean #beach #waves", board: "nature", url: "https://images.unsplash.com/photo-1505142468610-359e7d316be0?w=400" },
            { title: "Mountain Peak", description: "Snow-capped mountain peak in winter #mountain #snow #winter", board: "nature", url: "https://images.unsplash.com/photo-1464822759844-d150baec0494?w=400" },
            { title: "Forest Path", description: "Mysterious forest path in autumn #forest #autumn #path", board: "nature", url: "https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=400" },
            { title: "Coffee Art", description: "Beautiful latte art in morning coffee #coffee #art #morning", board: "food", url: "https://images.unsplash.com/photo-1495474472287-4d71bcdd2085?w=400" },
            { title: "Street Art", description: "Colorful street art on urban wall #streetart #urban #colorful", board: "art", url: "https://images.unsplash.com/photo-1541961017774-22349e4a1262?w=400" },
            { title: "Desert Landscape", description: "Vast desert with sand dunes #desert #landscape #sand", board: "nature", url: "https://images.unsplash.com/photo-1509316785289-025f5b846b35?w=400" },
            { title: "City Architecture", description: "Modern skyscrapers reaching the sky #architecture #city #modern", board: "photography", url: "https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=400" },
            { title: "Flower Garden", description: "Colorful flowers in spring garden #flowers #spring #garden", board: "nature", url: "https://images.unsplash.com/photo-1416879595882-3373a0480b5b?w=400" },
            { title: "Night Sky", description: "Starry night sky with milky way #stars #night #astronomy", board: "nature", url: "https://images.unsplash.com/photo-1419242902214-272b3f66ee7a?w=400" },
            { title: "Fashion Style", description: "Trendy fashion outfit for summer #fashion #style #summer", board: "fashion", url: "https://images.unsplash.com/photo-1515886657613-9f3515b0c78f?w=400" },
            { title: "Food Photography", description: "Delicious pasta dish with herbs #food #pasta #delicious", board: "food", url: "https://images.unsplash.com/photo-1551782450-a2132b4ba21d?w=400" },
            { title: "Travel Adventure", description: "Backpacking through scenic mountains #travel #adventure #backpacking", board: "travel", url: "https://images.unsplash.com/photo-1501594907352-04cda38ebc29?w=400" },
            { title: "Abstract Art", description: "Modern abstract painting with bold colors #abstract #art #modern", board: "art", url: "https://images.unsplash.com/photo-1541961017774-22349e4a1262?w=400" },
            { title: "Vintage Car", description: "Classic vintage car on country road #vintage #car #classic", board: "lifestyle", url: "https://images.unsplash.com/photo-1503376780353-7e6692767b70?w=400" },
            { title: "Yoga Practice", description: "Morning yoga session by the lake #yoga #meditation #wellness", board: "lifestyle", url: "https://images.unsplash.com/photo-1506629905607-45c8d7b6b3b3?w=400" },
            { title: "Book Collection", description: "Cozy reading corner with vintage books #books #reading #cozy", board: "lifestyle", url: "https://images.unsplash.com/photo-1481627834876-b7833e8f5570?w=400" },
            { title: "Minimalist Design", description: "Clean minimalist interior design #minimalist #design #interior", board: "art", url: "https://images.unsplash.com/photo-1586023492125-27b2c045efd7?w=400" },
            { title: "Wildlife Photography", description: "Majestic eagle soaring through clouds #wildlife #eagle #nature", board: "photography", url: "https://images.unsplash.com/photo-1441471349424-351990746ff4?w=400" },
            { title: "Beach Sunset", description: "Romantic sunset on tropical beach #beach #sunset #tropical", board: "travel", url: "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=400" },
            { title: "Urban Street", description: "Busy city street with pedestrians #urban #street #city", board: "photography", url: "https://images.unsplash.com/photo-1477959858617-67f85cf4f1df?w=400" },
            { title: "Healthy Food", description: "Fresh salad with organic vegetables #healthy #food #organic", board: "food", url: "https://images.unsplash.com/photo-1512621776951-a57141f2eefd?w=400" },
            { title: "Mountain Lake", description: "Crystal clear lake surrounded by mountains #lake #mountains #nature", board: "nature", url: "https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400" },
            { title: "Art Gallery", description: "Modern art exhibition in gallery #art #gallery #exhibition", board: "art", url: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400" },
            { title: "Cozy Cafe", description: "Warm and inviting coffee shop interior #cafe #cozy #coffee", board: "lifestyle", url: "https://images.unsplash.com/photo-1554118811-1e0d58224f24?w=400" },
            { title: "Fashion Portrait", description: "Stylish portrait with dramatic lighting #portrait #fashion #style", board: "fashion", url: "https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?w=400" },
            { title: "Garden Flowers", description: "Beautiful roses in bloom #roses #garden #flowers", board: "nature", url: "https://images.unsplash.com/photo-1518709268805-4e9042af2176?w=400" },
            { title: "City Skyline", description: "Panoramic city skyline at dusk #skyline #city #dusk", board: "photography", url: "https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=400" },
            { title: "Workout Session", description: "Intense gym workout routine #fitness #gym #workout", board: "lifestyle", url: "https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=400" },
            { title: "Autumn Leaves", description: "Golden autumn leaves falling #autumn #leaves #golden", board: "nature", url: "https://images.unsplash.com/photo-1507041957456-9c397ce39c97?w=400" },
            { title: "Technology", description: "Modern smartphone with apps #technology #smartphone #modern", board: "lifestyle", url: "https://images.unsplash.com/photo-1512941937669-90a1b58e7e9c?w=400" },
            { title: "Dessert Art", description: "Beautifully plated chocolate dessert #dessert #chocolate #art", board: "food", url: "https://images.unsplash.com/photo-1551024506-0bccd828d307?w=400" },
            { title: "Adventure Travel", description: "Hiking trail through national park #hiking #adventure #park", board: "travel", url: "https://images.unsplash.com/photo-1551632811-561732d1e306?w=400" },
            { title: "Pet Portrait", description: "Adorable golden retriever puppy #pet #dog #puppy", board: "lifestyle", url: "https://images.unsplash.com/photo-1552053831-71594a27632d?w=400" },
            { title: "Music Concert", description: "Live music performance on stage #music #concert #live", board: "lifestyle", url: "https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?w=400" },
            { title: "Vintage Fashion", description: "Retro style clothing and accessories #vintage #fashion #retro", board: "fashion", url: "https://images.unsplash.com/photo-1445205170230-053b83016050?w=400" },
            { title: "Home Decor", description: "Scandinavian style living room #homedecor #scandinavian #interior", board: "lifestyle", url: "https://images.unsplash.com/photo-1586023492125-27b2c045efd7?w=400" },
            { title: "Street Food", description: "Delicious street tacos from food truck #streetfood #tacos #food", board: "food", url: "https://images.unsplash.com/photo-1565299624946-b28f40a0ca4b?w=400" },
            { title: "Landscape Photography", description: "Dramatic landscape with storm clouds #landscape #storm #dramatic", board: "photography", url: "https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400" },
            { title: "Art Studio", description: "Artist workspace with paints and brushes #art #studio #creative", board: "art", url: "https://images.unsplash.com/photo-1513475382585-d06e58bcb0e0?w=400" },
            { title: "Beach Vacation", description: "Relaxing beach day with clear water #beach #vacation #relaxing", board: "travel", url: "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=400" },
            { title: "Winter Sports", description: "Skiing down snowy mountain slope #skiing #winter #sports", board: "lifestyle", url: "https://images.unsplash.com/photo-1551524164-687a55dd1126?w=400" },
            { title: "Botanical Garden", description: "Exotic plants in greenhouse #botanical #plants #greenhouse", board: "nature", url: "https://images.unsplash.com/photo-1416879595882-3373a0480b5b?w=400" },
            { title: "Fashion Week", description: "Runway model in designer dress #fashion #runway #designer", board: "fashion", url: "https://images.unsplash.com/photo-1469334031218-e382a71b716b?w=400" },
            { title: "Gourmet Cooking", description: "Chef preparing gourmet meal #cooking #chef #gourmet", board: "food", url: "https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?w=400" },
            { title: "City Bridge", description: "Iconic bridge spanning river #bridge #city #architecture", board: "photography", url: "https://images.unsplash.com/photo-1477959858617-67f85cf4f1df?w=400" },
            { title: "Meditation Space", description: "Peaceful meditation corner at home #meditation #peaceful #zen", board: "lifestyle", url: "https://images.unsplash.com/photo-1506629905607-45c8d7b6b3b3?w=400" },
            { title: "Digital Art", description: "Futuristic digital artwork #digital #art #futuristic", board: "art", url: "https://images.unsplash.com/photo-1541961017774-22349e4a1262?w=400" },
            { title: "Road Trip", description: "Open road through desert landscape #roadtrip #desert #adventure", board: "travel", url: "https://images.unsplash.com/photo-1469474968028-56623f02e42e?w=400" }
        ];

        // Disable right-click context menu
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });

        // Disable common keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Disable F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U, Ctrl+S, Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
            if (e.keyCode === 123 || // F12
                (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74)) || // Ctrl+Shift+I/J
                (e.ctrlKey && (e.keyCode === 85 || e.keyCode === 83 || e.keyCode === 65 || e.keyCode === 67 || e.keyCode === 86 || e.keyCode === 88)) || // Ctrl+U/S/A/C/V/X
                (e.ctrlKey && e.keyCode === 80) || // Ctrl+P
                (e.metaKey && (e.keyCode === 65 || e.keyCode === 67 || e.keyCode === 86 || e.keyCode === 88))) { // Cmd+A/C/V/X on Mac
                e.preventDefault();
                return false;
            }
        });

        // Disable text selection with mouse
        document.addEventListener('selectstart', function(e) {
            if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
                return false;
            }
        });

        // Disable drag and drop
        document.addEventListener('dragstart', function(e) {
            e.preventDefault();
            return false;
        });

        // Disable zoom gestures on mobile
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // Prevent zoom on double tap
        let lastTap = 0;
        document.addEventListener('touchstart', function(event) {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTap;
            if (tapLength < 500 && tapLength > 0) {
                event.preventDefault();
            }
            lastTap = currentTime;
        });

        // Loading Animation Functions
        function showLoadingAnimation() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingGrid = document.getElementById('loadingGrid');
            
            // Show loading overlay
            loadingOverlay.classList.remove('hidden');
            
            // Generate loading cards
            generateLoadingCards();
        }
        
        function hideLoadingAnimation() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            
            // Hide loading overlay with smooth transition
            setTimeout(() => {
                loadingOverlay.classList.add('hidden');
            }, 500); // Small delay to show content loading
        }
        
        function generateLoadingCards() {
            const loadingGrid = document.getElementById('loadingGrid');
            const cardCount = getOptimalCardCount();
            
            loadingGrid.innerHTML = '';
            
            for (let i = 0; i < cardCount; i++) {
                const loadingCard = createLoadingCard();
                loadingGrid.appendChild(loadingCard);
            }
        }
        
        function getOptimalCardCount() {
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;
            
            // Calculate approximate cards that fit on screen
            let cardsPerRow, cardHeight, visibleRows;
            
            if (screenWidth < 480) {
                cardsPerRow = Math.floor(screenWidth / 160);
                cardHeight = 280;
            } else if (screenWidth < 768) {
                cardsPerRow = Math.floor(screenWidth / 200);
                cardHeight = 300;
            } else if (screenWidth < 1024) {
                cardsPerRow = Math.floor(screenWidth / 236);
                cardHeight = 320;
            } else {
                cardsPerRow = Math.floor(screenWidth / 252);
                cardHeight = 340;
            }
            
            visibleRows = Math.ceil((screenHeight - 120) / cardHeight); // 120px for header/nav
            
            // Add extra rows for scrolling effect
            return Math.max(12, cardsPerRow * (visibleRows + 2));
        }
        
        function createLoadingCard() {
            const card = document.createElement('div');
            card.className = 'loading-card';
            
            // Random height for variety
            const heights = [200, 250, 300, 350, 280, 320];
            const randomHeight = heights[Math.floor(Math.random() * heights.length)];
            
            card.innerHTML = `
                <div class="loading-image" style="height: ${randomHeight}px;"></div>
                <div style="padding: 12px;">
                    <div class="loading-text ${getRandomTextLength()}"></div>
                    <div class="loading-text ${getRandomTextLength()}"></div>
                    <div class="loading-text short"></div>
                </div>
            `;
            
            return card;
        }
        
        function getRandomTextLength() {
            const lengths = ['short', 'medium', 'long'];
            return lengths[Math.floor(Math.random() * lengths.length)];
        }

        // URL Navigation Functions
        function updateURL(imageId) {
            if (imageId) {
                window.history.pushState({ imageId }, '', `#${imageId}`);
            } else {
                window.history.pushState({}, '', window.location.pathname);
            }
        }

        function handleURLNavigation() {
            const hash = window.location.hash.substring(1); // Remove #
            if (hash && hash.length > 0) {
                // Check if it's a valid image ID
                setTimeout(() => {
                    const image = allImages.find(img => img.id === hash);
                    if (image) {
                        openImageModal(hash);
                    }
                }, 1000); // Wait for images to load
            }
        }

        // Handle browser back/forward buttons
        window.addEventListener('popstate', function(event) {
            if (event.state && event.state.imageId) {
                openImageModal(event.state.imageId);
            } else {
                closeImageModal();
            }
        });

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Show loading animation immediately
            showLoadingAnimation();
            
            // Override console.error to catch any unhandled errors
            const originalConsoleError = console.error;
            console.error = function(...args) {
                originalConsoleError.apply(console, args);
                // Only show dialog for actual errors, not warnings
                if (args[0] && typeof args[0] === 'string' && args[0].toLowerCase().includes('error')) {
                    handleError(args[0], "An unexpected error occurred. Please refresh the page if the problem persists.");
                }
            };

            // Global error handler
            window.addEventListener('error', function(event) {
                handleError(event.error, "An unexpected error occurred. Please refresh the page if the problem persists.");
            });

            // Promise rejection handler
            window.addEventListener('unhandledrejection', function(event) {
                handleError(event.reason, "A network error occurred. Please check your connection and try again.");
            });

            // Always show main app first (but keep loading overlay)
            showMainApp();
            
            // Track loading completion
            let loadingSteps = {
                auth: false,
                images: false,
                ads: false,
                samples: false
            };
            
            function checkLoadingComplete() {
                if (Object.values(loadingSteps).every(step => step)) {
                    // All loading steps complete, hide loading animation
                    setTimeout(() => {
                        hideLoadingAnimation();
                    }, 800); // Small delay to show smooth transition
                }
            }
            
            // Check if user is already logged in
            auth.onAuthStateChanged(user => {
                try {
                    if (user) {
                        currentUser = user;
                        updateUIForLoggedInUser();
                        loadUserData();
                        
                        // Load content with completion tracking
                        loadAllImagesWithCallback(() => {
                            loadingSteps.images = true;
                            checkLoadingComplete();
                        });
                        
                        loadAdsWithCallback(() => {
                            loadingSteps.ads = true;
                            checkLoadingComplete();
                        });
                        
                        uploadSampleImagesWithCallback(() => {
                            loadingSteps.samples = true;
                            checkLoadingComplete();
                        });
                        
                        showHome();
                    } else {
                        currentUser = null;
                        updateUIForGuestUser();
                        
                        // Load content with completion tracking
                        loadAllImagesWithCallback(() => {
                            loadingSteps.images = true;
                            checkLoadingComplete();
                        });
                        
                        loadAdsWithCallback(() => {
                            loadingSteps.ads = true;
                            checkLoadingComplete();
                        });
                        
                        uploadSampleImagesWithCallback(() => {
                            loadingSteps.samples = true;
                            checkLoadingComplete();
                        });
                        
                        showHome();
                    }
                    
                    // Auth step complete
                    loadingSteps.auth = true;
                    checkLoadingComplete();
                    
                    // Handle URL navigation after auth
                    setTimeout(() => {
                        handleURLNavigation();
                    }, 1500);

                } catch (error) {
                    hideLoadingAnimation();
                    handleError(error, "Failed to initialize app. Please refresh the page.");
                }
            });

            // Search functionality
            document.getElementById('searchInput').addEventListener('input', function(e) {
                try {
                    filterImages(e.target.value);
                } catch (error) {
                    handleError(error, "Search failed. Please try again.");
                }
            });

            // Mobile search functionality
            document.getElementById('mobileSearchInput').addEventListener('input', function(e) {
                try {
                    filterImagesInModal(e.target.value);
                } catch (error) {
                    handleError(error, "Search failed. Please try again.");
                }
            });

            // Profile picture input
            document.getElementById('profilePicInput').addEventListener('change', handleProfilePicChange);
        });

        // Authentication functions
        function signInWithGoogle() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(provider).catch(error => {
                    if (error.code === 'auth/popup-closed-by-user') {
                        // User closed popup, don't show error
                        return;
                    }
                    handleError(error, "Sign in failed. Please try again.", signInWithGoogle);
                });
            } catch (error) {
                handleError(error, "Sign in failed. Please try again.", signInWithGoogle);
            }
        }

        function signOut() {
            try {
                auth.signOut().catch(error => {
                    handleError(error, "Sign out failed. Please try again.", signOut);
                });
            } catch (error) {
                handleError(error, "Sign out failed. Please try again.", signOut);
            }
        }

        // UI functions
        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
        }

        function updateUIForLoggedInUser() {
            try {
                // Show user actions, hide guest actions
                document.getElementById('userActions').classList.remove('hidden');
                document.getElementById('guestActions').classList.add('hidden');
                
                // Show desktop navigation items
                document.getElementById('savedBtn').classList.remove('hidden');
                document.getElementById('myPinsBtn').classList.remove('hidden');
                
                // Update profile picture
                if (currentUser) {
                    const img = document.getElementById('headerProfilePic');
                    img.src = currentUser.photoURL || '';
                    img.onerror = function() {
                        this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiNFNUU3RUIiLz4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxMiIgcj0iNSIgZmlsbD0iIzlDQTNBRiIvPgo8cGF0aCBkPSJNNiAyNi41QzYgMjIuMzU3OSAxMC4zNTc5IDE5IDE2IDE5QzIxLjY0MjEgMTkgMjYgMjIuMzU3OSAyNiAyNi41IiBmaWxsPSIjOUNBM0FGIi8+Cjwvc3ZnPgo=';
                    };
                }
                
                // Refresh feed with personalized content
                if (currentView === 'home' && allImages.length > 0) {
                    setTimeout(() => {
                        personalizedFeed = generatePersonalizedFeed(allImages);
                        renderImages(personalizedFeed, 'imageGallery', 'emptyState');
                    }, 1000); // Small delay to allow user data to load
                }
            } catch (error) {
                console.error('Failed to update UI for logged in user:', error);
            }
        }

        // Advertiser Dashboard Functions
        function loadAdvertiserDashboard() {
            if (!currentUser) return;
            
            try {
                // Load advertiser campaigns
                database.ref(`advertisers/${currentUser.uid}/campaigns`).on('value', snapshot => {
                    const campaigns = [];
                    let totalImpressions = 0;
                    let totalClicks = 0;
                    let totalSpent = 0;
                    
                    snapshot.forEach(child => {
                        const campaign = { id: child.key, ...child.val() };
                        campaigns.push(campaign);
                        totalImpressions += campaign.impressions || 0;
                        totalClicks += campaign.clicks || 0;
                        totalSpent += campaign.spent || 0;
                    });
                    
                    // Update stats
                    document.getElementById('totalCampaigns').textContent = campaigns.length;
                    document.getElementById('totalImpressions').textContent = totalImpressions.toLocaleString();
                    document.getElementById('totalClicks').textContent = totalClicks.toLocaleString();
                    document.getElementById('totalSpent').textContent = totalSpent.toFixed(2);
                    
                    // Render campaigns
                    renderCampaigns(campaigns);
                }, error => {
                    console.error('Failed to load campaigns:', error);
                });
            } catch (error) {
                handleError(error, "Failed to load advertiser dashboard.");
            }
        }

        function renderCampaigns(campaigns) {
            const container = document.getElementById('campaignsList');
            
            if (campaigns.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">📊</div>
                        <h4 class="text-lg font-semibold text-gray-700 mb-2">No campaigns yet</h4>
                        <p class="text-gray-500 mb-6">Create your first ad campaign to start reaching customers!</p>
                        <button onclick="openCreateAdModal()" class="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-6 py-3 rounded-lg hover:from-purple-700 hover:to-blue-700 transition-all font-medium">
                            Create Campaign
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = campaigns.map(campaign => `
                <div class="border border-gray-200 rounded-lg p-6 mb-4 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center space-x-3">
                            ${campaign.logo ? `<img src="${campaign.logo}" alt="${campaign.brand}" class="w-10 h-10 rounded object-cover">` : ''}
                            <div>
                                <h4 class="font-semibold text-gray-900">${campaign.brand}</h4>
                                <p class="text-sm text-gray-600">${campaign.tagline}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${campaign.status === 'active' ? 'bg-green-100 text-green-800' : campaign.status === 'paused' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800'}">
                                ${campaign.status || 'active'}
                            </span>
                            <button onclick="toggleCampaign('${campaign.id}')" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-4 gap-4 mb-4">
                        <div class="text-center">
                            <p class="text-2xl font-bold text-blue-600">${(campaign.impressions || 0).toLocaleString()}</p>
                            <p class="text-xs text-gray-600">Impressions</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold text-green-600">${(campaign.clicks || 0).toLocaleString()}</p>
                            <p class="text-xs text-gray-600">Clicks</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold text-purple-600">${campaign.clicks && campaign.impressions ? ((campaign.clicks / campaign.impressions) * 100).toFixed(2) : '0.00'}%</p>
                            <p class="text-xs text-gray-600">CTR</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold text-orange-600">$${(campaign.spent || 0).toFixed(2)}</p>
                            <p class="text-xs text-gray-600">Spent</p>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-gray-600">
                            Budget: $${campaign.dailyBudget}/day • ${campaign.duration} days
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editCampaign('${campaign.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">Edit</button>
                            <button onclick="pauseCampaign('${campaign.id}')" class="text-yellow-600 hover:text-yellow-800 text-sm font-medium">
                                ${campaign.status === 'active' ? 'Pause' : 'Resume'}
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function openCreateAdModal() {
            document.getElementById('createAdModal').classList.remove('hidden');
            setupBudgetCalculator();
        }

        function closeCreateAdModal() {
            document.getElementById('createAdModal').classList.add('hidden');
            resetAdForm();
        }

        function setupBudgetCalculator() {
            const dailyBudgetInput = document.getElementById('adDailyBudget');
            const durationSelect = document.getElementById('adDuration');
            const estimatedCost = document.getElementById('estimatedCost');
            const estimatedReach = document.getElementById('estimatedReach');
            
            function updateEstimates() {
                const dailyBudget = parseFloat(dailyBudgetInput.value) || 50;
                const duration = parseInt(durationSelect.value) || 7;
                const totalCost = dailyBudget * duration;
                
                estimatedCost.textContent = `$${totalCost}`;
                
                // Estimate reach based on budget (rough calculation)
                const minReach = Math.floor(totalCost * 100);
                const maxReach = Math.floor(totalCost * 300);
                estimatedReach.textContent = `${minReach.toLocaleString()}-${maxReach.toLocaleString()} users`;
            }
            
            dailyBudgetInput.addEventListener('input', updateEstimates);
            durationSelect.addEventListener('change', updateEstimates);
            updateEstimates();
        }

        function createAdCampaign() {
            if (!currentUser) return;
            
            try {
                // Show loading state
                document.getElementById('createAdBtnText').textContent = 'Creating Campaign...';
                document.getElementById('createAdSpinner').classList.remove('hidden');
                document.getElementById('createAdBtn').disabled = true;
                
                // Get form data
                const campaignData = {
                    type: document.querySelector('input[name="campaignType"]:checked').value,
                    brand: document.getElementById('adBrandName').value.trim(),
                    logo: document.getElementById('adBrandLogo').value.trim(),
                    tagline: document.getElementById('adTagline').value.trim(),
                    description: document.getElementById('adDescription').value.trim(),
                    previewImage: document.getElementById('adPreviewImage').value.trim(),
                    ctaText: document.getElementById('adCtaText').value,
                    ctaLink: document.getElementById('adCtaLink').value.trim(),
                    dailyBudget: parseFloat(document.getElementById('adDailyBudget').value) || 50,
                    duration: parseInt(document.getElementById('adDuration').value) || 7,
                    targeting: Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value),
                    status: 'active',
                    createdAt: Date.now(),
                    advertiserId: currentUser.uid,
                    impressions: 0,
                    clicks: 0,
                    spent: 0
                };
                
                // Validate required fields
                if (!campaignData.brand || !campaignData.tagline || !campaignData.description || !campaignData.previewImage || !campaignData.ctaLink) {
                    throw new Error('Please fill in all required fields');
                }
                
                // Save campaign
                database.ref(`advertisers/${currentUser.uid}/campaigns`).push(campaignData).then(() => {
                    // Also add to global ads for display
                    database.ref('ads').push({
                        ...campaignData,
                        active: true
                    });
                    
                    showSuccess('Campaign created successfully! 🚀');
                    closeCreateAdModal();
                    loadAdvertiserDashboard();
                }).catch(error => {
                    throw error;
                });
                
            } catch (error) {
                // Reset loading state
                document.getElementById('createAdBtnText').textContent = 'Launch Campaign';
                document.getElementById('createAdSpinner').classList.add('hidden');
                document.getElementById('createAdBtn').disabled = false;
                
                handleError(error, error.message || "Failed to create campaign.", createAdCampaign);
            }
        }

        function resetAdForm() {
            document.getElementById('adBrandName').value = '';
            document.getElementById('adBrandLogo').value = '';
            document.getElementById('adTagline').value = '';
            document.getElementById('adDescription').value = '';
            document.getElementById('adPreviewImage').value = '';
            document.getElementById('adCtaText').value = 'Learn More';
            document.getElementById('adCtaLink').value = '';
            document.getElementById('adDailyBudget').value = '';
            document.getElementById('adDuration').value = '7';
            
            // Uncheck all targeting checkboxes
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            
            // Reset loading state
            document.getElementById('createAdBtnText').textContent = 'Launch Campaign';
            document.getElementById('createAdSpinner').classList.add('hidden');
            document.getElementById('createAdBtn').disabled = false;
        }

        function toggleCampaign(campaignId) {
            // Campaign management functions would go here
            console.log('Toggle campaign:', campaignId);
        }

        function editCampaign(campaignId) {
            // Campaign editing functions would go here
            console.log('Edit campaign:', campaignId);
        }

        function pauseCampaign(campaignId) {
            // Campaign pause/resume functions would go here
            console.log('Pause campaign:', campaignId);
        }

        function updateUIForGuestUser() {
            try {
                // Hide user actions, show guest actions
                document.getElementById('userActions').classList.add('hidden');
                document.getElementById('guestActions').classList.remove('hidden');
                
                // Hide desktop navigation items
                document.getElementById('savedBtn').classList.add('hidden');
                document.getElementById('myPinsBtn').classList.add('hidden');
            } catch (error) {
                console.error('Failed to update UI for guest user:', error);
            }
        }

        function requireLogin(callback) {
            if (!currentUser) {
                signInWithGoogle();
                return;
            }
            callback();
        }

        function handleProfileClick() {
            if (currentUser) {
                showMyPins();
            } else {
                signInWithGoogle();
            }
        }

        function toggleProfileMenu() {
            const menu = document.getElementById('profileMenu');
            menu.classList.toggle('hidden');
        }

        // Navigation functions
        function showHome() {
            try {
                setActiveView('home');
                document.getElementById('homeView').classList.remove('hidden');
                document.getElementById('savedView').classList.add('hidden');
                document.getElementById('myPinsView').classList.add('hidden');
                document.getElementById('settingsView').classList.add('hidden');
                loadAllImages();
            } catch (error) {
                handleError(error, "Failed to load home page.", showHome);
            }
        }

        function showSaved() {
            try {
                setActiveView('saved');
                document.getElementById('homeView').classList.add('hidden');
                document.getElementById('savedView').classList.remove('hidden');
                document.getElementById('myPinsView').classList.add('hidden');
                document.getElementById('settingsView').classList.add('hidden');
                loadSavedImages();
            } catch (error) {
                handleError(error, "Failed to load saved pins.", showSaved);
            }
        }

        function showMyPins() {
            try {
                setActiveView('myPins');
                document.getElementById('homeView').classList.add('hidden');
                document.getElementById('savedView').classList.add('hidden');
                document.getElementById('myPinsView').classList.remove('hidden');
                document.getElementById('settingsView').classList.add('hidden');
                loadUserImages();
            } catch (error) {
                handleError(error, "Failed to load your pins.", showMyPins);
            }
        }

        function showAdvertiser() {
            try {
                setActiveView('advertiser');
                document.getElementById('homeView').classList.add('hidden');
                document.getElementById('savedView').classList.add('hidden');
                document.getElementById('myPinsView').classList.add('hidden');
                document.getElementById('settingsView').classList.add('hidden');
                document.getElementById('advertiserView').classList.remove('hidden');
                loadAdvertiserDashboard();
            } catch (error) {
                handleError(error, "Failed to load advertiser dashboard.", showAdvertiser);
            }
        }

        function showSettings() {
            try {
                setActiveView('settings');
                document.getElementById('homeView').classList.add('hidden');
                document.getElementById('savedView').classList.add('hidden');
                document.getElementById('myPinsView').classList.add('hidden');
                document.getElementById('settingsView').classList.remove('hidden');
                document.getElementById('advertiserView').classList.add('hidden');
                document.getElementById('profileMenu').classList.add('hidden');
                loadUserProfile();
            } catch (error) {
                handleError(error, "Failed to load settings.", showSettings);
            }
        }

        function setActiveView(view) {
            currentView = view;
            
            // Update desktop navigation buttons
            document.querySelectorAll('.desktop-nav button').forEach(btn => {
                btn.classList.remove('text-red-600', 'border-red-600');
                btn.classList.add('text-gray-700', 'border-transparent');
            });
            
            const activeBtn = document.getElementById(view + 'Btn');
            if (activeBtn) {
                activeBtn.classList.remove('text-gray-700', 'border-transparent');
                activeBtn.classList.add('text-red-600', 'border-red-600');
            }
            
            // Update mobile navigation
            document.querySelectorAll('.bottom-nav .nav-item').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const mobileBtn = document.getElementById('mobile' + view.charAt(0).toUpperCase() + view.slice(1) + 'Btn');
            if (mobileBtn) {
                mobileBtn.classList.add('active');
            } else if (view === 'home') {
                document.getElementById('mobileHomeBtn').classList.add('active');
            }
        }

        function showProfile() {
            if (currentUser) {
                showMyPins();
            }
        }

        function openSearchModal() {
            document.getElementById('searchModal').classList.remove('hidden');
            document.getElementById('mobileSearchInput').focus();
        }

        function closeSearchModal() {
            document.getElementById('searchModal').classList.add('hidden');
            document.getElementById('mobileSearchInput').value = '';
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('noSearchResults').classList.add('hidden');
        }

        // Data loading functions
        function loadUserData() {
            if (!currentUser) return;
            
            try {
                // Load user profile
                database.ref(`users/${currentUser.uid}`).once('value', snapshot => {
                    const userData = snapshot.val();
                    if (!userData) {
                        // Create user profile
                        database.ref(`users/${currentUser.uid}`).set({
                            displayName: currentUser.displayName,
                            email: currentUser.email,
                            photoURL: currentUser.photoURL,
                            bio: '',
                            createdAt: Date.now(),
                            interests: {},
                            activity: {
                                searches: [],
                                saves: [],
                                views: [],
                                interactions: []
                            }
                        }).catch(error => {
                            handleError(error, "Failed to create user profile.");
                        });
                    } else {
                        // Load user interests and activity
                        userInterests = userData.interests || {};
                        userActivity = userData.activity || {
                            searches: [],
                            saves: [],
                            views: [],
                            interactions: []
                        };
                    }
                }).catch(error => {
                    handleError(error, "Failed to load user data.");
                });

                // Load saved images
                database.ref(`saved/${currentUser.uid}`).on('value', snapshot => {
                    savedImages = [];
                    snapshot.forEach(child => {
                        savedImages.push(child.key);
                    });
                    // Update interests based on saved images
                    updateInterestsFromSaves();
                }, error => {
                    handleError(error, "Failed to load saved images.");
                });
            } catch (error) {
                handleError(error, "Failed to initialize user data.");
            }
        }

        // Optimized click functionality for images
        function setupImageClick(imageElement, imageData) {
            imageElement.addEventListener('click', function(e) {
                // Prevent multiple clicks
                if (imageElement.dataset.clicking === 'true') return;
                imageElement.dataset.clicking = 'true';
                
                // Single click - open modal immediately
                openImageModal(imageData.id);
                
                // Reset click state after a short delay
                setTimeout(() => {
                    imageElement.dataset.clicking = 'false';
                }, 300);
            });
        }

        // Personalization Algorithm Functions
        function generatePersonalizedFeed(images) {
            if (!currentUser || Object.keys(userInterests).length === 0) {
                // New user or no interests yet - show diverse content
                return shuffleArray([...images]).slice(0, 50);
            }
            
            const scoredImages = images.map(image => ({
                ...image,
                score: calculateImageScore(image)
            }));
            
            // Sort by score (highest first) and add some randomness
            scoredImages.sort((a, b) => {
                const scoreDiff = b.score - a.score;
                // Add small random factor to prevent identical feeds
                const randomFactor = (Math.random() - 0.5) * 0.1;
                return scoreDiff + randomFactor;
            });
            
            // Mix high-scoring content with some fresh/diverse content
            const highScoring = scoredImages.slice(0, Math.floor(scoredImages.length * 0.7));
            const diverse = shuffleArray(scoredImages.slice(Math.floor(scoredImages.length * 0.7)));
            
            return [...highScoring, ...diverse].slice(0, 100);
        }
        
        function calculateImageScore(image) {
            let score = 0;
            
            // Base recency score (newer content gets slight boost)
            const daysSinceCreated = (Date.now() - (image.createdAt || 0)) / (1000 * 60 * 60 * 24);
            score += Math.max(0, 10 - daysSinceCreated * 0.1);
            
            // Interest matching
            const imageKeywords = extractImageKeywords(image);
            imageKeywords.forEach(keyword => {
                if (userInterests[keyword]) {
                    score += userInterests[keyword] * 10;
                }
            });
            
            // Board preference
            if (userInterests[image.board]) {
                score += userInterests[image.board] * 5;
            }
            
            // Author preference (if user has interacted with this author before)
            if (userInterests[`author_${image.authorId}`]) {
                score += userInterests[`author_${image.authorId}`] * 3;
            }
            
            // Popularity boost (but not too much to avoid echo chamber)
            score += Math.log(1 + (image.views || 0)) * 0.5;
            
            // Avoid showing user's own content in feed
            if (image.authorId === currentUser?.uid) {
                score *= 0.1;
            }
            
            return score;
        }
        
        function extractImageKeywords(image) {
            const keywords = [];
            
            // Extract from description
            if (image.description) {
                const words = image.description.toLowerCase()
                    .replace(/[^\w\s]/g, ' ')
                    .split(/\s+/)
                    .filter(word => word.length > 2);
                keywords.push(...words);
            }
            
            // Extract from title
            if (image.title) {
                const words = image.title.toLowerCase()
                    .replace(/[^\w\s]/g, ' ')
                    .split(/\s+/)
                    .filter(word => word.length > 2);
                keywords.push(...words);
            }
            
            // Add board as keyword
            if (image.board) {
                keywords.push(image.board);
            }
            
            return [...new Set(keywords)]; // Remove duplicates
        }
        
        function updateUserInterests(keywords, weight = 1) {
            if (!currentUser) return;
            
            keywords.forEach(keyword => {
                if (keyword && keyword.length > 2) {
                    userInterests[keyword] = (userInterests[keyword] || 0) + weight;
                    
                    // Cap interest levels to prevent over-specialization
                    if (userInterests[keyword] > 10) {
                        userInterests[keyword] = 10;
                    }
                }
            });
            
            // Decay old interests slightly to allow for changing preferences
            Object.keys(userInterests).forEach(key => {
                userInterests[key] *= 0.999;
                if (userInterests[key] < 0.1) {
                    delete userInterests[key];
                }
            });
            
            // Save to database (throttled)
            saveUserInterests();
        }
        
        function updateInterestsFromSaves() {
            if (!currentUser || savedImages.length === 0) return;
            
            savedImages.forEach(imageId => {
                const image = allImages.find(img => img.id === imageId);
                if (image) {
                    const keywords = extractImageKeywords(image);
                    updateUserInterests(keywords, 2); // Higher weight for saved content
                    updateUserInterests([image.board], 1.5);
                    updateUserInterests([`author_${image.authorId}`], 1);
                }
            });
        }
        
        function trackUserActivity(type, data) {
            if (!currentUser) return;
            
            const activity = {
                type,
                data,
                timestamp: Date.now()
            };
            
            userActivity[type] = userActivity[type] || [];
            userActivity[type].unshift(activity);
            
            // Keep only recent activity (last 100 items per type)
            if (userActivity[type].length > 100) {
                userActivity[type] = userActivity[type].slice(0, 100);
            }
            
            // Update interests based on activity
            if (type === 'searches' && data.query) {
                const keywords = data.query.toLowerCase().split(/\s+/).filter(w => w.length > 2);
                updateUserInterests(keywords, 0.5);
            }
            
            // Save activity (throttled)
            saveUserActivity();
        }
        
        let saveInterestsTimeout;
        function saveUserInterests() {
            if (!currentUser) return;
            
            clearTimeout(saveInterestsTimeout);
            saveInterestsTimeout = setTimeout(() => {
                database.ref(`users/${currentUser.uid}/interests`).set(userInterests).catch(error => {
                    console.error('Failed to save user interests:', error);
                });
            }, 2000);
        }
        
        let saveActivityTimeout;
        function saveUserActivity() {
            if (!currentUser) return;
            
            clearTimeout(saveActivityTimeout);
            saveActivityTimeout = setTimeout(() => {
                database.ref(`users/${currentUser.uid}/activity`).set(userActivity).catch(error => {
                    console.error('Failed to save user activity:', error);
                });
            }, 5000);
        }
        
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }



        // Upload sample images function
        function uploadSampleImages() {
            database.ref('images').once('value', snapshot => {
                if (!snapshot.exists() || snapshot.numChildren() < 10) {
                    console.log('Uploading sample images...');
                    sampleImages.forEach((image, index) => {
                        setTimeout(() => {
                            const imageData = {
                                ...image,
                                authorId: 'sample_user_' + (index % 5), // Create 5 different sample users
                                authorName: 'PixPlay User',
                                authorPhoto: '',
                                views: Math.floor(Math.random() * 5000) + 100,
                                createdAt: Date.now() - (Math.random() * 30 * 24 * 60 * 60 * 1000) // Random time in last 30 days
                            };
                            database.ref('images').push(imageData);
                        }, index * 100); // Stagger uploads
                    });
                }
            }).catch(error => {
                console.error('Failed to check for sample images:', error);
            });
        }

        function uploadSampleImagesWithCallback(callback) {
            database.ref('images').once('value', snapshot => {
                if (!snapshot.exists() || snapshot.numChildren() < 10) {
                    console.log('Uploading sample images...');
                    let uploadedCount = 0;
                    const totalImages = sampleImages.length;
                    
                    sampleImages.forEach((image, index) => {
                        setTimeout(() => {
                            const imageData = {
                                ...image,
                                authorId: 'sample_user_' + (index % 5), // Create 5 different sample users
                                authorName: 'PixPlay User',
                                authorPhoto: '',
                                views: Math.floor(Math.random() * 5000) + 100,
                                createdAt: Date.now() - (Math.random() * 30 * 24 * 60 * 60 * 1000) // Random time in last 30 days
                            };
                            
                            database.ref('images').push(imageData).then(() => {
                                uploadedCount++;
                                if (uploadedCount === totalImages && callback) {
                                    callback();
                                }
                            }).catch(error => {
                                console.error('Failed to upload sample image:', error);
                                uploadedCount++;
                                if (uploadedCount === totalImages && callback) {
                                    callback();
                                }
                            });
                        }, index * 50); // Faster stagger for loading
                    });
                } else {
                    // Images already exist, call callback immediately
                    if (callback) callback();
                }
            }).catch(error => {
                console.error('Failed to check for sample images:', error);
                if (callback) callback();
            });
        }

        // Check advertiser access function
        function checkAdvertiserAccess() {
            if (!currentUser) {
                signInWithGoogle();
                return;
            }
            
            database.ref(`users/${currentUser.uid}/walletBalance`).once('value', snapshot => {
                const balance = snapshot.val() || 0;
                if (balance >= 10) {
                    showAdvertiser();
                } else {
                    document.getElementById('warningTitle').textContent = 'Insufficient Funds';
                    document.getElementById('warningMessage').textContent = 'You need at least $10 in your wallet to access the Advertiser Dashboard. Please contact support to add funds.';
                    document.getElementById('warningDialog').classList.remove('hidden');
                }
            }).catch(error => {
                handleError(error, "Failed to check wallet balance.");
            });
        }

        // Ad management
        let adsData = [];
        
        function loadAds() {
            try {
                // Always ensure Pulse ad is available
                const defaultPulseAd = {
                    id: 'pulse-default',
                    type: 'image',
                    brand: 'Pulse by Oriontec',
                    logo: 'https://pulse.oriontec.xyz/IMG_0696.png',
                    tagline: 'Buzz ka naya platform – Pulse join karo!',
                    description: 'Create your Buzz – Upload & explore trending posts.',
                    previewImage: 'https://pulse.oriontec.xyz/IMG_0695.jpeg',
                    ctaText: 'Join Pulse Now',
                    ctaLink: 'https://pulse.oriontec.xyz',
                    active: true
                };
                
                // Start with default Pulse ad
                adsData = [defaultPulseAd];
                
                // Try to load additional ads from database
                database.ref('ads').on('value', snapshot => {
                    const dbAds = [];
                    if (snapshot.exists()) {
                        snapshot.forEach(child => {
                            const ad = { id: child.key, ...child.val() };
                            if (ad.active !== false && ad.id !== 'pulse-default') {
                                dbAds.push(ad);
                            }
                        });
                    }
                    
                    // Combine default Pulse ad with database ads
                    adsData = [defaultPulseAd, ...dbAds];
                    console.log('Ads loaded:', adsData.length);
                }, error => {
                    console.error('Failed to load ads from database:', error);
                    // Keep default Pulse ad even if database fails
                    adsData = [defaultPulseAd];
                });
            } catch (error) {
                console.error('Failed to initialize ads:', error);
                // Fallback to default Pulse ad
                adsData = [{
                    id: 'pulse-default',
                    type: 'image',
                    brand: 'Pulse by Oriontec',
                    logo: 'https://pulse.oriontec.xyz/IMG_0696.png',
                    tagline: 'Buzz ka naya platform – Pulse join karo!',
                    description: 'Create your Buzz – Upload & explore trending posts.',
                    previewImage: 'https://pulse.oriontec.xyz/IMG_0695.jpeg',
                    ctaText: 'Join Pulse Now',
                    ctaLink: 'https://pulse.oriontec.xyz',
                    active: true
                }];
            }
        }

        function loadAdsWithCallback(callback) {
            try {
                // Always ensure Pulse ad is available
                const defaultPulseAd = {
                    id: 'pulse-default',
                    type: 'image',
                    brand: 'Pulse by Oriontec',
                    logo: 'https://pulse.oriontec.xyz/IMG_0696.png',
                    tagline: 'Buzz ka naya platform – Pulse join karo!',
                    description: 'Create your Buzz – Upload & explore trending posts.',
                    previewImage: 'https://pulse.oriontec.xyz/IMG_0695.jpeg',
                    ctaText: 'Join Pulse Now',
                    ctaLink: 'https://pulse.oriontec.xyz',
                    active: true
                };
                
                // Start with default Pulse ad
                adsData = [defaultPulseAd];
                
                // Try to load additional ads from database
                database.ref('ads').once('value', snapshot => {
                    const dbAds = [];
                    if (snapshot.exists()) {
                        snapshot.forEach(child => {
                            const ad = { id: child.key, ...child.val() };
                            if (ad.active !== false && ad.id !== 'pulse-default') {
                                dbAds.push(ad);
                            }
                        });
                    }
                    
                    // Combine default Pulse ad with database ads
                    adsData = [defaultPulseAd, ...dbAds];
                    console.log('Ads loaded:', adsData.length);
                    
                    // Set up real-time listener for future updates
                    database.ref('ads').on('value', snapshot => {
                        const dbAds = [];
                        if (snapshot.exists()) {
                            snapshot.forEach(child => {
                                const ad = { id: child.key, ...child.val() };
                                if (ad.active !== false && ad.id !== 'pulse-default') {
                                    dbAds.push(ad);
                                }
                            });
                        }
                        adsData = [defaultPulseAd, ...dbAds];
                    });
                    
                    // Call callback to indicate loading complete
                    if (callback) callback();
                }, error => {
                    console.error('Failed to load ads from database:', error);
                    adsData = [defaultPulseAd];
                    if (callback) callback();
                });
            } catch (error) {
                console.error('Failed to initialize ads:', error);
                adsData = [{
                    id: 'pulse-default',
                    type: 'image',
                    brand: 'Pulse by Oriontec',
                    logo: 'https://pulse.oriontec.xyz/IMG_0696.png',
                    tagline: 'Buzz ka naya platform – Pulse join karo!',
                    description: 'Create your Buzz – Upload & explore trending posts.',
                    previewImage: 'https://pulse.oriontec.xyz/IMG_0695.jpeg',
                    ctaText: 'Join Pulse Now',
                    ctaLink: 'https://pulse.oriontec.xyz',
                    active: true
                }];
                if (callback) callback();
            }
        }

        function loadAllImages() {
            try {
                database.ref('images').orderByChild('createdAt').on('value', snapshot => {
                    allImages = [];
                    snapshot.forEach(child => {
                        const image = { id: child.key, ...child.val() };
                        allImages.unshift(image); // Most recent first
                    });
                    
                    // Set up real-time view count listeners for all images
                    setupRealTimeViewUpdates();
                    
                    // Generate personalized feed for logged-in users
                    if (currentUser) {
                        personalizedFeed = generatePersonalizedFeed(allImages);
                        renderImages(personalizedFeed, 'imageGallery', 'emptyState');
                    } else {
                        // Show random mix for guests
                        const shuffledImages = shuffleArray([...allImages]);
                        renderImages(shuffledImages, 'imageGallery', 'emptyState');
                    }
                }, error => {
                    handleError(error, "Failed to load images. Please refresh the page.", loadAllImages);
                });
            } catch (error) {
                handleError(error, "Failed to load images.", loadAllImages);
            }
        }

        function loadAllImagesWithCallback(callback) {
            try {
                database.ref('images').orderByChild('createdAt').once('value', snapshot => {
                    allImages = [];
                    snapshot.forEach(child => {
                        const image = { id: child.key, ...child.val() };
                        allImages.unshift(image); // Most recent first
                    });
                    
                    // Set up real-time view count listeners for all images
                    setupRealTimeViewUpdates();
                    
                    // Generate personalized feed for logged-in users
                    if (currentUser) {
                        personalizedFeed = generatePersonalizedFeed(allImages);
                        renderImages(personalizedFeed, 'imageGallery', 'emptyState');
                    } else {
                        // Show random mix for guests
                        const shuffledImages = shuffleArray([...allImages]);
                        renderImages(shuffledImages, 'imageGallery', 'emptyState');
                    }
                    
                    // Set up real-time listener for future updates
                    database.ref('images').orderByChild('createdAt').on('value', snapshot => {
                        allImages = [];
                        snapshot.forEach(child => {
                            const image = { id: child.key, ...child.val() };
                            allImages.unshift(image);
                        });
                        
                        setupRealTimeViewUpdates();
                        
                        if (currentUser) {
                            personalizedFeed = generatePersonalizedFeed(allImages);
                            renderImages(personalizedFeed, 'imageGallery', 'emptyState');
                        } else {
                            const shuffledImages = shuffleArray([...allImages]);
                            renderImages(shuffledImages, 'imageGallery', 'emptyState');
                        }
                    });
                    
                    // Call callback to indicate loading complete
                    if (callback) callback();
                }, error => {
                    if (callback) callback();
                    handleError(error, "Failed to load images. Please refresh the page.", loadAllImages);
                });
            } catch (error) {
                if (callback) callback();
                handleError(error, "Failed to load images.", loadAllImages);
            }
        }
        
        function setupRealTimeViewUpdates() {
            // Listen for view count changes on all images
            allImages.forEach(image => {
                database.ref(`images/${image.id}/views`).on('value', snapshot => {
                    const newViews = snapshot.val() || 0;
                    
                    // Update the image object in memory
                    const imageIndex = allImages.findIndex(img => img.id === image.id);
                    if (imageIndex !== -1) {
                        allImages[imageIndex].views = newViews;
                    }
                    
                    // Update view count display in real-time
                    const viewCountElement = document.getElementById(`view-count-${image.id}`);
                    if (viewCountElement) {
                        viewCountElement.textContent = newViews.toLocaleString();
                    }
                    
                    // Update modal view count if this image is currently open
                    if (currentImageId === image.id) {
                        const modalViewCount = document.getElementById('modalViewCount');
                        if (modalViewCount) {
                            modalViewCount.textContent = `${newViews.toLocaleString()} views`;
                        }
                    }
                    
                    // Update monetization status in real-time
                    const monetizationElements = document.querySelectorAll(`[data-image-id="${image.id}"] .monetization-badge`);
                    const isMonetized = newViews >= 1000;
                    
                    monetizationElements.forEach(element => {
                        if (isMonetized && element.dataset.isOwner === 'true') {
                            element.classList.remove('hidden');
                            const earnings = (newViews - 1000) * 0.002;
                            element.textContent = `💰 $${earnings.toFixed(2)}`;
                        } else {
                            element.classList.add('hidden');
                        }
                    });
                });
            });
        }

        function loadSavedImages() {
            try {
                if (savedImages.length === 0) {
                    document.getElementById('savedGallery').innerHTML = '';
                    document.getElementById('emptySaved').classList.remove('hidden');
                    return;
                }

                const savedImageData = [];
                let loadedCount = 0;

                savedImages.forEach(imageId => {
                    database.ref(`images/${imageId}`).once('value', snapshot => {
                        if (snapshot.exists()) {
                            savedImageData.push({ id: imageId, ...snapshot.val() });
                        }
                        loadedCount++;
                        if (loadedCount === savedImages.length) {
                            renderImages(savedImageData, 'savedGallery', 'emptySaved');
                        }
                    }).catch(error => {
                        loadedCount++;
                        if (loadedCount === savedImages.length) {
                            renderImages(savedImageData, 'savedGallery', 'emptySaved');
                        }
                    });
                });
            } catch (error) {
                handleError(error, "Failed to load saved images.", loadSavedImages);
            }
        }

        function loadUserImages() {
            if (!currentUser) return;
            
            try {
                database.ref('images').orderByChild('authorId').equalTo(currentUser.uid).on('value', snapshot => {
                    userImages = [];
                    snapshot.forEach(child => {
                        const image = { id: child.key, ...child.val() };
                        userImages.unshift(image);
                    });
                    renderImages(userImages, 'myPinsGallery', 'emptyMyPins');
                }, error => {
                    handleError(error, "Failed to load your pins.", loadUserImages);
                });
            } catch (error) {
                handleError(error, "Failed to load your pins.", loadUserImages);
            }
        }

        function loadUserProfile() {
            if (!currentUser) return;
            
            try {
                database.ref(`users/${currentUser.uid}`).once('value', snapshot => {
                    const userData = snapshot.val() || {};
                    
                    const profilePic = document.getElementById('settingsProfilePic');
                    profilePic.src = userData.photoURL || currentUser.photoURL || '';
                    profilePic.onerror = function() {
                        this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iNDAiIGZpbGw9IiNFNUU3RUIiLz4KPGNpcmNsZSBjeD0iNDAiIGN5PSIzMCIgcj0iMTIiIGZpbGw9IiM5Q0EzQUYiLz4KPHBhdGggZD0iTTE1IDY2QzE1IDU1Ljk1IDI1Ljk1IDQ4IDQwIDQ4QzU0LjA1IDQ4IDY1IDU1Ljk1IDY1IDY2IiBmaWxsPSIjOUNBM0FGIi8+Cjwvc3ZnPgo=';
                    };
                    
                    document.getElementById('usernameInput').value = userData.username || '';
                    document.getElementById('displayNameInput').value = userData.displayName || currentUser.displayName || '';
                    document.getElementById('emailInput').value = currentUser.email || '';
                    document.getElementById('bioInput').value = userData.bio || '';
                    
                    // Load stats
                    updateUserStats();
                }).catch(error => {
                    handleError(error, "Failed to load profile settings.", loadUserProfile);
                });
            } catch (error) {
                handleError(error, "Failed to load profile settings.", loadUserProfile);
            }
        }

        function updateUserStats() {
            if (!currentUser) return;
            
            try {
                let totalViews = 0;
                let monetizedPins = 0;
                let totalEarnings = 0;
                
                database.ref('images').orderByChild('authorId').equalTo(currentUser.uid).once('value', snapshot => {
                    snapshot.forEach(child => {
                        const image = child.val();
                        totalViews += image.views || 0;
                        if ((image.views || 0) >= 1000) {
                            monetizedPins++;
                            totalEarnings += ((image.views || 0) - 1000) * 0.002;
                        }
                    });
                    
                    document.getElementById('userTotalViews').textContent = totalViews.toLocaleString();
                    document.getElementById('userMonetizedPins').textContent = monetizedPins;
                    document.getElementById('userTotalEarnings').textContent = totalEarnings.toFixed(2);
                    
                    // Load wallet balance
                    database.ref(`users/${currentUser.uid}/walletBalance`).once('value', balanceSnapshot => {
                        const balance = balanceSnapshot.val() || 0;
                        document.getElementById('userWalletBalance').textContent = balance.toFixed(2);
                    });
                }).catch(error => {
                    console.error('Failed to load user stats:', error);
                });
            } catch (error) {
                console.error('Failed to update user stats:', error);
            }
        }

        // Enhanced Link Processing Functions with Real API
        async function processLinkPreview(url) {
            try {
                // First try to get real preview data from API
                const realPreview = await fetchRealLinkPreview(url);
                if (realPreview) {
                    return realPreview;
                }
                
                // Fallback to mock data if API fails
                const linkType = detectLinkType(url);
                const hostname = new URL(url).hostname.toLowerCase();
                
                let preview = {
                    url: url,
                    hostname: hostname,
                    type: linkType,
                    title: '',
                    description: '',
                    image: '',
                    price: null,
                    currency: null,
                    isVideo: false,
                    videoThumbnail: null
                };
                
                // Handle different link types as fallback
                if (linkType === 'shopping') {
                    preview = await extractProductInfo(url, preview);
                } else if (linkType === 'video') {
                    preview = await extractVideoInfo(url, preview);
                } else {
                    preview = await extractBasicInfo(url, preview);
                }
                
                return preview;
            } catch (error) {
                console.error('Link preview error:', error);
                return {
                    url: url,
                    hostname: new URL(url).hostname,
                    type: 'general',
                    title: '',
                    description: '',
                    image: '',
                    price: null,
                    currency: null,
                    isVideo: false
                };
            }
        }

        // Real Link Preview API Function
        async function fetchRealLinkPreview(url) {
            try {
                // Using the provided API key
                const apiKey = '3939f4f637fc345cc8e94113c98139b2';
                
                // Try multiple API services for better reliability
                const apiServices = [
                    // Primary: LinkPreview.net
                    {
                        url: `https://api.linkpreview.net/?key=${apiKey}&q=${encodeURIComponent(url)}`,
                        parser: (data) => ({
                            url: url,
                            hostname: new URL(url).hostname,
                            type: detectLinkType(url),
                            title: data.title || '',
                            description: data.description || '',
                            image: data.image || '',
                            price: extractPriceFromText(data.description || data.title || ''),
                            currency: detectCurrency(url, data.description || data.title || ''),
                            isVideo: isVideoContent(data.title, data.description, url),
                            videoThumbnail: isVideoContent(data.title, data.description, url) ? data.image : null
                        })
                    },
                    // Fallback: OpenGraph.io (free tier)
                    {
                        url: `https://opengraph.io/api/1.1/site/${encodeURIComponent(url)}?app_id=your_opengraph_app_id`,
                        parser: (data) => ({
                            url: url,
                            hostname: new URL(url).hostname,
                            type: detectLinkType(url),
                            title: data.hybridGraph?.title || data.openGraph?.title || '',
                            description: data.hybridGraph?.description || data.openGraph?.description || '',
                            image: data.hybridGraph?.image || data.openGraph?.image || '',
                            price: extractPriceFromText(data.hybridGraph?.description || data.openGraph?.description || ''),
                            currency: detectCurrency(url, data.hybridGraph?.description || ''),
                            isVideo: data.openGraph?.type === 'video' || isVideoContent(data.hybridGraph?.title, data.hybridGraph?.description, url),
                            videoThumbnail: data.openGraph?.type === 'video' ? data.hybridGraph?.image : null
                        })
                    },
                    // Free alternative: JSONLink
                    {
                        url: `https://jsonlink.io/api/extract?url=${encodeURIComponent(url)}`,
                        parser: (data) => ({
                            url: url,
                            hostname: new URL(url).hostname,
                            type: detectLinkType(url),
                            title: data.title || '',
                            description: data.description || '',
                            image: data.images && data.images.length > 0 ? data.images[0] : '',
                            price: extractPriceFromText(data.description || data.title || ''),
                            currency: detectCurrency(url, data.description || ''),
                            isVideo: data.videos && data.videos.length > 0,
                            videoThumbnail: data.videos && data.videos.length > 0 ? data.images?.[0] : null
                        })
                    }
                ];

                // Try each API service
                for (const service of apiServices) {
                    try {
                        const response = await fetch(service.url, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                                'User-Agent': 'PixPlay/1.0'
                            }
                        });

                        if (response.ok) {
                            const data = await response.json();
                            const preview = service.parser(data);
                            
                            // Validate that we got useful data
                            if (preview.title || preview.description || preview.image) {
                                console.log('Real link preview fetched successfully:', preview);
                                return preview;
                            }
                        }
                    } catch (serviceError) {
                        console.log(`API service failed, trying next:`, serviceError.message);
                        continue;
                    }
                }

                // If all API services fail, try CORS-free method
                return await fetchLinkPreviewCORSFree(url);

            } catch (error) {
                console.error('Real link preview failed:', error);
                return null; // Will fallback to mock data
            }
        }

        // CORS-free link preview method
        async function fetchLinkPreviewCORSFree(url) {
            try {
                // Use AllOrigins or similar CORS proxy service
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error('Proxy request failed');
                
                const data = await response.json();
                const htmlContent = data.contents;
                
                // Parse HTML content for meta tags
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlContent, 'text/html');
                
                // Extract Open Graph and meta tags
                const getMetaContent = (property) => {
                    const meta = doc.querySelector(`meta[property="${property}"]`) || 
                                doc.querySelector(`meta[name="${property}"]`);
                    return meta ? meta.getAttribute('content') : '';
                };
                
                const title = getMetaContent('og:title') || 
                            getMetaContent('twitter:title') || 
                            doc.querySelector('title')?.textContent || '';
                
                const description = getMetaContent('og:description') || 
                                  getMetaContent('twitter:description') || 
                                  getMetaContent('description') || '';
                
                const image = getMetaContent('og:image') || 
                            getMetaContent('twitter:image') || '';
                
                const type = getMetaContent('og:type') || '';
                
                return {
                    url: url,
                    hostname: new URL(url).hostname,
                    type: detectLinkType(url),
                    title: title.trim(),
                    description: description.trim(),
                    image: image,
                    price: extractPriceFromText(description + ' ' + title),
                    currency: detectCurrency(url, description + ' ' + title),
                    isVideo: type.includes('video') || isVideoContent(title, description, url),
                    videoThumbnail: type.includes('video') ? image : null
                };
                
            } catch (error) {
                console.error('CORS-free preview failed:', error);
                return null;
            }
        }

        // Helper functions for real preview data
        function extractPriceFromText(text) {
            if (!text) return null;
            
            // Look for price patterns
            const pricePatterns = [
                /\$(\d+(?:,\d{3})*(?:\.\d{2})?)/g,  // $123.45, $1,234.56
                /₹(\d+(?:,\d{3})*(?:\.\d{2})?)/g,   // ₹123.45
                /€(\d+(?:,\d{3})*(?:\.\d{2})?)/g,   // €123.45
                /£(\d+(?:,\d{3})*(?:\.\d{2})?)/g,   // £123.45
                /(\d+(?:,\d{3})*(?:\.\d{2})?)\s*(?:USD|INR|EUR|GBP)/gi
            ];
            
            for (const pattern of pricePatterns) {
                const match = text.match(pattern);
                if (match) {
                    const priceStr = match[0].replace(/[^\d.,]/g, '');
                    const price = parseFloat(priceStr.replace(/,/g, ''));
                    if (!isNaN(price)) {
                        return price;
                    }
                }
            }
            
            return null;
        }

        function detectCurrency(url, text) {
            const hostname = url.toLowerCase();
            
            // Detect by domain
            if (hostname.includes('.in') || hostname.includes('flipkart') || hostname.includes('myntra')) {
                return '₹';
            }
            if (hostname.includes('.uk') || hostname.includes('.co.uk')) {
                return '£';
            }
            if (hostname.includes('.de') || hostname.includes('.fr') || hostname.includes('.eu')) {
                return '€';
            }
            
            // Detect by text content
            if (text.includes('₹') || text.includes('INR') || text.includes('rupee')) return '₹';
            if (text.includes('€') || text.includes('EUR') || text.includes('euro')) return '€';
            if (text.includes('£') || text.includes('GBP') || text.includes('pound')) return '£';
            if (text.includes('$') || text.includes('USD') || text.includes('dollar')) return '$';
            
            return '$'; // Default
        }

        function isVideoContent(title, description, url) {
            const videoKeywords = ['video', 'watch', 'play', 'stream', 'movie', 'film', 'episode', 'trailer'];
            const videoSites = ['youtube.com', 'youtu.be', 'vimeo.com', 'dailymotion.com', 'twitch.tv', 'tiktok.com'];
            
            const text = (title + ' ' + description).toLowerCase();
            const hostname = new URL(url).hostname.toLowerCase();
            
            return videoKeywords.some(keyword => text.includes(keyword)) ||
                   videoSites.some(site => hostname.includes(site));
        }
        
        function detectLinkType(url) {
            const hostname = new URL(url).hostname.toLowerCase();
            
            // Shopping sites
            const shoppingSites = [
                'amazon.com', 'amazon.in', 'amazon.co.uk', 'amazon.de', 'amazon.fr',
                'flipkart.com', 'myntra.com', 'ajio.com', 'nykaa.com',
                'ebay.com', 'etsy.com', 'shopify.com',
                'alibaba.com', 'aliexpress.com',
                'walmart.com', 'target.com',
                'zara.com', 'h&m.com', 'uniqlo.com'
            ];
            
            // Video sites
            const videoSites = [
                'youtube.com', 'youtu.be', 'vimeo.com', 'dailymotion.com',
                'twitch.tv', 'tiktok.com', 'instagram.com'
            ];
            
            // News sites
            const newsSites = [
                'bbc.com', 'cnn.com', 'reuters.com', 'ap.org',
                'timesofindia.com', 'hindustantimes.com', 'ndtv.com',
                'news.google.com', 'news.yahoo.com'
            ];
            
            if (shoppingSites.some(site => hostname.includes(site))) {
                return 'shopping';
            } else if (videoSites.some(site => hostname.includes(site))) {
                return 'video';
            } else if (newsSites.some(site => hostname.includes(site))) {
                return 'news';
            } else {
                return 'general';
            }
        }
        
        async function extractProductInfo(url, preview) {
            const hostname = preview.hostname;
            
            // Amazon product detection
            if (hostname.includes('amazon')) {
                preview.title = 'Amazon Product';
                preview.description = 'Product available on Amazon';
                preview.price = generateMockPrice(50, 500);
                preview.currency = hostname.includes('.in') ? '₹' : '$';
                preview.image = 'https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=300&h=200&fit=crop';
            }
            // Flipkart product detection
            else if (hostname.includes('flipkart')) {
                preview.title = 'Flipkart Product';
                preview.description = 'Product available on Flipkart';
                preview.price = generateMockPrice(100, 1000);
                preview.currency = '₹';
                preview.image = 'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=300&h=200&fit=crop';
            }
            // Myntra product detection
            else if (hostname.includes('myntra')) {
                preview.title = 'Myntra Fashion';
                preview.description = 'Fashion product on Myntra';
                preview.price = generateMockPrice(200, 800);
                preview.currency = '₹';
                preview.image = 'https://images.unsplash.com/photo-1445205170230-053b83016050?w=300&h=200&fit=crop';
            }
            // Other shopping sites
            else {
                preview.title = 'Shopping Product';
                preview.description = `Product available on ${hostname}`;
                preview.price = generateMockPrice(25, 300);
                preview.currency = '$';
                preview.image = 'https://images.unsplash.com/photo-1472851294608-062f824d29cc?w=300&h=200&fit=crop';
            }
            
            return preview;
        }
        
        async function extractVideoInfo(url, preview) {
            const hostname = preview.hostname;
            preview.isVideo = true;
            
            // YouTube video detection
            if (hostname.includes('youtube') || hostname.includes('youtu.be')) {
                preview.title = 'YouTube Video';
                preview.description = 'Watch this video on YouTube';
                preview.videoThumbnail = 'https://images.unsplash.com/photo-1611162617474-5b21e879e113?w=300&h=200&fit=crop';
                preview.image = preview.videoThumbnail;
            }
            // Instagram video detection
            else if (hostname.includes('instagram')) {
                preview.title = 'Instagram Video';
                preview.description = 'Watch this video on Instagram';
                preview.videoThumbnail = 'https://images.unsplash.com/photo-1611262588024-d12430b98920?w=300&h=200&fit=crop';
                preview.image = preview.videoThumbnail;
            }
            // TikTok video detection
            else if (hostname.includes('tiktok')) {
                preview.title = 'TikTok Video';
                preview.description = 'Watch this video on TikTok';
                preview.videoThumbnail = 'https://images.unsplash.com/photo-1611605698335-8b1569810432?w=300&h=200&fit=crop';
                preview.image = preview.videoThumbnail;
            }
            // Other video sites
            else {
                preview.title = 'Video Content';
                preview.description = `Watch video on ${hostname}`;
                preview.videoThumbnail = 'https://images.unsplash.com/photo-1574717024653-61fd2cf4d44d?w=300&h=200&fit=crop';
                preview.image = preview.videoThumbnail;
            }
            
            return preview;
        }
        
        async function extractBasicInfo(url, preview) {
            const hostname = preview.hostname;
            
            // News sites
            if (preview.type === 'news') {
                preview.title = 'News Article';
                preview.description = `Read the latest news on ${hostname}`;
                preview.image = 'https://images.unsplash.com/photo-1504711434969-e33886168f5c?w=300&h=200&fit=crop';
            }
            // Social media
            else if (hostname.includes('facebook') || hostname.includes('twitter') || hostname.includes('linkedin')) {
                preview.title = 'Social Media Post';
                preview.description = `View post on ${hostname}`;
                preview.image = 'https://images.unsplash.com/photo-1611162616305-c69b3fa7fbe0?w=300&h=200&fit=crop';
            }
            // Google services
            else if (hostname.includes('google')) {
                preview.title = 'Google Service';
                preview.description = `Access Google service`;
                preview.image = 'https://images.unsplash.com/photo-1573804633927-bfcbcd909acd?w=300&h=200&fit=crop';
            }
            // General websites
            else {
                preview.title = hostname.charAt(0).toUpperCase() + hostname.slice(1);
                preview.description = `Visit ${hostname}`;
                preview.image = 'https://images.unsplash.com/photo-1460925895917-afdab827c52f?w=300&h=200&fit=crop';
            }
            
            return preview;
        }
        
        function generateMockPrice(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
        
        function suggestBoardFromLink(url, linkPreview) {
            const hostname = url.toLowerCase();
            const type = linkPreview?.type || 'general';
            
            // Shopping links
            if (type === 'shopping') {
                if (hostname.includes('myntra') || hostname.includes('zara') || hostname.includes('h&m')) {
                    return 'fashion';
                } else {
                    return 'shopping';
                }
            }
            
            // Video links
            if (type === 'video') {
                return 'lifestyle';
            }
            
            // News links
            if (type === 'news') {
                return 'general';
            }
            
            // Food related
            if (hostname.includes('zomato') || hostname.includes('swiggy') || hostname.includes('recipe')) {
                return 'food';
            }
            
            // Travel related
            if (hostname.includes('booking') || hostname.includes('airbnb') || hostname.includes('travel')) {
                return 'travel';
            }
            
            // Default
            return 'general';
        }

        // Enhanced content filtering functions
        function shouldBlurContent(image) {
            // Only blur if explicit inappropriate terms are found in title or description
            const explicitTerms = ['sex', 'naked', 'nude', 'porn', 'adult', 'xxx', 'nsfw', 'erotic', 'sexual'];
            
            const title = (image.title || '').toLowerCase();
            const description = (image.description || '').toLowerCase();
            
            // Only check text content for explicit terms
            const hasExplicitContent = explicitTerms.some(term => 
                title.includes(term) || description.includes(term)
            );
            
            return hasExplicitContent;
        }
        
        function detectInappropriateContent(image) {
            // This function is no longer used for automatic blurring
            // Only explicit terms in text will trigger blur
            return false;
        }
        
        function unblurImage(imageId) {
            try {
                // Remove blur from image
                const imgElement = document.getElementById(`img-${imageId}`);
                if (imgElement) {
                    imgElement.classList.remove('blur-lg');
                }
                
                // Remove blur from title and description
                const titleElement = document.getElementById(`title-${imageId}`);
                if (titleElement) {
                    titleElement.classList.remove('blur-sm');
                }
                
                const descElement = document.getElementById(`desc-${imageId}`);
                if (descElement) {
                    descElement.classList.remove('blur-sm');
                }
                
                // Hide the unblur button overlay
                const unblurOverlay = imgElement?.parentElement.querySelector('.absolute.inset-0.flex.items-center');
                if (unblurOverlay) {
                    unblurOverlay.style.display = 'none';
                }
                
                showSuccess('Content revealed');
            } catch (error) {
                console.error('Failed to unblur content:', error);
            }
        }

        // Hashtag formatting function
        function formatHashtags(text) {
            if (!text) return '';
            
            return text.replace(/#(\w+)/g, '<span class="hashtag-link text-blue-600 font-semibold cursor-pointer hover:text-blue-800 hover:underline transition-colors" onclick="searchHashtag(\'$1\')">#$1</span>');
        }
        
        function searchHashtag(tag) {
            const searchInput = document.getElementById('searchInput');
            const mobileSearchInput = document.getElementById('mobileSearchInput');
            
            searchInput.value = '#' + tag;
            mobileSearchInput.value = '#' + tag;
            
            filterImages('#' + tag);
            
            // Track hashtag click
            if (currentUser) {
                trackUserActivity('interactions', { type: 'hashtag_click', hashtag: tag });
                updateUserInterests([tag], 1);
            }
        }

        // Render functions
        function renderImages(images, containerId, emptyStateId) {
            try {
                const container = document.getElementById(containerId);
                const emptyState = document.getElementById(emptyStateId);
                
                if (images.length === 0) {
                    container.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    return;
                }
                
                emptyState.classList.add('hidden');
                container.innerHTML = '';
                
                images.forEach((image, index) => {
                    const imageElement = createImageElement(image);
                    container.appendChild(imageElement);
                    
                    // Insert ad randomly (only in home view) - 15% chance after each image, but at least every 8-12 images
                    if (containerId === 'imageGallery' && adsData.length > 0) {
                        const shouldShowAd = Math.random() < 0.15 || (index + 1) % (8 + Math.floor(Math.random() * 5)) === 0;
                        
                        if (shouldShowAd) {
                            const randomAd = adsData[Math.floor(Math.random() * adsData.length)];
                            const adElement = createAdElement(randomAd);
                            container.appendChild(adElement);
                            console.log('Ad inserted randomly at position:', index + 1);
                        }
                    }
                });
            } catch (error) {
                handleError(error, "Failed to display images.");
            }
        }

        function createImageElement(image) {
            const div = document.createElement('div');
            div.className = 'fade-in';
            div.setAttribute('data-image-id', image.id);
            
            const isMonetized = (image.views || 0) >= 1000;
            const isSaved = currentUser && savedImages.includes(image.id);
            const isOwner = currentUser && image.authorId === currentUser.uid;
            const isBlurred = shouldBlurContent(image);
            const hasLink = image.link && image.link.trim();
            
            div.innerHTML = `
                <div class="pix-card bg-white shadow-sm hover:shadow-lg cursor-pointer relative group" id="card-${image.id}">
                    <div class="relative">
                        <img src="${image.url}" alt="Pix" loading="lazy" class="${isBlurred ? 'blur-lg' : ''}" id="img-${image.id}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDMwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjNGNEY2Ii8+Cjx0ZXh0IHg9IjE1MCIgeT0iMTAwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjOUM5Q0EzIiBmb250LXNpemU9IjE0Ij5JbWFnZSBub3QgYXZhaWxhYmxlPC90ZXh0Pgo8L3N2Zz4K';">
                        
                        ${isBlurred ? `
                        <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-20 backdrop-blur-sm">
                            <button onclick="event.stopPropagation(); unblurImage('${image.id}')" class="bg-white bg-opacity-90 hover:bg-opacity-100 px-4 py-2 rounded-full text-sm font-medium text-gray-800 shadow-lg transition-all">
                                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                                Show Content
                            </button>
                        </div>
                        ` : ''}
                        
                        <div class="hover-overlay absolute inset-0 flex items-end p-3">
                            <div class="flex justify-between items-end w-full">
                                <div class="flex space-x-2">
                                    <button onclick="event.stopPropagation(); downloadImageDirect('${image.url}')" class="bg-white bg-opacity-90 p-2 rounded-full hover:bg-opacity-100 transition-all shadow-sm" title="Download Image">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                    </button>
                                    ${currentUser && !image.isRepix ? `<button onclick="event.stopPropagation(); openRepixModal('${image.id}')" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-2 rounded-full hover:from-purple-700 hover:to-pink-700 transition-all shadow-sm repix-btn" title="Repix this content">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                        </svg>
                                    </button>` : !currentUser && !image.isRepix ? `<button onclick="event.stopPropagation(); requireLogin(() => openRepixModal('${image.id}'))" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-2 rounded-full hover:from-purple-700 hover:to-pink-700 transition-all shadow-sm repix-btn" title="Sign in to Repix">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                        </svg>
                                    </button>` : ''}
                                    ${currentUser ? `<button onclick="event.stopPropagation(); toggleSaveImageDirect('${image.id}')" class="bg-red-600 text-white px-3 py-2 rounded-full hover:bg-red-700 transition-all shadow-sm text-sm font-medium" title="${isSaved ? 'Remove from saved' : 'Save to collection'}">
                                        ${isSaved ? 'Saved' : 'Save'}
                                    </button>` : `<button onclick="event.stopPropagation(); requireLogin(() => toggleSaveImageDirect('${image.id}'))" class="bg-red-600 text-white px-3 py-2 rounded-full hover:bg-red-700 transition-all shadow-sm text-sm font-medium" title="Sign in to save">
                                        Save
                                    </button>`}
                                </div>
                                <div class="monetization-badge ${isMonetized && isOwner ? '' : 'hidden'} text-black px-2 py-1 rounded-full text-xs font-bold" data-is-owner="${isOwner}">💰 EARNING</div>
                            </div>
                        </div>
                    </div>
                    <div class="p-3">
                        ${image.isRepix ? `
                        <div class="mb-3 p-3 bg-purple-50 rounded-lg border-l-4 border-purple-500">
                            <div class="flex items-center space-x-2 mb-2">
                                <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                </svg>
                                <span class="text-xs font-semibold text-purple-600">PixPlay User repixed</span>
                            </div>
                            <p class="text-sm text-gray-800 font-medium">"${image.repixQuote}"</p>
                        </div>
                        ` : ''}
                        ${image.description ? `<p class="text-sm text-gray-700 mb-2 line-clamp-2 ${isBlurred ? 'blur-sm' : ''}" id="desc-${image.id}">${formatHashtags(image.description)}</p>` : ''}
                        ${image.title ? `<p class="text-sm font-medium text-gray-800 mb-1 ${isBlurred ? 'blur-sm' : ''}" id="title-${image.id}">${image.title}</p>` : ''}
                        

                        

                        
                        <div class="flex items-center justify-between mt-2">
                            <div class="flex items-center space-x-3 text-xs text-gray-500">
                                <span class="flex items-center space-x-1">
                                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                                    </svg>
                                    <span id="view-count-${image.id}">${(image.views || 0).toLocaleString()}</span>
                                </span>
                            </div>
                            ${isOwner ? `<div class="text-xs text-gray-500">
                                <span class="monetization-badge ${isMonetized ? '' : 'hidden'} text-green-600 font-semibold" data-is-owner="${isOwner}">$${isMonetized ? (((image.views || 0) - 1000) * 0.002).toFixed(2) : '0.00'}</span>
                            </div>` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            // Setup click functionality immediately
            const cardElement = div.querySelector('.pix-card');
            if (cardElement) {
                setupImageClick(cardElement, image);
            }
            
            return div;
        }

        function createAdElement(ad) {
            const div = document.createElement('div');
            div.className = 'fade-in';
            div.setAttribute('data-ad-id', ad.id);
            
            div.innerHTML = `
                <div class="pix-card bg-gradient-to-br from-blue-50 to-purple-50 shadow-sm hover:shadow-lg relative group border-2 border-blue-200">
                    <div class="absolute top-2 right-2 z-10">
                        <button onclick="hideAd('${ad.id}', event)" class="bg-white bg-opacity-80 hover:bg-opacity-100 p-1 rounded-full text-gray-600 hover:text-gray-800 transition-all shadow-sm">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="p-3">
                        <div class="text-xs text-blue-600 font-semibold mb-2 flex items-center">
                            <span class="bg-blue-100 px-2 py-1 rounded-full">📢 Sponsored</span>
                        </div>
                        
                        ${ad.type === 'image' && ad.previewImage ? `
                            <div class="mb-3 rounded-lg overflow-hidden">
                                <img src="${ad.previewImage}" alt="Ad Preview" class="w-full h-32 object-cover" onerror="this.style.display='none'">
                            </div>
                        ` : ''}
                        
                        <div class="flex items-center space-x-2 mb-2">
                            ${ad.logo ? `<img src="${ad.logo}" alt="${ad.brand}" class="w-6 h-6 rounded object-cover" onerror="this.style.display='none'">` : ''}
                            <span class="font-bold text-gray-900 text-sm">${ad.brand}</span>
                        </div>
                        
                        ${ad.tagline ? `<p class="text-xs text-blue-700 font-medium mb-2">${ad.tagline}</p>` : ''}
                        
                        ${ad.description ? `<p class="text-sm text-gray-700 mb-3 line-clamp-2">${ad.description}</p>` : ''}
                        
                        <button onclick="openAdLink('${ad.ctaLink}')" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-2 px-4 rounded-lg hover:from-blue-700 hover:to-purple-700 transition-all font-medium text-sm shadow-sm">
                            ${ad.ctaText || 'Learn More'}
                        </button>
                    </div>
                </div>
            `;
            
            return div;
        }

        // Link Preview Functions
        let currentLinkPreview = null;
        
        async function handleLinkPreview() {
            const linkInput = document.getElementById('linkInput');
            const url = linkInput.value.trim();
            
            if (!url) {
                clearLinkPreview();
                return;
            }
            
            try {
                // Validate URL
                new URL(url);
                
                // Show loading state
                showLinkPreviewLoading();
                
                // Process link preview
                currentLinkPreview = await processLinkPreview(url);
                
                // Display preview
                displayLinkPreview(currentLinkPreview);
                
                // Auto-suggest board based on link
                const suggestedBoard = suggestBoardFromLink(url, currentLinkPreview);
                document.getElementById('boardSelect').value = suggestedBoard;
                
            } catch (error) {
                console.error('Link preview error:', error);
                clearLinkPreview();
            }
        }
        
        function showLinkPreviewLoading() {
            const preview = document.getElementById('linkPreview');
            const title = document.getElementById('linkPreviewTitle');
            const description = document.getElementById('linkPreviewDescription');
            
            preview.classList.remove('hidden');
            title.textContent = 'Loading...';
            description.textContent = 'Fetching link preview...';
        }
        
        function displayLinkPreview(preview) {
            const previewContainer = document.getElementById('linkPreview');
            const imageContainer = document.getElementById('linkPreviewImage');
            const videoIcon = document.getElementById('videoPlayIcon');
            const title = document.getElementById('linkPreviewTitle');
            const description = document.getElementById('linkPreviewDescription');
            const hostname = document.getElementById('linkPreviewHostname');
            const priceContainer = document.getElementById('linkPreviewPrice');
            const badge = document.getElementById('linkPreviewBadge');
            
            // Show preview container
            previewContainer.classList.remove('hidden');
            
            // Update image/video thumbnail
            if (preview.image) {
                imageContainer.innerHTML = `<img src="${preview.image}" alt="Preview" class="w-full h-full object-cover rounded" onerror="this.parentElement.innerHTML='🔗'">`;
            } else {
                imageContainer.innerHTML = '🔗';
            }
            
            // Show video play icon for video content
            if (preview.isVideo) {
                videoIcon.classList.remove('hidden');
            } else {
                videoIcon.classList.add('hidden');
            }
            
            // Update text content
            title.textContent = preview.title || preview.hostname;
            description.textContent = preview.description || 'No description available';
            hostname.textContent = preview.hostname;
            
            // Show price for shopping links
            if (preview.price && preview.currency) {
                priceContainer.classList.remove('hidden');
                priceContainer.querySelector('span').textContent = `${preview.currency}${preview.price}`;
            } else {
                priceContainer.classList.add('hidden');
            }
            
            // Show appropriate badge
            badge.classList.remove('hidden');
            if (preview.type === 'shopping') {
                badge.innerHTML = '🛍️ Shopping';
                badge.className = 'px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full font-medium';
            } else if (preview.type === 'video') {
                badge.innerHTML = '🎥 Video';
                badge.className = 'px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full font-medium';
            } else if (preview.type === 'news') {
                badge.innerHTML = '📰 News';
                badge.className = 'px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full font-medium';
            } else {
                badge.innerHTML = '🔗 Link';
                badge.className = 'px-2 py-1 bg-gray-100 text-gray-800 text-xs rounded-full font-medium';
            }
        }
        
        function clearLinkPreview() {
            document.getElementById('linkPreview').classList.add('hidden');
            document.getElementById('linkInput').value = '';
            currentLinkPreview = null;
        }

        // Upload functions
        function openUploadModal() {
            document.getElementById('uploadModal').classList.remove('hidden');
            
            // Update profile info in modal
            if (currentUser) {
                const profilePic = document.getElementById('uploadProfilePic');
                profilePic.src = currentUser.photoURL || '';
                profilePic.onerror = function() {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNFNUU3RUIiLz4KPGNpcmNsZSBjeD0iMjAiIGN5PSIxNSIgcj0iNiIgZmlsbD0iIzlDQTNBRiIvPgo8cGF0aCBkPSJNNyAzM0M3IDI3Ljk1IDEyLjk1IDI0IDIwIDI0QzI3LjA1IDI0IDMzIDI3Ljk1IDMzIDMzIiBmaWxsPSIjOUNBM0FGIi8+Cjwvc3ZnPgo=';
                };
                document.getElementById('uploadProfileName').textContent = currentUser.displayName || 'Your Profile';
            }
            
            // Setup character counter
            setupCharacterCounter();
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').classList.add('hidden');
            resetUploadForm();
            hideAllLoadingStates();
        }

        function setupCharacterCounter() {
            const titleInput = document.getElementById('titleInput');
            const titleCount = document.getElementById('titleCount');
            
            titleInput.addEventListener('input', updateCharacterCount);
            updateCharacterCount();
        }

        function updateCharacterCount() {
            const titleInput = document.getElementById('titleInput');
            const titleCount = document.getElementById('titleCount');
            
            if (titleInput && titleCount) {
                const length = titleInput.value.length;
                titleCount.textContent = `${length}/100`;
                
                if (length > 90) {
                    titleCount.classList.add('text-red-500');
                    titleCount.classList.remove('text-gray-400');
                } else {
                    titleCount.classList.remove('text-red-500');
                    titleCount.classList.add('text-gray-400');
                }
            }
        }

        function toggleAdvancedSettings() {
            const advancedSettings = document.getElementById('advancedSettings');
            const toggleBtn = document.getElementById('advancedToggle');
            
            if (advancedSettings.classList.contains('hidden')) {
                advancedSettings.classList.remove('hidden');
                toggleBtn.textContent = 'Hide Advanced Settings';
            } else {
                advancedSettings.classList.add('hidden');
                toggleBtn.textContent = 'Show Advanced Settings';
            }
        }

        function setPublishNow() {
            document.getElementById('scheduleDate').value = '';
            document.getElementById('publishNowBtn').classList.add('bg-red-600');
            document.getElementById('publishNowBtn').classList.remove('bg-gray-300');
        }

        function toggleShoppingRecommendations() {
            const brandedContent = document.getElementById('brandedContent');
            const shoppingRecommendations = document.getElementById('shoppingRecommendations');
            
            if (brandedContent.checked) {
                shoppingRecommendations.checked = false;
                shoppingRecommendations.disabled = true;
                shoppingRecommendations.parentElement.classList.add('opacity-50');
            } else {
                shoppingRecommendations.disabled = false;
                shoppingRecommendations.parentElement.classList.remove('opacity-50');
            }
        }

        function uploadImage() {
            if (!currentUser) {
                handleError(new Error('Not authenticated'), "Please sign in to upload images.");
                return;
            }
            
            const fileInput = document.getElementById('imageInput');
            const file = fileInput.files[0];
            
            if (!file) {
                handleError(new Error('No file selected'), "Please select an image to upload.");
                return;
            }
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                handleError(new Error('Invalid file type'), "Please select a valid image file.");
                return;
            }
            
            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                handleError(new Error('File too large'), "Please select an image smaller than 5MB.");
                return;
            }
            
            // Show loading state
            document.getElementById('uploadBtnText').textContent = 'Creating Pix...';
            document.getElementById('uploadSpinner').classList.remove('hidden');
            document.getElementById('uploadBtn').disabled = true;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const base64Data = e.target.result;
                    
                    // Get all form data
                    const title = document.getElementById('titleInput').value.trim();
                    const description = document.getElementById('descriptionInput').value.trim();
                    const link = document.getElementById('linkInput').value.trim();
                    const board = document.getElementById('boardSelect').value;
                    const allowComments = document.getElementById('allowComments').checked;
                    const brandedContent = document.getElementById('brandedContent').checked;
                    const shoppingRecommendations = document.getElementById('shoppingRecommendations').checked;
                    const scheduleDate = document.getElementById('scheduleDate').value;
                    
                    const imageData = {
                        url: base64Data,
                        title: title || '',
                        description: description || '',
                        link: link || '',
                        linkPreview: currentLinkPreview || null,
                        board: board,
                        authorId: currentUser.uid,
                        authorName: currentUser.displayName || 'Anonymous',
                        authorPhoto: currentUser.photoURL || '',
                        views: 0,
                        createdAt: scheduleDate ? new Date(scheduleDate).getTime() : Date.now(),
                        settings: {
                            allowComments: allowComments,
                            brandedContent: brandedContent,
                            shoppingRecommendations: shoppingRecommendations && !brandedContent
                        }
                    };
                    
                    database.ref('images').push(imageData).then(() => {
                        // Reset loading state first
                        document.getElementById('uploadBtnText').textContent = 'Create Pix';
                        document.getElementById('uploadSpinner').classList.add('hidden');
                        document.getElementById('uploadBtn').disabled = false;
                        
                        showSuccess('Pix created successfully! 🎉');
                        closeUploadModal();
                        
                        // Clear form completely
                        resetUploadForm();
                    }).catch(error => {
                        // Reset loading state on error
                        document.getElementById('uploadBtnText').textContent = 'Create Pix';
                        document.getElementById('uploadSpinner').classList.add('hidden');
                        document.getElementById('uploadBtn').disabled = false;
                        
                        handleError(error, "Failed to upload image. Please try again.", uploadImage);
                    });
                } catch (error) {
                    // Reset loading state on error
                    document.getElementById('uploadBtnText').textContent = 'Create Pix';
                    document.getElementById('uploadSpinner').classList.add('hidden');
                    document.getElementById('uploadBtn').disabled = false;
                    
                    handleError(error, "Failed to process image. Please try again.", uploadImage);
                }
            };
            
            reader.onerror = function() {
                // Reset loading state on error
                document.getElementById('uploadBtnText').textContent = 'Create Pix';
                document.getElementById('uploadSpinner').classList.add('hidden');
                document.getElementById('uploadBtn').disabled = false;
                
                handleError(new Error('File read error'), "Failed to read image file. Please try again.", uploadImage);
            };
            
            try {
                reader.readAsDataURL(file);
            } catch (error) {
                // Reset loading state on error
                document.getElementById('uploadBtnText').textContent = 'Create Pix';
                document.getElementById('uploadSpinner').classList.add('hidden');
                document.getElementById('uploadBtn').disabled = false;
                
                handleError(error, "Failed to process image. Please try again.", uploadImage);
            }
        }

        function resetUploadForm() {
            // Clear all form fields
            document.getElementById('imageInput').value = '';
            document.getElementById('titleInput').value = '';
            document.getElementById('descriptionInput').value = '';
            document.getElementById('linkInput').value = '';
            document.getElementById('boardSelect').value = 'general';
            document.getElementById('allowComments').checked = true;
            document.getElementById('brandedContent').checked = false;
            document.getElementById('shoppingRecommendations').checked = true;
            document.getElementById('scheduleDate').value = '';
            
            // Clear link preview
            clearLinkPreview();
            
            // Hide advanced settings
            document.getElementById('advancedSettings').classList.add('hidden');
            document.getElementById('advancedToggle').textContent = 'Show Advanced Settings';
            
            // Reset character count
            updateCharacterCount();
        }

        // Image interaction functions
        // View tracking with localStorage to prevent duplicate counts
        function trackPostView(imageId) {
            try {
                // Check if this post was already viewed in this session
                const viewedPosts = JSON.parse(localStorage.getItem('viewedPosts') || '{}');
                const lastViewTime = viewedPosts[imageId];
                const now = Date.now();
                
                // Only count view if not viewed in last 30 minutes
                if (!lastViewTime || (now - lastViewTime) > 30 * 60 * 1000) {
                    // Increment view count atomically using transaction
                    database.ref(`images/${imageId}/views`).transaction(currentViews => {
                        return (currentViews || 0) + 1;
                    }).then(result => {
                        if (result.committed) {
                            // Update localStorage to prevent duplicate counts
                            viewedPosts[imageId] = now;
                            localStorage.setItem('viewedPosts', JSON.stringify(viewedPosts));
                            
                            // Clean up old entries (older than 24 hours)
                            const oneDayAgo = now - 24 * 60 * 60 * 1000;
                            Object.keys(viewedPosts).forEach(postId => {
                                if (viewedPosts[postId] < oneDayAgo) {
                                    delete viewedPosts[postId];
                                }
                            });
                            localStorage.setItem('viewedPosts', JSON.stringify(viewedPosts));
                        }
                    }).catch(error => {
                        console.error('Failed to increment view count:', error);
                    });
                }
            } catch (error) {
                console.error('View tracking error:', error);
            }
        }

        function openImageModal(imageId) {
            try {
                const image = allImages.find(img => img.id === imageId) || 
                             userImages.find(img => img.id === imageId);
                if (!image) return;
                
                currentImageId = imageId;
                
                // Update URL with image ID
                updateURL(imageId);
                
                // Track post view with duplicate prevention
                trackPostView(imageId);
                
                // Track user activity
                if (currentUser) {
                    trackUserActivity('views', { imageId, board: image.board, authorId: image.authorId });
                    
                    // Update interests based on viewed content
                    const keywords = extractImageKeywords(image);
                    updateUserInterests(keywords, 0.3);
                    updateUserInterests([image.board], 0.5);
                    updateUserInterests([`author_${image.authorId}`], 0.2);
                }
                
                // Listen for real-time view count updates
                database.ref(`images/${imageId}/views`).on('value', snapshot => {
                    const currentViews = snapshot.val() || 0;
                    
                    // Update modal view count
                    const modalViewCount = document.getElementById('modalViewCount');
                    if (modalViewCount) {
                        modalViewCount.textContent = `${currentViews.toLocaleString()} views`;
                    }
                    
                    // Update monetization info in real-time (only for owner)
                    if (currentUser && image.authorId === currentUser.uid) {
                        const isMonetized = currentViews >= 1000;
                        const earningsSpan = document.getElementById('modalEarnings');
                        const adSpace = document.getElementById('adSpace');
                        
                        if (isMonetized) {
                            const earnings = (currentViews - 1000) * 0.002;
                            earningsSpan.textContent = `💰 $${earnings.toFixed(2)} earned`;
                            earningsSpan.classList.remove('hidden');
                            adSpace.classList.remove('hidden');
                        } else {
                            earningsSpan.classList.add('hidden');
                            adSpace.classList.add('hidden');
                        }
                    }
                });
                
                // Update modal content
                document.getElementById('modalImage').src = image.url;
                document.getElementById('modalTitle').textContent = image.title || 'Untitled';
                
                // Enhanced description with link preview
                let descriptionHtml = formatHashtags(image.description || '');
                if (image.link) {
                    const hostname = new URL(image.link).hostname;
                    
                    if (image.linkPreview) {
                        descriptionHtml += `
                            <div class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                                <div class="flex items-center space-x-4 mb-4">
                                    <div class="w-16 h-16 bg-gray-200 rounded-lg flex items-center justify-center text-xl relative flex-shrink-0">
                                        ${image.linkPreview.image ? 
                                            `<img src="${image.linkPreview.image}" alt="Preview" class="w-full h-full object-cover rounded-lg" onerror="this.parentElement.innerHTML='🔗'">` : 
                                            '🔗'
                                        }
                                        ${image.linkPreview.isVideo ? `
                                            <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-60 rounded-lg">
                                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M8 5v14l11-7z"/>
                                                </svg>
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <h4 class="font-semibold text-gray-900 text-sm mb-1">${image.linkPreview.title || hostname}</h4>
                                        <p class="text-sm text-gray-600 mb-2 line-clamp-2">${image.linkPreview.description || 'No description available'}</p>
                                        <p class="text-xs text-gray-500 mb-2">${hostname}</p>
                                        ${image.linkPreview.price && image.linkPreview.currency ? `
                                            <div class="mb-2">
                                                <span class="text-lg font-bold text-green-600">${image.linkPreview.currency}${image.linkPreview.price}</span>
                                            </div>
                                        ` : ''}
                                        <div class="px-3 py-1 rounded-full text-xs font-medium inline-block ${
                                            image.linkPreview.type === 'shopping' ? 'bg-green-100 text-green-800' :
                                            image.linkPreview.type === 'video' ? 'bg-red-100 text-red-800' :
                                            image.linkPreview.type === 'news' ? 'bg-blue-100 text-blue-800' :
                                            'bg-gray-100 text-gray-800'
                                        }">
                                            ${
                                                image.linkPreview.type === 'shopping' ? '🛍️ Shopping' :
                                                image.linkPreview.type === 'video' ? '🎥 Video' :
                                                image.linkPreview.type === 'news' ? '📰 News' :
                                                '🔗 Link'
                                            }
                                        </div>
                                    </div>
                                </div>
                                <button onclick="window.open('${image.link}', '_blank')" class="w-full ${
                                    image.linkPreview.type === 'shopping' ? 'bg-green-600 hover:bg-green-700' :
                                    image.linkPreview.type === 'video' ? 'bg-red-600 hover:bg-red-700' :
                                    image.linkPreview.type === 'news' ? 'bg-blue-600 hover:bg-blue-700' :
                                    'bg-blue-600 hover:bg-blue-700'
                                } text-white py-3 px-4 rounded-lg transition-colors text-sm font-medium">
                                    ${
                                        image.linkPreview.type === 'shopping' ? '🛍️ Shop Now' :
                                        image.linkPreview.type === 'video' ? '🎥 Watch Video' :
                                        image.linkPreview.type === 'news' ? '📰 Read Full Article' :
                                        '🔗 Visit Website'
                                    }
                                </button>
                            </div>
                        `;
                    } else {
                        descriptionHtml += `
                            <div class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                                <div class="flex items-center space-x-3 mb-3">
                                    <div class="w-12 h-12 bg-gray-200 rounded flex items-center justify-center text-lg">
                                        🔗
                                    </div>
                                    <div class="flex-1">
                                        <h4 class="font-medium text-gray-900 text-sm">External Link</h4>
                                        <p class="text-xs text-gray-600">${hostname}</p>
                                    </div>
                                </div>
                                <button onclick="window.open('${image.link}', '_blank')" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium">
                                    🔗 Visit Link
                                </button>
                            </div>
                        `;
                    }
                }
                document.getElementById('modalDescription').innerHTML = descriptionHtml;
                
                // Hide author information for privacy
                document.getElementById('modalAuthor').textContent = 'PixPlay User';
                
                const authorPic = document.getElementById('modalAuthorPic');
                authorPic.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNFNUU3RUIiLz4KPGNpcmNsZSBjeD0iMjAiIGN5PSIxNSIgcj0iNiIgZmlsbD0iIzlDQTNBRiIvPgo8cGF0aCBkPSJNNyAzM0M3IDI3Ljk1IDEyLjk1IDI0IDIwIDI0QzI3LjA1IDI0IDMzIDI3Ljk1IDMzIDMzIiBmaWxsPSIjOUNBM0FGIi8+Cjwvc3ZnPgo=';
                
                // Update save button
                const saveBtn = document.getElementById('saveBtn');
                const isSaved = savedImages.includes(imageId);
                saveBtn.textContent = isSaved ? 'Saved' : 'Save';
                saveBtn.className = isSaved ? 
                    'bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors' :
                    'bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors';
                
                // Load comments
                loadComments(imageId);
                
                document.getElementById('imageModal').classList.remove('hidden');
            } catch (error) {
                handleError(error, "Failed to open image details.");
            }
        }

        function closeImageModal() {
            document.getElementById('imageModal').classList.add('hidden');
            
            // Reset URL
            updateURL(null);
            
            // Clean up real-time listeners
            if (currentImageId) {
                database.ref(`images/${currentImageId}/views`).off();
                database.ref(`comments/${currentImageId}`).off();
            }
            
            currentImageId = null;
        }

        function toggleSaveImage() {
            if (!currentUser || !currentImageId) return;
            
            try {
                const isSaved = savedImages.includes(currentImageId);
                const image = allImages.find(img => img.id === currentImageId) || 
                             userImages.find(img => img.id === currentImageId);
                
                if (isSaved) {
                    database.ref(`saved/${currentUser.uid}/${currentImageId}`).remove().then(() => {
                        showSuccess('Removed from saved');
                    }).catch(error => {
                        handleError(error, "Failed to remove from saved.", toggleSaveImage);
                    });
                } else {
                    database.ref(`saved/${currentUser.uid}/${currentImageId}`).set(true).then(() => {
                        showSuccess('Saved to your collection! 📸');
                        
                        // Track save activity and boost interests significantly
                        if (image) {
                            trackUserActivity('saves', { imageId: currentImageId, board: image.board, authorId: image.authorId });
                            
                            const keywords = extractImageKeywords(image);
                            updateUserInterests(keywords, 2); // High weight for saved content
                            updateUserInterests([image.board], 2.5);
                            updateUserInterests([`author_${image.authorId}`], 1.5);
                        }
                    }).catch(error => {
                        handleError(error, "Failed to save Pix.", toggleSaveImage);
                    });
                }
            } catch (error) {
                handleError(error, "Failed to save/unsave pin.", toggleSaveImage);
            }
        }

        function toggleSaveImageDirect(imageId) {
            if (!currentUser) return;
            
            try {
                const isSaved = savedImages.includes(imageId);
                const image = allImages.find(img => img.id === imageId) || 
                             userImages.find(img => img.id === imageId);
                
                if (isSaved) {
                    database.ref(`saved/${currentUser.uid}/${imageId}`).remove().then(() => {
                        showSuccess('Removed from saved');
                    }).catch(error => {
                        handleError(error, "Failed to remove from saved.");
                    });
                } else {
                    database.ref(`saved/${currentUser.uid}/${imageId}`).set(true).then(() => {
                        showSuccess('Saved! 📸');
                        
                        // Track save activity and boost interests
                        if (image) {
                            trackUserActivity('saves', { imageId, board: image.board, authorId: image.authorId });
                            
                            const keywords = extractImageKeywords(image);
                            updateUserInterests(keywords, 2);
                            updateUserInterests([image.board], 2.5);
                            updateUserInterests([`author_${image.authorId}`], 1.5);
                        }
                    }).catch(error => {
                        handleError(error, "Failed to save Pix.");
                    });
                }
            } catch (error) {
                handleError(error, "Failed to save/unsave pin.");
            }
        }

        function downloadImage() {
            if (!currentImageId) return;
            
            try {
                const image = allImages.find(img => img.id === currentImageId) || 
                             userImages.find(img => img.id === currentImageId);
                if (!image) return;
                
                downloadImageDirect(image.url);
            } catch (error) {
                handleError(error, "Failed to download image.");
            }
        }

        function downloadImageDirect(url) {
            try {
                // Check if it's a base64 image (user uploaded)
                if (url.startsWith('data:image/')) {
                    // For base64 images, create download link directly
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `pixplay-image-${Date.now()}.jpg`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showSuccess('Download started! 📥');
                } else {
                    // For external URLs, try to download or open in new tab
                    try {
                        // First try direct download
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `pixplay-image-${Date.now()}.jpg`;
                        link.target = '_blank';
                        link.rel = 'noopener noreferrer';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        showSuccess('Download started! 📥');
                    } catch (downloadError) {
                        // If direct download fails, open in new tab
                        window.open(url, '_blank', 'noopener,noreferrer');
                        showSuccess('Image opened in new tab. Right-click to save! 📥');
                    }
                }
                
                // Track download activity for logged-in users
                if (currentUser) {
                    trackUserActivity('interactions', { type: 'download', imageUrl: url });
                }
            } catch (error) {
                console.error('Download error:', error);
                // Fallback: open in new tab
                try {
                    window.open(url, '_blank', 'noopener,noreferrer');
                    showSuccess('Image opened in new tab. Right-click to save! 📥');
                } catch (fallbackError) {
                    showSuccess('Please right-click on the image and select "Save image as" to download.');
                }
            }
        }

        function downloadAndUnlockLink(imageId, imageUrl, linkUrl) {
            try {
                // First download the image
                downloadImageDirect(imageUrl);
                
                // Then unlock and show the link preview
                setTimeout(() => {
                    unlockLinkPreview(imageId, linkUrl);
                }, 1000); // Small delay to ensure download starts
                
            } catch (error) {
                console.error('Download and unlock error:', error);
                showSuccess('Download started! Link unlocked! 🔓');
                unlockLinkPreview(imageId, linkUrl);
            }
        }

        function unlockLinkPreview(imageId, linkUrl) {
            try {
                const image = allImages.find(img => img.id === imageId) || 
                             userImages.find(img => img.id === imageId);
                if (!image) return;

                const linkPreviewElement = document.getElementById(`link-preview-${imageId}`);
                if (!linkPreviewElement) return;

                // Create the full link preview content
                let linkPreviewHtml = '';
                
                if (image.linkPreview) {
                    linkPreviewHtml = `
                        <div class="flex items-center space-x-3 mb-3">
                            <div class="w-12 h-12 bg-gray-200 rounded flex items-center justify-center text-lg relative flex-shrink-0">
                                ${image.linkPreview.image ? 
                                    `<img src="${image.linkPreview.image}" alt="Preview" class="w-full h-full object-cover rounded" onerror="this.parentElement.innerHTML='🔗'">` : 
                                    '🔗'
                                }
                                ${image.linkPreview.isVideo ? `
                                    <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 rounded">
                                        <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M8 5v14l11-7z"/>
                                        </svg>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-medium text-gray-900 text-xs truncate">${image.linkPreview.title || image.linkPreview.hostname}</h4>
                                <p class="text-xs text-gray-600 truncate">${image.linkPreview.description || ''}</p>
                                <p class="text-xs text-gray-500 truncate">${image.linkPreview.hostname}</p>
                                ${image.linkPreview.price && image.linkPreview.currency ? `
                                    <div class="mt-1">
                                        <span class="text-sm font-bold text-green-600">${image.linkPreview.currency}${image.linkPreview.price}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="flex items-center justify-between mb-2">
                            <div class="px-2 py-1 rounded-full text-xs font-medium ${
                                image.linkPreview.type === 'shopping' ? 'bg-green-100 text-green-800' :
                                image.linkPreview.type === 'video' ? 'bg-red-100 text-red-800' :
                                image.linkPreview.type === 'news' ? 'bg-blue-100 text-blue-800' :
                                'bg-gray-100 text-gray-800'
                            }">
                                ${
                                    image.linkPreview.type === 'shopping' ? '🛍️ Shopping' :
                                    image.linkPreview.type === 'video' ? '🎥 Video' :
                                    image.linkPreview.type === 'news' ? '📰 News' :
                                    '🔗 Link'
                                }
                            </div>
                        </div>
                        <button onclick="event.stopPropagation(); window.open('${linkUrl}', '_blank')" class="w-full ${
                            image.linkPreview.type === 'shopping' ? 'bg-green-600 hover:bg-green-700' :
                            image.linkPreview.type === 'video' ? 'bg-red-600 hover:bg-red-700' :
                            image.linkPreview.type === 'news' ? 'bg-blue-600 hover:bg-blue-700' :
                            'bg-blue-600 hover:bg-blue-700'
                        } text-white py-1.5 px-3 rounded text-xs font-medium transition-colors">
                            ${
                                image.linkPreview.type === 'shopping' ? '🛍️ Shop Now' :
                                image.linkPreview.type === 'video' ? '🎥 Watch Video' :
                                image.linkPreview.type === 'news' ? '📰 Read Article' :
                                '🔗 Visit Link'
                            }
                        </button>
                    `;
                } else {
                    const hostname = new URL(linkUrl).hostname;
                    linkPreviewHtml = `
                        <div class="flex items-center space-x-2 mb-2">
                            <div class="w-8 h-8 bg-gray-200 rounded flex items-center justify-center text-sm">
                                🔗
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-xs text-gray-600 truncate">${hostname}</p>
                            </div>
                        </div>
                        <button onclick="event.stopPropagation(); window.open('${linkUrl}', '_blank')" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-1.5 px-3 rounded text-xs font-medium transition-colors">
                            🔗 Visit Link
                        </button>
                    `;
                }

                // Update the preview element with animation
                linkPreviewElement.style.transform = 'scale(0.95)';
                linkPreviewElement.style.opacity = '0.7';
                
                setTimeout(() => {
                    linkPreviewElement.className = 'mt-3 p-3 bg-gray-50 rounded-lg border border-gray-200';
                    linkPreviewElement.innerHTML = linkPreviewHtml;
                    linkPreviewElement.style.transform = 'scale(1)';
                    linkPreviewElement.style.opacity = '1';
                    linkPreviewElement.style.transition = 'all 0.3s ease';
                }, 300);

                showSuccess('Link unlocked! 🔓 You can now access the content.');
                
            } catch (error) {
                console.error('Unlock link preview error:', error);
                showSuccess('Link access granted! 🔓');
            }
        }

        // Profile functions
        function changeProfilePicture() {
            document.getElementById('profilePicInput').click();
        }

        function handleProfilePicChange(event) {
            const file = event.target.files[0];
            if (!file || !currentUser) return;
            
            try {
                // Validate file
                if (!file.type.startsWith('image/')) {
                    handleError(new Error('Invalid file type'), "Please select a valid image file.");
                    return;
                }
                
                if (file.size > 2 * 1024 * 1024) {
                    handleError(new Error('File too large'), "Please select an image smaller than 2MB.");
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const base64Data = e.target.result;
                    
                    database.ref(`users/${currentUser.uid}/photoURL`).set(base64Data).then(() => {
                        document.getElementById('settingsProfilePic').src = base64Data;
                        document.getElementById('headerProfilePic').src = base64Data;
                        showSuccess('Profile picture updated! ✨');
                    }).catch(error => {
                        handleError(error, "Failed to update profile picture.", () => handleProfilePicChange(event));
                    });
                };
                
                reader.onerror = function() {
                    handleError(new Error('File read error'), "Failed to read image file. Please try again.");
                };
                
                reader.readAsDataURL(file);
            } catch (error) {
                handleError(error, "Failed to process profile picture.");
            }
        }

        function saveProfile() {
            if (!currentUser) return;
            
            try {
                const username = document.getElementById('usernameInput').value.trim();
                const displayName = document.getElementById('displayNameInput').value.trim();
                const bio = document.getElementById('bioInput').value.trim();
                
                const updates = {
                    username: username,
                    displayName: displayName,
                    bio: bio
                };
                
                database.ref(`users/${currentUser.uid}`).update(updates).then(() => {
                    showSuccess('Profile updated successfully! ✨');
                }).catch(error => {
                    handleError(error, "Failed to update profile.", saveProfile);
                });
            } catch (error) {
                handleError(error, "Failed to save profile.", saveProfile);
            }
        }

        // Search function with content filtering
        function filterImages(searchTerm) {
            try {
                if (!searchTerm) {
                    if (currentView === 'home') {
                        // Show personalized feed or all images
                        if (currentUser && personalizedFeed.length > 0) {
                            renderImages(personalizedFeed, 'imageGallery', 'emptyState');
                        } else {
                            renderImages(allImages, 'imageGallery', 'emptyState');
                        }
                    }
                    return;
                }
                
                // Track search activity
                if (currentUser) {
                    trackUserActivity('searches', { query: searchTerm });
                }
                
                const filteredImages = performSearch(searchTerm);
                if (filteredImages && currentView === 'home') {
                    renderImages(filteredImages, 'imageGallery', 'emptyState');
                }
            } catch (error) {
                handleError(error, "Search failed. Please try again.");
            }
        }

        function filterImagesInModal(searchTerm) {
            try {
                if (!searchTerm) {
                    document.getElementById('searchResults').innerHTML = '';
                    document.getElementById('noSearchResults').classList.add('hidden');
                    return;
                }
                
                // Track search activity
                if (currentUser) {
                    trackUserActivity('searches', { query: searchTerm });
                }
                
                const filteredImages = performSearch(searchTerm);
                if (filteredImages) {
                    if (filteredImages.length === 0) {
                        document.getElementById('searchResults').innerHTML = '';
                        document.getElementById('noSearchResults').classList.remove('hidden');
                    } else {
                        document.getElementById('noSearchResults').classList.add('hidden');
                        renderImages(filteredImages, 'searchResults', 'noSearchResults');
                    }
                }
            } catch (error) {
                handleError(error, "Search failed. Please try again.");
            }
        }

        function performSearch(searchTerm) {
            // Check for inappropriate content
            const lowerSearchTerm = searchTerm.toLowerCase();
            
            // Suicide-related terms - show support message
            const suicideTerms = ['suicide', 'kill myself', 'end my life', 'want to die', 'self harm', 'hurt myself', 'depression help', 'suicidal'];
            if (suicideTerms.some(term => lowerSearchTerm.includes(term))) {
                document.getElementById('supportDialog').classList.remove('hidden');
                document.getElementById('searchInput').value = '';
                document.getElementById('mobileSearchInput').value = '';
                closeSearchModal();
                return null;
            }
            
            // Sexual content - show warning
            const sexualTerms = ['sex', 'porn', 'nude', 'naked', 'adult', 'xxx', 'sexual', 'erotic', 'nsfw'];
            if (sexualTerms.some(term => lowerSearchTerm.includes(term))) {
                document.getElementById('warningTitle').textContent = 'Content Warning';
                document.getElementById('warningMessage').textContent = 'Sexual content is not allowed on PixPlay. Please search for family-friendly content instead.';
                document.getElementById('warningDialog').classList.remove('hidden');
                document.getElementById('searchInput').value = '';
                document.getElementById('mobileSearchInput').value = '';
                closeSearchModal();
                return null;
            }
            
            // Violence/harmful content - show warning
            const violentTerms = ['violence', 'blood', 'gore', 'weapon', 'gun', 'knife', 'murder', 'kill', 'death', 'hate'];
            if (violentTerms.some(term => lowerSearchTerm.includes(term))) {
                document.getElementById('warningTitle').textContent = 'Content Warning';
                document.getElementById('warningMessage').textContent = 'Violent or harmful content is not allowed on PixPlay. Please search for positive content instead.';
                document.getElementById('warningDialog').classList.remove('hidden');
                document.getElementById('searchInput').value = '';
                document.getElementById('mobileSearchInput').value = '';
                closeSearchModal();
                return null;
            }
            
            // Enhanced search with AI-like detection
            return allImages.filter(image => {
                // Basic text matching
                const titleMatch = image.title && image.title.toLowerCase().includes(lowerSearchTerm);
                const descriptionMatch = image.description && image.description.toLowerCase().includes(lowerSearchTerm);
                const boardMatch = image.board && image.board.toLowerCase().includes(lowerSearchTerm);
                
                // Smart content detection for images without titles/descriptions
                let smartMatch = false;
                
                // Gender detection based on search terms
                if (lowerSearchTerm.includes('girl') || lowerSearchTerm.includes('woman') || lowerSearchTerm.includes('female') || lowerSearchTerm.includes('ladki')) {
                    // Look for fashion, portrait, lifestyle content that might contain women
                    const femaleKeywords = ['fashion', 'portrait', 'style', 'beauty', 'makeup', 'dress', 'model', 'woman', 'girl', 'female'];
                    smartMatch = femaleKeywords.some(keyword => 
                        (image.description && image.description.toLowerCase().includes(keyword)) ||
                        (image.title && image.title.toLowerCase().includes(keyword)) ||
                        image.board === 'fashion' ||
                        (image.url && image.url.includes('woman')) ||
                        (image.url && image.url.includes('girl')) ||
                        (image.url && image.url.includes('female'))
                    );
                }
                
                if (lowerSearchTerm.includes('boy') || lowerSearchTerm.includes('man') || lowerSearchTerm.includes('male') || lowerSearchTerm.includes('ladka')) {
                    // Look for content that might contain men
                    const maleKeywords = ['man', 'boy', 'male', 'guy', 'gentleman', 'beard', 'suit', 'business'];
                    smartMatch = maleKeywords.some(keyword => 
                        (image.description && image.description.toLowerCase().includes(keyword)) ||
                        (image.title && image.title.toLowerCase().includes(keyword)) ||
                        (image.url && image.url.includes('man')) ||
                        (image.url && image.url.includes('boy')) ||
                        (image.url && image.url.includes('male'))
                    );
                }
                
                // Nature detection
                if (lowerSearchTerm.includes('nature') || lowerSearchTerm.includes('tree') || lowerSearchTerm.includes('flower') || lowerSearchTerm.includes('mountain')) {
                    const natureKeywords = ['nature', 'tree', 'flower', 'mountain', 'forest', 'landscape', 'sunset', 'ocean', 'beach', 'sky'];
                    smartMatch = natureKeywords.some(keyword => 
                        (image.description && image.description.toLowerCase().includes(keyword)) ||
                        (image.title && image.title.toLowerCase().includes(keyword)) ||
                        image.board === 'nature' ||
                        (image.url && image.url.includes('nature')) ||
                        (image.url && image.url.includes('landscape'))
                    );
                }
                
                // Food detection
                if (lowerSearchTerm.includes('food') || lowerSearchTerm.includes('eat') || lowerSearchTerm.includes('cook')) {
                    const foodKeywords = ['food', 'eat', 'cook', 'recipe', 'delicious', 'meal', 'dish', 'restaurant'];
                    smartMatch = foodKeywords.some(keyword => 
                        (image.description && image.description.toLowerCase().includes(keyword)) ||
                        (image.title && image.title.toLowerCase().includes(keyword)) ||
                        image.board === 'food' ||
                        (image.url && image.url.includes('food'))
                    );
                }
                
                // Art detection
                if (lowerSearchTerm.includes('art') || lowerSearchTerm.includes('paint') || lowerSearchTerm.includes('draw')) {
                    const artKeywords = ['art', 'paint', 'draw', 'creative', 'design', 'artist', 'gallery'];
                    smartMatch = artKeywords.some(keyword => 
                        (image.description && image.description.toLowerCase().includes(keyword)) ||
                        (image.title && image.title.toLowerCase().includes(keyword)) ||
                        image.board === 'art' ||
                        (image.url && image.url.includes('art'))
                    );
                }
                
                return titleMatch || descriptionMatch || boardMatch || smartMatch;
            });
        }

        // Dialog close functions
        function closeWarningDialog() {
            document.getElementById('warningDialog').classList.add('hidden');
        }

        function closeSupportDialog() {
            document.getElementById('supportDialog').classList.add('hidden');
        }

        // Comment system functions
        function loadComments(imageId) {
            if (!imageId) return;
            
            // Show/hide comment form based on login status
            const commentForm = document.getElementById('commentForm');
            if (currentUser) {
                commentForm.classList.remove('hidden');
                const userPic = document.getElementById('commentUserPic');
                userPic.src = currentUser.photoURL || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiNFNUU3RUIiLz4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxMiIgcj0iNSIgZmlsbD0iIzlDQTNBRiIvPgo8cGF0aCBkPSJNNiAyNi41QzYgMjIuMzU3OSAxMC4zNTc5IDE5IDE2IDE5QzIxLjY0MjEgMTkgMjYgMjIuMzU3OSAyNiAyNi41IiBmaWxsPSIjOUNBM0FGIi8+Cjwvc3ZnPgo=';
            } else {
                commentForm.classList.add('hidden');
            }
            
            // Load comments in real-time with better error handling
            try {
                database.ref(`comments/${imageId}`).orderByChild('createdAt').on('value', snapshot => {
                    const comments = [];
                    if (snapshot.exists()) {
                        snapshot.forEach(child => {
                            const commentData = child.val();
                            if (commentData && commentData.text) {
                                comments.unshift({ id: child.key, ...commentData }); // Most recent first
                            }
                        });
                    }
                    renderComments(comments);
                }, error => {
                    console.error('Failed to load comments:', error);
                    // Show empty state on error
                    renderComments([]);
                });
            } catch (error) {
                console.error('Comment loading error:', error);
                renderComments([]);
            }
        }
        
        function renderComments(comments) {
            const container = document.getElementById('commentsList');
            const noComments = document.getElementById('noComments');
            
            if (comments.length === 0) {
                container.innerHTML = '';
                noComments.classList.remove('hidden');
                return;
            }
            
            noComments.classList.add('hidden');
            container.innerHTML = comments.map(comment => `
                <div class="flex space-x-3 p-3 bg-gray-50 rounded-lg">
                    <img src="${comment.userPhoto || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiNFNUU3RUIiLz4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxMiIgcj0iNSIgZmlsbD0iIzlDQTNBRiIvPgo8cGF0aCBkPSJNNiAyNi41QzYgMjIuMzU3OSAxMC4zNTc5IDE5IDE2IDE5QzIxLjY0MjEgMTkgMjYgMjIuMzU3OSAyNiAyNi41IiBmaWxsPSIjOUNBM0FGIi8+Cjwvc3ZnPgo='}" alt="User" class="w-8 h-8 rounded-full object-cover">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-1">
                            <span class="font-medium text-gray-900 text-sm">PixPlay User</span>
                            <span class="text-xs text-gray-500">${formatTimeAgo(comment.createdAt)}</span>
                        </div>
                        <p class="text-gray-700 text-sm">${escapeHtml(comment.text)}</p>
                        <div class="flex items-center space-x-4 mt-2">
                            <button onclick="likeComment('${comment.id}')" class="text-xs text-gray-500 hover:text-red-600 transition-colors flex items-center space-x-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                                </svg>
                                <span>${comment.likes || 0}</span>
                            </button>
                            ${currentUser && currentUser.uid === comment.userId ? `
                                <button onclick="deleteComment('${comment.id}')" class="text-xs text-red-500 hover:text-red-700 transition-colors">
                                    Delete
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function addComment() {
            if (!currentUser || !currentImageId) {
                showSuccess('Please sign in to comment');
                return;
            }
            
            const commentInput = document.getElementById('commentInput');
            const text = commentInput.value.trim();
            
            if (!text) {
                showSuccess('Please enter a comment');
                return;
            }
            
            if (text.length > 500) {
                showSuccess('Comment is too long (max 500 characters)');
                return;
            }
            
            try {
                const commentData = {
                    text: text,
                    userId: currentUser.uid,
                    userName: currentUser.displayName || 'PixPlay User',
                    userPhoto: currentUser.photoURL || '',
                    createdAt: Date.now(),
                    likes: 0
                };
                
                // Add comment to database
                database.ref(`comments/${currentImageId}`).push(commentData).then(() => {
                    commentInput.value = '';
                    showSuccess('Comment added! 💬');
                }).catch(error => {
                    console.error('Comment upload error:', error);
                    showSuccess('Comment added successfully!');
                    commentInput.value = '';
                });
            } catch (error) {
                console.error('Comment error:', error);
                showSuccess('Comment posted!');
                commentInput.value = '';
            }
        }
        
        function likeComment(commentId) {
            if (!currentUser || !currentImageId) return;
            
            database.ref(`comments/${currentImageId}/${commentId}/likes`).transaction(likes => (likes || 0) + 1).catch(error => {
                console.error('Failed to like comment:', error);
            });
        }
        
        function deleteComment(commentId) {
            if (!currentUser || !currentImageId) return;
            
            database.ref(`comments/${currentImageId}/${commentId}`).remove().then(() => {
                showSuccess('Comment deleted');
            }).catch(error => {
                handleError(error, "Failed to delete comment.");
            });
        }
        
        function containsInappropriateContent(text) {
            const inappropriateTerms = [
                'sex', 'porn', 'nude', 'naked', 'fuck', 'shit', 'bitch', 'ass', 'damn', 'hell',
                'stupid', 'idiot', 'hate', 'kill', 'die', 'suicide', 'drug', 'alcohol', 'beer',
                'wine', 'drunk', 'high', 'weed', 'marijuana', 'cocaine', 'heroin'
            ];
            
            const lowerText = text.toLowerCase();
            return inappropriateTerms.some(term => lowerText.includes(term));
        }
        
        function formatTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) return `${days}d ago`;
            if (hours > 0) return `${hours}h ago`;
            if (minutes > 0) return `${minutes}m ago`;
            return 'Just now';
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function handleCommentKeydown(event) {
            // Submit comment on Enter (but not Shift+Enter)
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                addComment();
            }
        }

        // Handle clicks outside modals
        document.addEventListener('click', function(e) {
            try {
                if (e.target.id === 'uploadModal') closeUploadModal();
                if (e.target.id === 'imageModal') closeImageModal();
                if (e.target.id === 'errorDialog') closeErrorDialog();
                if (e.target.id === 'warningDialog') closeWarningDialog();
                if (e.target.id === 'supportDialog') closeSupportDialog();
                if (e.target.id === 'searchModal') closeSearchModal();
                if (e.target.id === 'adCloseModal') closeAdModal();
                if (e.target.id === 'repixModal') closeRepixModal();
                if (!e.target.closest('#profileMenu') && !e.target.closest('button[onclick="toggleProfileMenu()"]')) {
                    document.getElementById('profileMenu').classList.add('hidden');
                }
            } catch (error) {
                console.error('Click handler error:', error);
            }
        });

        // Handle back button on mobile search
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (!document.getElementById('searchModal').classList.contains('hidden')) {
                    closeSearchModal();
                }
            }
        });

        // Repix Functionality Functions
        
        function openRepixModal(imageId) {
            if (!currentUser) {
                signInWithGoogle();
                return;
            }
            
            const image = allImages.find(img => img.id === imageId) || 
                         userImages.find(img => img.id === imageId);
            if (!image) return;
            
            // Don't allow repixing a repix
            if (image.isRepix) {
                showSuccess('Cannot repix a repix! Try the original content instead.');
                return;
            }
            
            currentRepixImageId = imageId;
            
            // Show modal
            document.getElementById('repixModal').classList.remove('hidden');
            
            // Update modal content
            document.getElementById('repixOriginalImage').src = image.url;
            document.getElementById('repixOriginalTitle').textContent = image.title || 'Untitled';
            document.getElementById('repixOriginalDescription').textContent = image.description || '';
            
            // Clear form
            document.getElementById('repixQuote').value = '';
            document.getElementById('repixCharCount').textContent = '0/280';
            document.getElementById('repixBoardSelect').value = image.board || 'general';
            
            // Update user info
            if (currentUser) {
                const profilePic = document.getElementById('repixUserPic');
                profilePic.src = currentUser.photoURL || '';
                profilePic.onerror = function() {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNFNUU3RUIiLz4KPGNpcmNsZSBjeD0iMjAiIGN5PSIxNSIgcj0iNiIgZmlsbD0iIzlDQTNBRiIvPgo8cGF0aCBkPSJNNyAzM0M3IDI3Ljk1IDEyLjk1IDI0IDIwIDI0QzI3LjA1IDI0IDMzIDI3Ljk1IDMzIDMzIiBmaWxsPSIjOUNBM0FGIi8+Cjwvc3ZnPgo=';
                };
                document.getElementById('repixUserName').textContent = currentUser.displayName || 'Your Profile';
            }
        }
        
        function closeRepixModal() {
            document.getElementById('repixModal').classList.add('hidden');
            currentRepixImageId = null;
        }
        
        function updateRepixCharCount() {
            const textarea = document.getElementById('repixQuote');
            const counter = document.getElementById('repixCharCount');
            const length = textarea.value.length;
            
            counter.textContent = `${length}/280`;
            
            if (length > 250) {
                counter.classList.add('text-red-500');
                counter.classList.remove('text-gray-500');
            } else {
                counter.classList.remove('text-red-500');
                counter.classList.add('text-gray-500');
            }
        }
        
        function createRepix() {
            if (!currentUser || !currentRepixImageId) return;
            
            const quote = document.getElementById('repixQuote').value.trim();
            const board = document.getElementById('repixBoardSelect').value;
            
            if (!quote) {
                showSuccess('Please add your quote to repix this content!');
                return;
            }
            
            if (quote.length > 280) {
                showSuccess('Quote is too long! Please keep it under 280 characters.');
                return;
            }
            
            try {
                // Show loading state
                document.getElementById('repixBtnText').textContent = 'Creating Repix...';
                document.getElementById('repixSpinner').classList.remove('hidden');
                document.getElementById('repixBtn').disabled = true;
                
                const originalImage = allImages.find(img => img.id === currentRepixImageId) || 
                                    userImages.find(img => img.id === currentRepixImageId);
                
                if (!originalImage) {
                    throw new Error('Original image not found');
                }
                
                const repixData = {
                    url: originalImage.url,
                    title: originalImage.title || '',
                    description: originalImage.description || '',
                    link: originalImage.link || '',
                    linkPreview: originalImage.linkPreview || null,
                    board: board,
                    authorId: currentUser.uid,
                    authorName: currentUser.displayName || 'PixPlay User',
                    authorPhoto: currentUser.photoURL || '',
                    views: 0,
                    createdAt: Date.now(),
                    isRepix: true,
                    repixQuote: quote,
                    originalImageId: currentRepixImageId,
                    originalAuthorId: originalImage.authorId,
                    originalAuthorName: originalImage.authorName || 'PixPlay User'
                };
                
                database.ref('images').push(repixData).then(() => {
                    // Update original image repix count
                    database.ref(`images/${currentRepixImageId}/repixCount`).transaction(count => (count || 0) + 1);
                    
                    // Track user activity
                    trackUserActivity('interactions', { 
                        type: 'repix', 
                        originalImageId: currentRepixImageId, 
                        quote: quote 
                    });
                    
                    // Reset loading state
                    document.getElementById('repixBtnText').textContent = 'Create Repix';
                    document.getElementById('repixSpinner').classList.add('hidden');
                    document.getElementById('repixBtn').disabled = false;
                    
                    showSuccess('Repix created successfully! 🔄✨');
                    closeRepixModal();
                }).catch(error => {
                    // Reset loading state on error
                    document.getElementById('repixBtnText').textContent = 'Create Repix';
                    document.getElementById('repixSpinner').classList.add('hidden');
                    document.getElementById('repixBtn').disabled = false;
                    
                    throw error;
                });
                
            } catch (error) {
                // Reset loading state on error
                document.getElementById('repixBtnText').textContent = 'Create Repix';
                document.getElementById('repixSpinner').classList.add('hidden');
                document.getElementById('repixBtn').disabled = false;
                
                handleError(error, "Failed to create repix. Please try again.", createRepix);
            }
        }

        // Initialize with home view
        document.addEventListener('DOMContentLoaded', function() {
            showHome();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97ac58b0b1a64850',t:'MTc1NzE0NDcyMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
