<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PixPlay - Discover & Share Images</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <style>
        /* Pinterest-style responsive grid */
        .pinterest-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            grid-gap: 16px;
            padding: 16px;
        }
        
        @media (max-width: 768px) {
            .pinterest-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                grid-gap: 8px;
                padding: 8px;
            }
        }
        
        @media (max-width: 480px) {
            .pinterest-grid {
                grid-template-columns: repeat(2, 1fr);
                grid-gap: 6px;
                padding: 6px;
            }
        }
        
        .masonry {
            columns: 5;
            column-gap: 1rem;
        }
        .masonry-item {
            break-inside: avoid;
            margin-bottom: 1rem;
            display: inline-block;
            width: 100%;
        }
        @media (max-width: 1280px) { .masonry { columns: 4; } }
        @media (max-width: 1024px) { .masonry { columns: 3; } }
        @media (max-width: 768px) { .masonry { columns: 2; } }
        @media (max-width: 640px) { .masonry { columns: 1; } }
        
        .pin-card {
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s ease;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
        }
        .pin-card:hover {
            -webkit-transform: translateY(-2px);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        .pin-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: -webkit-linear-gradient(top, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.3) 100%);
            background: linear-gradient(180deg, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.3) 100%);
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .pin-card:hover .pin-overlay {
            opacity: 1;
        }
        .pin-actions {
            position: absolute;
            top: 12px;
            right: 12px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .pin-card:hover .pin-actions {
            opacity: 1;
        }
        .upload-area {
            border: 2px dashed #e5e7eb;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            border-color: #dc2626;
            background-color: #fef2f2;
        }
        .upload-area.dragover {
            border-color: #dc2626;
            background-color: #fef2f2;
        }
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
        }
        .search-suggestion {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
        }
        .search-suggestion:hover {
            background-color: #f9fafb;
        }
        .search-suggestion:last-child {
            border-bottom: none;
        }
        .modal-backdrop {
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }
        .safety-modal {
            animation: fadeInScale 0.3s ease-out;
        }
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-white">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50 border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <!-- Mobile Menu Button -->
                    <button onclick="toggleMobileMenu()" class="md:hidden p-2 text-gray-600 hover:text-red-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                    <h1 class="text-xl md:text-2xl font-bold text-red-600">PixPlay</h1>
                    <nav class="hidden md:flex space-x-6">
                        <button onclick="showHome()" class="text-gray-900 hover:text-red-600 font-medium">Home</button>
                        <button onclick="showSaved()" class="text-gray-600 hover:text-red-600">Saved Pix</button>
                        <button onclick="showMyPins()" class="text-gray-600 hover:text-red-600">My Pix</button>
                    </nav>
                </div>
                
                <div class="flex-1 max-w-2xl mx-2 md:mx-8">
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="Search for ideas" 
                               class="w-full px-3 md:px-4 py-2 md:py-3 bg-gray-100 rounded-full focus:outline-none focus:ring-2 focus:ring-red-500 text-sm md:text-base"
                               oninput="handleSearch()" onkeydown="handleSearchKeydown(event)">
                        <button onclick="performSearch()" class="absolute right-2 md:right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-red-600">
                            <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </button>
                        <div id="searchSuggestions" class="search-suggestions hidden"></div>
                    </div>
                </div>

                <div class="flex items-center space-x-2 md:space-x-4">
                    <button onclick="openUploadModal()" class="bg-red-600 text-white px-3 md:px-4 py-2 rounded-full hover:bg-red-700 transition-colors text-sm md:text-base">
                        <span class="hidden sm:inline">Create</span>
                        <svg class="w-4 h-4 sm:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                    </button>
                    <div id="userSection" class="hidden flex items-center space-x-2 md:space-x-3">
                        <button onclick="openSettings()" class="p-2 text-gray-600 hover:text-red-600 rounded-full hover:bg-gray-100">
                            <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </button>
                        <img id="userAvatar" class="w-7 h-7 md:w-8 md:h-8 rounded-full cursor-pointer" onclick="openSettings()">
                    </div>
                    <div id="loginSection">
                        <button onclick="signInWithGoogle()" class="bg-blue-600 text-white px-3 md:px-4 py-2 rounded-full hover:bg-blue-700 transition-colors text-sm md:text-base">
                            <span class="hidden sm:inline">Sign in with Google</span>
                            <span class="sm:hidden">Sign in</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Mobile Navigation Menu -->
        <div id="mobileMenu" class="md:hidden bg-white border-t hidden">
            <div class="px-4 py-3 space-y-2">
                <button onclick="showHome(); closeMobileMenu()" class="w-full text-left px-3 py-2 text-gray-900 hover:text-red-600 hover:bg-gray-50 rounded-lg font-medium">
                    <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                    </svg>
                    Home
                </button>
                <button onclick="showSaved(); closeMobileMenu()" class="w-full text-left px-3 py-2 text-gray-600 hover:text-red-600 hover:bg-gray-50 rounded-lg">
                    <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"/>
                    </svg>
                    Saved Pix
                </button>
                <button onclick="showMyPins(); closeMobileMenu()" class="w-full text-left px-3 py-2 text-gray-600 hover:text-red-600 hover:bg-gray-50 rounded-lg">
                    <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                    </svg>
                    My Pix
                </button>
                <div class="border-t pt-2 mt-2" id="mobileUserSection">
                    <!-- User options will be added here -->
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-4 md:py-8">
        <!-- Home View -->
        <div id="homeView">
            <div class="pinterest-grid" id="imageGallery">
                <!-- Images will be loaded here -->
            </div>
        </div>

        <!-- Saved View -->
        <div id="savedView" class="hidden">
            <h2 class="text-xl md:text-2xl font-bold mb-4 md:mb-6 px-4">Saved Pix</h2>
            <div class="pinterest-grid" id="savedGallery">
                <!-- Saved images will be loaded here -->
            </div>
        </div>

        <!-- My Pins View -->
        <div id="myPinsView" class="hidden">
            <div class="flex justify-between items-center mb-4 md:mb-6 px-4">
                <h2 class="text-xl md:text-2xl font-bold">My Pix</h2>
                <div id="myPinsStats" class="text-sm text-gray-600">
                    <!-- Stats will be shown here -->
                </div>
            </div>
            <div class="pinterest-grid" id="myPinsGallery">
                <!-- User's images will be loaded here -->
            </div>
        </div>
    </main>

    <!-- Upload Modal -->
    <div id="uploadModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto mx-4">
            <div class="p-4 md:p-6">
                <div class="flex justify-between items-center mb-4 md:mb-6">
                    <h3 class="text-lg md:text-xl font-semibold">Create Pix</h3>
                    <button onclick="closeUploadModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                    <div>
                        <div class="upload-area p-6 md:p-8 text-center rounded-2xl mb-4" id="uploadArea">
                            <svg class="w-10 h-10 md:w-12 md:h-12 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            <p class="text-gray-600 mb-2 text-sm md:text-base">Choose a file or drag and drop it here</p>
                            <p class="text-xs md:text-sm text-gray-400">We recommend using high quality .jpg files</p>
                            <input type="file" id="imageInput" accept="image/*" class="hidden">
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                            <input type="text" id="pinTitle" placeholder="Add a title" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <textarea id="pinDescription" rows="3" placeholder="Tell everyone what your Pin is about" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"></textarea>
                        </div>
                        
                        <button onclick="uploadImage()" class="w-full bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 transition-colors font-medium">
                            Save Pix
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pin Detail Modal -->
    <div id="pinModal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="grid grid-cols-1 lg:grid-cols-2">
                <div class="relative">
                    <img id="modalImage" class="w-full h-full object-cover" alt="">
                    <button onclick="closePinModal()" class="absolute top-4 right-4 bg-white rounded-full p-2 shadow-lg hover:bg-gray-100">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex space-x-3">
                            <button onclick="savePin()" class="bg-red-600 text-white px-6 py-2 rounded-full hover:bg-red-700 transition-colors font-medium">
                                Save
                            </button>
                            <button onclick="downloadImage()" class="border border-gray-300 text-gray-700 px-6 py-2 rounded-full hover:bg-gray-50 transition-colors font-medium">
                                Download
                            </button>
                        </div>
                        <button class="p-2 text-gray-600 hover:text-red-600 rounded-full hover:bg-gray-100">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="mb-6">
                        <div class="flex items-center space-x-3 mb-4">
                            <img class="w-10 h-10 rounded-full" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNGM0Y0RjYiLz4KPHN2ZyB4PSI4IiB5PSI4IiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSI+CjxwYXRoIGQ9Ik0yMCAyMXYtMmE0IDQgMCAwIDAtNC00SDh2LTJhNCA0IDAgMCAwLTQtNEg0djJhNCA0IDAgMCAwIDQgNGg4djJhNCA0IDAgMCAwIDQgNGgyeiIgZmlsbD0iIzlDQTNBRiIvPgo8Y2lyY2xlIGN4PSIxMiIgY3k9IjciIHI9IjQiIGZpbGw9IiM5Q0EzQUYiLz4KPC9zdmc+Cjwvc3ZnPgo=" alt="User">
                            <div>
                                <div class="font-medium">Anonymous User</div>
                                <div class="text-sm text-gray-500">0 followers</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ad Space for Monetized Content -->
                    <div id="adSpace" class="hidden bg-gray-50 p-4 rounded-lg mb-6">
                        <div class="text-xs text-gray-500 mb-2 text-center">Advertisement</div>
                        <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-6 rounded text-center">
                            <div class="font-bold mb-2">Your Ad Here</div>
                            <div class="text-sm opacity-90">Monetized content ad space</div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <h3 class="font-semibold text-lg mb-2">Comments</h3>
                            <div class="space-y-3" id="commentsList">
                                <!-- Comments will be loaded here -->
                            </div>
                        </div>
                        
                        <div class="flex space-x-3">
                            <img class="w-8 h-8 rounded-full" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiNGM0Y0RjYiLz4KPHN2ZyB4PSI2IiB5PSI2IiB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgZmlsbD0ibm9uZSI+CjxwYXRoIGQ9Ik0xNiAxN3YtMmEzIDMgMCAwIDAtMy0zSDd2LTJhMyAzIDAgMCAwLTMtM0g0djJhMyAzIDAgMCAwIDMgM2g2djJhMyAzIDAgMCAwIDMgM2gyeiIgZmlsbD0iIzlDQTNBRiIvPgo8Y2lyY2xlIGN4PSIxMCIgY3k9IjYiIHI9IjMiIGZpbGw9IiM5Q0EzQUYiLz4KPC9zdmc+Cjwvc3ZnPgo=" alt="User">
                            <input type="text" id="commentInput" placeholder="Add a comment" class="flex-1 p-2 border-b border-gray-200 focus:outline-none focus:border-red-500">
                            <button onclick="addComment()" class="text-red-600 hover:text-red-700 font-medium">Post</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Safety Warning Modal -->
    <div id="safetyModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full safety-modal">
            <div class="p-6 text-center">
                <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-semibold mb-4" id="safetyTitle">Content Warning</h3>
                <p class="text-gray-600 mb-6" id="safetyMessage"></p>
                <button onclick="closeSafetyModal()" class="w-full bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 transition-colors font-medium">
                    I Understand
                </button>
            </div>
        </div>
    </div>

    <!-- Support Modal -->
    <div id="supportModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full safety-modal">
            <div class="p-6 text-center">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-semibold mb-4">You Matter</h3>
                <p class="text-gray-600 mb-6">If you're going through a tough time, please know that you're not alone. There are people who care and want to help.</p>
                <div class="space-y-3 mb-6">
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <div class="font-medium">Crisis Text Line</div>
                        <div class="text-sm text-gray-600">Text HOME to 741741</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <div class="font-medium">National Suicide Prevention Lifeline</div>
                        <div class="text-sm text-gray-600">988 or 1-800-273-8255</div>
                    </div>
                </div>
                <button onclick="closeSupportModal()" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors font-medium">
                    Thank You
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold">Settings</h3>
                    <button onclick="closeSettings()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="space-y-6">
                    <div class="text-center">
                        <div class="relative inline-block">
                            <img id="settingsAvatar" class="w-20 h-20 rounded-full mx-auto" src="">
                            <button onclick="changeProfilePicture()" class="absolute bottom-0 right-0 bg-red-600 text-white rounded-full p-2 hover:bg-red-700">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                                </svg>
                            </button>
                        </div>
                        <input type="file" id="profilePictureInput" accept="image/*" class="hidden">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Display Name</label>
                        <input type="text" id="displayName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Bio</label>
                        <textarea id="userBio" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Tell people about yourself"></textarea>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="saveProfile()" class="flex-1 bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 transition-colors font-medium">
                            Save Changes
                        </button>
                        <button onclick="signOut()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium">
                            Sign Out
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDjfNlHwhT4xYb7vVym_SAqMlSuY_TMz0o",
            authDomain: "orioplay.firebaseapp.com",
            databaseURL: "https://orioplay-default-rtdb.firebaseio.com",
            projectId: "orioplay",
            storageBucket: "orioplay.firebasestorage.app",
            messagingSenderId: "300811706751",
            appId: "1:300811706751:web:bdce98b1ba7e11d34d7a4a"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Global variables
        let currentUser = null;
        let currentView = 'home';
        let currentPinId = null;
        let allPins = [];
        let savedPins = [];
        let userPins = [];
        let searchTimeout = null;
        let currentSearchTerm = '';
        let filteredPins = [];
        let adsData = [];
        let hiddenAds = [];

        // Initialize app
        function init() {
            setupEventListeners();
            auth.onAuthStateChanged(handleAuthStateChange);
            loadPins();
            loadAds();
            setupSearchEventListeners();
        }

        function setupSearchEventListeners() {
            // Close search suggestions when clicking outside
            document.addEventListener('click', function(e) {
                const searchInput = document.getElementById('searchInput');
                const suggestions = document.getElementById('searchSuggestions');
                if (!searchInput.contains(e.target) && !suggestions.contains(e.target)) {
                    suggestions.classList.add('hidden');
                }
            });
        }

        function handleSearch() {
            const searchInput = document.getElementById('searchInput');
            const query = searchInput.value.trim().toLowerCase();
            
            // Clear previous timeout
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            // Check for sensitive content
            if (checkSensitiveContent(query)) {
                return;
            }
            
            // Debounce search
            searchTimeout = setTimeout(() => {
                if (query.length > 0) {
                    showSearchSuggestions(query);
                    performSearchFilter(query);
                } else {
                    hideSearchSuggestions();
                    showAllPins();
                }
            }, 300);
        }

        function handleSearchKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                performSearch();
            }
        }

        function checkSensitiveContent(query) {
            const suicideKeywords = ['suicide', 'kill myself', 'end my life', 'want to die', 'self harm', 'hurt myself'];
            const sexualKeywords = ['sex', 'porn', 'nude', 'naked', 'adult', 'xxx', 'sexual'];
            
            // Check for suicide-related content
            for (let keyword of suicideKeywords) {
                if (query.includes(keyword)) {
                    showSupportModal();
                    document.getElementById('searchInput').value = '';
                    return true;
                }
            }
            
            // Check for sexual content
            for (let keyword of sexualKeywords) {
                if (query.includes(keyword)) {
                    showSafetyWarning();
                    document.getElementById('searchInput').value = '';
                    return true;
                }
            }
            
            return false;
        }

        function showSafetyWarning() {
            document.getElementById('safetyTitle').textContent = 'Content Warning';
            document.getElementById('safetyMessage').textContent = 'This type of content is not allowed on PixPlay. Please search for appropriate content only.';
            document.getElementById('safetyModal').classList.remove('hidden');
        }

        function showSupportModal() {
            document.getElementById('supportModal').classList.remove('hidden');
        }

        function closeSafetyModal() {
            document.getElementById('safetyModal').classList.add('hidden');
        }

        function closeSupportModal() {
            document.getElementById('supportModal').classList.add('hidden');
        }

        function showSearchSuggestions(query) {
            const suggestions = document.getElementById('searchSuggestions');
            const commonSearches = [
                'nature photography', 'food recipes', 'home decor', 'fashion style', 
                'travel destinations', 'art inspiration', 'diy projects', 'wedding ideas',
                'fitness motivation', 'garden design', 'architecture', 'photography tips'
            ];
            
            const filteredSuggestions = commonSearches.filter(item => 
                item.toLowerCase().includes(query)
            ).slice(0, 5);
            
            if (filteredSuggestions.length > 0) {
                suggestions.innerHTML = filteredSuggestions.map(suggestion => 
                    `<div class="search-suggestion" onclick="selectSuggestion('${suggestion}')">${suggestion}</div>`
                ).join('');
                suggestions.classList.remove('hidden');
            } else {
                hideSearchSuggestions();
            }
        }

        function hideSearchSuggestions() {
            document.getElementById('searchSuggestions').classList.add('hidden');
        }

        function selectSuggestion(suggestion) {
            document.getElementById('searchInput').value = suggestion;
            hideSearchSuggestions();
            performSearchFilter(suggestion.toLowerCase());
        }

        function performSearch() {
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            if (query && !checkSensitiveContent(query)) {
                performSearchFilter(query);
                hideSearchSuggestions();
            }
        }

        function performSearchFilter(query) {
            currentSearchTerm = query;
            
            if (query === '') {
                showAllPins();
                return;
            }
            
            // Filter pins based on tags, descriptions, or any metadata
            filteredPins = allPins.filter(pin => {
                const searchableText = [
                    pin.tags || '',
                    pin.description || '',
                    pin.category || '',
                    pin.userDisplayName || ''
                ].join(' ').toLowerCase();
                
                return searchableText.includes(query);
            });
            
            displayPinsWithAds(filteredPins, 'imageGallery');
            
            // Show search results message
            if (filteredPins.length === 0) {
                document.getElementById('imageGallery').innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-gray-400 text-6xl mb-4">🔍</div>
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">No results found</h3>
                        <p class="text-gray-500">Try searching for something else</p>
                    </div>
                `;
            }
        }

        function showAllPins() {
            currentSearchTerm = '';
            filteredPins = [];
            displayPinsWithAds(allPins, 'imageGallery');
        }

        function setupEventListeners() {
            const uploadArea = document.getElementById('uploadArea');
            const imageInput = document.getElementById('imageInput');
            const profilePictureInput = document.getElementById('profilePictureInput');

            uploadArea.addEventListener('click', () => imageInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);

            imageInput.addEventListener('change', handleImageSelect);
            profilePictureInput.addEventListener('change', handleProfilePictureSelect);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        }

        function handleImageSelect(e) {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        }

        function handleProfilePictureSelect(e) {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('settingsAvatar').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function handleFileSelect(file) {
            if (file && file.type.startsWith('image/')) {
                // Check file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showError('File size too large. Please select an image under 5MB.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const uploadArea = document.getElementById('uploadArea');
                        uploadArea.innerHTML = `
                            <img src="${e.target.result}" class="max-h-48 mx-auto rounded-lg" style="max-width: 100%; height: auto;">
                            <p class="text-sm text-gray-600 mt-2">Image selected</p>
                        `;
                        uploadArea.dataset.imageData = e.target.result;
                    } catch (error) {
                        console.error('Error processing image:', error);
                        showError('Error processing image. Please try again.');
                    }
                };
                reader.onerror = function() {
                    showError('Error reading file. Please try again.');
                };
                reader.readAsDataURL(file);
            } else {
                showError('Please select a valid image file.');
            }
        }

        function showError(message) {
            // Create a simple error notification
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }

        function showSuccess(message) {
            // Create a simple success notification
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.parentNode.removeChild(successDiv);
                }
            }, 3000);
        }

        function handleAuthStateChange(user) {
            currentUser = user;
            if (user) {
                showUserSection(user);
                loadUserData();
            } else {
                showLoginSection();
            }
            updateMobileUserSection();
        }

        function showUserSection(user) {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('userSection').classList.remove('hidden');
            document.getElementById('userAvatar').src = user.photoURL || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiNGM0Y0RjYiLz4KPHN2ZyB4PSI2IiB5PSI2IiB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgZmlsbD0ibm9uZSI+CjxwYXRoIGQ9Ik0xNiAxN3YtMmEzIDMgMCAwIDAtMy0zSDd2LTJhMyAzIDAgMCAwLTMtM0g0djJhMyAzIDAgMCAwIDMgM2g2djJhMyAzIDAgMCAwIDMgM2gyeiIgZmlsbD0iIzlDQTNBRiIvPgo8Y2lyY2xlIGN4PSIxMCIgY3k9IjYiIHI9IjMiIGZpbGw9IiM5Q0EzQUYiLz4KPC9zdmc+Cjwvc3ZnPgo=';
        }

        function showLoginSection() {
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('userSection').classList.add('hidden');
        }

        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            
            // Show loading state
            const signInButton = document.querySelector('button[onclick="signInWithGoogle()"]');
            const originalText = signInButton.textContent;
            signInButton.textContent = 'Signing in...';
            signInButton.disabled = true;
            
            auth.signInWithPopup(provider).catch(error => {
                console.error('Sign in error:', error);
                let errorMessage = 'Sign in failed. Please try again.';
                
                switch (error.code) {
                    case 'auth/popup-closed-by-user':
                        errorMessage = 'Sign in was cancelled.';
                        break;
                    case 'auth/popup-blocked':
                        errorMessage = 'Pop-up was blocked. Please allow pop-ups and try again.';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = 'Network error. Please check your connection.';
                        break;
                }
                
                showError(errorMessage);
            }).finally(() => {
                signInButton.textContent = originalText;
                signInButton.disabled = false;
            });
        }

        function signOut() {
            auth.signOut();
            closeSettings();
        }

        function loadUserData() {
            if (!currentUser) return;
            
            // Load user profile data
            database.ref(`users/${currentUser.uid}`).once('value', (snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    document.getElementById('displayName').value = userData.displayName || currentUser.displayName;
                    document.getElementById('userBio').value = userData.bio || '';
                    document.getElementById('settingsAvatar').src = userData.photoURL || currentUser.photoURL;
                }
            });

            // Load user's saved pins
            database.ref(`savedPins/${currentUser.uid}`).on('value', (snapshot) => {
                savedPins = [];
                snapshot.forEach((child) => {
                    savedPins.push(child.key);
                });
                if (currentView === 'saved') {
                    showSaved();
                }
            });

            // Load user's pins
            database.ref('pins').orderByChild('userId').equalTo(currentUser.uid).on('value', (snapshot) => {
                userPins = [];
                snapshot.forEach((child) => {
                    userPins.push({ id: child.key, ...child.val() });
                });
                if (currentView === 'myPins') {
                    showMyPins();
                }
            });
        }

        function loadPins() {
            database.ref('pins').on('value', (snapshot) => {
                allPins = [];
                snapshot.forEach((child) => {
                    const pin = { id: child.key, ...child.val() };
                    allPins.push(pin);
                });
                if (currentView === 'home') {
                    displayPinsWithAds(allPins, 'imageGallery');
                }
            });
        }

        function loadAds() {
            database.ref('ads').on('value', (snapshot) => {
                adsData = [];
                snapshot.forEach((child) => {
                    const ad = { id: child.key, ...child.val() };
                    if (ad.active !== false) {
                        adsData.push(ad);
                    }
                });
            });
        }

        function displayPins(pins, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            pins.forEach(pin => {
                const pinCard = createPinCard(pin);
                container.appendChild(pinCard);
            });
        }

        function displayPinsWithAds(pins, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            pins.forEach((pin, index) => {
                const pinCard = createPinCard(pin);
                container.appendChild(pinCard);

                // Show ad after every 7-8 pins
                if ((index + 1) % 7 === 0 && adsData.length > 0) {
                    const randomAd = adsData[Math.floor(Math.random() * adsData.length)];
                    if (!hiddenAds.includes(randomAd.id)) {
                        const adCard = createAdCard(randomAd);
                        container.appendChild(adCard);
                    }
                }
            });
        }

        function createPinCard(pin) {
            const card = document.createElement('div');
            card.className = 'pin-card bg-white shadow-sm rounded-2xl overflow-hidden cursor-pointer transition-transform hover:scale-105';
            card.onclick = () => openPinModal(pin.id);

            const isSaved = savedPins.includes(pin.id);
            const isMonetized = pin.views >= 2000;
            const isOwner = currentUser && pin.userId === currentUser.uid;

            card.innerHTML = `
                <div class="relative">
                    <img src="${pin.imageData}" alt="Pin" class="w-full h-auto object-cover" style="aspect-ratio: auto;">
                    <div class="pin-overlay"></div>
                    <div class="pin-actions">
                        <button onclick="event.stopPropagation(); toggleSavePin('${pin.id}')" 
                                class="bg-red-600 text-white px-2 md:px-3 py-1 rounded-full text-xs md:text-sm hover:bg-red-700 transition-colors">
                            ${isSaved ? 'Saved' : 'Save'}
                        </button>
                    </div>
                    ${isMonetized ? '<div class="absolute top-2 left-2 bg-green-500 text-white px-2 py-1 rounded-full text-xs">💰 Monetized</div>' : ''}
                    ${isOwner ? `<div class="absolute bottom-2 left-2 bg-blue-500 text-white px-2 py-1 rounded-full text-xs flex items-center space-x-1">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                            <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                        </svg>
                        <span>${pin.views || 0}</span>
                    </div>` : ''}
                </div>
                ${pin.title ? `<div class="p-3">
                    <h3 class="font-medium text-sm md:text-base text-gray-900 line-clamp-2">${pin.title}</h3>
                    ${pin.description ? `<p class="text-xs md:text-sm text-gray-600 mt-1 line-clamp-2">${pin.description}</p>` : ''}
                </div>` : ''}
            `;

            return card;
        }

        function createAdCard(ad) {
            const card = document.createElement('div');
            card.className = 'pin-card bg-white shadow-sm rounded-2xl overflow-hidden relative';
            
            card.innerHTML = `
                <div class="relative">
                    <button onclick="hideAd('${ad.id}')" class="absolute top-2 right-2 bg-white bg-opacity-80 hover:bg-opacity-100 rounded-full p-1 z-10 transition-all">
                        <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                    <div class="absolute top-2 left-2 bg-blue-500 text-white px-2 py-1 rounded-full text-xs font-medium">
                        Sponsored
                    </div>
                    ${ad.previewImage ? `<img src="${ad.previewImage}" alt="Ad Preview" class="w-full h-auto object-cover" style="aspect-ratio: auto;">` : ''}
                </div>
                <div class="p-4">
                    <div class="flex items-center space-x-2 mb-3">
                        ${ad.logo ? `<img src="${ad.logo}" alt="${ad.brandName}" class="w-8 h-8 rounded-full object-cover">` : ''}
                        <div>
                            <div class="font-semibold text-sm text-gray-900">${ad.brandName || 'Pulse by Oriontec'}</div>
                            ${ad.tagline ? `<div class="text-xs text-gray-600">${ad.tagline}</div>` : ''}
                        </div>
                    </div>
                    ${ad.description ? `<p class="text-sm text-gray-700 mb-3 line-clamp-2">${ad.description}</p>` : ''}
                    <button onclick="window.open('${ad.ctaLink || 'https://pulse.oriontec.xyz'}', '_blank')" 
                            class="w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors font-medium text-sm">
                        ${ad.ctaText || 'Try Pulse Now'}
                    </button>
                </div>
            `;

            return card;
        }

        function hideAd(adId) {
            hiddenAds.push(adId);
            // Refresh current view to remove the ad
            if (currentView === 'home') {
                if (currentSearchTerm) {
                    displayPinsWithAds(filteredPins, 'imageGallery');
                } else {
                    displayPinsWithAds(allPins, 'imageGallery');
                }
            }
        }

        function showHome() {
            currentView = 'home';
            document.getElementById('homeView').classList.remove('hidden');
            document.getElementById('savedView').classList.add('hidden');
            document.getElementById('myPinsView').classList.add('hidden');
            
            // Show filtered pins if there's an active search, otherwise show all
            if (currentSearchTerm) {
                displayPinsWithAds(filteredPins, 'imageGallery');
            } else {
                displayPinsWithAds(allPins, 'imageGallery');
            }
        }

        function showSaved() {
            if (!currentUser) {
                showError('Please sign in to view saved pins');
                return;
            }
            currentView = 'saved';
            document.getElementById('homeView').classList.add('hidden');
            document.getElementById('savedView').classList.remove('hidden');
            document.getElementById('myPinsView').classList.add('hidden');
            
            const savedPinData = allPins.filter(pin => savedPins.includes(pin.id));
            displayPins(savedPinData, 'savedGallery');
        }

        function showMyPins() {
            if (!currentUser) {
                showError('Please sign in to view your pins');
                return;
            }
            currentView = 'myPins';
            document.getElementById('homeView').classList.add('hidden');
            document.getElementById('savedView').classList.add('hidden');
            document.getElementById('myPinsView').classList.remove('hidden');
            
            // Update stats
            const totalViews = userPins.reduce((sum, pin) => sum + (pin.views || 0), 0);
            document.getElementById('myPinsStats').innerHTML = `
                <div class="text-center">
                    <div class="text-lg font-bold text-gray-900">${userPins.length}</div>
                    <div class="text-xs text-gray-500">Pins</div>
                </div>
                <div class="text-center ml-4">
                    <div class="text-lg font-bold text-gray-900">${totalViews}</div>
                    <div class="text-xs text-gray-500">Total Views</div>
                </div>
            `;
            
            displayPins(userPins, 'myPinsGallery');
        }

        function openUploadModal() {
            if (!currentUser) {
                showError('Please sign in to upload images');
                return;
            }
            document.getElementById('uploadModal').classList.remove('hidden');
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').classList.add('hidden');
            resetUploadForm();
        }

        function resetUploadForm() {
            document.getElementById('uploadArea').innerHTML = `
                <svg class="w-10 h-10 md:w-12 md:h-12 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <p class="text-gray-600 mb-2 text-sm md:text-base">Choose a file or drag and drop it here</p>
                <p class="text-xs md:text-sm text-gray-400">We recommend using high quality .jpg files</p>
            `;
            document.getElementById('pinTitle').value = '';
            document.getElementById('pinDescription').value = '';
            delete document.getElementById('uploadArea').dataset.imageData;
        }

        function uploadImage() {
            const imageData = document.getElementById('uploadArea').dataset.imageData;
            const title = document.getElementById('pinTitle').value.trim();
            const description = document.getElementById('pinDescription').value.trim();
            
            if (!imageData) {
                showError('Please select an image');
                return;
            }

            if (!currentUser) {
                showError('Please sign in to upload images');
                return;
            }

            const newPin = {
                imageData: imageData,
                title: title,
                description: description,
                userId: currentUser.uid,
                userDisplayName: currentUser.displayName || 'Anonymous User',
                userPhotoURL: currentUser.photoURL || '',
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                views: 0,
                comments: {},
                tags: `${title} ${description}`.toLowerCase(),
                category: 'general'
            };

            // Show loading state
            const uploadButton = document.querySelector('#uploadModal button[onclick="uploadImage()"]');
            const originalText = uploadButton.textContent;
            uploadButton.textContent = 'Uploading...';
            uploadButton.disabled = true;

            database.ref('pins').push(newPin).then(() => {
                closeUploadModal();
                showSuccess('Pin uploaded successfully!');
            }).catch(error => {
                console.error('Upload error:', error);
                showError('Upload failed. Please try again.');
            }).finally(() => {
                uploadButton.textContent = originalText;
                uploadButton.disabled = false;
            });
        }

        function openPinModal(pinId) {
            const pin = allPins.find(p => p.id === pinId);
            if (!pin) return;

            currentPinId = pinId;
            
            // Increment view count
            database.ref(`pins/${pinId}/views`).transaction((currentViews) => {
                return (currentViews || 0) + 1;
            });

            // Update modal content
            document.getElementById('modalImage').src = pin.imageData;
            
            // Show ads for monetized content
            const adSpace = document.getElementById('adSpace');
            if (pin.views >= 2000) {
                adSpace.classList.remove('hidden');
            } else {
                adSpace.classList.add('hidden');
            }

            // Load comments
            loadComments(pinId);

            document.getElementById('pinModal').classList.remove('hidden');
        }

        function closePinModal() {
            document.getElementById('pinModal').classList.add('hidden');
            currentPinId = null;
        }

        function toggleSavePin(pinId) {
            if (!currentUser) {
                showError('Please sign in to save pins');
                return;
            }

            const isSaved = savedPins.includes(pinId);
            
            if (isSaved) {
                database.ref(`savedPins/${currentUser.uid}/${pinId}`).remove().catch(error => {
                    console.error('Error removing saved pin:', error);
                    showError('Failed to remove pin. Please try again.');
                });
            } else {
                database.ref(`savedPins/${currentUser.uid}/${pinId}`).set(true).catch(error => {
                    console.error('Error saving pin:', error);
                    showError('Failed to save pin. Please try again.');
                });
            }
        }

        function savePin() {
            if (currentPinId) {
                toggleSavePin(currentPinId);
            }
        }

        function downloadImage() {
            const pin = allPins.find(p => p.id === currentPinId);
            if (!pin) return;

            const link = document.createElement('a');
            link.href = pin.imageData;
            link.download = `pixplay-image-${currentPinId}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function loadComments(pinId) {
            const commentsList = document.getElementById('commentsList');
            commentsList.innerHTML = '';

            database.ref(`pins/${pinId}/comments`).on('value', (snapshot) => {
                commentsList.innerHTML = '';
                snapshot.forEach((child) => {
                    const comment = child.val();
                    const commentDiv = document.createElement('div');
                    commentDiv.className = 'flex space-x-3';
                    commentDiv.innerHTML = `
                        <img class="w-8 h-8 rounded-full" src="${comment.userPhotoURL || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiNGM0Y0RjYiLz4KPHN2ZyB4PSI2IiB5PSI2IiB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgZmlsbD0ibm9uZSI+CjxwYXRoIGQ9Ik0xNiAxN3YtMmEzIDMgMCAwIDAtMy0zSDd2LTJhMyAzIDAgMCAwLTMtM0g0djJhMyAzIDAgMCAwIDMgM2g2djJhMyAzIDAgMCAwIDMgM2gyeiIgZmlsbD0iIzlDQTNBRiIvPgo8Y2lyY2xlIGN4PSIxMCIgY3k9IjYiIHI9IjMiIGZpbGw9IiM5Q0EzQUYiLz4KPC9zdmc+Cjwvc3ZnPgo='}" alt="User">
                        <div class="flex-1">
                            <div class="font-medium text-sm">${comment.userDisplayName}</div>
                            <div class="text-gray-700">${comment.text}</div>
                            <div class="text-xs text-gray-500 mt-1">${new Date(comment.timestamp).toLocaleDateString()}</div>
                        </div>
                    `;
                    commentsList.appendChild(commentDiv);
                });
            });
        }

        function addComment() {
            if (!currentUser || !currentPinId) return;

            const commentInput = document.getElementById('commentInput');
            const commentText = commentInput.value.trim();
            
            if (!commentText) return;

            const newComment = {
                text: commentText,
                userId: currentUser.uid,
                userDisplayName: currentUser.displayName,
                userPhotoURL: currentUser.photoURL,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            database.ref(`pins/${currentPinId}/comments`).push(newComment).then(() => {
                commentInput.value = '';
            });
        }

        function openSettings() {
            if (!currentUser) return;
            
            document.getElementById('settingsAvatar').src = currentUser.photoURL || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iNDAiIGZpbGw9IiNGM0Y0RjYiLz4KPHN2ZyB4PSIyMCIgeT0iMjAiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDQwIDQwIiBmaWxsPSJub25lIj4KPHBhdGggZD0iTTMyIDM0di00YTYgNiAwIDAgMC02LTZIMTR2LTRhNiA2IDAgMCAwLTYtNkg4djRhNiA2IDAgMCAwIDYgNmgxMnY0YTYgNiAwIDAgMCA2IDZoNHoiIGZpbGw9IiM5Q0EzQUYiLz4KPGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iNiIgZmlsbD0iIzlDQTNBRiIvPgo8L3N2Zz4KPC9zdmc+Cg==';
            document.getElementById('displayName').value = currentUser.displayName || '';
            
            database.ref(`users/${currentUser.uid}`).once('value', (snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    document.getElementById('userBio').value = userData.bio || '';
                }
            });
            
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function changeProfilePicture() {
            document.getElementById('profilePictureInput').click();
        }

        function saveProfile() {
            if (!currentUser) return;

            const displayName = document.getElementById('displayName').value;
            const bio = document.getElementById('userBio').value;
            const photoURL = document.getElementById('settingsAvatar').src;

            const updates = {
                displayName: displayName,
                bio: bio,
                photoURL: photoURL
            };

            database.ref(`users/${currentUser.uid}`).update(updates).then(() => {
                // Update user avatar in header
                document.getElementById('userAvatar').src = photoURL;
                closeSettings();
                alert('Profile updated successfully!');
            }).catch(error => {
                console.error('Profile update error:', error);
                alert('Failed to update profile. Please try again.');
            });
        }

        // Mobile menu functions
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            mobileMenu.classList.toggle('hidden');
        }

        function closeMobileMenu() {
            document.getElementById('mobileMenu').classList.add('hidden');
        }

        function updateMobileUserSection() {
            const mobileUserSection = document.getElementById('mobileUserSection');
            if (currentUser) {
                mobileUserSection.innerHTML = `
                    <button onclick="openSettings(); closeMobileMenu()" class="w-full text-left px-3 py-2 text-gray-600 hover:text-red-600 hover:bg-gray-50 rounded-lg flex items-center space-x-2">
                        <img src="${currentUser.photoURL || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTIiIGZpbGw9IiNGM0Y0RjYiLz4KPHN2ZyB4PSI0IiB5PSI0IiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSI+CjxwYXRoIGQ9Ik0xMyAxNHYtMmEzIDMgMCAwIDAtMy0zSDZ2LTJhMyAzIDAgMCAwLTMtM0gzdjJhMyAzIDAgMCAwIDMgM2g0djJhMyAzIDAgMCAwIDMgM2gyeiIgZmlsbD0iIzlDQTNBRiIvPgo8Y2lyY2xlIGN4PSI4IiBjeT0iNSIgcj0iMyIgZmlsbD0iIzlDQTNBRiIvPgo8L3N2Zz4KPC9zdmc+Cg=='}" class="w-6 h-6 rounded-full">
                        <span>Settings</span>
                    </button>
                    <button onclick="signOut(); closeMobileMenu()" class="w-full text-left px-3 py-2 text-gray-600 hover:text-red-600 hover:bg-gray-50 rounded-lg">
                        🚪 Sign Out
                    </button>
                `;
            } else {
                mobileUserSection.innerHTML = `
                    <button onclick="signInWithGoogle(); closeMobileMenu()" class="w-full text-left px-3 py-2 text-blue-600 hover:text-blue-700 hover:bg-blue-50 rounded-lg">
                        🔑 Sign in with Google
                    </button>
                `;
            }
        }

        // Initialize the app
        init();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'979553fd034159b1',t:'MTc1NjkwMzM1Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
