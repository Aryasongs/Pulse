<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PixPlay - Discover & Share Images</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <style>
        /* Pinterest-style responsive grid */
        .pinterest-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            grid-gap: 16px;
            padding: 16px;
        }
        
        @media (max-width: 768px) {
            .pinterest-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                grid-gap: 8px;
                padding: 8px;
            }
        }
        
        @media (max-width: 480px) {
            .pinterest-grid {
                grid-template-columns: repeat(2, 1fr);
                grid-gap: 6px;
                padding: 6px;
            }
        }
        
        .masonry {
            columns: 5;
            column-gap: 1rem;
        }
        .masonry-item {
            break-inside: avoid;
            margin-bottom: 1rem;
            display: inline-block;
            width: 100%;
        }
        @media (max-width: 1280px) { .masonry { columns: 4; } }
        @media (max-width: 1024px) { .masonry { columns: 3; } }
        @media (max-width: 768px) { .masonry { columns: 2; } }
        @media (max-width: 640px) { .masonry { columns: 1; } }
        
        .pin-card {
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s ease;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
        }
        .pin-card:hover {
            -webkit-transform: translateY(-2px);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        .pin-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: -webkit-linear-gradient(top, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.3) 100%);
            background: linear-gradient(180deg, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.3) 100%);
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .pin-card:hover .pin-overlay {
            opacity: 1;
        }
        .pin-actions {
            position: absolute;
            top: 12px;
            right: 12px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .pin-card:hover .pin-actions {
            opacity: 1;
        }
        .upload-area {
            border: 2px dashed #e5e7eb;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            border-color: #dc2626;
            background-color: #fef2f2;
        }
        .upload-area.dragover {
            border-color: #dc2626;
            background-color: #fef2f2;
        }
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
        }
        .search-suggestion {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
        }
        .search-suggestion:hover {
            background-color: #f9fafb;
        }
        .search-suggestion:last-child {
            border-bottom: none;
        }
        .modal-backdrop {
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }
        .safety-modal {
            animation: fadeInScale 0.3s ease-out;
        }
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .policy-content {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .policy-section {
            margin-bottom: 2rem;
        }
        
        .policy-section h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #1f2937;
        }
        
        .policy-section h4 {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 0.75rem;
            color: #374151;
        }
        
        .policy-section p {
            margin-bottom: 1rem;
            line-height: 1.6;
            color: #4b5563;
        }
        
        .policy-section ul {
            margin-bottom: 1rem;
            padding-left: 1.5rem;
        }
        
        .policy-section li {
            margin-bottom: 0.5rem;
            color: #4b5563;
        }
    </style>
</head>
<body class="bg-white">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50 border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <!-- Mobile Menu Button -->
                    <button onclick="toggleMobileMenu()" class="md:hidden p-2 text-gray-600 hover:text-red-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                    <h1 class="text-xl md:text-2xl font-bold text-red-600">PixPlay</h1>
                    <nav class="hidden md:flex space-x-6">
                        <button onclick="showHome()" class="text-gray-900 hover:text-red-600 font-medium">Home</button>
                        <button onclick="showSaved()" class="text-gray-600 hover:text-red-600">Saved Pix</button>
                        <button onclick="showMyPix()" class="text-gray-600 hover:text-red-600">My Pix</button>
                    </nav>
                </div>
                
                <div class="flex-1 max-w-2xl mx-2 md:mx-8">
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="Search for ideas" 
                               class="w-full px-3 md:px-4 py-2 md:py-3 bg-gray-100 rounded-full focus:outline-none focus:ring-2 focus:ring-red-500 text-sm md:text-base"
                               oninput="handleSearch()" onkeydown="handleSearchKeydown(event)">
                        <button onclick="performSearch()" class="absolute right-2 md:right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-red-600">
                            <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </button>
                        <div id="searchSuggestions" class="search-suggestions hidden"></div>
                    </div>
                </div>

                <div class="flex items-center space-x-2 md:space-x-4">
                    <button onclick="openUploadModal()" class="bg-red-600 text-white px-3 md:px-4 py-2 rounded-full hover:bg-red-700 transition-colors text-sm md:text-base">
                        <span class="hidden sm:inline">Create</span>
                        <svg class="w-4 h-4 sm:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                    </button>
                    <div id="userSection" class="hidden flex items-center space-x-2 md:space-x-3">
                        <button onclick="openSettings()" class="p-2 text-gray-600 hover:text-red-600 rounded-full hover:bg-gray-100">
                            <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </button>
                        <img id="userAvatar" class="w-7 h-7 md:w-8 md:h-8 rounded-full cursor-pointer" onclick="openSettings()">
                    </div>
                    <div id="loginSection">
                        <button onclick="signInWithGoogle()" class="bg-blue-600 text-white px-3 md:px-4 py-2 rounded-full hover:bg-blue-700 transition-colors text-sm md:text-base">
                            <span class="hidden sm:inline">Sign in with Google</span>
                            <span class="sm:hidden">Sign in</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Mobile Navigation Menu -->
        <div id="mobileMenu" class="md:hidden bg-white border-t hidden">
            <div class="px-4 py-3 space-y-2">
                <button onclick="showHome(); closeMobileMenu()" class="w-full text-left px-3 py-2 text-gray-900 hover:text-red-600 hover:bg-gray-50 rounded-lg font-medium">
                    <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                    </svg>
                    Home
                </button>
                <button onclick="showSaved(); closeMobileMenu()" class="w-full text-left px-3 py-2 text-gray-600 hover:text-red-600 hover:bg-gray-50 rounded-lg">
                    <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"/>
                    </svg>
                    Saved Pix
                </button>
                <button onclick="showMyPix(); closeMobileMenu()" class="w-full text-left px-3 py-2 text-gray-600 hover:text-red-600 hover:bg-gray-50 rounded-lg">
                    <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                    </svg>
                    My Pix
                </button>
                <div class="border-t pt-2 mt-2" id="mobileUserSection">
                    <!-- User options will be added here -->
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-4 md:py-8">
        <!-- Home View -->
        <div id="homeView">
            <div class="pinterest-grid" id="imageGallery">
                <!-- Images will be loaded here -->
            </div>
        </div>

        <!-- Saved View -->
        <div id="savedView" class="hidden">
            <h2 class="text-xl md:text-2xl font-bold mb-4 md:mb-6 px-4">Saved Pix</h2>
            <div class="pinterest-grid" id="savedGallery">
                <!-- Saved images will be loaded here -->
            </div>
        </div>

        <!-- My Pix View -->
        <div id="myPixView" class="hidden">
            <div class="flex justify-between items-center mb-4 md:mb-6 px-4">
                <h2 class="text-xl md:text-2xl font-bold">My Pix</h2>
                <div id="myPixStats" class="text-sm text-gray-600">
                    <!-- Stats will be shown here -->
                </div>
            </div>
            <div class="pinterest-grid" id="myPixGallery">
                <!-- User's images will be loaded here -->
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-50 border-t mt-16">
        <div class="max-w-7xl mx-auto px-4 py-8">
            <div class="text-center">
                <div class="flex justify-center items-center space-x-4 mb-4">
                    <div class="text-2xl font-bold text-red-600">PixPlay</div>
                    <div class="text-gray-400">•</div>
                    <div class="text-sm text-gray-600">Discover & Share Amazing Images</div>
                </div>
                <div class="text-sm text-gray-500">
                    <p>&copy; 2024 PixPlay. All rights reserved. Powered by Oriontec.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Upload Modal -->
    <div id="uploadModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto mx-4">
            <div class="p-4 md:p-6">
                <div class="flex justify-between items-center mb-4 md:mb-6">
                    <h3 class="text-lg md:text-xl font-semibold">Create Pix</h3>
                    <button onclick="closeUploadModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
                    <div>
                        <div class="upload-area p-6 md:p-8 text-center rounded-2xl mb-4" id="uploadArea">
                            <svg class="w-10 h-10 md:w-12 md:h-12 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            <p class="text-gray-600 mb-2 text-sm md:text-base">Choose a file or drag and drop it here</p>
                            <p class="text-xs md:text-sm text-gray-400">We recommend using high quality .jpg files</p>
                            <input type="file" id="imageInput" accept="image/*" class="hidden">
                        </div>
                        
                        <!-- Upload Status -->
                        <div id="uploadStatus" class="hidden">
                            <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-4">
                                <div class="flex items-center">
                                    <svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                    </svg>
                                    <span class="text-sm text-green-700">Image uploaded successfully!</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                            <input type="text" id="pixTitle" placeholder="Add a title" maxlength="100" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                            <div class="text-xs text-gray-500 mt-1"><span id="titleCount">0</span>/100</div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tell everyone what your Pix is about</label>
                            <textarea id="pixDescription" rows="3" placeholder="Add a description, mention, or hashtags to your Pix." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Link</label>
                            <input type="url" id="pixLink" placeholder="Add a destination link" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pick a board</label>
                            <select id="pixBoard" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                                <option value="">Choose a board</option>
                                <option value="general">General</option>
                                <option value="photography">Photography</option>
                                <option value="art">Art & Design</option>
                                <option value="food">Food & Recipes</option>
                                <option value="travel">Travel</option>
                                <option value="fashion">Fashion</option>
                                <option value="home">Home & Decor</option>
                                <option value="diy">DIY & Crafts</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tag related topics</label>
                            <input type="text" id="pixTags" placeholder="Add tags separated by commas" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                            <div class="text-xs text-gray-500 mt-1">Help people discover your Pix</div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tag products</label>
                            <input type="text" id="pixProducts" placeholder="Tag products in your Pix" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Schedule date</label>
                                <input type="datetime-local" id="pixSchedule" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                            </div>
                            <div class="flex items-end">
                                <button onclick="setPublishNow()" class="w-full bg-gray-100 text-gray-700 py-3 rounded-lg hover:bg-gray-200 transition-colors font-medium">
                                    Publish now
                                </button>
                            </div>
                        </div>
                        
                        <!-- Advanced Settings -->
                        <div class="border-t pt-4">
                            <button onclick="toggleAdvancedSettings()" class="flex items-center justify-between w-full text-left">
                                <span class="text-sm font-medium text-gray-700">Advanced settings</span>
                                <svg id="advancedArrow" class="w-4 h-4 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            
                            <div id="advancedSettings" class="hidden mt-4 space-y-4">
                                <div>
                                    <h4 class="text-sm font-medium text-gray-700 mb-3">Engagement settings</h4>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="allowComments" checked class="rounded border-gray-300 text-red-600 focus:ring-red-500">
                                        <span class="ml-2 text-sm text-gray-700">Allow comments</span>
                                    </label>
                                </div>
                                
                                <div>
                                    <h4 class="text-sm font-medium text-gray-700 mb-3">Branded content</h4>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="paidPartnership" class="rounded border-gray-300 text-red-600 focus:ring-red-500">
                                        <span class="ml-2 text-sm text-gray-700">Add paid partnership label</span>
                                    </label>
                                </div>
                                
                                <div>
                                    <h4 class="text-sm font-medium text-gray-700 mb-3">Shopping recommendations</h4>
                                    <label class="flex items-center mb-2">
                                        <input type="checkbox" id="showSimilarProducts" class="rounded border-gray-300 text-red-600 focus:ring-red-500">
                                        <span class="ml-2 text-sm text-gray-700">Show similar products</span>
                                    </label>
                                    <p class="text-xs text-gray-500 ml-6">People can shop products similar to what's shown in this Pix using visual search.</p>
                                    <p class="text-xs text-gray-400 ml-6 mt-1">Shopping recommendations aren't available for Pixs with tagged products or paid partnership label.</p>
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="uploadImage()" class="w-full bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 transition-colors font-medium">
                            Save Pix
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pin Detail Modal -->
    <div id="pinModal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="grid grid-cols-1 lg:grid-cols-2">
                <div class="relative">
                    <img id="modalImage" class="w-full h-full object-cover" alt="">
                    <button onclick="closePinModal()" class="absolute top-4 right-4 bg-white rounded-full p-2 shadow-lg hover:bg-gray-100">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex space-x-3">
                            <button onclick="savePix()" class="bg-red-600 text-white px-6 py-2 rounded-full hover:bg-red-700 transition-colors font-medium">
                                Save
                            </button>
                            <button onclick="downloadImage()" class="border border-gray-300 text-gray-700 px-6 py-2 rounded-full hover:bg-gray-50 transition-colors font-medium">
                                Download
                            </button>
                        </div>
                        <button class="p-2 text-gray-600 hover:text-red-600 rounded-full hover:bg-gray-100">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="mb-6">
                        <div class="flex items-center space-x-3 mb-4">
                            <img class="w-10 h-10 rounded-full" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNGM0Y0RjYiLz4KPHN2ZyB4PSI4IiB5PSI4IiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSI+CjxwYXRoIGQ9Ik0yMCAyMXYtMmE0IDQgMCAwIDAtNC00SDh2LTJhNCA0IDAgMCAwLTQtNEg0djJhNCA0IDAgMCAwIDQgNGg4djJhNCA0IDAgMCAwIDQgNGgyeiIgZmlsbD0iIzlDQTNBRiIvPgo8Y2lyY2xlIGN4PSIxMiIgY3k9IjciIHI9IjQiIGZpbGw9IiM5Q0EzQUYiLz4KPC9zdmc+Cjwvc3ZnPgo=" alt="User">
                            <div>
                                <div class="font-medium">Anonymous User</div>
                                <div class="text-sm text-gray-500">0 followers</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ad Space for Monetized Content -->
                    <div id="adSpace" class="hidden bg-gray-50 p-4 rounded-lg mb-6">
                        <div class="text-xs text-gray-500 mb-2 text-center">Advertisement</div>
                        <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-6 rounded text-center">
                            <div class="font-bold mb-2">Your Ad Here</div>
                            <div class="text-sm opacity-90">Monetized content ad space</div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <h3 class="font-semibold text-lg mb-2">Comments</h3>
                            <div class="space-y-3" id="commentsList">
                                <!-- Comments will be loaded here -->
                            </div>
                        </div>
                        
                        <div class="flex space-x-3">
                            <img class="w-8 h-8 rounded-full" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiNGM0Y0RjYiLz4KPHN2ZyB4PSI2IiB5PSI2IiB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgZmlsbD0ibm9uZSI+CjxwYXRoIGQ9Ik0xNiAxN3YtMmEzIDMgMCAwIDAtMy0zSDd2LTJhMyAzIDAgMCAwLTMtM0g0djJhMyAzIDAgMCAwIDMgM2g2djJhMyAzIDAgMCAwIDMgM2gyeiIgZmlsbD0iIzlDQTNBRiIvPgo8Y2lyY2xlIGN4PSIxMCIgY3k9IjYiIHI9IjMiIGZpbGw9IiM5Q0EzQUYiLz4KPC9zdmc+Cjwvc3ZnPgo=" alt="User">
                            <input type="text" id="commentInput" placeholder="Add a comment" class="flex-1 p-2 border-b border-gray-200 focus:outline-none focus:border-red-500">
                            <button onclick="addComment()" class="text-red-600 hover:text-red-700 font-medium">Post</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Policy Modal -->
    <div id="policyModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold" id="policyTitle">Policy</h3>
                    <button onclick="closePolicyModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="policy-content p-6" id="policyContent">
                <!-- Policy content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Safety Warning Modal -->
    <div id="safetyModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full safety-modal">
            <div class="p-6 text-center">
                <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-semibold mb-4" id="safetyTitle">Content Warning</h3>
                <p class="text-gray-600 mb-6" id="safetyMessage"></p>
                <button onclick="closeSafetyModal()" class="w-full bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 transition-colors font-medium">
                    I Understand
                </button>
            </div>
        </div>
    </div>

    <!-- Support Modal -->
    <div id="supportModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full safety-modal">
            <div class="p-6 text-center">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-semibold mb-4">You Matter</h3>
                <p class="text-gray-600 mb-6">If you're going through a tough time, please know that you're not alone. There are people who care and want to help.</p>
                <div class="space-y-3 mb-6">
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <div class="font-medium">Crisis Text Line</div>
                        <div class="text-sm text-gray-600">Text HOME to 741741</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <div class="font-medium">National Suicide Prevention Lifeline</div>
                        <div class="text-sm text-gray-600">988 or 1-800-273-8255</div>
                    </div>
                </div>
                <button onclick="closeSupportModal()" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors font-medium">
                    Thank You
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold">Settings</h3>
                    <button onclick="closeSettings()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="space-y-6">
                    <div class="text-center">
                        <div class="relative inline-block">
                            <img id="settingsAvatar" class="w-20 h-20 rounded-full mx-auto" src="">
                            <button onclick="changeProfilePicture()" class="absolute bottom-0 right-0 bg-red-600 text-white rounded-full p-2 hover:bg-red-700">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                                </svg>
                            </button>
                        </div>
                        <input type="file" id="profilePictureInput" accept="image/*" class="hidden">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Display Name</label>
                        <input type="text" id="displayName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Bio</label>
                        <textarea id="userBio" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Tell people about yourself"></textarea>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="saveProfile()" class="flex-1 bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 transition-colors font-medium">
                            Save Changes
                        </button>
                        <button onclick="signOut()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium">
                            Sign Out
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDjfNlHwhT4xYb7vVym_SAqMlSuY_TMz0o",
            authDomain: "orioplay.firebaseapp.com",
            databaseURL: "https://orioplay-default-rtdb.firebaseio.com",
            projectId: "orioplay",
            storageBucket: "orioplay.firebasestorage.app",
            messagingSenderId: "300811706751",
            appId: "1:300811706751:web:bdce98b1ba7e11d34d7a4a"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Global variables
        let currentUser = null;
        let currentView = 'home';
        let currentPinId = null;
        let allPins = [];
        let savedPins = [];
        let userPix = [];
        let searchTimeout = null;
        let currentSearchTerm = '';
        let filteredPins = [];
        let adsData = [];
        let hiddenAds = [];
        let userInterests = {};
        let userBehavior = {};

        // Personalization Algorithm
        class PersonalizationEngine {
            constructor() {
                this.userProfile = {
                    interests: {},
                    categories: {},
                    searchHistory: [],
                    viewHistory: [],
                    saveHistory: [],
                    timeSpent: {},
                    preferredColors: {},
                    interactionPatterns: {}
                };
            }

            // Track user interactions
            trackInteraction(type, data) {
                const timestamp = Date.now();
                
                switch(type) {
                    case 'view':
                        this.trackView(data, timestamp);
                        break;
                    case 'save':
                        this.trackSave(data, timestamp);
                        break;
                    case 'search':
                        this.trackSearch(data, timestamp);
                        break;
                    case 'timeSpent':
                        this.trackTimeSpent(data, timestamp);
                        break;
                }
                
                this.updateUserProfile();
            }

            trackView(pinData, timestamp) {
                this.userProfile.viewHistory.push({
                    pinId: pinData.id,
                    category: pinData.category || 'general',
                    tags: pinData.tags || '',
                    timestamp: timestamp
                });

                // Update category interests
                const category = pinData.category || 'general';
                this.userProfile.categories[category] = (this.userProfile.categories[category] || 0) + 1;

                // Extract and weight keywords
                const keywords = this.extractKeywords(pinData.title + ' ' + pinData.description + ' ' + pinData.tags);
                keywords.forEach(keyword => {
                    this.userProfile.interests[keyword] = (this.userProfile.interests[keyword] || 0) + 0.5;
                });
            }

            trackSave(pinData, timestamp) {
                this.userProfile.saveHistory.push({
                    pinId: pinData.id,
                    category: pinData.category || 'general',
                    tags: pinData.tags || '',
                    timestamp: timestamp
                });

                // Higher weight for saved content
                const category = pinData.category || 'general';
                this.userProfile.categories[category] = (this.userProfile.categories[category] || 0) + 3;

                const keywords = this.extractKeywords(pinData.title + ' ' + pinData.description + ' ' + pinData.tags);
                keywords.forEach(keyword => {
                    this.userProfile.interests[keyword] = (this.userProfile.interests[keyword] || 0) + 2;
                });
            }

            trackSearch(searchTerm, timestamp) {
                this.userProfile.searchHistory.push({
                    term: searchTerm,
                    timestamp: timestamp
                });

                const keywords = this.extractKeywords(searchTerm);
                keywords.forEach(keyword => {
                    this.userProfile.interests[keyword] = (this.userProfile.interests[keyword] || 0) + 1.5;
                });
            }

            trackTimeSpent(pinData, timeSpent) {
                this.userProfile.timeSpent[pinData.id] = timeSpent;
                
                // If user spent significant time, boost interest
                if (timeSpent > 10000) { // 10 seconds
                    const keywords = this.extractKeywords(pinData.title + ' ' + pinData.description + ' ' + pinData.tags);
                    keywords.forEach(keyword => {
                        this.userProfile.interests[keyword] = (this.userProfile.interests[keyword] || 0) + 1;
                    });
                }
            }

            extractKeywords(text) {
                if (!text) return [];
                
                const stopWords = ['the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'is', 'are', 'was', 'were', 'be', 'been', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could', 'should'];
                
                return text.toLowerCase()
                    .replace(/[^\w\s]/g, '')
                    .split(/\s+/)
                    .filter(word => word.length > 2 && !stopWords.includes(word))
                    .slice(0, 10); // Limit to top 10 keywords
            }

            // Calculate relevance score for a pin
            calculateRelevanceScore(pin) {
                let score = 0;
                
                // Category preference
                const category = pin.category || 'general';
                const categoryWeight = this.userProfile.categories[category] || 0;
                score += categoryWeight * 0.3;

                // Keyword matching
                const keywords = this.extractKeywords(pin.title + ' ' + pin.description + ' ' + pin.tags);
                keywords.forEach(keyword => {
                    const interestWeight = this.userProfile.interests[keyword] || 0;
                    score += interestWeight * 0.4;
                });

                // Recency boost for newer content
                const daysSinceCreated = (Date.now() - (pin.timestamp || 0)) / (1000 * 60 * 60 * 24);
                if (daysSinceCreated < 7) {
                    score += (7 - daysSinceCreated) * 0.1;
                }

                // Popularity boost
                const views = pin.views || 0;
                score += Math.log(views + 1) * 0.1;

                // Diversity factor (reduce score for similar content recently shown)
                const recentViews = this.userProfile.viewHistory.slice(-20);
                const similarCount = recentViews.filter(view => {
                    const viewKeywords = this.extractKeywords(view.tags);
                    return keywords.some(k => viewKeywords.includes(k));
                }).length;
                
                score -= similarCount * 0.2;

                return Math.max(0, score);
            }

            // Personalize feed with advanced algorithm
            personalizeFeed(pins) {
                if (!currentUser || pins.length === 0) {
                    return this.shuffleArray([...pins]);
                }

                // Calculate scores for all pins
                const scoredPins = pins.map(pin => ({
                    ...pin,
                    relevanceScore: this.calculateRelevanceScore(pin)
                }));

                // Group pins by categories for better distribution
                const categoryGroups = {};
                scoredPins.forEach(pin => {
                    const category = pin.category || pin.board || 'general';
                    if (!categoryGroups[category]) {
                        categoryGroups[category] = [];
                    }
                    categoryGroups[category].push(pin);
                });

                // Sort each category by relevance
                Object.keys(categoryGroups).forEach(category => {
                    categoryGroups[category].sort((a, b) => b.relevanceScore - a.relevanceScore);
                });

                // Create diverse feed by rotating through categories
                const finalFeed = [];
                const categoryKeys = Object.keys(categoryGroups);
                const maxPerCategory = Math.ceil(pins.length / categoryKeys.length);
                
                // Interleave content from different categories
                for (let round = 0; round < maxPerCategory; round++) {
                    for (let categoryIndex = 0; categoryIndex < categoryKeys.length; categoryIndex++) {
                        const category = categoryKeys[categoryIndex];
                        const categoryPins = categoryGroups[category];
                        
                        if (categoryPins && categoryPins.length > round) {
                            // Add some randomness within top pins of each category
                            const availablePins = categoryPins.slice(round, Math.min(round + 3, categoryPins.length));
                            const selectedPin = availablePins[Math.floor(Math.random() * availablePins.length)];
                            
                            if (selectedPin && !finalFeed.find(p => p.id === selectedPin.id)) {
                                finalFeed.push(selectedPin);
                            }
                        }
                    }
                }

                // Fill remaining slots with highest scoring pins not yet included
                const remainingPins = scoredPins
                    .filter(pin => !finalFeed.find(p => p.id === pin.id))
                    .sort((a, b) => b.relevanceScore - a.relevanceScore);
                
                finalFeed.push(...remainingPins);

                return finalFeed.slice(0, pins.length);
            }

            shuffleArray(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }

            updateUserProfile() {
                if (currentUser) {
                    // Save user profile to Firebase
                    database.ref(`userProfiles/${currentUser.uid}`).set(this.userProfile);
                }
            }

            loadUserProfile() {
                if (currentUser) {
                    database.ref(`userProfiles/${currentUser.uid}`).once('value', (snapshot) => {
                        const profile = snapshot.val();
                        if (profile) {
                            this.userProfile = { ...this.userProfile, ...profile };
                        }
                    });
                }
            }
        }

        // Initialize personalization engine
        const personalizationEngine = new PersonalizationEngine();

        // Policy content
        const policyContent = {
            privacy: {
                title: "Privacy Policy",
                content: `
                    <div class="policy-section">
                        <h3>1. Information We Collect</h3>
                        <p>At PixPlay, we are committed to protecting your privacy and ensuring transparency about how we collect, use, and protect your personal information. This Privacy Policy explains our practices regarding the collection, use, and disclosure of information when you use our service.</p>
                        
                        <h4>1.1 Information You Provide</h4>
                        <p>When you create an account with PixPlay, we collect information you voluntarily provide, including:</p>
                        <ul>
                            <li>Your name, email address, and profile information</li>
                            <li>Images, descriptions, and other content you upload</li>
                            <li>Comments, messages, and other communications</li>
                            <li>Preferences and settings you configure</li>
                        </ul>

                        <h4>1.2 Information We Collect Automatically</h4>
                        <p>When you use PixPlay, we automatically collect certain information about your device and usage patterns:</p>
                        <ul>
                            <li>Device information (type, operating system, browser)</li>
                            <li>IP address and location data</li>
                            <li>Usage patterns and interaction data</li>
                            <li>Cookies and similar tracking technologies</li>
                        </ul>

                        <h3>2. How We Use Your Information</h3>
                        <p>We use the information we collect for various purposes, including:</p>
                        <ul>
                            <li>Providing and maintaining our service</li>
                            <li>Personalizing your experience and content recommendations</li>
                            <li>Communicating with you about updates and features</li>
                            <li>Analyzing usage patterns to improve our service</li>
                            <li>Detecting and preventing fraud and abuse</li>
                            <li>Complying with legal obligations</li>
                        </ul>

                        <h3>3. Information Sharing and Disclosure</h3>
                        <p>We do not sell, trade, or otherwise transfer your personal information to third parties without your consent, except in the following circumstances:</p>
                        <ul>
                            <li>With your explicit consent</li>
                            <li>To comply with legal obligations</li>
                            <li>To protect our rights and safety</li>
                            <li>In connection with a business transfer</li>
                            <li>With service providers who assist us in operating our platform</li>
                        </ul>

                        <h3>4. Data Security</h3>
                        <p>We implement appropriate technical and organizational measures to protect your personal information against unauthorized access, alteration, disclosure, or destruction. These measures include:</p>
                        <ul>
                            <li>Encryption of data in transit and at rest</li>
                            <li>Regular security assessments and updates</li>
                            <li>Access controls and authentication measures</li>
                            <li>Employee training on data protection</li>
                        </ul>

                        <h3>5. Your Rights and Choices</h3>
                        <p>You have several rights regarding your personal information:</p>
                        <ul>
                            <li>Access: You can request access to your personal information</li>
                            <li>Correction: You can update or correct your information</li>
                            <li>Deletion: You can request deletion of your account and data</li>
                            <li>Portability: You can request a copy of your data</li>
                            <li>Opt-out: You can opt out of certain communications</li>
                        </ul>

                        <h3>6. Cookies and Tracking</h3>
                        <p>We use cookies and similar technologies to enhance your experience, analyze usage, and provide personalized content. You can control cookie settings through your browser preferences.</p>

                        <h3>7. Children's Privacy</h3>
                        <p>PixPlay is not intended for children under 13 years of age. We do not knowingly collect personal information from children under 13. If we become aware that we have collected such information, we will take steps to delete it.</p>

                        <h3>8. International Data Transfers</h3>
                        <p>Your information may be transferred to and processed in countries other than your own. We ensure appropriate safeguards are in place to protect your information during such transfers.</p>

                        <h3>9. Changes to This Policy</h3>
                        <p>We may update this Privacy Policy from time to time. We will notify you of any material changes by posting the new policy on this page and updating the effective date.</p>

                        <h3>10. Contact Us</h3>
                        <p>If you have any questions about this Privacy Policy, please contact us at privacy@pixplay.com or through our support channels.</p>
                        
                        <p><strong>Last updated:</strong> December 2024</p>
                    </div>
                `
            },
            terms: {
                title: "Terms of Service",
                content: `
                    <div class="policy-section">
                        <h3>1. Acceptance of Terms</h3>
                        <p>Welcome to PixPlay! These Terms of Service ("Terms") govern your use of the PixPlay platform, website, and services. By accessing or using PixPlay, you agree to be bound by these Terms and our Privacy Policy.</p>

                        <h3>2. Description of Service</h3>
                        <p>PixPlay is a visual discovery platform that allows users to discover, save, and share images and ideas. Our service includes:</p>
                        <ul>
                            <li>Image sharing and discovery features</li>
                            <li>Personalized content recommendations</li>
                            <li>Social interaction tools</li>
                            <li>Creator monetization programs</li>
                        </ul>

                        <h3>3. User Accounts</h3>
                        <p>To use certain features of PixPlay, you must create an account. You are responsible for:</p>
                        <ul>
                            <li>Providing accurate and complete information</li>
                            <li>Maintaining the security of your account</li>
                            <li>All activities that occur under your account</li>
                            <li>Notifying us of any unauthorized use</li>
                        </ul>

                        <h3>4. Content and Conduct</h3>
                        <h4>4.1 Your Content</h4>
                        <p>You retain ownership of content you upload to PixPlay. By uploading content, you grant us a license to use, display, and distribute your content on our platform.</p>

                        <h4>4.2 Prohibited Content</h4>
                        <p>You may not upload or share content that:</p>
                        <ul>
                            <li>Violates any laws or regulations</li>
                            <li>Infringes on intellectual property rights</li>
                            <li>Contains harmful, offensive, or inappropriate material</li>
                            <li>Promotes violence, hatred, or discrimination</li>
                            <li>Contains spam or misleading information</li>
                        </ul>

                        <h4>4.3 Community Guidelines</h4>
                        <p>Users must follow our community guidelines, which promote respectful and positive interactions. Violations may result in content removal or account suspension.</p>

                        <h3>5. Intellectual Property</h3>
                        <p>PixPlay respects intellectual property rights. We respond to valid copyright infringement notices and may terminate accounts of repeat infringers.</p>

                        <h3>6. Monetization and Creator Program</h3>
                        <p>Eligible creators may participate in our monetization programs. Participation is subject to additional terms and conditions, including:</p>
                        <ul>
                            <li>Content quality and engagement requirements</li>
                            <li>Compliance with advertising policies</li>
                            <li>Revenue sharing agreements</li>
                            <li>Tax reporting obligations</li>
                        </ul>

                        <h3>7. Privacy and Data Protection</h3>
                        <p>Your privacy is important to us. Our Privacy Policy explains how we collect, use, and protect your information. By using PixPlay, you consent to our data practices as described in the Privacy Policy.</p>

                        <h3>8. Disclaimers and Limitations</h3>
                        <p>PixPlay is provided "as is" without warranties of any kind. We do not guarantee:</p>
                        <ul>
                            <li>Uninterrupted or error-free service</li>
                            <li>Accuracy or reliability of content</li>
                            <li>Security of user data</li>
                            <li>Compatibility with all devices</li>
                        </ul>

                        <h3>9. Limitation of Liability</h3>
                        <p>To the maximum extent permitted by law, PixPlay shall not be liable for any indirect, incidental, special, or consequential damages arising from your use of the service.</p>

                        <h3>10. Termination</h3>
                        <p>We may terminate or suspend your account at any time for violations of these Terms or for any other reason. You may also terminate your account at any time.</p>

                        <h3>11. Changes to Terms</h3>
                        <p>We may modify these Terms at any time. We will notify users of material changes and continued use constitutes acceptance of the modified Terms.</p>

                        <h3>12. Governing Law</h3>
                        <p>These Terms are governed by the laws of the jurisdiction where PixPlay operates, without regard to conflict of law principles.</p>

                        <h3>13. Contact Information</h3>
                        <p>For questions about these Terms, contact us at legal@pixplay.com or through our support channels.</p>
                        
                        <p><strong>Last updated:</strong> December 2024</p>
                    </div>
                `
            },
            copyright: {
                title: "Copyright Policy",
                content: `
                    <div class="policy-section">
                        <h3>1. Respect for Intellectual Property</h3>
                        <p>PixPlay respects the intellectual property rights of others and expects our users to do the same. This Copyright Policy outlines our procedures for addressing claims of copyright infringement on our platform.</p>

                        <h3>2. Digital Millennium Copyright Act (DMCA)</h3>
                        <p>PixPlay complies with the Digital Millennium Copyright Act (DMCA) and other applicable copyright laws. We respond promptly to valid copyright infringement notices and take appropriate action against infringing content.</p>

                        <h3>3. Copyright Infringement Notification</h3>
                        <p>If you believe that your copyrighted work has been infringed on PixPlay, please provide our designated copyright agent with the following information:</p>
                        <ul>
                            <li>A physical or electronic signature of the copyright owner or authorized representative</li>
                            <li>Identification of the copyrighted work claimed to be infringed</li>
                            <li>Identification of the infringing material and its location on PixPlay</li>
                            <li>Your contact information (address, phone number, email)</li>
                            <li>A statement of good faith belief that the use is not authorized</li>
                            <li>A statement of accuracy and authority to act on behalf of the copyright owner</li>
                        </ul>

                        <h3>4. Counter-Notification Process</h3>
                        <p>If you believe your content was removed in error, you may submit a counter-notification containing:</p>
                        <ul>
                            <li>Your physical or electronic signature</li>
                            <li>Identification of the removed content and its former location</li>
                            <li>A statement under penalty of perjury that the removal was a mistake</li>
                            <li>Your contact information and consent to jurisdiction</li>
                        </ul>

                        <h3>5. Repeat Infringer Policy</h3>
                        <p>PixPlay maintains a policy of terminating accounts of users who are repeat copyright infringers. We track copyright violations and may suspend or terminate accounts that receive multiple valid infringement notices.</p>

                        <h3>6. Fair Use and Educational Content</h3>
                        <p>We recognize that some uses of copyrighted material may qualify as fair use under copyright law. However, fair use is determined on a case-by-case basis considering factors such as:</p>
                        <ul>
                            <li>Purpose and character of the use</li>
                            <li>Nature of the copyrighted work</li>
                            <li>Amount and substantiality of the portion used</li>
                            <li>Effect on the market for the original work</li>
                        </ul>

                        <h3>7. User Responsibilities</h3>
                        <p>Users are responsible for ensuring they have the right to upload and share content on PixPlay. This includes:</p>
                        <ul>
                            <li>Only uploading content you own or have permission to use</li>
                            <li>Respecting copyright notices and attribution requirements</li>
                            <li>Understanding fair use limitations</li>
                            <li>Removing infringing content when notified</li>
                        </ul>

                        <h3>8. Content Removal Process</h3>
                        <p>When we receive a valid copyright infringement notice, we will:</p>
                        <ul>
                            <li>Remove or disable access to the infringing content</li>
                            <li>Notify the user who uploaded the content</li>
                            <li>Document the infringement for repeat infringer tracking</li>
                            <li>Provide information about the counter-notification process</li>
                        </ul>

                        <h3>9. False Claims</h3>
                        <p>Submitting false or fraudulent copyright claims may result in legal liability. Users who repeatedly submit invalid claims may have their ability to submit future claims restricted.</p>

                        <h3>10. International Copyright</h3>
                        <p>PixPlay respects copyright laws in all jurisdictions where we operate. We work with international copyright organizations and respond to valid claims from copyright holders worldwide.</p>

                        <h3>11. Creative Commons and Open Source</h3>
                        <p>We support the use of Creative Commons licensed content and open source materials. Users should properly attribute such content according to the specific license requirements.</p>

                        <h3>12. Contact Information</h3>
                        <p>For copyright-related inquiries or to submit a DMCA notice, contact our designated copyright agent:</p>
                        <p>Email: copyright@pixplay.com<br>
                        Address: PixPlay Copyright Agent, [Company Address]</p>
                        
                        <p><strong>Last updated:</strong> December 2024</p>
                    </div>
                `
            },
            monetization: {
                title: "Monetization Policy",
                content: `
                    <div class="policy-section">
                        <h3>1. Creator Monetization Program</h3>
                        <p>PixPlay's Creator Monetization Program allows eligible content creators to earn revenue from their content through various monetization features. This policy outlines the requirements, guidelines, and terms for participation in our monetization programs.</p>

                        <h3>2. Eligibility Requirements</h3>
                        <p>To participate in monetization programs, creators must meet the following criteria:</p>
                        <ul>
                            <li>Minimum of 1,000 followers</li>
                            <li>At least 10,000 monthly views across all content</li>
                            <li>Account in good standing with no recent policy violations</li>
                            <li>Original, high-quality content that complies with our guidelines</li>
                            <li>Active engagement with the PixPlay community</li>
                            <li>Verification of identity and tax information</li>
                        </ul>

                        <h3>3. Monetization Features</h3>
                        <h4>3.1 Ad Revenue Sharing</h4>
                        <p>Eligible creators can earn revenue from advertisements displayed alongside their content. Revenue sharing rates vary based on:</p>
                        <ul>
                            <li>Content performance and engagement</li>
                            <li>Audience demographics and location</li>
                            <li>Advertiser demand and seasonal factors</li>
                            <li>Creator tier and partnership level</li>
                        </ul>

                        <h4>3.2 Sponsored Content</h4>
                        <p>Creators may partner with brands for sponsored content opportunities. All sponsored content must:</p>
                        <ul>
                            <li>Be clearly labeled as sponsored or promotional</li>
                            <li>Comply with advertising disclosure requirements</li>
                            <li>Align with PixPlay's content guidelines</li>
                            <li>Provide value to the creator's audience</li>
                        </ul>

                        <h4>3.3 Premium Content</h4>
                        <p>Creators can offer premium content or exclusive access to subscribers for a fee. Premium content features include:</p>
                        <ul>
                            <li>Exclusive image collections</li>
                            <li>Early access to new content</li>
                            <li>Behind-the-scenes content</li>
                            <li>Direct interaction opportunities</li>
                        </ul>

                        <h3>4. Content Quality Standards</h3>
                        <p>Monetized content must meet higher quality standards, including:</p>
                        <ul>
                            <li>High-resolution, professionally presented images</li>
                            <li>Original content or properly licensed material</li>
                            <li>Engaging descriptions and relevant tags</li>
                            <li>Consistent posting schedule and audience engagement</li>
                            <li>Compliance with copyright and intellectual property laws</li>
                        </ul>

                        <h3>5. Revenue Sharing and Payments</h3>
                        <p>PixPlay operates on a revenue-sharing model with the following terms:</p>
                        <ul>
                            <li>Creators receive 70% of net advertising revenue</li>
                            <li>Payments are processed monthly for earnings above $100</li>
                            <li>Multiple payment methods available (PayPal, bank transfer, etc.)</li>
                            <li>Detailed analytics and earnings reports provided</li>
                            <li>Tax documentation provided for reporting purposes</li>
                        </ul>

                        <h3>6. Prohibited Monetization Practices</h3>
                        <p>The following practices are prohibited and may result in removal from monetization programs:</p>
                        <ul>
                            <li>Artificial inflation of views, likes, or engagement</li>
                            <li>Misleading or deceptive advertising practices</li>
                            <li>Promotion of illegal or harmful products/services</li>
                            <li>Violation of platform community guidelines</li>
                            <li>Copyright infringement or unauthorized use of content</li>
                        </ul>

                        <h3>7. Brand Safety and Advertiser Guidelines</h3>
                        <p>To maintain advertiser confidence and brand safety, monetized content must:</p>
                        <ul>
                            <li>Be suitable for general audiences</li>
                            <li>Avoid controversial or sensitive topics</li>
                            <li>Maintain professional presentation standards</li>
                            <li>Comply with advertising industry standards</li>
                        </ul>

                        <h3>8. Performance Metrics and Analytics</h3>
                        <p>Creators have access to comprehensive analytics including:</p>
                        <ul>
                            <li>Revenue and earnings breakdowns</li>
                            <li>Audience demographics and engagement metrics</li>
                            <li>Content performance insights</li>
                            <li>Trend analysis and optimization recommendations</li>
                        </ul>

                        <h3>9. Creator Support and Resources</h3>
                        <p>PixPlay provides monetizing creators with:</p>
                        <ul>
                            <li>Dedicated creator support team</li>
                            <li>Educational resources and best practices</li>
                            <li>Networking opportunities with other creators</li>
                            <li>Early access to new monetization features</li>
                        </ul>

                        <h3>10. Policy Violations and Enforcement</h3>
                        <p>Violations of monetization policies may result in:</p>
                        <ul>
                            <li>Warning and opportunity to correct issues</li>
                            <li>Temporary suspension from monetization programs</li>
                            <li>Permanent removal from creator programs</li>
                            <li>Withholding of earned revenue in severe cases</li>
                        </ul>

                        <h3>11. Appeals Process</h3>
                        <p>Creators may appeal monetization decisions through our formal appeals process, which includes review by specialized teams and opportunity to provide additional context.</p>

                        <h3>12. Program Updates and Changes</h3>
                        <p>PixPlay may update monetization policies and features. Creators will be notified of significant changes with reasonable advance notice.</p>

                        <p><strong>Last updated:</strong> December 2024</p>
                    </div>
                `
            },
            ads: {
                title: "Advertising Policy",
                content: `
                    <div class="policy-section">
                        <h3>1. Advertising Standards</h3>
                        <p>PixPlay maintains high standards for advertising content to ensure a positive user experience while supporting creators and businesses. This Advertising Policy governs all advertisements displayed on our platform.</p>

                        <h3>2. Acceptable Advertising Content</h3>
                        <p>Advertisements on PixPlay must:</p>
                        <ul>
                            <li>Be clearly identifiable as advertising content</li>
                            <li>Provide accurate and truthful information</li>
                            <li>Comply with applicable laws and regulations</li>
                            <li>Respect user privacy and data protection rights</li>
                            <li>Maintain appropriate content standards</li>
                        </ul>

                        <h3>3. Prohibited Advertising Content</h3>
                        <p>The following types of advertisements are prohibited on PixPlay:</p>
                        <ul>
                            <li>Illegal products, services, or activities</li>
                            <li>Adult content or sexually explicit material</li>
                            <li>Tobacco, alcohol, or controlled substances (with exceptions for legal markets)</li>
                            <li>Weapons, explosives, or dangerous items</li>
                            <li>Misleading or deceptive claims</li>
                            <li>Hate speech or discriminatory content</li>
                            <li>Malware, phishing, or security threats</li>
                            <li>Counterfeit or pirated goods</li>
                        </ul>

                        <h3>4. Ad Placement and User Experience</h3>
                        <p>Advertisements are integrated into the user experience in the following ways:</p>
                        <ul>
                            <li>Native ads that blend with organic content</li>
                            <li>Sponsored pins clearly labeled as promotional</li>
                            <li>Banner advertisements in designated areas</li>
                            <li>Video ads with skip options after initial viewing period</li>
                            <li>Frequency capping to prevent ad fatigue</li>
                        </ul>

                        <h3>5. Targeting and Privacy</h3>
                        <p>Our advertising targeting respects user privacy while providing relevant content:</p>
                        <ul>
                            <li>Interest-based targeting using anonymized data</li>
                            <li>Demographic targeting with user consent</li>
                            <li>Behavioral targeting based on platform activity</li>
                            <li>Opt-out options for personalized advertising</li>
                            <li>No sharing of personal information with advertisers</li>
                        </ul>

                        <h3>6. Advertiser Requirements</h3>
                        <p>Businesses advertising on PixPlay must:</p>
                        <ul>
                            <li>Provide accurate business information and credentials</li>
                            <li>Comply with all applicable advertising laws</li>
                            <li>Respect intellectual property rights</li>
                            <li>Maintain professional communication standards</li>
                            <li>Honor advertised prices and terms</li>
                        </ul>

                        <h3>7. Ad Review Process</h3>
                        <p>All advertisements undergo review before publication:</p>
                        <ul>
                            <li>Automated screening for policy violations</li>
                            <li>Manual review by trained specialists</li>
                            <li>Ongoing monitoring of live advertisements</li>
                            <li>User reporting system for inappropriate ads</li>
                            <li>Regular audits of advertiser compliance</li>
                        </ul>

                        <h3>8. Sponsored Content Guidelines</h3>
                        <p>Sponsored content created by influencers and creators must:</p>
                        <ul>
                            <li>Include clear disclosure of sponsorship</li>
                            <li>Maintain authenticity and creator voice</li>
                            <li>Provide genuine value to audiences</li>
                            <li>Comply with FTC guidelines and local regulations</li>
                            <li>Align with creator's typical content style</li>
                        </ul>

                        <h3>9. Political and Social Issue Advertising</h3>
                        <p>Political advertisements and social issue ads have additional requirements:</p>
                        <ul>
                            <li>Verification of advertiser identity and authorization</li>
                            <li>Clear labeling of political content</li>
                            <li>Transparency in funding sources</li>
                            <li>Compliance with election laws and regulations</li>
                            <li>Restricted targeting options for sensitive content</li>
                        </ul>

                        <h3>10. Ad Performance and Analytics</h3>
                        <p>Advertisers receive comprehensive performance data:</p>
                        <ul>
                            <li>Impression and click-through metrics</li>
                            <li>Audience engagement analytics</li>
                            <li>Conversion tracking and attribution</li>
                            <li>Demographic and interest insights</li>
                            <li>ROI and performance optimization recommendations</li>
                        </ul>

                        <h3>11. User Controls and Preferences</h3>
                        <p>Users have control over their advertising experience:</p>
                        <ul>
                            <li>Ad preference settings and customization</li>
                            <li>Ability to hide or report inappropriate ads</li>
                            <li>Opt-out options for personalized advertising</li>
                            <li>Feedback mechanisms for ad relevance</li>
                            <li>Transparency about why specific ads are shown</li>
                        </ul>

                        <h3>12. Enforcement and Violations</h3>
                        <p>Violations of advertising policies may result in:</p>
                        <ul>
                            <li>Ad rejection or removal</li>
                            <li>Account warnings and restrictions</li>
                            <li>Suspension of advertising privileges</li>
                            <li>Permanent ban from advertising platform</li>
                            <li>Legal action for severe violations</li>
                        </ul>

                        <h3>13. Appeals and Support</h3>
                        <p>Advertisers may appeal policy decisions through our support system, which provides:</p>
                        <ul>
                            <li>Detailed explanation of policy violations</li>
                            <li>Guidance for compliance and resubmission</li>
                            <li>Escalation to specialized review teams</li>
                            <li>Educational resources for policy compliance</li>
                        </ul>

                        <p><strong>Last updated:</strong> December 2024</p>
                    </div>
                `
            }
        };

        // Helper functions for upload form
        function toggleAdvancedSettings() {
            const settings = document.getElementById('advancedSettings');
            const arrow = document.getElementById('advancedArrow');
            
            if (settings.classList.contains('hidden')) {
                settings.classList.remove('hidden');
                arrow.style.transform = 'rotate(180deg)';
            } else {
                settings.classList.add('hidden');
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        function setPublishNow() {
            document.getElementById('pixSchedule').value = '';
        }

        // Title character counter
        function setupTitleCounter() {
            const titleInput = document.getElementById('pixTitle');
            const titleCount = document.getElementById('titleCount');
            
            titleInput.addEventListener('input', function() {
                const count = this.value.length;
                titleCount.textContent = count;
                
                if (count > 90) {
                    titleCount.style.color = '#ef4444';
                } else if (count > 70) {
                    titleCount.style.color = '#f59e0b';
                } else {
                    titleCount.style.color = '#6b7280';
                }
            });
        }

        // Initialize app
        function init() {
            setupEventListeners();
            setupTitleCounter();
            auth.onAuthStateChanged(handleAuthStateChange);
            loadPixs(); // Changed from loadPins to loadPixs
            loadAds();
            setupSearchEventListeners();
        }

        function setupSearchEventListeners() {
            // Close search suggestions when clicking outside
            document.addEventListener('click', function(e) {
                const searchInput = document.getElementById('searchInput');
                const suggestions = document.getElementById('searchSuggestions');
                if (!searchInput.contains(e.target) && !suggestions.contains(e.target)) {
                    suggestions.classList.add('hidden');
                }
            });
        }

        function handleSearch() {
            const searchInput = document.getElementById('searchInput');
            const query = searchInput.value.trim().toLowerCase();
            
            // Clear previous timeout
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            // Check for sensitive content
            if (checkSensitiveContent(query)) {
                return;
            }
            
            // Track search for personalization
            if (query.length > 0) {
                personalizationEngine.trackInteraction('search', query);
            }
            
            // Debounce search
            searchTimeout = setTimeout(() => {
                if (query.length > 0) {
                    showSearchSuggestions(query);
                    performSearchFilter(query);
                } else {
                    hideSearchSuggestions();
                    showAllPins();
                }
            }, 300);
        }

        function handleSearchKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                performSearch();
            }
        }

        function checkSensitiveContent(query) {
            const suicideKeywords = ['suicide', 'kill myself', 'end my life', 'want to die', 'self harm', 'hurt myself'];
            const sexualKeywords = ['sex', 'porn', 'nude', 'naked', 'adult', 'xxx', 'sexual'];
            
            // Check for suicide-related content
            for (let keyword of suicideKeywords) {
                if (query.includes(keyword)) {
                    showSupportModal();
                    document.getElementById('searchInput').value = '';
                    return true;
                }
            }
            
            // Check for sexual content
            for (let keyword of sexualKeywords) {
                if (query.includes(keyword)) {
                    showSafetyWarning();
                    document.getElementById('searchInput').value = '';
                    return true;
                }
            }
            
            return false;
        }

        function showSafetyWarning() {
            document.getElementById('safetyTitle').textContent = 'Content Warning';
            document.getElementById('safetyMessage').textContent = 'This type of content is not allowed on PixPlay. Please search for appropriate content only.';
            document.getElementById('safetyModal').classList.remove('hidden');
        }

        function showSupportModal() {
            document.getElementById('supportModal').classList.remove('hidden');
        }

        function closeSafetyModal() {
            document.getElementById('safetyModal').classList.add('hidden');
        }

        function closeSupportModal() {
            document.getElementById('supportModal').classList.add('hidden');
        }

        function showSearchSuggestions(query) {
            const suggestions = document.getElementById('searchSuggestions');
            const commonSearches = [
                'nature photography', 'food recipes', 'home decor', 'fashion style', 
                'travel destinations', 'art inspiration', 'diy projects', 'wedding ideas',
                'fitness motivation', 'garden design', 'architecture', 'photography tips'
            ];
            
            const filteredSuggestions = commonSearches.filter(item => 
                item.toLowerCase().includes(query)
            ).slice(0, 5);
            
            if (filteredSuggestions.length > 0) {
                suggestions.innerHTML = filteredSuggestions.map(suggestion => 
                    `<div class="search-suggestion" onclick="selectSuggestion('${suggestion}')">${suggestion}</div>`
                ).join('');
                suggestions.classList.remove('hidden');
            } else {
                hideSearchSuggestions();
            }
        }

        function hideSearchSuggestions() {
            document.getElementById('searchSuggestions').classList.add('hidden');
        }

        function selectSuggestion(suggestion) {
            document.getElementById('searchInput').value = suggestion;
            hideSearchSuggestions();
            performSearchFilter(suggestion.toLowerCase());
        }

        function performSearch() {
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            if (query && !checkSensitiveContent(query)) {
                performSearchFilter(query);
                hideSearchSuggestions();
            }
        }

        function performSearchFilter(query) {
            currentSearchTerm = query;
            
            if (query === '') {
                showAllPixs();
                return;
            }
            
            // Filter pixs based on tags, descriptions, or any metadata
            filteredPins = allPins.filter(pix => {
                const searchableText = [
                    pix.tags || '',
                    pix.searchTags || '',
                    pix.description || '',
                    pix.title || '',
                    pix.category || '',
                    pix.board || '',
                    pix.userDisplayName || ''
                ].join(' ').toLowerCase();
                
                return searchableText.includes(query);
            });
            
            displayPinsWithAds(filteredPins, 'imageGallery');
            
            // Show search results message
            if (filteredPins.length === 0) {
                document.getElementById('imageGallery').innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-gray-400 text-6xl mb-4">🔍</div>
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">No results found</h3>
                        <p class="text-gray-500">Try searching for something else</p>
                    </div>
                `;
            }
        }

        function showAllPixs() {
            currentSearchTerm = '';
            filteredPins = [];
            const personalizedPixs = personalizationEngine.personalizeFeed(allPins);
            displayPinsWithAds(personalizedPixs, 'imageGallery');
        }

        function setupEventListeners() {
            const uploadArea = document.getElementById('uploadArea');
            const imageInput = document.getElementById('imageInput');
            const profilePictureInput = document.getElementById('profilePictureInput');

            uploadArea.addEventListener('click', () => imageInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);

            imageInput.addEventListener('change', handleImageSelect);
            profilePictureInput.addEventListener('change', handleProfilePictureSelect);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        }

        function handleImageSelect(e) {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        }

        function handleProfilePictureSelect(e) {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('settingsAvatar').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function handleFileSelect(file) {
            if (file && file.type.startsWith('image/')) {
                // Check file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showError('File size too large. Please select an image under 5MB.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const uploadArea = document.getElementById('uploadArea');
                        uploadArea.innerHTML = `
                            <img src="${e.target.result}" class="max-h-48 mx-auto rounded-lg" style="max-width: 100%; height: auto;">
                            <p class="text-sm text-gray-600 mt-2">Image selected</p>
                        `;
                        uploadArea.dataset.imageData = e.target.result;
                    } catch (error) {
                        console.error('Error processing image:', error);
                        showError('Error processing image. Please try again.');
                    }
                };
                reader.onerror = function() {
                    showError('Error reading file. Please try again.');
                };
                reader.readAsDataURL(file);
            } else {
                showError('Please select a valid image file.');
            }
        }

        function showError(message) {
            // Create a simple error notification
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }

        function showSuccess(message) {
            // Create a simple success notification
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.parentNode.removeChild(successDiv);
                }
            }, 3000);
        }

        function handleAuthStateChange(user) {
            currentUser = user;
            if (user) {
                showUserSection(user);
                loadUserData();
                personalizationEngine.loadUserProfile();
            } else {
                showLoginSection();
            }
            updateMobileUserSection();
        }

        function showUserSection(user) {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('userSection').classList.remove('hidden');
            document.getElementById('userAvatar').src = user.photoURL || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiNGM0Y0RjYiLz4KPHN2ZyB4PSI2IiB5PSI2IiB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgZmlsbD0ibm9uZSI+CjxwYXRoIGQ9Ik0xNiAxN3YtMmEzIDMgMCAwIDAtMy0zSDd2LTJhMyAzIDAgMCAwLTMtM0g0djJhMyAzIDAgMCAwIDMgM2g2djJhMyAzIDAgMCAwIDMgM2gyeiIgZmlsbD0iIzlDQTNBRiIvPgo8Y2lyY2xlIGN4PSIxMCIgY3k9IjYiIHI9IjMiIGZpbGw9IiM5Q0EzQUYiLz4KPC9zdmc+Cjwvc3ZnPgo=';
        }

        function showLoginSection() {
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('userSection').classList.add('hidden');
        }

        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            
            // Show loading state
            const signInButton = document.querySelector('button[onclick="signInWithGoogle()"]');
            const originalText = signInButton.textContent;
            signInButton.textContent = 'Signing in...';
            signInButton.disabled = true;
            
            auth.signInWithPopup(provider).catch(error => {
                console.error('Sign in error:', error);
                let errorMessage = 'Sign in failed. Please try again.';
                
                switch (error.code) {
                    case 'auth/popup-closed-by-user':
                        errorMessage = 'Sign in was cancelled.';
                        break;
                    case 'auth/popup-blocked':
                        errorMessage = 'Pop-up was blocked. Please allow pop-ups and try again.';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = 'Network error. Please check your connection.';
                        break;
                }
                
                showError(errorMessage);
            }).finally(() => {
                signInButton.textContent = originalText;
                signInButton.disabled = false;
            });
        }

        function signOut() {
            auth.signOut();
            closeSettings();
        }

        function loadUserData() {
            if (!currentUser) return;
            
            // Load user profile data
            database.ref(`users/${currentUser.uid}`).once('value', (snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    document.getElementById('displayName').value = userData.displayName || currentUser.displayName;
                    document.getElementById('userBio').value = userData.bio || '';
                    document.getElementById('settingsAvatar').src = userData.photoURL || currentUser.photoURL;
                }
            });

            // Load user's saved pixs (check both new and legacy)
            const loadSavedPixs = database.ref(`savedPixs/${currentUser.uid}`).once('value');
            const loadSavedPins = database.ref(`savedPins/${currentUser.uid}`).once('value');
            
            Promise.all([loadSavedPixs, loadSavedPins]).then(([pixsSnapshot, pinsSnapshot]) => {
                savedPins = [];
                
                // Load from new savedPixs
                pixsSnapshot.forEach((child) => {
                    savedPins.push(child.key);
                });
                
                // Load from legacy savedPins
                pinsSnapshot.forEach((child) => {
                    if (!savedPins.includes(child.key)) {
                        savedPins.push(child.key);
                    }
                });
                
                if (currentView === 'saved') {
                    showSaved();
                }
            });
            
            // Set up real-time listeners
            database.ref(`savedPixs/${currentUser.uid}`).on('value', (snapshot) => {
                const newSavedPixs = [];
                snapshot.forEach((child) => {
                    newSavedPixs.push(child.key);
                });
                
                // Merge with existing saved pins to avoid losing legacy data
                savedPins = [...new Set([...savedPins, ...newSavedPixs])];
                
                if (currentView === 'saved') {
                    showSaved();
                }
            });

            // Load user's pixs (both current and legacy)
            const loadUserPixs = database.ref('pixs').orderByChild('userId').equalTo(currentUser.uid).once('value');
            const loadUserPins = database.ref('pins').orderByChild('userId').equalTo(currentUser.uid).once('value');
            
            Promise.all([loadUserPixs, loadUserPins]).then(([pixsSnapshot, pinsSnapshot]) => {
                userPix = [];
                
                // Load current pixs
                pixsSnapshot.forEach((child) => {
                    userPix.push({ id: child.key, ...child.val() });
                });
                
                // Load legacy pins
                pinsSnapshot.forEach((child) => {
                    const pin = { id: child.key, ...child.val() };
                    // Convert to pix format
                    const migratedPix = {
                        ...pin,
                        board: pin.category || 'general',
                        tags: pin.tags || '',
                        products: '',
                        link: '',
                        settings: {
                            allowComments: true,
                            paidPartnership: false,
                            showSimilarProducts: false
                        }
                    };
                    userPix.push(migratedPix);
                });
                
                if (currentView === 'myPix') {
                    showMyPix();
                }
            });
            
            // Set up real-time listener for new user pixs
            database.ref('pixs').orderByChild('userId').equalTo(currentUser.uid).on('child_added', (snapshot) => {
                const pix = { id: snapshot.key, ...snapshot.val() };
                if (!userPix.find(p => p.id === pix.id)) {
                    userPix.unshift(pix);
                    if (currentView === 'myPix') {
                        showMyPix();
                    }
                }
            });
        }

        function loadPixs() {
            // Load both current pixs and legacy pins data
            const loadCurrentPixs = database.ref('pixs').once('value');
            const loadLegacyPins = database.ref('pins').once('value');
            
            Promise.all([loadCurrentPixs, loadLegacyPins]).then(([pixsSnapshot, pinsSnapshot]) => {
                allPins = [];
                
                // Load current pixs
                pixsSnapshot.forEach((child) => {
                    const pix = { id: child.key, ...child.val() };
                    // Only show published pixs (not scheduled)
                    if (!pix.isScheduled || pix.publishTime <= Date.now()) {
                        allPins.push(pix);
                    }
                });
                
                // Load legacy pins and migrate them
                pinsSnapshot.forEach((child) => {
                    const pin = { id: child.key, ...child.val() };
                    // Convert pin to pix format
                    const migratedPix = {
                        ...pin,
                        board: pin.category || 'general',
                        tags: pin.tags || '',
                        products: '',
                        link: '',
                        settings: {
                            allowComments: true,
                            paidPartnership: false,
                            showSimilarProducts: false
                        },
                        searchTags: pin.tags || `${pin.title || ''} ${pin.description || ''}`.toLowerCase()
                    };
                    allPins.push(migratedPix);
                });
                
                if (currentView === 'home') {
                    const personalizedPixs = personalizationEngine.personalizeFeed(allPins);
                    displayPinsWithAds(personalizedPixs, 'imageGallery');
                }
            }).catch(error => {
                console.error('Error loading pixs:', error);
            });
            
            // Set up real-time listeners for new pixs
            database.ref('pixs').on('child_added', (snapshot) => {
                const pix = { id: snapshot.key, ...snapshot.val() };
                if (!pix.isScheduled || pix.publishTime <= Date.now()) {
                    // Check if already exists to avoid duplicates
                    if (!allPins.find(p => p.id === pix.id)) {
                        allPins.unshift(pix); // Add to beginning for newest first
                        if (currentView === 'home') {
                            const personalizedPixs = personalizationEngine.personalizeFeed(allPins);
                            displayPinsWithAds(personalizedPixs, 'imageGallery');
                        }
                    }
                }
            });
        }

        function loadAds() {
            database.ref('ads').on('value', (snapshot) => {
                adsData = [];
                snapshot.forEach((child) => {
                    const ad = { id: child.key, ...child.val() };
                    if (ad.active !== false) {
                        adsData.push(ad);
                    }
                });
            });
        }

        function displayPins(pins, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            pins.forEach(pin => {
                const pinCard = createPinCard(pin);
                container.appendChild(pinCard);
            });
        }

        function displayPinsWithAds(pins, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            pins.forEach((pin, index) => {
                const pinCard = createPinCard(pin);
                container.appendChild(pinCard);

                // Show ad after every 7-8 pins
                if ((index + 1) % 7 === 0 && adsData.length > 0) {
                    const randomAd = adsData[Math.floor(Math.random() * adsData.length)];
                    if (!hiddenAds.includes(randomAd.id)) {
                        const adCard = createAdCard(randomAd);
                        container.appendChild(adCard);
                    }
                }
            });
        }

        function createPinCard(pin) {
            const card = document.createElement('div');
            card.className = 'pin-card bg-white shadow-sm rounded-2xl overflow-hidden cursor-pointer transition-transform hover:scale-105';
            
            // Track view time for personalization
            let viewStartTime = null;
            
            card.onclick = () => {
                openPinModal(pin.id);
                // Track view interaction
                personalizationEngine.trackInteraction('view', pin);
            };

            card.onmouseenter = () => {
                viewStartTime = Date.now();
            };

            card.onmouseleave = () => {
                if (viewStartTime) {
                    const timeSpent = Date.now() - viewStartTime;
                    personalizationEngine.trackInteraction('timeSpent', { ...pin, timeSpent });
                    viewStartTime = null;
                }
            };

            const isSaved = savedPins.includes(pin.id);
            const isMonetized = pin.views >= 2000;
            const isOwner = currentUser && pin.userId === currentUser.uid;

            card.innerHTML = `
                <div class="relative">
                    <img src="${pin.imageData}" alt="Pin" class="w-full h-auto object-cover" style="aspect-ratio: auto;">
                    <div class="pin-overlay"></div>
                    <div class="pin-actions">
                        <button onclick="event.stopPropagation(); toggleSavePix('${pin.id}')" 
                                class="bg-red-600 text-white px-2 md:px-3 py-1 rounded-full text-xs md:text-sm hover:bg-red-700 transition-colors">
                            ${isSaved ? 'Saved' : 'Save'}
                        </button>
                    </div>
                    ${isMonetized ? '<div class="absolute top-2 left-2 bg-green-500 text-white px-2 py-1 rounded-full text-xs">💰 Monetized</div>' : ''}
                    ${isOwner ? `<div class="absolute bottom-2 left-2 bg-blue-500 text-white px-2 py-1 rounded-full text-xs flex items-center space-x-1">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                            <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                        </svg>
                        <span>${pin.views || 0}</span>
                    </div>` : ''}
                </div>
                ${pin.title ? `<div class="p-3">
                    <h3 class="font-medium text-sm md:text-base text-gray-900 line-clamp-2">${pin.title}</h3>
                    ${pin.description ? `<p class="text-xs md:text-sm text-gray-600 mt-1 line-clamp-2">${pin.description}</p>` : ''}
                </div>` : ''}
            `;

            return card;
        }

        function createAdCard(ad) {
            const card = document.createElement('div');
            card.className = 'pin-card bg-white shadow-sm rounded-2xl overflow-hidden relative';
            
            card.innerHTML = `
                <div class="relative">
                    <button onclick="hideAd('${ad.id}')" class="absolute top-2 right-2 bg-white bg-opacity-80 hover:bg-opacity-100 rounded-full p-1 z-10 transition-all">
                        <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                    <div class="absolute top-2 left-2 bg-blue-500 text-white px-2 py-1 rounded-full text-xs font-medium">
                        Sponsored
                    </div>
                    ${ad.previewImage ? `<img src="${ad.previewImage}" alt="Ad Preview" class="w-full h-auto object-cover" style="aspect-ratio: auto;">` : ''}
                </div>
                <div class="p-4">
                    <div class="flex items-center space-x-2 mb-3">
                        ${ad.logo ? `<img src="${ad.logo}" alt="${ad.brandName}" class="w-8 h-8 rounded-full object-cover">` : ''}
                        <div>
                            <div class="font-semibold text-sm text-gray-900">${ad.brandName || 'Pulse by Oriontec'}</div>
                            ${ad.tagline ? `<div class="text-xs text-gray-600">${ad.tagline}</div>` : ''}
                        </div>
                    </div>
                    ${ad.description ? `<p class="text-sm text-gray-700 mb-3 line-clamp-2">${ad.description}</p>` : ''}
                    <button onclick="window.open('${ad.ctaLink || 'https://pulse.oriontec.xyz'}', '_blank')" 
                            class="w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors font-medium text-sm">
                        ${ad.ctaText || 'Try Pulse Now'}
                    </button>
                </div>
            `;

            return card;
        }

        function hideAd(adId) {
            hiddenAds.push(adId);
            // Refresh current view to remove the ad
            if (currentView === 'home') {
                if (currentSearchTerm) {
                    displayPinsWithAds(filteredPins, 'imageGallery');
                } else {
                    const personalizedPins = personalizationEngine.personalizeFeed(allPins);
                    displayPinsWithAds(personalizedPins, 'imageGallery');
                }
            }
        }

        function showHome() {
            currentView = 'home';
            document.getElementById('homeView').classList.remove('hidden');
            document.getElementById('savedView').classList.add('hidden');
            document.getElementById('myPixView').classList.add('hidden');
            
            // Show filtered pixs if there's an active search, otherwise show personalized feed
            if (currentSearchTerm) {
                displayPinsWithAds(filteredPins, 'imageGallery');
            } else {
                const personalizedPixs = personalizationEngine.personalizeFeed(allPins);
                displayPinsWithAds(personalizedPixs, 'imageGallery');
            }
        }

        function showSaved() {
            if (!currentUser) {
                showError('Please sign in to view saved Pix');
                return;
            }
            currentView = 'saved';
            document.getElementById('homeView').classList.add('hidden');
            document.getElementById('savedView').classList.remove('hidden');
            document.getElementById('myPixView').classList.add('hidden');
            
            const savedPixData = allPins.filter(pix => savedPins.includes(pix.id));
            displayPins(savedPixData, 'savedGallery');
        }

        function showMyPix() {
            if (!currentUser) {
                showError('Please sign in to view your Pix');
                return;
            }
            currentView = 'myPix';
            document.getElementById('homeView').classList.add('hidden');
            document.getElementById('savedView').classList.add('hidden');
            document.getElementById('myPixView').classList.remove('hidden');
            
            // Update stats
            const totalViews = userPix.reduce((sum, pix) => sum + (pix.views || 0), 0);
            const scheduledCount = userPix.filter(pix => pix.isScheduled && pix.publishTime > Date.now()).length;
            
            document.getElementById('myPixStats').innerHTML = `
                <div class="text-center">
                    <div class="text-lg font-bold text-gray-900">${userPix.length}</div>
                    <div class="text-xs text-gray-500">Pix</div>
                </div>
                <div class="text-center ml-4">
                    <div class="text-lg font-bold text-gray-900">${totalViews}</div>
                    <div class="text-xs text-gray-500">Total Views</div>
                </div>
                ${scheduledCount > 0 ? `<div class="text-center ml-4">
                    <div class="text-lg font-bold text-blue-600">${scheduledCount}</div>
                    <div class="text-xs text-gray-500">Scheduled</div>
                </div>` : ''}
            `;
            
            displayPins(userPix, 'myPixGallery');
        }

        function openUploadModal() {
            if (!currentUser) {
                showError('Please sign in to upload images');
                return;
            }
            document.getElementById('uploadModal').classList.remove('hidden');
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').classList.add('hidden');
            resetUploadForm();
        }

        function resetUploadForm() {
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.innerHTML = `
                <svg class="w-10 h-10 md:w-12 md:h-12 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <p class="text-gray-600 mb-2 text-sm md:text-base">Choose a file or drag and drop it here</p>
                <p class="text-xs md:text-sm text-gray-400">We recommend using high quality .jpg files</p>
            `;
            uploadArea.classList.remove('dragover');
            
            // Clear all form fields
            document.getElementById('pixTitle').value = '';
            document.getElementById('pixDescription').value = '';
            document.getElementById('pixLink').value = '';
            document.getElementById('pixBoard').value = '';
            document.getElementById('pixTags').value = '';
            document.getElementById('pixProducts').value = '';
            document.getElementById('pixSchedule').value = '';
            document.getElementById('allowComments').checked = true;
            document.getElementById('paidPartnership').checked = false;
            document.getElementById('showSimilarProducts').checked = false;
            document.getElementById('imageInput').value = '';
            document.getElementById('titleCount').textContent = '0';
            
            // Hide status messages
            document.getElementById('uploadStatus').classList.add('hidden');
            
            // Clear image data
            delete uploadArea.dataset.imageData;
            
            // Reset advanced settings
            const advancedSettings = document.getElementById('advancedSettings');
            const advancedArrow = document.getElementById('advancedArrow');
            advancedSettings.classList.add('hidden');
            advancedArrow.style.transform = 'rotate(0deg)';
        }

        function uploadImage() {
            const imageData = document.getElementById('uploadArea').dataset.imageData;
            const title = document.getElementById('pixTitle').value.trim();
            const description = document.getElementById('pixDescription').value.trim();
            const link = document.getElementById('pixLink').value.trim();
            const board = document.getElementById('pixBoard').value;
            const tags = document.getElementById('pixTags').value.trim();
            const products = document.getElementById('pixProducts').value.trim();
            const schedule = document.getElementById('pixSchedule').value;
            const allowComments = document.getElementById('allowComments').checked;
            const paidPartnership = document.getElementById('paidPartnership').checked;
            const showSimilarProducts = document.getElementById('showSimilarProducts').checked;
            
            if (!imageData) {
                showError('Please select an image');
                return;
            }

            if (!currentUser) {
                showError('Please sign in to upload images');
                return;
            }

            // Check if scheduled for future
            const publishTime = schedule ? new Date(schedule).getTime() : Date.now();
            const isScheduled = publishTime > Date.now();

            const newPix = {
                imageData: imageData,
                title: title,
                description: description,
                link: link,
                board: board || 'general',
                tags: tags,
                products: products,
                userId: currentUser.uid,
                userDisplayName: currentUser.displayName || 'Anonymous User',
                userPhotoURL: currentUser.photoURL || '',
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                publishTime: publishTime,
                isScheduled: isScheduled,
                views: 0,
                comments: {},
                settings: {
                    allowComments: allowComments,
                    paidPartnership: paidPartnership,
                    showSimilarProducts: showSimilarProducts && !products && !paidPartnership
                },
                category: board || 'general',
                searchTags: `${title} ${description} ${tags}`.toLowerCase()
            };

            // Show loading state
            const uploadButton = document.querySelector('#uploadModal button[onclick="uploadImage()"]');
            const originalText = uploadButton.textContent;
            uploadButton.textContent = 'Saving Pix...';
            uploadButton.disabled = true;

            // Show upload status
            document.getElementById('uploadStatus').classList.remove('hidden');

            const dbRef = isScheduled ? 'scheduledPixs' : 'pixs';
            
            database.ref(dbRef).push(newPix).then(() => {
                // Success - show success message and close modal
                if (isScheduled) {
                    showSuccess('Pix scheduled successfully!');
                } else {
                    showSuccess('Pix uploaded successfully!');
                }
                
                // Reset button state
                uploadButton.textContent = originalText;
                uploadButton.disabled = false;
                
                // Close modal and reset form
                setTimeout(() => {
                    closeUploadModal();
                }, 1000);
                
            }).catch(error => {
                console.error('Upload error:', error);
                showError('Upload failed. Please try again.');
                document.getElementById('uploadStatus').classList.add('hidden');
                
                // Reset button state on error
                uploadButton.textContent = originalText;
                uploadButton.disabled = false;
            });
        }

        function openPinModal(pixId) {
            const pix = allPins.find(p => p.id === pixId);
            if (!pix) return;

            currentPinId = pixId;
            
            // Increment view count - check both pixs and pins collections
            const dbRef = pix.board ? 'pixs' : 'pins'; // New pixs have board property
            database.ref(`${dbRef}/${pixId}/views`).transaction((currentViews) => {
                return (currentViews || 0) + 1;
            });

            // Update modal content
            document.getElementById('modalImage').src = pix.imageData;
            
            // Show ads for monetized content
            const adSpace = document.getElementById('adSpace');
            if (pix.views >= 2000) {
                adSpace.classList.remove('hidden');
            } else {
                adSpace.classList.add('hidden');
            }

            // Load comments
            loadComments(pixId);

            document.getElementById('pinModal').classList.remove('hidden');
        }

        function closePinModal() {
            document.getElementById('pinModal').classList.add('hidden');
            currentPinId = null;
        }

        function toggleSavePix(pixId) {
            if (!currentUser) {
                showError('Please sign in to save Pix');
                return;
            }

            const isSaved = savedPins.includes(pixId);
            const pix = allPins.find(p => p.id === pixId);
            
            if (isSaved) {
                database.ref(`savedPixs/${currentUser.uid}/${pixId}`).remove().catch(error => {
                    console.error('Error removing saved pix:', error);
                    showError('Failed to remove Pix. Please try again.');
                });
            } else {
                database.ref(`savedPixs/${currentUser.uid}/${pixId}`).set(true).then(() => {
                    // Track save interaction for personalization
                    if (pix) {
                        personalizationEngine.trackInteraction('save', pix);
                    }
                }).catch(error => {
                    console.error('Error saving pix:', error);
                    showError('Failed to save Pix. Please try again.');
                });
            }
        }

        function savePix() {
            if (currentPinId) {
                toggleSavePix(currentPinId);
            }
        }

        function downloadImage() {
            const pin = allPins.find(p => p.id === currentPinId);
            if (!pin) return;

            const link = document.createElement('a');
            link.href = pin.imageData;
            link.download = `pixplay-image-${currentPinId}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function loadComments(pinId) {
            const commentsList = document.getElementById('commentsList');
            commentsList.innerHTML = '';

            database.ref(`pins/${pinId}/comments`).on('value', (snapshot) => {
                commentsList.innerHTML = '';
                snapshot.forEach((child) => {
                    const comment = child.val();
                    const commentDiv = document.createElement('div');
                    commentDiv.className = 'flex space-x-3';
                    commentDiv.innerHTML = `
                        <img class="w-8 h-8 rounded-full" src="${comment.userPhotoURL || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiNGM0Y0RjYiLz4KPHN2ZyB4PSI2IiB5PSI2IiB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgZmlsbD0ibm9uZSI+CjxwYXRoIGQ9Ik0xNiAxN3YtMmEzIDMgMCAwIDAtMy0zSDd2LTJhMyAzIDAgMCAwLTMtM0g0djJhMyAzIDAgMCAwIDMgM2g2djJhMyAzIDAgMCAwIDMgM2gyeiIgZmlsbD0iIzlDQTNBRiIvPgo8Y2lyY2xlIGN4PSIxMCIgY3k9IjYiIHI9IjMiIGZpbGw9IiM5Q0EzQUYiLz4KPC9zdmc+Cjwvc3ZnPgo='}" alt="User">
                        <div class="flex-1">
                            <div class="font-medium text-sm">${comment.userDisplayName}</div>
                            <div class="text-gray-700">${comment.text}</div>
                            <div class="text-xs text-gray-500 mt-1">${new Date(comment.timestamp).toLocaleDateString()}</div>
                        </div>
                    `;
                    commentsList.appendChild(commentDiv);
                });
            });
        }

        function addComment() {
            if (!currentUser || !currentPinId) return;

            const commentInput = document.getElementById('commentInput');
            const commentText = commentInput.value.trim();
            
            if (!commentText) return;

            const newComment = {
                text: commentText,
                userId: currentUser.uid,
                userDisplayName: currentUser.displayName,
                userPhotoURL: currentUser.photoURL,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            database.ref(`pins/${currentPinId}/comments`).push(newComment).then(() => {
                commentInput.value = '';
            });
        }

        function openSettings() {
            if (!currentUser) return;
            
            document.getElementById('settingsAvatar').src = currentUser.photoURL || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iNDAiIGZpbGw9IiNGM0Y0RjYiLz4KPHN2ZyB4PSIyMCIgeT0iMjAiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDQwIDQwIiBmaWxsPSJub25lIj4KPHBhdGggZD0iTTMy
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97956a792329836f',t:'MTc1NjkwNDI3OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
