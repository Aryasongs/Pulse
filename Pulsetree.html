<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pulsetree - UPI QR Generator & Profile Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        body {
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        /* Instagram-like App Styles */
        .app-container {
            max-width: 430px;
            margin: 0 auto;
            background: #000;
            min-height: 100vh;
            position: relative;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #833ab4 0%, #fd1d1d 50%, #fcb045 100%);
        }
        
        .dark-bg {
            background: #000;
        }
        
        .card-bg {
            background: #1a1a1a;
            border: 1px solid #333;
        }
        
        .text-primary {
            color: #fff;
        }
        
        .text-secondary {
            color: #8e8e8e;
        }
        
        .text-accent {
            color: #0095f6;
        }
        
        /* Story-like highlights */
        .story-ring {
            background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
            padding: 2px;
            border-radius: 50%;
        }
        
        .story-inner {
            background: #000;
            border-radius: 50%;
            padding: 2px;
        }
        
        /* Post styles */
        .post-card {
            background: #000;
            border-bottom: 1px solid #262626;
        }
        
        .post-image {
            aspect-ratio: 1;
            object-fit: cover;
        }
        
        /* Bottom navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 430px;
            background: #000;
            border-top: 1px solid #262626;
            z-index: 50;
        }
        
        /* Animations */
        .heart-animation {
            animation: heartBeat 0.6s ease-in-out;
        }
        
        @keyframes heartBeat {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }
        
        /* Loading skeleton */
        .skeleton {
            background: linear-gradient(90deg, #262626 25%, #333 50%, #262626 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Mobile optimizations */
        .touch-target {
            min-height: 44px;
            min-width: 44px;
        }
        
        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* Payment button styles */
        .pay-button {
            background: linear-gradient(45deg, #405de6, #5851db, #833ab4, #c13584, #e1306c, #fd1d1d);
            background-size: 300% 300%;
            animation: gradientShift 3s ease infinite;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Story viewer */
        .story-viewer {
            background: #000;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 100;
        }
        
        .story-progress {
            height: 2px;
            background: rgba(255,255,255,0.3);
            border-radius: 1px;
            overflow: hidden;
        }
        
        .story-progress-fill {
            height: 100%;
            background: #fff;
            border-radius: 1px;
            animation: progressFill 5s linear;
        }
        
        @keyframes progressFill {
            from { width: 0%; }
            to { width: 100%; }
        }
    </style>
</head>
<body class="dark-bg">
    <div class="app-container">
    <!-- UPI QR Generator View -->
    <div id="qrGeneratorView" class="min-h-full p-4">
        <div class="max-w-md mx-auto">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-white mb-2">🚀 Pulsetree</h1>
                <p class="text-white/80 text-lg">UPI QR Generator</p>
                <p class="text-white/60 text-sm mt-2">Generate instant UPI payment QR codes</p>
            </div>

            <div class="glass-effect rounded-2xl p-6 mb-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-white font-medium mb-2">UPI ID *</label>
                        <input type="text" id="qrUpiId" class="w-full p-3 border border-white/20 rounded-lg bg-white/10 text-white placeholder-white/50" placeholder="rahul@okaxis">
                    </div>
                    
                    <div>
                        <label class="block text-white font-medium mb-2">Payee Name (Optional)</label>
                        <input type="text" id="qrPayeeName" class="w-full p-3 border border-white/20 rounded-lg bg-white/10 text-white placeholder-white/50" placeholder="Rahul Kumar">
                    </div>
                    
                    <div>
                        <label class="block text-white font-medium mb-2">Amount (Optional)</label>
                        <input type="number" id="qrAmount" class="w-full p-3 border border-white/20 rounded-lg bg-white/10 text-white placeholder-white/50" placeholder="100" min="1">
                    </div>
                    
                    <div>
                        <label class="block text-white font-medium mb-2">Note/Message (Optional)</label>
                        <input type="text" id="qrNote" class="w-full p-3 border border-white/20 rounded-lg bg-white/10 text-white placeholder-white/50" placeholder="Tip for creator">
                    </div>
                    
                    <button id="generateQrBtn" class="w-full bg-white text-purple-600 py-3 rounded-lg font-semibold hover:bg-white/90 transition-colors">
                        🎯 Generate QR Code
                    </button>
                </div>
            </div>

            <!-- QR Code Display -->
            <div id="qrDisplay" class="glass-effect rounded-2xl p-6 text-center hidden">
                <h3 class="text-white font-semibold mb-4">📱 Your UPI QR Code</h3>
                <div class="bg-white p-4 rounded-lg mb-4 inline-block">
                    <canvas id="qrCanvas" class="mx-auto"></canvas>
                </div>
                <p class="text-white/80 text-sm mb-4">Scan with any UPI app to pay</p>
                
                <div class="space-y-3">
                    <button id="openUpiBtn" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors">
                        📱 Open UPI App
                    </button>
                    <button id="downloadQrBtn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                        💾 Download QR Code
                    </button>
                    <button id="shareQrBtn" class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition-colors">
                        📤 Share QR Code
                    </button>
                </div>
                
                <div class="mt-4 p-3 bg-white/10 rounded-lg">
                    <p class="text-white/60 text-xs mb-1">UPI Deep Link:</p>
                    <a id="upiDeepLink" href="#" class="text-white text-xs font-mono break-all hover:text-white/80" target="_blank"></a>
                </div>
            </div>

            <!-- Create Profile CTA -->
            <div class="glass-effect rounded-2xl p-6 text-center mt-6">
                <h3 class="text-white font-semibold mb-2">🌟 Want More Features?</h3>
                <p class="text-white/80 text-sm mb-4">Create your Pulsetree profile for link-in-bio + tip jar</p>
                <button id="createProfileBtn" class="w-full bg-gradient-to-r from-pink-500 to-purple-600 text-white py-3 rounded-lg font-semibold hover:from-pink-600 hover:to-purple-700 transition-all">
                    🚀 Create My Profile
                </button>
                <p class="text-white/50 text-xs mt-2">Your profile: pulse.oriontec.xyz/pulsetree.html/username</p>
            </div>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-full flex items-center justify-center p-4">
        <div class="max-w-md w-full">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-white mb-4">🚀 Pulsetree</h1>
                <p class="text-white/80 text-lg mb-2">Social Creator Platform</p>
                <p class="text-white/60 text-sm">Login required to access profiles and features</p>
            </div>

            <div class="glass-effect rounded-2xl p-6">
                <h2 class="text-xl font-bold text-white mb-6 text-center">Welcome Back!</h2>
                
                <!-- Google Sign In -->
                <button id="googleLoginBtn" class="w-full bg-white text-gray-800 py-3 px-4 rounded-lg font-semibold hover:bg-gray-100 transition-colors flex items-center justify-center gap-3 mb-4">
                    <svg class="w-5 h-5" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC04" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Continue with Google
                </button>

                <!-- Demo Login Button -->
                <button id="demoLoginBtn" class="w-full bg-purple-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-purple-700 transition-colors mb-4">
                    🚀 Try Demo Mode
                </button>

                <p class="text-center text-white/60 text-sm">Quick and secure login with your Google account</p>

                <div class="text-center mt-6">
                    <p class="text-white/60 text-sm mb-3">Don't have an account?</p>
                    <button id="showSignupBtn" class="text-white font-semibold hover:text-white/80 transition-colors">
                        Create New Account
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Signup Screen -->
    <div id="signupScreen" class="min-h-full flex items-center justify-center p-4 hidden">
        <div class="max-w-md w-full">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-white mb-4">🚀 Pulsetree</h1>
                <p class="text-white/80 text-lg mb-2">Join the Creator Community</p>
                <p class="text-white/60 text-sm">Create your profile and start receiving tips</p>
            </div>

            <div class="glass-effect rounded-2xl p-6">
                <h2 class="text-xl font-bold text-white mb-6 text-center">Create Account</h2>
                
                <!-- Google Sign Up -->
                <button id="googleSignupBtn" class="w-full bg-white text-gray-800 py-3 px-4 rounded-lg font-semibold hover:bg-gray-100 transition-colors flex items-center justify-center gap-3 mb-4">
                    <svg class="w-5 h-5" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC04" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Sign Up with Google
                </button>

                <p class="text-center text-white/60 text-sm">Join thousands of creators using Google authentication</p>

                <div class="text-center mt-6">
                    <p class="text-white/60 text-sm mb-3">Already have an account?</p>
                    <button id="showLoginBtn" class="text-white font-semibold hover:text-white/80 transition-colors">
                        Sign In Instead
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Instagram-like Home Feed -->
    <div id="discoveryView" class="min-h-full hidden">
        <!-- Header -->
        <div class="fixed top-0 left-0 right-0 bg-black border-b border-gray-800 z-40">
            <div class="px-4 py-3 flex items-center justify-between">
                <h1 class="text-2xl font-bold text-primary">Pulsetree</h1>
                <div class="flex items-center gap-4">
                    <button id="searchToggleBtn" class="text-primary text-xl">🔍</button>
                    <button id="createPostBtn" class="text-primary text-xl">➕</button>
                    <button id="myProfileBtn" class="w-8 h-8 rounded-full overflow-hidden">
                        <img id="navProfileImage" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23333'/%3E%3Cpath d='M50 45c5.5 0 10-4.5 10-10s-4.5-10-10-10-10 4.5-10 10 4.5 10 10 10zm0 5c-6.7 0-20 3.3-20 10v5h40v-5c0-6.7-13.3-10-20-10z' fill='%23666'/%3E%3C/svg%3E" alt="Profile" class="w-full h-full object-cover">
                    </button>
                </div>
            </div>
        </div>

        <!-- Stories Section -->
        <div class="fixed top-14 left-0 right-0 bg-black border-b border-gray-800 z-30">
            <div class="px-4 py-3">
                <div class="flex gap-4 overflow-x-auto">
                    <div class="flex flex-col items-center gap-1 min-w-0">
                        <div class="story-ring w-16 h-16 rounded-full">
                            <div class="story-inner w-full h-full rounded-full">
                                <img id="myStoryImage" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23333'/%3E%3Ctext x='50' y='55' text-anchor='middle' fill='%23fff' font-size='30'%3E%2B%3C/text%3E%3C/svg%3E" alt="Your Story" class="w-full h-full object-cover rounded-full">
                            </div>
                        </div>
                        <span class="text-xs text-secondary">Your Story</span>
                    </div>
                    <div id="storiesContainer" class="flex gap-4">
                        <!-- Stories will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Feed -->
        <div class="pt-32 pb-20">
            <div id="postsContainer" class="space-y-0">
                <!-- Posts will be loaded here -->
            </div>
        </div>

        <!-- Search Overlay -->
        <div id="searchOverlay" class="fixed inset-0 bg-black z-50 hidden">
            <div class="p-4">
                <div class="flex items-center gap-3 mb-4">
                    <button id="closeSearch" class="text-primary text-xl">←</button>
                    <input type="text" id="searchInput" class="flex-1 bg-gray-800 text-primary p-3 rounded-lg" placeholder="Search creators...">
                </div>
                <div class="flex gap-2 mb-4 flex-wrap">
                    <button class="category-filter px-3 py-1 rounded-full text-xs bg-gray-800 text-primary" data-category="">All</button>
                    <button class="category-filter px-3 py-1 rounded-full text-xs bg-gray-800 text-primary" data-category="tech">💻 Tech</button>
                    <button class="category-filter px-3 py-1 rounded-full text-xs bg-gray-800 text-primary" data-category="art">🎨 Art</button>
                    <button class="category-filter px-3 py-1 rounded-full text-xs bg-gray-800 text-primary" data-category="music">🎵 Music</button>
                    <button class="category-filter px-3 py-1 rounded-full text-xs bg-gray-800 text-primary" data-category="fitness">💪 Fitness</button>
                </div>
                <div id="searchResults" class="space-y-3">
                    <!-- Search results will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav safe-area-bottom">
        <div class="flex items-center justify-around py-3">
            <button id="homeNavBtn" class="touch-target flex flex-col items-center gap-1">
                <span class="text-xl">🏠</span>
                <span class="text-xs text-secondary">Home</span>
            </button>
            <button id="searchNavBtn" class="touch-target flex flex-col items-center gap-1">
                <span class="text-xl">🔍</span>
                <span class="text-xs text-secondary">Search</span>
            </button>
            <button id="createNavBtn" class="touch-target flex flex-col items-center gap-1">
                <span class="text-xl">➕</span>
                <span class="text-xs text-secondary">Create</span>
            </button>
            <button id="profileNavBtn" class="touch-target flex flex-col items-center gap-1">
                <span class="text-xl">👤</span>
                <span class="text-xs text-secondary">Profile</span>
            </button>
        </div>
    </div>

    <!-- Create Post Modal -->
    <div id="createPostModal" class="fixed inset-0 bg-black z-50 hidden">
        <div class="p-4">
            <div class="flex items-center justify-between mb-4">
                <button id="closeCreatePost" class="text-primary text-xl">✕</button>
                <h2 class="text-lg font-semibold text-primary">New Post</h2>
                <button id="sharePost" class="text-accent font-semibold">Share</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-primary mb-2">Post Type</label>
                    <div class="flex gap-2">
                        <button class="post-type-btn flex-1 p-3 bg-gray-800 rounded-lg text-primary" data-type="text">📝 Text</button>
                        <button class="post-type-btn flex-1 p-3 bg-gray-800 rounded-lg text-primary" data-type="image">📷 Image</button>
                        <button class="post-type-btn flex-1 p-3 bg-gray-800 rounded-lg text-primary" data-type="tweet">🐦 Tweet</button>
                    </div>
                </div>
                
                <div id="textPostSection" class="hidden">
                    <textarea id="postText" class="w-full bg-gray-800 text-primary p-3 rounded-lg h-32" placeholder="What's on your mind?"></textarea>
                </div>
                
                <div id="imagePostSection" class="hidden">
                    <input type="file" id="postImageUpload" accept="image/*" class="w-full p-2 bg-gray-800 text-primary rounded-lg">
                    <div id="imagePreview" class="mt-2 hidden">
                        <img id="previewImg" class="w-full rounded-lg" alt="Preview">
                    </div>
                    <textarea id="imageCaption" class="w-full bg-gray-800 text-primary p-3 rounded-lg mt-2" placeholder="Write a caption..."></textarea>
                </div>
                
                <div id="tweetPostSection" class="hidden">
                    <textarea id="tweetText" class="w-full bg-gray-800 text-primary p-3 rounded-lg h-24" placeholder="What's happening?" maxlength="280"></textarea>
                    <div class="text-right text-secondary text-sm mt-1">
                        <span id="tweetCharCount">0</span>/280
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile View -->
    <div id="profileView" class="min-h-full hidden pb-20">
        <!-- Profile Header -->
        <div class="bg-black border-b border-gray-800">
            <div class="px-4 py-3 flex items-center justify-between">
                <button id="backToFeed" class="text-primary text-xl">←</button>
                <span id="profileUsername" class="text-primary font-semibold">@username</span>
                <button id="profileMenuBtn" class="text-primary text-xl">⋯</button>
            </div>
        </div>

        <!-- Profile Info -->
        <div class="px-4 py-6">
            <div class="flex items-start gap-4 mb-4">
                <div class="w-20 h-20 rounded-full overflow-hidden border-2 border-gray-600">
                    <img id="profileImage" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23333'/%3E%3Cpath d='M50 45c5.5 0 10-4.5 10-10s-4.5-10-10-10-10 4.5-10 10 4.5 10 10 10zm0 5c-6.7 0-20 3.3-20 10v5h40v-5c0-6.7-13.3-10-20-10z' fill='%23666'/%3E%3C/svg%3E" alt="Profile" class="w-full h-full object-cover">
                </div>
                <div class="flex-1">
                    <div class="flex items-center gap-4 mb-2">
                        <div class="text-center">
                            <div id="postsCount" class="text-lg font-bold text-primary">0</div>
                            <div class="text-xs text-secondary">posts</div>
                        </div>
                        <div class="text-center">
                            <div id="followersCount" class="text-lg font-bold text-primary">0</div>
                            <div class="text-xs text-secondary">followers</div>
                        </div>
                        <div class="text-center">
                            <div id="tipsCount" class="text-lg font-bold text-primary">0</div>
                            <div class="text-xs text-secondary">tips</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <h1 id="profileName" class="text-lg font-bold text-primary mb-1">Your Name</h1>
                <p id="profileBio" class="text-secondary text-sm leading-relaxed">Add your bio here to tell people about yourself</p>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-2 mb-4">
                <button id="tipButton" class="pay-button flex-1 text-white py-2 px-4 rounded-lg font-semibold">
                    💝 Support
                </button>
                <button id="followButton" class="bg-gray-800 text-primary py-2 px-4 rounded-lg font-semibold">
                    Follow
                </button>
                <button id="messageButton" class="bg-gray-800 text-primary py-2 px-4 rounded-lg">
                    💬
                </button>
            </div>

            <!-- Social Links -->
            <div id="socialLinks" class="space-y-2 mb-4">
                <!-- Links will be dynamically added here -->
            </div>

            <!-- Profile URL Display -->
            <div id="profileUrlSection" class="mb-4 hidden">
                <div class="bg-gray-900 rounded-lg p-3">
                    <p class="text-secondary text-xs mb-1">Your Profile Link:</p>
                    <div class="flex items-center gap-2">
                        <span id="profileUrl" class="text-primary text-sm font-mono">pulse.oriontec.xyz/pulsetree.html/demo</span>
                        <button id="copyUrlButton" class="text-accent text-xs">📋</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Tabs -->
        <div class="border-b border-gray-800">
            <div class="flex">
                <button id="postsTab" class="flex-1 py-3 text-center text-primary border-b-2 border-primary">
                    <span class="text-xl">📱</span>
                </button>
                <button id="tipsTab" class="flex-1 py-3 text-center text-secondary">
                    <span class="text-xl">💝</span>
                </button>
                <button id="linksTab" class="flex-1 py-3 text-center text-secondary">
                    <span class="text-xl">🔗</span>
                </button>
            </div>
        </div>

        <!-- Profile Content -->
        <div id="profilePosts" class="grid grid-cols-3 gap-1 p-1">
            <!-- User posts will be loaded here -->
        </div>

        <div id="profileTips" class="hidden p-4">
            <!-- Recent tips will be loaded here -->
        </div>

        <div id="profileLinks" class="hidden p-4">
            <!-- Social links will be loaded here -->
        </div>
    </div>



    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50">
        <div class="min-h-full flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800">Profile Settings</h2>
                        <button id="closeSettings" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>

                    <!-- Profile Info -->
                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                            <div class="flex items-center">
                                <span class="text-gray-500 text-sm">pulse.oriontec.xyz/pulsetree.html?user=</span>
                                <input type="text" id="usernameInput" class="flex-1 p-3 border border-gray-300 rounded-lg ml-1" placeholder="yourname">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Profile Image</label>
                            <input type="file" id="imageUpload" accept="image/*" class="w-full p-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Name</label>
                            <input type="text" id="nameInput" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Your Name">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Bio (emojis welcome! 😊)</label>
                            <textarea id="bioInput" class="w-full p-3 border border-gray-300 rounded-lg h-20" placeholder="Tell people about yourself 🚀"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">UPI ID</label>
                            <input type="text" id="upiInput" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="yourname@paytm">
                        </div>
                    </div>

                    <!-- Theme Selection -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">🎨 Choose Theme</h3>
                        <div class="grid grid-cols-3 gap-3">
                            <button class="theme-option w-full h-16 rounded-lg gradient-purple border-2 border-transparent" data-theme="purple"></button>
                            <button class="theme-option w-full h-16 rounded-lg gradient-pink border-2 border-transparent" data-theme="pink"></button>
                            <button class="theme-option w-full h-16 rounded-lg gradient-orange border-2 border-transparent" data-theme="orange"></button>
                            <button class="theme-option w-full h-16 rounded-lg gradient-green border-2 border-transparent" data-theme="green"></button>
                            <button class="theme-option w-full h-16 rounded-lg gradient-blue border-2 border-transparent" data-theme="blue"></button>
                        </div>
                    </div>

                    <!-- Privacy Settings -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">🔒 Privacy Settings</h3>
                        <div class="space-y-3">
                            <label class="flex items-center">
                                <input type="checkbox" id="showUpiPublic" class="mr-2">
                                <span class="text-sm">Show UPI ID publicly (otherwise only QR)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="showTipCount" class="mr-2">
                                <span class="text-sm">Show tip count to visitors</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="showRecentTips" class="mr-2">
                                <span class="text-sm">Show recent tip messages (social proof)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="hidePayerNames" class="mr-2">
                                <span class="text-sm">Hide payer names in public view</span>
                            </label>
                        </div>
                    </div>

                    <!-- Social Links -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">Social Links</h3>
                        <div id="linkInputs" class="space-y-3">
                            <div class="flex gap-2">
                                <input type="text" placeholder="Link Title" class="flex-1 p-2 border border-gray-300 rounded-lg link-title">
                                <input type="url" placeholder="https://..." class="flex-1 p-2 border border-gray-300 rounded-lg link-url">
                                <button class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 remove-link">×</button>
                            </div>
                        </div>
                        <button id="addLink" class="mt-3 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">+ Add Link</button>
                    </div>

                    <!-- Save Button -->
                    <button id="saveSettings" class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition-colors">
                        Save Changes
                    </button>

                    <!-- Auth Section -->
                    <div id="authSection" class="mt-6 pt-6 border-t border-gray-200">
                        <div id="loginForm">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">Login to Save Profile</h3>
                            <div class="space-y-3">
                                <button id="googleSignInBtn" class="w-full bg-red-600 text-white py-3 rounded-lg font-semibold hover:bg-red-700 flex items-center justify-center gap-2">
                                    <svg class="w-5 h-5" viewBox="0 0 24 24">
                                        <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                        <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                        <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                        <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                    </svg>
                                    Continue with Google
                                </button>
                                <p class="text-center text-gray-500 text-sm">Secure authentication with your Google account</p>
                            </div>
                        </div>
                        <div id="loggedInSection" class="hidden">
                            <p class="text-green-600 mb-3">✓ Logged in as <span id="userEmail"></span></p>
                            <button id="logoutButton" class="w-full bg-red-600 text-white py-3 rounded-lg font-semibold hover:bg-red-700">Logout</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tip Modal -->
    <div id="tipModal" class="fixed inset-0 bg-black z-50 hidden slide-up">
        <div class="p-4">
            <div class="flex items-center justify-between mb-6">
                <button id="closeTip" class="text-primary text-xl">←</button>
                <h2 class="text-lg font-bold text-primary">Support <span id="tipProfileName"></span></h2>
                <div></div>
            </div>

            <div class="text-center mb-6">
                <div id="qrContainer" class="bg-gray-900 p-4 rounded-lg mb-4">
                    <canvas id="qrCode" class="mx-auto"></canvas>
                </div>
                <p class="text-sm text-secondary">UPI se pay karein. Message add karein (optional).</p>
                <div id="upiDisplay" class="mt-2 hidden">
                    <p class="text-xs text-secondary">UPI ID: <span id="displayUpiId"></span></p>
                </div>
                <p class="text-xs text-secondary mt-2">💡 Message mein 'Pulsetree' automatically add ho jayega.</p>
            </div>

            <!-- Quick Amount Buttons -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-primary mb-2">Quick Amount</label>
                <div class="grid grid-cols-4 gap-2">
                    <button class="quick-amount bg-gray-800 hover:bg-gray-700 p-2 rounded text-sm text-primary" data-amount="50">₹50</button>
                    <button class="quick-amount bg-gray-800 hover:bg-gray-700 p-2 rounded text-sm text-primary" data-amount="100">₹100</button>
                    <button class="quick-amount bg-gray-800 hover:bg-gray-700 p-2 rounded text-sm text-primary" data-amount="200">₹200</button>
                    <button class="quick-amount bg-gray-800 hover:bg-gray-700 p-2 rounded text-sm text-primary" data-amount="500">₹500</button>
                </div>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-primary mb-2">Amount (₹)</label>
                    <input type="number" id="tipAmount" class="w-full p-3 bg-gray-800 border border-gray-600 rounded-lg text-primary" placeholder="100" min="1">
                </div>
                
                <!-- Quick Message Prompts -->
                <div>
                    <label class="block text-sm font-medium text-primary mb-2">Quick Messages</label>
                    <div class="grid grid-cols-1 gap-2 mb-3">
                        <button class="quick-message bg-gray-800 hover:bg-gray-700 p-2 rounded text-sm text-left border border-gray-600 text-primary" data-message="Great content! Any tips for beginners?">💡 Great content! Any tips for beginners?</button>
                        <button class="quick-message bg-gray-800 hover:bg-gray-700 p-2 rounded text-sm text-left border border-gray-600 text-primary" data-message="Koi latest video recommend karoge?">🎥 Koi latest video recommend karoge?</button>
                        <button class="quick-message bg-gray-800 hover:bg-gray-700 p-2 rounded text-sm text-left border border-gray-600 text-primary" data-message="Shukriya, keep it up!">🙏 Shukriya, keep it up!</button>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-primary mb-2">Your Message (Optional)</label>
                    <textarea id="tipMessage" class="w-full p-3 bg-gray-800 border border-gray-600 rounded-lg h-20 text-primary" placeholder="Type your own message..."></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-primary mb-2">Your Name (Optional)</label>
                    <input type="text" id="payerName" class="w-full p-3 bg-gray-800 border border-gray-600 rounded-lg text-primary" placeholder="Anonymous">
                </div>
            </div>

            <div class="mt-6 space-y-3">
                <button id="payButton" class="w-full pay-button text-white py-3 rounded-lg font-semibold">
                    📱 Open UPI App
                </button>
                <button id="recordTip" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors">
                    ✓ Maine Pay Kar Diya - Record Tip
                </button>
                <button id="askQuestion" class="w-full bg-gray-800 text-primary py-3 rounded-lg font-semibold hover:bg-gray-700 transition-colors">
                    ❓ Ask a Question (Free)
                </button>
            </div>
        </div>
    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Modal -->
    <div id="analyticsModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50">
        <div class="min-h-full flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800">📊 Analytics Dashboard</h2>
                        <button id="closeAnalytics" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>

                    <!-- Stats Overview -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 rounded-lg">
                            <div class="text-2xl font-bold" id="analyticsTotal">₹0</div>
                            <div class="text-sm opacity-80">Total Earned</div>
                        </div>
                        <div class="bg-gradient-to-r from-green-500 to-teal-600 text-white p-4 rounded-lg">
                            <div class="text-2xl font-bold" id="analyticsTipCount">0</div>
                            <div class="text-sm opacity-80">Total Tips</div>
                        </div>
                        <div class="bg-gradient-to-r from-orange-500 to-red-600 text-white p-4 rounded-lg">
                            <div class="text-2xl font-bold" id="analyticsWeekly">₹0</div>
                            <div class="text-sm opacity-80">Last 7 Days</div>
                        </div>
                        <div class="bg-gradient-to-r from-pink-500 to-purple-600 text-white p-4 rounded-lg">
                            <div class="text-2xl font-bold" id="analyticsAverage">₹0</div>
                            <div class="text-sm opacity-80">Average Tip</div>
                        </div>
                    </div>

                    <!-- Recent Tips List -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">Recent Tips</h3>
                        <div id="analyticsRecentTips" class="space-y-3 max-h-60 overflow-y-auto">
                            <!-- Tips will be loaded here -->
                        </div>
                    </div>

                    <!-- Export Options -->
                    <div class="space-y-3">
                        <button id="exportTips" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700">
                            📄 Export Tip History
                        </button>
                        <button id="emailNotifications" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700">
                            📧 Email Notifications: OFF
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Question Modal -->
    <div id="questionModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50">
        <div class="min-h-full flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl w-full max-w-md">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800">Ask <span id="questionProfileName"></span> a Question</h2>
                        <button id="closeQuestion" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Your Question *</label>
                            <textarea id="questionText" class="w-full p-3 border border-gray-300 rounded-lg h-24" placeholder="What would you like to ask?"></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Your Name (Optional)</label>
                            <input type="text" id="questionerName" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Anonymous">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                            <select id="questionCategory" class="w-full p-3 border border-gray-300 rounded-lg">
                                <option value="general">General Question</option>
                                <option value="advice">Advice/Tips</option>
                                <option value="collaboration">Collaboration</option>
                                <option value="feedback">Feedback</option>
                                <option value="technical">Technical Help</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>

                    <div class="mt-6">
                        <button id="submitQuestion" class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition-colors">
                            📤 Send Question
                        </button>
                        <p class="text-center text-gray-500 text-xs mt-2">Questions are free! Creator will be notified.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Message -->
    <div id="successMessage" class="fixed top-4 left-4 right-4 bg-green-500 text-white p-4 rounded-lg shadow-lg transform -translate-y-full transition-transform duration-300 z-50">
        <p class="text-center font-semibold">Thank you for your support! 🎉</p>
    </div>

    <!-- Notification Toast -->
    <div id="notificationToast" class="fixed top-4 right-4 bg-blue-500 text-white p-4 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50">
        <div class="flex items-center gap-2">
            <span class="text-xl">💝</span>
            <div>
                <p class="font-semibold">New Tip Received!</p>
                <p class="text-sm opacity-90" id="notificationText">Someone just supported you</p>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC30TcmMVhP_8HdFYS1WufRiZwSDYNMTF0",
            authDomain: "pulse2-92372.firebaseapp.com",
            databaseURL: "https://pulse2-92372-default-rtdb.firebaseio.com",
            projectId: "pulse2-92372",
            storageBucket: "pulse2-92372.firebasestorage.app",
            messagingSenderId: "276235725177",
            appId: "1:276235725177:web:0f4e0789fae80a435927a8"
        };

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const database = firebase.database();
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization error:', error);
            alert('Firebase connection failed. Please refresh the page.');
        }


        // Global variables
        let currentUser = null;
        let currentProfile = null;
        let currentTheme = 'purple';
        let tipStats = { total: 0, count: 0, weekly: 0, average: 0 };
        const profileId = 'demo-profile'; // In real app, this would come from URL

        // DOM Elements
        const elements = {
            profileImage: document.getElementById('profileImage'),
            profileName: document.getElementById('profileName'),
            profileBio: document.getElementById('profileBio'),
            socialLinks: document.getElementById('socialLinks'),
            tipButton: document.getElementById('tipButton'),
            settingsSection: document.getElementById('settingsSection'),
            settingsModal: document.getElementById('settingsModal'),
            tipModal: document.getElementById('tipModal'),
            analyticsModal: document.getElementById('analyticsModal'),
            successMessage: document.getElementById('successMessage'),
            notificationToast: document.getElementById('notificationToast')
        };

        // Quick message prompts
        const quickMessages = [
            "Great content! Any tips for beginners?",
            "Koi latest video recommend karoge?",
            "Kya tum merch bhejte ho?",
            "Kaunsa topic next chahiye tumhe?",
            "Shukriya, keep it up!",
            "Can you make a short tutorial on X?",
            "Kya tum one-on-one session karte ho?"
        ];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            
            // Check URL for profile routing first
            const urlParams = new URLSearchParams(window.location.search);
            const hashUsername = window.location.hash.substring(1);
            const pathUsername = window.location.pathname.split('/').pop();
            const username = urlParams.get('user') || hashUsername || pathUsername;
            
            // Handle redirect result first
            auth.getRedirectResult().then(result => {
                if (result.user) {
                    showSuccess('Google login successful! Welcome! 🎉');
                    checkAndCreateUserProfile(result.user);
                }
            }).catch(error => {
                console.error('Redirect result error:', error);
            });

            // Check auth state
            auth.onAuthStateChanged(user => {
                currentUser = user;
                updateAuthUI();
                
                if (username && username !== 'pulsetree.html' && username !== '' && username !== 'Pulsetree.html') {
                    // Load specific user profile (works without login)
                    loadUserProfile(username);
                    showProfileView();
                } else if (user) {
                    // User is logged in, show feed
                    updateNavProfileImage(user);
                    showDiscoveryView();
                    loadDiscoveryContent();
                    loadPosts();
                } else {
                    // User is not logged in, show login
                    showLoginScreen();
                }
            });
        });

        function setupEventListeners() {
            // Settings modal
            document.getElementById('settingsButton').addEventListener('click', () => {
                elements.settingsModal.classList.remove('hidden');
                loadSettingsData();
            });

            document.getElementById('closeSettings').addEventListener('click', () => {
                elements.settingsModal.classList.add('hidden');
            });

            // Analytics modal
            document.getElementById('analyticsButton').addEventListener('click', () => {
                elements.analyticsModal.classList.remove('hidden');
                loadAnalytics();
            });

            document.getElementById('closeAnalytics').addEventListener('click', () => {
                elements.analyticsModal.classList.add('hidden');
            });

            // Tip modal
            elements.tipButton.addEventListener('click', () => {
                if (currentProfile && currentProfile.upiId) {
                    elements.tipModal.classList.remove('hidden');
                    document.getElementById('tipProfileName').textContent = currentProfile.name || 'Creator';
                    updateUpiDisplay();
                    generateQRCode();
                } else {
                    alert('UPI not configured for tips yet!');
                }
            });

            document.getElementById('closeTip').addEventListener('click', () => {
                elements.tipModal.classList.add('hidden');
            });

            // Authentication event listeners
            document.getElementById('googleLoginBtn').addEventListener('click', signInWithGoogle);
            document.getElementById('googleSignupBtn').addEventListener('click', signInWithGoogle);
            document.getElementById('demoLoginBtn').addEventListener('click', demoLogin);
            document.getElementById('showSignupBtn').addEventListener('click', showSignupScreen);
            document.getElementById('showLoginBtn').addEventListener('click', showLoginScreen);

            // Navigation
            document.getElementById('searchToggleBtn').addEventListener('click', toggleSearch);
            document.getElementById('myProfileBtn').addEventListener('click', showMyProfile);
            document.getElementById('createPostBtn').addEventListener('click', openCreatePost);
            document.getElementById('backToFeed').addEventListener('click', () => showDiscoveryView());
            
            // Bottom navigation
            document.getElementById('homeNavBtn').addEventListener('click', () => showDiscoveryView());
            document.getElementById('searchNavBtn').addEventListener('click', toggleSearch);
            document.getElementById('createNavBtn').addEventListener('click', openCreatePost);
            document.getElementById('profileNavBtn').addEventListener('click', showMyProfile);
            
            // Create post functionality
            document.getElementById('closeCreatePost').addEventListener('click', closeCreatePost);
            document.getElementById('sharePost').addEventListener('click', sharePost);
            document.getElementById('closeSearch').addEventListener('click', closeSearch);
            
            // Post type selection
            document.querySelectorAll('.post-type-btn').forEach(btn => {
                btn.addEventListener('click', () => selectPostType(btn.dataset.type));
            });
            
            // Profile tabs
            document.getElementById('postsTab').addEventListener('click', () => switchProfileTab('posts'));
            document.getElementById('tipsTab').addEventListener('click', () => switchProfileTab('tips'));
            document.getElementById('linksTab').addEventListener('click', () => switchProfileTab('links'));
            
            // Image upload for posts
            document.getElementById('postImageUpload').addEventListener('change', handlePostImageUpload);
            
            // Tweet character count
            document.getElementById('tweetText').addEventListener('input', updateTweetCharCount);

            // Copy URL functionality
            document.getElementById('copyUrlButton').addEventListener('click', copyProfileUrl);

            // Save settings
            document.getElementById('saveSettings').addEventListener('click', saveProfile);

            // Add link functionality
            document.getElementById('addLink').addEventListener('click', addLinkInput);

            // Theme selection
            document.querySelectorAll('.theme-option').forEach(button => {
                button.addEventListener('click', () => selectTheme(button.dataset.theme));
            });

            // Quick amount buttons
            document.querySelectorAll('.quick-amount').forEach(button => {
                button.addEventListener('click', () => {
                    document.getElementById('tipAmount').value = button.dataset.amount;
                    generateQRCode();
                });
            });

            // Quick message buttons
            document.querySelectorAll('.quick-message').forEach(button => {
                button.addEventListener('click', () => {
                    document.getElementById('tipMessage').value = button.dataset.message;
                    generateQRCode();
                });
            });

            // QR Generator buttons
            document.getElementById('generateQrBtn').addEventListener('click', generateUPIQR);
            document.getElementById('openUpiBtn').addEventListener('click', openUPIFromQR);
            document.getElementById('downloadQrBtn').addEventListener('click', downloadQRCode);
            document.getElementById('shareQrBtn').addEventListener('click', shareQRCode);
            document.getElementById('createProfileBtn').addEventListener('click', showProfileCreation);

            // Auth buttons
            document.getElementById('googleSignInBtn').addEventListener('click', signInWithGoogle);
            document.getElementById('logoutButton').addEventListener('click', logout);

            // Tip functionality
            document.getElementById('payButton').addEventListener('click', openUPIApp);
            document.getElementById('recordTip').addEventListener('click', recordTip);
            
            // Question functionality
            document.getElementById('askQuestion').addEventListener('click', openQuestionModal);
            document.getElementById('closeQuestion').addEventListener('click', closeQuestionModal);
            document.getElementById('submitQuestion').addEventListener('click', submitQuestion);

            // Analytics functionality
            document.getElementById('exportTips').addEventListener('click', exportTipHistory);
            document.getElementById('emailNotifications').addEventListener('click', toggleEmailNotifications);

            // Image upload
            document.getElementById('imageUpload').addEventListener('change', handleImageUpload);

            // Amount input for QR update
            document.getElementById('tipAmount').addEventListener('input', generateQRCode);
            document.getElementById('tipMessage').addEventListener('input', generateQRCode);
        }

        function showLoginScreen() {
            hideAllViews();
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        function showSignupScreen() {
            hideAllViews();
            document.getElementById('signupScreen').classList.remove('hidden');
        }

        function showDiscoveryView() {
            hideAllViews();
            document.getElementById('discoveryView').classList.remove('hidden');
        }

        function showQRGeneratorView() {
            hideAllViews();
            document.getElementById('qrGeneratorView').classList.remove('hidden');
        }

        function showProfileView() {
            hideAllViews();
            document.getElementById('profileView').classList.remove('hidden');
        }

        function hideAllViews() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('signupScreen').classList.add('hidden');
            document.getElementById('discoveryView').classList.add('hidden');
            document.getElementById('qrGeneratorView').classList.add('hidden');
            document.getElementById('profileView').classList.add('hidden');
        }

        function showProfileCreation() {
            showProfileView();
            elements.settingsModal.classList.remove('hidden');
            loadSettingsData();
        }

        async function loadUserProfile(username) {
            try {
                const snapshot = await database.ref('profiles').orderByChild('username').equalTo(username).once('value');
                const profiles = snapshot.val();
                
                if (profiles) {
                    const profileKey = Object.keys(profiles)[0];
                    const profile = profiles[profileKey];
                    currentProfile = profile;
                    currentTheme = profile.theme || 'purple';
                    updateProfileUI(profile);
                    applyTheme(currentTheme);
                    loadTipStats();
                    loadRecentTips();
                } else {
                    // Profile not found
                    showQRGeneratorView();
                    showSuccess('Profile not found. Create your own profile!');
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
                showQRGeneratorView();
            }
        }

        async function loadProfile() {
            try {
                const snapshot = await database.ref(`profiles/${profileId}`).once('value');
                const profile = snapshot.val();
                
                if (profile) {
                    currentProfile = profile;
                    currentTheme = profile.theme || 'purple';
                    updateProfileUI(profile);
                    applyTheme(currentTheme);
                    loadTipStats();
                    loadRecentTips();
                } else {
                    // Default profile
                    currentProfile = {
                        name: 'Your Name',
                        bio: 'Add your bio here to tell people about yourself 🚀',
                        username: 'demo',
                        links: [],
                        upiId: '',
                        theme: 'purple',
                        privacy: {
                            showUpiPublic: false,
                            showTipCount: true,
                            showRecentTips: true,
                            hidePayerNames: false
                        }
                    };
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        function updateProfileUI(profile) {
            elements.profileName.textContent = profile.name || 'Your Name';
            elements.profileBio.textContent = profile.bio || 'Add your bio here';
            
            if (profile.imageUrl) {
                elements.profileImage.src = profile.imageUrl;
            }

            // Update profile URL
            if (profile.username) {
                document.getElementById('profileUrl').textContent = `pulse.oriontec.xyz/pulsetree.html/${profile.username}`;
                document.getElementById('profileUrlSection').classList.remove('hidden');
            }

            // Update social links
            elements.socialLinks.innerHTML = '';
            if (profile.links && profile.links.length > 0) {
                profile.links.forEach(link => {
                    const linkElement = createLinkElement(link.title, link.url);
                    elements.socialLinks.appendChild(linkElement);
                });
            }

            // Show/hide sections based on privacy settings
            if (currentUser && profile.userId === currentUser.uid) {
                elements.settingsSection.classList.remove('hidden');
                document.getElementById('analyticsSection').classList.remove('hidden');
                document.getElementById('recentTipsSection').classList.remove('hidden');
            }

            // Show social proof if enabled
            if (profile.privacy && profile.privacy.showRecentTips) {
                document.getElementById('socialProofSection').classList.remove('hidden');
            }
        }

        function applyTheme(theme) {
            const body = document.body;
            body.className = body.className.replace(/gradient-\w+/, `gradient-${theme}`);
            currentTheme = theme;
        }

        function selectTheme(theme) {
            applyTheme(theme);
            
            // Update theme selection UI
            document.querySelectorAll('.theme-option').forEach(btn => {
                btn.classList.remove('border-white');
            });
            document.querySelector(`[data-theme="${theme}"]`).classList.add('border-white');
        }

        function copyProfileUrl() {
            const url = document.getElementById('profileUrl').textContent;
            navigator.clipboard.writeText(`https://${url}`).then(() => {
                showSuccess('Profile URL copied to clipboard! 📋');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = `https://${url}`;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showSuccess('Profile URL copied to clipboard! 📋');
            });
        }

        function updateUpiDisplay() {
            const upiDisplay = document.getElementById('upiDisplay');
            const displayUpiId = document.getElementById('displayUpiId');
            
            if (currentProfile && currentProfile.upiId && currentProfile.privacy && currentProfile.privacy.showUpiPublic) {
                displayUpiId.textContent = currentProfile.upiId;
                upiDisplay.classList.remove('hidden');
            } else {
                upiDisplay.classList.add('hidden');
            }
        }

        function createLinkElement(title, url) {
            const linkDiv = document.createElement('div');
            linkDiv.className = 'glass-effect rounded-xl p-4 hover:bg-white/20 transition-all duration-300';
            
            linkDiv.innerHTML = `
                <a href="${url}" target="_blank" rel="noopener noreferrer" class="flex items-center justify-between text-white">
                    <span class="font-medium">${title}</span>
                    <span class="text-white/70">→</span>
                </a>
            `;
            
            return linkDiv;
        }

        function loadSettingsData() {
            if (currentProfile) {
                document.getElementById('usernameInput').value = currentProfile.username || '';
                document.getElementById('nameInput').value = currentProfile.name || '';
                document.getElementById('bioInput').value = currentProfile.bio || '';
                document.getElementById('upiInput').value = currentProfile.upiId || '';
                
                // Load privacy settings
                if (currentProfile.privacy) {
                    document.getElementById('showUpiPublic').checked = currentProfile.privacy.showUpiPublic || false;
                    document.getElementById('showTipCount').checked = currentProfile.privacy.showTipCount !== false;
                    document.getElementById('showRecentTips').checked = currentProfile.privacy.showRecentTips !== false;
                    document.getElementById('hidePayerNames').checked = currentProfile.privacy.hidePayerNames || false;
                }
                
                // Load theme
                selectTheme(currentProfile.theme || 'purple');
                
                // Load links
                const linkInputs = document.getElementById('linkInputs');
                linkInputs.innerHTML = '';
                
                if (currentProfile.links && currentProfile.links.length > 0) {
                    currentProfile.links.forEach(link => {
                        addLinkInput(link.title, link.url);
                    });
                } else {
                    addLinkInput();
                }
            }
        }

        async function loadTipStats() {
            try {
                const snapshot = await database.ref('tips').orderByChild('profileId').equalTo(profileId).once('value');
                const tips = snapshot.val();
                
                if (tips) {
                    const tipArray = Object.values(tips);
                    const now = Date.now();
                    const weekAgo = now - (7 * 24 * 60 * 60 * 1000);
                    
                    tipStats.count = tipArray.length;
                    tipStats.total = tipArray.reduce((sum, tip) => sum + (tip.amount || 0), 0);
                    tipStats.weekly = tipArray
                        .filter(tip => tip.createdAt > weekAgo)
                        .reduce((sum, tip) => sum + (tip.amount || 0), 0);
                    tipStats.average = tipStats.count > 0 ? Math.round(tipStats.total / tipStats.count) : 0;
                    
                    updateStatsUI();
                }
            } catch (error) {
                console.error('Error loading tip stats:', error);
            }
        }

        function updateStatsUI() {
            document.getElementById('totalTips').textContent = tipStats.count;
            document.getElementById('totalAmount').textContent = `₹${tipStats.total}`;
            
            // Update analytics modal
            document.getElementById('analyticsTotal').textContent = `₹${tipStats.total}`;
            document.getElementById('analyticsTipCount').textContent = tipStats.count;
            document.getElementById('analyticsWeekly').textContent = `₹${tipStats.weekly}`;
            document.getElementById('analyticsAverage').textContent = `₹${tipStats.average}`;
        }

        async function loadRecentTips() {
            try {
                const snapshot = await database.ref('tips')
                    .orderByChild('profileId')
                    .equalTo(profileId)
                    .limitToLast(10)
                    .once('value');
                
                const tips = snapshot.val();
                if (tips) {
                    const tipArray = Object.entries(tips)
                        .map(([key, tip]) => ({ ...tip, id: key }))
                        .reverse();
                    
                    updateRecentTipsUI(tipArray);
                }
            } catch (error) {
                console.error('Error loading recent tips:', error);
            }
        }

        function updateRecentTipsUI(tips) {
            const recentTipsList = document.getElementById('recentTipsList');
            const publicTipsList = document.getElementById('publicTipsList');
            
            recentTipsList.innerHTML = '';
            publicTipsList.innerHTML = '';
            
            tips.forEach(tip => {
                const tipElement = createTipElement(tip, false);
                recentTipsList.appendChild(tipElement);
                
                // Add to public list if privacy allows
                if (currentProfile.privacy && currentProfile.privacy.showRecentTips) {
                    const publicTipElement = createTipElement(tip, true);
                    publicTipsList.appendChild(publicTipElement);
                }
            });
        }

        function createTipElement(tip, isPublic = false) {
            const div = document.createElement('div');
            div.className = 'bg-white/10 rounded-lg p-3 text-sm';
            
            const hideNames = isPublic && currentProfile.privacy && currentProfile.privacy.hidePayerNames;
            const displayName = hideNames ? 'Anonymous' : (tip.payerName || 'Anonymous');
            const timeAgo = formatTimeAgo(tip.createdAt);
            
            div.innerHTML = `
                <div class="flex justify-between items-start mb-1">
                    <span class="font-medium text-white">${displayName}</span>
                    <span class="text-white/60 text-xs">₹${tip.amount}</span>
                </div>
                <p class="text-white/80 text-xs mb-1">${tip.payerMessage || 'No message'}</p>
                <span class="text-white/50 text-xs">${timeAgo}</span>
            `;
            
            return div;
        }

        function formatTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (days > 0) return `${days}d ago`;
            if (hours > 0) return `${hours}h ago`;
            if (minutes > 0) return `${minutes}m ago`;
            return 'Just now';
        }

        async function loadAnalytics() {
            await loadTipStats();
            
            // Load detailed tip history for analytics
            try {
                const snapshot = await database.ref('tips')
                    .orderByChild('profileId')
                    .equalTo(profileId)
                    .limitToLast(50)
                    .once('value');
                
                const tips = snapshot.val();
                if (tips) {
                    const tipArray = Object.entries(tips)
                        .map(([key, tip]) => ({ ...tip, id: key }))
                        .reverse();
                    
                    const analyticsContainer = document.getElementById('analyticsRecentTips');
                    analyticsContainer.innerHTML = '';
                    
                    tipArray.forEach(tip => {
                        const tipElement = createAnalyticsTipElement(tip);
                        analyticsContainer.appendChild(tipElement);
                    });
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        function createAnalyticsTipElement(tip) {
            const div = document.createElement('div');
            div.className = 'bg-gray-50 rounded-lg p-3 border';
            
            const date = new Date(tip.createdAt).toLocaleDateString();
            const time = new Date(tip.createdAt).toLocaleTimeString();
            
            div.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <span class="font-medium text-gray-800">${tip.payerName || 'Anonymous'}</span>
                        <span class="text-green-600 font-bold ml-2">₹${tip.amount}</span>
                    </div>
                    <span class="text-gray-500 text-xs">${date} ${time}</span>
                </div>
                <p class="text-gray-600 text-sm">${tip.payerMessage || 'No message'}</p>
            `;
            
            return div;
        }

        function addLinkInput(title = '', url = '') {
            const linkInputs = document.getElementById('linkInputs');
            const linkDiv = document.createElement('div');
            linkDiv.className = 'flex gap-2';
            
            linkDiv.innerHTML = `
                <input type="text" placeholder="Link Title" value="${title}" class="flex-1 p-2 border border-gray-300 rounded-lg link-title">
                <input type="url" placeholder="https://..." value="${url}" class="flex-1 p-2 border border-gray-300 rounded-lg link-url">
                <button class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 remove-link">×</button>
            `;
            
            linkDiv.querySelector('.remove-link').addEventListener('click', () => {
                linkDiv.remove();
            });
            
            linkInputs.appendChild(linkDiv);
        }

        async function saveProfile() {
            if (!currentUser) {
                alert('Please login to save your profile');
                return;
            }

            try {
                const username = document.getElementById('usernameInput').value.trim();
                const name = document.getElementById('nameInput').value;
                const bio = document.getElementById('bioInput').value;
                const upiId = document.getElementById('upiInput').value;
                
                // Collect links
                const linkElements = document.querySelectorAll('#linkInputs > div');
                const links = [];
                
                linkElements.forEach(linkDiv => {
                    const title = linkDiv.querySelector('.link-title').value.trim();
                    const url = linkDiv.querySelector('.link-url').value.trim();
                    
                    if (title && url) {
                        links.push({ title, url });
                    }
                });

                // Collect privacy settings
                const privacy = {
                    showUpiPublic: document.getElementById('showUpiPublic').checked,
                    showTipCount: document.getElementById('showTipCount').checked,
                    showRecentTips: document.getElementById('showRecentTips').checked,
                    hidePayerNames: document.getElementById('hidePayerNames').checked
                };

                const category = document.getElementById('categorySelect')?.value || '';
                
                const profileData = {
                    username: username || generateUsername(currentUser.displayName || currentUser.email),
                    name: name || currentUser.displayName || 'New Creator',
                    bio: bio || 'Welcome to my Pulsetree profile! 🚀',
                    email: currentUser.email,
                    upiId,
                    links,
                    theme: currentTheme,
                    category,
                    privacy,
                    userId: currentUser.uid,
                    createdAt: currentProfile?.createdAt || firebase.database.ServerValue.TIMESTAMP,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                };

                if (currentProfile?.imageUrl) {
                    profileData.imageUrl = currentProfile.imageUrl;
                }

                // Save profile using user ID as key
                await database.ref(`profiles/${currentUser.uid}`).set(profileData);
                currentProfile = profileData;
                updateProfileUI(profileData);
                
                elements.settingsModal.classList.add('hidden');
                showSuccess('Profile saved successfully! 🎉');
                
            } catch (error) {
                console.error('Error saving profile:', error);
                alert('Error saving profile. Please try again.');
            }
        }

        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file || !currentUser) return;

            try {
                const storageRef = storage.ref(`profile-images/${currentUser.uid}/${Date.now()}`);
                const snapshot = await storageRef.put(file);
                const downloadURL = await snapshot.ref.getDownloadURL();
                
                currentProfile.imageUrl = downloadURL;
                elements.profileImage.src = downloadURL;
                
            } catch (error) {
                console.error('Error uploading image:', error);
                alert('Error uploading image. Please try again.');
            }
        }

        async function signInWithGoogle() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');
                
                // Try popup first, fallback to redirect
                let result;
                try {
                    result = await auth.signInWithPopup(provider);
                } catch (popupError) {
                    console.log('Popup blocked, trying redirect...');
                    await auth.signInWithRedirect(provider);
                    return; // Redirect will handle the rest
                }
                
                const user = result.user;
                
                if (user) {
                    showSuccess('Google login successful! Welcome! 🎉');
                    
                    // Check if user has a profile, if not create one
                    await checkAndCreateUserProfile(user);
                    
                    // Navigate to appropriate view
                    showDiscoveryView();
                    loadDiscoveryContent();
                    loadPosts();
                }
            } catch (error) {
                console.error('Google Sign-In error:', error);
                if (error.code === 'auth/popup-closed-by-user') {
                    return;
                }
                if (error.code === 'auth/popup-blocked') {
                    alert('Popup blocked! Please allow popups for this site or try again.');
                    return;
                }
                alert('Login failed: ' + error.message);
            }
        }



        async function checkAndCreateUserProfile(user) {
            try {
                // Check if user already has a profile
                const snapshot = await database.ref('profiles').orderByChild('userId').equalTo(user.uid).once('value');
                const existingProfiles = snapshot.val();
                
                if (!existingProfiles) {
                    // Create default profile for new user
                    const username = generateUsername(user.displayName || user.email);
                    const profileData = {
                        userId: user.uid,
                        username: username,
                        name: user.displayName || 'New Creator',
                        bio: 'Welcome to my Pulsetree profile! 🚀',
                        email: user.email,
                        imageUrl: user.photoURL || '',
                        links: [],
                        upiId: '',
                        theme: 'purple',
                        category: '',
                        privacy: {
                            showUpiPublic: false,
                            showTipCount: true,
                            showRecentTips: true,
                            hidePayerNames: false
                        },
                        createdAt: firebase.database.ServerValue.TIMESTAMP,
                        updatedAt: firebase.database.ServerValue.TIMESTAMP
                    };
                    
                    // Save profile with user ID as key
                    await database.ref(`profiles/${user.uid}`).set(profileData);
                    currentProfile = profileData;
                }
            } catch (error) {
                console.error('Error creating user profile:', error);
            }
        }

        function generateUsername(displayName) {
            // Generate username from display name or email
            let username = (displayName || 'user').toLowerCase()
                .replace(/[^a-z0-9]/g, '')
                .substring(0, 15);
            
            // Add random number to make it unique
            username += Math.floor(Math.random() * 1000);
            
            return username;
        }

        function demoLogin() {
            // Create a demo user object
            const demoUser = {
                uid: 'demo-user-' + Date.now(),
                displayName: 'Demo User',
                email: 'demo@pulsetree.com',
                photoURL: 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'50\' fill=\'%23667eea\'/%3E%3Ctext x=\'50\' y=\'55\' text-anchor=\'middle\' fill=\'white\' font-size=\'30\' font-weight=\'bold\'%3ED%3C/text%3E%3C/svg%3E'
            };

            // Set as current user
            currentUser = demoUser;
            
            // Create demo profile
            currentProfile = {
                userId: demoUser.uid,
                username: 'demouser',
                name: 'Demo User',
                bio: 'This is a demo account to explore Pulsetree features! 🚀',
                email: demoUser.email,
                imageUrl: demoUser.photoURL,
                links: [
                    { title: '🌐 Website', url: 'https://pulsetree.com' },
                    { title: '📱 Instagram', url: 'https://instagram.com/pulsetree' }
                ],
                upiId: 'demo@paytm',
                theme: 'purple',
                category: 'tech',
                privacy: {
                    showUpiPublic: true,
                    showTipCount: true,
                    showRecentTips: true,
                    hidePayerNames: false
                },
                createdAt: Date.now(),
                updatedAt: Date.now()
            };

            showSuccess('Demo mode activated! Explore all features! 🎉');
            updateAuthUI();
            updateNavProfileImage(demoUser);
            showDiscoveryView();
            loadDemoContent();
        }

        async function logout() {
            try {
                if (currentUser && currentUser.uid.startsWith('demo-user')) {
                    // Demo logout
                    currentUser = null;
                    currentProfile = null;
                    elements.settingsSection.classList.add('hidden');
                    showSuccess('Demo session ended!');
                    showLoginScreen();
                } else {
                    await auth.signOut();
                    elements.settingsSection.classList.add('hidden');
                    showSuccess('Logged out successfully!');
                    showLoginScreen();
                }
            } catch (error) {
                alert('Logout failed: ' + error.message);
            }
        }

        function loadDemoContent() {
            // Load demo posts
            const demoPosts = [
                {
                    id: 'demo1',
                    userId: 'creator1',
                    username: 'techguru',
                    userName: 'Tech Guru',
                    userImage: 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'50\' fill=\'%2300d4aa\'/%3E%3Ctext x=\'50\' y=\'55\' text-anchor=\'middle\' fill=\'white\' font-size=\'30\' font-weight=\'bold\'%3ET%3C/text%3E%3C/svg%3E',
                    type: 'text',
                    content: 'Just launched my new coding tutorial series! 🚀 Perfect for beginners who want to learn web development.',
                    createdAt: Date.now() - 3600000,
                    likes: 24,
                    comments: 5
                },
                {
                    id: 'demo2',
                    userId: 'creator2',
                    username: 'artlover',
                    userName: 'Art Lover',
                    userImage: 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'50\' fill=\'%23ff6b6b\'/%3E%3Ctext x=\'50\' y=\'55\' text-anchor=\'middle\' fill=\'white\' font-size=\'30\' font-weight=\'bold\'%3EA%3C/text%3E%3C/svg%3E',
                    type: 'tweet',
                    content: 'Creating art is not just about the final piece, it\'s about the journey of self-discovery. Every stroke tells a story! 🎨✨',
                    createdAt: Date.now() - 7200000,
                    likes: 18,
                    comments: 3
                },
                {
                    id: 'demo3',
                    userId: 'creator3',
                    username: 'fitnessmotivator',
                    userName: 'Fitness Motivator',
                    userImage: 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'50\' fill=\'%23ffa726\'/%3E%3Ctext x=\'50\' y=\'55\' text-anchor=\'middle\' fill=\'white\' font-size=\'30\' font-weight=\'bold\'%3EF%3C/text%3E%3C/svg%3E',
                    type: 'text',
                    content: 'Morning workout complete! 💪 Remember: consistency beats perfection. Small steps every day lead to big changes!',
                    createdAt: Date.now() - 10800000,
                    likes: 31,
                    comments: 8
                }
            ];

            displayPosts(demoPosts);

            // Load demo creators
            const demoCreators = [
                {
                    id: 'creator1',
                    username: 'techguru',
                    name: 'Tech Guru',
                    bio: 'Full-stack developer sharing coding tips and tutorials 💻',
                    category: 'tech',
                    imageUrl: 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'50\' fill=\'%2300d4aa\'/%3E%3Ctext x=\'50\' y=\'55\' text-anchor=\'middle\' fill=\'white\' font-size=\'30\' font-weight=\'bold\'%3ET%3C/text%3E%3C/svg%3E',
                    tipCount: 47,
                    createdAt: Date.now() - 86400000
                },
                {
                    id: 'creator2',
                    username: 'artlover',
                    name: 'Art Lover',
                    bio: 'Digital artist creating beautiful illustrations 🎨',
                    category: 'art',
                    imageUrl: 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'50\' fill=\'%23ff6b6b\'/%3E%3Ctext x=\'50\' y=\'55\' text-anchor=\'middle\' fill=\'white\' font-size=\'30\' font-weight=\'bold\'%3EA%3C/text%3E%3C/svg%3E',
                    tipCount: 23,
                    createdAt: Date.now() - 172800000
                },
                {
                    id: 'creator3',
                    username: 'fitnessmotivator',
                    name: 'Fitness Motivator',
                    bio: 'Personal trainer helping you achieve your fitness goals 💪',
                    category: 'fitness',
                    imageUrl: 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'50\' fill=\'%23ffa726\'/%3E%3Ctext x=\'50\' y=\'55\' text-anchor=\'middle\' fill=\'white\' font-size=\'30\' font-weight=\'bold\'%3EF%3C/text%3E%3C/svg%3E',
                    tipCount: 35,
                    createdAt: Date.now() - 259200000
                }
            ];

            displayCreators('featuredCreators', demoCreators.slice(0, 2));
            displayCreators('newCreators', demoCreators.slice(1));
            displayCreators('allCreators', demoCreators);
            setupSearch(demoCreators);
        }

        function updateNavProfileImage(user) {
            const navImage = document.getElementById('navProfileImage');
            if (user && user.photoURL) {
                navImage.src = user.photoURL;
            }
        }

        function toggleSearch() {
            const searchOverlay = document.getElementById('searchOverlay');
            searchOverlay.classList.toggle('hidden');
            
            if (!searchOverlay.classList.contains('hidden')) {
                document.getElementById('searchInput').focus();
            }
        }
        
        function closeSearch() {
            document.getElementById('searchOverlay').classList.add('hidden');
        }
        
        function openCreatePost() {
            document.getElementById('createPostModal').classList.remove('hidden');
        }
        
        function closeCreatePost() {
            document.getElementById('createPostModal').classList.add('hidden');
            // Reset form
            document.getElementById('postText').value = '';
            document.getElementById('imageCaption').value = '';
            document.getElementById('tweetText').value = '';
            document.getElementById('imagePreview').classList.add('hidden');
        }
        
        function selectPostType(type) {
            // Hide all sections
            document.getElementById('textPostSection').classList.add('hidden');
            document.getElementById('imagePostSection').classList.add('hidden');
            document.getElementById('tweetPostSection').classList.add('hidden');
            
            // Show selected section
            document.getElementById(`${type}PostSection`).classList.remove('hidden');
            
            // Update button styles
            document.querySelectorAll('.post-type-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600');
                btn.classList.add('bg-gray-800');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('bg-blue-600');
        }
        
        function handlePostImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Image size should be less than 5MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('imagePreview').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }
        
        function updateTweetCharCount() {
            const text = document.getElementById('tweetText').value;
            document.getElementById('tweetCharCount').textContent = text.length;
        }
        
        async function sharePost() {
            if (!currentUser) {
                alert('Please login to create posts');
                return;
            }
            
            const activeType = document.querySelector('.post-type-btn.bg-blue-600')?.dataset.type || 'text';
            let postData = {
                userId: currentUser.uid,
                username: currentProfile?.username || 'user',
                userImage: currentUser.photoURL || '',
                userName: currentUser.displayName || 'User',
                type: activeType,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                likes: 0,
                comments: 0
            };
            
            try {
                switch (activeType) {
                    case 'text':
                        const textContent = document.getElementById('postText').value.trim();
                        if (!textContent) {
                            alert('Please enter some text');
                            return;
                        }
                        postData.content = textContent;
                        break;
                        
                    case 'image':
                        const imageFile = document.getElementById('postImageUpload').files[0];
                        const caption = document.getElementById('imageCaption').value.trim();
                        if (!imageFile) {
                            alert('Please select an image');
                            return;
                        }
                        
                        // Convert to base64
                        const reader = new FileReader();
                        reader.onload = async function(e) {
                            postData.imageUrl = e.target.result;
                            postData.caption = caption;
                            await database.ref('posts').push(postData);
                            closeCreatePost();
                            showSuccess('Post shared successfully! 🎉');
                            loadPosts();
                        };
                        reader.readAsDataURL(imageFile);
                        return;
                        
                    case 'tweet':
                        const tweetContent = document.getElementById('tweetText').value.trim();
                        if (!tweetContent) {
                            alert('Please enter tweet text');
                            return;
                        }
                        postData.content = tweetContent;
                        break;
                }
                
                await database.ref('posts').push(postData);
                closeCreatePost();
                showSuccess('Post shared successfully! 🎉');
                loadPosts();
                
            } catch (error) {
                console.error('Error sharing post:', error);
                alert('Error sharing post. Please try again.');
            }
        }
        
        function switchProfileTab(tab) {
            // Update tab styles
            document.querySelectorAll('#postsTab, #tipsTab, #linksTab').forEach(t => {
                t.classList.remove('text-primary', 'border-primary');
                t.classList.add('text-secondary');
            });
            
            document.getElementById(`${tab}Tab`).classList.add('text-primary', 'border-b-2', 'border-primary');
            document.getElementById(`${tab}Tab`).classList.remove('text-secondary');
            
            // Show/hide content
            document.getElementById('profilePosts').classList.add('hidden');
            document.getElementById('profileTips').classList.add('hidden');
            document.getElementById('profileLinks').classList.add('hidden');
            
            document.getElementById(`profile${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.remove('hidden');
        }
        
        async function loadPosts() {
            try {
                const snapshot = await database.ref('posts').orderByChild('createdAt').limitToLast(50).once('value');
                const posts = snapshot.val();
                
                if (posts) {
                    const postsArray = Object.entries(posts)
                        .map(([key, post]) => ({ ...post, id: key }))
                        .reverse();
                    
                    displayPosts(postsArray);
                }
            } catch (error) {
                console.error('Error loading posts:', error);
            }
        }
        
        function displayPosts(posts) {
            const container = document.getElementById('postsContainer');
            container.innerHTML = '';
            
            posts.forEach(post => {
                const postElement = createPostElement(post);
                container.appendChild(postElement);
            });
        }
        
        function createPostElement(post) {
            const div = document.createElement('div');
            div.className = 'post-card p-4';
            
            const timeAgo = formatTimeAgo(post.createdAt);
            
            let contentHTML = '';
            switch (post.type) {
                case 'text':
                    contentHTML = `<p class="text-primary mb-3">${post.content}</p>`;
                    break;
                case 'image':
                    contentHTML = `
                        <img src="${post.imageUrl}" alt="Post image" class="w-full post-image rounded-lg mb-3">
                        ${post.caption ? `<p class="text-primary mb-3">${post.caption}</p>` : ''}
                    `;
                    break;
                case 'tweet':
                    contentHTML = `
                        <div class="bg-gray-900 p-3 rounded-lg mb-3 border-l-4 border-blue-500">
                            <p class="text-primary">${post.content}</p>
                        </div>
                    `;
                    break;
            }
            
            div.innerHTML = `
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-8 h-8 rounded-full overflow-hidden">
                        <img src="${post.userImage || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'50\' fill=\'%23333\'/%3E%3Cpath d=\'M50 45c5.5 0 10-4.5 10-10s-4.5-10-10-10-10 4.5-10 10 4.5 10 10 10zm0 5c-6.7 0-20 3.3-20 10v5h40v-5c0-6.7-13.3-10-20-10z\' fill=\'%23666\'/%3E%3C/svg%3E'}" alt="${post.userName}" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center gap-2">
                            <span class="font-semibold text-primary">${post.userName}</span>
                            <span class="text-secondary text-sm">@${post.username}</span>
                        </div>
                        <span class="text-secondary text-xs">${timeAgo}</span>
                    </div>
                    <button class="text-secondary">⋯</button>
                </div>
                
                ${contentHTML}
                
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <button class="like-btn flex items-center gap-1 text-secondary hover:text-red-500" data-post-id="${post.id}">
                            <span class="text-xl">♡</span>
                            <span class="text-sm">${post.likes || 0}</span>
                        </button>
                        <button class="flex items-center gap-1 text-secondary">
                            <span class="text-xl">💬</span>
                            <span class="text-sm">${post.comments || 0}</span>
                        </button>
                        <button class="text-secondary text-xl">📤</button>
                    </div>
                    <button class="tip-post-btn pay-button text-white px-3 py-1 rounded-full text-sm" data-username="${post.username}">
                        💝 Tip
                    </button>
                </div>
            `;
            
            // Add event listeners
            div.querySelector('.like-btn').addEventListener('click', () => likePost(post.id));
            div.querySelector('.tip-post-btn').addEventListener('click', () => openTipForUser(post.username));
            
            return div;
        }
        
        async function likePost(postId) {
            if (!currentUser) {
                alert('Please login to like posts');
                return;
            }
            
            try {
                const postRef = database.ref(`posts/${postId}`);
                const snapshot = await postRef.once('value');
                const post = snapshot.val();
                
                if (post) {
                    const newLikes = (post.likes || 0) + 1;
                    await postRef.update({ likes: newLikes });
                    
                    // Update UI
                    const likeBtn = document.querySelector(`[data-post-id="${postId}"]`);
                    if (likeBtn) {
                        likeBtn.innerHTML = `<span class="text-xl">❤️</span><span class="text-sm">${newLikes}</span>`;
                        likeBtn.classList.add('heart-animation');
                        likeBtn.classList.remove('text-secondary');
                        likeBtn.classList.add('text-red-500');
                    }
                }
            } catch (error) {
                console.error('Error liking post:', error);
            }
        }
        
        async function openTipForUser(username) {
            try {
                const snapshot = await database.ref('profiles').orderByChild('username').equalTo(username).once('value');
                const profiles = snapshot.val();
                
                if (profiles) {
                    const profileKey = Object.keys(profiles)[0];
                    const profile = profiles[profileKey];
                    
                    if (profile.upiId) {
                        currentProfile = profile;
                        document.getElementById('tipModal').classList.remove('hidden');
                        document.getElementById('tipProfileName').textContent = profile.name || username;
                        updateUpiDisplay();
                        generateQRCode();
                    } else {
                        alert('This user has not set up UPI for tips yet');
                    }
                } else {
                    alert('User profile not found');
                }
            } catch (error) {
                console.error('Error loading user for tip:', error);
                alert('Error loading user profile');
            }
        }

        async function showMyProfile() {
            if (currentUser) {
                try {
                    const snapshot = await database.ref(`profiles/${currentUser.uid}`).once('value');
                    const profile = snapshot.val();
                    
                    if (profile) {
                        currentProfile = profile;
                        updateProfileUI(profile);
                        showProfileView();
                        elements.settingsSection.classList.remove('hidden');
                    } else {
                        // Create profile if doesn't exist
                        await checkAndCreateUserProfile(currentUser);
                        showMyProfile(); // Retry
                    }
                } catch (error) {
                    console.error('Error loading user profile:', error);
                    alert('Error loading your profile');
                }
            }
        }

        async function loadDiscoveryContent() {
            try {
                // Load all profiles for discovery
                const snapshot = await database.ref('profiles').limitToLast(50).once('value');
                const profiles = snapshot.val();
                
                if (profiles) {
                    const profileArray = Object.entries(profiles)
                        .map(([key, profile]) => ({ ...profile, id: key }))
                        .filter(profile => profile.userId !== currentUser?.uid); // Exclude current user
                    
                    // Sort by creation date
                    profileArray.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                    
                    // Featured creators (first 3)
                    const featured = profileArray.slice(0, 3);
                    displayCreators('featuredCreators', featured);
                    
                    // New creators (next 5)
                    const newCreators = profileArray.slice(3, 8);
                    displayCreators('newCreators', newCreators);
                    
                    // All creators
                    displayCreators('allCreators', profileArray);
                    
                    // Setup search functionality
                    setupSearch(profileArray);
                }
            } catch (error) {
                console.error('Error loading discovery content:', error);
            }
        }

        function displayCreators(containerId, creators) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            creators.forEach(creator => {
                const creatorCard = createCreatorCard(creator);
                container.appendChild(creatorCard);
            });
        }

        function createCreatorCard(creator) {
            const div = document.createElement('div');
            div.className = 'glass-effect rounded-xl p-4 hover:bg-white/20 transition-all duration-300 cursor-pointer';
            
            const categoryEmoji = getCategoryEmoji(creator.category);
            const tipCount = creator.tipCount || 0;
            
            div.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full overflow-hidden border-2 border-white/30 flex-shrink-0">
                        <img src="${creator.imageUrl || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'50\' fill=\'%23e5e7eb\'/%3E%3Cpath d=\'M50 45c5.5 0 10-4.5 10-10s-4.5-10-10-10-10 4.5-10 10 4.5 10 10 10zm0 5c-6.7 0-20 3.3-20 10v5h40v-5c0-6.7-13.3-10-20-10z\' fill=\'%239ca3af\'/%3E%3C/svg%3E'}" alt="${creator.name}" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <h3 class="font-semibold text-white truncate">${creator.name}</h3>
                            ${categoryEmoji ? `<span class="text-sm">${categoryEmoji}</span>` : ''}
                        </div>
                        <p class="text-white/70 text-sm truncate mb-1">@${creator.username}</p>
                        <p class="text-white/60 text-xs line-clamp-2">${creator.bio || 'No bio available'}</p>
                    </div>
                    <div class="text-right">
                        <div class="text-white/60 text-xs">💝 ${tipCount}</div>
                        <div class="text-white/40 text-xs">tips</div>
                    </div>
                </div>
            `;
            
            div.addEventListener('click', () => {
                loadCreatorProfile(creator);
            });
            
            return div;
        }

        function getCategoryEmoji(category) {
            const categories = {
                'tech': '💻',
                'art': '🎨',
                'music': '🎵',
                'fitness': '💪',
                'food': '🍳',
                'travel': '✈️',
                'education': '📚',
                'gaming': '🎮'
            };
            return categories[category] || '';
        }

        async function loadCreatorProfile(creator) {
            currentProfile = creator;
            updateProfileUI(creator);
            showProfileView();
            
            // Hide settings section for other users' profiles
            if (creator.userId !== currentUser?.uid) {
                elements.settingsSection.classList.add('hidden');
            } else {
                elements.settingsSection.classList.remove('hidden');
            }
            
            // Load tip stats for this profile
            await loadTipStatsForProfile(creator.id);
            await loadRecentTipsForProfile(creator.id);
        }

        async function loadTipStatsForProfile(profileId) {
            try {
                const snapshot = await database.ref('tips').orderByChild('profileId').equalTo(profileId).once('value');
                const tips = snapshot.val();
                
                if (tips) {
                    const tipArray = Object.values(tips);
                    const now = Date.now();
                    const weekAgo = now - (7 * 24 * 60 * 60 * 1000);
                    
                    tipStats.count = tipArray.length;
                    tipStats.total = tipArray.reduce((sum, tip) => sum + (tip.amount || 0), 0);
                    tipStats.weekly = tipArray
                        .filter(tip => tip.createdAt > weekAgo)
                        .reduce((sum, tip) => sum + (tip.amount || 0), 0);
                    tipStats.average = tipStats.count > 0 ? Math.round(tipStats.total / tipStats.count) : 0;
                    
                    updateStatsUI();
                }
            } catch (error) {
                console.error('Error loading tip stats:', error);
            }
        }

        async function loadRecentTipsForProfile(profileId) {
            try {
                const snapshot = await database.ref('tips')
                    .orderByChild('profileId')
                    .equalTo(profileId)
                    .limitToLast(10)
                    .once('value');
                
                const tips = snapshot.val();
                if (tips) {
                    const tipArray = Object.entries(tips)
                        .map(([key, tip]) => ({ ...tip, id: key }))
                        .reverse();
                    
                    updateRecentTipsUI(tipArray);
                }
            } catch (error) {
                console.error('Error loading recent tips:', error);
            }
        }

        function setupSearch(allCreators) {
            const searchInput = document.getElementById('searchInput');
            const categoryFilters = document.querySelectorAll('.category-filter');
            
            let currentFilter = '';
            
            // Search input handler
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                filterAndDisplayCreators(allCreators, query, currentFilter);
            });
            
            // Category filter handlers
            categoryFilters.forEach(filter => {
                filter.addEventListener('click', () => {
                    // Update active filter
                    categoryFilters.forEach(f => f.classList.remove('bg-white/40'));
                    filter.classList.add('bg-white/40');
                    
                    currentFilter = filter.dataset.category;
                    const query = searchInput.value.toLowerCase();
                    filterAndDisplayCreators(allCreators, query, currentFilter);
                });
            });
        }

        function filterAndDisplayCreators(creators, query, category) {
            let filtered = creators;
            
            // Filter by category
            if (category) {
                filtered = filtered.filter(creator => creator.category === category);
            }
            
            // Filter by search query
            if (query) {
                filtered = filtered.filter(creator => 
                    creator.name.toLowerCase().includes(query) ||
                    creator.username.toLowerCase().includes(query) ||
                    (creator.bio && creator.bio.toLowerCase().includes(query))
                );
            }
            
            // Display filtered results
            displayCreators('allCreators', filtered);
            
            // Hide other sections when searching/filtering
            if (query || category) {
                document.querySelector('#featuredCreators').parentElement.classList.add('hidden');
                document.querySelector('#newCreators').parentElement.classList.add('hidden');
            } else {
                document.querySelector('#featuredCreators').parentElement.classList.remove('hidden');
                document.querySelector('#newCreators').parentElement.classList.remove('hidden');
            }
        }

        function updateAuthUI() {
            const loginForm = document.getElementById('loginForm');
            const loggedInSection = document.getElementById('loggedInSection');
            const userEmail = document.getElementById('userEmail');
            
            if (currentUser) {
                loginForm.classList.add('hidden');
                loggedInSection.classList.remove('hidden');
                userEmail.textContent = currentUser.email;
            } else {
                loginForm.classList.remove('hidden');
                loggedInSection.classList.add('hidden');
            }
        }

        function generateQRCode() {
            if (!currentProfile || !currentProfile.upiId) return;
            
            const amount = document.getElementById('tipAmount').value || '';
            const message = document.getElementById('tipMessage').value || 'Support via Pulsetree';
            const name = currentProfile.name || 'Creator';
            
            let upiString = `upi://pay?pa=${currentProfile.upiId}&pn=${encodeURIComponent(name)}&tn=${encodeURIComponent(message + ' - Pulsetree')}&cu=INR`;
            
            if (amount) {
                upiString += `&am=${amount}`;
            }
            
            const canvas = document.getElementById('qrCode');
            QRCode.toCanvas(canvas, upiString, {
                width: 200,
                margin: 2,
                color: {
                    dark: '#000000',
                    light: '#FFFFFF'
                }
            }, function (error) {
                if (error) console.error('QR Code generation error:', error);
            });
        }

        function openUPIApp() {
            if (!currentProfile || !currentProfile.upiId) return;
            
            const amount = document.getElementById('tipAmount').value || '';
            const message = document.getElementById('tipMessage').value || 'Support via Pulsetree';
            const name = currentProfile.name || 'Creator';
            
            let upiString = `upi://pay?pa=${currentProfile.upiId}&pn=${encodeURIComponent(name)}&tn=${encodeURIComponent(message + ' - Pulsetree')}&cu=INR`;
            
            if (amount) {
                upiString += `&am=${amount}`;
            }
            
            // Try to open UPI app
            window.open(upiString, '_blank');
        }

        // Message moderation - block inappropriate content
        function moderateMessage(message) {
            const blockedWords = [
                'spam', 'scam', 'fake', 'fraud', 'cheat', 'hack', 'illegal',
                'drugs', 'violence', 'hate', 'abuse', 'harassment'
            ];
            
            const lowerMessage = message.toLowerCase();
            for (const word of blockedWords) {
                if (lowerMessage.includes(word)) {
                    return false;
                }
            }
            return true;
        }

        // Sanitize input to prevent XSS
        function sanitizeInput(input) {
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        }

        async function recordTip() {
            const amount = document.getElementById('tipAmount').value;
            const message = document.getElementById('tipMessage').value || '';
            const payerName = document.getElementById('payerName').value || 'Anonymous';
            
            if (!amount) {
                alert('Please enter an amount');
                return;
            }

            if (parseFloat(amount) < 1 || parseFloat(amount) > 50000) {
                alert('Amount should be between ₹1 and ₹50,000');
                return;
            }

            // Moderate message content
            if (message && !moderateMessage(message)) {
                alert('Message contains inappropriate content. Please modify your message.');
                return;
            }
            
            try {
                // Sanitize inputs
                const sanitizedMessage = sanitizeInput(message);
                const sanitizedName = sanitizeInput(payerName);
                
                const tipData = {
                    amount: parseFloat(amount),
                    payerName: sanitizedName.substring(0, 50), // Limit name length
                    payerMessage: (sanitizedMessage + (sanitizedMessage ? ' - ' : '') + 'Pulsetree').substring(0, 200), // Limit message length
                    profileId: profileId,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    status: 'recorded',
                    ipHash: btoa(Math.random().toString()).substring(0, 10) // Simple rate limiting identifier
                };
                
                await database.ref('tips').push(tipData);
                
                elements.tipModal.classList.add('hidden');
                showSuccess('Dhanyawad! Aapka support record ho gaya! 🎉');
                
                // Show notification to profile owner
                if (currentUser && currentProfile.userId === currentUser.uid) {
                    showNotification(`₹${amount} tip from ${sanitizedName}`);
                }
                
                // Refresh stats and tips
                loadTipStats();
                loadRecentTips();
                
                // Clear form
                document.getElementById('tipAmount').value = '';
                document.getElementById('tipMessage').value = '';
                document.getElementById('payerName').value = '';
                
            } catch (error) {
                console.error('Error recording tip:', error);
                alert('Error recording tip. Please try again.');
            }
        }

        function exportTipHistory() {
            // Create CSV content
            let csvContent = "Date,Time,Payer Name,Amount,Message\n";
            
            database.ref('tips').orderByChild('profileId').equalTo(profileId).once('value')
                .then(snapshot => {
                    const tips = snapshot.val();
                    if (tips) {
                        Object.values(tips).forEach(tip => {
                            const date = new Date(tip.createdAt);
                            const dateStr = date.toLocaleDateString();
                            const timeStr = date.toLocaleTimeString();
                            const message = (tip.payerMessage || '').replace(/"/g, '""'); // Escape quotes
                            
                            csvContent += `"${dateStr}","${timeStr}","${tip.payerName || 'Anonymous'}","₹${tip.amount}","${message}"\n`;
                        });
                        
                        // Download CSV
                        const blob = new Blob([csvContent], { type: 'text/csv' });
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `pulsetree-tips-${new Date().toISOString().split('T')[0]}.csv`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                        
                        showSuccess('Tip history exported! 📄');
                    }
                })
                .catch(error => {
                    console.error('Error exporting tips:', error);
                    alert('Error exporting tip history.');
                });
        }

        function toggleEmailNotifications() {
            const button = document.getElementById('emailNotifications');
            const isEnabled = button.textContent.includes('OFF');
            
            if (isEnabled) {
                button.textContent = '📧 Email Notifications: ON';
                button.classList.remove('bg-green-600', 'hover:bg-green-700');
                button.classList.add('bg-red-600', 'hover:bg-red-700');
                showSuccess('Email notifications enabled! 📧');
            } else {
                button.textContent = '📧 Email Notifications: OFF';
                button.classList.remove('bg-red-600', 'hover:bg-red-700');
                button.classList.add('bg-green-600', 'hover:bg-green-700');
                showSuccess('Email notifications disabled');
            }
        }

        function showNotification(message) {
            const toast = elements.notificationToast;
            document.getElementById('notificationText').textContent = message;
            toast.style.transform = 'translateX(0)';
            
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
            }, 4000);
        }

        function showSuccess(message) {
            const successEl = elements.successMessage;
            successEl.querySelector('p').textContent = message;
            successEl.style.transform = 'translateY(0)';
            
            setTimeout(() => {
                successEl.style.transform = 'translateY(-100%)';
            }, 3000);
        }

        // UPI QR Generator Functions
        let currentUPILink = '';

        function generateUPIQR() {
            const upiId = document.getElementById('qrUpiId').value.trim();
            const payeeName = document.getElementById('qrPayeeName').value.trim();
            const amount = document.getElementById('qrAmount').value.trim();
            const note = document.getElementById('qrNote').value.trim() || 'Pulsetree';

            if (!upiId) {
                alert('Please enter UPI ID');
                return;
            }

            // Validate UPI ID format
            const upiRegex = /^[a-zA-Z0-9.\-_]{2,256}@[a-zA-Z]{2,64}$/;
            if (!upiRegex.test(upiId)) {
                alert('Please enter a valid UPI ID (e.g., rahul@okaxis)');
                return;
            }

            // Create UPI deep link
            let upiString = `upi://pay?pa=${encodeURIComponent(upiId)}&cu=INR`;
            
            if (payeeName) {
                upiString += `&pn=${encodeURIComponent(payeeName)}`;
            }
            
            if (note) {
                upiString += `&tn=${encodeURIComponent(note)}`;
            }
            
            if (amount && parseFloat(amount) > 0) {
                upiString += `&am=${encodeURIComponent(amount)}`;
            }

            currentUPILink = upiString;

            // Update deep link display
            const deepLinkElement = document.getElementById('upiDeepLink');
            deepLinkElement.href = upiString;
            deepLinkElement.textContent = upiString;

            // Generate QR code
            const canvas = document.getElementById('qrCanvas');
            QRCode.toCanvas(canvas, upiString, {
                width: 200,
                margin: 2,
                color: {
                    dark: '#000000',
                    light: '#FFFFFF'
                }
            }, function (error) {
                if (error) {
                    console.error('QR Code generation error:', error);
                    alert('Error generating QR code');
                } else {
                    document.getElementById('qrDisplay').classList.remove('hidden');
                    showSuccess('QR Code generated successfully! 🎯');
                }
            });
        }

        function openUPIFromQR() {
            if (currentUPILink) {
                window.open(currentUPILink, '_blank');
            }
        }

        function downloadQRCode() {
            const canvas = document.getElementById('qrCanvas');
            const link = document.createElement('a');
            link.download = 'upi-qr-code.png';
            link.href = canvas.toDataURL();
            link.click();
            showSuccess('QR Code downloaded! 💾');
        }

        async function shareQRCode() {
            const canvas = document.getElementById('qrCanvas');
            
            if (navigator.share && navigator.canShare) {
                try {
                    canvas.toBlob(async (blob) => {
                        const file = new File([blob], 'upi-qr-code.png', { type: 'image/png' });
                        
                        if (navigator.canShare({ files: [file] })) {
                            await navigator.share({
                                title: 'UPI QR Code',
                                text: 'Scan this QR code to pay via UPI',
                                files: [file]
                            });
                        } else {
                            // Fallback to sharing the UPI link
                            await navigator.share({
                                title: 'UPI Payment Link',
                                text: 'Pay via UPI using this link',
                                url: currentUPILink
                            });
                        }
                    });
                } catch (error) {
                    console.error('Error sharing:', error);
                    copyToClipboard(currentUPILink);
                }
            } else {
                // Fallback: copy UPI link to clipboard
                copyToClipboard(currentUPILink);
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showSuccess('UPI link copied to clipboard! 📋');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showSuccess('UPI link copied to clipboard! 📋');
            });
        }

        function openQuestionModal() {
            document.getElementById('questionModal').classList.remove('hidden');
            document.getElementById('questionProfileName').textContent = currentProfile.name || 'Creator';
        }

        function closeQuestionModal() {
            document.getElementById('questionModal').classList.add('hidden');
            // Clear form
            document.getElementById('questionText').value = '';
            document.getElementById('questionerName').value = '';
            document.getElementById('questionCategory').value = 'general';
        }

        async function submitQuestion() {
            const questionText = document.getElementById('questionText').value.trim();
            const questionerName = document.getElementById('questionerName').value.trim() || 'Anonymous';
            const category = document.getElementById('questionCategory').value;

            if (!questionText) {
                alert('Please enter your question');
                return;
            }

            if (questionText.length < 10) {
                alert('Question should be at least 10 characters long');
                return;
            }

            if (questionText.length > 500) {
                alert('Question should be less than 500 characters');
                return;
            }

            // Moderate question content
            if (!moderateMessage(questionText)) {
                alert('Question contains inappropriate content. Please modify your question.');
                return;
            }

            try {
                const sanitizedQuestion = sanitizeInput(questionText);
                const sanitizedName = sanitizeInput(questionerName);

                const questionData = {
                    question: sanitizedQuestion,
                    askerName: sanitizedName.substring(0, 50),
                    category: category,
                    profileId: currentProfile.userId || 'demo-profile',
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    status: 'pending',
                    answered: false
                };

                await database.ref('questions').push(questionData);

                closeQuestionModal();
                showSuccess('Question sent successfully! Creator will be notified. 📤');

                // Show notification to profile owner
                if (currentUser && currentProfile.userId === currentUser.uid) {
                    showNotification(`New question from ${sanitizedName}`);
                }

            } catch (error) {
                console.error('Error submitting question:', error);
                alert('Error sending question. Please try again.');
            }
        }

        // Close modals when clicking outside
        elements.settingsModal.addEventListener('click', (e) => {
            if (e.target === elements.settingsModal) {
                elements.settingsModal.classList.add('hidden');
            }
        });

        elements.tipModal.addEventListener('click', (e) => {
            if (e.target === elements.tipModal) {
                elements.tipModal.classList.add('hidden');
            }
        });

        elements.analyticsModal.addEventListener('click', (e) => {
            if (e.target === elements.analyticsModal) {
                elements.analyticsModal.classList.add('hidden');
            }
        });

        document.getElementById('questionModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('questionModal')) {
                closeQuestionModal();
            }
        });

        /*
        FIREBASE SECURITY RULES FOR PRODUCTION:
        
        {
          "rules": {
            "profiles": {
              "$profileId": {
                ".read": true,
                ".write": "auth != null && auth.uid == data.child('userId').val()",
                "userId": {
                  ".validate": "newData.val() == auth.uid"
                },
                "username": {
                  ".validate": "newData.isString() && newData.val().length <= 30"
                },
                "name": {
                  ".validate": "newData.isString() && newData.val().length <= 100"
                },
                "bio": {
                  ".validate": "newData.isString() && newData.val().length <= 500"
                },
                "upiId": {
                  ".validate": "newData.isString() && newData.val().length <= 100"
                },
                "theme": {
                  ".validate": "newData.isString() && newData.val().matches(/^(purple|pink|orange|green|blue)$/)"
                }
              }
            },
            "tips": {
              ".read": true,
              "$tipId": {
                ".write": true,
                ".validate": "newData.hasChildren(['amount', 'profileId', 'createdAt'])",
                "amount": {
                  ".validate": "newData.isNumber() && newData.val() >= 1 && newData.val() <= 50000"
                },
                "payerName": {
                  ".validate": "newData.isString() && newData.val().length <= 50"
                },
                "payerMessage": {
                  ".validate": "newData.isString() && newData.val().length <= 200"
                },
                "profileId": {
                  ".validate": "newData.isString()"
                }
              }
            }
          }
        }
        */
    </script>
    </div>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98d5f9b954f58584',t:'MTc2MDI2NTU4OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
