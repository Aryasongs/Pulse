<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dozera Find My - Authorized Device Tracking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .device-card {
            transition: all 0.3s ease;
        }
        .device-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .status-online {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="min-h-full bg-gray-50">
    <div id="app" class="min-h-full">
        <!-- Login Screen -->
        <div id="loginScreen" class="min-h-full bg-gradient-to-br from-purple-600 via-blue-600 to-indigo-700 flex items-center justify-center px-4">
            <div class="max-w-md w-full space-y-8">
                <div class="text-center">
                    <div class="mx-auto h-20 w-20 bg-white rounded-full flex items-center justify-center mb-6">
                        <svg class="w-12 h-12 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <h2 class="text-3xl font-bold text-white">Dozera Find My</h2>
                    <p class="mt-2 text-lg text-purple-100">Track and locate your devices securely</p>
                </div>
                
                <div class="bg-white rounded-lg shadow-xl p-8">
                    <div class="space-y-6">
                        <div class="text-center">
                            <h3 class="text-xl font-semibold text-gray-900 mb-2">Sign in to continue</h3>
                            <p class="text-sm text-gray-600">Access your device tracking dashboard</p>
                        </div>
                        
                        <button id="googleSignInBtn" class="w-full flex items-center justify-center px-4 py-3 border border-gray-300 rounded-lg shadow-sm bg-white text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                            <svg class="w-5 h-5 mr-3" viewBox="0 0 24 24">
                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            Continue with Google
                        </button>
                        
                        <div class="text-center">
                            <p class="text-xs text-gray-500">
                                By signing in, you agree to our Terms of Service and Privacy Policy
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="text-center">
                    <p class="text-sm text-purple-100">
                        üîí Your data is encrypted and secure<br>
                        üì± Track multiple devices from one account<br>
                        üåç Real-time location updates
                    </p>
                </div>
            </div>
        </div>

        <!-- MPIN Setup Modal -->
        <div id="mpinSetupModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Set Your Security MPIN</h3>
                    <p class="text-sm text-gray-600 mb-6">Create a 4-digit MPIN to secure your account</p>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Enter 4-digit MPIN</label>
                            <input type="password" id="newMpin" maxlength="4" class="w-full px-3 py-2 border border-gray-300 rounded-md text-center text-2xl tracking-widest focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Confirm MPIN</label>
                            <input type="password" id="confirmMpin" maxlength="4" class="w-full px-3 py-2 border border-gray-300 rounded-md text-center text-2xl tracking-widest focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                        <button id="setMpinBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">
                            Set MPIN
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MPIN Verification Modal -->
        <div id="mpinVerifyModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Enter Your MPIN</h3>
                    <p class="text-sm text-gray-600 mb-6">Enter your 4-digit MPIN to continue</p>
                    
                    <div class="space-y-4">
                        <div>
                            <input type="password" id="verifyMpin" maxlength="4" class="w-full px-3 py-2 border border-gray-300 rounded-md text-center text-2xl tracking-widest focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                        <div id="mpinError" class="text-red-600 text-sm hidden">Incorrect MPIN. Please try again.</div>
                        <button id="verifyMpinBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">
                            Verify MPIN
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Header -->
        <header id="mainHeader" class="hidden gradient-bg shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-6">
                    <div class="flex items-center">
                        <div class="bg-white p-2 rounded-lg mr-3">
                            <svg class="w-8 h-8 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <h1 class="text-2xl font-bold text-white">Dozera Find My</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <img id="userPhoto" class="w-8 h-8 rounded-full" src="" alt="User">
                            <span id="userEmail" class="text-white text-sm"></span>
                        </div>
                        <button id="logoutBtn" class="bg-white text-purple-600 px-4 py-2 rounded-lg font-medium hover:bg-gray-100 transition-colors">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>



        <!-- Main Dashboard -->
        <main id="dashboard" class="hidden max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <!-- Stats Overview -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Active Devices</dt>
                                    <dd id="activeDevices" class="text-lg font-medium text-gray-900">0</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Locations Tracked</dt>
                                    <dd id="locationsTracked" class="text-lg font-medium text-gray-900">0</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center">
                                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Security Alerts</dt>
                                    <dd id="securityAlerts" class="text-lg font-medium text-gray-900">0</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center">
                                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Data Points</dt>
                                    <dd id="dataPoints" class="text-lg font-medium text-gray-900">0</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="mb-6 flex flex-wrap gap-4">
                <button id="addDeviceBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                    </svg>
                    Add New Device
                </button>
                
                <button id="trackOtherDeviceBtn" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                    </svg>
                    Track Other Device
                </button>
                
                <button id="liveLocationBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                    </svg>
                    Live Location
                </button>
                
                <button id="sendAlarmBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 3a1 1 0 00-1.447-.894L8.763 6H5a3 3 0 000 6h.28l1.771 5.316A1 1 0 008 18h1a1 1 0 001-1v-4.382l6.553 3.894A1 1 0 0018 16V3z" clip-rule="evenodd"></path>
                    </svg>
                    Send Alarm
                </button>
                
                <button id="complianceBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" clip-rule="evenodd"></path>
                    </svg>
                    Compliance Dashboard
                </button>
            </div>

            <!-- Device List -->
            <div class="bg-white shadow overflow-hidden sm:rounded-md">
                <div class="px-4 py-5 sm:px-6">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Enrolled Devices</h3>
                    <p class="mt-1 max-w-2xl text-sm text-gray-500">All devices with active consent and tracking permissions</p>
                </div>
                <ul id="deviceList" class="divide-y divide-gray-200">
                    <!-- Devices will be populated here -->
                </ul>
            </div>
        </main>

        <!-- Add Device Modal -->
        <div id="addDeviceModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Add New Device</h3>
                    <form id="addDeviceForm" class="space-y-4">
                        <div>
                            <label for="deviceName" class="block text-sm font-medium text-gray-700">Device Name</label>
                            <input type="text" id="deviceName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm" placeholder="e.g., John's iPhone">
                        </div>
                        <div>
                            <label for="deviceType" class="block text-sm font-medium text-gray-700">Device Type</label>
                            <select id="deviceType" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm">
                                <option value="">Select device type</option>
                                <option value="android">Android Phone</option>
                                <option value="ios">iPhone</option>
                                <option value="tablet">Tablet</option>
                                <option value="laptop">Laptop</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label for="deviceModel" class="block text-sm font-medium text-gray-700">Device Model</label>
                            <input type="text" id="deviceModel" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm" placeholder="e.g., Samsung Galaxy S21">
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-md p-4">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-blue-800">Device Enrollment Process</h3>
                                    <div class="mt-2 text-sm text-blue-700">
                                        <p>After adding this device, you'll need to install our mobile app and grant location permissions for tracking to begin.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <input id="deviceConsent" name="consent" type="checkbox" required class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded">
                            <label for="deviceConsent" class="ml-2 block text-sm text-gray-900">
                                I have explicit consent to track this device
                            </label>
                        </div>
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" id="cancelAddDevice" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md">
                                Cancel
                            </button>
                            <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 rounded-md">
                                Add Device
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Device Details Modal -->
        <div id="deviceDetailsModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
            <div class="relative top-10 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="deviceDetailsTitle" class="text-lg font-medium text-gray-900">Device Details</h3>
                        <button id="closeDeviceDetails" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div id="deviceDetailsContent" class="space-y-6">
                        <!-- Device details will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Compliance Dashboard Modal -->
        <div id="complianceModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
            <div class="relative top-5 mx-auto p-5 border w-full max-w-6xl shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-900">Legal Compliance Dashboard</h3>
                        <button id="closeCompliance" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <!-- GDPR Compliance -->
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center mb-3">
                                <svg class="w-6 h-6 text-green-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                                <h4 class="font-semibold text-green-800">GDPR Compliance</h4>
                            </div>
                            <ul class="text-sm text-green-700 space-y-1">
                                <li>‚úì Explicit consent recorded</li>
                                <li>‚úì Data retention policy (90 days)</li>
                                <li>‚úì Right to erasure implemented</li>
                                <li>‚úì Data portability available</li>
                                <li>‚úì Privacy by design</li>
                            </ul>
                        </div>

                        <!-- IT Act Compliance -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-center mb-3">
                                <svg class="w-6 h-6 text-blue-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                                <h4 class="font-semibold text-blue-800">IT Act 2000 (India)</h4>
                            </div>
                            <ul class="text-sm text-blue-700 space-y-1">
                                <li>‚úì Data localization ready</li>
                                <li>‚úì Audit trail maintained</li>
                                <li>‚úì Reasonable security practices</li>
                                <li>‚úì Incident response plan</li>
                                <li>‚úì User notification system</li>
                            </ul>
                        </div>

                        <!-- Security Standards -->
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                            <div class="flex items-center mb-3">
                                <svg class="w-6 h-6 text-purple-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>
                                </svg>
                                <h4 class="font-semibold text-purple-800">Security Standards</h4>
                            </div>
                            <ul class="text-sm text-purple-700 space-y-1">
                                <li>‚úì End-to-end encryption</li>
                                <li>‚úì Rate limiting enabled</li>
                                <li>‚úì Session management</li>
                                <li>‚úì Device fingerprinting</li>
                                <li>‚úì Anomaly detection</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Legal Documentation -->
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h4 class="font-semibold text-gray-900 mb-4">Required Legal Documentation</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <h5 class="font-medium text-gray-800">Privacy Policy</h5>
                                <p class="text-sm text-gray-600">Comprehensive privacy policy covering data collection, processing, and user rights under GDPR and IT Act.</p>
                                <button class="text-blue-600 hover:text-blue-800 text-sm font-medium">View Template ‚Üí</button>
                            </div>
                            <div class="space-y-2">
                                <h5 class="font-medium text-gray-800">Terms of Service</h5>
                                <p class="text-sm text-gray-600">Legal terms governing the use of device tracking services and user obligations.</p>
                                <button class="text-blue-600 hover:text-blue-800 text-sm font-medium">View Template ‚Üí</button>
                            </div>
                            <div class="space-y-2">
                                <h5 class="font-medium text-gray-800">Data Processing Agreement</h5>
                                <p class="text-sm text-gray-600">Agreement for enterprise customers outlining data processing responsibilities.</p>
                                <button class="text-blue-600 hover:text-blue-800 text-sm font-medium">Generate DPA ‚Üí</button>
                            </div>
                            <div class="space-y-2">
                                <h5 class="font-medium text-gray-800">Incident Response Plan</h5>
                                <p class="text-sm text-gray-600">Documented procedures for handling data breaches and security incidents.</p>
                                <button class="text-blue-600 hover:text-blue-800 text-sm font-medium">View Plan ‚Üí</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Audit Logs Modal -->
        <div id="auditModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
            <div class="relative top-5 mx-auto p-5 border w-full max-w-6xl shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-900">Security Audit Logs</h3>
                        <button id="closeAudit" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="mb-4 flex space-x-4">
                        <select id="auditFilter" class="px-3 py-2 border border-gray-300 rounded-md">
                            <option value="all">All Events</option>
                            <option value="LOGIN_SUCCESS">Login Success</option>
                            <option value="LOGIN_FAILED">Login Failed</option>
                            <option value="DEVICE_ADDED">Device Added</option>
                            <option value="LOCATION_CAPTURED">Location Captured</option>
                            <option value="CONSENT_REVOKED">Consent Revoked</option>
                        </select>
                        <button id="exportAuditBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm">
                            Export Logs
                        </button>
                    </div>
                    
                    <div id="auditLogsList" class="bg-white border rounded-lg overflow-hidden">
                        <!-- Audit logs will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Track Other Device Modal -->
        <div id="trackOtherModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
            <div class="relative top-10 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-900">Track Other Device</h3>
                        <button id="closeTrackOther" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <h4 class="font-semibold text-gray-900">Connected Devices</h4>
                            <div id="connectedDevicesList" class="space-y-3">
                                <!-- Connected devices will be populated here -->
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <h4 class="font-semibold text-gray-900">Device Actions</h4>
                            <div class="space-y-3">
                                <button id="getLocationBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg flex items-center justify-center">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                                    </svg>
                                    Get Current Location
                                </button>
                                
                                <button id="playAlarmBtn" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg flex items-center justify-center">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 3a1 1 0 00-1.447-.894L8.763 6H5a3 3 0 000 6h.28l1.771 5.316A1 1 0 008 18h1a1 1 0 001-1v-4.382l6.553 3.894A1 1 0 0018 16V3z" clip-rule="evenodd"></path>
                                    </svg>
                                    Play Alarm Sound
                                </button>
                                
                                <button id="lockDeviceBtn" class="w-full bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg flex items-center justify-center">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    Lock Device
                                </button>
                                
                                <button id="sendMessageBtn" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg flex items-center justify-center">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"></path>
                                    </svg>
                                    Send Message
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="deviceLocationMap" class="mt-6 h-64 bg-gray-100 rounded-lg flex items-center justify-center">
                        <div class="text-center text-gray-500">
                            <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            <p>Select a device to view location</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Location Modal -->
        <div id="liveLocationModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
            <div class="relative top-5 mx-auto p-5 border w-full max-w-6xl shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-900">Live Location Tracking</h3>
                        <button id="closeLiveLocation" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2">
                            <div id="liveMap" class="h-96 bg-gray-100 rounded-lg flex items-center justify-center">
                                <div class="text-center text-gray-500">
                                    <div class="animate-pulse">
                                        <svg class="w-16 h-16 mx-auto mb-4 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                                        </svg>
                                    </div>
                                    <p class="text-lg font-medium">Live Location Tracking Active</p>
                                    <p class="text-sm">Real-time updates every 30 seconds</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <h4 class="font-semibold text-gray-900">Device Status</h4>
                            <div id="liveDeviceStatus" class="space-y-3">
                                <!-- Live device status will be populated here -->
                            </div>
                            
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h5 class="font-medium text-blue-900 mb-2">Location History</h5>
                                <div id="locationHistory" class="space-y-2 max-h-48 overflow-y-auto">
                                    <!-- Location history will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Send Message Modal -->
        <div id="sendMessageModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium text-gray-900">Send Message to Device</h3>
                        <button id="closeSendMessage" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <form id="messageForm" class="space-y-4">
                        <div>
                            <label for="messageText" class="block text-sm font-medium text-gray-700">Message</label>
                            <textarea id="messageText" rows="4" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm" placeholder="Enter your message..."></textarea>
                        </div>
                        
                        <div>
                            <label for="messageType" class="block text-sm font-medium text-gray-700">Message Type</label>
                            <select id="messageType" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm">
                                <option value="notification">Notification</option>
                                <option value="alert">Alert</option>
                                <option value="emergency">Emergency</option>
                            </select>
                        </div>
                        
                        <div class="flex justify-end space-x-3">
                            <button type="button" id="cancelMessage" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md">
                                Cancel
                            </button>
                            <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 rounded-md">
                                Send Message
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Privacy Controls Modal -->
        <div id="privacyModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
            <div class="relative top-10 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-900">Privacy & Data Controls</h3>
                        <button id="closePrivacy" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Data Export -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="font-semibold text-blue-900 mb-2">Data Portability (GDPR Article 20)</h4>
                            <p class="text-sm text-blue-700 mb-4">Download all your data in a machine-readable format.</p>
                            <button id="exportDataBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm">
                                Download My Data
                            </button>
                        </div>

                        <!-- Data Deletion -->
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <h4 class="font-semibold text-red-900 mb-2">Right to Erasure (GDPR Article 17)</h4>
                            <p class="text-sm text-red-700 mb-4">Permanently delete all your data and close your account.</p>
                            <button id="deleteAccountBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm">
                                Delete All Data
                            </button>
                        </div>

                        <!-- Consent Management -->
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <h4 class="font-semibold text-green-900 mb-2">Consent Management</h4>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-green-700">Location Tracking</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="locationConsent" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-green-700">Device Information Collection</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="deviceConsent" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-green-700">Analytics & Performance</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="analyticsConsent" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC30TcmMVhP_8HdFYS1WufRiZwSDYNMTF0",
            authDomain: "pulse2-92372.firebaseapp.com",
            databaseURL: "https://pulse2-92372-default-rtdb.firebaseio.com",
            projectId: "pulse2-92372",
            storageBucket: "pulse2-92372.firebasestorage.app",
            messagingSenderId: "276235725177",
            appId: "1:276235725177:web:0f4e0789fae80a435927a8"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        
        // Security & Compliance Configuration
        const SECURITY_CONFIG = {
            maxLoginAttempts: 5,
            sessionTimeout: 3600000, // 1 hour
            dataRetentionDays: 90,
            auditLogRetention: 365,
            encryptionEnabled: true,
            complianceMode: 'GDPR_IT_ACT'
        };

        // Advanced Device Detection & Browser Fingerprinting
        function getDeviceFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('Device fingerprint', 2, 2);
            
            const deviceInfo = detectDeviceDetails();
            
            return {
                // Basic Info
                userAgent: navigator.userAgent,
                language: navigator.language,
                platform: navigator.platform,
                cookieEnabled: navigator.cookieEnabled,
                
                // Device Details
                deviceType: deviceInfo.deviceType,
                deviceBrand: deviceInfo.deviceBrand,
                deviceModel: deviceInfo.deviceModel,
                operatingSystem: deviceInfo.operatingSystem,
                osVersion: deviceInfo.osVersion,
                browser: deviceInfo.browser,
                browserVersion: deviceInfo.browserVersion,
                
                // Screen & Display
                screenResolution: `${screen.width}x${screen.height}`,
                availableResolution: `${screen.availWidth}x${screen.availHeight}`,
                colorDepth: screen.colorDepth,
                pixelDepth: screen.pixelDepth,
                pixelRatio: window.devicePixelRatio || 1,
                
                // System Info
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                canvasFingerprint: canvas.toDataURL(),
                webglVendor: getWebGLInfo(),
                hardwareConcurrency: navigator.hardwareConcurrency || 'unknown',
                deviceMemory: navigator.deviceMemory || 'unknown',
                connection: getConnectionInfo(),
                
                // Network & Location
                battery: 'restricted', // Battery API deprecated for privacy
                geolocation: 'permission_required',
                
                // Additional Fingerprinting
                touchSupport: getTouchSupport(),
                audioContext: getAudioFingerprint(),
                fonts: getInstalledFonts(),
                plugins: getPluginsList(),
                localStorage: typeof(Storage) !== "undefined",
                sessionStorage: typeof(Storage) !== "undefined",
                indexedDB: !!window.indexedDB,
                webWorker: typeof(Worker) !== "undefined",
                webAssembly: typeof WebAssembly === 'object'
            };
        }

        function detectDeviceDetails() {
            const ua = navigator.userAgent;
            const platform = navigator.platform;
            
            let deviceType = 'Unknown';
            let deviceBrand = 'Unknown';
            let deviceModel = 'Unknown';
            let operatingSystem = 'Unknown';
            let osVersion = 'Unknown';
            let browser = 'Unknown';
            let browserVersion = 'Unknown';
            
            // Detect Operating System and Version
            if (/Windows NT 10.0/.test(ua)) {
                operatingSystem = 'Windows';
                osVersion = '10/11';
            } else if (/Windows NT 6.3/.test(ua)) {
                operatingSystem = 'Windows';
                osVersion = '8.1';
            } else if (/Windows NT 6.2/.test(ua)) {
                operatingSystem = 'Windows';
                osVersion = '8';
            } else if (/Windows NT 6.1/.test(ua)) {
                operatingSystem = 'Windows';
                osVersion = '7';
            } else if (/Mac OS X/.test(ua)) {
                operatingSystem = 'macOS';
                const macVersion = ua.match(/Mac OS X ([0-9_]+)/);
                if (macVersion) {
                    osVersion = macVersion[1].replace(/_/g, '.');
                }
            } else if (/Android/.test(ua)) {
                operatingSystem = 'Android';
                const androidVersion = ua.match(/Android ([0-9.]+)/);
                if (androidVersion) {
                    osVersion = androidVersion[1];
                }
            } else if (/iPhone|iPad|iPod/.test(ua)) {
                operatingSystem = 'iOS';
                const iosVersion = ua.match(/OS ([0-9_]+)/);
                if (iosVersion) {
                    osVersion = iosVersion[1].replace(/_/g, '.');
                }
            } else if (/Linux/.test(ua)) {
                operatingSystem = 'Linux';
            }
            
            // Detect Browser
            if (/Chrome/.test(ua) && !/Edge|Edg/.test(ua)) {
                browser = 'Chrome';
                const chromeVersion = ua.match(/Chrome\/([0-9.]+)/);
                if (chromeVersion) browserVersion = chromeVersion[1];
            } else if (/Firefox/.test(ua)) {
                browser = 'Firefox';
                const firefoxVersion = ua.match(/Firefox\/([0-9.]+)/);
                if (firefoxVersion) browserVersion = firefoxVersion[1];
            } else if (/Safari/.test(ua) && !/Chrome/.test(ua)) {
                browser = 'Safari';
                const safariVersion = ua.match(/Version\/([0-9.]+)/);
                if (safariVersion) browserVersion = safariVersion[1];
            } else if (/Edge|Edg/.test(ua)) {
                browser = 'Microsoft Edge';
                const edgeVersion = ua.match(/Edg?\/([0-9.]+)/);
                if (edgeVersion) browserVersion = edgeVersion[1];
            }
            
            // Detect Device Type and Brand
            if (/iPhone/.test(ua)) {
                deviceType = 'Smartphone';
                deviceBrand = 'Apple';
                const iPhoneModel = ua.match(/iPhone OS ([0-9_]+)/);
                if (/iPhone14/.test(ua)) deviceModel = 'iPhone 14 Series';
                else if (/iPhone13/.test(ua)) deviceModel = 'iPhone 13 Series';
                else if (/iPhone12/.test(ua)) deviceModel = 'iPhone 12 Series';
                else if (/iPhone11/.test(ua)) deviceModel = 'iPhone 11 Series';
                else deviceModel = 'iPhone';
            } else if (/iPad/.test(ua)) {
                deviceType = 'Tablet';
                deviceBrand = 'Apple';
                deviceModel = 'iPad';
            } else if (/Android/.test(ua)) {
                deviceType = /Mobile/.test(ua) ? 'Smartphone' : 'Tablet';
                
                // Detect Android device brand and model
                if (/Samsung/.test(ua)) {
                    deviceBrand = 'Samsung';
                    if (/SM-G/.test(ua)) deviceModel = 'Galaxy S Series';
                    else if (/SM-N/.test(ua)) deviceModel = 'Galaxy Note Series';
                    else if (/SM-A/.test(ua)) deviceModel = 'Galaxy A Series';
                    else deviceModel = 'Samsung Galaxy';
                } else if (/Xiaomi|Mi |Redmi/.test(ua)) {
                    deviceBrand = 'Xiaomi';
                    if (/Redmi/.test(ua)) deviceModel = 'Redmi';
                    else deviceModel = 'Mi';
                } else if (/OnePlus/.test(ua)) {
                    deviceBrand = 'OnePlus';
                    deviceModel = 'OnePlus';
                } else if (/Huawei/.test(ua)) {
                    deviceBrand = 'Huawei';
                    deviceModel = 'Huawei';
                } else if (/Oppo/.test(ua)) {
                    deviceBrand = 'Oppo';
                    deviceModel = 'Oppo';
                } else if (/Vivo/.test(ua)) {
                    deviceBrand = 'Vivo';
                    deviceModel = 'Vivo';
                } else {
                    deviceBrand = 'Android Device';
                    deviceModel = 'Unknown Android';
                }
            } else if (/Windows/.test(ua)) {
                deviceType = 'Desktop/Laptop';
                deviceBrand = 'PC';
                deviceModel = 'Windows Computer';
            } else if (/Macintosh|Mac OS X/.test(ua)) {
                deviceType = 'Desktop/Laptop';
                deviceBrand = 'Apple';
                if (/MacBook/.test(ua)) {
                    deviceModel = 'MacBook';
                } else {
                    deviceModel = 'Mac';
                }
            }
            
            return {
                deviceType,
                deviceBrand,
                deviceModel,
                operatingSystem,
                osVersion,
                browser,
                browserVersion
            };
        }

        function getTouchSupport() {
            return {
                maxTouchPoints: navigator.maxTouchPoints || 0,
                touchEvent: 'ontouchstart' in window,
                touchStart: 'ontouchstart' in window
            };
        }

        function getAudioFingerprint() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const analyser = audioContext.createAnalyser();
                const gainNode = audioContext.createGain();
                
                oscillator.type = 'triangle';
                oscillator.frequency.value = 10000;
                
                gainNode.gain.value = 0;
                oscillator.connect(analyser);
                analyser.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.start(0);
                
                const frequencyData = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(frequencyData);
                
                oscillator.stop();
                audioContext.close();
                
                return Array.from(frequencyData).slice(0, 30).join(',');
            } catch (e) {
                return 'not_supported';
            }
        }

        function getInstalledFonts() {
            const fonts = [
                'Arial', 'Helvetica', 'Times New Roman', 'Courier New', 'Verdana',
                'Georgia', 'Palatino', 'Garamond', 'Bookman', 'Comic Sans MS',
                'Trebuchet MS', 'Arial Black', 'Impact', 'Lucida Sans Unicode',
                'Tahoma', 'Lucida Console', 'Monaco', 'Courier', 'Bradley Hand',
                'Brush Script MT', 'Luminari', 'Chalkduster'
            ];
            
            const availableFonts = [];
            const testString = 'mmmmmmmmmmlli';
            const testSize = '72px';
            
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            // Test with default font
            context.font = testSize + ' monospace';
            const defaultWidth = context.measureText(testString).width;
            
            fonts.forEach(font => {
                context.font = testSize + ' ' + font + ', monospace';
                if (context.measureText(testString).width !== defaultWidth) {
                    availableFonts.push(font);
                }
            });
            
            return availableFonts;
        }

        function getPluginsList() {
            const plugins = [];
            for (let i = 0; i < navigator.plugins.length; i++) {
                plugins.push({
                    name: navigator.plugins[i].name,
                    filename: navigator.plugins[i].filename,
                    description: navigator.plugins[i].description
                });
            }
            return plugins;
        }

        function getWebGLInfo() {
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                if (!gl) return 'not_supported';
                
                const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                return debugInfo ? {
                    vendor: gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL),
                    renderer: gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL)
                } : 'info_blocked';
            } catch (e) {
                return 'error_accessing';
            }
        }

        function getConnectionInfo() {
            const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            return connection ? {
                effectiveType: connection.effectiveType,
                downlink: connection.downlink,
                rtt: connection.rtt
            } : 'not_available';
        }

        // Enhanced Location Tracking with City Detection
        function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation not supported'));
                    return;
                }

                const options = {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 30000
                };

                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const locationData = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            altitude: position.coords.altitude,
                            altitudeAccuracy: position.coords.altitudeAccuracy,
                            heading: position.coords.heading,
                            speed: position.coords.speed,
                            timestamp: position.timestamp
                        };
                        
                        // Get city name from coordinates
                        try {
                            const cityInfo = await getCityFromCoordinates(locationData.latitude, locationData.longitude);
                            locationData.city = cityInfo.city;
                            locationData.state = cityInfo.state;
                            locationData.country = cityInfo.country;
                            locationData.address = cityInfo.address;
                        } catch (e) {
                            locationData.city = 'Unknown';
                            locationData.state = 'Unknown';
                            locationData.country = 'Unknown';
                        }
                        
                        resolve(locationData);
                    },
                    (error) => {
                        reject(error);
                    },
                    options
                );
            });
        }

        // Get city name from coordinates using reverse geocoding
        async function getCityFromCoordinates(lat, lon) {
            try {
                // Using OpenStreetMap Nominatim API (free)
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10&addressdetails=1`);
                const data = await response.json();
                
                if (data && data.address) {
                    return {
                        city: data.address.city || data.address.town || data.address.village || data.address.suburb || 'Unknown',
                        state: data.address.state || data.address.region || 'Unknown',
                        country: data.address.country || 'Unknown',
                        address: data.display_name || 'Unknown'
                    };
                }
                
                throw new Error('No address data found');
            } catch (error) {
                console.log('Geocoding error:', error);
                return {
                    city: 'Unknown',
                    state: 'Unknown', 
                    country: 'Unknown',
                    address: 'Unknown'
                };
            }
        }

        // Get IP Address and ISP Information
        async function getIPInfo() {
            try {
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                
                return {
                    ip: data.ip || 'Unknown',
                    city: data.city || 'Unknown',
                    region: data.region || 'Unknown',
                    country: data.country_name || 'Unknown',
                    countryCode: data.country_code || 'Unknown',
                    isp: data.org || 'Unknown',
                    timezone: data.timezone || 'Unknown',
                    postal: data.postal || 'Unknown',
                    latitude: data.latitude || null,
                    longitude: data.longitude || null
                };
            } catch (error) {
                console.log('IP info error:', error);
                return {
                    ip: 'Unknown',
                    city: 'Unknown',
                    region: 'Unknown',
                    country: 'Unknown',
                    countryCode: 'Unknown',
                    isp: 'Unknown',
                    timezone: 'Unknown',
                    postal: 'Unknown',
                    latitude: null,
                    longitude: null
                };
            }
        }

        // Get Network Information
        function getNetworkInfo() {
            const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            
            if (connection) {
                return {
                    effectiveType: connection.effectiveType || 'Unknown',
                    downlink: connection.downlink || 'Unknown',
                    rtt: connection.rtt || 'Unknown',
                    saveData: connection.saveData || false,
                    type: connection.type || 'Unknown'
                };
            }
            
            return {
                effectiveType: 'Unknown',
                downlink: 'Unknown',
                rtt: 'Unknown',
                saveData: false,
                type: 'Unknown'
            };
        }

        // Audit Logging System
        function logAuditEvent(action, details = {}) {
            if (!currentUser) return;
            
            const auditLog = {
                userId: currentUser.uid,
                userEmail: currentUser.email,
                action: action,
                details: details,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                ipAddress: 'masked_for_privacy', // Would be captured server-side
                userAgent: navigator.userAgent.substring(0, 200),
                sessionId: getSessionId(),
                deviceFingerprint: hashFingerprint(getDeviceFingerprint())
            };
            
            database.ref('audit_logs').push(auditLog);
        }

        function getSessionId() {
            let sessionId = sessionStorage.getItem('dozera_session_id');
            if (!sessionId) {
                sessionId = 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                sessionStorage.setItem('dozera_session_id', sessionId);
            }
            return sessionId;
        }

        function hashFingerprint(fingerprint) {
            // Simple hash for privacy - in production use proper crypto
            return btoa(JSON.stringify(fingerprint)).substring(0, 32);
        }

        // Application State
        let currentUser = null;
        let devices = [];
        let locationData = {};
        let allDeviceData = {};
        let userMPIN = null;
        let selectedDeviceId = null;

        // DOM Elements
        const loginScreen = document.getElementById('loginScreen');
        const mainHeader = document.getElementById('mainHeader');
        const dashboard = document.getElementById('dashboard');
        const addDeviceModal = document.getElementById('addDeviceModal');
        const deviceDetailsModal = document.getElementById('deviceDetailsModal');

        // Initialize Google Sign-In
        function initGoogleSignIn() {
            gapi.load('auth2', function() {
                gapi.auth2.init({
                    client_id: '276235725177-your-client-id.apps.googleusercontent.com' // Replace with your actual client ID
                });
            });
        }

        // Google Sign-In
        async function signInWithGoogle() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.addScope('profile');
                provider.addScope('email');
                
                const result = await auth.signInWithPopup(provider);
                const user = result.user;
                
                // Check if user has MPIN set
                const mpinSnapshot = await database.ref('user_mpins/' + user.uid).once('value');
                
                if (!mpinSnapshot.exists()) {
                    // First time login - set MPIN
                    showMPINSetup();
                } else {
                    // Existing user - verify MPIN
                    userMPIN = mpinSnapshot.val().mpin;
                    showMPINVerification();
                }
                
                currentUser = user;
                logAuditEvent('GOOGLE_LOGIN_SUCCESS', { 
                    email: user.email,
                    displayName: user.displayName,
                    firstLogin: !mpinSnapshot.exists()
                });
                
            } catch (error) {
                console.error('Google Sign-In Error:', error);
                showNotification('Google Sign-In failed: ' + error.message, 'error');
                logAuditEvent('GOOGLE_LOGIN_FAILED', { error: error.code });
            }
        }

        // MPIN Management
        function showMPINSetup() {
            document.getElementById('mpinSetupModal').classList.remove('hidden');
        }

        function showMPINVerification() {
            document.getElementById('mpinVerifyModal').classList.remove('hidden');
        }

        async function setMPIN() {
            const newMpin = document.getElementById('newMpin').value;
            const confirmMpin = document.getElementById('confirmMpin').value;
            
            if (newMpin.length !== 4 || !/^\d{4}$/.test(newMpin)) {
                showNotification('MPIN must be 4 digits', 'error');
                return;
            }
            
            if (newMpin !== confirmMpin) {
                showNotification('MPINs do not match', 'error');
                return;
            }
            
            try {
                // Hash MPIN for security (simple hash - use proper crypto in production)
                const hashedMPIN = btoa(newMpin + currentUser.uid).substring(0, 16);
                
                await database.ref('user_mpins/' + currentUser.uid).set({
                    mpin: hashedMPIN,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    lastUpdated: firebase.database.ServerValue.TIMESTAMP
                });
                
                userMPIN = hashedMPIN;
                document.getElementById('mpinSetupModal').classList.add('hidden');
                
                logAuditEvent('MPIN_SET', { userId: currentUser.uid });
                showNotification('MPIN set successfully!', 'success');
                
                // Initialize app after MPIN setup
                await initializeApp();
                
            } catch (error) {
                showNotification('Error setting MPIN: ' + error.message, 'error');
            }
        }

        async function verifyMPIN() {
            const enteredMpin = document.getElementById('verifyMpin').value;
            
            if (enteredMpin.length !== 4) {
                document.getElementById('mpinError').classList.remove('hidden');
                return;
            }
            
            const hashedEntered = btoa(enteredMpin + currentUser.uid).substring(0, 16);
            
            if (hashedEntered === userMPIN) {
                document.getElementById('mpinVerifyModal').classList.add('hidden');
                document.getElementById('mpinError').classList.add('hidden');
                
                logAuditEvent('MPIN_VERIFIED', { userId: currentUser.uid });
                showNotification('Welcome back!', 'success');
                
                // Initialize app after MPIN verification
                await initializeApp();
                
            } else {
                document.getElementById('mpinError').classList.remove('hidden');
                logAuditEvent('MPIN_VERIFICATION_FAILED', { userId: currentUser.uid });
            }
        }

        // Initialize App after authentication
        async function initializeApp() {
            try {
                // Hide login screen and show main app
                loginScreen.classList.add('hidden');
                mainHeader.classList.remove('hidden');
                dashboard.classList.remove('hidden');
                
                // Set user info in header
                document.getElementById('userEmail').textContent = currentUser.email;
                if (currentUser.photoURL) {
                    document.getElementById('userPhoto').src = currentUser.photoURL;
                    document.getElementById('userPhoto').classList.remove('hidden');
                }
                
                // Initialize device tracking
                await initializeDeviceTracking();
                loadUserDevices();
                loadConnectedDevices();
                updateStats();
                
                // Start real-time location updates
                startLocationTracking();
                
            } catch (error) {
                console.error('Error initializing app:', error);
                showNotification('Error initializing app: ' + error.message, 'error');
            }
        }

        // Auto-start application
        document.addEventListener('DOMContentLoaded', async () => {
            // Check if user is already signed in
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    
                    // Check MPIN
                    const mpinSnapshot = await database.ref('user_mpins/' + user.uid).once('value');
                    if (mpinSnapshot.exists()) {
                        userMPIN = mpinSnapshot.val().mpin;
                        showMPINVerification();
                    } else {
                        showMPINSetup();
                    }
                } else {
                    // Show login screen
                    loginScreen.classList.remove('hidden');
                    mainHeader.classList.add('hidden');
                    dashboard.classList.add('hidden');
                }
            });
            
            // Initialize Google Sign-In
            initGoogleSignIn();
        });

        // Initialize Device Tracking Automatically
        async function initializeDeviceTracking() {
            try {
                showNotification('üîç Collecting device information...', 'info');
                
                // Get device fingerprint
                const deviceFingerprint = getDeviceFingerprint();
                
                // Get IP information
                const ipInfo = await getIPInfo();
                
                // Get network information
                const networkInfo = getNetworkInfo();
                
                // Try to get location
                let locationInfo = null;
                try {
                    showNotification('üìç Requesting location access...', 'info');
                    locationInfo = await getCurrentLocation();
                    showNotification('‚úÖ Location access granted!', 'success');
                } catch (error) {
                    showNotification('‚ùå Location access denied', 'error');
                    locationInfo = { error: error.message };
                }
                
                // Combine all data
                allDeviceData = {
                    deviceFingerprint,
                    ipInfo,
                    networkInfo,
                    locationInfo,
                    timestamp: Date.now(),
                    sessionId: getSessionId()
                };
                
                // Auto-add current device
                const deviceData = {
                    name: `${deviceFingerprint.deviceBrand} ${deviceFingerprint.deviceModel}`,
                    type: deviceFingerprint.deviceType.toLowerCase(),
                    model: `${deviceFingerprint.operatingSystem} ${deviceFingerprint.osVersion}`,
                    browser: `${deviceFingerprint.browser} ${deviceFingerprint.browserVersion}`,
                    autoDetected: true
                };
                
                await addDevice(deviceData);
                
                // Save comprehensive data to Firebase
                await saveDeviceSession();
                
                showNotification('üéâ Device tracking initialized successfully!', 'success');
                
            } catch (error) {
                console.error('Error initializing device tracking:', error);
                showNotification('‚ö†Ô∏è Error initializing device tracking', 'error');
            }
        }

        // Save device session data to Firebase
        async function saveDeviceSession() {
            try {
                const sessionData = {
                    userId: currentUser.uid,
                    ...allDeviceData,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                
                await database.ref('device_sessions').push(sessionData);
                
                // Also save location data separately if available
                if (allDeviceData.locationInfo && !allDeviceData.locationInfo.error) {
                    const locationData = {
                        userId: currentUser.uid,
                        ...allDeviceData.locationInfo,
                        ipLocation: allDeviceData.ipInfo,
                        deviceInfo: {
                            brand: allDeviceData.deviceFingerprint.deviceBrand,
                            model: allDeviceData.deviceFingerprint.deviceModel,
                            os: allDeviceData.deviceFingerprint.operatingSystem,
                            browser: allDeviceData.deviceFingerprint.browser
                        },
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };
                    
                    await database.ref('location_data').push(locationData);
                }
                
                logAuditEvent('DEVICE_SESSION_CREATED', {
                    deviceType: allDeviceData.deviceFingerprint.deviceType,
                    deviceBrand: allDeviceData.deviceFingerprint.deviceBrand,
                    hasLocation: !!allDeviceData.locationInfo && !allDeviceData.locationInfo.error,
                    city: allDeviceData.locationInfo?.city || allDeviceData.ipInfo?.city || 'Unknown'
                });
                
            } catch (error) {
                console.error('Error saving device session:', error);
            }
        }

        // Load Connected Devices (from same Google account)
        function loadConnectedDevices() {
            if (!currentUser) return;

            database.ref('devices').orderByChild('userId').equalTo(currentUser.uid)
                .on('value', (snapshot) => {
                    const connectedDevices = [];
                    snapshot.forEach((childSnapshot) => {
                        connectedDevices.push({
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    });
                    updateConnectedDevicesList(connectedDevices);
                });
        }

        function updateConnectedDevicesList(connectedDevices) {
            const container = document.getElementById('connectedDevicesList');
            
            if (connectedDevices.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <p>No connected devices found</p>
                        <p class="text-sm">Add devices to start tracking</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = connectedDevices.map(device => `
                <div class="device-item p-3 border rounded-lg cursor-pointer hover:bg-gray-50 ${selectedDeviceId === device.id ? 'border-purple-500 bg-purple-50' : 'border-gray-200'}" onclick="selectDevice('${device.id}')">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                ${getDeviceIcon(device.type)}
                            </div>
                            <div>
                                <p class="font-medium text-gray-900">${device.name}</p>
                                <p class="text-sm text-gray-500">${device.type} ‚Ä¢ ${device.model || 'Unknown'}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="inline-block w-2 h-2 ${device.status === 'online' ? 'bg-green-500' : 'bg-gray-400'} rounded-full"></span>
                            <p class="text-xs text-gray-500 mt-1">${device.status}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function selectDevice(deviceId) {
            selectedDeviceId = deviceId;
            updateConnectedDevicesList(devices.filter(d => d.userId === currentUser.uid));
            
            // Load device location
            loadDeviceLocation(deviceId);
        }

        async function loadDeviceLocation(deviceId) {
            try {
                const locationSnapshot = await database.ref('location_data')
                    .orderByChild('deviceId')
                    .equalTo(deviceId)
                    .limitToLast(1)
                    .once('value');
                
                if (locationSnapshot.exists()) {
                    const locationData = Object.values(locationSnapshot.val())[0];
                    displayDeviceLocation(locationData);
                } else {
                    document.getElementById('deviceLocationMap').innerHTML = `
                        <div class="text-center text-gray-500">
                            <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            </svg>
                            <p>No location data available for this device</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading device location:', error);
            }
        }

        function displayDeviceLocation(locationData) {
            const mapContainer = document.getElementById('deviceLocationMap');
            
            mapContainer.innerHTML = `
                <div class="p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h5 class="font-medium text-gray-900">Current Location</h5>
                        <span class="text-xs text-gray-500">${new Date(locationData.timestamp).toLocaleString()}</span>
                    </div>
                    
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-500">City:</span>
                            <span class="text-sm font-medium">${locationData.city || 'Unknown'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-500">State:</span>
                            <span class="text-sm font-medium">${locationData.state || 'Unknown'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-500">Coordinates:</span>
                            <span class="text-sm font-medium">${locationData.latitude?.toFixed(6)}, ${locationData.longitude?.toFixed(6)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-500">Accuracy:</span>
                            <span class="text-sm font-medium">${locationData.accuracy}m</span>
                        </div>
                    </div>
                    
                    <div class="mt-4 flex space-x-2">
                        <button onclick="openInMaps(${locationData.latitude}, ${locationData.longitude})" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded text-sm">
                            Open in Maps
                        </button>
                        <button onclick="getDirections(${locationData.latitude}, ${locationData.longitude})" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-3 rounded text-sm">
                            Get Directions
                        </button>
                    </div>
                </div>
            `;
        }

        function openInMaps(lat, lon) {
            const url = `https://www.google.com/maps?q=${lat},${lon}`;
            window.open(url, '_blank', 'noopener,noreferrer');
        }

        function getDirections(lat, lon) {
            const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`;
            window.open(url, '_blank', 'noopener,noreferrer');
        }

        // Device Actions
        async function getCurrentDeviceLocation() {
            if (!selectedDeviceId) {
                showNotification('Please select a device first', 'error');
                return;
            }
            
            try {
                showNotification('Requesting location from device...', 'info');
                
                // Send location request to device
                await database.ref('device_commands/' + selectedDeviceId).push({
                    command: 'GET_LOCATION',
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    requestedBy: currentUser.uid
                });
                
                logAuditEvent('LOCATION_REQUESTED', { deviceId: selectedDeviceId });
                showNotification('Location request sent to device', 'success');
                
                // Listen for location response
                listenForLocationResponse(selectedDeviceId);
                
            } catch (error) {
                showNotification('Error requesting location: ' + error.message, 'error');
            }
        }

        function listenForLocationResponse(deviceId) {
            const timeout = setTimeout(() => {
                showNotification('Location request timed out', 'error');
            }, 30000); // 30 second timeout
            
            database.ref('location_data')
                .orderByChild('deviceId')
                .equalTo(deviceId)
                .limitToLast(1)
                .on('child_added', (snapshot) => {
                    clearTimeout(timeout);
                    const locationData = snapshot.val();
                    
                    if (locationData.timestamp > Date.now() - 60000) { // Within last minute
                        displayDeviceLocation(locationData);
                        showNotification('Location updated successfully!', 'success');
                    }
                });
        }

        async function playDeviceAlarm() {
            if (!selectedDeviceId) {
                showNotification('Please select a device first', 'error');
                return;
            }
            
            try {
                await database.ref('device_commands/' + selectedDeviceId).push({
                    command: 'PLAY_ALARM',
                    duration: 30, // seconds
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    requestedBy: currentUser.uid
                });
                
                logAuditEvent('ALARM_SENT', { deviceId: selectedDeviceId });
                showNotification('Alarm sent to device', 'success');
                
            } catch (error) {
                showNotification('Error sending alarm: ' + error.message, 'error');
            }
        }

        async function lockDevice() {
            if (!selectedDeviceId) {
                showNotification('Please select a device first', 'error');
                return;
            }
            
            if (!confirm('Are you sure you want to lock this device?')) {
                return;
            }
            
            try {
                await database.ref('device_commands/' + selectedDeviceId).push({
                    command: 'LOCK_DEVICE',
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    requestedBy: currentUser.uid
                });
                
                logAuditEvent('DEVICE_LOCKED', { deviceId: selectedDeviceId });
                showNotification('Lock command sent to device', 'success');
                
            } catch (error) {
                showNotification('Error locking device: ' + error.message, 'error');
            }
        }

        async function sendMessageToDevice() {
            document.getElementById('sendMessageModal').classList.remove('hidden');
        }

        async function sendMessage() {
            if (!selectedDeviceId) {
                showNotification('Please select a device first', 'error');
                return;
            }
            
            const messageText = document.getElementById('messageText').value;
            const messageType = document.getElementById('messageType').value;
            
            if (!messageText.trim()) {
                showNotification('Please enter a message', 'error');
                return;
            }
            
            try {
                await database.ref('device_commands/' + selectedDeviceId).push({
                    command: 'SEND_MESSAGE',
                    message: messageText,
                    messageType: messageType,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    requestedBy: currentUser.uid
                });
                
                document.getElementById('sendMessageModal').classList.add('hidden');
                document.getElementById('messageForm').reset();
                
                logAuditEvent('MESSAGE_SENT', { 
                    deviceId: selectedDeviceId, 
                    messageType: messageType 
                });
                showNotification('Message sent to device', 'success');
                
            } catch (error) {
                showNotification('Error sending message: ' + error.message, 'error');
            }
        }

        // Live Location Tracking
        let liveLocationInterval = null;

        function startLiveLocationTracking() {
            document.getElementById('liveLocationModal').classList.remove('hidden');
            
            // Update live device status
            updateLiveDeviceStatus();
            
            // Start real-time updates
            liveLocationInterval = setInterval(() => {
                updateLiveDeviceStatus();
                updateLocationHistory();
            }, 30000); // Update every 30 seconds
        }

        function stopLiveLocationTracking() {
            if (liveLocationInterval) {
                clearInterval(liveLocationInterval);
                liveLocationInterval = null;
            }
        }

        function updateLiveDeviceStatus() {
            const container = document.getElementById('liveDeviceStatus');
            
            container.innerHTML = devices.map(device => `
                <div class="bg-white p-3 rounded-lg border">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-2">
                            <span class="w-2 h-2 ${device.status === 'online' ? 'bg-green-500' : 'bg-gray-400'} rounded-full"></span>
                            <span class="font-medium text-sm">${device.name}</span>
                        </div>
                        <span class="text-xs text-gray-500">${device.status}</span>
                    </div>
                    <div class="mt-2 text-xs text-gray-600">
                        Last seen: ${device.lastSeen ? new Date(device.lastSeen).toLocaleString() : 'Never'}
                    </div>
                </div>
            `).join('');
        }

        function updateLocationHistory() {
            const container = document.getElementById('locationHistory');
            
            // Get recent location data
            database.ref('location_data')
                .orderByChild('userId')
                .equalTo(currentUser.uid)
                .limitToLast(10)
                .once('value', (snapshot) => {
                    const locations = [];
                    snapshot.forEach((child) => {
                        locations.push(child.val());
                    });
                    
                    container.innerHTML = locations.reverse().map(location => `
                        <div class="text-xs p-2 bg-gray-50 rounded">
                            <div class="font-medium">${location.city || 'Unknown'}, ${location.state || 'Unknown'}</div>
                            <div class="text-gray-500">${new Date(location.timestamp).toLocaleString()}</div>
                        </div>
                    `).join('');
                });
        }

        // Real-time Location Tracking
        function startLocationTracking() {
            if (!currentUser) return;
            
            // Update location every 5 minutes
            setInterval(async () => {
                try {
                    const location = await getCurrentLocation();
                    
                    // Save to Firebase
                    await database.ref('location_data').push({
                        userId: currentUser.uid,
                        deviceId: 'current_device',
                        ...location,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                } catch (error) {
                    console.log('Location update failed:', error);
                }
            }, 300000); // 5 minutes
        }

        // Enhanced Authentication with Security Features
        let loginAttempts = 0;
        let lastLoginAttempt = 0;

        function login(email, password) {
            // Rate limiting
            const now = Date.now();
            if (loginAttempts >= SECURITY_CONFIG.maxLoginAttempts && 
                now - lastLoginAttempt < 300000) { // 5 minutes lockout
                throw new Error('Too many login attempts. Please try again later.');
            }

            return auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    loginAttempts = 0; // Reset on success
                    logAuditEvent('LOGIN_SUCCESS', { 
                        email: email,
                        deviceFingerprint: hashFingerprint(getDeviceFingerprint())
                    });
                    
                    // Capture device information on login
                    captureDeviceInfo(userCredential.user.uid);
                    
                    return userCredential;
                })
                .catch((error) => {
                    loginAttempts++;
                    lastLoginAttempt = now;
                    logAuditEvent('LOGIN_FAILED', { 
                        email: email, 
                        error: error.code,
                        attempt: loginAttempts
                    });
                    throw error;
                });
        }

        function register(email, password) {
            return auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const deviceFingerprint = getDeviceFingerprint();
                    
                    // Enhanced consent record with device info
                    const consentRecord = {
                        userId: userCredential.user.uid,
                        email: email,
                        consentGiven: true,
                        consentVersion: '2.0',
                        consentType: 'EXPLICIT_DEVICE_TRACKING',
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        ipAddress: 'masked_for_privacy',
                        userAgent: navigator.userAgent.substring(0, 200),
                        deviceFingerprint: hashFingerprint(deviceFingerprint),
                        legalBasis: 'CONSENT_GDPR_6_1_A',
                        dataRetentionDays: SECURITY_CONFIG.dataRetentionDays,
                        complianceFramework: SECURITY_CONFIG.complianceMode
                    };
                    
                    // Log registration
                    logAuditEvent('USER_REGISTERED', { 
                        email: email,
                        consentVersion: '2.0'
                    });
                    
                    // Capture initial device info
                    captureDeviceInfo(userCredential.user.uid);
                    
                    return database.ref('consent_records/' + userCredential.user.uid).set(consentRecord);
                });
        }

        function logout() {
            if (currentUser) {
                logAuditEvent('LOGOUT', { userId: currentUser.uid });
            }
            sessionStorage.removeItem('dozera_session_id');
            return auth.signOut();
        }

        // Device Information Capture
        function captureDeviceInfo(userId) {
            const deviceInfo = {
                userId: userId,
                fingerprint: getDeviceFingerprint(),
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                sessionId: getSessionId()
            };
            
            // Store device info for this session
            database.ref('device_sessions').push(deviceInfo);
            
            // Try to get location if permitted
            getCurrentLocation()
                .then((location) => {
                    const locationData = {
                        userId: userId,
                        ...location,
                        source: 'web_browser',
                        sessionId: getSessionId(),
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };
                    
                    database.ref('location_data').push(locationData);
                    logAuditEvent('LOCATION_CAPTURED', { 
                        accuracy: location.accuracy,
                        source: 'web_browser'
                    });
                })
                .catch((error) => {
                    logAuditEvent('LOCATION_DENIED', { 
                        error: error.message 
                    });
                });
        }

        // Data Retention and Cleanup
        function scheduleDataCleanup() {
            const cutoffDate = Date.now() - (SECURITY_CONFIG.dataRetentionDays * 24 * 60 * 60 * 1000);
            
            // This would typically run server-side
            database.ref('location_data')
                .orderByChild('timestamp')
                .endAt(cutoffDate)
                .once('value', (snapshot) => {
                    const updates = {};
                    snapshot.forEach((child) => {
                        updates[child.key] = null; // Mark for deletion
                    });
                    
                    if (Object.keys(updates).length > 0) {
                        database.ref('location_data').update(updates);
                        logAuditEvent('DATA_CLEANUP', { 
                            recordsDeleted: Object.keys(updates).length,
                            cutoffDate: new Date(cutoffDate).toISOString()
                        });
                    }
                });
        }

        // Device Management
        function addDevice(deviceData) {
            if (!currentUser) return Promise.reject('Not authenticated');
            
            const deviceId = database.ref().child('devices').push().key;
            const device = {
                id: deviceId,
                userId: currentUser.uid,
                name: deviceData.name,
                type: deviceData.type,
                model: deviceData.model,
                status: 'enrolled',
                enrollmentDate: firebase.database.ServerValue.TIMESTAMP,
                lastSeen: null,
                consentGiven: true,
                trackingEnabled: true
            };

            return database.ref('devices/' + deviceId).set(device);
        }

        function loadUserDevices() {
            if (!currentUser) return;

            database.ref('devices').orderByChild('userId').equalTo(currentUser.uid)
                .on('value', (snapshot) => {
                    devices = [];
                    snapshot.forEach((childSnapshot) => {
                        devices.push({
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    });
                    updateDeviceList();
                    updateStats();
                });
        }

        function updateDeviceList() {
            const deviceList = document.getElementById('deviceList');
            
            if (devices.length === 0) {
                deviceList.innerHTML = `
                    <li class="px-4 py-4 text-center text-gray-500">
                        <div class="text-sm">Detecting devices...</div>
                        <div class="text-xs mt-1">Please wait while we collect device information</div>
                    </li>
                `;
                return;
            }

            deviceList.innerHTML = devices.map(device => {
                const statusColor = device.status === 'online' ? 'green' : 
                                  device.status === 'enrolled' ? 'yellow' : 'red';
                const lastSeen = device.lastSeen ? 
                    new Date(device.lastSeen).toLocaleString() : 'Just now';

                // Get location info if available
                const locationText = allDeviceData.locationInfo && !allDeviceData.locationInfo.error ? 
                    `üìç ${allDeviceData.locationInfo.city}, ${allDeviceData.locationInfo.state}` : 
                    allDeviceData.ipInfo ? `üìç ${allDeviceData.ipInfo.city}, ${allDeviceData.ipInfo.region}` : 'üìç Location unavailable';

                return `
                    <li class="device-card cursor-pointer hover:bg-gray-50" onclick="showDeviceDetails('${device.id}')">
                        <div class="px-4 py-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-12 w-12">
                                        <div class="h-12 w-12 rounded-full bg-${statusColor}-100 flex items-center justify-center">
                                            ${getDeviceIcon(device.type)}
                                        </div>
                                    </div>
                                    <div class="ml-4">
                                        <div class="text-sm font-medium text-gray-900">${device.name}</div>
                                        <div class="text-sm text-gray-500">${device.type} ‚Ä¢ ${device.model || 'Unknown Model'}</div>
                                        <div class="text-xs text-gray-400">${device.browser || ''}</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm text-gray-900 capitalize flex items-center">
                                        <span class="inline-block w-2 h-2 bg-${statusColor}-500 rounded-full mr-2 status-online"></span>
                                        ${device.status}
                                    </div>
                                    <div class="text-sm text-gray-500">Last seen: ${lastSeen}</div>
                                </div>
                            </div>
                            <div class="mt-2 text-xs text-gray-600">
                                ${locationText}
                            </div>
                            ${allDeviceData.ipInfo ? `
                                <div class="mt-1 text-xs text-gray-500">
                                    üåê ${allDeviceData.ipInfo.isp} ‚Ä¢ IP: ${allDeviceData.ipInfo.ip}
                                </div>
                            ` : ''}
                        </div>
                    </li>
                `;
            }).join('');
        }

        function getDeviceIcon(deviceType) {
            const icons = {
                'smartphone': `<svg class="h-7 w-7 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7 2a2 2 0 00-2 2v12a2 2 0 002 2h6a2 2 0 002-2V4a2 2 0 00-2-2H7zM8 4h4v10H8V4z" clip-rule="evenodd"></path>
                </svg>`,
                'tablet': `<svg class="h-7 w-7 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v10H5V4z" clip-rule="evenodd"></path>
                </svg>`,
                'desktop/laptop': `<svg class="h-7 w-7 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v8a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm2 2v4h10V6H5z" clip-rule="evenodd"></path>
                </svg>`
            };
            
            return icons[deviceType.toLowerCase()] || icons['smartphone'];
        }

        function updateStats() {
            const activeDevices = devices.filter(d => d.status === 'online').length;
            const totalLocations = Object.keys(locationData).reduce((sum, deviceId) => {
                return sum + (locationData[deviceId] ? locationData[deviceId].length : 0);
            }, 0);

            document.getElementById('activeDevices').textContent = activeDevices;
            document.getElementById('locationsTracked').textContent = totalLocations;
            document.getElementById('securityAlerts').textContent = '0';
            document.getElementById('dataPoints').textContent = devices.length * 24; // Simulated
        }

        function showDeviceDetails(deviceId) {
            const device = devices.find(d => d.id === deviceId);
            if (!device) return;

            document.getElementById('deviceDetailsTitle').textContent = device.name;
            
            const content = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <h4 class="font-medium text-gray-900">Device Information</h4>
                        <div class="bg-gray-50 p-4 rounded-lg space-y-2">
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-500">Device ID:</span>
                                <span class="text-sm font-mono">${device.id.substring(0, 8)}...</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-500">Type:</span>
                                <span class="text-sm capitalize">${device.type}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-500">Model:</span>
                                <span class="text-sm">${device.model || 'Unknown'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-500">Status:</span>
                                <span class="text-sm capitalize ${device.status === 'online' ? 'text-green-600' : 'text-yellow-600'}">${device.status}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-500">Enrolled:</span>
                                <span class="text-sm">${new Date(device.enrollmentDate).toLocaleDateString()}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <h4 class="font-medium text-gray-900">Privacy & Consent</h4>
                        <div class="bg-green-50 p-4 rounded-lg space-y-2">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="text-sm text-green-800">Consent Given</span>
                            </div>
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="text-sm text-green-800">Tracking Authorized</span>
                            </div>
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="text-sm text-green-800">Data Encrypted</span>
                            </div>
                        </div>
                        
                        <div class="space-y-2">
                            <button class="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-md text-sm font-medium" onclick="revokeDeviceConsent('${device.id}')">
                                Revoke Tracking Consent
                            </button>
                            <button class="w-full bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-md text-sm font-medium" onclick="removeDevice('${device.id}')">
                                Remove Device
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6">
                    <h4 class="font-medium text-gray-900 mb-4">Recent Location History</h4>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600 text-center py-8">
                            <svg class="w-12 h-12 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            <p>No location data available</p>
                            <p class="text-xs mt-1">Install the mobile app on this device to begin tracking</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('deviceDetailsContent').innerHTML = content;
            deviceDetailsModal.classList.remove('hidden');
        }

        function revokeDeviceConsent(deviceId) {
            if (confirm('Are you sure you want to revoke tracking consent for this device? This will stop all location tracking immediately.')) {
                database.ref('devices/' + deviceId + '/trackingEnabled').set(false);
                database.ref('devices/' + deviceId + '/status').set('consent_revoked');
                deviceDetailsModal.classList.add('hidden');
                showNotification('Tracking consent revoked successfully', 'success');
            }
        }

        function removeDevice(deviceId) {
            if (confirm('Are you sure you want to remove this device? All associated data will be permanently deleted.')) {
                database.ref('devices/' + deviceId).remove();
                deviceDetailsModal.classList.add('hidden');
                showNotification('Device removed successfully', 'success');
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-md shadow-lg ${
                type === 'success' ? 'bg-green-500 text-white' : 
                type === 'error' ? 'bg-red-500 text-white' : 
                'bg-blue-500 text-white'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Enhanced Modal and Feature Functions
        function loadAuditLogs() {
            if (!currentUser) return;
            
            database.ref('audit_logs')
                .orderByChild('userId')
                .equalTo(currentUser.uid)
                .limitToLast(50)
                .once('value', (snapshot) => {
                    const logs = [];
                    snapshot.forEach((child) => {
                        logs.push({
                            id: child.key,
                            ...child.val()
                        });
                    });
                    
                    displayAuditLogs(logs.reverse());
                });
        }

        function displayAuditLogs(logs) {
            const container = document.getElementById('auditLogsList');
            
            if (logs.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-gray-500">No audit logs found</div>';
                return;
            }
            
            container.innerHTML = `
                <div class="divide-y divide-gray-200">
                    ${logs.map(log => `
                        <div class="p-4 hover:bg-gray-50">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="flex-shrink-0">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getActionColor(log.action)}">
                                            ${log.action}
                                        </span>
                                    </div>
                                    <div class="min-w-0 flex-1">
                                        <p class="text-sm font-medium text-gray-900">${formatLogDetails(log)}</p>
                                        <p class="text-sm text-gray-500">${new Date(log.timestamp).toLocaleString()}</p>
                                    </div>
                                </div>
                                <div class="text-xs text-gray-400">
                                    Session: ${log.sessionId ? log.sessionId.substring(0, 8) + '...' : 'N/A'}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function getActionColor(action) {
            const colors = {
                'LOGIN_SUCCESS': 'bg-green-100 text-green-800',
                'LOGIN_FAILED': 'bg-red-100 text-red-800',
                'DEVICE_ADDED': 'bg-blue-100 text-blue-800',
                'LOCATION_CAPTURED': 'bg-purple-100 text-purple-800',
                'CONSENT_REVOKED': 'bg-yellow-100 text-yellow-800'
            };
            return colors[action] || 'bg-gray-100 text-gray-800';
        }

        function formatLogDetails(log) {
            switch (log.action) {
                case 'LOGIN_SUCCESS':
                    return `Successful login from ${log.details?.deviceFingerprint ? 'recognized device' : 'new device'}`;
                case 'LOGIN_FAILED':
                    return `Failed login attempt (${log.details?.error || 'unknown error'})`;
                case 'DEVICE_ADDED':
                    return `New device enrolled: ${log.details?.deviceName || 'Unknown Device'}`;
                case 'LOCATION_CAPTURED':
                    return `Location captured with ${log.details?.accuracy}m accuracy`;
                case 'CONSENT_REVOKED':
                    return `Tracking consent revoked for device`;
                default:
                    return log.action.replace(/_/g, ' ').toLowerCase();
            }
        }

        function exportUserData() {
            if (!currentUser) return;
            
            const exportData = {
                user: {
                    uid: currentUser.uid,
                    email: currentUser.email,
                    exportDate: new Date().toISOString()
                },
                devices: devices,
                locationData: locationData,
                consentRecords: {},
                auditLogs: {}
            };
            
            // Get consent records
            database.ref('consent_records/' + currentUser.uid).once('value', (snapshot) => {
                exportData.consentRecords = snapshot.val() || {};
                
                // Get audit logs
                database.ref('audit_logs').orderByChild('userId').equalTo(currentUser.uid).once('value', (snapshot) => {
                    const logs = {};
                    snapshot.forEach((child) => {
                        logs[child.key] = child.val();
                    });
                    exportData.auditLogs = logs;
                    
                    // Create and download file
                    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `dozera-data-export-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    logAuditEvent('DATA_EXPORTED', { format: 'JSON' });
                    showNotification('Data export completed successfully!', 'success');
                });
            });
        }

        function deleteAllUserData() {
            if (!currentUser) return;
            
            const confirmText = 'DELETE ALL MY DATA';
            const userInput = prompt(`This will permanently delete ALL your data and cannot be undone.\n\nType "${confirmText}" to confirm:`);
            
            if (userInput === confirmText) {
                logAuditEvent('DATA_DELETION_REQUESTED', { timestamp: Date.now() });
                
                // Delete user devices
                devices.forEach(device => {
                    database.ref('devices/' + device.id).remove();
                });
                
                // Delete location data
                database.ref('location_data').orderByChild('userId').equalTo(currentUser.uid).once('value', (snapshot) => {
                    const updates = {};
                    snapshot.forEach((child) => {
                        updates[child.key] = null;
                    });
                    database.ref('location_data').update(updates);
                });
                
                // Delete consent records
                database.ref('consent_records/' + currentUser.uid).remove();
                
                // Mark audit logs for deletion (keep for legal compliance period)
                database.ref('audit_logs').orderByChild('userId').equalTo(currentUser.uid).once('value', (snapshot) => {
                    const updates = {};
                    snapshot.forEach((child) => {
                        updates[child.key + '/deleted'] = true;
                        updates[child.key + '/deletionDate'] = firebase.database.ServerValue.TIMESTAMP;
                    });
                    database.ref('audit_logs').update(updates);
                });
                
                // Delete user account
                currentUser.delete().then(() => {
                    showNotification('All data deleted successfully. Account closed.', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                }).catch((error) => {
                    showNotification('Error deleting account: ' + error.message, 'error');
                });
            }
        }

        // Event Listeners
        document.getElementById('googleSignInBtn').addEventListener('click', signInWithGoogle);
        document.getElementById('setMpinBtn').addEventListener('click', setMPIN);
        document.getElementById('verifyMpinBtn').addEventListener('click', verifyMPIN);
        
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            const enteredMpin = prompt('Enter your MPIN to logout:');
            if (!enteredMpin) return;
            
            const hashedEntered = btoa(enteredMpin + currentUser.uid).substring(0, 16);
            
            if (hashedEntered === userMPIN) {
                try {
                    await auth.signOut();
                    sessionStorage.clear();
                    localStorage.clear();
                    window.location.reload();
                } catch (error) {
                    showNotification('Error signing out: ' + error.message, 'error');
                }
            } else {
                showNotification('Incorrect MPIN', 'error');
            }
        });

        // Track Other Device Events
        document.getElementById('trackOtherDeviceBtn').addEventListener('click', () => {
            document.getElementById('trackOtherModal').classList.remove('hidden');
        });

        document.getElementById('closeTrackOther').addEventListener('click', () => {
            document.getElementById('trackOtherModal').classList.add('hidden');
        });

        document.getElementById('getLocationBtn').addEventListener('click', getCurrentDeviceLocation);
        document.getElementById('playAlarmBtn').addEventListener('click', playDeviceAlarm);
        document.getElementById('lockDeviceBtn').addEventListener('click', lockDevice);
        document.getElementById('sendMessageBtn').addEventListener('click', sendMessageToDevice);

        // Live Location Events
        document.getElementById('liveLocationBtn').addEventListener('click', startLiveLocationTracking);
        document.getElementById('closeLiveLocation').addEventListener('click', () => {
            document.getElementById('liveLocationModal').classList.add('hidden');
            stopLiveLocationTracking();
        });

        // Send Alarm Event
        document.getElementById('sendAlarmBtn').addEventListener('click', () => {
            if (devices.length === 0) {
                showNotification('No devices available to send alarm', 'error');
                return;
            }
            
            // Send alarm to all devices
            devices.forEach(async (device) => {
                try {
                    await database.ref('device_commands/' + device.id).push({
                        command: 'PLAY_ALARM',
                        duration: 60, // 1 minute
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        requestedBy: currentUser.uid
                    });
                } catch (error) {
                    console.error('Error sending alarm to device:', device.id, error);
                }
            });
            
            logAuditEvent('ALARM_SENT_ALL_DEVICES', { deviceCount: devices.length });
            showNotification(`Alarm sent to ${devices.length} devices`, 'success');
        });

        // Message Modal Events
        document.getElementById('closeSendMessage').addEventListener('click', () => {
            document.getElementById('sendMessageModal').classList.add('hidden');
        });

        document.getElementById('cancelMessage').addEventListener('click', () => {
            document.getElementById('sendMessageModal').classList.add('hidden');
        });

        document.getElementById('messageForm').addEventListener('submit', (e) => {
            e.preventDefault();
            sendMessage();
        });

        // MPIN Input Events
        document.getElementById('newMpin').addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/\D/g, ''); // Only digits
        });

        document.getElementById('confirmMpin').addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/\D/g, ''); // Only digits
        });

        document.getElementById('verifyMpin').addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/\D/g, ''); // Only digits
            if (e.target.value.length === 4) {
                // Auto-verify when 4 digits entered
                setTimeout(verifyMPIN, 100);
            }
        });

        // Compliance Dashboard Events
        document.getElementById('complianceBtn').addEventListener('click', () => {
            document.getElementById('complianceModal').classList.remove('hidden');
        });

        document.getElementById('closeCompliance').addEventListener('click', () => {
            document.getElementById('complianceModal').classList.add('hidden');
        });

        // Audit Logs Events
        document.getElementById('auditLogBtn').addEventListener('click', () => {
            document.getElementById('auditModal').classList.remove('hidden');
            loadAuditLogs();
        });

        document.getElementById('closeAudit').addEventListener('click', () => {
            document.getElementById('auditModal').classList.add('hidden');
        });

        document.getElementById('exportAuditBtn').addEventListener('click', () => {
            // Export audit logs functionality
            showNotification('Audit logs export started...', 'info');
        });

        // Privacy Controls Events
        document.getElementById('privacyControlsBtn').addEventListener('click', () => {
            document.getElementById('privacyModal').classList.remove('hidden');
        });

        document.getElementById('closePrivacy').addEventListener('click', () => {
            document.getElementById('privacyModal').classList.add('hidden');
        });

        document.getElementById('exportDataBtn').addEventListener('click', exportUserData);
        document.getElementById('deleteAccountBtn').addEventListener('click', deleteAllUserData);



        document.getElementById('addDeviceBtn').addEventListener('click', () => {
            addDeviceModal.classList.remove('hidden');
        });

        document.getElementById('cancelAddDevice').addEventListener('click', () => {
            addDeviceModal.classList.add('hidden');
        });

        document.getElementById('closeDeviceDetails').addEventListener('click', () => {
            deviceDetailsModal.classList.add('hidden');
        });

        document.getElementById('addDeviceForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const deviceData = {
                name: document.getElementById('deviceName').value,
                type: document.getElementById('deviceType').value,
                model: document.getElementById('deviceModel').value
            };
            
            addDevice(deviceData)
                .then(() => {
                    addDeviceModal.classList.add('hidden');
                    document.getElementById('addDeviceForm').reset();
                    logAuditEvent('DEVICE_ADDED', { deviceName: deviceData.name, deviceType: deviceData.type });
                    showNotification('Device added successfully!', 'success');
                })
                .catch((error) => {
                    showNotification('Failed to add device: ' + error.message, 'error');
                });
        });

        // Simulate some real-time updates
        setInterval(() => {
            if (currentUser && devices.length > 0) {
                // Simulate device status updates
                const randomDevice = devices[Math.floor(Math.random() * devices.length)];
                if (randomDevice && Math.random() > 0.7) {
                    const newStatus = Math.random() > 0.5 ? 'online' : 'enrolled';
                    database.ref('devices/' + randomDevice.id + '/status').set(newStatus);
                    database.ref('devices/' + randomDevice.id + '/lastSeen').set(firebase.database.ServerValue.TIMESTAMP);
                }
            }
        }, 10000);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'993f7913d2c85959',t:'MTc2MTM3MTgxMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
