<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radio Imaging Technology Portal</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        medical: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            900: '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .chat-bubble { max-width: 80%; padding: 12px 16px; border-radius: 12px; margin-bottom: 10px; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .gallery-item:hover .gallery-overlay { opacity: 1; }
        .gallery-overlay { opacity: 0; transition: opacity 0.3s ease; }
        .glass-effect { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .spinner { border: 3px solid rgba(0, 0, 0, 0.1); border-radius: 50%; border-top: 3px solid #0ea5e9; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans min-h-screen flex flex-col">

    <!-- Navigation -->
    <nav class="sticky top-0 z-50 glass-effect border-b border-gray-200 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center cursor-pointer" onclick="router('home')">
                    <i class="fa-solid fa-x-ray text-medical-600 text-2xl mr-2"></i>
                    <span class="font-bold text-xl tracking-tight text-gray-900">RadTech<span class="text-medical-600">Portal</span></span>
                </div>
                
                <!-- Desktop Menu -->
                <div class="hidden md:flex items-center space-x-4">
                    <button onclick="router('home')" class="nav-link px-3 py-2 text-gray-600 hover:text-medical-600 font-medium transition">Home</button>
                    <button onclick="router('syllabus')" class="nav-link px-3 py-2 text-gray-600 hover:text-medical-600 font-medium transition">Syllabus</button>
                    <button onclick="router('qbank')" class="nav-link px-3 py-2 text-gray-600 hover:text-medical-600 font-medium transition">Q-Bank</button>
                    <button onclick="router('community')" class="nav-link px-3 py-2 text-gray-600 hover:text-medical-600 font-medium transition relative">
                        Community <span class="absolute top-0 right-0 -mt-1 -mr-1 flex h-3 w-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span></span>
                    </button>
                    <button onclick="router('gallery')" class="nav-link px-3 py-2 text-gray-600 hover:text-medical-600 font-medium transition">Gallery</button>
                    <button onclick="router('ai-help')" class="px-4 py-2 rounded-full bg-medical-600 text-white hover:bg-medical-700 transition flex items-center shadow-md">
                        <i class="fa-solid fa-robot mr-2"></i> AI Help
                    </button>
                </div>

                <!-- Mobile Menu Button -->
                <div class="md:hidden flex items-center">
                    <button onclick="toggleMobileMenu()" class="text-gray-600 hover:text-gray-900 focus:outline-none">
                        <i class="fa-solid fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-white border-t border-gray-100">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <button onclick="router('home'); toggleMobileMenu()" class="block w-full text-left px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-medical-600 hover:bg-gray-50">Home</button>
                <button onclick="router('community'); toggleMobileMenu()" class="block w-full text-left px-3 py-2 rounded-md text-base font-medium text-medical-600 font-bold bg-green-50">Community Forum</button>
                <button onclick="router('qbank'); toggleMobileMenu()" class="block w-full text-left px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-medical-600 hover:bg-gray-50">Question Bank</button>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main id="app-content" class="flex-grow">
        
        <!-- HOME SECTION -->
        <section id="home" class="view-section animate-fade-in">
            <!-- Hero -->
            <div class="bg-gradient-to-r from-medical-700 to-medical-900 text-white py-20">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col md:flex-row items-center">
                    <div class="md:w-1/2 mb-10 md:mb-0">
                        <span class="bg-white/20 text-white text-xs font-bold px-3 py-1 rounded-full mb-4 inline-block">Updated 2024 Syllabus</span>
                        <h1 class="text-4xl md:text-5xl font-bold mb-4 leading-tight">Master Radiology & Imaging Technology</h1>
                        <p class="text-lg text-medical-100 mb-8">Access 100k+ Questions, discuss doubts in our Community, and use AI support for your BRIT studies.</p>
                        <div class="flex flex-wrap gap-4">
                            <button onclick="router('community')" class="bg-white text-medical-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition shadow-lg">Ask Community</button>
                            <button onclick="router('qbank')" class="bg-transparent border-2 border-white text-white px-6 py-3 rounded-lg font-semibold hover:bg-white/10 transition">Start Practicing</button>
                        </div>
                    </div>
                    <div class="md:w-1/2 flex justify-center">
                        <div class="bg-white/10 p-6 rounded-2xl backdrop-blur-sm border border-white/20 shadow-xl w-full max-w-md text-center">
                            <div class="grid grid-cols-2 gap-4">
                                <div onclick="router('community')" class="cursor-pointer bg-white/10 p-4 rounded-lg hover:bg-white/20 transition">
                                    <div class="text-3xl font-bold text-yellow-400"><i class="fa-solid fa-users"></i></div>
                                    <div class="text-sm text-white/80">Community</div>
                                </div>
                                <div class="bg-white/10 p-4 rounded-lg">
                                    <div class="text-3xl font-bold text-green-400">100k+</div>
                                    <div class="text-sm text-white/80">Questions</div>
                                </div>
                                <div class="bg-white/10 p-4 rounded-lg">
                                    <div class="text-3xl font-bold text-blue-400">HD</div>
                                    <div class="text-sm text-white/80">Gallery</div>
                                </div>
                                <div class="bg-white/10 p-4 rounded-lg">
                                    <div class="text-3xl font-bold text-purple-400">AI</div>
                                    <div class="text-sm text-white/80">Tutor</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- COMMUNITY SECTION (FIREBASE) -->
        <section id="community" class="view-section hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800"><i class="fa-solid fa-comments text-medical-600 mr-2"></i> Community Forum</h2>
                    <p class="text-gray-500 text-sm">Can't find an answer? Ask your peers!</p>
                </div>
                <button onclick="document.getElementById('ask-modal').classList.remove('hidden')" class="bg-medical-600 text-white px-4 py-2 rounded-lg shadow hover:bg-medical-700 transition flex items-center">
                    <i class="fa-solid fa-plus mr-2"></i> Ask Question
                </button>
            </div>

            <div id="community-loading" class="flex justify-center py-12">
                <div class="spinner"></div>
            </div>

            <div id="community-feed" class="space-y-6">
                <!-- Dynamic Content from Firebase -->
            </div>
        </section>

        <!-- SYLLABUS SECTION -->
        <section id="syllabus" class="view-section hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
            <h2 class="text-3xl font-bold mb-6 text-gray-800 flex items-center">
                <i class="fa-solid fa-graduation-cap text-medical-600 mr-3"></i> Syllabus
            </h2>
            <!-- Filters -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select State</label>
                        <select id="syllabus-state" onchange="renderSyllabus()" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-medical-500 focus:ring-medical-500 border p-2">
                            <option value="All">All States (General)</option>
                            <option value="Punjab">Punjab</option>
                            <option value="Delhi">Delhi</option>
                            <option value="Maharashtra">Maharashtra</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Year/Semester</label>
                        <select id="syllabus-year" onchange="renderSyllabus()" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-medical-500 focus:ring-medical-500 border p-2">
                            <option value="1">Year 1 (Anatomy & Physiology)</option>
                            <option value="2">Year 2 (Radiography Physics)</option>
                            <option value="3">Year 3 (Modern Imaging)</option>
                        </select>
                    </div>
                </div>
            </div>
            <div id="syllabus-content" class="space-y-4"></div>
        </section>

        <!-- QUESTION BANK SECTION -->
        <section id="qbank" class="view-section hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800"><i class="fa-solid fa-list-check text-medical-600 mr-2"></i> Question Bank</h2>
                    <p class="text-sm text-gray-500 mt-1">100,000+ Entries Available</p>
                </div>
                <div class="mt-4 md:mt-0 w-full md:w-1/3 relative">
                    <input type="text" id="qbank-search" oninput="resetPaginationAndFilter()" placeholder="Search..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-medical-500">
                    <i class="fa-solid fa-search absolute left-3 top-3 text-gray-400"></i>
                </div>
            </div>
            <div class="flex space-x-2 mb-6 overflow-x-auto pb-2 scrollbar-hide">
                <button onclick="setQFilter('All')" class="q-filter active px-4 py-2 rounded-lg bg-medical-100 text-medical-700 font-medium">All</button>
                <button onclick="setQFilter('Anatomy')" class="q-filter px-4 py-2 rounded-lg bg-gray-100 text-gray-600 font-medium">Anatomy</button>
                <button onclick="setQFilter('Physics')" class="q-filter px-4 py-2 rounded-lg bg-gray-100 text-gray-600 font-medium">Rad Physics</button>
            </div>
            <div id="questions-container" class="grid grid-cols-1 gap-4 mb-8"></div>
            <div class="flex justify-between items-center bg-white p-4 rounded-lg border border-gray-200">
                <button onclick="changePage(-1)" class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50">Previous</button>
                <span class="text-gray-600 font-medium" id="page-indicator">Page 1</span>
                <button onclick="changePage(1)" class="px-4 py-2 bg-medical-600 text-white rounded hover:bg-medical-700">Next</button>
            </div>
        </section>

        <!-- GALLERY SECTION -->
        <section id="gallery" class="view-section hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
            <h2 class="text-3xl font-bold mb-8 text-gray-800"><i class="fa-solid fa-images text-medical-600 mr-2"></i> Anatomy Gallery</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6" id="gallery-grid"></div>
        </section>

        <!-- AI HELP SECTION -->
        <section id="ai-help" class="view-section hidden h-[calc(100vh-64px)] bg-gray-100 flex flex-col">
            <div class="flex-grow overflow-y-auto p-4 md:p-8" id="chat-history">
                <div class="flex justify-start mb-4">
                    <div class="bg-white text-gray-800 p-4 rounded-2xl rounded-tl-none shadow-sm max-w-lg border border-gray-200">
                        <div class="font-bold text-medical-600 mb-1 flex items-center"><i class="fa-solid fa-robot mr-2"></i> MedBot</div>
                        <p>Hello! Ask me about X-ray Positioning, MRI Sequences, or Radiation Safety.</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 border-t border-gray-200">
                <div class="max-w-4xl mx-auto flex gap-2">
                    <input type="text" id="ai-input" class="flex-grow border border-gray-300 rounded-full px-6 py-3 focus:outline-none focus:ring-2 focus:ring-medical-500" placeholder="Ask a medical question...">
                    <button onclick="sendMessage()" class="bg-medical-600 text-white rounded-full w-12 h-12 flex items-center justify-center hover:bg-medical-700 transition">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </section>

    </main>

    <!-- ASK QUESTION MODAL -->
    <div id="ask-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-lg shadow-2xl animate-fade-in p-6">
            <h3 class="font-bold text-xl text-gray-800 mb-4">Ask the Community</h3>
            <textarea id="ask-text" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-medical-500 h-32" placeholder="Type your question here..."></textarea>
            
            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Attach Image (Optional)</label>
                <input type="file" id="ask-image" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-medical-50 file:text-medical-700 hover:file:bg-medical-100">
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="document.getElementById('ask-modal').classList.add('hidden')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
                <button onclick="postQuestion()" id="btn-post-q" class="px-6 py-2 bg-medical-600 text-white rounded-lg hover:bg-medical-700 flex items-center">
                    <span>Post Question</span>
                </button>
            </div>
        </div>
    </div>

    <!-- IMAGE PREVIEW MODAL -->
    <div id="image-modal" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden flex items-center justify-center p-4" onclick="closeImageModal()">
        <img id="modal-img" src="" alt="Full View" class="max-h-[90vh] max-w-[90vw] rounded-lg shadow-2xl">
    </div>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, doc, updateDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyC30TcmMVhP_8HdFYS1WufRiZwSDYNMTF0",
            authDomain: "pulse2-92372.firebaseapp.com",
            databaseURL: "https://pulse2-92372-default-rtdb.firebaseio.com",
            projectId: "pulse2-92372",
            storageBucket: "pulse2-92372.firebasestorage.app",
            messagingSenderId: "276235725177",
            appId: "1:276235725177:web:0f4e0789fae80a435927a8"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Sign In Anonymously
        let currentUser = null;
        signInAnonymously(auth).then((userCredential) => {
            currentUser = userCredential.user;
            console.log("Logged in anonymously:", currentUser.uid);
            initCommunity();
        }).catch((error) => {
            console.error("Auth Error:", error);
        });

        // --- APP ID ---
        const appId = 'rad-tech-portal-v1';

        // --- UTILS: BASE64 IMAGE COMPRESSION ---
        window.processImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800; 
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7)); // Compress to 0.7 quality
                    };
                };
                reader.onerror = (error) => reject(error);
            });
        };

        // --- COMMUNITY LOGIC ---
        function initCommunity() {
            const feed = document.getElementById('community-feed');
            const loading = document.getElementById('community-loading');
            
            // Using a simple query. Note: Compound queries/ordering require indexing.
            // We will fetch and sort in client to avoid index creation errors for this demo.
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'community_questions');

            onSnapshot(q, (snapshot) => {
                loading.style.display = 'none';
                const questions = [];
                snapshot.forEach(doc => questions.push({ id: doc.id, ...doc.data() }));
                
                // Sort by timestamp desc in JS
                questions.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                if (questions.length === 0) {
                    feed.innerHTML = `<div class="text-center text-gray-500 py-10">No questions yet. Be the first to ask!</div>`;
                    return;
                }

                feed.innerHTML = questions.map(q => `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                        <div class="flex items-start justify-between">
                            <div class="flex-grow">
                                <p class="text-xs text-gray-400 mb-1">User: ${q.userId ? q.userId.substring(0, 6) : 'Anon'} â€¢ ${new Date(q.timestamp).toLocaleDateString()}</p>
                                <h3 class="text-lg font-bold text-gray-900 mb-2">${escapeHtml(q.text)}</h3>
                                ${q.image ? `<img src="${q.image}" class="mt-2 rounded-lg max-h-48 cursor-pointer border border-gray-100" onclick="window.openImageModal('${q.image}')">` : ''}
                            </div>
                        </div>
                        
                        <div class="mt-4 pt-4 border-t border-gray-100">
                            <button onclick="window.toggleAnswers('${q.id}')" class="text-medical-600 text-sm font-medium hover:text-medical-800 flex items-center">
                                <i class="fa-regular fa-comment-dots mr-2"></i> ${q.answerCount || 0} Answers / Reply
                            </button>
                            
                            <!-- Answers Section (Hidden by default) -->
                            <div id="answers-${q.id}" class="hidden mt-4 bg-gray-50 rounded-lg p-4">
                                <div id="answers-list-${q.id}" class="space-y-3 mb-4">
                                    <div class="flex justify-center"><div class="spinner"></div></div>
                                </div>
                                
                                <!-- Post Answer Form -->
                                <div class="flex flex-col gap-2">
                                    <textarea id="reply-text-${q.id}" class="w-full text-sm border border-gray-300 rounded p-2" placeholder="Write an answer..."></textarea>
                                    <div class="flex justify-between items-center">
                                        <input type="file" id="reply-image-${q.id}" accept="image/*" class="text-xs text-gray-500">
                                        <button onclick="window.postAnswer('${q.id}')" class="bg-gray-800 text-white text-xs px-3 py-1.5 rounded hover:bg-black">Post Reply</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            });
        }

        window.postQuestion = async () => {
            const btn = document.getElementById('btn-post-q');
            const text = document.getElementById('ask-text').value;
            const fileInput = document.getElementById('ask-image');
            
            if (!text.trim()) return alert("Please type a question.");
            if (!currentUser) return alert("Initializing... please wait.");

            btn.disabled = true;
            btn.innerHTML = `<div class="spinner border-white border-t-transparent mr-2 w-4 h-4"></div> Posting...`;

            try {
                let base64Img = null;
                if (fileInput.files.length > 0) {
                    base64Img = await window.processImage(fileInput.files[0]);
                }

                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'community_questions'), {
                    text: text,
                    image: base64Img,
                    timestamp: Date.now(),
                    userId: currentUser.uid,
                    answerCount: 0
                });

                document.getElementById('ask-modal').classList.add('hidden');
                document.getElementById('ask-text').value = '';
                fileInput.value = '';
            } catch (e) {
                console.error(e);
                alert("Error posting question.");
            }
            btn.disabled = false;
            btn.innerHTML = `Post Question`;
        };

        window.toggleAnswers = (qId) => {
            const div = document.getElementById(`answers-${qId}`);
            const isHidden = div.classList.contains('hidden');
            div.classList.toggle('hidden');

            if (isHidden) {
                // Fetch answers
                const q = collection(db, 'artifacts', appId, 'public', 'data', 'community_answers');
                // We filter in memory for simplicity/robustness without indexes
                onSnapshot(q, (snapshot) => {
                    const answers = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.questionId === qId) answers.push(data);
                    });
                    answers.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));

                    const list = document.getElementById(`answers-list-${qId}`);
                    if (answers.length === 0) {
                        list.innerHTML = `<p class="text-xs text-gray-500 italic">No answers yet.</p>`;
                    } else {
                        list.innerHTML = answers.map(a => `
                            <div class="bg-white p-2 rounded border border-gray-200">
                                <p class="text-sm text-gray-800">${escapeHtml(a.text)}</p>
                                ${a.image ? `<img src="${a.image}" class="mt-2 rounded max-h-32 border cursor-pointer" onclick="window.openImageModal('${a.image}')">` : ''}
                                <p class="text-[10px] text-gray-400 mt-1">${new Date(a.timestamp).toLocaleTimeString()}</p>
                            </div>
                        `).join('');
                    }
                });
            }
        };

        window.postAnswer = async (qId) => {
            const text = document.getElementById(`reply-text-${qId}`).value;
            const fileInput = document.getElementById(`reply-image-${qId}`);
            
            if (!text.trim()) return alert("Please type an answer.");

            try {
                let base64Img = null;
                if (fileInput.files.length > 0) {
                    base64Img = await window.processImage(fileInput.files[0]);
                }

                // Add answer
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'community_answers'), {
                    questionId: qId,
                    text: text,
                    image: base64Img,
                    timestamp: Date.now(),
                    userId: currentUser.uid
                });

                // Clear inputs
                document.getElementById(`reply-text-${qId}`).value = '';
                fileInput.value = '';

                // Ideally update answer count on parent doc, but requires doc ID ref. 
                // Skipping for simplicity in this demo structure.

            } catch (e) {
                console.error(e);
                alert("Error posting reply.");
            }
        };

        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

    </script>
    
    <!-- STANDARD JS -->
    <script>
        // --- DATA ---
        const syllabusData = {
            "1": [ { title: "Anatomy", desc: "Skeletal system structure.", topics: ["Bones", "Joints"] }, { title: "Physics", desc: "Basic electricity.", topics: ["Ohm's Law", "Magnetism"] } ],
            "2": [ { title: "Darkroom", desc: "Film processing.", topics: ["Developers", "Fixers"] }, { title: "Radiation", desc: "X-ray production.", topics: ["Cathode", "Anode"] } ],
            "3": [ { title: "MRI", desc: "Magnetic Resonance.", topics: ["T1/T2", "Coils"] }, { title: "CT", desc: "Computed Tomography.", topics: ["Generations", "Detectors"] } ]
        };
        const curatedQuestions = [
            { id: 1, type: "Anatomy", q: "Largest bone?", a: "Femur." },
            { id: 2, type: "Physics", q: "Unit of frequency?", a: "Hertz." },
            { id: 3, type: "Physics", q: "Define HVL.", a: "Thickness to reduce intensity by half." },
            { id: 4, type: "Anatomy", q: "Carpal bones count?", a: "8 bones." },
            { id: 5, type: "Physics", q: "CT Hounsfield unit for water?", a: "Zero (0)." }
        ];
        const galleryImages = [
            { src: "https://images.unsplash.com/photo-1530497610245-94d3c16cda28?auto=format&fit=crop&q=80&w=600", title: "Chest X-Ray", cat: "X-Ray" },
            { src: "https://images.unsplash.com/photo-1559757175-5700dde675bc?auto=format&fit=crop&q=80&w=600", title: "Brain MRI", cat: "MRI" },
            { src: "https://images.unsplash.com/photo-1579684385180-1ea90d843845?auto=format&fit=crop&q=80&w=600", title: "Abdomen CT", cat: "CT" },
            { src: "https://images.unsplash.com/photo-1530026405186-ed1f139313f8?auto=format&fit=crop&q=80&w=600", title: "Spine", cat: "X-Ray" }
        ];

        // --- ROUTER ---
        window.router = function(viewName) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            const target = document.getElementById(viewName);
            if(target) { target.classList.remove('hidden'); target.classList.add('animate-fade-in'); }
            window.scrollTo(0,0);
            if(viewName === 'syllabus') renderSyllabus();
            if(viewName === 'qbank') renderQuestions();
            if(viewName === 'gallery') renderGallery();
        };

        window.toggleMobileMenu = function() {
            document.getElementById('mobile-menu').classList.toggle('hidden');
        };

        // --- SYLLABUS ---
        window.renderSyllabus = function() {
            const y = document.getElementById('syllabus-year').value;
            document.getElementById('syllabus-content').innerHTML = syllabusData[y].map(s => `
                <div class="bg-white rounded-lg border border-gray-200 p-4 shadow-sm">
                    <h3 class="font-bold text-lg">${s.title}</h3>
                    <p class="text-gray-600 mb-2">${s.desc}</p>
                    <div class="flex gap-2">${s.topics.map(t => `<span class="bg-gray-100 text-xs px-2 py-1 rounded">${t}</span>`).join('')}</div>
                </div>
            `).join('');
        };

        // --- QBANK ---
        let qPage = 1, qFilter = 'All';
        window.setQFilter = (f) => { qFilter = f; qPage = 1; renderQuestions(); updateFilterUI(); };
        function updateFilterUI() {
             document.querySelectorAll('.q-filter').forEach(b => {
                 if(b.innerText.includes(qFilter) || (qFilter==='All' && b.innerText==='All')) b.classList.add('bg-medical-100','text-medical-700');
                 else b.classList.remove('bg-medical-100','text-medical-700');
             });
        }
        window.resetPaginationAndFilter = () => { qPage = 1; renderQuestions(); };
        window.changePage = (d) => { qPage += d; if(qPage < 1) qPage = 1; renderQuestions(); };
        
        window.renderQuestions = () => {
            const search = document.getElementById('qbank-search').value.toLowerCase();
            const container = document.getElementById('questions-container');
            
            // Generate virtual questions if needed
            let list = curatedQuestions.filter(q => (qFilter === 'All' || q.type === qFilter) && (q.q.toLowerCase().includes(search) || q.a.toLowerCase().includes(search)));
            
            // Simulating massive DB for demo
            if(qPage > 1 || list.length < 5) {
                for(let i=0; i<5; i++) list.push({ id: 99+i, type: qFilter==='All'?'Physics':qFilter, q: `Generated Question #${qPage}-${i} about ${qFilter}`, a: "Procedural answer." });
            }

            container.innerHTML = list.map(q => `
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                    <div class="flex justify-between mb-2"><span class="bg-gray-100 text-xs px-2 py-1 rounded font-bold">${q.type}</span></div>
                    <h3 class="font-medium text-gray-900 mb-2">${q.q}</h3>
                    <details class="text-sm text-gray-600 bg-green-50 p-2 rounded"><summary class="cursor-pointer text-medical-600 font-medium">Show Answer</summary><p class="mt-1">${q.a}</p></details>
                </div>
            `).join('');
            document.getElementById('page-indicator').innerText = `Page ${qPage}`;
        };

        // --- GALLERY ---
        window.renderGallery = () => {
            document.getElementById('gallery-grid').innerHTML = galleryImages.map(img => `
                <div class="gallery-item relative group cursor-pointer overflow-hidden rounded-lg shadow-md bg-gray-100 aspect-square" onclick="window.openImageModal('${img.src}')">
                    <img src="${img.src}" class="object-cover w-full h-full transform group-hover:scale-110 transition duration-500">
                    <div class="gallery-overlay absolute inset-0 bg-black/50 flex flex-col items-center justify-center text-white p-2 text-center">
                        <p class="font-bold">${img.title}</p><span class="text-xs bg-blue-500 px-2 rounded mt-1">${img.cat}</span>
                    </div>
                </div>
            `).join('');
        };
        window.openImageModal = (src) => { document.getElementById('modal-img').src = src; document.getElementById('image-modal').classList.remove('hidden'); };
        window.closeImageModal = () => { document.getElementById('image-modal').classList.add('hidden'); };

        // --- AI BOT ---
        window.sendMessage = () => {
            const i = document.getElementById('ai-input');
            const h = document.getElementById('chat-history');
            const txt = i.value.trim().toLowerCase();
            if(!txt) return;
            h.innerHTML += `<div class="flex justify-end"><div class="bg-medical-600 text-white chat-bubble">${i.value}</div></div>`;
            i.value = '';
            setTimeout(() => {
                let ans = "Check the syllabus for details.";
                if(txt.includes('x-ray')) ans = "X-rays use high energy photons. Bones absorb them (white), air doesn't (black).";
                if(txt.includes('mri')) ans = "MRI uses magnets. Avoid metal objects!";
                h.innerHTML += `<div class="flex justify-start"><div class="bg-white border chat-bubble"><span class="font-bold text-medical-600 block text-xs">MedBot</span>${ans}</div></div>`;
                h.scrollTop = h.scrollHeight;
            }, 600);
        };

        // Init
        renderQuestions();
    </script>
</body>
</html>


