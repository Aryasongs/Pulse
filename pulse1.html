<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hype - Share Your Buzz</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #1d9bf0; --bg: #000000; --surface: #16181c; --text: #e7e9ea; --border: #2f3336; }
        body { background-color: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; display: flex; min-height: 100vh; }
        
        /* Simple Layout */
        .sidebar { width: 250px; padding: 20px; border-right: 1px solid var(--border); position: fixed; height: 100%; }
        .main-feed { margin-left: 290px; width: 600px; border-right: 1px solid var(--border); }
        
        .nav-item { display: block; padding: 15px; font-size: 20px; color: var(--text); cursor: pointer; }
        .btn-buzz { background-color: var(--primary); color: white; border: none; padding: 15px; width: 100%; border-radius: 30px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        
        /* Auth Styles */
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .auth-box { background: black; border: 1px solid var(--border); padding: 40px; border-radius: 15px; text-align: center; width: 300px; }
        .google-btn { background: white; color: black; padding: 12px; border-radius: 25px; border: none; font-weight: bold; cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 16px; }
        .google-btn:hover { background: #e6e6e6; }
        
        /* Post Styles */
        .compose-box { padding: 15px; border-bottom: 1px solid var(--border); }
        textarea { background: transparent; border: none; color: white; width: 100%; font-size: 18px; outline: none; resize: none; }
        .buzz { padding: 15px; border-bottom: 1px solid var(--border); display: flex; gap: 10px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: gray; object-fit: cover;}
        .buzz-img { width: 100%; border-radius: 10px; margin-top: 10px; border: 1px solid var(--border); }
        .verified { color: var(--primary); margin-left: 4px; }
        
        #setup-modal { display: none; }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div class="auth-box" id="login-box">
            <h1 style="margin-top: 0;"><i class="fas fa-bolt"></i> Hype</h1>
            <p>Join the conversation.</p>
            <button class="google-btn" id="google-login-btn">
                <i class="fab fa-google"></i> Sign in with Google
            </button>
            <p id="error-msg" style="color: red; font-size: 12px; margin-top: 10px;"></p>
        </div>

        <div class="auth-box" id="setup-modal">
            <h2>Create Username</h2>
            <input type="text" id="username-input" placeholder="@username" style="background: #202327; border: none; color: white; padding: 15px; border-radius: 5px; width: 85%; margin-bottom: 10px;">
            <button class="btn-buzz" id="finalize-btn">Get Started</button>
        </div>
    </div>

    <div class="sidebar">
        <h1><i class="fas fa-bolt"></i></h1>
        <div class="nav-item"><i class="fas fa-home"></i> Home</div>
        <div class="nav-item"><i class="fas fa-user"></i> Profile</div>
        <button class="btn-buzz" onclick="document.getElementById('buzz-input').focus()">Buzz</button>
        <div style="position: absolute; bottom: 20px; display: flex; gap: 10px; align-items: center;">
            <img id="sidebar-img" class="avatar">
            <div>
                <div id="sidebar-name" style="font-weight: bold; font-size: 14px;"></div>
                <div id="sidebar-handle" style="color: gray; font-size: 12px;"></div>
            </div>
        </div>
    </div>

    <div class="main-feed">
        <div style="padding: 15px; border-bottom: 1px solid var(--border); font-weight: bold;">Home</div>
        
        <div class="compose-box">
            <textarea id="buzz-input" rows="3" placeholder="What's happening?"></textarea>
            <div id="preview-area"></div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                <input type="file" id="img-input" accept="image/*" style="display: none;">
                <i class="far fa-image" style="color: var(--primary); cursor: pointer; font-size: 20px;" onclick="document.getElementById('img-input').click()"></i>
                <button class="btn-buzz" style="width: auto; padding: 8px 20px; margin: 0;" id="post-btn">Buzz</button>
            </div>
        </div>

        <div id="feed-container"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getDatabase, ref, set, push, onChildAdded, get, update, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // YOUR CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyB2XeuTfHZ7FYKLoYb4epKp3upmVqG0fzE",
            authDomain: "pulse-17f40.firebaseapp.com",
            databaseURL: "https://pulse-17f40-default-rtdb.firebaseio.com",
            projectId: "pulse-17f40",
            storageBucket: "pulse-17f40.firebasestorage.app",
            messagingSenderId: "259780854138",
            appId: "1:259780854138:web:89c265fd22a34a7f1fd6c3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let selectedImgBase64 = null;

        // 1. LOGIN LOGIC
        document.getElementById('google-login-btn').addEventListener('click', () => {
            signInWithPopup(auth, provider)
                .then(async (result) => {
                    const user = result.user;
                    console.log("Google Login Success:", user.email);
                    
                    // Check if user has username
                    const snapshot = await get(ref(db, 'users/' + user.uid));
                    if (snapshot.exists()) {
                        document.getElementById('auth-overlay').style.display = 'none';
                    } else {
                        document.getElementById('login-box').style.display = 'none';
                        document.getElementById('setup-modal').style.display = 'block';
                    }
                })
                .catch((error) => {
                    console.error(error);
                    alert("Login Failed: " + error.message); 
                    document.getElementById('error-msg').innerText = error.message;
                });
        });

        // 2. CREATE USERNAME LOGIC
        document.getElementById('finalize-btn').addEventListener('click', async () => {
            const username = document.getElementById('username-input').value.toLowerCase().trim();
            const user = auth.currentUser;
            
            if (username.length < 3) return alert("Username too short!");
            
            // Check availability
            const check = await get(ref(db, 'usernames/' + username));
            if (check.exists()) return alert("Username already taken! Try another.");

            const userData = {
                name: user.displayName,
                email: user.email,
                photoURL: user.photoURL,
                username: username,
                verified: false,
                uid: user.uid
            };

            const updates = {};
            updates['/users/' + user.uid] = userData;
            updates['/usernames/' + username] = user.uid;

            await update(ref(db), updates);
            document.getElementById('auth-overlay').style.display = 'none';
        });

        // 3. AUTH STATE LISTENER
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const snap = await get(ref(db, 'users/' + user.uid));
                if (snap.exists()) {
                    currentUser = snap.val();
                    document.getElementById('auth-overlay').style.display = 'none';
                    document.getElementById('sidebar-img').src = currentUser.photoURL;
                    document.getElementById('sidebar-name').innerText = currentUser.name;
                    document.getElementById('sidebar-handle').innerText = "@" + currentUser.username;
                }
            } else {
                document.getElementById('auth-overlay').style.display = 'flex';
                document.getElementById('login-box').style.display = 'block';
                document.getElementById('setup-modal').style.display = 'none';
            }
        });

        // 4. IMAGE HANDLING
        document.getElementById('img-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                selectedImgBase64 = evt.target.result;
                document.getElementById('preview-area').innerHTML = `<img src="${selectedImgBase64}" style="max-height: 200px; border-radius: 10px; margin-top:10px;">`;
            };
            reader.readAsDataURL(file);
        });

        // 5. POSTING LOGIC
        document.getElementById('post-btn').addEventListener('click', () => {
            const text = document.getElementById('buzz-input').value;
            if (!text && !selectedImgBase64) return;

            const newPost = {
                text: text,
                image: selectedImgBase64 || null,
                uid: currentUser.uid,
                name: currentUser.name,
                username: currentUser.username,
                userPhoto: currentUser.photoURL,
                verified: currentUser.verified || false,
                timestamp: serverTimestamp()
            };

            push(ref(db, 'buzzes'), newPost);
            
            // Reset UI
            document.getElementById('buzz-input').value = "";
            document.getElementById('preview-area').innerHTML = "";
            selectedImgBase64 = null;
        });

        // 6. FEED LOGIC
        onChildAdded(ref(db, 'buzzes'), (data) => {
            const post = data.val();
            
            // Detect Hashtags/Mentions
            const formattedText = post.text
                .replace(/#(\w+)/g, '<span style="color:var(--primary)">#$1</span>')
                .replace(/@(\w+)/g, '<span style="color:var(--primary)">@$1</span>');

            const html = `
                <div class="buzz">
                    <img src="${post.userPhoto}" class="avatar">
                    <div style="width: 100%;">
                        <div>
                            <span style="font-weight: bold;">${post.name}</span>
                            ${post.verified ? '<i class="fas fa-check-circle verified"></i>' : ''}
                            <span style="color: gray;">@${post.username}</span>
                        </div>
                        <div style="margin-top: 5px; white-space: pre-wrap;">${formattedText}</div>
                        ${post.image ? `<img src="${post.image}" class="buzz-img">` : ''}
                        <div style="margin-top: 10px; color: gray; display: flex; gap: 20px;">
                            <i class="far fa-comment"></i>
                            <i class="fas fa-retweet"></i>
                            <i class="far fa-heart"></i>
                        </div>
                    </div>
                </div>
            `;
            const feed = document.getElementById('feed-container');
            feed.insertAdjacentHTML('afterbegin', html);
        });
    </script>
</body>
</html>
